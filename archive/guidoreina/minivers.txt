Project Path: arc_guidoreina_minivers_a5a27fov

Source Tree:

```txt
arc_guidoreina_minivers_a5a27fov
├── README.md
├── minivers
│   ├── RegistrationData.c
│   ├── copy_file.c
│   ├── copy_file.h
│   ├── minivers.c
│   ├── minivers.h
│   ├── minivers.inf
│   ├── minivers.rc
│   ├── minivers.vcxproj
│   └── minivers.vcxproj.filters
├── minivers Package
│   ├── minivers Package.vcxproj
│   └── minivers Package.vcxproj.filters
└── minivers.sln

```

`README.md`:

```md
Minivers File System Minifilter Driver
======================================

Minivers is a Windows file system minifilter driver which monitors changes in files with certain extensions. If a monitored file is about to be changed, deleted or renamed, a backup copy of the file is performed before the operation begins.

The file name of the backup files has the format:
```
<original-filename>.YYYYMMDD_hhmmss_mmm.minivers
```


The following file extensions are monitored:
* doc
* docx
* xls
* xlsx
* txt

You can add more file extensions by editing the file minivers.c:
```
/******************************************************************************
 ******************************************************************************
 **                                                                          **
 ** File extensions to be taken into account.                                **
 **                                                                          **
 ******************************************************************************
 ******************************************************************************/
DECLARE_CONST_UNICODE_STRING(DOC, L"doc");
DECLARE_CONST_UNICODE_STRING(DOCX, L"docx");
DECLARE_CONST_UNICODE_STRING(XLS, L"xls");
DECLARE_CONST_UNICODE_STRING(XLSX, L"xlsx");
DECLARE_CONST_UNICODE_STRING(TXT, L"txt");
 
static const UNICODE_STRING* extensions[] = {&DOC, &DOCX, &XLS, &XLSX, &TXT};
```


The backup files have the extension `minivers`:
```
DECLARE_CONST_UNICODE_STRING(MINIVERS_EXT, L"minivers");
```


Files with this file extension cannot be deleted, if you want to change this, change the following `define`:
```
#define IMMUTABLE_BACKUP_FILES TRUE
```


Minivers can be used to protect against ransomware, as they search files with certain extensions (not tested though).

Minivers logs the name of the executable which produced the change, to avoid this change the following `define`:
```
#define LOG_IMAGE_FILENAME     TRUE
```

```

`minivers Package/minivers Package.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Win8.1 Debug|Win32">
      <Configuration>Win8.1 Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win8.1 Release|Win32">
      <Configuration>Win8.1 Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win8 Debug|Win32">
      <Configuration>Win8 Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win8 Release|Win32">
      <Configuration>Win8 Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win7 Debug|Win32">
      <Configuration>Win7 Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win7 Release|Win32">
      <Configuration>Win7 Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win8.1 Debug|x64">
      <Configuration>Win8.1 Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win8.1 Release|x64">
      <Configuration>Win8.1 Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win8 Debug|x64">
      <Configuration>Win8 Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win8 Release|x64">
      <Configuration>Win8 Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win7 Debug|x64">
      <Configuration>Win7 Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win7 Release|x64">
      <Configuration>Win7 Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <ProjectGuid>{305D7A16-455C-4019-946A-7CBFFC6508D1}</ProjectGuid>
    <TemplateGuid>{4605da2c-74a5-4865-98e1-152ef136825f}</TemplateGuid>
    <TargetFrameworkVersion>v4.5</TargetFrameworkVersion>
    <MinimumVisualStudioVersion>11.0</MinimumVisualStudioVersion>
    <Configuration>Win8.1 Debug</Configuration>
    <Platform Condition="'$(Platform)' == ''">Win32</Platform>
    <RootNamespace>minivers_Package</RootNamespace>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Debug|Win32'" Label="Configuration">
    <TargetVersion>WindowsV6.3</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Utility</ConfigurationType>
    <DriverType>Package</DriverType>
    <DisableFastUpToDateCheck>true</DisableFastUpToDateCheck>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Release|Win32'" Label="Configuration">
    <TargetVersion>WindowsV6.3</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Utility</ConfigurationType>
    <DriverType>Package</DriverType>
    <DisableFastUpToDateCheck>true</DisableFastUpToDateCheck>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Debug|Win32'" Label="Configuration">
    <TargetVersion>Windows8</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Utility</ConfigurationType>
    <DriverType>Package</DriverType>
    <DisableFastUpToDateCheck>true</DisableFastUpToDateCheck>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Release|Win32'" Label="Configuration">
    <TargetVersion>Windows8</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Utility</ConfigurationType>
    <DriverType>Package</DriverType>
    <DisableFastUpToDateCheck>true</DisableFastUpToDateCheck>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Debug|Win32'" Label="Configuration">
    <TargetVersion>Windows7</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Utility</ConfigurationType>
    <DriverType>Package</DriverType>
    <DisableFastUpToDateCheck>true</DisableFastUpToDateCheck>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Release|Win32'" Label="Configuration">
    <TargetVersion>Windows7</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Utility</ConfigurationType>
    <DriverType>Package</DriverType>
    <DisableFastUpToDateCheck>true</DisableFastUpToDateCheck>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Debug|x64'" Label="Configuration">
    <TargetVersion>WindowsV6.3</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Utility</ConfigurationType>
    <DriverType>Package</DriverType>
    <DisableFastUpToDateCheck>true</DisableFastUpToDateCheck>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Release|x64'" Label="Configuration">
    <TargetVersion>WindowsV6.3</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Utility</ConfigurationType>
    <DriverType>Package</DriverType>
    <DisableFastUpToDateCheck>true</DisableFastUpToDateCheck>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Debug|x64'" Label="Configuration">
    <TargetVersion>Windows8</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Utility</ConfigurationType>
    <DriverType>Package</DriverType>
    <DisableFastUpToDateCheck>true</DisableFastUpToDateCheck>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Release|x64'" Label="Configuration">
    <TargetVersion>Windows8</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Utility</ConfigurationType>
    <DriverType>Package</DriverType>
    <DisableFastUpToDateCheck>true</DisableFastUpToDateCheck>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Debug|x64'" Label="Configuration">
    <TargetVersion>Windows7</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Utility</ConfigurationType>
    <DriverType>Package</DriverType>
    <DisableFastUpToDateCheck>true</DisableFastUpToDateCheck>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Release|x64'" Label="Configuration">
    <TargetVersion>Windows7</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Utility</ConfigurationType>
    <DriverType>Package</DriverType>
    <DisableFastUpToDateCheck>true</DisableFastUpToDateCheck>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="PropertySheets">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Debug|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <EnableDeployment>False</EnableDeployment>
    <RemoveDriver>True</RemoveDriver>
    <HardwareIdString />
    <CommandLine />
    <DeployFiles />
    <EnableVerifier>False</EnableVerifier>
    <AllDrivers>False</AllDrivers>
    <VerifyProjectOutput>True</VerifyProjectOutput>
    <VerifyDrivers />
    <VerifyFlags>133563</VerifyFlags>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Release|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <EnableDeployment>False</EnableDeployment>
    <RemoveDriver>True</RemoveDriver>
    <HardwareIdString />
    <CommandLine />
    <DeployFiles />
    <EnableVerifier>False</EnableVerifier>
    <AllDrivers>False</AllDrivers>
    <VerifyProjectOutput>True</VerifyProjectOutput>
    <VerifyDrivers />
    <VerifyFlags>133563</VerifyFlags>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Debug|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <EnableDeployment>False</EnableDeployment>
    <RemoveDriver>True</RemoveDriver>
    <HardwareIdString />
    <CommandLine />
    <DeployFiles />
    <EnableVerifier>False</EnableVerifier>
    <AllDrivers>False</AllDrivers>
    <VerifyProjectOutput>True</VerifyProjectOutput>
    <VerifyDrivers />
    <VerifyFlags>133563</VerifyFlags>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Release|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <EnableDeployment>False</EnableDeployment>
    <RemoveDriver>True</RemoveDriver>
    <HardwareIdString />
    <CommandLine />
    <DeployFiles />
    <EnableVerifier>False</EnableVerifier>
    <AllDrivers>False</AllDrivers>
    <VerifyProjectOutput>True</VerifyProjectOutput>
    <VerifyDrivers />
    <VerifyFlags>133563</VerifyFlags>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Debug|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <EnableDeployment>False</EnableDeployment>
    <RemoveDriver>True</RemoveDriver>
    <HardwareIdString />
    <CommandLine />
    <DeployFiles />
    <EnableVerifier>False</EnableVerifier>
    <AllDrivers>False</AllDrivers>
    <VerifyProjectOutput>True</VerifyProjectOutput>
    <VerifyDrivers />
    <VerifyFlags>133563</VerifyFlags>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Release|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <EnableDeployment>False</EnableDeployment>
    <RemoveDriver>True</RemoveDriver>
    <HardwareIdString />
    <CommandLine />
    <DeployFiles />
    <EnableVerifier>False</EnableVerifier>
    <AllDrivers>False</AllDrivers>
    <VerifyProjectOutput>True</VerifyProjectOutput>
    <VerifyDrivers />
    <VerifyFlags>133563</VerifyFlags>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Debug|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <EnableDeployment>False</EnableDeployment>
    <RemoveDriver>True</RemoveDriver>
    <HardwareIdString />
    <CommandLine />
    <DeployFiles />
    <EnableVerifier>False</EnableVerifier>
    <AllDrivers>False</AllDrivers>
    <VerifyProjectOutput>True</VerifyProjectOutput>
    <VerifyDrivers />
    <VerifyFlags>133563</VerifyFlags>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Release|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <EnableDeployment>False</EnableDeployment>
    <RemoveDriver>True</RemoveDriver>
    <HardwareIdString />
    <CommandLine />
    <DeployFiles />
    <EnableVerifier>False</EnableVerifier>
    <AllDrivers>False</AllDrivers>
    <VerifyProjectOutput>True</VerifyProjectOutput>
    <VerifyDrivers />
    <VerifyFlags>133563</VerifyFlags>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Debug|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <EnableDeployment>False</EnableDeployment>
    <RemoveDriver>True</RemoveDriver>
    <HardwareIdString />
    <CommandLine />
    <DeployFiles />
    <EnableVerifier>False</EnableVerifier>
    <AllDrivers>False</AllDrivers>
    <VerifyProjectOutput>True</VerifyProjectOutput>
    <VerifyDrivers />
    <VerifyFlags>133563</VerifyFlags>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Release|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <EnableDeployment>False</EnableDeployment>
    <RemoveDriver>True</RemoveDriver>
    <HardwareIdString />
    <CommandLine />
    <DeployFiles />
    <EnableVerifier>False</EnableVerifier>
    <AllDrivers>False</AllDrivers>
    <VerifyProjectOutput>True</VerifyProjectOutput>
    <VerifyDrivers />
    <VerifyFlags>133563</VerifyFlags>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Debug|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <EnableDeployment>False</EnableDeployment>
    <RemoveDriver>True</RemoveDriver>
    <HardwareIdString />
    <CommandLine />
    <DeployFiles />
    <EnableVerifier>False</EnableVerifier>
    <AllDrivers>False</AllDrivers>
    <VerifyProjectOutput>True</VerifyProjectOutput>
    <VerifyDrivers />
    <VerifyFlags>133563</VerifyFlags>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Release|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <EnableDeployment>False</EnableDeployment>
    <RemoveDriver>True</RemoveDriver>
    <HardwareIdString />
    <CommandLine />
    <DeployFiles />
    <EnableVerifier>False</EnableVerifier>
    <AllDrivers>False</AllDrivers>
    <VerifyProjectOutput>True</VerifyProjectOutput>
    <VerifyDrivers />
    <VerifyFlags>133563</VerifyFlags>
  </PropertyGroup>
  <ItemGroup>
    <FilesToPackage Include="@(Inf->'%(CopyOutput)')" Condition="'@(Inf)'!=''" />
  </ItemGroup>
  <ItemGroup>
    <ProjectReference Include="..\minivers\minivers.vcxproj">
      <Project>{e337ac23-f84d-4e6d-81e9-729f64684a30}</Project>
    </ProjectReference>
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`minivers Package/minivers Package.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Driver Files">
      <UniqueIdentifier>{8E41214B-6785-4CFE-B992-037D68949A14}</UniqueIdentifier>
      <Extensions>inf;inv;inx;mof;mc;</Extensions>
    </Filter>
  </ItemGroup>
</Project>
```

`minivers.sln`:

```sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Express 2013 for Windows Desktop
VisualStudioVersion = 12.0.31101.0
MinimumVisualStudioVersion = 10.0.40219.1
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "minivers", "minivers\minivers.vcxproj", "{E337AC23-F84D-4E6D-81E9-729F64684A30}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "minivers Package", "minivers Package\minivers Package.vcxproj", "{305D7A16-455C-4019-946A-7CBFFC6508D1}"
	ProjectSection(ProjectDependencies) = postProject
		{E337AC23-F84D-4E6D-81E9-729F64684A30} = {E337AC23-F84D-4E6D-81E9-729F64684A30}
	EndProjectSection
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Win7 Debug|Win32 = Win7 Debug|Win32
		Win7 Debug|x64 = Win7 Debug|x64
		Win7 Release|Win32 = Win7 Release|Win32
		Win7 Release|x64 = Win7 Release|x64
		Win8 Debug|Win32 = Win8 Debug|Win32
		Win8 Debug|x64 = Win8 Debug|x64
		Win8 Release|Win32 = Win8 Release|Win32
		Win8 Release|x64 = Win8 Release|x64
		Win8.1 Debug|Win32 = Win8.1 Debug|Win32
		Win8.1 Debug|x64 = Win8.1 Debug|x64
		Win8.1 Release|Win32 = Win8.1 Release|Win32
		Win8.1 Release|x64 = Win8.1 Release|x64
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win7 Debug|Win32.ActiveCfg = Win7 Debug|Win32
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win7 Debug|Win32.Build.0 = Win7 Debug|Win32
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win7 Debug|Win32.Deploy.0 = Win7 Debug|Win32
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win7 Debug|x64.ActiveCfg = Win7 Debug|x64
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win7 Debug|x64.Build.0 = Win7 Debug|x64
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win7 Debug|x64.Deploy.0 = Win7 Debug|x64
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win7 Release|Win32.ActiveCfg = Win7 Release|Win32
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win7 Release|Win32.Build.0 = Win7 Release|Win32
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win7 Release|Win32.Deploy.0 = Win7 Release|Win32
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win7 Release|x64.ActiveCfg = Win7 Release|x64
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win7 Release|x64.Build.0 = Win7 Release|x64
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win7 Release|x64.Deploy.0 = Win7 Release|x64
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8 Debug|Win32.ActiveCfg = Win8 Debug|Win32
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8 Debug|Win32.Build.0 = Win8 Debug|Win32
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8 Debug|Win32.Deploy.0 = Win8 Debug|Win32
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8 Debug|x64.ActiveCfg = Win8 Debug|x64
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8 Debug|x64.Build.0 = Win8 Debug|x64
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8 Debug|x64.Deploy.0 = Win8 Debug|x64
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8 Release|Win32.ActiveCfg = Win8 Release|Win32
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8 Release|Win32.Build.0 = Win8 Release|Win32
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8 Release|Win32.Deploy.0 = Win8 Release|Win32
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8 Release|x64.ActiveCfg = Win8 Release|x64
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8 Release|x64.Build.0 = Win8 Release|x64
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8 Release|x64.Deploy.0 = Win8 Release|x64
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8.1 Debug|Win32.ActiveCfg = Win8.1 Debug|Win32
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8.1 Debug|Win32.Build.0 = Win8.1 Debug|Win32
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8.1 Debug|Win32.Deploy.0 = Win8.1 Debug|Win32
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8.1 Debug|x64.ActiveCfg = Win8.1 Debug|x64
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8.1 Debug|x64.Build.0 = Win8.1 Debug|x64
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8.1 Debug|x64.Deploy.0 = Win8.1 Debug|x64
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8.1 Release|Win32.ActiveCfg = Win8.1 Release|Win32
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8.1 Release|Win32.Build.0 = Win8.1 Release|Win32
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8.1 Release|Win32.Deploy.0 = Win8.1 Release|Win32
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8.1 Release|x64.ActiveCfg = Win8.1 Release|x64
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8.1 Release|x64.Build.0 = Win8.1 Release|x64
		{E337AC23-F84D-4E6D-81E9-729F64684A30}.Win8.1 Release|x64.Deploy.0 = Win8.1 Release|x64
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win7 Debug|Win32.ActiveCfg = Win7 Debug|Win32
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win7 Debug|Win32.Build.0 = Win7 Debug|Win32
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win7 Debug|Win32.Deploy.0 = Win7 Debug|Win32
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win7 Debug|x64.ActiveCfg = Win7 Debug|x64
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win7 Debug|x64.Build.0 = Win7 Debug|x64
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win7 Debug|x64.Deploy.0 = Win7 Debug|x64
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win7 Release|Win32.ActiveCfg = Win7 Release|Win32
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win7 Release|Win32.Build.0 = Win7 Release|Win32
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win7 Release|Win32.Deploy.0 = Win7 Release|Win32
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win7 Release|x64.ActiveCfg = Win7 Release|x64
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win7 Release|x64.Build.0 = Win7 Release|x64
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win7 Release|x64.Deploy.0 = Win7 Release|x64
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8 Debug|Win32.ActiveCfg = Win8 Debug|Win32
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8 Debug|Win32.Build.0 = Win8 Debug|Win32
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8 Debug|Win32.Deploy.0 = Win8 Debug|Win32
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8 Debug|x64.ActiveCfg = Win8 Debug|x64
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8 Debug|x64.Build.0 = Win8 Debug|x64
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8 Debug|x64.Deploy.0 = Win8 Debug|x64
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8 Release|Win32.ActiveCfg = Win8 Release|Win32
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8 Release|Win32.Build.0 = Win8 Release|Win32
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8 Release|Win32.Deploy.0 = Win8 Release|Win32
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8 Release|x64.ActiveCfg = Win8 Release|x64
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8 Release|x64.Build.0 = Win8 Release|x64
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8 Release|x64.Deploy.0 = Win8 Release|x64
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8.1 Debug|Win32.ActiveCfg = Win8.1 Debug|Win32
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8.1 Debug|Win32.Build.0 = Win8.1 Debug|Win32
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8.1 Debug|Win32.Deploy.0 = Win8.1 Debug|Win32
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8.1 Debug|x64.ActiveCfg = Win8.1 Debug|x64
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8.1 Debug|x64.Build.0 = Win8.1 Debug|x64
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8.1 Debug|x64.Deploy.0 = Win8.1 Debug|x64
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8.1 Release|Win32.ActiveCfg = Win8.1 Release|Win32
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8.1 Release|Win32.Build.0 = Win8.1 Release|Win32
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8.1 Release|Win32.Deploy.0 = Win8.1 Release|Win32
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8.1 Release|x64.ActiveCfg = Win8.1 Release|x64
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8.1 Release|x64.Build.0 = Win8.1 Release|x64
		{305D7A16-455C-4019-946A-7CBFFC6508D1}.Win8.1 Release|x64.Deploy.0 = Win8.1 Release|x64
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
EndGlobal

```

`minivers/RegistrationData.c`:

```c
#include "minivers.h"

/* Place all the following DATA and CONSTANT DATA in the INIT segment. */
#ifdef ALLOC_DATA_PRAGMA
  #pragma data_seg("INIT")
  #pragma const_seg("INIT")
#endif /* ALLOC_DATA_PRAGMA */

CONST FLT_OPERATION_REGISTRATION callbacks[] = {
  {IRP_MJ_CREATE,          0, PreOperationCallback, NULL},
  {IRP_MJ_SET_INFORMATION, 0, PreOperationCallback, NULL},
  {IRP_MJ_OPERATION_END                                 }
};

CONST FLT_REGISTRATION filter_registration = {
  sizeof(FLT_REGISTRATION),             /* Size. */
  FLT_REGISTRATION_VERSION,             /* Version. */
  0,                                    /* Flags. */
  NULL,                                 /* ContextRegistration. */
  callbacks,                            /* OperationRegistration. */
  FilterUnload,                         /* FilterUnloadCallback. */
  InstanceSetup,                        /* InstanceSetupCallback. */
  InstanceQueryTeardown,                /* InstanceQueryTeardownCallback. */
  NULL,                                 /* InstanceTeardownStartCallback. */
  NULL,                                 /* InstanceTeardownCompleteCallback. */
  NULL,                                 /* GenerateFileNameCallback. */
  NULL,                                 /* NormalizeNameComponentCallback. */
  NULL                                  /* NormalizeContextCleanupCallback. */

#if FLT_MGR_LONGHORN
  , NULL                                /* TransactionNotificationCallback. */
  , NULL                                /* NormalizeNameComponentExCallback. */
#endif /* FLT_MGR_LONGHORN */
#if FLT_MFG_WIN8
  , NULL                                /* SectionNotificationCallback. */
#endif
};

/* Restore the given section types back to their previous section definition. */
#ifdef ALLOC_DATA_PRAGMA
  #pragma data_seg()
  #pragma const_seg()
#endif /* ALLOC_DATA_PRAGMA */

```

`minivers/copy_file.c`:

```c
#include <ntifs.h>
#include "copy_file.h"
#include "minivers.h"

#define BUFFER_SIZE (4 * 1024)

static BOOLEAN write(HANDLE hFile, void* buf, ULONG len);
static BOOLEAN delete_file(PFLT_INSTANCE instance, PFILE_OBJECT file);

/* Disable warning:
 * Conditional expression is constant:
 * do {
 *   ...
 * } while (1);
 */
#pragma warning(disable:4127)

BOOLEAN copy_file(PFLT_FILTER filter,
                  PFLT_INSTANCE instance,
                  UNICODE_STRING* dest,
                  UNICODE_STRING* src)
{
  HANDLE hInput, hOutput;
  PFILE_OBJECT out;
  OBJECT_ATTRIBUTES attr;
  IO_STATUS_BLOCK io_status_block;
  PVOID buf;
  ULONGLONG filesize;
  NTSTATUS status;

  InitializeObjectAttributes(&attr,
                             src,
                             OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
                             NULL,
                             NULL);

  /* Open input file for reading. */
  status = FltCreateFile(filter,                       /* Filter            */
                         instance,                     /* Instance          */
                         &hInput,                      /* FileHandle        */
                         GENERIC_READ,                 /* DesiredAccess     */
                         &attr,                        /* ObjectAttributes  */
                         &io_status_block,             /* IoStatusBlock     */
                         NULL,                         /* AllocationSize    */
                         FILE_ATTRIBUTE_NORMAL,        /* FileAttributes    */
                         FILE_SHARE_READ |             /* ShareAccess       */
                         FILE_SHARE_WRITE |
                         FILE_SHARE_DELETE,
                         FILE_OPEN,                    /* CreateDisposition */
                         FILE_SYNCHRONOUS_IO_NONALERT, /* CreateOptions     */
                         NULL,                         /* EaBuffer          */
                         0,                            /* EaLength          */
                         IO_FORCE_ACCESS_CHECK);       /* Flags             */

  /* If the input file could be opened... */
  if (NT_SUCCESS(status)) {
    InitializeObjectAttributes(&attr,
                               dest,
                               OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
                               NULL,
                               NULL);

    /* Open output file for writing. */
    status = FltCreateFileEx(filter,                       /* Filter            */
                             instance,                     /* Instance          */
                             &hOutput,                     /* FileHandle        */
                             &out,                         /* FileObject        */
                             GENERIC_WRITE,                /* DesiredAccess     */
                             &attr,                        /* ObjectAttributes  */
                             &io_status_block,             /* IoStatusBlock     */
                             NULL,                         /* AllocationSize    */
                             FILE_ATTRIBUTE_NORMAL,        /* FileAttributes    */
                             0,                            /* ShareAccess       */
                             FILE_OVERWRITE_IF,            /* CreateDisposition */
                             FILE_SYNCHRONOUS_IO_NONALERT, /* CreateOptions     */
                             NULL,                         /* EaBuffer          */
                             0,                            /* EaLength          */
                             IO_FORCE_ACCESS_CHECK);       /* Flags             */

    /* If the output file could be opened... */
    if (NT_SUCCESS(status)) {
      /* Allocate memory. */
      if ((buf = ExAllocatePoolWithTag(NonPagedPool,
                                       BUFFER_SIZE,
                                       TAG)) != NULL) {
        filesize = 0;

        do {
          /* Read from the input file. */
          status = ZwReadFile(hInput,           /* FileHandle    */
                              NULL,             /* Event         */
                              NULL,             /* ApcRoutine    */
                              NULL,             /* ApcContext    */
                              &io_status_block, /* IoStatusBlock */
                              buf,              /* Buffer        */
                              BUFFER_SIZE,      /* Length        */
                              NULL,             /* ByteOffset    */
                              NULL);            /* Key           */

          if (NT_SUCCESS(status)) {
            if (write(hOutput, buf, io_status_block.Information)) {
              filesize += io_status_block.Information;
            } else {
              /* Free memory. */
              ExFreePoolWithTag(buf, TAG);

              /* Close input file. */
              FltClose(hInput);

              /* Delete output file. */
              delete_file(instance, out);

              /* Close output file. */
              FltClose(hOutput);
              ObDereferenceObject(out);

              return FALSE;
            }
          } else if (status == STATUS_END_OF_FILE) {
            /* Free memory. */
            ExFreePoolWithTag(buf, TAG);

            /* Close input file. */
            FltClose(hInput);

            /* If the file is not empty... */
            if (filesize > 0) {
              DbgPrint("Copied file '%wZ' -> '%wZ', filesize: %lu.",
                       src,
                       dest,
                       filesize);
            } else {
              /* Delete output file. */
              delete_file(instance, out);
            }

            /* Close output file. */
            FltClose(hOutput);
            ObDereferenceObject(out);

            return TRUE;
          } else {
            /* Free memory. */
            ExFreePoolWithTag(buf, TAG);

            /* Close input file. */
            FltClose(hInput);

            /* Delete output file. */
            delete_file(instance, out);

            /* Close output file. */
            FltClose(hOutput);
            ObDereferenceObject(out);

            return FALSE;
          }
        } while (1);
      } else {
        /* Delete output file. */
        delete_file(instance, out);

        /* Close output file. */
        FltClose(hOutput);
        ObDereferenceObject(out);
      }
    }

    /* Close input file. */
    FltClose(hInput);
  }

  return FALSE;
}

BOOLEAN write(HANDLE hFile, void* buf, ULONG len)
{
  IO_STATUS_BLOCK io_status_block;
  UCHAR* b;

  b = (UCHAR*) buf;

  while (len > 0) {
    if (!NT_SUCCESS(ZwWriteFile(hFile,            /* FileHandle    */
                                NULL,             /* Event         */
                                NULL,             /* ApcRoutine    */
                                NULL,             /* ApcContext    */
                                &io_status_block, /* IoStatusBlock */
                                b,                /* Buffer        */
                                len,              /* Length        */
                                NULL,             /* ByteOffset    */
                                NULL))) {         /* Key           */
      return FALSE;
    }

    b += io_status_block.Information;
    len -= io_status_block.Information;
  }

  return TRUE;
}

BOOLEAN delete_file(PFLT_INSTANCE instance, PFILE_OBJECT file)
{
  FILE_DISPOSITION_INFORMATION info;

  info.DeleteFile = TRUE;

  return NT_SUCCESS(FltSetInformationFile(instance,
                                          file,
                                          &info,
                                          sizeof(FILE_DISPOSITION_INFORMATION),
                                          FileDispositionInformation));
}

```

`minivers/copy_file.h`:

```h
#ifndef COPY_FILE_H
#define COPY_FILE_H

#include <wdm.h>
#include <fltKernel.h>

BOOLEAN copy_file(PFLT_FILTER filter,
                  PFLT_INSTANCE instance,
                  UNICODE_STRING* dest,
                  UNICODE_STRING* src);

#endif /* COPY_FILE_H */

```

`minivers/minivers.c`:

```c
#include "minivers.h"
#include <ntstrsafe.h>
#include "copy_file.h"

#define DEFERRED_IO            TRUE
#define IMMUTABLE_BACKUP_FILES TRUE
#define LOG_IMAGE_FILENAME     TRUE

static DRIVER_DATA driver_data;

#if LOG_IMAGE_FILENAME
  #define EXE_MAX_LEN            (4 * 1024)

  /* Prototype of the function 'ZwQueryInformationProcess()'. */
  typedef NTSTATUS (*QueryInformationProcess)(HANDLE,
                                              PROCESSINFOCLASS,
                                              PVOID,
                                              ULONG,
                                              PULONG);

  /* Pointer to the function 'ZwQueryInformationProcess()'. */
  static QueryInformationProcess fnQueryInformationProcess = NULL;
#endif /* LOG_IMAGE_FILENAME */


/******************************************************************************
 ******************************************************************************
 **                                                                          **
 ** File extensions to be taken into account.                                **
 **                                                                          **
 ******************************************************************************
 ******************************************************************************/
DECLARE_CONST_UNICODE_STRING(DOC, L"doc");
DECLARE_CONST_UNICODE_STRING(DOCX, L"docx");
DECLARE_CONST_UNICODE_STRING(XLS, L"xls");
DECLARE_CONST_UNICODE_STRING(XLSX, L"xlsx");
DECLARE_CONST_UNICODE_STRING(TXT, L"txt");

static const UNICODE_STRING* extensions[] = {&DOC, &DOCX, &XLS, &XLSX, &TXT};


/******************************************************************************
 ******************************************************************************
 **                                                                          **
 ** minivers's file extension.                                               **
 **                                                                          **
 ******************************************************************************
 ******************************************************************************/
DECLARE_CONST_UNICODE_STRING(MINIVERS_EXT, L"minivers");


DRIVER_INITIALIZE DriverEntry;
NTSTATUS DriverEntry(_In_ PDRIVER_OBJECT DriverObject,
                     _In_ PUNICODE_STRING RegistryPath);

static NTSTATUS process_irp(PFLT_CALLBACK_DATA Data,
                            PCFLT_RELATED_OBJECTS FltObjects,
                            PVOID* CompletionContext,
                            BOOLEAN deferred_io);

static BOOLEAN get_file_name_information(PFLT_CALLBACK_DATA data,
                                         PFLT_FILE_NAME_INFORMATION* name_info);

static BOOLEAN find_extension(const UNICODE_STRING* ext);
static BOOLEAN duplicate_file(PFLT_CALLBACK_DATA CallbackData,
                              PFLT_INSTANCE instance);

static void deferred_io_workitem(PFLT_DEFERRED_IO_WORKITEM FltWorkItem,
                                 PFLT_CALLBACK_DATA CallbackData,
                                 PVOID Context);

#if LOG_IMAGE_FILENAME
  static BOOLEAN get_process_image_filename(PEPROCESS process,
                                            void* buf,
                                            size_t len);
#endif /* LOG_IMAGE_FILENAME */

#ifdef ALLOC_PRAGMA
  #pragma alloc_text(INIT, DriverEntry)
  #pragma alloc_text(PAGE, InstanceSetup)
  #pragma alloc_text(PAGE, FilterUnload)
  #pragma alloc_text(PAGE, InstanceQueryTeardown)
#endif /* ALLOC_PRAGMA */


NTSTATUS DriverEntry(_In_ PDRIVER_OBJECT DriverObject,
                     _In_ PUNICODE_STRING RegistryPath)
{
#if LOG_IMAGE_FILENAME
  UNICODE_STRING name;
#endif

  NTSTATUS status;

  UNREFERENCED_PARAMETER(RegistryPath);

#if LOG_IMAGE_FILENAME
  RtlInitUnicodeString(&name, L"ZwQueryInformationProcess");

  /* Get a pointer to the function 'ZwQueryInformationProcess()'. */
  fnQueryInformationProcess = (QueryInformationProcess)
                              (ULONG_PTR) MmGetSystemRoutineAddress(&name);
#endif /* LOG_IMAGE_FILENAME */

  /* Register with the filter manager. */
  status = FltRegisterFilter(DriverObject,
                             &filter_registration,
                             &driver_data.filter);

  if (NT_SUCCESS(status)) {
    /* Start filtering. */
    status = FltStartFiltering(driver_data.filter);

    if (!NT_SUCCESS(status)) {
      FltUnregisterFilter(driver_data.filter);
    }
  }

  return status;
}

NTSTATUS InstanceSetup(_In_ PCFLT_RELATED_OBJECTS FltObjects,
                       _In_ FLT_INSTANCE_SETUP_FLAGS Flags,
                       _In_ DEVICE_TYPE VolumeDeviceType,
                       _In_ FLT_FILESYSTEM_TYPE VolumeFilesystemType)
{
  UNREFERENCED_PARAMETER(FltObjects);
  UNREFERENCED_PARAMETER(Flags);
  UNREFERENCED_PARAMETER(VolumeFilesystemType);

  PAGED_CODE();

  return (VolumeDeviceType != FILE_DEVICE_CD_ROM_FILE_SYSTEM) ?
           STATUS_SUCCESS :
           STATUS_FLT_DO_NOT_ATTACH;
}

NTSTATUS FilterUnload(_In_ FLT_FILTER_UNLOAD_FLAGS Flags)
{
  UNREFERENCED_PARAMETER(Flags);

  PAGED_CODE();

  FltUnregisterFilter(driver_data.filter);

  return STATUS_SUCCESS;
}

NTSTATUS InstanceQueryTeardown(_In_ PCFLT_RELATED_OBJECTS FltObjects,
                               _In_ FLT_INSTANCE_QUERY_TEARDOWN_FLAGS Flags)
{
  UNREFERENCED_PARAMETER(FltObjects);
  UNREFERENCED_PARAMETER(Flags);

  PAGED_CODE();

  return STATUS_SUCCESS;
}

FLT_PREOP_CALLBACK_STATUS
PreOperationCallback(
  _Inout_ PFLT_CALLBACK_DATA Data,
  _In_ PCFLT_RELATED_OBJECTS FltObjects,
  _Flt_CompletionContext_Outptr_ PVOID* CompletionContext
)
{
  /* IRP-based I/O operation? */
  if (FLT_IS_IRP_OPERATION(Data)) {
    /* Open file? */
    if (Data->Iopb->MajorFunction == IRP_MJ_CREATE) {
      /* Open file for writing/appending? */
      if (Data->Iopb->Parameters.Create.SecurityContext->DesiredAccess &
          (FILE_WRITE_DATA | FILE_APPEND_DATA)) {
        return process_irp(Data, FltObjects, CompletionContext, DEFERRED_IO);
      }
    } else if (Data->Iopb->MajorFunction == IRP_MJ_SET_INFORMATION) {
      switch (Data->Iopb->Parameters.SetFileInformation.FileInformationClass) {
        case FileDispositionInformation:
          if (((FILE_DISPOSITION_INFORMATION*)
               Data->Iopb->Parameters.SetFileInformation.InfoBuffer
              )->DeleteFile) {
            return process_irp(Data, FltObjects, CompletionContext, FALSE);
          }

          break;
        case FileEndOfFileInformation:
        case FileRenameInformation:
          return process_irp(Data, FltObjects, CompletionContext, FALSE);
      }
    }
  }

  return FLT_PREOP_SUCCESS_NO_CALLBACK;
}

NTSTATUS process_irp(PFLT_CALLBACK_DATA Data,
                     PCFLT_RELATED_OBJECTS FltObjects,
                     PVOID* CompletionContext,
                     BOOLEAN deferred_io)
{
  PFLT_FILE_NAME_INFORMATION name_info;
  PFLT_DEFERRED_IO_WORKITEM work;

#if LOG_IMAGE_FILENAME
  PEPROCESS process;
  ULONG pid;
  char buf[sizeof(UNICODE_STRING) + (sizeof(WCHAR) * EXE_MAX_LEN)];
  PUNICODE_STRING exe;
#endif // LOG_IMAGE_FILENAME

  /* Get name information. */
  if (get_file_name_information(Data, &name_info)) {
    if (find_extension(&name_info->Extension)) {
#if LOG_IMAGE_FILENAME
      if (fnQueryInformationProcess) {
        exe = (PUNICODE_STRING) buf;
        exe->Buffer = (WCHAR*) (buf + sizeof(UNICODE_STRING));
        exe->Length = 0;
        exe->MaximumLength = EXE_MAX_LEN;

        /* Get process image filename. */
        if (((pid = FltGetRequestorProcessId(Data)) != 0) &&
            ((process = FltGetRequestorProcess(Data)) != NULL) &&
            (get_process_image_filename(process, buf, sizeof(buf)))) {
          DbgPrint("[PID: %u, executable: '%wZ'] Filename: '%wZ', "
                   "extension: '%wZ'.",
                   pid,
                   exe,
                   &name_info->Name,
                   &name_info->Extension);
        } else {
          DbgPrint("Filename: '%wZ', extension: '%wZ'.",
                   &name_info->Name,
                   &name_info->Extension);
        }
      } else {
        DbgPrint("Filename: '%wZ', extension: '%wZ'.",
                 &name_info->Name,
                 &name_info->Extension);
      }
#else
      DbgPrint("Filename: '%wZ', extension: '%wZ'.",
               &name_info->Name,
               &name_info->Extension);
#endif

      if (deferred_io) {
        if ((work = FltAllocateDeferredIoWorkItem()) != NULL) {
          if (NT_SUCCESS(FltQueueDeferredIoWorkItem(work,
                                                    Data,
                                                    deferred_io_workitem,
                                                    DelayedWorkQueue,
                                                    FltObjects->Instance))) {
            FltReleaseFileNameInformation(name_info);

            *CompletionContext = NULL;

            return FLT_PREOP_PENDING;
          } else {
            FltFreeDeferredIoWorkItem(work);
          }
        }
      }

      duplicate_file(Data, FltObjects->Instance);
#if IMMUTABLE_BACKUP_FILES
    } else if (RtlEqualUnicodeString(&name_info->Extension,
                                     &MINIVERS_EXT,
                                     TRUE)) {
      DbgPrint("Filename: '%wZ', extension: '%wZ'.",
               &name_info->Name,
               &name_info->Extension);

      FltReleaseFileNameInformation(name_info);

      Data->IoStatus.Status = STATUS_ACCESS_DENIED;
      return FLT_PREOP_COMPLETE;
#endif /* IMMUTABLE_BACKUP_FILES */
    }

    FltReleaseFileNameInformation(name_info);
  }

  return FLT_PREOP_SUCCESS_NO_CALLBACK;
}

BOOLEAN get_file_name_information(PFLT_CALLBACK_DATA data,
                                  PFLT_FILE_NAME_INFORMATION* name_info)
{
  /* Get name information. */
  if (NT_SUCCESS(FltGetFileNameInformation(
                   data,
                   FLT_FILE_NAME_NORMALIZED |
                   FLT_FILE_NAME_QUERY_ALWAYS_ALLOW_CACHE_LOOKUP,
                   name_info
                 ))) {
    /* Parse file name information. */
    if (NT_SUCCESS(FltParseFileNameInformation(*name_info))) {
      return TRUE;
    }

    FltReleaseFileNameInformation(*name_info);
#if OSVER(NTDDI_VERSION) > NTDDI_WIN2K
  } else {
    /*
     * We couldn't get the "normalized" name, try to get the "opened"
     * name.
     */
    if (NT_SUCCESS(FltGetFileNameInformation(data,
                     FLT_FILE_NAME_OPENED |
                     FLT_FILE_NAME_QUERY_ALWAYS_ALLOW_CACHE_LOOKUP,
                     name_info
                   ))) {
      if (NT_SUCCESS(FltParseFileNameInformation(*name_info))) {
        return TRUE;
      }

      FltReleaseFileNameInformation(*name_info);
    }
#endif /* OSVER(NTDDI_VERSION) > NTDDI_WIN2K */
  }

  return FALSE;
}

BOOLEAN find_extension(const UNICODE_STRING* ext)
{
  size_t i;

  for (i = 0; i < ARRAYSIZE(extensions); i++) {
    if (RtlEqualUnicodeString(ext, extensions[i], TRUE)) {
      return TRUE;
    }
  }

  return FALSE;
}

BOOLEAN duplicate_file(PFLT_CALLBACK_DATA CallbackData, PFLT_INSTANCE instance)
{
  PFLT_FILE_NAME_INFORMATION name_info;
  UNICODE_STRING dest;
  LARGE_INTEGER system_time, local_time;
  TIME_FIELDS time;

  /* Get name information. */
  if (get_file_name_information(CallbackData, &name_info)) {
    /* Compute size in bytes.
     * Suffix's format: .YYYYMMDD_hhmmss_mmm.<MINIVERS_EXT>
     */
    dest.MaximumLength = name_info->Name.Length +
                         42 +
                         MINIVERS_EXT.Length +
                         sizeof(WCHAR);

    /* Allocate memory for the destination file name. */
    if ((dest.Buffer = ExAllocatePoolWithTag(NonPagedPool,
                                             dest.MaximumLength,
                                             TAG)) != NULL) {
      dest.Length = 0;

      /* Get system time. */
      KeQuerySystemTime(&system_time);

      /* Convert system time to local time. */
      ExSystemTimeToLocalTime(&system_time, &local_time);

      RtlTimeToTimeFields(&local_time, &time);

      /* Compose name of the new file. */
      if (NT_SUCCESS(RtlUnicodeStringPrintf(
                       &dest,
                       L"%wZ.%04u%02u%02u_%02u%02u%02u_%03u.%wZ",
                       &name_info->Name,
                       time.Year,
                       time.Month,
                       time.Day,
                       time.Hour,
                       time.Minute,
                       time.Second,
                       time.Milliseconds,
                       &MINIVERS_EXT
                     ))) {
        /* Copy file. */
        if (copy_file(driver_data.filter, instance, &dest, &name_info->Name)) {
          ExFreePoolWithTag(dest.Buffer, TAG);
          FltReleaseFileNameInformation(name_info);

          return TRUE;
        }
      }

      ExFreePoolWithTag(dest.Buffer, TAG);
    }

    FltReleaseFileNameInformation(name_info);
  }

  return FALSE;
}

void deferred_io_workitem(PFLT_DEFERRED_IO_WORKITEM FltWorkItem,
                          PFLT_CALLBACK_DATA CallbackData,
                          PVOID Context)
{
  duplicate_file(CallbackData, Context);

  FltFreeDeferredIoWorkItem(FltWorkItem);

  FltCompletePendedPreOperation(CallbackData,
                                FLT_PREOP_SUCCESS_NO_CALLBACK,
                                NULL);
}

#if LOG_IMAGE_FILENAME
  BOOLEAN get_process_image_filename(PEPROCESS process, void* buf, size_t len)
  {
    HANDLE hProcess;
    NTSTATUS status;

    PAGED_CODE();

    /* Get process handle. */
    if (NT_SUCCESS(ObOpenObjectByPointer(process,
                                         OBJ_KERNEL_HANDLE,
                                         NULL,
                                         0,
                                         0,
                                         KernelMode,
                                         &hProcess))) {
      /* Get process image filename. */
      status = fnQueryInformationProcess(hProcess,
                                         ProcessImageFileName,
                                         buf,
                                         len,
                                         NULL);

      ZwClose(hProcess);

      return NT_SUCCESS(status) ? TRUE : FALSE;
    }

    return FALSE;
  }
#endif /* LOG_IMAGE_FILENAME */

```

`minivers/minivers.h`:

```h
#ifndef MINIVERS_H
#define MINIVERS_H

#include <fltKernel.h>
#include <suppress.h>

#pragma prefast(disable:__WARNING_ENCODE_MEMBER_FUNCTION_POINTER, "Not valid for kernel mode drivers")

#define TAG 'reVM'


/******************************************************************************
 ******************************************************************************
 **                                                                          **
 ** Type definitions.                                                        **
 **                                                                          **
 ******************************************************************************
 ******************************************************************************/
typedef struct {
  /* The filter that results from a call to FltRegisterFilter. */
  PFLT_FILTER filter;
} DRIVER_DATA;


/******************************************************************************
 ******************************************************************************
 **                                                                          **
 ** Global variables.                                                        **
 **                                                                          **
 ******************************************************************************
 ******************************************************************************/
extern const FLT_REGISTRATION filter_registration;


/******************************************************************************
 ******************************************************************************
 **                                                                          **
 ** Function prototypes.                                                     **
 **                                                                          **
 ******************************************************************************
 ******************************************************************************/
FLT_PREOP_CALLBACK_STATUS
PreOperationCallback(
  _Inout_ PFLT_CALLBACK_DATA Data,
  _In_ PCFLT_RELATED_OBJECTS FltObjects,
  _Flt_CompletionContext_Outptr_ PVOID* CompletionContext
);

NTSTATUS InstanceSetup(_In_ PCFLT_RELATED_OBJECTS FltObjects,
                       _In_ FLT_INSTANCE_SETUP_FLAGS Flags,
                       _In_ DEVICE_TYPE VolumeDeviceType,
                       _In_ FLT_FILESYSTEM_TYPE VolumeFilesystemType);

NTSTATUS FilterUnload(_In_ FLT_FILTER_UNLOAD_FLAGS Flags);

NTSTATUS InstanceQueryTeardown(_In_ PCFLT_RELATED_OBJECTS FltObjects,
                               _In_ FLT_INSTANCE_QUERY_TEARDOWN_FLAGS Flags);

#endif /* MINIVERS_H */

```

`minivers/minivers.inf`:

```inf
;;;
;;; minivers
;;;

[Version]
Signature   = "$Windows NT$"
Class       = "ActivityMonitor"                         ;This is determined by the work this filter driver does
ClassGuid   = {b86dff51-a31e-4bac-b3cf-e8cfe75c9fc2}    ;This value is determined by the Class
Provider    = %ManufacturerName%
DriverVer   = 05/28/2017,1.0.0.0
CatalogFile = minivers.cat

[DestinationDirs]
DefaultDestDir          = 12
MiniFilter.DriverFiles  = 12            ;%windir%\system32\drivers

;;
;; Default install sections
;;

[DefaultInstall]
OptionDesc          = %ServiceDescription%
CopyFiles           = MiniFilter.DriverFiles

[DefaultInstall.Services]
AddService          = %ServiceName%,,MiniFilter.Service

;;
;; Default uninstall sections
;;

[DefaultUninstall]
DelFiles   = MiniFilter.DriverFiles

[DefaultUninstall.Services]
DelService = %ServiceName%,0x200      ;Ensure service is stopped before deleting

;
; Services Section
;

[MiniFilter.Service]
DisplayName      = %ServiceName%
Description      = %ServiceDescription%
ServiceBinary    = %12%\%DriverName%.sys        ;%windir%\system32\drivers\
Dependencies     = "FltMgr"
ServiceType      = 2                            ;SERVICE_FILE_SYSTEM_DRIVER
StartType        = 3                            ;SERVICE_DEMAND_START
ErrorControl     = 1                            ;SERVICE_ERROR_NORMAL
LoadOrderGroup   = "FSFilter Activity Monitor"
AddReg           = MiniFilter.AddRegistry

;
; Registry Modifications
;

[MiniFilter.AddRegistry]
HKR,,"DebugFlags",0x00010001 ,0x0
HKR,,"SupportedFeatures",0x00010001,0x3
HKR,"Instances","DefaultInstance",0x00000000,%DefaultInstance%
HKR,"Instances\"%Instance1.Name%,"Altitude",0x00000000,%Instance1.Altitude%
HKR,"Instances\"%Instance1.Name%,"Flags",0x00010001,%Instance1.Flags%

;
; Copy Files
;

[MiniFilter.DriverFiles]
%DriverName%.sys

[SourceDisksFiles]
minivers.sys = 1,,

[SourceDisksNames]
1 = %DiskId1%,,,

;;
;; String Section
;;

[Strings]
; TODO - Add your manufacturer
ManufacturerName        = "Template"
ServiceDescription      = "minivers Mini-Filter Driver"
ServiceName             = "minivers"
DriverName              = "minivers"
DiskId1                 = "minivers Device Installation Disk"

;Instances specific information.
DefaultInstance         = "minivers Instance"
Instance1.Name          = "minivers Instance"
Instance1.Altitude      = "385100" ; minispy.sys - Top
Instance1.Flags         = 0x0              ; Allow all attachments

```

`minivers/minivers.rc`:

```rc
#include <windows.h>

#include <ntverp.h>

#define VER_FILETYPE    VFT_DRV
#define VER_FILESUBTYPE VFT2_DRV_SYSTEM
#define VER_FILEDESCRIPTION_STR     "minivers Filter Driver"
#define VER_INTERNALNAME_STR        "minivers.sys"

#include "common.ver"

```

`minivers/minivers.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Win8.1 Debug|Win32">
      <Configuration>Win8.1 Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win8.1 Release|Win32">
      <Configuration>Win8.1 Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win8 Debug|Win32">
      <Configuration>Win8 Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win8 Release|Win32">
      <Configuration>Win8 Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win7 Debug|Win32">
      <Configuration>Win7 Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win7 Release|Win32">
      <Configuration>Win7 Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win8.1 Debug|x64">
      <Configuration>Win8.1 Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win8.1 Release|x64">
      <Configuration>Win8.1 Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win8 Debug|x64">
      <Configuration>Win8 Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win8 Release|x64">
      <Configuration>Win8 Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win7 Debug|x64">
      <Configuration>Win7 Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Win7 Release|x64">
      <Configuration>Win7 Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="RegistrationData.c" />
    <ResourceCompile Include="minivers.rc" />
    <ClCompile Include="copy_file.c" />
    <ClCompile Include="minivers.c" />
    <Inf Include="minivers.inf" />
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <ProjectGuid>{E337AC23-F84D-4E6D-81E9-729F64684A30}</ProjectGuid>
    <TemplateGuid>{f2f62967-0815-4fd7-9b86-6eedcac766eb}</TemplateGuid>
    <TargetFrameworkVersion>v4.5</TargetFrameworkVersion>
    <MinimumVisualStudioVersion>11.0</MinimumVisualStudioVersion>
    <Configuration>Win8.1 Debug</Configuration>
    <Platform Condition="'$(Platform)' == ''">Win32</Platform>
    <RootNamespace>minivers</RootNamespace>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Debug|Win32'" Label="Configuration">
    <TargetVersion>WindowsV6.3</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Release|Win32'" Label="Configuration">
    <TargetVersion>WindowsV6.3</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Debug|Win32'" Label="Configuration">
    <TargetVersion>Windows8</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Release|Win32'" Label="Configuration">
    <TargetVersion>Windows8</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Debug|Win32'" Label="Configuration">
    <TargetVersion>Windows7</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Release|Win32'" Label="Configuration">
    <TargetVersion>Windows7</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Debug|x64'" Label="Configuration">
    <TargetVersion>WindowsV6.3</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Release|x64'" Label="Configuration">
    <TargetVersion>WindowsV6.3</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Debug|x64'" Label="Configuration">
    <TargetVersion>Windows8</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Release|x64'" Label="Configuration">
    <TargetVersion>Windows8</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Debug|x64'" Label="Configuration">
    <TargetVersion>Windows7</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Release|x64'" Label="Configuration">
    <TargetVersion>Windows7</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver8.1</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="PropertySheets">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Debug|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Release|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Debug|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Release|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Debug|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Release|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Debug|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Release|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Debug|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Release|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Debug|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Release|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Debug|Win32'">
    <Link>
      <AdditionalDependencies>$(DDK_LIB_PATH)\fltmgr.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Release|Win32'">
    <Link>
      <AdditionalDependencies>$(DDK_LIB_PATH)\fltmgr.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Debug|Win32'">
    <Link>
      <AdditionalDependencies>$(DDK_LIB_PATH)\fltmgr.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Release|Win32'">
    <Link>
      <AdditionalDependencies>$(DDK_LIB_PATH)\fltmgr.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Debug|Win32'">
    <Link>
      <AdditionalDependencies>$(DDK_LIB_PATH)\fltmgr.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Release|Win32'">
    <Link>
      <AdditionalDependencies>$(DDK_LIB_PATH)\fltmgr.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Debug|x64'">
    <Link>
      <AdditionalDependencies>$(DDK_LIB_PATH)\fltmgr.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Win8.1 Release|x64'">
    <Link>
      <AdditionalDependencies>$(DDK_LIB_PATH)\fltmgr.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Debug|x64'">
    <Link>
      <AdditionalDependencies>$(DDK_LIB_PATH)\fltmgr.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Win8 Release|x64'">
    <Link>
      <AdditionalDependencies>$(DDK_LIB_PATH)\fltmgr.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Debug|x64'">
    <Link>
      <AdditionalDependencies>$(DDK_LIB_PATH)\fltmgr.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Win7 Release|x64'">
    <Link>
      <AdditionalDependencies>$(DDK_LIB_PATH)\fltmgr.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <FilesToPackage Include="$(TargetPath)" />
    <FilesToPackage Include="@(Inf->'%(CopyOutput)')" Condition="'@(Inf)'!=''" />
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="copy_file.h" />
    <ClInclude Include="minivers.h" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`minivers/minivers.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hpp;hxx;hm;inl;inc;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
    <Filter Include="Driver Files">
      <UniqueIdentifier>{8E41214B-6785-4CFE-B992-037D68949A14}</UniqueIdentifier>
      <Extensions>inf;inv;inx;mof;mc;</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <Inf Include="minivers.inf">
      <Filter>Driver Files</Filter>
    </Inf>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="minivers.c">
      <Filter>Source Files</Filter>
    </ClCompile>
    <ClCompile Include="copy_file.c">
      <Filter>Source Files</Filter>
    </ClCompile>
    <ClCompile Include="RegistrationData.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
  <ItemGroup>
    <ResourceCompile Include="minivers.rc">
      <Filter>Resource Files</Filter>
    </ResourceCompile>
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="minivers.h">
      <Filter>Header Files</Filter>
    </ClInclude>
    <ClInclude Include="copy_file.h">
      <Filter>Header Files</Filter>
    </ClInclude>
  </ItemGroup>
</Project>
```