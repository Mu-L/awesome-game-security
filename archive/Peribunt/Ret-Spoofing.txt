Project Path: arc_Peribunt_Ret-Spoofing_azydss3p

Source Tree:

```txt
arc_Peribunt_Ret-Spoofing_azydss3p
├── README.md
├── Shellcode.asm
└── Source.cpp

```

`README.md`:

```md
# Ret Spoofing
A simple and minimalistic way to spoof return addresses without using an exception handler

# Pros & Cons
Pros:
* Very easy to implement
* Very easy to use
* Little to no performance decrease

Cons:
* Relies on the preservation of the nonvolatile GPRs of the x64 calling convention
  * Which in this case means it expects these registers to be preserved, in very rare cases they might not be
  * Read [MSDN Documentation for Caller/Callee Saved registers](https://docs.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-170#callercallee-saved-registers)

```

`Shellcode.asm`:

```asm
.code

InitSpoofCall PROC
	movq   xmm15, rdx
	pinsrq xmm15, rcx, 1
	ret
InitSpoofCall ENDP

SpoofCall PROC
	mov     rbx, qword ptr[rsp]
	movq    qword ptr[rsp], xmm15
	movhlps xmm15, xmm15
	sub     rsp, 8
	movq    qword ptr[rsp], xmm15
	ret
SpoofCall ENDP

END

```

`Source.cpp`:

```cpp
#include <windows.h>
#include <cstdio>

#define SPOOFER_NOINLINE __declspec( noinline )
#define SPOOFER_INLINE __forceinline

#define CONSOLE_PAUSE( ) \
system( "pause" )

#define CONSOLE_LOG( Fmt, ... ) \
printf( "[!] " __FUNCTION__ ": " Fmt "\n", ##__VA_ARGS__ )

#pragma code_seg( push, ".text" )
__declspec( allocate( ".text" ) )
BYTE JMP_RBX_TEST[] = 
{ 
	0xFF, 0xE3 
};
#pragma code_seg( pop )

namespace ReturnSpoofer
{
	extern "C" 
		ULONG_PTR SpoofCall(
			IN ... );

	extern "C"
		VOID InitSpoofCall(
			IN LPVOID Function,
			IN LPVOID FakeRet );

	template< typename _RET_TYPE_,
		typename... _VA_ARGS_ >
		SPOOFER_NOINLINE
		_RET_TYPE_ WINAPI DoSpoofCall(
			IN LPVOID Function,
			IN LPVOID FakeRet,
			IN OUT _VA_ARGS_... Args OPTIONAL )
		noexcept
	{
		InitSpoofCall( Function, FakeRet );

		return ( ( _RET_TYPE_( * )( IN OUT ... OPTIONAL ) )SpoofCall )
			( Args... );
	}
}

LONG main( VOID )
{
	DWORD Result =
		ReturnSpoofer::DoSpoofCall<DWORD>( MessageBoxA, (PBYTE)JMP_RBX_TEST,
			NULL, "Hello World", "Spoofed call", NULL );

	//
	// Log to prove both execution flow lands here and the value returned properly
	//
	CONSOLE_LOG( "MessageBoxA Result: %i", Result );

	CONSOLE_PAUSE( );

	return NULL;
}

```