Project Path: arc_rednaga_frida-stack_3s30tla7

Source Tree:

```txt
arc_rednaga_frida-stack_3s30tla7
├── README.md
├── biome.json
├── lib
│   └── index.ts
├── package-lock.json
├── package.json
└── tsconfig.json

```

`README.md`:

```md
# frida-stack

Small frida module for ensuring you get the stack information you wanted.

## What?

Often when using [Frida](https://github.com/frida/frida), I would run into issues
with wanting specific stack traces. Then I realized I didn't have a specific context
window, or the stack traces didn't contain the correct shared libraries in them. This
resulted in me re-writing the same functions all the time.

In other instances, mostly when reverse engineering heavily obfuscated or packed code,
I would have discovered functions or places in memory which had been created without any
exports available. This would lead to questions like, what process/library owned this? Where
am I inside those libraries?

To answer the above questions, I wrapped some of the standard `Thread.Backtrace` functions
and added some scanning of the `Process` memory ranges.

## Installing

```sh
$ npm install frida-stack
```

## Usage

```typescript

import { Stack } from 'frida-stack'

function hook_exit() {
  const _exitPtr = Process.findModuleByName("libc.so")?.findExportByName("_exit");

  if (_exitPtr) {
    const _exit = new NativeFunction(_exitPtr, 'int', ['int']);

    Interceptor.replace(
      _exitPtr,
      new NativeCallback(
        function (status) {
          console.log(`[+] _exit : ${status} from ${Stack.getModuleInfo(this.context.pc)}`);
	        console.log(Stack.native(this.context)
          return _exit(status);
        },
        'int',
        ['int'],
      ),
    );
  }
}
```

Output:
```
[Pixel 4::com.example.package ]-> [+] _exit : 0 from 0x7713d25000 libexamplesharedlib.so:0x1aae8
0x7713d25000 libexamplesharedlib.so:0x1aae8
```

Now you have a library and the exact offset into the library for reversing.


## License

```
Copyright 2020-2025 Tim 'diff' Strazzere <diff@protonmail.com>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
```
```

`biome.json`:

```json
{
  "javascript": {
    "parser": {
      "unsafeParameterDecoratorsEnabled": true
    },
    "formatter": {
      "indentStyle": "space"
    }
  }
}
```

`lib/index.ts`:

```ts
/**
 * Copyright (C) 2024-2025 Red Naga, LLC - Tim Strazzere <diff@protonmail.com>
 *
 * Helper class for getting stack traces and backtraces while debugging with
 * Frida, primarily used for Android.
 *
 */

import Java from "frida-java-bridge";

export class Stack {
  private threadObj!: Java.Wrapper<object>;

  constructor() {
    if (!Java.available) {
      throw new Error(
        `Unable to initialize a Java stacktrace object when Java is unavailable`,
      );
    }

    Java.perform(() => {
      const ThreadDef = Java.use("java.lang.Thread");
      this.threadObj = ThreadDef.$new();
    });
  }

  /**
   * @returns {string} a java stack trace of where this was called
   */
  java(): string {
    if (!this.threadObj) {
      throw new Error("No java stack available as no thread object available");
    }

    const trace = this.threadObj.currentThread().getStackTrace();

    // Skip our own frames (getStackStrace/getThreadStackTrace)
    return trace
      .slice(2)
      .map((frame: string, i: number) => `${i + 1} => ${String(frame)}`)
      .join("\n");
  }

  /**
   * Note: This may block a java thread while running and act in a different manner
   * than expected.
   *
   * @returns {string} a java stack trace of where this was called statically
   */
  static java(): string {
    if (!Java.available) {
      throw new Error(`Java is not available`);
    }

    let stackTrace = "";
    Java.performNow(() => {
      const trace = Java.use("java.lang.Thread")
        .currentThread()
        .getStackTrace();

      // Skip our own frames (getStackStrace/getThreadStackTrace)
      stackTrace = trace
        .slice(2)
        .map((frame: string, i: number) => `${i + 1} => ${String(frame)}`)
        .join("\n");
    });

    return stackTrace;
  }

  /**
   * @param context in which to get a native backtrace
   * @returns string of backtrace
   */
  static native(context: CpuContext): string {
    return `${Thread.backtrace(context, Backtracer.ACCURATE).map(Stack.getModuleInfo).join("\n")}\n"`;
  }

  /**
   * Return a decorated string, similar to DebugSymbol.fromAddress
   * and Process.getModuleFromAddress, however if those fail we
   * will forcefully look up the address association via the mappings.
   *
   * For some reason, DebugSymbol.fromAddress doesn't always work,
   * nor does Process.getModuleFromAddress, so utilize enumerating the
   * addresses manually to figure out what the module is and the local
   * offset inside it.
   *
   * @param address Address to look up details for.
   * @returns string of relevant data `0x7713d25000 libsharedlib.so:0x1aae8`
   */
  static getModuleInfo(address: NativePointer) {
    const debugSymbol = DebugSymbol.fromAddress(address);

    if (debugSymbol.moduleName) {
      // Add local offset?
      return debugSymbol.toString();
    }

    // When hooking we might get something interesting like the following;
    //  [
    //    {
    //      "base": "0x76fa7000",    <==== [anon:dalvik-free list large object space]
    //      "protection": "rw-",           we don't actually care about this
    //      "size": 536870912
    //    },
    //    {
    //      "base": "0x771e939000", <==== this isn't the actual base, we need to refind that
    //      "file": {
    //        "offset": 663552,
    //         "path": "/apex/com.android.runtime/lib64/bionic/libc.so",
    //         "size": 0
    //      },
    //     "protection": "rwx",
    //     "size": 4096
    //   }
    // ]

    const builtSymbol = {
      base: ptr(0x0),
      moduleName: "",
      path: "",
      size: 0,
    };

    let ranges = Process.enumerateRanges("").filter(
      (range) => range.base <= address && range.base.add(range.size) >= address,
    );

    ranges.forEach((range) => {
      if (range.file) {
        builtSymbol.path = range.file.path;
        const moduleNameChunks = range.file.path.split("/");
        builtSymbol.moduleName = moduleNameChunks[moduleNameChunks.length - 1];

        builtSymbol.base = range.base.sub(range.file.offset);
      }
    });

    ranges = Process.enumerateRanges("").filter(
      (range) =>
        range.base <= builtSymbol.base &&
        range.base.add(range.size) >= builtSymbol.base,
    );

    ranges.forEach((range) => {
      if (builtSymbol.base === ptr(0x0) || builtSymbol.base < range.base) {
        builtSymbol.base = range.base;
      }
      builtSymbol.size += range.size;
    });

    return `${builtSymbol.base} ${builtSymbol.moduleName}:${address.sub(builtSymbol.base)}`;
  }
}

```

`package-lock.json`:

```json
{
  "name": "frida-stack",
  "version": "1.1.0",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {
    "": {
      "name": "frida-stack",
      "version": "1.1.0",
      "license": "Apache-2.0",
      "dependencies": {
        "frida-fs": "^7.0.0",
        "frida-java-bridge": "^7.0.12"
      },
      "devDependencies": {
        "@biomejs/biome": "^2.4.3",
        "@types/frida-gum": "^19.0.1",
        "@types/node": "^25.3.0",
        "typescript": "^5.3.3"
      }
    },
    "node_modules/@biomejs/biome": {
      "version": "2.4.3",
      "resolved": "https://registry.npmjs.org/@biomejs/biome/-/biome-2.4.3.tgz",
      "integrity": "sha512-cBrjf6PNF6yfL8+kcNl85AjiK2YHNsbU0EvDOwiZjBPbMbQ5QcgVGFpjD0O52p8nec5O8NYw7PKw3xUR7fPAkQ==",
      "dev": true,
      "license": "MIT OR Apache-2.0",
      "bin": {
        "biome": "bin/biome"
      },
      "engines": {
        "node": ">=14.21.3"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/biome"
      },
      "optionalDependencies": {
        "@biomejs/cli-darwin-arm64": "2.4.3",
        "@biomejs/cli-darwin-x64": "2.4.3",
        "@biomejs/cli-linux-arm64": "2.4.3",
        "@biomejs/cli-linux-arm64-musl": "2.4.3",
        "@biomejs/cli-linux-x64": "2.4.3",
        "@biomejs/cli-linux-x64-musl": "2.4.3",
        "@biomejs/cli-win32-arm64": "2.4.3",
        "@biomejs/cli-win32-x64": "2.4.3"
      }
    },
    "node_modules/@biomejs/cli-darwin-arm64": {
      "version": "2.4.3",
      "resolved": "https://registry.npmjs.org/@biomejs/cli-darwin-arm64/-/cli-darwin-arm64-2.4.3.tgz",
      "integrity": "sha512-eOafSFlI/CF4id2tlwq9CVHgeEqvTL5SrhWff6ZORp6S3NL65zdsR3ugybItkgF8Pf4D9GSgtbB6sE3UNgOM9w==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT OR Apache-2.0",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=14.21.3"
      }
    },
    "node_modules/@biomejs/cli-darwin-x64": {
      "version": "2.4.3",
      "resolved": "https://registry.npmjs.org/@biomejs/cli-darwin-x64/-/cli-darwin-x64-2.4.3.tgz",
      "integrity": "sha512-V2+av4ilbWcBMNufTtMMXVW00nPwyIjI5qf7n9wSvUaZ+tt0EvMGk46g9sAFDJBEDOzSyoRXiSP6pCvKTOEbPA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT OR Apache-2.0",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=14.21.3"
      }
    },
    "node_modules/@biomejs/cli-linux-arm64": {
      "version": "2.4.3",
      "resolved": "https://registry.npmjs.org/@biomejs/cli-linux-arm64/-/cli-linux-arm64-2.4.3.tgz",
      "integrity": "sha512-0m+O0x9FgK99FAwDK+fiDtjs2wnqq7bvfj17KJVeCkTwT/liI+Q9njJG7lwXK0iSJVXeFNRIxukpVI3SifMYAA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT OR Apache-2.0",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=14.21.3"
      }
    },
    "node_modules/@biomejs/cli-linux-arm64-musl": {
      "version": "2.4.3",
      "resolved": "https://registry.npmjs.org/@biomejs/cli-linux-arm64-musl/-/cli-linux-arm64-musl-2.4.3.tgz",
      "integrity": "sha512-QuFzvsGo8BA4Xm7jGX5idkw6BqFblcCPySMTvq0AhGYnhUej5VJIDJbmTKfHqwjHepZiC4fA+T5i6wmiZolZNw==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT OR Apache-2.0",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=14.21.3"
      }
    },
    "node_modules/@biomejs/cli-linux-x64": {
      "version": "2.4.3",
      "resolved": "https://registry.npmjs.org/@biomejs/cli-linux-x64/-/cli-linux-x64-2.4.3.tgz",
      "integrity": "sha512-NVqh0saIU0u5OfOp/0jFdlKRE59+XyMvWmtx0f6Nm/2OpdxBl04coRIftBbY9d1gfu+23JVv4CItAqPYrjYh5w==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT OR Apache-2.0",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=14.21.3"
      }
    },
    "node_modules/@biomejs/cli-linux-x64-musl": {
      "version": "2.4.3",
      "resolved": "https://registry.npmjs.org/@biomejs/cli-linux-x64-musl/-/cli-linux-x64-musl-2.4.3.tgz",
      "integrity": "sha512-qEc0OCpj/uytruQ4wLM0yWNJLZy0Up8H1Er5MW3SrstqM6J2d4XqdNA86xzCy8MQCHpoVZ3lFye3GBlIL4/ljw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT OR Apache-2.0",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=14.21.3"
      }
    },
    "node_modules/@biomejs/cli-win32-arm64": {
      "version": "2.4.3",
      "resolved": "https://registry.npmjs.org/@biomejs/cli-win32-arm64/-/cli-win32-arm64-2.4.3.tgz",
      "integrity": "sha512-gRO96vrIARilv/Cp2ZnmNNL5LSZg3RO75GPp13hsLO3N4YVpE7saaMDp2bcyV48y2N2Pbit1brkGVGta0yd6VQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT OR Apache-2.0",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=14.21.3"
      }
    },
    "node_modules/@biomejs/cli-win32-x64": {
      "version": "2.4.3",
      "resolved": "https://registry.npmjs.org/@biomejs/cli-win32-x64/-/cli-win32-x64-2.4.3.tgz",
      "integrity": "sha512-vSm/vOJe06pf14aGHfHl3Ar91Nlx4YYmohElDJ+17UbRwe99n987S/MhAlQOkONqf1utJor04ChkCPmKb8SWdw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT OR Apache-2.0",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=14.21.3"
      }
    },
    "node_modules/@types/frida-gum": {
      "version": "19.0.1",
      "resolved": "https://registry.npmjs.org/@types/frida-gum/-/frida-gum-19.0.1.tgz",
      "integrity": "sha512-mp8BpWWkQFJH86ZN5uXZuDiA7KY/+jDknrw0a06x0/+F5ucPwctHrCuV6iT+LLCp/GyICc36ssedF33B1WoLsw==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/node": {
      "version": "25.3.0",
      "resolved": "https://registry.npmjs.org/@types/node/-/node-25.3.0.tgz",
      "integrity": "sha512-4K3bqJpXpqfg2XKGK9bpDTc6xO/xoUP/RBWS7AtRMug6zZFaRekiLzjVtAoZMquxoAbzBvy5nxQ7veS5eYzf8A==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "undici-types": "~7.18.0"
      }
    },
    "node_modules/frida-fs": {
      "version": "7.0.0",
      "resolved": "https://registry.npmjs.org/frida-fs/-/frida-fs-7.0.0.tgz",
      "integrity": "sha512-95m7LCjuFMZObrR/37tlEUHAKC0UP82vWBtcaFntUSFr5MuqhoZG6FDCXKl58FhTf0SwOCYvwctCYPLV3/pHgw==",
      "license": "MIT"
    },
    "node_modules/frida-java-bridge": {
      "version": "7.0.12",
      "resolved": "https://registry.npmjs.org/frida-java-bridge/-/frida-java-bridge-7.0.12.tgz",
      "integrity": "sha512-xpoTFPQkUjNMeRnyZ6rUj/APlYGWpKEv5iekOk4lQeDcv9fv8J/s3ETjTRdSfyZ8/aPv9r8+oBmsxN2gCHRTqg==",
      "license": "LGPL-2.0 WITH WxWindows-exception-3.1"
    },
    "node_modules/typescript": {
      "version": "5.9.3",
      "resolved": "https://registry.npmjs.org/typescript/-/typescript-5.9.3.tgz",
      "integrity": "sha512-jl1vZzPDinLr9eUt3J/t7V6FgNEw9QjvBPdysz9KfQDD41fQrC2Y4vKQdiaUpFT4bXlb1RHhLpp8wtm6M5TgSw==",
      "dev": true,
      "license": "Apache-2.0",
      "bin": {
        "tsc": "bin/tsc",
        "tsserver": "bin/tsserver"
      },
      "engines": {
        "node": ">=14.17"
      }
    },
    "node_modules/undici-types": {
      "version": "7.18.2",
      "resolved": "https://registry.npmjs.org/undici-types/-/undici-types-7.18.2.tgz",
      "integrity": "sha512-AsuCzffGHJybSaRrmr5eHr81mwJU3kjw6M+uprWvCXiNeN9SOGwQ3Jn8jb8m3Z6izVgknn1R0FTCEAP2QrLY/w==",
      "dev": true,
      "license": "MIT"
    }
  }
}

```

`package.json`:

```json
{
  "name": "frida-stack",
  "version": "1.1.0",
  "description": "Getting better stacks and backtraces in Frida",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "files": [
    "/dist/**/*.js",
    "/dist/**/*.d.ts"
  ],
  "type": "module",
  "repository": {
    "type": "git",
    "url": "git+https://github.com/rednaga/frida-stack.git"
  },
  "author": "Tim Strazzere <diff@protonmail.com>",
  "keywords": [
    "frida",
    "frida-gum",
    "stacks",
    "reverse-engineering"
  ],
  "license": "Apache-2.0",
  "scripts": {
    "lint": "npx @biomejs/biome check --write ./lib",
    "prepare": "npm run build",
    "build": "tsc",
    "watch": "tsc -w"
  },
  "devDependencies": {
    "@biomejs/biome": "^2.4.3",
    "@types/frida-gum": "^19.0.1",
    "@types/node": "^25.3.0",
    "typescript": "^5.3.3"
  },
  "dependencies": {
    "frida-fs": "^7.0.0",
    "frida-java-bridge": "^7.0.12"
  }
}

```

`tsconfig.json`:

```json
{
  "compilerOptions": {
    "target": "es2020",
    "lib": ["es2020"],
    "module": "Node16",
    "moduleResolution": "node16",
    "strict": true,
    "skipLibCheck": true,
    "declaration": true,
    "outDir": "./dist"
  },
  "include": [
    "lib/**/*"
  ],
  "exclude": [
    "src/**/*.spec.ts",
    "node_modules",
    "./node_modules",
    "./node_modules/**/*",
    "./node_modules/@types/node/index.d.ts",
  ],
}

```