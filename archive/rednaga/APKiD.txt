Project Path: arc_rednaga_APKiD_3cmgkc9o

Source Tree:

```txt
arc_rednaga_APKiD_3cmgkc9o
├── AUTHORS.txt
├── Dockerfile
├── LICENSE.COMMERCIAL
├── LICENSE.GPL
├── MANIFEST.in
├── README.md
├── README.rst
├── apkid
│   ├── __init__.py
│   ├── apkid.py
│   ├── main.py
│   ├── output.py
│   ├── rules
│   │   ├── apk
│   │   │   ├── common.yara
│   │   │   ├── obfuscators.yara
│   │   │   ├── packers.yara
│   │   │   └── protectors.yara
│   │   ├── dex
│   │   │   ├── abnormal.yara
│   │   │   ├── anti-vm.yara
│   │   │   ├── common.yara
│   │   │   ├── compilers.yara
│   │   │   ├── obfuscators.yara
│   │   │   ├── packers.yara
│   │   │   └── protectors.yara
│   │   ├── dll
│   │   │   ├── common.yara
│   │   │   └── obfuscators.yara
│   │   ├── elf
│   │   │   ├── anti-vm.yara
│   │   │   ├── common.yara
│   │   │   ├── obfuscators.yara
│   │   │   ├── packers.yara
│   │   │   └── protectors.yara
│   │   └── res
│   │       ├── common.yara
│   │       ├── obfuscators.yara
│   │       └── protectors.yara
│   └── rules.py
├── apkid.iml
├── docker
│   └── apkid.sh
├── prep-release.py
├── setup.cfg
├── setup.py
└── tests
    ├── __init__.py
    ├── conftest.py
    ├── factories.py
    ├── test_rules.py
    └── test_scanner.py

```

`AUTHORS.txt`:

```txt
Caleb Fenton <calebjfenton -at- gmail.com> <caleb -at- sentinelone.com>
Tim 'diff' Strazzere <strazz -at- gmail.com>

```

`Dockerfile`:

```
FROM python:3.11-slim
LABEL maintainer="RedNaga <rednaga@protonmail.com>"

RUN groupadd -g 999 appuser && \
    useradd -r -u 999 -g appuser appuser

WORKDIR /apkid
COPY . .

RUN python -m venv --copies /opt/venv

ENV PATH="/opt/venv/bin:$PATH"

RUN python -m pip install yara-python-dex>=1.0.5 \
    && python prep-release.py \
    && python -m pip install .

# Place to bind a mount point to for scratch pad work
RUN mkdir /input
WORKDIR /input

RUN chown -R appuser:appuser /apkid && \
    chown -R appuser:appuser /input
USER appuser

ENTRYPOINT ["apkid"]

```

`LICENSE.COMMERCIAL`:

```COMMERCIAL
The commercial license of APKiD allows you to use APKiD and accompanying rules in commercial products.

- The APKiD commercial license is perpetual and royalty-free.
- You have the right to distribute the binary and modifications of APKiD.
- No source code redistribution is allowed in any way.

Contact rednaga@protonmail.com for further information.
```

`LICENSE.GPL`:

```GPL
                    GNU GENERAL PUBLIC LICENSE
                       Version 3, 29 June 2007

 Copyright (C) 2007 Free Software Foundation, Inc. <http://fsf.org/>
 Everyone is permitted to copy and distribute verbatim copies
 of this license document, but changing it is not allowed.

                            Preamble

  The GNU General Public License is a free, copyleft license for
software and other kinds of works.

  The licenses for most software and other practical works are designed
to take away your freedom to share and change the works.  By contrast,
the GNU General Public License is intended to guarantee your freedom to
share and change all versions of a program--to make sure it remains free
software for all its users.  We, the Free Software Foundation, use the
GNU General Public License for most of our software; it applies also to
any other work released this way by its authors.  You can apply it to
your programs, too.

  When we speak of free software, we are referring to freedom, not
price.  Our General Public Licenses are designed to make sure that you
have the freedom to distribute copies of free software (and charge for
them if you wish), that you receive source code or can get it if you
want it, that you can change the software or use pieces of it in new
free programs, and that you know you can do these things.

  To protect your rights, we need to prevent others from denying you
these rights or asking you to surrender the rights.  Therefore, you have
certain responsibilities if you distribute copies of the software, or if
you modify it: responsibilities to respect the freedom of others.

  For example, if you distribute copies of such a program, whether
gratis or for a fee, you must pass on to the recipients the same
freedoms that you received.  You must make sure that they, too, receive
or can get the source code.  And you must show them these terms so they
know their rights.

  Developers that use the GNU GPL protect your rights with two steps:
(1) assert copyright on the software, and (2) offer you this License
giving you legal permission to copy, distribute and/or modify it.

  For the developers' and authors' protection, the GPL clearly explains
that there is no warranty for this free software.  For both users' and
authors' sake, the GPL requires that modified versions be marked as
changed, so that their problems will not be attributed erroneously to
authors of previous versions.

  Some devices are designed to deny users access to install or run
modified versions of the software inside them, although the manufacturer
can do so.  This is fundamentally incompatible with the aim of
protecting users' freedom to change the software.  The systematic
pattern of such abuse occurs in the area of products for individuals to
use, which is precisely where it is most unacceptable.  Therefore, we
have designed this version of the GPL to prohibit the practice for those
products.  If such problems arise substantially in other domains, we
stand ready to extend this provision to those domains in future versions
of the GPL, as needed to protect the freedom of users.

  Finally, every program is threatened constantly by software patents.
States should not allow patents to restrict development and use of
software on general-purpose computers, but in those that do, we wish to
avoid the special danger that patents applied to a free program could
make it effectively proprietary.  To prevent this, the GPL assures that
patents cannot be used to render the program non-free.

  The precise terms and conditions for copying, distribution and
modification follow.

                       TERMS AND CONDITIONS

  0. Definitions.

  "This License" refers to version 3 of the GNU General Public License.

  "Copyright" also means copyright-like laws that apply to other kinds of
works, such as semiconductor masks.

  "The Program" refers to any copyrightable work licensed under this
License.  Each licensee is addressed as "you".  "Licensees" and
"recipients" may be individuals or organizations.

  To "modify" a work means to copy from or adapt all or part of the work
in a fashion requiring copyright permission, other than the making of an
exact copy.  The resulting work is called a "modified version" of the
earlier work or a work "based on" the earlier work.

  A "covered work" means either the unmodified Program or a work based
on the Program.

  To "propagate" a work means to do anything with it that, without
permission, would make you directly or secondarily liable for
infringement under applicable copyright law, except executing it on a
computer or modifying a private copy.  Propagation includes copying,
distribution (with or without modification), making available to the
public, and in some countries other activities as well.

  To "convey" a work means any kind of propagation that enables other
parties to make or receive copies.  Mere interaction with a user through
a computer network, with no transfer of a copy, is not conveying.

  An interactive user interface displays "Appropriate Legal Notices"
to the extent that it includes a convenient and prominently visible
feature that (1) displays an appropriate copyright notice, and (2)
tells the user that there is no warranty for the work (except to the
extent that warranties are provided), that licensees may convey the
work under this License, and how to view a copy of this License.  If
the interface presents a list of user commands or options, such as a
menu, a prominent item in the list meets this criterion.

  1. Source Code.

  The "source code" for a work means the preferred form of the work
for making modifications to it.  "Object code" means any non-source
form of a work.

  A "Standard Interface" means an interface that either is an official
standard defined by a recognized standards body, or, in the case of
interfaces specified for a particular programming language, one that
is widely used among developers working in that language.

  The "System Libraries" of an executable work include anything, other
than the work as a whole, that (a) is included in the normal form of
packaging a Major Component, but which is not part of that Major
Component, and (b) serves only to enable use of the work with that
Major Component, or to implement a Standard Interface for which an
implementation is available to the public in source code form.  A
"Major Component", in this context, means a major essential component
(kernel, window system, and so on) of the specific operating system
(if any) on which the executable work runs, or a compiler used to
produce the work, or an object code interpreter used to run it.

  The "Corresponding Source" for a work in object code form means all
the source code needed to generate, install, and (for an executable
work) run the object code and to modify the work, including scripts to
control those activities.  However, it does not include the work's
System Libraries, or general-purpose tools or generally available free
programs which are used unmodified in performing those activities but
which are not part of the work.  For example, Corresponding Source
includes interface definition files associated with source files for
the work, and the source code for shared libraries and dynamically
linked subprograms that the work is specifically designed to require,
such as by intimate data communication or control flow between those
subprograms and other parts of the work.

  The Corresponding Source need not include anything that users
can regenerate automatically from other parts of the Corresponding
Source.

  The Corresponding Source for a work in source code form is that
same work.

  2. Basic Permissions.

  All rights granted under this License are granted for the term of
copyright on the Program, and are irrevocable provided the stated
conditions are met.  This License explicitly affirms your unlimited
permission to run the unmodified Program.  The output from running a
covered work is covered by this License only if the output, given its
content, constitutes a covered work.  This License acknowledges your
rights of fair use or other equivalent, as provided by copyright law.

  You may make, run and propagate covered works that you do not
convey, without conditions so long as your license otherwise remains
in force.  You may convey covered works to others for the sole purpose
of having them make modifications exclusively for you, or provide you
with facilities for running those works, provided that you comply with
the terms of this License in conveying all material for which you do
not control copyright.  Those thus making or running the covered works
for you must do so exclusively on your behalf, under your direction
and control, on terms that prohibit them from making any copies of
your copyrighted material outside their relationship with you.

  Conveying under any other circumstances is permitted solely under
the conditions stated below.  Sublicensing is not allowed; section 10
makes it unnecessary.

  3. Protecting Users' Legal Rights From Anti-Circumvention Law.

  No covered work shall be deemed part of an effective technological
measure under any applicable law fulfilling obligations under article
11 of the WIPO copyright treaty adopted on 20 December 1996, or
similar laws prohibiting or restricting circumvention of such
measures.

  When you convey a covered work, you waive any legal power to forbid
circumvention of technological measures to the extent such circumvention
is effected by exercising rights under this License with respect to
the covered work, and you disclaim any intention to limit operation or
modification of the work as a means of enforcing, against the work's
users, your or third parties' legal rights to forbid circumvention of
technological measures.

  4. Conveying Verbatim Copies.

  You may convey verbatim copies of the Program's source code as you
receive it, in any medium, provided that you conspicuously and
appropriately publish on each copy an appropriate copyright notice;
keep intact all notices stating that this License and any
non-permissive terms added in accord with section 7 apply to the code;
keep intact all notices of the absence of any warranty; and give all
recipients a copy of this License along with the Program.

  You may charge any price or no price for each copy that you convey,
and you may offer support or warranty protection for a fee.

  5. Conveying Modified Source Versions.

  You may convey a work based on the Program, or the modifications to
produce it from the Program, in the form of source code under the
terms of section 4, provided that you also meet all of these conditions:

    a) The work must carry prominent notices stating that you modified
    it, and giving a relevant date.

    b) The work must carry prominent notices stating that it is
    released under this License and any conditions added under section
    7.  This requirement modifies the requirement in section 4 to
    "keep intact all notices".

    c) You must license the entire work, as a whole, under this
    License to anyone who comes into possession of a copy.  This
    License will therefore apply, along with any applicable section 7
    additional terms, to the whole of the work, and all its parts,
    regardless of how they are packaged.  This License gives no
    permission to license the work in any other way, but it does not
    invalidate such permission if you have separately received it.

    d) If the work has interactive user interfaces, each must display
    Appropriate Legal Notices; however, if the Program has interactive
    interfaces that do not display Appropriate Legal Notices, your
    work need not make them do so.

  A compilation of a covered work with other separate and independent
works, which are not by their nature extensions of the covered work,
and which are not combined with it such as to form a larger program,
in or on a volume of a storage or distribution medium, is called an
"aggregate" if the compilation and its resulting copyright are not
used to limit the access or legal rights of the compilation's users
beyond what the individual works permit.  Inclusion of a covered work
in an aggregate does not cause this License to apply to the other
parts of the aggregate.

  6. Conveying Non-Source Forms.

  You may convey a covered work in object code form under the terms
of sections 4 and 5, provided that you also convey the
machine-readable Corresponding Source under the terms of this License,
in one of these ways:

    a) Convey the object code in, or embodied in, a physical product
    (including a physical distribution medium), accompanied by the
    Corresponding Source fixed on a durable physical medium
    customarily used for software interchange.

    b) Convey the object code in, or embodied in, a physical product
    (including a physical distribution medium), accompanied by a
    written offer, valid for at least three years and valid for as
    long as you offer spare parts or customer support for that product
    model, to give anyone who possesses the object code either (1) a
    copy of the Corresponding Source for all the software in the
    product that is covered by this License, on a durable physical
    medium customarily used for software interchange, for a price no
    more than your reasonable cost of physically performing this
    conveying of source, or (2) access to copy the
    Corresponding Source from a network server at no charge.

    c) Convey individual copies of the object code with a copy of the
    written offer to provide the Corresponding Source.  This
    alternative is allowed only occasionally and noncommercially, and
    only if you received the object code with such an offer, in accord
    with subsection 6b.

    d) Convey the object code by offering access from a designated
    place (gratis or for a charge), and offer equivalent access to the
    Corresponding Source in the same way through the same place at no
    further charge.  You need not require recipients to copy the
    Corresponding Source along with the object code.  If the place to
    copy the object code is a network server, the Corresponding Source
    may be on a different server (operated by you or a third party)
    that supports equivalent copying facilities, provided you maintain
    clear directions next to the object code saying where to find the
    Corresponding Source.  Regardless of what server hosts the
    Corresponding Source, you remain obligated to ensure that it is
    available for as long as needed to satisfy these requirements.

    e) Convey the object code using peer-to-peer transmission, provided
    you inform other peers where the object code and Corresponding
    Source of the work are being offered to the general public at no
    charge under subsection 6d.

  A separable portion of the object code, whose source code is excluded
from the Corresponding Source as a System Library, need not be
included in conveying the object code work.

  A "User Product" is either (1) a "consumer product", which means any
tangible personal property which is normally used for personal, family,
or household purposes, or (2) anything designed or sold for incorporation
into a dwelling.  In determining whether a product is a consumer product,
doubtful cases shall be resolved in favor of coverage.  For a particular
product received by a particular user, "normally used" refers to a
typical or common use of that class of product, regardless of the status
of the particular user or of the way in which the particular user
actually uses, or expects or is expected to use, the product.  A product
is a consumer product regardless of whether the product has substantial
commercial, industrial or non-consumer uses, unless such uses represent
the only significant mode of use of the product.

  "Installation Information" for a User Product means any methods,
procedures, authorization keys, or other information required to install
and execute modified versions of a covered work in that User Product from
a modified version of its Corresponding Source.  The information must
suffice to ensure that the continued functioning of the modified object
code is in no case prevented or interfered with solely because
modification has been made.

  If you convey an object code work under this section in, or with, or
specifically for use in, a User Product, and the conveying occurs as
part of a transaction in which the right of possession and use of the
User Product is transferred to the recipient in perpetuity or for a
fixed term (regardless of how the transaction is characterized), the
Corresponding Source conveyed under this section must be accompanied
by the Installation Information.  But this requirement does not apply
if neither you nor any third party retains the ability to install
modified object code on the User Product (for example, the work has
been installed in ROM).

  The requirement to provide Installation Information does not include a
requirement to continue to provide support service, warranty, or updates
for a work that has been modified or installed by the recipient, or for
the User Product in which it has been modified or installed.  Access to a
network may be denied when the modification itself materially and
adversely affects the operation of the network or violates the rules and
protocols for communication across the network.

  Corresponding Source conveyed, and Installation Information provided,
in accord with this section must be in a format that is publicly
documented (and with an implementation available to the public in
source code form), and must require no special password or key for
unpacking, reading or copying.

  7. Additional Terms.

  "Additional permissions" are terms that supplement the terms of this
License by making exceptions from one or more of its conditions.
Additional permissions that are applicable to the entire Program shall
be treated as though they were included in this License, to the extent
that they are valid under applicable law.  If additional permissions
apply only to part of the Program, that part may be used separately
under those permissions, but the entire Program remains governed by
this License without regard to the additional permissions.

  When you convey a copy of a covered work, you may at your option
remove any additional permissions from that copy, or from any part of
it.  (Additional permissions may be written to require their own
removal in certain cases when you modify the work.)  You may place
additional permissions on material, added by you to a covered work,
for which you have or can give appropriate copyright permission.

  Notwithstanding any other provision of this License, for material you
add to a covered work, you may (if authorized by the copyright holders of
that material) supplement the terms of this License with terms:

    a) Disclaiming warranty or limiting liability differently from the
    terms of sections 15 and 16 of this License; or

    b) Requiring preservation of specified reasonable legal notices or
    author attributions in that material or in the Appropriate Legal
    Notices displayed by works containing it; or

    c) Prohibiting misrepresentation of the origin of that material, or
    requiring that modified versions of such material be marked in
    reasonable ways as different from the original version; or

    d) Limiting the use for publicity purposes of names of licensors or
    authors of the material; or

    e) Declining to grant rights under trademark law for use of some
    trade names, trademarks, or service marks; or

    f) Requiring indemnification of licensors and authors of that
    material by anyone who conveys the material (or modified versions of
    it) with contractual assumptions of liability to the recipient, for
    any liability that these contractual assumptions directly impose on
    those licensors and authors.

  All other non-permissive additional terms are considered "further
restrictions" within the meaning of section 10.  If the Program as you
received it, or any part of it, contains a notice stating that it is
governed by this License along with a term that is a further
restriction, you may remove that term.  If a license document contains
a further restriction but permits relicensing or conveying under this
License, you may add to a covered work material governed by the terms
of that license document, provided that the further restriction does
not survive such relicensing or conveying.

  If you add terms to a covered work in accord with this section, you
must place, in the relevant source files, a statement of the
additional terms that apply to those files, or a notice indicating
where to find the applicable terms.

  Additional terms, permissive or non-permissive, may be stated in the
form of a separately written license, or stated as exceptions;
the above requirements apply either way.

  8. Termination.

  You may not propagate or modify a covered work except as expressly
provided under this License.  Any attempt otherwise to propagate or
modify it is void, and will automatically terminate your rights under
this License (including any patent licenses granted under the third
paragraph of section 11).

  However, if you cease all violation of this License, then your
license from a particular copyright holder is reinstated (a)
provisionally, unless and until the copyright holder explicitly and
finally terminates your license, and (b) permanently, if the copyright
holder fails to notify you of the violation by some reasonable means
prior to 60 days after the cessation.

  Moreover, your license from a particular copyright holder is
reinstated permanently if the copyright holder notifies you of the
violation by some reasonable means, this is the first time you have
received notice of violation of this License (for any work) from that
copyright holder, and you cure the violation prior to 30 days after
your receipt of the notice.

  Termination of your rights under this section does not terminate the
licenses of parties who have received copies or rights from you under
this License.  If your rights have been terminated and not permanently
reinstated, you do not qualify to receive new licenses for the same
material under section 10.

  9. Acceptance Not Required for Having Copies.

  You are not required to accept this License in order to receive or
run a copy of the Program.  Ancillary propagation of a covered work
occurring solely as a consequence of using peer-to-peer transmission
to receive a copy likewise does not require acceptance.  However,
nothing other than this License grants you permission to propagate or
modify any covered work.  These actions infringe copyright if you do
not accept this License.  Therefore, by modifying or propagating a
covered work, you indicate your acceptance of this License to do so.

  10. Automatic Licensing of Downstream Recipients.

  Each time you convey a covered work, the recipient automatically
receives a license from the original licensors, to run, modify and
propagate that work, subject to this License.  You are not responsible
for enforcing compliance by third parties with this License.

  An "entity transaction" is a transaction transferring control of an
organization, or substantially all assets of one, or subdividing an
organization, or merging organizations.  If propagation of a covered
work results from an entity transaction, each party to that
transaction who receives a copy of the work also receives whatever
licenses to the work the party's predecessor in interest had or could
give under the previous paragraph, plus a right to possession of the
Corresponding Source of the work from the predecessor in interest, if
the predecessor has it or can get it with reasonable efforts.

  You may not impose any further restrictions on the exercise of the
rights granted or affirmed under this License.  For example, you may
not impose a license fee, royalty, or other charge for exercise of
rights granted under this License, and you may not initiate litigation
(including a cross-claim or counterclaim in a lawsuit) alleging that
any patent claim is infringed by making, using, selling, offering for
sale, or importing the Program or any portion of it.

  11. Patents.

  A "contributor" is a copyright holder who authorizes use under this
License of the Program or a work on which the Program is based.  The
work thus licensed is called the contributor's "contributor version".

  A contributor's "essential patent claims" are all patent claims
owned or controlled by the contributor, whether already acquired or
hereafter acquired, that would be infringed by some manner, permitted
by this License, of making, using, or selling its contributor version,
but do not include claims that would be infringed only as a
consequence of further modification of the contributor version.  For
purposes of this definition, "control" includes the right to grant
patent sublicenses in a manner consistent with the requirements of
this License.

  Each contributor grants you a non-exclusive, worldwide, royalty-free
patent license under the contributor's essential patent claims, to
make, use, sell, offer for sale, import and otherwise run, modify and
propagate the contents of its contributor version.

  In the following three paragraphs, a "patent license" is any express
agreement or commitment, however denominated, not to enforce a patent
(such as an express permission to practice a patent or covenant not to
sue for patent infringement).  To "grant" such a patent license to a
party means to make such an agreement or commitment not to enforce a
patent against the party.

  If you convey a covered work, knowingly relying on a patent license,
and the Corresponding Source of the work is not available for anyone
to copy, free of charge and under the terms of this License, through a
publicly available network server or other readily accessible means,
then you must either (1) cause the Corresponding Source to be so
available, or (2) arrange to deprive yourself of the benefit of the
patent license for this particular work, or (3) arrange, in a manner
consistent with the requirements of this License, to extend the patent
license to downstream recipients.  "Knowingly relying" means you have
actual knowledge that, but for the patent license, your conveying the
covered work in a country, or your recipient's use of the covered work
in a country, would infringe one or more identifiable patents in that
country that you have reason to believe are valid.

  If, pursuant to or in connection with a single transaction or
arrangement, you convey, or propagate by procuring conveyance of, a
covered work, and grant a patent license to some of the parties
receiving the covered work authorizing them to use, propagate, modify
or convey a specific copy of the covered work, then the patent license
you grant is automatically extended to all recipients of the covered
work and works based on it.

  A patent license is "discriminatory" if it does not include within
the scope of its coverage, prohibits the exercise of, or is
conditioned on the non-exercise of one or more of the rights that are
specifically granted under this License.  You may not convey a covered
work if you are a party to an arrangement with a third party that is
in the business of distributing software, under which you make payment
to the third party based on the extent of your activity of conveying
the work, and under which the third party grants, to any of the
parties who would receive the covered work from you, a discriminatory
patent license (a) in connection with copies of the covered work
conveyed by you (or copies made from those copies), or (b) primarily
for and in connection with specific products or compilations that
contain the covered work, unless you entered into that arrangement,
or that patent license was granted, prior to 28 March 2007.

  Nothing in this License shall be construed as excluding or limiting
any implied license or other defenses to infringement that may
otherwise be available to you under applicable patent law.

  12. No Surrender of Others' Freedom.

  If conditions are imposed on you (whether by court order, agreement or
otherwise) that contradict the conditions of this License, they do not
excuse you from the conditions of this License.  If you cannot convey a
covered work so as to satisfy simultaneously your obligations under this
License and any other pertinent obligations, then as a consequence you may
not convey it at all.  For example, if you agree to terms that obligate you
to collect a royalty for further conveying from those to whom you convey
the Program, the only way you could satisfy both those terms and this
License would be to refrain entirely from conveying the Program.

  13. Use with the GNU Affero General Public License.

  Notwithstanding any other provision of this License, you have
permission to link or combine any covered work with a work licensed
under version 3 of the GNU Affero General Public License into a single
combined work, and to convey the resulting work.  The terms of this
License will continue to apply to the part which is the covered work,
but the special requirements of the GNU Affero General Public License,
section 13, concerning interaction through a network will apply to the
combination as such.

  14. Revised Versions of this License.

  The Free Software Foundation may publish revised and/or new versions of
the GNU General Public License from time to time.  Such new versions will
be similar in spirit to the present version, but may differ in detail to
address new problems or concerns.

  Each version is given a distinguishing version number.  If the
Program specifies that a certain numbered version of the GNU General
Public License "or any later version" applies to it, you have the
option of following the terms and conditions either of that numbered
version or of any later version published by the Free Software
Foundation.  If the Program does not specify a version number of the
GNU General Public License, you may choose any version ever published
by the Free Software Foundation.

  If the Program specifies that a proxy can decide which future
versions of the GNU General Public License can be used, that proxy's
public statement of acceptance of a version permanently authorizes you
to choose that version for the Program.

  Later license versions may give you additional or different
permissions.  However, no additional obligations are imposed on any
author or copyright holder as a result of your choosing to follow a
later version.

  15. Disclaimer of Warranty.

  THERE IS NO WARRANTY FOR THE PROGRAM, TO THE EXTENT PERMITTED BY
APPLICABLE LAW.  EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT
HOLDERS AND/OR OTHER PARTIES PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY
OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO,
THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
PURPOSE.  THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE PROGRAM
IS WITH YOU.  SHOULD THE PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF
ALL NECESSARY SERVICING, REPAIR OR CORRECTION.

  16. Limitation of Liability.

  IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MODIFIES AND/OR CONVEYS
THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES, INCLUDING ANY
GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE
USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED TO LOSS OF
DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD
PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER PROGRAMS),
EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF
SUCH DAMAGES.

  17. Interpretation of Sections 15 and 16.

  If the disclaimer of warranty and limitation of liability provided
above cannot be given local legal effect according to their terms,
reviewing courts shall apply local law that most closely approximates
an absolute waiver of all civil liability in connection with the
Program, unless a warranty or assumption of liability accompanies a
copy of the Program in return for a fee.

                     END OF TERMS AND CONDITIONS

            How to Apply These Terms to Your New Programs

  If you develop a new program, and you want it to be of the greatest
possible use to the public, the best way to achieve this is to make it
free software which everyone can redistribute and change under these terms.

  To do so, attach the following notices to the program.  It is safest
to attach them to the start of each source file to most effectively
state the exclusion of warranty; and each file should have at least
the "copyright" line and a pointer to where the full notice is found.

    <one line to give the program's name and a brief idea of what it does.>
    Copyright (C) <year>  <name of author>

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.

Also add information on how to contact you by electronic and paper mail.

  If the program does terminal interaction, make it output a short
notice like this when it starts in an interactive mode:

    <program>  Copyright (C) <year>  <name of author>
    This program comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
    This is free software, and you are welcome to redistribute it
    under certain conditions; type `show c' for details.

The hypothetical commands `show w' and `show c' should show the appropriate
parts of the General Public License.  Of course, your program's commands
might be different; for a GUI interface, you would use an "about box".

  You should also get your employer (if you work as a programmer) or school,
if any, to sign a "copyright disclaimer" for the program, if necessary.
For more information on this, and how to apply and follow the GNU GPL, see
<http://www.gnu.org/licenses/>.

  The GNU General Public License does not permit incorporating your program
into proprietary programs.  If your program is a subroutine library, you
may consider it more useful to permit linking proprietary applications with
the library.  If this is what you want to do, use the GNU Lesser General
Public License instead of this License.  But first, please read
<http://www.gnu.org/philosophy/why-not-lgpl.html>.

```

`MANIFEST.in`:

```in
include README.md
include LICENSE.COMMERCIAL
include LICENSE.GPL

include apkid/rules/rules.yarc

```

`README.md`:

```md
# APKiD

[![Build Status](https://app.travis-ci.com/rednaga/APKiD.svg?branch=master)](https://app.travis-ci.com/rednaga/APKiD)
[![PyPI](https://img.shields.io/pypi/v/apkid.svg)](https://pypi.org/project/apkid/)
[![PyPI - Python Version](https://img.shields.io/pypi/pyversions/apkid.svg)](https://pypi.org/project/apkid/)
[![PyPI - Format](https://img.shields.io/pypi/format/apkid.svg)](https://pypi.org/project/apkid/)
[![PyPI - License](https://img.shields.io/pypi/l/apkid.svg)](https://pypi.org/project/apkid/)

APKiD gives you information about how an APK was made. It identifies many compilers, packers, obfuscators, and other weird stuff. It's [_PEiD_](https://www.aldeid.com/wiki/PEiD) for Android.

![Screen Shot 2019-05-07 at 10 55 00 AM](https://user-images.githubusercontent.com/1356658/57322793-49be9c00-70b9-11e9-84da-1e64d9459a8a.png)

For more information on what this tool can be used for, check out:

* [Android Compiler Fingerprinting](http://hitcon.org/2016/CMT/slide/day1-r0-e-1.pdf)
* [Detecting Pirated and Malicious Android Apps with APKiD](http://rednaga.io/2016/07/31/detecting_pirated_and_malicious_android_apps_with_apkid/)
* [APKiD: PEiD for Android Apps (BlackHat EU/UK Arsenal 2018)](https://github.com/enovella/cve-bio-enovella/blob/master/slides/bheu18-enovella-APKID.pdf)
* [APKiD: Fast Identification of AppShielding Products](https://github.com/enovella/cve-bio-enovella/blob/master/slides/APKiD-NowSecure-Connect19-enovella.pdf)
* [APKiD: Fast Identification of Mobile RASP SDKs (BlackHat USA Arsenal 2023)](https://github.com/enovella/cve-bio-enovella/blob/master/slides/bheu23-enovella-APKID.pdf)

## Installing

```bash
pip install apkid
```

### Docker

You can also run APKiD with [Docker](https://www.docker.com/community-edition)! Of course, this requires that you have git and Docker installed.

Here's how to use Docker:

```bash
git clone https://github.com/rednaga/APKiD
cd APKiD/
docker build . -t rednaga:apkid
docker/apkid.sh ~/reverse/targets/android/example/example.apk
[+] APKiD 2.1.0 :: from RedNaga :: rednaga.io
[*] example.apk!classes.dex
 |-> compiler : dx
```

## Usage

```
usage: apkid [-h] [-v] [-t TIMEOUT] [-r] [--scan-depth SCAN_DEPTH]
             [--entry-max-scan-size ENTRY_MAX_SCAN_SIZE] [--typing {magic,filename,none}] [-j]
             [-o DIR]
             [FILE [FILE ...]]

APKiD - Android Application Identifier v2.1.2

positional arguments:
  FILE                                       apk, dex, or directory

optional arguments:
  -h, --help                                 show this help message and exit
  -v, --verbose                              log debug messages

scanning:
  -t TIMEOUT, --timeout TIMEOUT              Yara scan timeout (in seconds)
  -r, --recursive                            recurse into subdirectories
  --scan-depth SCAN_DEPTH                    how deep to go when scanning nested zips
  --entry-max-scan-size ENTRY_MAX_SCAN_SIZE  max zip entry size to scan in bytes, 0 = no limit
  --typing {magic,filename,none}             method to decide which files to scan

output:
  -j, --json                                 output scan results in JSON format
  -o DIR, --output-dir DIR                   write individual results here (implies --json)
```

## Submitting New Packers / Compilers / Obfuscators

If you come across an APK or DEX which APKiD does not recognize, please open a GitHub issue and tell us:

* what you think it is -- obfuscated, packed, etc.
* the file hash (either MD5, SHA1, SHA256)

We are open to any type of concept you might have for "something interesting" to detect, so do not limit yourself solely to packers, compilers or obfuscators. If there is an interesting anti-disassembler, anti-vm, anti-* trick, please make an issue.

Pull requests are welcome. If you're submitting a new rule, be sure to include a file hash of the APK / DEX so we can check the rule.

## License

This tool is available under a dual license: a commercial one suitable for closed source projects and a GPL license that can be used in open source software.

Depending on your needs, you must choose one of them and follow its policies. A detail of the policies and agreements for each license type are available in the [LICENSE.COMMERCIAL](LICENSE.COMMERCIAL) and [LICENSE.GPL](LICENSE.GPL) files.

## Hacking

If you want to install the latest version in order to make changes, develop your own rules, and so on, simply clone this repository, compile the rules, and install the package in editable mode:

```bash
git clone https://github.com/rednaga/APKiD
cd APKiD
python prep-release.py
pip install -e .[dev,test]
```

If the above doesn't work, due to permission errors dependent on your local machine and where Python has been installed, try specifying the `--user` flag. This is likely needed if you're not using a virtual environment:

```bash
pip install -e .[dev,test] --user
```

If you update any of the rules, be sure to run `prep-release.py` to recompile them.

If you are using Windows, install Yara 3.11.0 and yara-python-dex before compiling

```bash
pip install yara-python==3.11.0
pip install wheel
pip wheel --wheel-dir=yara-python-dex git+https://github.com/MobSF/yara-python-dex.git
pip install --no-index --find-links=yara-python-dex yara-python-dex
```

## For Package Maintainers

When releasing a new version, make sure the version has been updated in [apkid/__init__.py](apkid/__init__.py).

As for running tests, check out [.travis.yml](.travis.yml) to see how the dev and test environments are setup and tests are run.

Update the compiled rules, the readme, build the package and upload to PyPI:

```bash
./prep-release.py readme
rm -f dist/*
python setup.py sdist bdist_wheel
twine upload --repository-url https://upload.pypi.org/legacy/ dist/*
```

For more information see [Packaging Projects](https://packaging.python.org/tutorials/packaging-projects/).

```

`README.rst`:

```rst
APKiD
=====

|Build Status| |PyPI| |PyPI - Python Version| |PyPI - Format| |PyPI -
License|

APKiD gives you information about how an APK was made. It identifies
many compilers, packers, obfuscators, and other weird stuff. It’s
`PEiD <https://www.aldeid.com/wiki/PEiD>`__ for Android.

.. figure:: https://user-images.githubusercontent.com/1356658/57322793-49be9c00-70b9-11e9-84da-1e64d9459a8a.png
   :alt: Screen Shot 2019-05-07 at 10 55 00 AM

   Screen Shot 2019-05-07 at 10 55 00 AM

For more information on what this tool can be used for, check out:

-  `Android Compiler
   Fingerprinting <http://hitcon.org/2016/CMT/slide/day1-r0-e-1.pdf>`__
-  `Detecting Pirated and Malicious Android Apps with
   APKiD <http://rednaga.io/2016/07/31/detecting_pirated_and_malicious_android_apps_with_apkid/>`__
-  `APKiD: PEiD for Android
   Apps <https://github.com/enovella/cve-bio-enovella/blob/master/slides/bheu18-enovella-APKID.pdf>`__

Installing
----------

.. code:: bash

   pip install apkid

Docker
~~~~~~

You can also run APKiD with
`Docker <https://www.docker.com/community-edition>`__! Of course, this
requires that you have git and Docker installed.

Here’s how to use Docker:

.. code:: bash

   git clone https://github.com/rednaga/APKiD
   cd APKiD/
   docker build . -t rednaga:apkid
   docker/apkid.sh ~/reverse/targets/android/example/example.apk
   [+] APKiD 2.1.0 :: from RedNaga :: rednaga.io
   [*] example.apk!classes.dex
    |-> compiler : dx

Usage
-----

::

   usage: apkid [-h] [-v] [-t TIMEOUT] [-r] [--scan-depth SCAN_DEPTH]
                [--entry-max-scan-size ENTRY_MAX_SCAN_SIZE] [--typing {magic,filename,none}] [-j]
                [-o DIR]
                [FILE [FILE ...]]

   APKiD - Android Application Identifier v2.1.2

   positional arguments:
     FILE                                       apk, dex, or directory

   optional arguments:
     -h, --help                                 show this help message and exit
     -v, --verbose                              log debug messages

   scanning:
     -t TIMEOUT, --timeout TIMEOUT              Yara scan timeout (in seconds)
     -r, --recursive                            recurse into subdirectories
     --scan-depth SCAN_DEPTH                    how deep to go when scanning nested zips
     --entry-max-scan-size ENTRY_MAX_SCAN_SIZE  max zip entry size to scan in bytes, 0 = no limit
     --typing {magic,filename,none}             method to decide which files to scan

   output:
     -j, --json                                 output scan results in JSON format
     -o DIR, --output-dir DIR                   write individual results here (implies --json)

Submitting New Packers / Compilers / Obfuscators
------------------------------------------------

If you come across an APK or DEX which APKiD does not recognize, please
open a GitHub issue and tell us:

-  what you think it is – obfuscated, packed, etc.
-  the file hash (either MD5, SHA1, SHA256)

We are open to any type of concept you might have for “something
interesting” to detect, so do not limit yourself solely to packers,
compilers or obfuscators. If there is an interesting anti-disassembler,
anti-vm, anti-\* trick, please make an issue.

Pull requests are welcome. If you’re submitting a new rule, be sure to
include a file hash of the APK / DEX so we can check the rule.

License
-------

This tool is available under a dual license: a commercial one suitable
for closed source projects and a GPL license that can be used in open
source software.

Depending on your needs, you must choose one of them and follow its
policies. A detail of the policies and agreements for each license type
are available in the `LICENSE.COMMERCIAL <LICENSE.COMMERCIAL>`__ and
`LICENSE.GPL <LICENSE.GPL>`__ files.

Hacking
-------

If you want to install the latest version in order to make changes,
develop your own rules, and so on, simply clone this repository, compile
the rules, and install the package in editable mode:

.. code:: bash

   git clone https://github.com/rednaga/APKiD
   cd APKiD
   ./prep-release.py
   pip install -e .[dev,test]

If the above doesn’t work, due to permission errors dependent on your
local machine and where Python has been installed, try specifying the
``--user`` flag. This is likely needed if you’re not using a virtual
environment:

.. code:: bash

   pip install -e .[dev,test] --user

If you update any of the rules, be sure to run ``prep-release.py`` to
recompile them.

For Maintainers
---------------

This section is for package maintainers.

Make sure the version has been updated in
`apkid/init.py <apkid/__init__.py>`__

Update the compiled rules, the readme, build the package and upload to
PyPI:

.. code:: bash

   ./prep-release.py readme
   rm -f dist/*
   python setup.py sdist bdist_wheel
   twine upload --repository-url https://upload.pypi.org/legacy/ dist/*

For more information see `Packaging
Projects <https://packaging.python.org/tutorials/packaging-projects/>`__.

.. |Build Status| image:: https://travis-ci.org/rednaga/APKiD.svg?branch=master
   :target: https://travis-ci.org/rednaga/APKiD
.. |PyPI| image:: https://img.shields.io/pypi/v/apkid.svg
   :target: https://pypi.org/project/apkid/
.. |PyPI - Python Version| image:: https://img.shields.io/pypi/pyversions/apkid.svg
   :target: https://pypi.org/project/apkid/
.. |PyPI - Format| image:: https://img.shields.io/pypi/format/apkid.svg
   :target: https://pypi.org/project/apkid/
.. |PyPI - License| image:: https://img.shields.io/pypi/l/apkid.svg
   :target: https://pypi.org/project/apkid/

```

`apkid.iml`:

```iml
<?xml version="1.0" encoding="UTF-8"?>
<module type="PYTHON_MODULE" version="4">
  <component name="NewModuleRootManager" inherit-compiler-output="true">
    <exclude-output />
    <content url="file://$MODULE_DIR$" />
    <orderEntry type="jdk" jdkName="Python 3.7 (apkid)" jdkType="Python SDK" />
    <orderEntry type="sourceFolder" forTests="false" />
  </component>
</module>
```

`apkid/__init__.py`:

```py
#!/usr/bin/env python
"""
 Copyright (C) 2026  RedNaga. https://rednaga.io
 All rights reserved. Contact: rednaga@protonmail.com


 This file is part of APKiD


 Commercial License Usage
 ------------------------
 Licensees holding valid commercial APKiD licenses may use this file
 in accordance with the commercial license agreement provided with the
 Software or, alternatively, in accordance with the terms contained in
 a written agreement between you and RedNaga.


 GNU General Public License Usage
 --------------------------------
 Alternatively, this file may be used under the terms of the GNU General
 Public License version 3.0 as published by the Free Software Foundation
 and appearing in the file LICENSE.GPL included in the packaging of this
 file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 information to ensure the GNU General Public License version 3.0
 requirements will be met.
"""

__title__ = 'apkid'
__version__ = '3.1.0'
__author__ = 'Caleb Fenton & Tim Strazzere'
__license__ = 'GPL & Commercial'
__copyright__ = 'Copyright (C) 2026 RedNaga'

```

`apkid/apkid.py`:

```py
"""
 Copyright (C) 2024  RedNaga. https://rednaga.io
 All rights reserved. Contact: rednaga@protonmail.com


 This file is part of APKiD


 Commercial License Usage
 ------------------------
 Licensees holding valid commercial APKiD licenses may use this file
 in accordance with the commercial license agreement provided with the
 Software or, alternatively, in accordance with the terms contained in
 a written agreement between you and RedNaga.


 GNU General Public License Usage
 --------------------------------
 Alternatively, this file may be used under the terms of the GNU General
 Public License version 3.0 as published by the Free Software Foundation
 and appearing in the file LICENSE.GPL included in the packaging of this
 file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 information to ensure the GNU General Public License version 3.0
 requirements will be met.
"""

import io
import lzma
import os
import struct
import sys
import traceback
import zipfile
from typing import Union, IO, List, Dict, Set

import yara

from .output import OutputFormatter
from .rules import RulesManager

SCANNABLE_FILE_MAGICS: Dict[str, Set[bytes]] = {
    'zip': {b'PK\x03\x04', b'PK\x05\x06', b'PK\x07\x08'},
    'dex': {b'dex\n', b'dey\n'},
    'elf': {b'\x7fELF'},
    'res': {b'\x02\x00\x0c\x00'},
    'dll': {b'MZ\x90\x00'},
    # TODO: implement axml yara module
    # 'axml': set(),
}
XZ_COMPRESSION_TYPE = 95
ZIP_LFH_SIG_SIZE = 4
ZIP_LFH_FIELDS_SIZE = 26
ZIP_LFH_HEADER_SIZE = ZIP_LFH_SIG_SIZE + ZIP_LFH_FIELDS_SIZE


class Options(object):

    def __init__(self, timeout: int = 10, verbose: bool = False, json: bool = False, output_dir: Union[str, None] = None,
                 typing: Union[str, None] = 'magic', entry_max_scan_size: int = 0, scan_depth=2, recursive: bool = False,
                 include_types: bool = False):
        """Scan options.
        Holds user-supplied options governing how APKiD behaves.

        Parameters
        ----------
        timeout : integer, optional (default=10)
            The number of seconds before Yara match should time out.
        json : boolean, optional (default=False)
            If the output should be JSON format.
        output_dir : string or None, optional (default=None)
            Directory to write individual scan results to. If this is true, it implies `json_output=True`.
            Note: This is useful for feature extraction of a bunch of APKs.
        verbose : boolean, optional (default=False)
            When set to `True`, log warnings and other debug information.
        typing : string or None, optional (default="magic")
            Determines how the scanner decides if a file should be scanned.
            If "magic", then require the file match a built-in list of supported file magics
            If "filename", then scan files which have names known to be supported (e.g. ".dex")
            If None, pass every file to Yara for matching.
            Note: This option defines a trade-off between performance and accuracy. For example, if you're scanning a large APK file, it is expensive
            to uncompress every ZIP entry for Yara matching. It's much faster to only decompress files which have a known extension such as ".dex".
            But in many cases files may not have the correct extension, e.g. a DEX file may be named "notmalware.gif". On the other extreme, one could
            simply decompress every file and scan it, but this is wasteful because most files in an APK are typically not interesting, e.g. images.
            The default behavior of "magic" only needs to read a few bytes to decide if a file should be completely uncompressed.
        entry_max_scan_size : integer, optional (default=0)
            If > 0, only scan APK entries if their uncompressed size is less than this value.
        scan_depth : integer, optional (default=2)
            Determines how many times scanner should recurse into nested archives.
            If 0, don't recurse into nested archives.
            Note: It's possible to construct a malicious ZIP which can be infinitely nested. It's therefore necessary to limit the scan depth.
            Don't get cheeky and think you can set this value to 1000 and scan random malware without blowing up your memory.
        recursive : boolean, optional (default=True)
            If true, when scanning a directory, will recurse into subdirectories.
        """
        self.timeout = timeout
        self.verbose = verbose
        self.typing = typing
        self.entry_max_scan_size = entry_max_scan_size
        self.scan_depth = scan_depth
        self.recursive = recursive
        self.rules_manager = RulesManager()
        self.output = OutputFormatter(
            json_output=json,
            output_dir=output_dir,
            rules_manager=self.rules_manager,
            include_types=include_types
        )


class Scanner(object):

    def __init__(self, rules: yara.Rules, options: Options):
        self.rules = rules
        self.options = options

    def scan(self, path: str) -> None:
        if os.path.isfile(path):
            results = self.scan_file(path)
            if len(results) > 0:
                self.options.output.write(results)
        elif os.path.isdir(path):
            self.scan_directory(path)

    def scan_directory(self, dir_path: str) -> None:
        for file_path in self._yield_file_paths(dir_path):
            self.scan(file_path)

    def scan_file(self, file_path: str) -> Dict[str, List[yara.Match]]:
        results = []
        with open(file_path, 'rb') as f:
            try:
                results: Dict[str, List[yara.Match]] = self.scan_file_obj(f, file_path)
            except Exception as e:
                stack = traceback.format_exc()
                print(f"Exception scanning {file_path}: {stack}")
        return results

    def scan_file_obj(self, file: IO, file_path: str = '$FILE$'):
        if file_path == '$FILE$':
            file_name = file_path
        else:
            file_name = os.path.basename(file_path)

        results: Dict[str, List[yara.Match]] = {}
        if not self._should_scan(file, file_name):
            return results

        matches: List[yara.Matches] = self.rules.match(data=file.read(), timeout=self.options.timeout)
        if len(matches) > 0:
            results[file_path] = matches
        if self._is_zipfile(file, file_name):
            with zipfile.ZipFile(file) as zf:
                zip_results = self._scan_zip(zf)
            for entry_name, entry_matches in zip_results.items():
                results[f'{file_path}!{entry_name}'] = entry_matches
        return results

    def _scan_zip(self, zf: zipfile.ZipFile, depth=0) -> Dict[str, List[yara.Match]]:
        results: Dict[str, List[yara.Match]] = {}
        for info in zf.infolist():
            if info.is_dir():
                continue
            try:
                self._scan_zip_entry(zf, info, results, depth)
            except Exception as e:
                stack = traceback.format_exc()
                print(f"Exception scanning {info.filename} in {zf.filename}, depth={depth}: {stack}",
                    file=sys.stderr)
        return results

    def _scan_zip_entry(self, zf, info, results, depth) -> None:
        try:
            with zf.open(info) as entry:
                # Python 3.6 zip entries are not seek'able :(
                entry_buffer: IO = io.BytesIO(entry.read(4))
                entry_buffer.seek(0)
                if not self._should_scan(entry_buffer, info.filename):
                    return
                entry_buffer.seek(4)
                entry_buffer.write(entry.read())
        except zipfile.BadZipFile as e:
            if "Overlapped entries" in str(e) or "possible zip bomb" in str(e):
                if self.options.verbose:
                    print(f"[W] Skipping overlapped entry {info.filename} (possible zip bomb)")
                return
            else:
                raise
        except NotImplementedError:
            # XZ-compression
            if info.compress_type == XZ_COMPRESSION_TYPE:
                with open(zf.filename, 'rb') as raw_zip:
                    raw_zip.seek(info.header_offset + ZIP_LFH_FIELDS_SIZE)
                    filename_len = struct.unpack('<H', raw_zip.read(2))[0]
                    extra_len = struct.unpack('<H', raw_zip.read(2))[0]
                    data_offset = info.header_offset + ZIP_LFH_HEADER_SIZE + filename_len + extra_len
                    raw_zip.seek(data_offset)
                    compressed_data = raw_zip.read(info.compress_size)
                    try:
                        decompressed_data = lzma.decompress(compressed_data)
                        entry_buffer = io.BytesIO(decompressed_data)
                    except Exception as e:
                        print(f"[E] Failed to decompress {info.filename}: {e}")
                        return
            else:
                print(f"[E] Unsupported compression method {info.compress_type} for {info.filename}")
                return


        entry_buffer.seek(0)
        matches = self.rules.match(data=entry_buffer.read(), timeout=self.options.timeout)

        if len(matches) > 0:
            results[info.filename] = matches

        if depth < self.options.scan_depth and self._is_zipfile(entry_buffer, info.filename):
            with zipfile.ZipFile(entry_buffer) as zip_entry:
                nested_results = self._scan_zip(zip_entry, depth=depth + 1)
                for nested_name, nested_matches in nested_results.items():
                    results[f'{info.filename}!{nested_name}'] = nested_matches

    @staticmethod
    def _type_file(file: IO) -> Union[None, str]:
        magic = file.read(4)
        file.seek(0)
        for file_type, magics in SCANNABLE_FILE_MAGICS.items():
            if magic in magics:
                return file_type
        return None

    def _is_zipfile(self, file: IO, name: str) -> bool:
        if self.options.typing == 'filename':
            name = name.lower()
            return name.endswith('.apk') or name.endswith('.zip') or name.endswith('.jar')
        else:
            # Look at file magic since zipfile.is_zipfile isn't perfect
            # Some elfs may be considered zips and this causes apkid to barf errors
            file.seek(0)
            return Scanner._type_file(file) == 'zip' and zipfile.is_zipfile(file)

    def _should_scan(self, file: IO, name: str) -> bool:
        if self.options.typing == 'magic':
            file_type = Scanner._type_file(file)
            return file_type is not None
        elif self.options.typing == 'filename':
            name = name.lower()
            return name.startswith('classes') \
                   or name.startswith('AndroidManifest.xml') \
                   or name.startswith('lib/') \
                   or name.endswith('.so') \
                   or name.endswith('.dex') \
                   or name.endswith('.apk') \
                   or name.endswith('.arsc') \
                   or name.endswith('.dll')
        return True

    def _yield_file_paths(self, dir_path: str):
        if self.options.recursive:
            for root, _, filenames in os.walk(dir_path):
                for path in filenames:
                    yield os.path.join(root, path)
        else:
            for path in os.listdir(dir_path):
                full_path = os.path.join(dir_path, path)
                if os.path.isdir(full_path):
                    continue
                yield full_path

```

`apkid/main.py`:

```py
"""
 Copyright (C) 2023  RedNaga. https://rednaga.io
 All rights reserved. Contact: rednaga@protonmail.com


 This file is part of APKiD


 Commercial License Usage
 ------------------------
 Licensees holding valid commercial APKiD licenses may use this file
 in accordance with the commercial license agreement provided with the
 Software or, alternatively, in accordance with the terms contained in
 a written agreement between you and RedNaga.


 GNU General Public License Usage
 --------------------------------
 Alternatively, this file may be used under the terms of the GNU General
 Public License version 3.0 as published by the Free Software Foundation
 and appearing in the file LICENSE.GPL included in the packaging of this
 file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 information to ensure the GNU General Public License version 3.0
 requirements will be met.
"""

import argparse

from apkid.apkid import Scanner, Options
from . import __version__


def get_parser():
    formatter = lambda prog: argparse.ArgumentDefaultsHelpFormatter(prog, max_help_position=50, width=100)

    parser = argparse.ArgumentParser(
        description=f"APKiD - Android Application Identifier v{__version__}",
        formatter_class=formatter
    )
    parser.add_argument('input', metavar='FILE', type=str, nargs='*',
                        help="apk, dex, or directory")
    parser.add_argument('-v', '--verbose', action='store_true',
                        help="log debug messages")

    scanning = parser.add_argument_group('scanning')
    scanning.add_argument('-t', '--timeout', type=int, default=30,
                          help="Yara scan timeout (in seconds)")
    scanning.add_argument('-r', '--recursive', action='store_true', default=False,
                          help="recurse into subdirectories")
    scanning.add_argument('--scan-depth', type=int, default=2,
                          help="how deep to go when scanning nested zips")
    scanning.add_argument('--entry-max-scan-size', type=int, default=100 * 1024 * 1024,
                          help="max zip entry size to scan in bytes, 0 = no limit")
    scanning.add_argument('--typing', choices=('magic', 'filename', 'none'), default='magic',
                          help="method to decide which files to scan")

    output = parser.add_argument_group('output')
    output.add_argument('-j', '--json', action='store_true',
                        help="output scan results in JSON format", )
    output.add_argument('-o', '--output-dir', metavar='DIR', default=None,
                        help="write individual results here (implies --json)")
    output.add_argument('--include-types', action='store_true', default=False,
                        help="include file type info for matched files")

    return parser


def build_options(args) -> Options:
    return Options(
        timeout=args.timeout,
        verbose=args.verbose,
        json=args.json,
        output_dir=args.output_dir,
        typing=args.typing,
        entry_max_scan_size=args.entry_max_scan_size,
        scan_depth=args.scan_depth,
        recursive=args.recursive,
        include_types=args.include_types,
    )


def main():
    parser = get_parser()
    args = parser.parse_args()
    options = build_options(args)

    if not options.output.json:
        print(f"[+] APKiD {__version__} :: from RedNaga :: rednaga.io")

    rules = options.rules_manager.load()
    scanner = Scanner(rules, options)

    for input in args.input:
        scanner.scan(input)


if __name__ == '__main__':
    main()

```

`apkid/output.py`:

```py
"""
 Copyright (C) 2023  RedNaga. https://rednaga.io
 All rights reserved. Contact: rednaga@protonmail.com


 This file is part of APKiD


 Commercial License Usage
 ------------------------
 Licensees holding valid commercial APKiD licenses may use this file
 in accordance with the commercial license agreement provided with the
 Software or, alternatively, in accordance with the terms contained in
 a written agreement between you and RedNaga.


 GNU General Public License Usage
 --------------------------------
 Alternatively, this file may be used under the terms of the GNU General
 Public License version 3.0 as published by the Free Software Foundation
 and appearing in the file LICENSE.GPL included in the packaging of this
 file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 information to ensure the GNU General Public License version 3.0
 requirements will be met.
"""

import json
import os
import sys
from typing import Dict, List, Union

import yara

from .rules import RulesManager

prt_red = lambda s: f"\033[91m{s}\033[00m"
prt_green = lambda s: f"\033[92m{s}\033[00m"
prt_yellow = lambda s: f"\033[93m{s}\033[00m"
prt_light_purple = lambda s: f"\033[94m{s}\033[00m"
prt_purple = lambda s: f"\033[95m{s}\033[00m"
prt_cyan = lambda s: f"\033[36m{s}\033[00m"
prt_light_cyan = lambda s: f"\033[96m{s}\033[00m"
prt_light_gray = lambda s: f"\033[97m{s}\033[00m"
prt_orange = lambda s: f"\033[33m{s}\033[00m"
prt_pink = lambda s: f"\033[35m{s}\033[00m"

def is_windows_cmd():
    """
    Check if the current environment is a Windows command prompt.

    Returns:
        bool: True if the operating system is Windows and the SESSIONNAME
              environment variable is not set, indicating a command prompt.
    """
    return os.name == 'nt' and (
        os.getenv('SESSIONNAME') is None
    )

def colorize_tag(tag) -> str:
    if tag == 'compiler':
        return prt_cyan(tag)
    elif tag == 'manipulator':
        return prt_light_cyan(tag)
    elif tag == 'abnormal':
        return prt_light_gray(tag)
    elif tag in ['anti_vm', 'anti_disassembly', 'anti_debug', 'anti_root']:
        return prt_purple(tag)
    elif tag in ['packer', 'protector', 'anticheat']:
        return prt_red(tag)
    elif tag == 'obfuscator':
        return prt_yellow(tag)
    elif tag == 'dropper':
        return prt_green(tag)
    elif tag == 'embedded':
        return prt_light_purple(tag)
    elif tag == 'file_type':
        return prt_orange(tag)
    elif tag == 'internal':
        return prt_pink(tag)
    else:
        return tag


class OutputFormatter(object):
    def __init__(self, json_output: bool, output_dir: Union[str, None], rules_manager: RulesManager, include_types: bool):
        from apkid import __version__
        self.output_dir = output_dir
        self.json = json_output or output_dir
        self.version = __version__
        self.rules_hash = rules_manager.hash
        self.include_types = include_types

    def write(self, results: Dict[str, List[yara.Match]]) -> None:
        """
         Example yara.Match:
        {
          'tags': ['foo', 'bar'],
          'matches': True,
          'namespace': 'default',
          'rule': 'my_rule',
          'meta': {},
          'strings': [(81L, '$a', 'abc'), (141L, '$b', 'def')]
        }
        """

        if self.output_dir:
            # Result keys are file paths. Shortest key is base file in the case of archives.
            base_file = sorted(results.keys(), key=lambda k: len(k))[0]
            out_file = os.path.join(self.output_dir, *base_file.split(os.path.sep))
            out_path = os.path.dirname(out_file)
            if not os.path.exists(out_path):
                os.makedirs(out_path)
            output = self.build_json_output(results)
            with open(out_file, 'w') as f:
                f.write(json.dumps(output))
        else:
            if self.json:
                self._print_json(results)
            else:
                self._print_console(results)

    def build_json_output(self, results: Dict[str, List[yara.Match]]):
        output = {
            'apkid_version': self.version,
            'rules_sha256': self.rules_hash,
            'files': [],
        }
        for filename, matches in results.items():
            match_results = self._build_match_results(matches)
            if len(match_results) == 0:
                continue
            result = {
                'filename': filename,
                'matches': match_results,
            }
            output['files'].append(result)
        return output

    def _print_json(self, results: Dict[str, List[yara.Match]]) -> None:
        output = self.build_json_output(results)
        print(json.dumps(output, sort_keys=True))

    def _print_console(self, results: Dict[str, List[yara.Match]]) -> None:
        for key, raw_matches in results.items():
            match_results = self._build_match_results(raw_matches)
            if len(match_results) == 0:
                continue
            print(f"[*] {key}")
            for tags in sorted(match_results):
                descriptions = ', '.join(sorted(match_results[tags]))
                if sys.stdout.isatty() and not is_windows_cmd():
                    tags_str = OutputFormatter._colorize_tags(tags)
                else:
                    tags_str = tags
                print(f" |-> {tags_str} : {descriptions}")

    def _build_match_results(self, matches) -> Dict[str, List[str]]:
        results: Dict[str, List[str]] = {}
        for m in matches:
            if 'file_type' in m.tags and not self.include_types:
                continue
            tags = ', '.join(sorted(m.tags))
            description = m.meta.get('description', m)
            if tags in results:
                if description not in results[tags]:
                    results[tags].append(description)
            else:
                results[tags] = [description]
        return results

    @staticmethod
    def _colorize_tags(tags) -> str:
        colored_tags = []
        for tag in tags.split(', '):
            colored_tag = colorize_tag(tag)
            colored_tags.append(colored_tag)
        return ', '.join(colored_tags)

```

`apkid/rules.py`:

```py
"""
 Copyright (C) 2023  RedNaga. https://rednaga.io
 All rights reserved. Contact: rednaga@protonmail.com


 This file is part of APKiD


 Commercial License Usage
 ------------------------
 Licensees holding valid commercial APKiD licenses may use this file
 in accordance with the commercial license agreement provided with the
 Software or, alternatively, in accordance with the terms contained in
 a written agreement between you and RedNaga.


 GNU General Public License Usage
 --------------------------------
 Alternatively, this file may be used under the terms of the GNU General
 Public License version 3.0 as published by the Free Software Foundation
 and appearing in the file LICENSE.GPL included in the packaging of this
 file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 information to ensure the GNU General Public License version 3.0
 requirements will be met.
"""

import hashlib
import os
from typing import Dict
from typing import Optional

import yara


class RulesManager(object):
    def __init__(self, rules_dir=None, rules_ext='.yara'):
        if not rules_dir:
            rules_dir = os.path.join(os.path.dirname(os.path.realpath(__file__)), 'rules')
        self.rules_dir: str = rules_dir
        self.rules_path: str = os.path.join(self.rules_dir, 'rules.yarc')
        self.rules_ext: str = rules_ext
        self.rules: Optional[yara.Rules] = None
        self.rules_hash: Optional[str] = None

    def load(self) -> yara.Rules:
        self.rules = yara.load(self.rules_path)
        return self.rules

    def _collect_yara_files(self) -> Dict[str, str]:
        files = {}
        for root, dirnames, filenames in os.walk(self.rules_dir):
            for filename in filenames:
                if not filename.lower().endswith(self.rules_ext):
                    continue
                path = os.path.join(root, filename)
                files[path] = path
        return files

    def compile(self) -> yara.Rules:
        yara_files = self._collect_yara_files()
        self.rules = yara.compile(filepaths=yara_files)
        return self.rules

    def save(self) -> int:
        self.rules.save(self.rules_path)
        rules_count = len(set([r.identifier for r in self.rules]))
        return rules_count

    @property
    def hash(self) -> str:
        if not self.rules_hash:
            h = hashlib.sha256()
            for file_path in self._collect_yara_files():
                with open(file_path, 'rb') as f:
                    h.update(f.read())
            self.rules_hash = h.hexdigest()
        return self.rules_hash

```

`apkid/rules/apk/common.yara`:

```yara
/*
 * Copyright (C) 2023  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

rule is_apk : file_type
{
  meta:
    description = "APK"

  strings:
    $zip_head = "PK"
    $manifest = "AndroidManifest.xml"

  condition:
    $zip_head at 0 and $manifest and #manifest >= 2
}

private rule is_signed_apk : internal
{
  meta:
    description = "Resembles a signed APK that is likely not corrupt"

  strings:
    $meta_inf = "META-INF/"
    $ext_rsa = ".RSA"
    $ext_dsa = ".DSA"
    $ext_ec = ".EC"
    $apk_sig_block_footer = { 41 50 4B 20 53 69 67 20 42 6C 6F 63 6B 20 34 32 50 4B 01 02 }

  condition:
    is_apk and
    (
      for all of ($meta_inf*) : ($ext_rsa or $ext_dsa or $ext_ec in (@ + 9..@ + 9 + 100)) or
      $apk_sig_block_footer
    )
}

private rule is_unsigned_apk : internal
{
  meta:
    description = "Resembles an unsigned APK that is likely not corrupt"

  condition:
    is_apk and not is_signed_apk
}

```

`apkid/rules/apk/obfuscators.yara`:

```yara
/*
 * Copyright (C) 2023  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

include "common.yara"

rule arxan_guardit : obfuscator
{
  meta:
    description = "Arxan GuardIT"
    url         = "https://www.arxan.com"
    sample      = "0da79f5202b4c29c4ef43f769d5703a3d4ebfa65e49ea967abb49965d4ac3ba4"
    author      = "Eduardo Novella"

  strings:
    // guardit4j.fin -- in root of apk; contains GuardIT version
    $cfg = { 00 67 75 61 72 64 69 74 34 6A 2E 66 69 6E }

  condition:
    is_apk and #cfg > 1
}

rule gemalto_protector : obfuscator
{
  meta:
    description = "Gemalto"
    url         = "https://www.gemalto.com"
    author      = "Eduardo Novella"
    sample      = "294f95298189080a25b20ef28295d60ecde27ee12361f93ad2f024fdcb5bdb0b"

  strings:
    $l1 = "lib/arm64-v8a/libmedl.so"
    $l2 = "lib/armeabi-v7a/libmedl.so"
    $l3 = "lib/armeabi/libmedl.so"
    $l4 = "lib/mips/libmedl.so"
    $l5 = "lib/mips64/libmedl.so"
    $l6 = "lib/x86/libmedl.so"
    $l7 = "lib/x86_64/libmedl.so"

  condition:
    any of them and is_apk
}

rule androidrepublic : obfuscator
{
  meta:
    description = "AndroidRepublic"
    url         = "https://androidrepublic.org/"
    sample      = "b893b45852ccfe4e037a356348042e613c47ae56e554943d8b3998c0cbb3ffb9"
    author      = "Eduardo Novella"

  strings:
    $asset1 = "assets/emt.androidrepublic/config.png"
    $asset2 = "assets/emt.androidrepublic/monkey.png"
    $asset3 = "assets/emt.androidrepublic/system.png"
    $asset4 = "assets/emt.androidrepublic/system_000.png"
    $asset5 = "assets/emt.androidrepublic/system_001.png"
    $asset6 = "assets/emt.androidrepublic/system_002.png"
    $asset7 = "assets/emt.androidrepublic/system_003.png"
    $asset8 = "assets/emt.androidrepublic/system_004.png"
    $asset9 = "assets/emt.androidrepublic/system_005.png"

  condition:
    is_apk and any of them
}

rule androidrepublic_vip : obfuscator
{
  meta:
    description = "AndroidRepublic VIP"
    url         = "https://androidrepublic.org/"
    sample      = "ea1c69b7ba4f43ddcfb615e3fc5ff87d599232e6df089845a0e663d4bea761e0"
    author      = "Eduardo Novella"

  strings:
    $asset1 = /assets\/androidrepublic\.org\/(.*)\.png/

  condition:
    is_apk and all of them
}

rule obfuscapk_libencryption : obfuscator
{
  meta:
    description = "Obfuscapk - LibEncryption plugin"
    url         = "https://github.com/ClaudiuGeorgiu/Obfuscapk"
    author      = "Simone Aonzo - https://twitter.com/packm4d"
    sample      = "4957d9c1b423ae045f27d97b1d0b1f32ba6a2ce56525a2e93bda7172ec18ad0c"

  strings:
    $lib_arm = /assets\/lib\.arm(eabi|64)-v[0-9a-zA-Z]{2}\.[!-~]+\.so/
    $lib_x86 = /assets\/lib\.x86(_64)?\.[!-~]+\.so/
  condition:
    any of them and is_apk
}

```

`apkid/rules/apk/packers.yara`:

```yara
/*
 * Copyright (C) 2023  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

include "common.yara"

rule appguard : packer
{
  meta:
    description = "AppGuard"
    url         = "http://appguard.nprotect.com/en/index.html"

  strings:
    $stub          = "assets/appguard/"
    $encrypted_dex = "assets/classes.sox"

  condition:
    is_apk and all of them
}

rule appguard_a : packer
{
  meta:
    description = "AppGuard"
    sample      = "c5195daa5d17ba6e1755f8cb7270ae3a971eb688ee7d650d10c284d7c93b777d"
    url         = "http://appguard.nprotect.com/en/index.html"
    author      = "Eduardo Novella"

  strings:
    $a = "assets/AppGuard0.jar"
    $b = "assets/AppGuard.dgc"
    $c = /lib\/(arm.*|x86.*)\/libAppGuard\.so/
    $d = "libAppGuard-x86.so"

  condition:
    is_apk and any of them
}

rule appguard_b : packer
{
  meta:
    description = "AppGuard"
    sample      = "23cd2af10d46459065ea65b2d40fb706fd4847a1f8ef195cbebf1c6d8d54a48a"
    url         = "http://appguard.nprotect.com/en/index.html"
    author      = "Eduardo Novella"

  strings:
    $stub = "assets/appguard/"

  condition:
    is_apk and any of them and not appguard
}

rule appguard_c : packer
{
  meta:
    description = "AppGuard (TOAST-NHNent)"
    url         = "https://docs.toast.com/en/Security/AppGuard/en/Overview/"
    url2        = "https://www.toast.com/service/security/appguard"
    sample      = "80ac3e9d3b36613fa82085cf0f5d03b58ce20b72ba29e07f7c744df476aa9a92"
    samples     = "https://koodous.com/rulesets/5249/apks"
    author      = "Eduardo Novella"

  strings:
    // package com.nhnent.appguard;
    $a1 = /assets\/classes[1-9]{0,1}\.(jet|zip)/
    $b1 = /lib\/(arm.*|x86.*)\/libloader\.so/
    $b2 = /lib\/(arm.*|x86.*)\/libdiresu\.so/
    $c1 = "assets/m7a"
    $c2 = "assets/m8a"
    $c3 = "assets/agconfig"    //appguard cfg?
    $c4 = "assets/agmetainfo"

  condition:
    is_apk and 1 of ($b*) and (1 of ($a*) or 1 of ($c*))
}


rule appguard_d : packer
{
  meta:
    description = "AppGuard"
    sample      = "94454b39eb50b677afec136b1eaea90895f07a735ae2801618baca16e6a2a19f"
    url         = "http://appguard.nprotect.com/en/index.html"
    author      = "Moolakarapaiyan"

  strings:
    $dircheck = "assets/appguard/"
    $libcheck = /lib\/(arm.*|x86.*)\/libcompatible(_x86)?\.so/

  condition:
    is_apk and all of them
}



rule dxshield : packer
{
  meta:
    description = "DxShield"
    url = "http://www.nshc.net/wp/portfolio-item/dxshield_eng/"

  strings:
    $decryptlib = "libdxbase.so"
    $res = "assets/DXINFO.XML"

  condition:
    is_apk and ($decryptlib or $res)
}

private rule secneo_base
{
  strings:
    $encryptlib1 = "libDexHelper.so"
    $encryptlib2 = "libDexHelper-x86.so"
    $encrypted_dex = "assets/classes0.jar"

  condition:
    is_apk and any of ($encrypted_dex, $encryptlib2, $encryptlib1)
}

rule secneo_c : packer
{
  meta:
    description = "SecNeo.C"
    url         = "http://www.secneo.com"
    sample      = "9267b90fdbf2280f38e1bb4b23262514f71b3dd1c1dad750d8f7f56a831247bc"
    author      = "jcase"

  strings:
    $lib = "libdatajar.so"

  condition:
    secneo_base and $lib
}

rule secneo_b : packer
{
  meta:
    description = "SecNeo.B"
    url         = "http://www.secneo.com"
    sample      = "f5d7985e2add50fce74c99511512084845558ac996ce66f45e633c9495d78400"

  strings:
    $lib1 = "libdexjni.so"
    $lib2 = "libdexjni%s.so"

  condition:
    secneo_base and any of ($lib1, $lib2)
}

rule secneo_a : packer
{
  meta:
    description = "SecNeo.A"
    url         = "http://www.secneo.com"

  condition:
    secneo_base
    and not secneo_b
    and not secneo_c
}

rule dexprotector : packer
{
  // DexProtector v6.x.x :- Demo, Standard, Business Edition

  meta:
    author      = "Jasi2169 and Eduardo Novella"
    description = "DexProtector"
    url         = "https://dexprotector.com/"

  strings:
    $encrptlib_1 = "assets/dp.arm.so.dat"
    $encrptlib_2 = "assets/dp.arm-v7.so.dat"
    $encrptlib_3 = "assets/dp.arm-v8.so.dat"
    $encrptlib_4 = "assets/dp.x86.so.dat"
    $encrptlib_5 = "assets/dp.x86_64.so.dat"

    $asset1 = "assets/classes.dex.dat"
    $asset2 = "assets/classes1.dex.dat"
    $asset3 = "assets/classes2.dex.dat"
    $asset4 = "assets/classes3.dex.dat"
    $asset5 = "assets/resources.dat"
    $asset6 = "assets/dp.mp3"

  condition:
    is_apk and 1 of ($encrptlib_*) and 1 of ($asset*)
}

rule dexprotector_a : packer
{
  // Possible older version

  meta:
    author      = "Eduardo Novella"
    description = "DexProtector"
    url         = "https://dexprotector.com/"
    sample      = "242e0ee59de46c7648b7b38efeb8c088ae3dc8c5c8fe9fbd5e707b098ab8f404"

  strings:
    $encrptlib_1 = "assets/dp.arm-v7.art.kk.so"
    $encrptlib_2 = "assets/dp.arm-v7.art.l.so"
    $encrptlib_3 = "assets/dp.arm-v7.dvm.so"
    $encrptlib_4 = "assets/dp.arm.art.kk.so"
    $encrptlib_5 = "assets/dp.arm.art.l.so"
    $encrptlib_6 = "assets/dp.arm.dvm.so"
    $encrptlib_7 = "assets/dp.x86.art.kk.so"
    $encrptlib_8 = "assets/dp.x86.art.l.so"
    $encrptlib_9 = "assets/dp.x86.dvm.so"

    $encrptcustom = "assets/dp.mp3"

  condition:
    is_apk and 2 of them
}

rule dexprotector_b : packer
{
  // Possible newer version
  meta:
    author      = "Eduardo Novella"
    description = "DexProtector"
    url         = "https://dexprotector.com/"
    sample      = "dca2a0bc0f2605072b9b48579e73711af816b0fa1108b825335d2d1f2418e2a7"
    sample2     = "353f5fa432208f67cdc106c08b19f2c8644a5f768a7051f7c9043d9931a2a116"

  strings:
    //              assets/com.package.name.arm.so.dat
    $encrptlib_1 = /assets\/[A-Za-z0-9.]{2,50}\.arm\-v7\.so\.dat/
    $encrptlib_2 = /assets\/[A-Za-z0-9.]{2,50}\.arm\-v8\.so\.dat/
    $encrptlib_3 = /assets\/[A-Za-z0-9.]{2,50}\.arm\.so\.dat/
    $encrptlib_4 = /assets\/[A-Za-z0-9.]{2,50}\.dex\.dat/
    $encrptlib_5 = /assets\/[A-Za-z0-9.]{2,50}\.x86\.so\.dat/
    $encrptlib_6 = /assets\/[A-Za-z0-9.]{2,50}\.x86\_64\.so\.dat/

    $encrptcustom_mp3 = /assets\/[A-Za-z0-9.]{2,50}\.mp3/
    $encrptcustom_dat = /assets\/[A-Za-z0-9.]{2,50}\.dat/

  condition:
    is_apk and 1 of ($encrptlib_*) and 1 of ($encrptcustom_*) and
    not dexprotector_a and
    not dexprotector
}

rule dexprotector_c : packer
{
  meta:
    author      = "Eduardo Novella"
    description = "DexProtector"
    url         = "https://dexprotector.com/"
    sample      = "2a0d410d540d75f0f1d9a217087e5df6e7032399d3c116a324541488a03f12d3"

  strings:
    //               assets/dp.arch.so.random.mp3
    $encrptlib    = /assets\/dp\.(arm-v7|arm-v8|x86|x86_64)\.so\.[A-Za-z0-9]{2,8}\.mp3/
    $encrptcustom = /assets\/[A-Za-z0-9]{2,8}\.mp3/

  condition:
    is_apk and all of them and
    not dexprotector_a and
    not dexprotector_b and
    not dexprotector
}

rule dexprotector_d : packer
{
  meta:
    author      = "Eduardo Novella"
    description = "DexProtector"
    url         = "https://dexprotector.com/"
    sample      = "18e638efebb43bcd57e96214fab6f94ff609fc51babf1599f8ef0efd846fbf74"

  strings:
    //            assets/random.(mp3|dat)
    $encrptlib = /assets\/[A-Za-z0-9]{3,64}\.mp3/
    $encrptdat = /assets\/[A-Za-z0-9]{3,64}\.dat/
    $libdexpro = /lib\/(arm.*|x86.*)\/libdexprotector\.[A-Za-z0-9.]{2,16}\.so/
    $libalice  = /lib\/(arm.*|x86.*)\/libalice.so/

  condition:
    is_apk and 1 of ($encrpt*) and 1 of ($lib*) and
    not dexprotector_a and
    not dexprotector_b and
    not dexprotector_c and
    not dexprotector
}

rule dexpro_aide_a : packer
{
  meta:
    description = "DexProtector for AIDE"
    url         = "https://play.google.com/store/apps/details?id=mph.trunksku.apps.dexpro"
    sample      = "ccac4f15989a7ee430476d60b3a90ccf6c4ac7f6219f4e06676a69f75c7ce887"
    author      = "Eduardo Novella"

  strings:
    $asset_1 = "assets/classes.dex.dat"
    $asset_2 = "assets/dp-lib/dp.kotlin-v1.lua.mph"

  condition:
    is_apk and all of them
}

rule dexpro_aide_b : packer
{
  meta:
    description = "DexProtector for AIDE"
    url         = "https://github.com/rednaga/APKiD/issues/197"
    sample      = "e113be26d90fe2cb287009345139fba0c550a67b15c3022eb5dc13aa0eb8235a"
    author      = "Eduardo Novella"

  strings:
    // pkgname  = mph.dexprotect.a
    $asset_1    = "assets/dexprotect/classes.dex.dat"
    $asset_2    = "assets/eprotect.dat"
    $properties = "dexpro-build.properties"

  condition:
    is_apk and all of them
}

rule apkprotect : packer
{
  meta:
    description = "APKProtect"

  strings:
    $key = "apkprotect.com/key.dat"
    $dir = "apkprotect.com/"
    $lib = "libAPKProtect.so"

  condition:
    is_apk and ($key or $dir or $lib)
}

rule apkprotect_a : packer
{
  meta:
    description = "APKProtect 6.x"
    url         = "https://play.google.com/store/apps/details?id=com.mcal.dexprotect"
    sample      = "1c3e09c6e336fef0261a19e546f3686fcf9a00ee23f7426608fef40465d91289"
    author      = "Eduardo Novella"

  strings:
    $a1 = /lib\/(x86\_64|armeabi\-v7a|arm64\-v8a|x86)\/libapkprotect\.so/
    $a2 = "assets/apkprotect.bin"
    $a3 = "assets/apkprotect/classes.dex.bin"
    $a4 = "apkprotect-build.properties"
    $a5 = "META-INF/APKPROTECT.RSA"
    $a6 = "META-INF/APKPROTECT.SF"

  condition:
    is_apk and 4 of ($a*)
}

rule apkprotect_b : packer
{
  meta:
    description = "APKProtect 9.x"
    url         = "https://play.google.com/store/apps/details?id=com.mcal.dexprotect"
    sample      = "65e02abc0a9e9646cea11a1b0d17e4fd080c98d08c755be7a1dec9d7c21de4de"
    author      = "Eduardo Novella"

  strings:
    /**
      unzip -l 65e02abc0a9e9646cea11a1b0d17e4fd080c98d08c755be7a1dec9d7c21de4de.apk
        Length      Date    Time    Name
      ---------  ---------- -----   ----
          1269  2020-05-14 14:56   META-INF/MANIFEST.MF
          1347  2020-05-14 14:56   META-INF/APKPROTECT.SF
          1299  2020-05-14 14:56   META-INF/APKPROTECT.RSA
          6980  2020-05-14 14:56   AndroidManifest.xml
            36  2020-05-14 14:56   assets/ap.others/apkprotect.bin
        425126  2020-05-14 14:56   assets/ap.res/a/a.png
          1464  2020-05-14 14:56   assets/ap.res/b/b.xml
          1504  2020-05-14 14:56   assets/ap.res/c/b.xml
          2981  2020-05-14 14:56   assets/ap.res/d/c.png
          5755  2020-05-14 14:56   assets/ap.res/e/c.png
          9277  2020-05-14 14:56   assets/ap.res/f/c.png
         17743  2020-05-14 14:56   assets/ap.res/g/c.png
        522140  2020-05-14 14:56   assets/ap.src/apkprotect-v1.bin
        161320  2020-05-14 14:56   classes.dex
        202880  2020-05-14 14:56   lib/arm64-v8a/libapkprotect.so
        104088  2020-05-14 14:56   lib/armeabi-v7a/libapkprotect.so
        198336  2020-05-14 14:56   lib/x86/libapkprotect.so
        223632  2020-05-14 14:56   lib/x86_64/libapkprotect.so
          2040  2020-05-14 14:56   resources.arsc
    */
    $a1 = /lib\/(x86\_64|armeabi\-v7a|arm64\-v8a|x86)\/libapkprotect\.so/
    $a2 = /assets\/(.*)\/apkprotect(.*)\.bin/
    $a3 = "META-INF/APKPROTECT.RSA"
    $a4 = "META-INF/APKPROTECT.SF"

  condition:
    is_apk and 3 of ($a*) and not apkprotect_a
}

rule bangcle : packer
{
  meta:
    description = "Bangcle"

  strings:
    $main_lib = "libsecexe.so"
    $second_lib = "libsecmain.so"
    $container = "assets/bangcleplugin/container.dex"
    $encrypted_jar = "bangcleclasses.jar"
    $encrypted_jar2 = "bangcle_classes.jar"

  condition:
    is_apk and any of ($main_lib, $second_lib, $container, $encrypted_jar, $encrypted_jar2)
}

rule bangcle_secshell : packer
{
  meta:
    description = "Bangcle (SecShell)"
    sample      = "d710a24971a0cd56c5cbe62b4b926e0122704fba52821e9c888e651a2d26a05c"
    url         = "https://blog.fortinet.com/2017/01/26/deep-analysis-of-android-rootnik-malware-using-advanced-anti-debug-and-anti-hook-part-i-debugging-in-the-scope-of-native-layer"
    author      = "Eduardo Novella"

  strings:
    $a = "assets/secData0.jar"
    $b = "libSecShell.so"
    $c = "libSecShell-x86.so"

  condition:
    is_apk and 2 of them
}

rule kiro : packer
{
  meta:
    description = "Kiro"

  strings:
    $kiro_lib = "libkiroro.so"
    $sbox = "assets/sbox"

  condition:
    is_apk and $kiro_lib and $sbox
}

rule qihoo360 : packer
{
  meta:
    description = "Qihoo 360"

  strings:
    $a = "libprotectClass.so"

  condition:
    is_apk and
    $a and
    not kiro
}

rule jiagu : packer
{
  meta:
    //developed by Qihoo 360
    description = "Jiagu"
    url = "http://jiagu.360.cn/"

  strings:
    // These contain a trick function "youAreFooled"
    $main_lib = "libjiagu.so"
    $art_lib = "libjiagu_art.so"

  condition:
    is_apk and ($main_lib or $art_lib)
}

rule jiagu_a : packer
{
  meta:
    description = "Jiagu (ApkToolPlus)"
    sample      = "684baab16344dc663b7ae84dd1f8d6a39bfb480a977ad581a0a6032f6e437218"
    url         = "https://github.com/linchaolong/ApkToolPlus/tree/master/lib.JiaGu/src/com/linchaolong/apktoolplus/jiagu"
    author      = "Eduardo Novella"

  strings:
    $a = "assets/jiagu_data.bin"
    $b = "assets/sign.bin"
    $c = "libapktoolplus_jiagu.so"

  condition:
    is_apk and all of them
}

rule qdbh_packer : packer
{
  meta:
    description = "qdbh packer"
    sample      = "faf1e85f878ea52a3b3fbb67126132b527f509586706f242f39b8c1fdb4a2065"

  strings:
    $qdbh = "assets/qdbh"

  condition:
    is_apk and $qdbh
}

rule unicom_loader : packer
{
  meta:
    description = "Unicom SDK Loader"

  strings:
    $decrypt_lib = "libdecrypt.jar"
    $unicom_lib = "libunicomsdk.jar"
    $classes_jar = "classes.jar"

  condition:
    is_apk and ($unicom_lib and ($decrypt_lib or $classes_jar))
}

rule liapp : packer
{
  meta:
    description = "LIAPP"
    sample      = "b5be20d225edf55634621aa17988a6ed3368d4f7632c8a1eb4d3fc3b6a61c325"
    sample2     = "0697d32c80af84fdde536c5eae2a8bf7ddb0504426a6db7ccde6d8d684a6f588"
    author      = "Caleb & Diff & Eduardo Novella"

  strings:
    $dir = "/LIAPPEgg"
    $lib = "LIAPPClient.sc"
    $ini = "assets/LIAPP.ini"

  condition:
    is_apk and any of ($dir, $lib, $ini)
}

rule app_fortify : packer
{
  meta:
    description = "App Fortify"

  strings:
    $lib = "libNSaferOnly.so"

  condition:
    is_apk and $lib
}

rule nqshield : packer
{
  meta:
    description = "NQ Shield"

  strings:
    $lib = "libnqshield.so"
    $lib_sec1 = "nqshield"
    $lib_sec2 = "nqshell"

  condition:
    is_apk and any of ($lib, $lib_sec1, $lib_sec2)
}

rule tencent : packer
{
  meta:
    description = "Mobile Tencent Protect"
    url         = "https://intl.cloud.tencent.com/product/mtp"
    sample      = "7c6024abc61b184ddcc9fa49f9fac1a7e5568d1eab09ee748f8c4987844a3f81"

  strings:
    $decryptor_lib = /lib\/(arm.*|x86.*)\/libshell\.so/
    $zip_lib       = /lib\/(arm.*|x86.*)\/libmobisecy\.so/
    $mix_dex       = "/mix.dex"

  condition:
    is_apk and any of them
}

rule tencent_a : packer
{
  meta:
    description = "Mobile Tencent Protect"
    url         = "https://intl.cloud.tencent.com/product/mtp"
    sample      = "b1a5d9d4c1916a0acc2d5c3b7c811a39ebeb2f6d42b305036473f7053bbf5fe7"
    author      = "Eduardo Novella"

  strings:
    $lib =  /lib\/(arm.*|x86.*)\/libshell(a|x)-\d\.\d\.\d\.\d\.so/

  condition:
    is_apk and all of them
}

rule tencent_b : packer
{
  meta:
    description = "Tencent Security Enterprise Edition"
    url         = "https://cloud.tencent.com/product/ms"
    url2        = "http://www.fron.com.cn/yaq/"
    sample      = "49dddbde640fa5e46bf5e427564f6a75599a87e391699e20b0380869b7c4ad83" // com.qidian.QDReader v7.9.352
    author      = "Eduardo Novella"

  strings:
    // lib/arm/libshell-supervbasic.2019.so and lib/arm/libshell-superv.2019.so
    $lib = /lib\/(arm.*|x86.*)\/libshell\-superv(.*)\.\d{4}\.so/
    // assets/dexMethod_00oo1l1l.dat
    $asset = /assets\/dexMethod.*\.dat/

  condition:
    is_apk and all of them
}

rule tencent_legu : packer
{
  meta:
    description = "Tencent's Legu"
    url         = "https://blog.quarkslab.com/a-glimpse-into-tencents-legu-packer.html"
    sample      = "9ff3a53f76c7a6d7e3de3b8567c9606f2cc08ec4aaaae596a27361018d839c58"
    author      = "Mert Arıkan"

  strings:
    $a = "assets/tosversion"
    $b = "assets/0OO00l111l1l"
    $c = "assets/0OO00oo01l1l"
    $d = "assets/o0oooOO0ooOo.dat"

  condition:
    is_apk
    and $b
    and ($a or $c or $d)
    and not tencent
    and not tencent_a
    and not tencent_b
}

rule tencent_legu_VMP : packer
{
  meta:
    description = "Tencent's Legu (VMP)"
    url         = "https://github.com/rednaga/APKiD/issues/390"
    sample      = "95ca638cfb80ebbb21e97c202f9c06f7306c6fc9696b4760a401afa9293000f7" // com.youwan.aoao v2.9.2
    author      = "Eduardo Novella"

  strings:
    $a = /assets\/libwsDataEncryption\_AZAPP.*\.so/
    $b = /assets\/wslib\/(arm.*|x86.*)\/libWSSec(V?)\.so/
    $c = "assets/wsDal.jar"
    $d = /assets\/WSSEC(A|B|C|D)\.jar/

  condition:
    is_apk and all of them
}

rule ijiami : packer
{
  meta:
    description = "Ijiami"

  strings:
    $old_dat = "assets/ijiami.dat"
    $new_ajm = /ijiami(3)?\.ajm/
    $ijm_lib = "assets/ijm_lib/"
    $new_dat = "assets/IJMDal.Data"
    $new_lib = "assets/libijmDataEncryption.so"

  condition:
    is_apk and any of them
}

rule naga : packer
{
  meta:
    description = "Naga"

  strings:
    // libedog | libfdog | libvdog etc. - lib name changes a/c to edition
    $lib   = /lib(e|d|f|v)dog\.so/
    $lib2  = "libchaosvmp.so"
    $lib3  = "libxloader.so"
    $asset = "assets/maindata/fake_classes.dex"

  condition:
    is_apk and any of them
}

rule alibaba : packer
{
  meta:
    description = "Alibaba"

  strings:
    $lib = "libmobisec.so"

  condition:
    is_apk and $lib
}

rule medusah : packer
{
  meta:
    description = "Medusah"
    url = "https://medusah.com/"

  strings:
    $lib = "libmd.so"

  condition:
    is_apk and $lib
}

rule medusah_appsolid : packer
{
  meta:
    // Samples and discussion: https://github.com/rednaga/APKiD/issues/19
    description = "Medusah (AppSolid)"
    url = "https://appsolid.co/"
    sample = "5c1f14c1674c6f3ff72d9a017b083023d6c59635bec83718afec2d23372f84f4"

  strings:
    $encrypted_dex = "assets/high_resolution.png"

  condition:
    is_apk and $encrypted_dex and not medusah
}

rule baidu : packer
{
  meta:
    description = "Baidu"

  strings:
    $lib = "libbaiduprotect.so"
    $encrypted = "baiduprotect1.jar"

  condition:
    is_apk and ($lib or $encrypted)
}

rule pangxie : packer
{
  meta:
    description = "PangXie"
    sample = "ea70a5b3f7996e9bfea2d5d99693195fdb9ce86385b7116fd08be84032d43d2c"

  strings:
    $lib = "libnsecure.so"

  condition:
    is_apk and $lib
}

rule kony : packer
{
  meta:
    description = "Kony"
    url = "http://www.kony.com/"

  strings:
    $lib = "libkonyjsvm.so"
    $decrypt_keys = "assets/application.properties"
    $encrypted_js = "assets/js/startup.js"

  condition:
    is_apk and $lib and $decrypt_keys and $encrypted_js
}

rule approov : packer
{
  meta:
    description = "Approov"
    url = "https://www.approov.io/"

  strings:
    $lib = "libapproov.so"
    $sdk_config = "assets/cbconfig.JSON"

  condition:
    is_apk and $lib and $sdk_config
}

rule yidun : packer
{
  meta:
    description = "yidun"
    url = "https://dun.163.com/product/app-protect"

  strings:
    $anti_trick = "Lcom/_" // Class path of anti-trick
    $entry_point = "Lcom/netease/nis/wrapper/Entry"
    $jni_func = "Lcom/netease/nis/wrapper/MyJni"
    $lib = "libnesec.so"
    $nedata = "assets/nedata.db"
    $nedig = "assets/nedig.properties"

  condition:
    is_apk and (#lib > 1 or ($anti_trick and $entry_point and $jni_func) or ($nedata and $nedig))
}

rule apkpacker : packer
{
  meta:
    description = "ApkPacker"
    sample      = "087af5aacab8fc8bc7b1dcb7a138c3552d175c74b496056893299bc437422f95"
    author      = "Eduardo Novella"

  strings:
    $a = "assets/ApkPacker/apkPackerConfiguration"
    $b = "assets/ApkPacker/classes.dex"
    // These may be related, but not enough samples to be sure
    //$c = "assets/config.txt"
    //$d = "assets/sht.txt"

  condition:
    is_apk and all of them
}

rule chornclickers : packer
{

  meta:
    // This has no name so we made one up from Ch-china,-orn-porn and -clickers
    description = "ChornClickers"
    url         = "https://github.com/rednaga/APKiD/issues/93"
    sample      = "0c4a26d6b27986775c9c58813407a737657294579b6fd37618b0396d90d3efc3"
    author      = "Eduardo Novella"

  strings:
    $a = "lib/armeabi/libhdus.so"
    $b = "lib/armeabi/libwjus.so"

  condition:
    is_apk and all of them
}

rule appsuit_packer : packer
{
    meta:
        description = "AppSuit"
        url         = "http://www.stealien.com/appsuit.html"
        sample      = "8dc42cc950617ff51d0409a05809d20ca4c375f05c3fa2324b249e1306758a94"
        author      = "Eduardo Novella"

    strings:
        $asset1      = "assets/appsuit/momo"
        $asset2      = "assets/appsuit/meme"
        $native_lib2 = "libAppSuit.so"

    condition:
        is_apk and 2 of them
}

rule appsealing : packer
{
  meta:
    // Commercial packer
    description = "AppSealing"
    url         = "https://www.appsealing.com/"
    sample      = "61a983b032aee2e56159e682ad1588ad30fa8c3957bf849d1afe6f10e1d9645d"
    author      = "zeroload"

  strings:
    $native_lib_1 = "libcovault.so"
    $native_lib_2 = "libcovault-appsec.so"
    $stub         = "assets/appsealing.dex"
    $dex          = "assets/sealed1.dex"

  condition:
    is_apk and all of them
}

rule appsealing_a : packer
{
  meta:
    description = "AppSealing"
    url         = "https://www.appsealing.com/"
    sample      = "09de88c86182f066b5a1b1b7f0d5553cf6010ef2aed4a12ed5d9bea2e1866bbb"
    author      = "Eduardo Novella"

  strings:
    // asset names at "assets/AppSealing" : 11,a1,a3,aslc,hr,s1,s3,si,x1,x3
    $a1 = /assets\/AppSealing\/(.*)/

  condition:
    is_apk and #a1 > 3
}

rule secenh : packer
{
  meta:
    description = "Secenh"
    sample = "0709d38575e15643f03793445479d869116dca319bce2296cb8af798453a8752"
    author = "Nacho Sanmillan"

  strings:
    $a1 = "assets/libsecenh.so"
    $a2 = "assets/libsecenh_x86.so"
    $b1 = "assets/respatcher.jar"
    $b2 = "assets/res.zip"

  condition:
    is_apk
    and 1 of ($a*)
    and 1 of ($b*)
}

rule apkencryptor : packer
{
  meta:
    description = "ApkEncryptor"
    url         = "https://github.com/FlyingYu-Z/ApkEncryptor"
    sample      = "bc4a8774f4a2b0a72b3ffd4d9e1933913a1d95a8e50082255a167dec9d115a99"
    author      = "Eduardo Novella"

  strings:
    $src1 = "src/2ba5b2615b9b71b48c7694d6489e0171"
    $src2 = "src/2e15f58d32a5ff652706ef41ec85a763"
    $src3 = "src/3676d55f84497cbeadfc614c1b1b62fc"

  condition:
    is_apk and ($src1 or $src2 or $src3)
}

rule epicvm : packer
{
    meta:
        description = "Epic VM"
        url         = "https://t.me/epic_pro"
        url2        = "https://t.me/epic_pro/12"
        sample      = "da62478ddde547878294508d428580013e7ffce274ae3756ac260ae7d50640b8"
        author      = "Eduardo Novella"

    strings:
        $lib =  /lib\/(x86\_64|armeabi\-v7a|arm64\-v8a|x86)\/libEpic\_Vm\.so/

    condition:
        is_apk and all of them
}

rule appiron : packer
{
    meta:
        description = "Secucen AppIron"
        url         = "http://www.secucen.com/app/view/fintech/appIron"
        sample      = "d4f4a24ce6350bc4e23e2170da5b217dd65161aba5eca775d75514e9cdac4d59"
        author      = "dustty0 & Eduardo Novella"

    strings:
      $lib   = /lib\/(.*)\/libAppIron-jni_v(.*)\.so/
      $lib2  = /libAppIronExpress_v(.*)\.so/
      $asset = /assets\/appiron\/(.*)/

    condition:
      is_apk and 2 of them
}

rule eversafe : packer
{
    meta:
        description = "Eversafe"
        url         = "https://everspin.global/products/solutions/eversafe-mobile"
        sample      = "00dbb346f3ae0540620eb120ccf00a65af81a07baed5adfdcd2fc620a33ed298"
        author      = "dustty0 & Eduardo Novella"

    strings:
      $lib1  = /lib\/(.*)\/libeversafe\.so/
      $lib2  = /lib\/(.*)\/libeversafe-loader\.so/
      $asset = /assets\/eversafe\/eversafe_(.*)\.data/

    condition:
      is_apk and 2 of them
}

rule appcamo : packer
{
    meta:
        description = "AppCamo"
        url         = "http://appcamo.com/s2/s2_1.php"
        sample      = "b8bf8e44eff2f4557f050d19534624dc3df5053f7793eb409b98c18c475d969b"
        author      = "dustty0 & Eduardo Novella"

    strings:
      $lib   = /lib\/(.*)\/libalib\.so/
      $asset = /assets\/[0-9a-f]{32}\/[0-9a-f]{32}\.png/
      // assets/288426d06828409c8fb4f21080a51aee/d7b00c0c23514d7b9c9a022fcb9ce073.png

    condition:
      is_apk and all of them
}

rule aegis : packer
{
    meta:
        description = "Aegis - Android Republic Mods"
        url         = "https://androidrepublic.org"
        sample      = "4ca8c5f8ecfa1c36678b1745a2b58872e3f3f5fd14df6dd5fd65d6b8f2677f53"
        author      = "Yehh22 & Eduardo Novella"

    strings:
        $asset1 = "assets/aegis/aegis.mf"
        $asset2 = "assets/aegis/aegis.sig"
        $asset3 = /assets\/aegis\/aegis[0-9]{1}\.dat/
        $asset4 = "assets/aegis/nmsscr.nmss"
        $asset5 = "assets/aegis/nmssey.nmss"
        $asset6 = "assets/aegis/nmsskc.nmss"
        $asset7 = "assets/aegis/shield.dat"

    condition:
      is_apk and any of them
}

rule kangapack : packer
{
    meta:
        description = "KangaPack"
        sample      = "2c05efa757744cb01346fe6b39e9ef8ea2582d27481a441eb885c5c4dcd2b65b"
        sample2     = "1ac9044146fa1ff7fcf73cd31f7a940838983792e2a849cb66eed5a1d9c997dd"
        author      = "Axelle Apvrille"
        url         = "https://cryptax.medium.com/inside-kangapack-the-kangaroo-packer-with-native-decryption-3e7e054679c4"

    strings:
        $lib  = /lib\/(arm.*|x86.*)\/libapksadfsalkwes.so/

    condition:
        is_apk and all of them
}

rule tongfu_shield : packer
{
    meta:
        description = "Tongfu shield"
        url         = "https://www.tongfudun.com"
        url2        = "https://www.payegis.com/"
        sample      = "af27533557a47ff6795b0df77ea863bbefafa4974ce2dbf9604a79ce7196d080" // com.kingdee.zhihuiji v6.25.22
        author      = "Eduardo Novella"

    strings:
        $asset1 = "assets/mode"
        $asset2 = "assets/PK"
        $asset3 = "assets/virtual"
        $asset4 = "assets/libegis.a"
        $lib    = /lib\/(arm.*|x86.*)\/libegis.so/

    condition:
      is_apk and $lib and any of ($asset*)
}

rule zimperium_zshield_apk : packer
{
  meta:
    description = "Zimperium (zShield)"
    url         = "https://www.zimperium.com/zshield"
    sample      = "9512c46d99cdca1914a9f86870aa1c49845701abe1c63365ba2681d658c19941" // com.dbs.dbspaylah v6.2.0
    author      = "Eduardo Novella"

  strings:
    /**
      assets/jkhybtvppg.szip
      assets/jkhybtvppg/0.odex
      assets/jkhybtvppg/1.odex
      lib/$arch/libjkhybtvppg.so

      assets/ztest.szip
      assets/ztest/0.odex
      lib/$arch/libztest.so
    */
    $lib    = /lib\/(arm.*|x86.*)\/lib.*\.so/
    $asset1 = /assets\/.*\/0\.odex/
    $asset2 = /assets\/.*\.szip/

  condition:
    is_apk and all of them
}

rule nesun_apk : packer
{
  meta:
    description = "Nesun"
    url         = "http://nesun.cn"
    sample      = "13735b73994231e25393a1847e1111c9741cc112315b3f0d4f775a62ab58ae5d"
    author      = "Abhi"

  strings:
    $lib    = /lib\/(arm.*|x86.*)\/libzprotect\.so/

  condition:
    is_apk and $lib
}

rule gpresto_apk : packer
{
  meta:
    description = "G-Presto (anti-cheat)"
    url         = "https://www.largosoft.co.kr/"
    sample      = "44558c6c758b1ecf42ecda9981240d50c32f42e0d2be4693e37e39f8eb3a3488"
    author      = "Abhi"

  strings:
    $lib       = /lib\/(arm.*|x86.*)\/libATG_L\.so/
    $assets    = /assets\/ATG_E.*\.sec/
    $assetslib = "assets/libData.so"

  condition:
    is_apk and 2 of them
}

rule kiwisec_apk : packer
{
  meta:
    description = "KiwiSec"
    url         = "https://en.kiwisec.com/"
    sample      = "d108652bd1b685765e3ada2b7376e3c3ff67f8162afcf8bad91e0aef79b7b08a"
    author      = "Abhi"

  strings:
    $lib  = /lib\/(arm.*|x86.*)\/libkiwicrash\.so/
    $lib2 = /lib\/(arm.*|x86.*)\/libkiwi_dumper\.so/
    $lib3 = /lib\/(arm.*|x86.*)\/libKwProtectSDK\.so/
    $lib4 = /lib\/(arm.*|x86.*)\/libkwsdataenc\.so/
    $lib5 = /lib\/(arm.*|x86.*)\/libkadp\.so/
    $lib6 = /lib\/(arm.*|x86.*)\/libwhite-box\.so/

  condition:
    is_apk and 2 of them
}

rule dingxiang_apk : packer
{
  meta:
    description = "DingXiang"
    url         = "https://www.dingxiang-inc.com/business/android"
    sample      = "788ebabd9b5464c5e86b3832e4a7b6e7c91cce5603ff17f214429400ba3bb2b9" // net.crigh.cgsport
    author      = "Abhi"

  strings:
    $lib      = /lib\/(arm.*|x86.*)\/libsys_misc\.so/
    $assets   = /assets\/csn.*\.data\d?/
    $assets2  = "assets/__param.data"
    $assets3  = "assets/__version.txt"
    $dsnstub  = "dsnstub000.vd"

  condition:
    is_apk and 2 of them
}

rule manxi_sec : packer
{
  meta:
    description = "Manxi Security"
    url         = "https://www.manxi-inc.com/en/"
    sample      = "9803121e89d5609215dc736b11cf5cf0a7d56ddfe5ac9ab71eb2b2883f427ac2" // cn.dict.android.pro (6.1.37)
    author      = "Abhi"

  strings:
    $a1 = /assets\/mxsafe\/(arm.*|x86.*)\/libdSafeShell\.so/
    $a2 = /assets\/mx\/(arm.*|x86.*)\/libmxacc\.so/
    $a3 = /lib\/(arm.*|x86.*)\/libmanxi\.so/
    $a4 = "assets/mxsafe.data"
    $a5 = "assets/mxsafe.config"
    $a6 = "assets/mxsafe.jar"

  condition:
    is_apk and any of them
}

rule dexprotectx : packer
{
  meta:
    description = "DexProtect X (DexShellx)"
    url         = "https://dexprotectx.pro"
    url2        = "https://t.me/DexShell_x"
    sample      = "72e8685df3168c947190a4ccb76ca26de3762bfe5560549545e935b09c8893df" // com.x.dexprotectx
    author      = "Abhi"

  strings:
    $a1 = "assets/libVMDexShellx.so"
    $a2 = /assets\/dexshell\/(arm.*|x86.*)\/libdexshell\.so/
    $a3 = "assets/DexShell.mp3"

  condition:
    is_apk and any of them
}

rule venustech : packer
{
  meta:
    description = "Venustech"
    url         = "https://www.venustech.com.cn/new_type/ydyyaqjg/"
    sample      = "TODO"
    author      = "Abhi, ApkCheckPack"

  strings:
    $lib = /lib\/(arm.*|x86.*)\/libven(Sec|ustech)\.so/

  condition:
    is_apk and all of them
}

```

`apkid/rules/apk/protectors.yara`:

```yara
/*
 * Copyright (C) 2023  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

include "common.yara"

rule verimatrix : protector
{
  meta:
    description = "InsideSecure Verimatrix"
    url         = "https://www.verimatrix.com/solutions/code-protection"
    sample      = "fdd6b324a267cb5287550b1ab2c7e527ad49b5ed4f4542abbc4fb5e8e2c00d3f"
    author      = "Eduardo Novella"

  strings:
    $libname = /lib\/(arm.*|x86.*)\/libmfjava\.so/

  condition:
    is_apk and $libname
}

rule virbox_apk : protector
{
  meta:
    description = "Virbox"
    url         = "https://shell.virbox.com"
    sample      = "b1a5d9d4c1916a0acc2d5c3b7c811a39ebeb2f6d42b305036473f7053bbf5fe7"
    author      = "Eduardo Novella"

  strings:
    $libs1 = "libsandhook.so"
    $libs2 = "libsandhook-native.so"
    $libv1 = "libv++_64.so"
    $libv2 = "libv++.so"

  condition:
    is_apk and
    1 of ($libs*) and
    1 of ($libv*)
}

rule vkey_apk : protector
{
  meta:
    description = "Vkey (V-OS App Protection)"
    url         = "https://www.v-key.com/products/v-os-app-protection/"
    author      = "Eduardo Novella"
    sample      = "eb7f7fd8b23ea2b55504b2d22dd6ee7a1214d822a79e848badcf720359ee78d1"

  strings:
    $lib1    = /lib\/(x86\_64|armeabi\-v7a|arm64\-v8a|x86)\/libvosWrapperEx\.so/
    $lib2    = /lib\/(x86\_64|armeabi\-v7a|arm64\-v8a|x86)\/libvtap\.so/
    $lib3    = /lib\/(x86\_64|armeabi\-v7a|arm64\-v8a|x86)\/libloadTA\.so/
    $lib4    = /lib\/(x86\_64|armeabi\-v7a|arm64\-v8a|x86)\/libchecks\.so/
    $asseta1 = "assets/firmware"
    $asseta2 = "assets/kernel.bin"
    $asseta3 = "assets/signature"
    $assetb1 = "assets/vkeylicensepack"
    $assetb2 = "assets/vkwbc_ta.bin"
    $assetb3 = "assets/voscodesign.vky"

  condition:
    is_apk and
    2 of ($lib*) and
    1 of ($asseta*) and
    1 of ($assetb*)
}

rule free_rasp_old : protector
{
  meta:
    description = "FreeRASP"
    url         = "https://www.talsec.app/freerasp-in-app-protection-security-talsec"
    sample      = "e10b8772fd9b6aaf8ba030c5bcb324fb9b91f34e893a62bdf238629df856e047"
    author      = "Fare9"

  strings:
    $lib1   = /lib\/(arm.*|x86.*)\/libsecurity\.so/
    $lib2   = /lib\/(arm.*|x86.*)\/libpolarssl\.so/

  condition:
    is_apk and all of them
}

rule ahnlab_v3_engine : protector
{
  meta:
    description = "Ahnlab V3 engine"
    url         = "https://www.ahnlab.com/en"
    author      = "whoa-mi"
    sample      = "638bad9c6336049f43ac88d7db65c743d9703d732f86f2dc094999b195d63aa2"

  strings:
    $binary1 = /lib\/(arm|x86).*\/libEngineManager\.so/
    $binary2 = /assets\/ahnlab\/engine\/(arm|x86).*\/lib(rc|av)engine/
    $binary3 = "assets/ahnlab/engine/rootchecker2.rcd"

  condition:
    is_apk and 2 of ($binary*)
}

rule free_rasp_new : protector
{
  meta:
    description = "FreeRASP"
    url         = "https://www.talsec.app/freerasp-in-app-protection-security-talsec"
    sample      = "2b8faa038bf34474075a56e2fda7887a7df9c3c57db8a9f25547dc9374137ec9"
    author      = "Fare9"

  strings:
    $lib1   = /lib\/(arm.*|x86.*)\/libsecurity\.so/
    $lib2   = /lib\/(arm.*|x86.*)\/libpolarssl\.so/
    $asset  = "assets/talsec"

  condition:
    is_apk and all of them
}

rule ahope_appshield : protector
{
    meta:
        description = "Ahope AppShield"
        url         = "http://www.ahope.net/sub/app-shields"
        sample      = "42a4d907caf625ff73d5b6fbbf32b59ba14d6d5a72f28b81bdc76c47db516122"
        author      = "dustty0 & Eduardo Novella"

    strings:
      $lib = /lib\/(arm.*|x86.*)\/libahope(.*)\.so/

    condition:
      is_apk and any of them
}

rule vguard : protector
{
  meta:
    description = "VGuard"
    url         = "https://www.vguard.co.kr"
    sample      = "7024bdadb53cbec86a39de845108b182ed2f7b3f0e7c0b876a948e1532ec5b9f"
    author      = "dustty0"

  strings:
    $lib    = /lib\/(arm.*|x86.*)\/libedex\.so/
    $asset1 = /assets\/dexsky\.(d|e)b(a|b|x|y)/
    $asset2 = /assets\/dex[a-z0-9]{3}\.zip/
    $asset3 = /assets\/vguard\.(key|enginehash)/
    $asset4 = "assets/dexsky.ini"

  condition:
    is_apk and 2 of them
}

rule appdefence : protector
{
  meta:
    description = "ExTrus AppDefence"
    url         = "https://www.extrus.co.kr/eng/m/product_01_05.html"
    sample      = "e080380673479d2e182ad7eff5130bb72fe9a228c0a5de9852df23c4e98113b2"
    author      = "dustty0"

  strings:
    $asset = "assets/appdefence_xml"

  condition:
    is_apk and all of them
}

rule dpt_shell : protector
{
  meta:
    description = "DPT Shell"
    url         = "https://github.com/luoyesiqiu/dpt-shell"
    sample      = "0c4341700f4e685cafc9c86c9112098b75057580ba1f7163bc971347af3712ad"
    author      = "Abhi"

  strings:
    $app = "assets/app_name"
    $app_acf = "assets/app_acf"
    $assetlib = /assets\/(.*)\/(arm.*|x86.*)\/libdpt\.so/

  condition:
    is_apk and $assetlib and any of ($app*)
}

rule build38 : protector
{
  meta:
    description = "Build38"
    url         = "https://build38.com"
    sample      = "cfbbfca598a9877a381583a7ae2f9e8cde92e7314b21152658bcba5a4e3a0fff" // com.esignus.hashwalletmanager
    author      = "Abhi"

  strings:
    $lib      = /lib\/(arm.*|x86.*)\/libtak\.so/
    $license  = "__license.tak"
    $license2 = "license.tak"

  condition:
    is_apk and 2 of them
}

rule shield_sdk : protector
{
  meta:
    description = "Shield SDK"
    url         = "https://shield.com/"
    sample      = "fb4b7f033658b3898e0448955491b448a2c78e1a2325c65fece6ad64f6f6b6d0" // com.mpl.androidapp
    author      = "Abhi"

  strings:
    $lib = /lib\/(arm.*|x86.*)\/libcashshieldabc-native-lib\.so/

  condition:
    is_apk and all of them
}

rule andres : manipulator
{
    meta:
      description = "Resources Confusion"
      url         = "https://github.com/shwenzhang/AndResGuard"
      sample      = "45610fcb6ba935db0bf1bd94d672a848852ee9665cebaab7b3d4d7497d8e730f"
      author      = "Abhi"

    strings:
      $res = /res\/[^\/]+\.xml/

    condition:
      is_apk and #res > 10
}

rule bugsmirror : protector
{
  meta:
    description = "BugsMirror"
    url         = "https://www.bugsmirror.com/"
    sample      = "c9bbf66ac86bf02663b7bc28a735881d4aeaa8d90e9b8b752e9cf337a26f0bdd"
    author      = "Abhi"

  strings:
    $lib  = /lib\/(arm.*|x86.*)\/libdefender\.so/
    $xml  = /res\/xml\/(com_bugsmirror_)?(defender|bugsmirror)_authenticator\.xml/
    $lib2 = /lib\/(arm.*|x86.*)\/libsettings\.so/

  condition:
    is_apk and 2 of them
}

rule bshield : protector
{
  meta:
    description = "BShield"
    url         = "https://bshield.io/"
    sample      = "f54fa5cfcd9a5d14a947bbd93bc7bb59e8c2b1b23cc5bcc84c66ad0143e55201"
    author      = "Abhi"

  strings:
    $asset = "assets/bshield.dat"

  condition:
    is_apk and all of them
}

rule denuvo_apk : protector
{
  meta:
    description = "Denuvo"
    url         = "https://irdeto.com/denuvo/anti-tamper"
    sample      = "f7d1cd97b5d61da16b804daf6cd1199fe822745f9066596988d30a934441f6fc"
    author      = "Abhi"

  strings:
    $tid     = "assets/tid"
    $libvmpc = "libvmpc.so"

  condition:
    is_apk and all of them
}

rule alibaba_sec : protector
{
  meta:
    description = "Alibaba Security SDK"
    url         = "https://www.alibabacloud.com/zh/product/mpaas"
    sample      = "4590673ad6320d9a091d33e5b3b9b652479ddced573bde9c3ded8acba0451d53"
    author      = "Abhi"

  strings:
    $lib   = /lib\/(arm.*|x86.*)\/lib(alisecuritysdk|demolish(data)?|reverify1)\.so/
    $asset = "assets/ali_sec.dat"

  condition:
    is_apk and any of them
}

rule bureau : protector
{
  meta:
    description = "Bureau"
    url         = "https://bureau.id"
    sample      = "484d8d0f4eb2c2ed66770edfa0ab89bf76f9b84227faea3889ce74b2af8cbbc4"
    author      = "Abhi, ApkUnpacker"

  strings:
    $lib  = /lib\/(arm.*|x86.*)\/libbureau\-.*\.so/

  condition:
    is_apk and all of them
}

rule haiyun : protector
{
  meta:
    description = "Haiyun'an Security"
    url         = "https://www.secidea.com/services/appprotect.html" // dead url now
    sample      = "TODO"
    author      = "Abhi"

  strings:
    $lib   = /lib\/(arm.*|x86.*)\/libitsec\.so/
    $asset = "assets/itse"

  condition:
    is_apk and all of them
}

rule oppo_protect : protector
{
  meta:
    description = "OPPO Protect SDK"
    url         = "https://open.oppomobile.com/product/page?page_name=environmentdetect"
    sample      = "TODO"
    author      = "Abhi, ApkCheckPack"

  strings:
    $lib    = /lib\/(arm.*|x86.*)\/libOPPOProtect(2019)?\.so/
    $lib2   = /lib\/(arm.*|x86.*)\/libomesStdSco\.so/

  condition:
    is_apk and any of them
}


```

`apkid/rules/dex/abnormal.yara`:

```yara
/*
 * Copyright (C) 2023  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

/*
TODO:
    class name length is > 255 characters
*/

import "dex"
include "common.yara"

rule abnormal_header_size : abnormal
{
  meta:
    description = "non-standard header size"
    sample      = "1d97aff8d86d164dc64e81b822c01623940e2f21ab51d2fd42172b364d5e185e"

  condition:
    /*
     * Header size is always 112 bytes but the format allows it to be bigger. This would make it
     * possible to do weird stuff like hide files after the normal header data.
     */
    is_dex and dex.header.header_size != 0x70
}

rule non_zero_link_size : anti_disassembly
{
  meta:
    description = "non-zero link size"
    sample      = "ad006e1e152fe298e86bb540d2c56cf474a246885e87c351a3285615c8e8bb42"

  condition:
    dex.header.link_size != 0x0
}

rule non_zero_link_offset : anti_disassembly
{
  meta:
    description = "non-zero link offset"
    sample      = "5882f768d42fe1837f562023e5ea1d7e03c7b56f0c31bcbb4423726c2109faf9"

  condition:
    dex.header.link_offset != 0x0
}

rule non_little_endian : abnormal
{
  meta:
    description = "non little-endian format"
    sample      = "b82d521aa24f4f7c995ba55eaa8db9e2f4e9dd69ac0d9ddea2fb776d49ecd7a4"

  condition:
    dex.header.endian_tag != 0x12345678
}

rule data_injected_after_map : dropper
{
  meta:
    description = "injected data after map section"

  condition:
    dex.header.file_size < dex.header.map_offset + (dex.map_list.size * 12) + 4
}

rule illegal_class_names : anti_disassembly
{
  meta:
    description = "illegal class name"
    sample      = "5e980583904b08732ef7c833351ee45cfe86de55d6411a94a986cacce5b82700"

  strings:
    /*
     * Disassemblers use class names for file names, and these file names
     * are illegal on some file systems (looking at you, Windows)
     */
    $invalid = /\x00[^\x00]{1,4}L([^\x00\x2f]+\x2f)*(CON|PRN|AUX|CLOCK\$|NUL|COM[1-9]|LPT[1-9])(\x2f[^\x00\x2f]+\x2f+)*;\x00/is

  condition:
    any of them
}

```

`apkid/rules/dex/anti-vm.yara`:

```yara
/*
 * Copyright (C) 2023  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

import "dex"
include "common.yara"

private rule uses_build_class : internal
{
  meta:
    description = "References android.os.Build class"

  strings:
    // Landroid/os/Build;
    $a = {00 12 4C 61 6E 64 72 6F 69 64 2F 6F 73 2F 42 75 69 6C 64 3B 00}
  condition:
    is_dex
    and $a
}

private rule uses_debug_class : internal
{
  meta:
    description = "References android.os.Debug class"

  strings:
    // Landroid/os/Debug;
    $a = {00 12 4C 61 6E 64 72 6F 69 64 2F 6F 73 2F 44 65 62 75 67 3B 00}
  condition:
    is_dex
    and $a
}

private rule uses_telephony_class : internal
{
  meta:
    description = "References android.telephony.TelephonyManager class"

  strings:
    // Landroid/telephony/TelephonyManager;
    $a = {00 24 4C 61 6E 64 72 6F 69 64 2F 74 65 6C 65 70 68 6F 6E 79 2F 54
          65 6C 65 70 68 6F 6E 79 4D 61 6E 61 67 65 72 3B 00}
  condition:
    is_dex
    and $a
}

rule checks_build_fingerprint : anti_vm
{
  meta:
    description = "Build.FINGERPRINT check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    // FINGERPRINT
    $prop = {00 0B 46 49 4E 47 45 52 50 52 49 4E 54 00}
    // generic
    $str_1 = {00 07 67 65 6E 65 72 69 63 00 0A}
    // unknown
    $str_2 = {00 07 75 6E 6B 6E 6F 77 6E 00}
    $str_3 = "generic/sdk/generic"
    $str_4 = "generic/generic/generic"
    $str_5 = "generic/google_sdk/generic"
    $str_6 = "generic_x86/sdk_x86/generic_x86"
    $str_7 = "Android/full_x86/generic_x86"
    $str_8 = "generic/vbox86p/vbox86p"

  condition:
    uses_build_class
    and $prop
    and 1 of ($str_*)
}

rule checks_debugger_present : anti_debug
{
  meta:
    description = "Debug.isDebuggerConnected() check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    $debug = "Debug"
    $debugger_connected = "isDebuggerConnected"

  condition:
    uses_debug_class
    and $debug and $debugger_connected
}

rule checks_build_model : anti_vm
{
  meta:
    description = "Build.MODEL check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    // MODEL
    $prop = {00 05 4D 4F 44 45 4C 00}
    // google_sdk
    $str_1 = {00 0A 67 6F 6F 67 6C 65 5F 73 64 6B 00}
    // sdk
    $str_2 = {00 03 73 64 6B 00}
    // Emulator
    $str_3 = {00 08 45 6D 75 6C 61 74 6F 72 00}
    // Android SDK built for x86
    $str_4 = "Android SDK built for x86"
    $str_5 = "Full Android on x86"

  condition:
    uses_build_class
    and $prop
    and 1 of ($str_*)
}

rule checks_build_manufacturer : anti_vm
{
  meta:
    description = "Build.MANUFACTURER check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    // MANUFACTURER
    $prop = {00 0C 4D 41 4E 55 46 41 43 54 55 52 45 52 00}
    // Genymotion
    $str_1 = {00 0A 47 65 6E 79 6D 6F 74 69 6F 6E 00}
    // unknown
    $str_2 = {00 07 75 6E 6B 6E 6F 77 6E 00}

  condition:
    uses_build_class
    and $prop
    and 1 of ($str_*)
}

rule checks_build_brand : anti_vm
{
  meta:
    description = "Build.BRAND check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    // BRAND
    $prop = {00 05 42 52 41 4E 44 00}
    // generic
    $str_1 = {00 07 67 65 6E 65 72 69 63 00 0A}

  condition:
    uses_build_class
    and $prop
    and $str_1
}

rule checks_build_device : anti_vm
{
  meta:
    description = "Build.DEVICE check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    // DEVICE
    $prop = {00 06 44 45 56 49 43 45 00}
    // generic
    $str_1 = {00 07 67 65 6E 65 72 69 63 00 0A}

  condition:
    uses_build_class
    and $prop
    and $str_1
}

rule checks_build_product : anti_vm
{
  meta:
    description = "Build.PRODUCT check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    // PRODUCT
    $prop = {00 07 50 52 4F 44 55 43 54 00}
    // google_sdk
    $str_1 = {00 0A 67 6F 6F 67 6C 65 5F 73 64 6B 00}
    // sdk
    $str_2 = {00 03 73 64 6B 00}

  condition:
    uses_build_class
    and $prop
    and 1 of ($str_*)
}

rule checks_build_hardware : anti_vm
{
  meta:
    description = "Build.HARDWARE check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    // HARDWARE
    $prop = {00 08 48 41 52 44 57 41 52 45 00}
    // goldfish
    $str_1 = {00 08 67 6F 6C 64 66 69 73 68 00}
    // ranchu
    $str_2 = {00 06 72 61 6E 63 68 75 00}
    $str_4 = "vbox86"

  condition:
    uses_build_class
    and $prop
    and 1 of ($str_*)
}

rule checks_build_board : anti_vm
{
  meta:
    description = "Build.BOARD check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    // BOARD
    $prop = {00 05 42 4F 41 52 44 00}
    // unknown
    $str_1 = {00 07 75 6E 6B 6E 6F 77 6E 00}

  condition:
    uses_build_class
    and $prop
    and $str_1
}

rule checks_build_id : anti_vm
{
  meta:
    description = "Build.ID check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    // ID
    $prop = {00 02 49 44 00}
    // FRF91
    $str_1 = {00 05 46 52 46 39 31 00}

  condition:
    uses_build_class
    and $prop
    and $str_1
}

rule possible_build_serial_check : anti_vm
{
  meta:
    description = "possible Build.SERIAL check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    // SERIAL
    $prop = {00 06 53 45 52 49 41 4C 00}
    // Serial is checked for null / 0x0, so no literal

  condition:
    uses_build_class
    and $prop
}

rule checks_build_tags : anti_vm
{
  meta:
    description = "Build.TAGS check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    // TAGS
    $prop = {00 04 54 41 47 53 00}
    // test-keys
    $str_1 = {00 09 74 65 73 74 2D 6B 65 79 73 00}

  condition:
    uses_build_class
    and $prop
    and $str_1
}

rule checks_build_user : anti_vm
{
  meta:
    description = "Build.USER check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    // TAGS
    $prop = {00 04 54 41 47 53 00}
    // android-build
    $str_1 = {00 0D 61 6E 64 72 6F 69 64 2D 62 75 69 6C 64 00}

  condition:
    uses_build_class
    and $prop
    and $str_1
}

rule checks_sim_operator : anti_vm
{
  meta:
    description = "SIM operator check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    // getSimOperator
    $a = {00 0E 67 65 74 53 69 6D 4F 70 65 72 61 74 6F 72 00}
    // Android
    $b = {00 07 41 6E 64 72 6F 69 64 00}

  condition:
    uses_telephony_class
    and all of them
}

rule checks_network_operator : anti_vm
{
  meta:
    description = "network operator name check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    // getNetworkOperatorName
    $a = {00 16 67 65 74 4E 65 74 77 6F 72 6B 4F 70 65 72 61 74 6F 72 4E 61 6D 65 00}
    // Android
    $b = {00 07 41 6E 64 72 6F 69 64 00}

  condition:
    uses_telephony_class
    and all of them
}

rule checks_device_id : anti_vm
{
  meta:
    description = "device ID check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    // getDeviceId
    $a = {00 0B 67 65 74 44 65 76 69 63 65 49 64 00}
    // 000000000000000
    $b = {00 0F 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 00}

  condition:
    uses_telephony_class
    and all of them
}

rule checks_line1_number : anti_vm
{
  meta:
    description = "line 1 number check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    // getLine1Number
    $a = {00 0E 67 65 74 4C 69 6E 65 31 4E 75 6D 62 65 72 00}
    // 155552155
    $b = {00 09 31 35 35 35 35 32 31 35 35 00}

  condition:
    uses_telephony_class
    and all of them
}

rule checks_voicemail_number : anti_vm
{
  meta:
    description = "voice mail number check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    // getVoiceMailNumber
    $a = {00 12 67 65 74 56 6F 69 63 65 4D 61 69 6C 4E 75 6D 62 65 72 00}
    // 15552175049
    $b = {00 0B 31 35 35 35 32 31 37 35 30 34 39 00}

  condition:
    uses_telephony_class
    and all of them
}

rule checks_subscriber_id: anti_vm
{
  meta:
    description = "subscriber ID check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    // getSubscriberId
    $a = {00 0F 67 65 74 53 75 62 73 63 72 69 62 65 72 49 64 00}
    $b = "0000000000"

  condition:
    uses_telephony_class
    and all of them
}

rule checks_network_interface_names: anti_vm
{
  meta:
    description = "network interface name check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    // Ljava/net/NetworkInterface;
    $a = {00 1B 4C 6A 61 76 61 2F 6E 65 74 2F 4E 65 74 77 6F 72 6B 49 6E 74 65 72 66 61 63 65 3B 00}
    // getName
    $b = {00 07 67 65 74 4E 61 6D 65 00 0F}
    // eth0
    $c = {00 04 65 74 68 30 00}

  condition:
    is_dex
    and all of them
}

rule checks_cpuinfo : anti_vm
{
  meta:
    description = "/proc/cpuinfo check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    $a = "/proc/cpuinfo"
    $b = "Goldfish"

  condition:
    is_dex
    and all of them
}

rule checks_build_type : anti_vm
{
  meta:
    description = "ro.build.type check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    $a = "ro.build.type"
    $b = "user"

  condition:
    is_dex
    and all of them
}

rule checks_hardware : anti_vm
{
  meta:
    description = "ro.hardware check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    $a = "ro.hardware"
    $str_1 = "goldfish"
    $str_2 = "ranchu"

  condition:
    is_dex
    and $a
    and 2 of ($str_*)
}

rule checks_product_device : anti_vm
{
  meta:
    description = "ro.product.device check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    $a = "ro.product.device"
    $b = "generic"

  condition:
    is_dex
    and all of them
}

rule checks_kernel_qemu : anti_vm
{
  meta:
    description = "ro.kernel.qemu check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    $a = "ro.kernel.qemu"

  condition:
    is_dex
    and all of them
}

rule possible_ro_secure_check : anti_vm
{
  meta:
    description = "possible ro.secure check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    $a = "ro.secure"

  condition:
    is_dex
    and all of them
}

rule checks_qemu_file : anti_vm
{
  meta:
    description = "emulator file check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    $a = "/init.goldfish.rc"
    $b = "/sys/qemu_trace"
    $c = "/system/bin/qemud"
    $d = "/system/bin/qemu-props"
    $e = "/system/lib/libc_malloc_debug_qemu.so"
    $f = "/dev/qemu_pipe"
    $g = "/dev/socket/qemud"

    // Geny detections
    $h = "/dev/socket/genyd"
    $i = "/dev/socket/baseband_genyd"

  condition:
    is_dex
    and 1 of them
}

rule possible_vm_check : anti_vm
{
  meta:
    description = "possible VM check"
    sample = "9c6b6392fc30959874eef440b6a83a9f5ef8cc95533037a6f86d0d3d18245224"

  strings:
    $a = "isEmulator"

  condition:
    is_dex
    and all of them
}

```

`apkid/rules/dex/common.yara`:

```yara
/*
 * Copyright (C) 2023  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

import "dex"

rule is_dex : file_type
{
  meta:
    description = "DEX"

  strings:
    $dex = { 64 65 78 0A 30 33 ?? 00 }
    $odex = { 64 65 79 0A 30 33 ?? 00 }

  condition:
    $dex at 0 or
    $odex at 0
}

private rule yara_detected_dex : internal {
  meta:
    description = "magic bytes look like a dex but yara disagrees"

  condition:
    is_dex
    and dex.header.header_size > 0
}

rule yara_undetected_dex : yara_issue {
  meta:
    description = "yara issue - dex file recognized by apkid but not yara module"

  condition:
    is_dex
    and not yara_detected_dex
}

```

`apkid/rules/dex/compilers.yara`:

```yara
/*
 * Copyright (C) 2023  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

import "dex"
include "common.yara"

private rule unsorted_string_pool : internal
{
  meta:
    description = "String pool in non-standard order"

  condition:
    /*
     * DEX format requires string IDs to be sorted according to the data at their offsets but the actual
     * ordering of the string pool is undefined. Dexlib (smali/apktool) 1.x sorts strings by class and
     * proximity. DX sorts the string pool in the same order as the string table.
     *
     * Note: It's probably only necessary to check the first several strings.
     */
    for any i in (0..dex.header.string_ids_size - 1) : (dex.string_ids[i + 1].offset < dex.string_ids[i].offset)
}

private rule dexlib2_map_type_order : internal
{
  meta:
    description = "dexlib2 map_list type order"

  condition:
    (dex.map_list.map_item[7].type == 0x2002 and dex.map_list.map_item[8].type == 0x1001)
    or (dex.map_list.map_item[6].type == 0x2002 and dex.map_list.map_item[7].type == 0x1001)
}

private rule null_interfaces : internal
{
  meta:
    description = "null interfaces offset"

  condition:
    /*
     * Dexlib2 adds a non-zero interfaces_offset to every class_def_item, even if the class doesn't implement an
     * interface. It points to 4 null bytes right after string pool. DEX documentation says the value for
     * interfaces_offset should be 0 if there is no interface, which is what DX does. It's enough to check
     * if a single class has an interface which points to null bytes since no one else does this.
     */
    for any i in (0..dex.header.class_defs_size) : (dex.class_defs[i].interfaces_offset > 0 and uint32(dex.class_defs[i].interfaces_offset) == 0)
}

private rule dx_map_type_order : internal
{
  meta:
    description = "dx map_list type order"

  condition:
    /*
     * Different compiler families tend to order the map_list types differently.
     * DX order derrived from: https://github.com/aosp-mirror/platform_dalvik/blob/2e9d6011fe4f4d2e8c065210d0118e7b9d9f305c/dx/src/com/android/dx/dex/file/DexFile.java#L144
     * The order starting at offset 7 is:
     *   0x1002 = TYPE_ANNOTATION_SET_REF_LIST (optional)
     *   0x1003 = TYPE_ANNOTATION_SET_ITEM (optional)
     *   0x2001 = TYPE_CODE_ITEM (optional, but very common)
     *   0x2006 = TYPE_ANNOTATIONS_DIRECTORY_ITEM (optional)
     *   0x1001 = TYPE_TYPE_LIST (optional, but common)
     *   0x2002 = TYPE_STRING_DATA_ITEM
     * Also, for reference:
     *   0x0000 = TYPE_HEADER_ITEM
     *   0x0001 = TYPE_STRING_ID_ITEM
     *   0x0002 = TYPE_TYPE_ID_ITEM
     *   0x0006 = TYPE_CLASS_DEF_ITEM
     *   0x1000 = TYPE_MAP_LIST
     */
    // missing all TYPE_ANNOTATION*, common case
    (dex.map_list.map_item[7].type == 0x2001 and dex.map_list.map_item[8].type == 0x1001)

    // missing all TYPE_ANNOTATION*, and TYPE_TYPE_LIST so probably very small DEX
    or (dex.map_list.map_item[7].type == 0x2001 and dex.map_list.map_item[8].type == 0x2002)

    // has all TYPE_ANNOTATION*
    or (dex.map_list.map_item[7].type == 0x1002 and dex.map_list.map_item[8].type == 0x1003 and dex.map_list.map_item[9].type == 0x2001 and dex.map_list.map_item[10].type == 0x2006 and dex.map_list.map_item[11].type == 0x1001)

    // missing TYPE_ANNOTATION_SET_REF_LIST
    or (dex.map_list.map_item[7].type == 0x1003 and dex.map_list.map_item[8].type == 0x2001 and dex.map_list.map_item[9].type == 0x2006 and dex.map_list.map_item[10].type == 0x1001)

    // missing TYPE_ANNOTATION_SET_REF_LIST and TYPE_ANNOTATION_SET_ITEM
    or (dex.map_list.map_item[7].type == 0x2001 and dex.map_list.map_item[8].type == 0x2006 and dex.map_list.map_item[9].type == 0x1001)

    // missing TYPE_ANNOTATION_SET_REF_LIST and TYPE_ANNOTATIONS_DIRECTORY_ITEM
    or (dex.map_list.map_item[7].type == 0x1003 and dex.map_list.map_item[8].type == 0x2001 and dex.map_list.map_item[9].type == 0x1001)

    // missing TYPE_ANNOTATION_SET_ITEM
    or (dex.map_list.map_item[7].type == 0x1002 and dex.map_list.map_item[8].type == 0x2001 and dex.map_list.map_item[9].type == 0x2006 and dex.map_list.map_item[10].type == 0x1001)

    // missing TYPE_ANNOTATION_SET_ITEM and TYPE_ANNOTATIONS_DIRECTORY_ITEM
    or (dex.map_list.map_item[7].type == 0x1002 and dex.map_list.map_item[8].type == 0x2001 and dex.map_list.map_item[9].type == 0x1001)

    // missing TYPE_ANNOTATIONS_DIRECTORY_ITEM
    or (dex.map_list.map_item[7].type == 0x1002 and dex.map_list.map_item[8].type == 0x1003 and dex.map_list.map_item[9].type == 0x2001 and dex.map_list.map_item[10].type == 0x1001)

    // missing almost everything, VERY tiny dex
    or (dex.map_list.map_item[1].type == 0x0001 and dex.map_list.map_item[2].type == 0x0002 and dex.map_list.map_item[3].type == 0x0006 and dex.map_list.map_item[4].type == 0x2002 and dex.map_list.map_item[5].type == 0x1000)

    // missing code and (fields | something else), likely small dex
    or (dex.map_list.map_item[6].type == 0x1003 and dex.map_list.map_item[7].type == 0x2006 and dex.map_list.map_item[8].type == 0x1001 and dex.map_list.map_item[9].type == 0x2002)
}

private rule ambiguous_tiny_dex_map_type_order : internal
{
  meta:
    description = "ambiguous tiny dex map type order"

  condition:
    // missing almost everything, dexlib2 and r8 are identical here, impossible to type alone
    (dex.map_list.map_item[1].type == 0x0001 and dex.map_list.map_item[2].type == 0x0002 and dex.map_list.map_item[3].type == 0x0006 and dex.map_list.map_item[4].type == 0x2002 and dex.map_list.map_item[5].type == 0x1003 and dex.map_list.map_item[6].type == 0x1000)
}

private rule r8_map_type_order : internal
{
  meta:
    description = "r8 map_list type order"

  condition:
    /*
     * R8 order derrived from: https://r8.googlesource.com/r8/+/refs/heads/master/src/main/java/com/android/tools/r8/dex/FileWriter.java#1215
     * The order starting at offset 7 is:
     *   0x0007 = TYPE_CALL_SITE_ID_ITEM (optional)
     *   0x0008 = TYPE_METHOD_HANDLE_ITEM (optional)
     *   0x2001 = TYPE_CODE_ITEM
     *   0x2003 = TYPE_DEBUG_INFO_ITEM (optional)
     *   0x1001 = TYPE_TYPE_LIST
     *   0x2002 = TYPE_STRING_DATA_ITEM
     */
    // missing TYPE_CALL_SITE_ID_ITEM and TYPE_METHOD_HANDLE_ITEM, common case
    (dex.map_list.map_item[7].type == 0x2001 and dex.map_list.map_item[8].type == 0x2003 and dex.map_list.map_item[9].type == 0x1001)

    // missing TYPE_DEBUG_INFO_ITEM
    or (dex.map_list.map_item[7].type == 0x2001 and dex.map_list.map_item[8].type == 0x1001 and dex.map_list.map_item[9].type == 0x2002)

    // has everything
    or (dex.map_list.map_item[7].type == 0x0007 and dex.map_list.map_item[8].type == 0x0008 and dex.map_list.map_item[9].type == 0x2001 and dex.map_list.map_item[10].type == 0x2003 and dex.map_list.map_item[11].type == 0x1001)

    // missing TYPE_CALL_SITE_ID_ITEM
    or (dex.map_list.map_item[7].type == 0x0008 and dex.map_list.map_item[8].type == 0x2001 and dex.map_list.map_item[9].type == 0x2003 and dex.map_list.map_item[10].type == 0x1001)

    // missing TYPE_METHOD_HANDLE_ITEM
    or (dex.map_list.map_item[7].type == 0x0007 and dex.map_list.map_item[8].type == 0x2001 and dex.map_list.map_item[9].type == 0x2003 and dex.map_list.map_item[10].type == 0x1001)

    // ignore missing TYPE_CALL_SITE_ID_ITEM, TYPE_METHOD_HANDLE_ITEM, and TYPE_DEBUG_INFO_ITEM is possibly identical to dx map type order

    // missing code and (fields | something else), likely small dex
    or (dex.map_list.map_item[6].type == 0x1001 and dex.map_list.map_item[7].type == 0x2002 and dex.map_list.map_item[8].type == 0x2004 and dex.map_list.map_item[9].type == 0x2000 and dex.map_list.map_item[10].type == 0x1003)
}

private rule r8_marker : internal
{
  meta:
    description = "r8 hidden marker"

  strings:
    // Example: ~~D8{"compilation-mode":"
    // OR: ~~D8{"backend":"dex","compilation-mode":"
    $marker = { 00 [1-2] 7E 7E ( 44 | 52 | 4C ) 38 7B 22 [0-16] 63 6F 6D 70 69 6C 61 74 69 6F 6E 2D 6D 6F 64 65 22 3A 22 }

  condition:
    /*
     * Marker logic from: https://r8.googlesource.com/r8/+/refs/heads/master/src/main/java/com/android/tools/r8/dex/Marker.java#18
     */
    $marker
}

private rule dexmerge_map_type_order : internal
{
  meta:
    description = "dexmerge map_list type order"

  condition:
    /*
     * DexMerge order derrived from: https://github.com/aosp-mirror/platform_dalvik/blob/2e9d6011fe4f4d2e8c065210d0118e7b9d9f305c/dx/src/com/android/dx/merge/DexMerger.java#L110
     */
    dex.map_list.map_item[7].type == 0x1000 // TYPE_MAP_LIST
}

rule jack_4_12 : compiler
{
  meta:
    description = "Jack 4.12"
    sample      = "b6a92aec55ab93f2254f12a2ab42f6c53a1b4ba1fbae62623193262e7dc31f26"

  strings:
    $jack_emitter = {00 12 65 6D 69 74 74 65 72 3A 20 6A 61 63 6B 2D 34 2E 31 32 00}

  condition:
    is_dex and $jack_emitter
}

rule jack_3x : compiler
{
  meta:
    description = "Jack 3.x"

  strings:
    //\0<len>emitter: jack-3.??\0
    $jack_emitter = {00 1? 65 6D 69 74 74 65 72 3A 20 6A 61 63 6B 2D 33 2E [1-3] 00}

  condition:
    is_dex and $jack_emitter
}

rule jack_4x : compiler
{
  meta:
    description = "Jack 4.x"

  strings:
    //\0<len>emitter: jack-4.??\0
    $jack_emitter = {00 1? 65 6D 69 74 74 65 72 3A 20 6A 61 63 6B 2D 34 2E [1-3] 00}

  condition:
    is_dex and not jack_4_12 and $jack_emitter
}

rule jack_5x : compiler
{
  meta:
    description = "Jack 5.x"

  strings:
    //\0<len>emitter: jack-5.??\0
    $jack_emitter = {00 1? 65 6D 69 74 74 65 72 3A 20 6A 61 63 6B 2D 35 2E [1-3] 00}

  condition:
    is_dex and $jack_emitter
}

private rule has_jack_anon_methods : internal
{
  meta:
    description = "has Jack compiler anonymous methods"
    url = "https://calebfenton.github.io/2016/12/01/building-with-and-detecting-jack/"

  strings:
    $anon_set = {00 05 2D 73 65 74 30 00} // -set0
    $anon_get = {00 05 2D 67 65 74 30 00} // -get0
    $anon_wrap = {00 06 2D 77 72 61 70 30 00} // -wrap0

  condition:
    2 of ($anon_*)
}

private rule jack_emitter : internal
{
  meta:
    description = "has Jack compiler emitter string"

  strings:
    // "\0<len>emitter: jack-?.?\0"
    $jack_emitter = {00 1? 65 6D 69 74 74 65 72 3A 20 6A 61 63 6B 2D ?? 2E [1-3] 00}

  condition:
    $jack_emitter or has_jack_anon_methods
}

private rule has_javac_anon_methods : internal
{
  meta:
    description = "has Javac compiler anonymous methods"
    url = "https://calebfenton.github.io/2016/12/01/building-with-and-detecting-jack/"

  strings:
    $anon_set = {00 0A 61 63 63 65 73 73 24 30 30 32 00} // access$002
    $anon_get = {00 0A 61 63 63 65 73 73 24 30 30 30 00} // access$000
    $anon_wrap = {00 0A 61 63 63 65 73 73 24 31 30 30 00} // access$100

  condition:
    2 of ($anon_*)
}

rule jack_generic : compiler
{
  // New Android compiler: http://tools.android.com/tech-docs/jackandjill
  meta:
    description = "Jack (unknown version)"
    sample      = "aaa4aed09a3a014c6e045566b86708f964088a0f9c712f02191cdcf61ff06fe8"

  condition:
    is_dex
    and not jack_3x and not jack_4x and not jack_5x
    and not jack_4_12
    and (jack_emitter or has_jack_anon_methods)
}

rule dexlib1 : compiler
{
  meta:
    description = "dexlib 1.x"
    sample      = "cf7b06bd339ee68224420dfcaba84a88e51ae6cd07d504fc8b4f2db6c6889971"

  condition:
    unsorted_string_pool
}

rule dexlib2beta : compiler
{
  meta:
    description = "dexlib 2.x beta"
    sample      = "8fd8c1e2337a4d2ac8f8f64c13a4fb304589ecf165e41de27ebc656a7475a008"

  condition:
    not dexlib1
    and null_interfaces
}

rule dexlib2 : compiler
{
  meta:
    description = "dexlib 2.x"
    sample      = "c7c566b1b185c99e338a77865eaf2eed6dc9b2b97793e262208c0b7f38bbf947"

  condition:
    not dexlib1
    and dexlib2_map_type_order
    and not dexlib2beta
}

rule dx : compiler
{
  meta:
    description = "dx"
    sample      = "6ef06bcc9712ec2ef3b71c5c8454af3abdafa628406b4f5629815995470da878"

  condition:
    dx_map_type_order
    and not dexlib1
    and not dexlib2
    and not dexlib2beta
    and not r8_marker
}

rule dx_merged : compiler
{
  meta:
    description = "dx (possible dexmerge)"
    sample      = "6c31ccd3b10ff2b0fa428e6efa954c37c0d2e641814f63c524c4f8fec9d11e22"

  condition:
    dexmerge_map_type_order
    and not dexlib1
    and not dexlib2
    and not dexlib2beta
    and not r8_marker
}

rule r8 : compiler
{
  meta:
    description = "r8"
    sample      = "e45ea01eedfc7bede77669412cce07b7d41b284bc6ffc9dfa27a519270bbe99a"
    sample2     = "bae4c7c1974fa317ecc8fbbcf7bafa3b1a0d5903fdd3040412c628277cf45258"

  condition:
    r8_marker
    and (r8_map_type_order or ambiguous_tiny_dex_map_type_order)
}

rule r8_merged : compiler
{
  meta:
    description = "r8 (possible dexmerge)"
    sample      = "ee1e901bb862835b227f7e9cfbaaa357402992ee9760b630a05f9b3423520526"

  condition:
    r8_marker
    and dexmerge_map_type_order
}

rule r8_no_marker : compiler
{
  meta:
    // Hiding the marker is easier than hiding the map type order.
    description = "r8 without marker (suspicious)"
    sample      = "f399d833ff54a798d609279bb8a51222c75be9b7fb7b3ab9cc8cb628f7d76257"
    sample2     = "d8a5545eb3c76d8078d778eb5962398d9f2fefab34f971b19beda35e0e76f6ef"

  condition:
    not r8_marker
    and r8_map_type_order
}

rule dexmerge : manipulator
{
  meta:
    description = "dexmerge"
    sample      = "6c31ccd3b10ff2b0fa428e6efa954c37c0d2e641814f63c524c4f8fec9d11e22"

  condition:
    dexmerge_map_type_order
}

rule unknown_compiler : compiler {
  meta:
    description = "unknown (please file detection issue!)"

  condition:
    is_dex
    and not (
      (dexlib1 or dexlib2 or dexlib2beta)
      or (dx or dx_merged)
      or (r8 or r8_merged or r8_no_marker)
      or (jack_generic or jack_3x or jack_4x or jack_4_12 or jack_5x)
      or (dexmerge)
    )
}

```

`apkid/rules/dex/obfuscators.yara`:

```yara
/*
 * Copyright (C) 2023  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

import "dex"
include "common.yara"

private rule short_unicode_field_names : internal
{
  meta:
    description = "one or two character unicode field names"

  condition:
    is_dex and
    for 3 i in (0..dex.header.field_ids_size) : (dex.field[i].name matches /[^\x00-\x7F]{1,4}/)
}

private rule short_unicode_method_names : internal
{
  meta:
    description = "one or two character unicode method names"

  condition:
    is_dex and
    for 3 i in (0..dex.header.method_ids_size) : (dex.method[i].name matches /[^\x00-\x7F]{1,4}/)
}

rule dexguard_a : obfuscator
{
  meta:
    description = "DexGuard"
    url         = "https://www.guardsquare.com/en/products/dexguard"
    sample      = "74eb7cf3b81ff14add71ca884ef0cc9c7477b4193a74ca71b92f81212ff56101"

  strings:
    $opcodes = {
      00 06 00 01 00 03 00 00 00 00 00 00 00
      [20-65]
      0c 01
      12 12
      23 22 ?? ??
      1c 03 ?? ??
      12 04
      4d 03 02 04
      6e 3? ?? ?? 10 02
      0c 00
      62 01 ?? ??
      12 12
      23 22 ?? ??
      12 03
      4d 05 02 03
      6e 3? ?? ?? 10 02
      0c 00
      1f 00 ?? ??
      11 00
    }
    $a = "getClass"
    $b = "getDeclaredMethod"
    $c = "invoke"

  condition:
    is_dex and
    $opcodes and
    all of ($a, $b, $c) and
    uint32(dex.header.data_offset + dex.header.data_size - 4) == 0
}

rule dexguard_b : obfuscator
{
  meta:
    description = "DexGuard"
    url         = "https://www.guardsquare.com/en/products/dexguard"
    sample      = "41a9b44af8931d63812b4a23395b29279d2e055f357222dabed7153d4aee6299"

  strings:
    // Other obfuscators use aux and con (protected Windows file names), but not from Lo/
    $a_aux_class     = { 00 07 4C 6F 2F (41|61) (55|75) (58|78) 3B 00 }  // Lo/[Aa][Uu][Xx];
    $a_con_class     = { 00 07 4C 6F 2F (43|63) (4F|6F) (4E|6E) 3B 00 }  // Lo/[Cc][Oo][Nn];
    $a_if_class      = { 00 ?? 4C 6F 2F [1-4] 24 (49|69) (46|66) 3B 00 } // Lo/???$[iI][fF];
    // A single unicode code point may take 1 or more bytes depending on encoding.
    // Normally only see one code point worth, but not sure how many bytes it might be in some variants.
    // Also note the trailing null byte in the regex so this  is less of a naked string.
    $a_inner_unicode = /Lo\/([\u0000-\u007F]{1,4}|[^\u0000-\u007F]{1,4})\$[^\u0000-\u007F]{1,4};\x00/
    $b_o_three_class = { 00 07 4C 6F 2F ?? ?? ?? 3B 00 }  // Lo/???;

  condition:
    2 of ($a_*)
    or (#a_if_class >= 3 and (short_unicode_field_names or short_unicode_method_names))
    or (#b_o_three_class >= 3 and (short_unicode_field_names or short_unicode_method_names))
}

rule dexguard_c : obfuscator
{
  meta:
    description = "DexGuard"
    url         = "https://www.guardsquare.com/en/products/dexguard"
    sample      = "de67161a8bd7ebcaa26c9661efd811375b59260924eb0dfd9436d3a47a1c31fe"
    sample2     = "db11762886cc24bd4f938002f15f78680b512cf550d15c77b217fc5548b0c939"

  strings:
    $dexguard_pkg1 = "guardsquare/dexguard/runtime/"
    $dexguard_pkg2 = {
      001e4c64657867756172642f7574696c2f54616d7065724465746563746f723b00
    } // Ldexguard/util/TamperDetector;
    $dexguard_pkg3 = {
      00224c64657867756172642f7574696c2f4365727469666963617465436865636b65723b00
    } // Ldexguard/util/CertificateChecker;
    $dexguard_pkg4 = "com/guardsquare/dexguard/"

    // Most of some kind of runtime decryption method, signature = a(IIZI[I[[I[I)V
    $decrypt_method = {
      12 01                 // const/4 v1, 0x0
      39 ?? ?? ??           // if-nez ??, :????
      71 ?? ?? ?? ?? ??     // invoke-static {??}, ??
      01 10                 // move v0, v1
      35 ?? ?? ??           // if-ge ?, ?, :????
      44 ?? ?? ??           // aget ??, ??, ??
      B7 ??                 // xor-int/2addr (xor is fairly rare in legit code)
      71 ?? ?? ?? ?? ??     // invoke-static
      0A ??                 // move-result ??
      97 ?? ?? ??           // xor-int ??, ??, ??
      D8 00 00 01           // add-int/lit8 v0, v0, 0x1
      01 ??                 // move ?, ?
      28 F2                 // goto
      21 80                 // array-length
      D8 00 00 FE           // add-int/lit8 v0, v0, -0x2
      44 ?? ?? ??           // aget ??
      B7 ??                 // xor-int/2addr
      21 ??                 // invoke-static
      D8 ?? ?? ??           // add-int
      44 ?? ?? ??           // aget
      B7 ??                 // xor-int/2addr
    }

  condition:
    is_dex
    and any of them
}

rule dexguard_d : obfuscator
{
  meta:
    description = "DexGuard"
    url         = "https://www.guardsquare.com/en/products/dexguard"
    sample      = "423b09d2aec74b1624d5b5c63d24486efc873c9cce75ea9e2f2d699f40ca8f7c"

  strings:
    // Ldexguard/util/TamperDetection;
    $dexguard_class  = {00 1F 4C 64 65 78 67 75 61 72 64 2F 75 74 69 6C 2F 54 61 6D 70 65 72 44 65 74 65 63 74 69 6F 6E 3B 00}
    $a_aux_class     = { 00 05 4C (41|61) (55|75) (58|78) 3B 00 }  // L[Aa][Uu][Xx];
    $a_con_class     = { 00 05 4C (43|63) (4F|6F) (4E|6E) 3B 00 }  // L[Cc][Oo][Nn];
    $a_if_class      = { 00 ?? 4C [1-4] 24 (49|69) (46|66) 3B 00 } // L???$[iI][fF];
    $a_inner_unicode = /L([\u0000-\u007F]{1,4}|[^\u0000-\u007F]{1,4})\$[^\u0000-\u007F]{1,4};\x00/

  condition:
    3 of them
    or $dexguard_class
    or (#a_if_class >= 3 and (short_unicode_field_names or short_unicode_method_names))
}

rule dexprotector : obfuscator
{
  meta:
    description = "DexProtector"

  strings:
    $method = {
      07 00 02 00 00 00 02 00 00 00 00 00 3E 00 00 00
      12 01 13 00 0E 00 48 00 05 00 E0 00 00 10 01 12
      39 02 2A 00 12 32 D5 63 FF 00 48 03 05 03 D5 33
      FF 00 E1 04 06 08 D5 44 FF 00 48 04 05 04 D5 44
      FF 00 E0 04 04 08 B6 43 E1 04 06 10 D5 44 FF 00
      48 04 05 04 D5 44 FF 00 E0 04 04 10 B6 43 E1 04
      06 18 D5 44 FF 00 48 00 05 04 E0 00 00 18 B6 30
      0F 00 0D 02 39 01 FE FF 12 21 DD 02 06 7F 48 00
      05 02 E1 00 00 08 28 F5 0D 03 28 CB 0D 00 00 00
      20 00 ?? 00 37 00 00 00 02 00 ?? 00 02 01
    }
    $a = "getClass"
    $b = "getDeclaredMethod"
    $c = "invoke"

  condition:
    is_dex and
    $method and
    all of ($a, $b, $c)
}

rule bitwise_antiskid : obfuscator
{
  meta:
    description = "Bitwise AntiSkid"

  strings:
    $credits = "AntiSkid courtesy of Bitwise\x00"
    $array = "AntiSkid_Encrypted_Strings_Courtesy_of_Bitwise"
    $truth1 = "Don't be a script kiddy, go actually learn something. Stealing credit is pathetic, you didn't make this or even contribute to it and you know it."
    $truth2 = "Only skids can't get plaintext. Credits to Bitwise.\x00"

  condition:
    is_dex and
    any of them
}

rule arxan : obfuscator
{
  meta:
    description = "Arxan"
    url         = "https://www.arxan.com/products/application-protection-mobile/"
    sample      = "7bd1139b5f860d48e0c35a3f117f980564f45c177a6ef480588b5b5c8165f47e"
    author      = "Eduardo Novella"

  strings:
    // Obfuscated Lpackage/class/: "L([a-z]\1{5}\/[a-z]{6}\/".
    // AFAIK, Yara does not support backreferences at the moment, thus this is the combo:
    $pkg = /L(a{6}|b{6}|c{6}|d{6}|e{6}|f{6}|g{6}|h{6}|i{6}|j{6}|k{6}|l{6}|m{6}|n{6}|o{6}|p{6}|q{6}|r{6}|s{6}|t{6}|u{6}|v{6}|w{6}|x{6}|y{6}|z{6})\/[a-z]{6}/

    // Obfuscated methods are found to follow a pattern like:
    // 1 byte size + 1 byte ASCII + [7-26] non-ASCII bytes + 00 (null terminator)
    $m1 = { 10 62 (6? | 75) [14] 00 }
    $m2 = { (0b | 0d) 62 d0 [15] 00 }
    $m3 = { (0e | 10) 62 30 34 3? [15] 00 }
    $m4 = { (0b | 0d) 62 30 34 3? [13] 00 }
    $m5 = { (08 | 0b | 0d | 0e ) 62 [7-13] 00 }
    $m6 = { 0a 62 (30 34 3? | d? ?? ??) [11] 00 }
    $m7 = { (0d | 0b | 11) (62 d1 8? | 6? ?? ??) [14] 00 }

  condition:
    is_dex and
    $pkg and
    6 of ($m*)
}

rule arxan_multidex : obfuscator
{
  meta:
    description = "Arxan (multidex)"
    url         = "https://www.arxan.com/products/application-protection-mobile/"
    sample      = "9b2a978a937293d6cb93439e0f819b4e044a3fad80dde92dec9b67e419278b5d"
    author      = "Eduardo Novella"

  strings:
    // Obfuscated Lpackage/class/: "L([a-z]\1{5}\/[a-z]{6}\/".
    // AFAIK, Yara does not support backreferences at the moment, thus this is the combo:
    $pkg = /L(a{6}|b{6}|c{6}|d{6}|e{6}|f{6}|g{6}|h{6}|i{6}|j{6}|k{6}|l{6}|m{6}|n{6}|o{6}|p{6}|q{6}|r{6}|s{6}|t{6}|u{6}|v{6}|w{6}|x{6}|y{6}|z{6})\/[a-z]{6}/

    // Obfuscated methods are found to follow a pattern like:
    // 1 byte size + 1 byte ASCII + [7-26] non-ASCII bytes + 00 (null terminator)
    $m1 = { 10 62 (6? | 75) [14] 00 }
    $m2 = { (0b | 0d) 62 d0 [15] 00 }
    $m3 = { (0e | 10) 62 30 34 3? [15] 00 }
    $m4 = { (0b | 0d) 62 30 34 3? [13] 00 }
    $m5 = { (08 | 0b | 0d | 0e ) 62 [7-13] 00 }
    $m6 = { 0a 62 (30 34 3? | d? ?? ??) [11] 00 }
    $m7 = { (0d | 0b | 11) (62 d1 8? | 6? ?? ??) [14] 00 }

  condition:
    is_dex and
    $pkg and
    2 of ($m*) and
    not arxan
}

rule arxan_b : obfuscator
{
  meta:
    description = "Arxan"
    url         = "https://github.com/rednaga/APKiD/issues/160"
    sample      = "86ade15e885cf7927e5840dd2bf2782905fcd6843be77f898b51b64c2277f3de"
    author      = "Tim 'diff' Strazzere"

  strings:
    // Targeting this seemingly static byte sequence used inside the injected obfuscation:
    // move-result v0 (moving result from own deobfuscation, v2 and v3 are always consts)
    $deobf = {
      0A 0?
      DF 01 03 FF
      // and-int/2addr v1, v0
      B5 01
      // xor-int/lit8 v0, v0, -0x1
      DF 00 00 FF
      // and-int/2addr v0, v3
      B5 30
      // or-int/2addr v1, v0
      B6 01
      // int-to-short v7, v1
      8F 1?
    }

  condition:
    is_dex and
    $deobf
}

rule arxan_c : obfuscator
{
  meta:
    description = "Arxan"
    url         = "https://digital.ai/products/application-security/"
    sample      = "7bd1139b5f860d48e0c35a3f117f980564f45c177a6ef480588b5b5c8165f47e"
    author      = "Abhi"

  strings:
    // Example: .9Lcom/arxan/guardit4j/util/PackageNameEnumeratorException;.
    $pkg = { 00 ?? 4C 63 6F 6D 2F 61 72 78 61 6E 2F 67 75 61 72 64 69 74 } // .??Lcom/arxan/guardit

  condition:
    is_dex and
    $pkg and
    not (arxan or arxan_multidex or arxan_b)
}

rule allatori_demo : obfuscator
{
  meta:
    description = "Allatori demo"
    url         = "http://www.allatori.com/features.html"
    author      = "Eduardo Novella"
    sample      = "7f2f5aac9833f7bdccc0b9865f5cc2a9c94ee795a285ef2fa6ff83a34c91827f"
    sample2     = "8c9e6c7b8c516499dd2065cb435ef68089feb3d4053faf2cfcb2b759b051383c"

  strings:
    // null-prev-str + len + str + null
    $s = { 00 0D 41 4C 4C 41 54 4F 52 49 78 44 45 4D 4F 00 }  // ALLATORIxDEMO

  condition:
    is_dex and $s
}

rule aamo_str_enc : obfuscator
{
  meta:
    description = "AAMO"
    author      = "P0r0"
    url         = "https://github.com/necst/aamo"
    sample      = "c1ef860af0e168f924663630ed3b61920b474d0c8b10e2bde6bfd3769dbd31a8"
    sample2     = "eb0d4e1ba2e880749594eb8739e65aa21b6f7b43798f04b6681065b396c15a78"

  strings:
    $opcodes_nops = {
        22 ?? ?? ??                                 //new-instance v? Ljava/lang/String;
        ( 00 00 | 00 00 00 00 | 00 00 00 00 00 00 )
        12 ?2                                       //const/4 v2, 0x2 (the register and constant never change)
        ( 00 00 | 00 00 00 00 | 00 00 00 00 00 00 )
        1a ?? ?? ??                                 //const-string v?, _ref_to_string_
        ( 00 00 | 00 00 00 00 | 00 00 00 00 00 00 )
        71 ?? ?? ?? ?? ??                           //invoke-static {v?, v?}, Landroid/content/res/_RANDOM_CLASS_NAME.getStorageEncryption(ILjava/lang/String;)Ljavax/crypto/Cipher;
        0c 02                                       //move-result-object v2 (the register never changes)
        ( 00 00 | 00 00 00 00 | 00 00 00 00 00 00 )
        71 ?? ?? ?? ?? ??                           //invoke-static {v?, v?}, Landroid/content/res/_RANDOM_CLASS_NAME.decode(Ljava/lang/String;)[B
        0c 03                                       //move-result-object v3
        ( 00 00 | 00 00 00 00 | 00 00 00 00 00 00 )
        6e ?? ?? ?? ?? ??                           //invoke-virtual {v?, v?}, Ljavax/crypto/Cipher.doFinal([B)[B
        0c 02                                       //move-result-object v2
        ( 00 00 | 00 00 00 00 | 00 00 00 00 00 00 )
        1a ?? ?? ??                                 //const-string v?, _CONST_STR_
        ( 00 00 | 00 00 00 00 | 00 00 00 00 00 00 )
        70 ?? ?? ?? ?? ??                           //invoke-direct {v?, v?, v?}, Ljava/lang/String.<init>([BLjava/lang/String;)
        71 ?? ?? ?? ?? ??                           //invoke-static {v?, v?}, Landroid/content/res/_RANDOM_CLASS_NAME._RANDOM_METHOD_NAME_(Ljava/lang/String;)Ljava/lang/String;
        0c ??                                       //move-result-object v4
    }

    $opcodes = {
        22 ?? ?? ??         //new-instance v? Ljava/lang/String;
        12 ?2               //const/4 v2, 0x2 (the register and constant never change)
        1a ?? ?? ??         //const-string v?, _ref_to_string_
        71 ?? ?? ?? ?? ??   //invoke-static {v?, v?}, Landroid/content/res/_RANDOM_CLASS_NAME.getStorageEncryption(ILjava/lang/String;)Ljavax/crypto/Cipher;
        0c 02               //move-result-object v2 (the register never changes)
        71 ?? ?? ?? ?? ??   //invoke-static {v?, v?}, Landroid/content/res/_RANDOM_CLASS_NAME.decode(Ljava/lang/String;)[B
        0c 03               //move-result-object v3
        6e ?? ?? ?? ?? ??   //invoke-virtual {v?, v?}, Ljavax/crypto/Cipher.doFinal([B)[B
        0c 02               //move-result-object v2
        1a ?? ?? ??         //const-string v?, _CONST_STR_
        70 ?? ?? ?? ?? ??   //invoke-direct {v?, v?, v?}, Ljava/lang/String.<init>([BLjava/lang/String;)
        71 ?? ?? ?? ?? ??   //invoke-static {v?, v?}, Landroid/content/res/_RANDOM_CLASS_NAME._RANDOM_METHOD_NAME_(Ljava/lang/String;)Ljava/lang/String;
        0c ??               //move-result-object v4
    }

    $a = { 00 0f 63 6f 6e 76 65 72 74 54 6f 53 74 72 69 6e 67 00 } // convertToString
    $b = { 00 14 67 65 74 53 74 6f 72 61 67 65 45 6e 63 72 79 70 74 69 6f 6e 00 } //getStorageEncryption

  condition:
    is_dex and 1 of ($opcodes*) and all of ($a, $b)
}

rule appsuit_a : obfuscator
{
    meta:
        description = "AppSuit"
        url         = "http://www.stealien.com/appsuit.html"
        sample      = "b99bafbbd5288ac93647d22f1c5b1863c96f581ae7a19fdc0e84bff4c2141328"
        author      = "Eduardo Novella"

    strings:
        $a1 = { 00 0741707053756974 00 }                          // 00AppSuit00
        $a2 = { 00 0741505053554954 00 }                          // 00APPSUIT00
        $c1 = { 00 144c636f6d2f737465616c69656e2f636f6e73743b00 } // 00Lcom/stealien/const;00
        $c3 = { 00 084c615f6c6f636b3b00 }                         // 00La_lock;00
        $l1 = { 00 6c6962417070537569742e736f 00 }                // 00libAppSuit.so00
        $o  = { 000c 6368 6563 6b41 7070 5375 6974 00 }           // 00checkAppSuit00
        $p1 = { 00 08737465616c69656e 00 }                        // 00stealien00

    condition:
        is_dex and 2 of them
}

rule appsuit_b : obfuscator
{
    meta:
        description = "AppSuit"
        url         = "http://www.stealien.com/appsuit.html"
        sample      = "6055deceb83233cceefc89b2bce4e978fd417820c5f534b0df66415122f394ea"
        author      = "Eduardo Novella"

    strings:
        $c = { 00?? 4c636f6d2f737465616c69656e2f61707073756974 2f } // 00??Lcom/stealien/appsuit/

    condition:
        is_dex and all of them
}

rule gemalto_sdk : obfuscator
{
  meta:
    description = "Gemalto"
    url         = "https://www.gemalto.com/brochures-site/download-site/Documents/eba_ezio_on_mobile.pdf"
    author      = "Eduardo Novella"
    sample      = "294f95298189080a25b20ef28295d60ecde27ee12361f93ad2f024fdcb5bdb0b"

  strings:
    $p1 = "Lcom/gemalto/idp/mobile/"
    $p2 = "Lcom/gemalto/medl/"
    $p3 = "Lcom/gemalto/ezio/mobile/sdk/"

  condition:
    is_dex and any of them
}

rule kiwi_amazon : obfuscator
{
  meta:
    description = "Kiwi encrypter"
    sample      = "3e309548f90160e3a4dc6f67621c75d2b66cc3b580da7306ff3dc6d6c25bb8a1"
    author      = "Eduardo Novella"

  strings:
    $key   = { 00 19 4B6977695F5F56657273696F6E5F5F4F626675736361746F72 00 } // 00+len+"Kiwi__Version__Obfuscator"+00
    $class = { 00 19 4B69776956657273696F6E456E637279707465722E6A617661 00 } // 00+len+"KiwiVersionEncrypter.java"+00

  condition:
    is_dex and all of them
}

rule unreadable_field_names : obfuscator
{
  meta:
    description = "unreadable field names"
    sample      = "afd6da00440ec83d54aefea742f26ba045505ac520f074512207a7bb50aaf9c4"

  condition:
    short_unicode_field_names
    and (not dexguard_a and not dexguard_b and not dexguard_c and not dexguard_d)
}

rule unreadable_method_names : obfuscator
{
  meta:
    description = "unreadable method names"
    sample      = "afd6da00440ec83d54aefea742f26ba045505ac520f074512207a7bb50aaf9c4"

  condition:
    short_unicode_method_names
    and (not dexguard_a and not dexguard_b and not dexguard_c and not dexguard_d)
}

rule apkencryptor : obfuscator
{
  meta:
    description = "ApkEncryptor"
    url         = "https://github.com/FlyingYu-Z/ApkEncryptor"
    sample      = "26c25dacacd0b4fdd411d7459747021d66cb45e9d57f92743004d190af74acea"
    author      = "Eduardo Novella"

  strings:
    $p1 = "Lcn/beingyi/sub/utils/Native"
    $p2 = "Lcom/beingyi/encrypt/StringPool"
    $p3 = "Lcn/beingyi/sub/ui/JniAlert"

  condition:
    any of them and is_dex and unreadable_field_names and unreadable_method_names
}

rule blackobfuscator : obfuscator
{
  meta:
    description   = "BlackObfuscator"
    url           = "https://github.com/CodingGay/BlackObfuscator"
    sample        = "92ae23580c83642ad0e50f19979b9d2122f28d8b3a9d4b17539ce125ae8d93eb" // com.plus.currencyconverter
    sample2       = "1730a1244ed5b01bf14426ff464042976c79796d8b6361648f6ed98c30d77997" // com.abhi.myapplication with depth 1
    sample3       = "a01550f444063d7a96f48d7f276c88b9f0ac277fd8409586f370f189d347ad30" // com.abhi.myapplication with depth 2
    sample4       = "6f1e14a590b73848871d6f5331c395086b1334e7d04e0f78d4211476c5b966e0" // com.abhi.myapplication with depth 5
    author        = "Abhi"

  strings:
    /**
      protected void onCreate(Bundle bundle) {
        String str = "ۖۨ";
        while (true) {
            switch ((str.hashCode() ^ 9) ^ (-1279807116)) {
                    ....
            }
        }
    }
    */
    $opcodes = {
      1A 00 ?? ??                      // const-string v0, "random_weird_string"
      6E 10 ?? (AC | 00) 00 00         // invoke-virtual {v0}, Ljava/lang/String.hashCode()I
      0A ??                            // move-result v(\d)
      13 02 ?? ??                      // const/16 v(\d), 0x(\d+)
      (14 0? ?? ?? ?? ?? | B7 ??)      // const v(\d), 0x(\d+) or xor-int/2addr v(\d), v(\d)
      (B7 ?? | D7 ?? ?? ??)            // xor-int/2addr v(\d), v(\d) or xor-int/lit16 v(\d), v(\d), 0x(\d+)
    }
    /**
            switch (...) {
                case -2084167413:
                    ....
                case -2084167413:
                    ....
                case -2084167413:
                    ....
                ...
            }
    */
    $switch = {
      2C ?? ?? ?? ?? ??   // sparse-switch v(\d), 0x(\d+)
      28 ??               // goto 0x(\d+)
      1A 00 ?? ??         // const-string v0, "random_weird_string"
      28 ??               // goto 0x(\d+)
      1A 00 ?? ??         // const-string v0, "random_weird_string"
      28 ??               // goto 0x(\d+)
    }

  condition:
    is_dex and (#opcodes >= 2 and #switch >= 2)
}

rule mtprotector_dex : obfuscator
{
  meta:
    description = "MT Protector"
    url         = "https://mt2.cn/download/"
    sample      = "7fd0657a9d7a3b8f44e9a8938669439db8ef90585259d24aad31b9cc1599a419"
    author      = "Eduardo Novella"

  strings:
    $classname = { 00 204c 6269 6e2f 6d74 2f61 6e6e 6f74 6174 696f 6e73 2f4d 5450 726f 7465 6374 6f72 3b00 } // Lbin/mt/annotations/MTProtector;

  condition:
    is_dex and any of them
}

rule stringfog : obfuscator
{
  meta:
    description = "StringFog"
    url         = "https://github.com/MegatronKing/StringFog"
    sample      = "1b89174083b22d97979537dc00dc91473243155d2d23654f40958577c4641185"
    author      = "Abhi"

  strings:
    $classname = { 00 2E 4C 63 6F 6D 2F 67 69 74 68 75 62 2F 6D 65 67
                   61 74 72 6F 6E 6B 69 6E 67 2F 73 74 72 69 6E 67 66
                   6F 67 2F 49 53 74 72 69 6E 67 46 6F 67 3B 00 } // Lcom/github/megatronking/stringfog/IStringFog;

  condition:
    is_dex and any of them
}



```

`apkid/rules/dex/packers.yara`:

```yara
/*
 * Copyright (C) 2023  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

include "common.yara"

rule pangxie_dex : packer
{
  meta:
    description = "PangXie"
    sample      = "ea70a5b3f7996e9bfea2d5d99693195fdb9ce86385b7116fd08be84032d43d2c"

  strings:
    // Lcom/merry/wapper/WapperApplication;
    $wrapper = {
      00 24 4C 63 6F 6D 2F 6D 65 72 72 79 2F 77 61 70
      70 65 72 2F 57 61 70 70 65 72 41 70 70 6C 69 63
      61 74 69 6F 6E 3B 00
    }

  condition:
    is_dex and
    $wrapper
}

rule medusah_dex : packer
{
  meta:
    description = "Medusah"
    sample      = "b92c0090038f3185908f2fb3b7e927da734040b9332332fc09542e20c615e083"

  strings:
    $wrapper = "Lcom/seworks/medusah"

  condition:
    is_dex and $wrapper
}

rule medusah_appsolid_dex : packer
{
  meta:
    description = "Medusah (AppSolid)"

  strings:
    $loader = "Lweb/apache/sax/app;"
    $main_activity = "Lweb/apache/sax/MainActivity;"

  condition:
    is_dex and $loader and $main_activity
}

rule apkguard_dex : packer
{
  meta:
    description = "APKGuard"
    url         = "http://apkguard.io/"
    sample      = "d9c98fff427646883ecb457fc2e9d2a8914ba7a9ee194735e0a18f56baa26cca"

  strings:
    $attachBaseContextOpcodes = {
        120b            // const/4 v11, #int 0 // #0
        6f20 0100 fe00  // invoke-super {v14, v15}, Landroid/app/Application;.attachBaseContext:(Landroid/content/Context;)V // method@0001
        2206 ??00       // new-instance v6, Ljava/io/File; // type@0006
        6e10 ??00 0e00  // invoke-virtual {v14}, Lyxlhycuqv/weudayy;.getFilesDir:()Ljava/io/File; // method@0019
        0c09            // move-result-object v9
        1a0a (2f|30) 00 // const-string v10, "lllllllllllllllllllllllllllllllllllllllll.zip" // string@002f
        7030 ??00 960a  // invoke-direct {v6, v9, v10}, Ljava/io/File;.<init>:(Ljava/io/File;Ljava/lang/String;)V // method@000a
        1a09 1900       //  const-string v9, BASE64_ENCODED_ZIP_FILE
        7120 ??00 b900  // invoke-static {v9, v11}, Landroid/util/Base64;.decode:(Ljava/lang/String;I)[B // method@0003
        0c02            // move-result-object v2
        2205 ??00       // new-instance v5, Ljava/io/FileOutputStream; // type@0007
        7020 ??00 6500  // invoke-direct {v5, v6}, Ljava/io/FileOutputStream;.<init>:(Ljava/io/File;)V // method@000c
        2201 ??00       // new-instance v1, Ljava/io/BufferedOutputStream; // type@0005
        7020 ??00 5100  // invoke-direct {v1, v5}, Ljava/io/BufferedOutputStream;.<init>:(Ljava/io/OutputStream;)V // method@0006
        6e20 ??00 2100  // invoke-virtual {v1, v2}, Ljava/io/BufferedOutputStream;.write:([B)V // method@0009
        6e10 ??00 0100  // invoke-virtual {v1}, Ljava/io/BufferedOutputStream;.flush:()V // method@0008
        6e10 ??00 0100  // invoke-virtual {v1}, Ljava/io/BufferedOutputStream;.close:()V // method@0007
        6e10 ??00 0600  // invoke-virtual {v6}, Ljava/io/File;.getAbsolutePath:()Ljava/lang/String; // method@000b
        0c03            // move-result-object v3
        6e10 ??00 0e00  // invoke-virtual {v14}, Lyxlhycuqv/weudayy;.getFilesDir:()Ljava/io/File; // method@0019
        0c09            // move-result-object v9
        6e10 ??00 0900  // invoke-virtual {v9}, Ljava/io/File;.getAbsolutePath:()Ljava/lang/String; // method@000b
        0c07            // move-result-object v7
        6e10 ??00 0e00  // invoke-virtual {v14}, Lyxlhycuqv/weudayy;.getClassLoader:()Ljava/lang/ClassLoader; // method@0018
        0c00            // move-result-object v0
        2204 ??00       //  new-instance v4, Ldalvik/system/DexClassLoader; // type@0004
        1209            // const/4 v9, #int 0 // #0
        7050 ??00 3497  // invoke-direct {v4, v3, v7, v9, v0}, Ldalvik/system/DexClassLoader;.<init>:(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;Ljava/lang/ClassLoader;)V // method@0004
        1a09 ??00       // const-string v9, "yabno/blkngwigpd" // string@003d
        6e20 ??00 9400  // invoke-virtual {v4, v9}, Ldalvik/system/DexClassLoader;.loadClass:(Ljava/lang/String;)Ljava/lang/Class; // method@0005
        0c09            // move-result-object v9
        120a            // const/4 v10, #int 0 // #0
        23aa ??00       // new-array v10, v10, [Ljava/lang/Class; // type@0016
        6e20 ??00 a900  // invoke-virtual {v9, v10}, Ljava/lang/Class;.getConstructor:([Ljava/lang/Class;)Ljava/lang/reflect/Constructor; // method@000d
        0c09            // move-result-object v9
        120a            // const/4 v10, #int 0 // #0
        23aa ??00       // new-array v10, v10, [Ljava/lang/Object; // type@0017
        6e20 ??00 a900  // invoke-virtual {v9, v10}, Ljava/lang/reflect/Constructor;.newInstance:([Ljava/lang/Object;)Ljava/lang/Object; // method@0013
        0c09            // move-result-object v9
        5be9 0000       // iput-object v9, v14, Lyxlhycuqv/weudayy;.aaa:Ljava/lang/Object; // field@0000
        54e9 0000       // iget-object v9, v14, Lyxlhycuqv/weudayy;.aaa:Ljava/lang/Object; // field@0000
        6e10 ??00 0900  // invoke-virtual {v9}, Ljava/lang/Object;.getClass:()Ljava/lang/Class; // method@0012
        0c09            // move-result-object v9
        1a0a ??00       // const-string v10, "attachBaseContext" // string@0022
        121b            // const/4 v11, #int 1 // #1
        23bb ??00       // new-array v11, v11, [Ljava/lang/Class; // type@0016
        120c            // const/4 v12, #int 0 // #0
        1c0d ??00       // const-class v13, Landroid/content/Context; // type@0002
        4d0d 0b0c       // aput-object v13, v11, v12
        6e30 ??00 a90b  // invoke-virtual {v9, v10, v11}, Ljava/lang/Class;.getDeclaredMethod:(Ljava/lang/String;[Ljava/lang/Class;)Ljava/lang/reflect/Method; // method@000e
        0c09            // move-result-object v9
        54ea 0000       // iget-object v10, v14, Lyxlhycuqv/weudayy;.aaa:Ljava/lang/Object; // field@0000
        121b            // const/4 v11, #int 1 // #1
        23bb ??00       // new-array v11, v11, [Ljava/lang/Object; // type@0017
        120c            // const/4 v12, #int 0 // #0
        4d0e 0b0c       // aput-object v14, v11, v12
        6e30 ??00 a90b  // invoke-virtual {v9, v10, v11}, Ljava/lang/reflect/Method;.invoke:(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object; // method@0015
        0e00            // return-void
        0d08            // move-exception v8
        6e10 ??00 0800  // invoke-virtual {v8}, Ljava/lang/Exception;.printStackTrace:()V // method@000f
        28fb            // goto 0073 // -0005
    }

  condition:
    is_dex and $attachBaseContextOpcodes
}

rule cryptoshell_dex : packer
{
  meta:
    description = "CryptoShell"
    url         = "http://cryptoshell.io"
    sample      = "d6745c1533b440c93f7bdfbb106470043b23aafdf91506c52332ed192d7b7003"

  strings:
    $attachBaseContextOpcodes = {
        120b            // const/4 v11, 0
        6f20 0100 fe00  // invoke-super {v14, v15}, Landroid/app/Application.attachBaseContext(Landroid/content/Context;)V ; 0x1
        2206 ??00       // new-instance v6, Ljava/io/File; ; 0x180
        6e10 ??00 0e00  // invoke-virtual {v14}, Llctavku/ngbdjdfqf.getFilesDir()Ljava/io/File; ; 0x19
        0c09            // move-result-object v9
        1a0a ??00       // const-string v10, str.mtuECIoALWpjXcVYbOOKBHNTMligrjLQpGFKT.zip ; 0x239c
        7030 ???? 960a  // invoke-direct {v6, v9, v10}, Ljava/io/File.<init>(Ljava/io/File;Ljava/lang/String;)V ; 0xa
        1a09 ??00       // const-string v9, str.UEsDBBQAAAAIAAMAi0tT_4a5ihQAAGArAAALABwAY2xhc3Nlcy5kZXhVVAkAA1Wg....
        7120 ??00 b900  // invoke-static {v9, v11}, Landroid/util/Base64;.decode:(Ljava/lang/String;I)[B // method@0003
        0c02            // move-result-object v2
        2205 ??00       // new-instance v5, Ljava/io/FileOutputStream; // type@0007
        7020 ??00 6500  // invoke-direct {v5, v6}, Ljava/io/FileOutputStream;.<init>:(Ljava/io/File;)V // method@000c
        2201 ??00       // new-instance v1, Ljava/io/BufferedOutputStream; // type@0005
        7020 ??00 5100  // invoke-direct {v1, v5}, Ljava/io/BufferedOutputStream;.<init>:(Ljava/io/OutputStream;)V // method@0006
        6e20 ??00 2100  // invoke-virtual {v1, v2}, Ljava/io/BufferedOutputStream;.write:([B)V // method@0009
        6e10 ??00 0100  // invoke-virtual {v1}, Ljava/io/BufferedOutputStream;.flush:()V // method@0008
        6e10 ??00 0100  // invoke-virtual {v1}, Ljava/io/BufferedOutputStream;.close:()V // method@0007
        6e10 ??00 0600  // invoke-virtual {v6}, Ljava/io/File;.getAbsolutePath:()Ljava/lang/String; // method@000b
        0c03            // move-result-object v3
        6e10 ??00 0e00  // invoke-virtual {v14}, Lyxlhycuqv/weudayy;.getFilesDir:()Ljava/io/File; // method@0019
        0c09            // move-result-object v9
        6e10 ??00 0900  // invoke-virtual {v9}, Ljava/io/File;.getAbsolutePath:()Ljava/lang/String; // method@000b
        0c07            // move-result-object v7
        6e10 ??00 0e00  // invoke-virtual {v14}, Lyxlhycuqv/weudayy;.getClassLoader:()Ljava/lang/ClassLoader; // method@0018
        0c00            // move-result-object v0
        2204 ??00       //  new-instance v4, Ldalvik/system/DexClassLoader; // type@0004
        1209            // const/4 v9, #int 0 // #0
        7050 ??00 3497  // invoke-direct {v4, v3, v7, v9, v0}, Ldalvik/system/DexClassLoader;.<init>:(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;Ljava/lang/ClassLoader;)V // method@0004
        1a09 ??00       // const-string v9, "yabno/blkngwigpd" // string@003d
        6e20 ??00 9400  // invoke-virtual {v4, v9}, Ldalvik/system/DexClassLoader;.loadClass:(Ljava/lang/String;)Ljava/lang/Class; // method@0005
        0c09            // move-result-object v9
        120a            // const/4 v10, #int 0 // #0
        23aa ??00       // new-array v10, v10, [Ljava/lang/Class; // type@0016
        6e20 ??00 a900  // invoke-virtual {v9, v10}, Ljava/lang/Class;.getConstructor:([Ljava/lang/Class;)Ljava/lang/reflect/Constructor; // method@000d
        0c09            // move-result-object v9
        120a            // const/4 v10, #int 0 // #0
        23aa ??00       // new-array v10, v10, [Ljava/lang/Object; // type@0017
        6e20 ??00 a900  // invoke-virtual {v9, v10}, Ljava/lang/reflect/Constructor;.newInstance:([Ljava/lang/Object;)Ljava/lang/Object; // method@0013
        0c09            // move-result-object v9
        5be9 0000       // iput-object v9, v14, Lyxlhycuqv/weudayy;.aaa:Ljava/lang/Object; // field@0000
        54e9 0000       // iget-object v9, v14, Lyxlhycuqv/weudayy;.aaa:Ljava/lang/Object; // field@0000
        6e10 ??00 0900  // invoke-virtual {v9}, Ljava/lang/Object;.getClass:()Ljava/lang/Class; // method@0012
        0c09            // move-result-object v9
        1a0a ??00       // const-string v10, "attachBaseContext" // string@0022
        121b            // const/4 v11, #int 1 // #1
        23bb ??00       // new-array v11, v11, [Ljava/lang/Class; // type@0016
        120c            // const/4 v12, #int 0 // #0
        1c0d ??00       // const-class v13, Landroid/content/Context; // type@0002
        4d0d 0b0c       // aput-object v13, v11, v12
        6e30 ??00 a90b  // invoke-virtual {v9, v10, v11}, Ljava/lang/Class;.getDeclaredMethod:(Ljava/lang/String;[Ljava/lang/Class;)Ljava/lang/reflect/Method; // method@000e
        0c09            // move-result-object v9
        54ea 0000       // iget-object v10, v14, Lyxlhycuqv/weudayy;.aaa:Ljava/lang/Object; // field@0000
        121b            // const/4 v11, #int 1 // #1
        23bb ??00       // new-array v11, v11, [Ljava/lang/Object; // type@0017
        120c            // const/4 v12, #int 0 // #0
        4d0e 0b0c       // aput-object v14, v11, v12
        6e30 ??00 a90b  // invoke-virtual {v9, v10, v11}, Ljava/lang/reflect/Method;.invoke:(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object; // method@0015
        0e00            // return-void
        0d08            // move-exception v8
        6e10 ??00 0800  // invoke-virtual {v8}, Ljava/lang/Exception;.printStackTrace:()V // method@000f
        28fb            // goto 0073 // -0005
    }

  condition:
    is_dex and
    $attachBaseContextOpcodes and
    not apkguard_dex
}


rule jar_pack01 : packer
{
  meta:
    // Official name unknown
    description = "jar_pack01"
    sample      = "faf1e85f878ea52a3b3fbb67126132b527f509586706f242f39b8c1fdb4a2065"

  strings:
    $pre_jar  = { 00 6F 6E 43 72 65 61 74 65 00 28 29 56 00 63 6F 6D 2F 76 } // .onCreate.()V.com/v
    $jar_data = { 2E 6A 61 72 00 2F 64 61 74 61 2F 64 61 74 61 2F 00 2F } // .jar./data/data
    $post_jar = { 2E 6A 61 72 00 77 00 6A 61 76 61 2F 75 74 69 6C 2F 4D 61 70 00 67 65 74 49 6E 74 00 } // .jar.w.java/util/Map.getInt.

  condition:
    is_dex and
    ($pre_jar and $jar_data and $post_jar)
}

rule gaoxor : packer
{
  meta:
    description = "GaoXor"
    url         = "https://github.com/rednaga/APKiD/issues/71"
    sample      = "673b3ab2e06f830e7ece1e3106a6a8c5f4bacd31393998fa73f6096b89f2df47"
    author      = "Eduardo Novella"

  strings:
    $str_0 = { 11 61 74 74 61 63 68 42 61 73 65 43 6F 6E 74 65 78 74 00 } // "attachBaseContext"
    $str_1 = { 04 2F 6C 69 62 00 } // "/lib"
    $str_2 = { 17 4C 6A 61 76 61 2F 6C 61 6E 67 2F 43 6C 61 73 73 4C 6F 61 64 65 72 3B 00 } // Ljava/lang/ClassLoader;
    $str_3 = { 77 72 69 74 65 64 44 65 78 46 69 6C 65 00 } // writedDexFile

    /**
      public void attachBaseContext(Context base) {
          super.attachBaseContext(base);
          try {
              getClass().getDeclaredMethod(GaoAoxCoJpRm("MS4zNiguNyIBJCQ9HAU="), new Class[0]).invoke(this, new Object[0]);
          } catch (Exception e) {
          }
      }
    */
    $attachBaseContextOpcodes = {
        // method.public.Lpykqdxlnyt_iytDlJSoOg.Lpykqdxlnyt_iytDlJSoOg.method.attachBaseContext_Landroid_content_Context__V:
        6f20??004300   // invoke-super {v3, v4}, Landroid/app/Application.attachBaseContext(Landroid/content/Context;)V
        6e10??000300   // invoke-virtual {v3}, Ljava/lang/Object.getClass()Ljava/lang/Class;
        0c00           // move-result-object v0
        1a01??00       // const-string v1, str.MS4zNiguNyIBJCQ9HAU ; 0xdfd
        6e20??001300   // invoke-virtual {v3, v1}, Lpykqdxlnyt/iytDlJSoOg.GaoAoxCoJpRm(Ljava/lang/String;)Ljava/lang/String;
        0c01           // move-result-object v1
        1202           // const/4 v2, 0               ; Protect.java:79
        2322??00       // new-array v2, v2, [Ljava/lang/Class; ; 0x3b8
        6e30??001002   // invoke-virtual {v0, v1, v2}, Ljava/lang/Class.getDeclaredMethod(Ljava/lang/String;[Ljava/lang/Class;)Ljava/lang/reflect/Method;
        0c00           // move-result-object v0
        1201           // const/4 v1, 0
        2311??00       // new-array v1, v1, [Ljava/lang/Object; ; 0x3bc
        6e30??003001   // invoke-virtual {v0, v3, v1}, Ljava/lang/reflect/Method.invoke(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;
        0e00           // return-void
        0d00           // move-exception v0
        28fe           // goto 0x00002984
    }

    /**
        private byte[] mMuKJXDuYr(byte[] a, byte[] key) {
            byte[] out = new byte[a.length];
            for (int i = 0; i < a.length; i++) {
                out[i] = (byte) (a[i] ^ key[i % key.length]);
            }
            return out;
        }
    */
    $xor_key = {
       21 ?2         //  array-length        v2, p1
       23 21 17 00   //  new-array           v1, v2, [B
       12 00         //  const/4             v0, 0
       21 ?2         //  array-length        v2, p1
       35 20 10 00   //  if-ge               v0, v2, :2A
       48 02 0? 00   //  aget-byte           v2, p1, v0
       21 ?3         //  array-length        v3, p2
       94 03 00 03   //  rem-int             v3, v0, v3
       48 03 0? 03   //  aget-byte           v3, p2, v3
       B7 32         //  xor-int/2addr       v2, v3
       8D 22         //  int-to-byte         v2, v2
       4F 02 01 00   //  aput-byte           v2, v1, v0
       D8 00 00 01   //  add-int/lit8        v0, v0, 1
       28 F0         //  goto                :8
       11 01         //  return-object       v1
    }

  condition:
    $attachBaseContextOpcodes and $xor_key and is_dex and 3 of ($str_*)
}

rule appsealing_loader_1_2_2 : packer
{
  meta:
    // Commercial packer
    description = "AppSealing Loader v1.2.2"
    url         = "https://www.appsealing.com/"
    sample      = "61a983b032aee2e56159e682ad1588ad30fa8c3957bf849d1afe6f10e1d9645d"
    author      = "zeroload"

  strings:
    $loader_ver = /AppSealingLoader [.]+ v1.2.2/
    $class = "Lcom/inka/appsealing/AppSealingApplication;"

  condition:
    is_dex and all of them
}

rule tencent : packer
{
  meta:
    description = "Mobile Tencent Protect"
    url         = "https://intl.cloud.tencent.com/product/mtp"
    sample      = "7c6024abc61b184ddcc9fa49f9fac1a7e5568d1eab09ee748f8c4987844a3f81"

  strings:
    $libshell_a = { 00 0C 6C 69 62 73 68 65 6C 6C 61 2E 73 6F 00 } // libshella.so
    $libshell_b = { 00 0C 6C 69 62 73 68 65 6C 6C 62 2E 73 6F 00 } // libshellb.so
    $libshell_c = { 00 0C 6C 69 62 73 68 65 6C 6C 63 2E 73 6F 00 } // libshellc.so
    // Lcom/tencent/StubShell/TxAppEntry;
    $class_app_entry = {
        00 22 4C 63 6F 6D 2F 74 65 6E 63 65 6E 74 2F 53 74 75 62 53 68 65
        6C 6C 2F 54 78 41 70 70 45 6E 74 72 79 3B 00
    }
    // Lcom/tencent/StubShell/a
    $class_stubshell = {
        00 19 4C 63 6F 6D 2F 74 65 6E 63 65 6E 74 2F 53 74 75 62 53 68 65
        6C 6C 2F 61 3B 00
    }

  condition:
    is_dex
    and 2 of ($libshell_*)
    or 1 of ($class_*)
}

rule crazy_dog_wrapper : packer
{
  meta:
    description = "Crazy Dog Wrapper"
    url         = "https://github.com/rednaga/APKiD/issues/31"
    sample      = "b1f0143c22a588aea89d3a9c0a53fa6d8cea07dd64dec1f82d905f5599acea94"

  strings:
    // libhdog-x86.so
    $lib1 = { 00 0E 6C 69 62 68 64 6F 67 2D 78 38 36 2E 73 6F 00 }
    // libhdog.so
    $lib2 = { 00 0A 6C 69 62 68 64 6F 67 2E 73 6F 00 }
    // Lcom/vdog/VDogApplication;
    $class1 = { 00 1A 4C 63 6F 6D 2F 76 64 6F 67 2F 56 44 6F 67 41 70 70 6C 69 63 61 74 69 6F 6E 3B 00 }
    // Lcom/vdog/VLibrary;
    $class2 = { 00 13 4C 63 6F 6D 2F 76 64 6F 67 2F 56 4C 69 62 72 61 72 79 3B 00 }
    // /.cache/libvdog.so
    $str1 = { 00 12 2F 2E 63 61 63 68 65 2F 6C 69 62 76 64 6F 67 2E 73 6F 00 }

  condition:
    is_dex
    and 2 of them
}

rule jsonpacker : packer
{
  meta:
    description = "JsonPacker"
    sample      = "e23f0a124fdaba30c07a3c40011dd99240af081cec4cdfcb990c811126867e59"
    author      = "Axelle Apvrille"

  strings:
    /* typical XOR algo with junk operations */
    $algo = {
      b0 9b               // add-int/2addr       v11, v9
      da 0? 0? 00         // mul-int/lit8        v12, v11, 0
      b3 9c               // div-int/2addr       v12, v9
      b0 1c               // add-int/2addr       v12, v1
      b0 5c               // add-int/2addr       v12, v5
      93 0? 0? 0?         // div-int             v5, v6, v6
      d8 0? 0? ff         // add-int/lit8        v5, v5, -1
      b0 5c               // add-int/2addr       v12, v5
      b4 66               // rem-int/2addr       v6, v6
      b0 6c               // add-int/2addr       v12, v6
      97 05 0c 0a         // xor-int             v5, v12, v10
    }
    $algo2 = {
      b0 ??                     // add-int/2addr       v4, v12
      da 0? 0? 00               // mul-int/lit8        v4, v4, 0
      b0 ??                     // add-int/2addr       v4, v9
      93 0? 0? 0?               // div-int             v9, v12, v12
      (b3 69 | db 04 04 01)     // div-int/2addr       v9, v6
                                // or:  div-int/lit8        v4, v4, 0x1
      (b7 69 | df 04 04 01)     // xor-int/2addr       v9, v6
                                // or: xor-int/lit8        v4, v4, 0x1
      b0 ??                     // add-int/2addr       v4, v9
      94 0? 0? 0?               // rem-int             v9, v12, v12
      b0 ??                     // add-int/2addr       v4, v9
      (b7 b4 | 97 04 07 09 )    // xor-int/2addr       v4, v11
                                // or: xor-int             v4, v7, v9
    }
    $algo3 = {
      b0 36
      dc 07 05 02         // add-int/2addr       v6, v3
      48 07 02 07         // rem-int/lit8        v7, v5, 0x2
      d8 08 06 e5         // aget-byte           v7, v2, v7
      d8 08 08 26         // add-int/lit8        v8, v6, -27
      91 03 08 03         // sub-int             v3, v8, v3
      b7 74               // xor-int/2addr       v4, v7
    }
    $dexclass = {
      6e 20 ?? ?? 10 00   // invoke-virtual      {v0, v1}, Ljava/lang/reflect/Constructor;->newInstance([Ljava/lang/Object;)Ljava/lang/Object;
      0c ??               // move-result-object  p1
      1f 0?               // check-cast          p1, Ldalvik/system/DexClassLoader;
    }

   condition:
     is_dex
     and ($algo or $algo2 or $algo3)
     and $dexclass
}

rule multidexpacker : packer
{
  meta:
    description = "MultidexPacker"
    sample      = "49d167f8f7427f0340297ae1c89ce4a216a8e64c55294f8e422f1f972732bae7"
    author      = "Axelle Apvrille"
    url         = "https://cryptax.medium.com/multidex-trick-to-unpack-android-bianlian-ed52eb791e56"

  strings:
    /* the strings for the implementation of MultiDex are de-obfuscated */
    $multidex_deobfuscation = {
      13 00 58 01         // const/16            v0, 344
      71 10 ?? ?? 00 00   // invoke-static       b->a(I)String, v0     # DECRYPTED_STRING: "multidex.version"
      0C 00               // move-result-object  v0
      69 00 ?? ??         // sput-object         v0, b->e:String
      13 00 67 01         // const/16            v0, 359
      71 10 ?? ?? 00 00   // invoke-static       b->a(I)String, v0     # DECRYPTED_STRING: "timestamp" (0x1)
      0C 00               // move-result-object  v0
      69 00 ?? ??         // sput-object         v0, b->f:String
      13 00 76 01         // const/16            v0, 374
      71 10 ?? ?? 00 00   // invoke-static       b->a(I)String, v0     # DECRYPTED_STRING: "crc" (0x1)
    }

    /* decrypting the DEX and writing it in classes.dex */
    $decrypt_dex = {
      70 20 ?? ?? 40 00   // invoke-direct       ZipEntry-><init>(String)V, v0, v4
      6E 10 ?? ?? 0? 00   // invoke-virtual      ZipEntry->getTime()J, p1
      0B 0?               // move-result-wide    v4
      6E 30 ?? ?? 40 05   // invoke-virtual      ZipEntry->setTime(J)V, v0, v4, v5
      6E 20 ?? ?? 03 00   // invoke-virtual      ZipOutputStream->putNextEntry(ZipEntry)V, v3, v0
      62 00 ?? ??         // sget-object         v0, b->decryption_key:String
      22 04 ?? ??         // new-instance        v4, InflaterInputStream
      70 20 ?? ?? 14 00   // invoke-direct       InflaterInputStream-><init>(InputStream)V, v4, v1
      22 05 ?? ??         // new-instance        v5, InflaterOutputStream
      70 20 ?? ?? 35 00   // invoke-direct       InflaterOutputStream-><init>(OutputStream)V, v5, v3
      71 30 ?? ?? 40 05   // invoke-static       k->decrypt(String, InputStream, OutputStream)V, v0, v4, v5
    }

  condition:
     is_dex
     and $multidex_deobfuscation
     and $decrypt_dex
}

rule appguard_dex : packer
{
  meta:
    description = "AppGuard"
    url         = "http://appguard.nprotect.com/en/index.html"
    sample      = "23cd2af10d46459065ea65b2d40fb706fd4847a1f8ef195cbebf1c6d8d54a48a"
    author      = "Eduardo Novella"

  strings:
    $class1 = { 00?? 4c63 6f6d 2f69 6e63 612f 7365 6375 7269 7479 2f
               (49|69) (49|69) (49|69) (49|69) (49|69) (49|69) (49|69)
               [0-10] 3b 00} // Lcom/inca/security/IIIiiiiIii;
    $class2 = { 00 254c 636f 6d2f 696e 6361 2f73 6563
                7572 6974 792f 5072 6f78 792f 4a4e 4953
                6f78 5072 6f78 793b 00} // .%Lcom/inca/security/Proxy/JNISoxProxy;.
    $class3 = { 00 2b4c 636f 6d2f 696e 6361 2f73 6563
                7572 6974 792f 5365 7276 6963 652f 4170
                7047 7561 7264 5365 7276 6963 653b 00} // .+Lcom/inca/security/Service/AppGuardService;.

  condition:
    is_dex and any of them
}

rule custom_multidex : packer
{
  meta:
    description = "Custom Multidex"
    sample1     = "b8f8948187846371eb32b2d7ef4f537c94997329e08d762b9ac6b3bfcbc86993"
    sample2     = "fdf5b6930d38da33ec117d7c0f83f142db1c33013d020f0ab4801d1fd781f552"
    author      = "ReBensk"

  strings:
    $cipher = {
      1a00 ????       // const-string v0, // string@00c9
      7110 ???? 0000  // invoke-static {v0}, Ljava/nio/charset/Charset;.forName:(Ljava/lang/String;)Ljava/nio/charset/Charset; // method@0067
      0c00            // move-result-object v0
      6900 ????       // sput-object v0, Lᵔˎʻᐧـˏ/יﹳﹶˆˆ/ˊﾞᵔٴʼי/ᴵˆᵔᵎˑʾ/ʼˈˏﾞˎˉ;.defaultCharset:Ljava/nio/charset/Charset; // field@0069
      1a00 ????       // const-string v0, "ﾞﹳﾞـⁱᐧʿـʿʿⁱᵎﹶʽʾﾞʽٴיᵎﹶʼʼʽˑˉᵎʼٴי// ˋᵎʼـʿʿʼˈʽᵔ" // string@01a2
      7110 ???? 0000  // invoke-static {v0}, Lᵔˎʻᐧـˏ/יﹳﹶˆˆ/ˊﾞᵔٴʼי/ᴵˆᵔᵎˑʾ/ʼˈˏﾞˎˉ;.encodePass:(Ljava/lang/String;)Ljava/lang/String; // method@0082
      0c00            // move-result-object v0
      6900 ????       // sput-object v0 Lᵔˎʻᐧـˏ/יﹳﹶˆˆ/ˊﾞᵔٴʼי/ᴵˆᵔᵎˑʾ/ʼˈˏﾞˎˉ;.globalPass:Ljava/lang/String; // field@006a
      0e00            // return-void
    }
    $cipher2 = {
      1201            // const/4 v1, #int 0 // #0 
      2203 ????       // new-instance v3, Ljavax/crypto/spec/SecretKeySpec; // type@006a
      6e10 ???? 0700  // invoke-virtual {v7}, Ljava/lang/String;.getBytes:()[B // method@004f
      0c04            // move-result-object v4
      1a05 ????       // const-string v5, "AES" // string@001e
      7030 ???? 4305  // invoke-direct {v3, v4, v5}, Ljavax/crypto/spec/SecretKeySpec;.<init>:([BLjava/lang/String;)V // method@0072
      1a04 ????       // const-string v4, "AES" // string@001e
      7110 ???? 0400  // invoke-static {v4}, Ljavax/crypto/Cipher;.getInstance:(Ljava/lang/String;)Ljavax/crypto/Cipher; // method@0070
      0c00            // move-result-object v0
      1224            // const/4 v4, #int 2 // #2
      6e30 ???? 4003  // invoke-virtual {v0, v4, v3}, Ljavax/crypto/Cipher;.init:(ILjava/security/Key;)V // method@0071
      6e20 ???? 6000  // invoke-virtual {v0, v6}, Ljavax/crypto/Cipher;.doFinal:([B)[B // method@006f
      0c01            // move-result-object v1
      1101            // return-object v1
      0d02            // move-exception v2
      6e10 ???? 0200  // invoke-virtual {v2}, Ljava/lang/Exception;.printStackTrace:()V // method@0043
      28fb            // goto 001a // -0005
    }
    $cipher3 = {
      7110 ???? 0100  // invoke-static {v1}, Lᵔˎʻᐧـˏ/יﹳﹶˆˆ/ˊﾞᵔٴʼי/ᴵˆᵔᵎˑʾ/ʼˈˏﾞˎˉ;.encodeToMD516:(Ljava/lang/String;)Ljava/lang/String; // method@0085
      0c00            // move-result-object v0 
      6e10 ???? 0000  // invoke-virtual {v0}, Ljava/lang/String;.toLowerCase:()Ljava/lang/String; // method@0056
      0c00            // move-result-object v0
      1100            // return-object v0
    }

  condition:
    is_dex and all of them
}

rule custom_flutter : packer 
{
  meta:
    description = "Custom Flutter"
    sample1     = "d91a793d7a63ca6279da81ea5986ba51663f0762399ce122d85b09a020521a0c"
    sample2     = "130f9d4c200f8c45df48e49360eb422710db8999f3dc571f10cfb04b139ed0d0"
    author      = "ReBensk"

  strings:
    $attachBaseContextOpcodes = {
      6f20 0100 ba00  // invoke-super {v10, v11}, Landroid/app/Application;.attachBaseContext:(Landroid/content/Context;)V // method@0001
      1a0b ????       // const-string v11, "AppasyOlsoNaMdq_XoCdqeMx" // string@0005
      7110 ???? 0b00  // invoke-static {v11}, Lcom/zzWrgZUeZn;.reewRNuvCn:(Ljava/lang/String;)Ljava/lang/String; // method@0012
      0c0b            // move-result-object v11
      1203            // const/4 v3, #int 0 // #0
      6e30 ???? ba03  // invoke-virtual {v10, v11, v3}, Lcom/zzWrgZUeZn;.getDir:(Ljava/lang/String;I)Ljava/io/File; // method@000e
      0c0b            // move-result-object v11
      1a04 ????       // const-string v4, "ipwaIyIlxoxajdm_VdNeDx" // string@00f3
      7110 ???? 0400  // invoke-static {v4}, Lcom/zzWrgZUeZn;.reewRNuvCn:(Ljava/lang/String;)Ljava/lang/String; // method@0012
      0c04            // move-result-object v4
      6e30 ???? 4a03  // invoke-virtual {v10, v4, v3}, Lcom/zzWrgZUeZn;.getDir:(Ljava/lang/String;I)Ljava/io/File; // method@000e
      0c04            // move-result-object v4
      6e10 ???? 0400  // invoke-virtual {v4}, Ljava/io/File;.listFiles:()[Ljava/io/File; // method@0020
      0c05            // move-result-object v5
      2155            // array-length v5, v5
      3905 0d00       // if-nez v5, 0030 // +000d
    }
    $cipher = {
      1a00 ????       // const-string v0, "WATEPSY/cEDCnBZ/jPdKNCNSL5GPjawdmdkiWnzg" // string@00b2 // AES/ECB/PKCS5Padding
      7110 ???? 0000  // invoke-static {v0}, Lcom/zzWrgZUeZn;.reewRNuvCn:(Ljava/lang/String;)Ljava/lang/String; // method@0012
      0c00            // move-result-object v0
      1a01 ????       // const-string v1, "3662583155221358" // string@0001
      1a02 ????       // const-string v2, "7243279461549821" // string@0002
      7140 ???? 2140  // invoke-static {v1, v2, v0, v4}, Lcom/zzWrgZUeZn;.DgQYvfuzRk:(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;[B)[B // method@0006
      0c04            // move-result-object v4
      1104            // return-object v4
    }

  condition:
    is_dex and all of them
}

rule jiagu_k : packer
{
  meta:
    description = "Jiagu K"
    sample1     = "aa666b75ffb3588dd41c8e546d53e353cda67cf278b167c7737b1169262856bb"
    sample2     = "d9baf66e7ac116a8c68599ef16fae5397ac4fd0847e2fcfe3ee2c155ecf4f850"
    author      = "ReBensk"

  strings:
    $classNameString = { 00 10 4C 76 69 72 62 6F 78 2F 53 74 75 62 41 70 70 3B 00 } // Lvirbox/StubApp;
   
  condition:
    is_dex and all of them and (dex.header.data_size + dex.header.data_offset) < dex.header.file_size
}

rule nesun_dex : packer
{
  meta:
    description = "Nesun"
    url         = "http://nesun.cn"
    sample      = "13735b73994231e25393a1847e1111c9741cc112315b3f0d4f775a62ab58ae5d"
    author      = "Abhi"

  strings:
    $versionString = { 00 08 7a 56 65 72 73 69 6f 6e 00 } // ..zVersion.
    $libString = { 00 08 7A 70 72 6F 74 65 63 74 00 } // ..zprotect.
    $class = { 00 14 4c 63 6f 6d 2f 6e 65 73 75 6e 2f 73 74 75 62 2f 5a 41 50 3b 00 } // Lcom/nesun/stub/ZAP;
   
  condition:
    is_dex and all of them
}

rule gpresto_dex : packer
{
  meta:
    description = "G-Presto (anti-cheat)"
    url         = "https://www.largosoft.co.kr/"
    sample      = "44558c6c758b1ecf42ecda9981240d50c32f42e0d2be4693e37e39f8eb3a3488"
    author      = "Abhi"
  
  strings:
    $class = { 00 22 4C 63 6F 6D 2F 62 69 73 68 6F 70 73 6F 66 74 2F 50 72 65 73 74 6F 2F 53 44 4B 2F 50 72 65 73 74 6F 3B 00 } // ."Lcom/bishopsoft/Presto/SDK/Presto;.

    // code segment of the injected methods plus junk opcodes
    $code_segment = {
	  02 00 01 00 00 00 00 00 ?? ?? ?? ?? 11 00 00 00 00 (1? | 2? | 3? | 4? | 5? | 6? | 7? | 8? | 9? | a? | b? | c0 | c1 | c2 | c3 | c4 | c5 | c6 | c7)
    }
  
  condition:
    is_dex and all of them
}

rule dingxiang_dex : packer
{
  meta:
    description = "DingXiang"
    url         = "https://www.dingxiang-inc.com/business/android"
    sample      = "788ebabd9b5464c5e86b3832e4a7b6e7c91cce5603ff17f214429400ba3bb2b9" // net.crigh.cgsport
    author      = "Abhi"

  strings:
    $class  = { 00 50 4C [32] 2F 63 6F 6D 2F 64 69
                6E 67 78 69 61 6E 67 2F 6D 6F 62 69
                6C 65 2F 72 65 73 65 6E 2F 53 74 72
                69 6E 67 45 6E 63 72 79 70 74 55 74
                69 6C 73 3B 00 } // L[32]/com/dingxiang/mobile/resen/StringEncryptUtils;
    $class2 = { 00 1E 4C 63 6F 6D 2F 73 65 63 75 72
                69 74 79 2F 69 6E 6E 65 72 2F 73 74
                75 62 30 30 30 2F [1] 3B 00 } // Lcom/security/inner/stub000/x;
    $class3 = { 00 20 4C 70 6E 66 2F 74 68 69 73 2F
                6F 62 6A 65 63 74 2F 64 6F 65 73 2F
                6E 6F 74 2F 45 78 69 73 74 3B 00 } // Lcom/pnf/this/object/does/not/Exist;
    
    /* Older versions starts with hash + class name
    E.g.: L377f1c444f7bd22614205e1a99a24ee1/com/mobile/streng/BuildConfig; */
    $hash_code = { 00 40 4C [32] 2F 63 6F 6D 2F 6D 6F 62 69 6C 65 2F 73 74
                   72 65 6E 63 2F 42 75 69 6C 64 43 6F 6E 66 69 67 3B 00 }

    /* Newer Versions check for hash directly
    E.g.: String trim = ("5404f0525edfb68c1abc06e6f6d468f3" == 0 ? "" : "5404f0525edfb68c1abc06e6f6d468f3").trim(); */
    $hash_code2 = { 
      71 00 ?? 01 00 00 // invoke-static {}, Lpnf/this/object/does/not/Exist;->started()V
      63 00 4? 00       // sget-boolean v0, Lpnf/this/object/does/not/Exist;->enabled:Z
      67 00 4? 00       // sput v0, Lpnf/this/object/does/not/Exist;->started:I
      1A 00 ?? ??       // const-string v0, "hash"
      39 00 ?? ??       // if-nez v0, :cond_x
      1A 00 ?? ??       // const-string v0, ""
      6E 10 ?? ?? 00 00 // invoke-virtual {v0}, Ljava/lang/String;->trim()Ljava/lang/String;
      0C 00             // move-result-object v0
    }

    /* File file2 = new File(file, String.format("libdsn_hold_%s.jar", "56cc9cd75dfe4dff177b9b4de6908cba".trim())); */
    $hash_code3 = {
      22 ?? 40 00       // new-instance v1, Ljava/io/File;
      1A 00 ?? ??       // const-string v0, "hash"
      6E 10 ?? ?? 00 00 // invoke-virtual {v0}, Ljava/lang/String;->trim()Ljava/lang/String;
      0C 00             // move-result-object v0
      23 ?? 7A 00       // new-array v2, v10, [Ljava/lang/Object;
      4D 00 ?? ??       // aput-object v0, v2, v9
      1A 00 ?? ??       // const-string v0, "libdsn_hold_%s.jar" | "libdsn_%s.jar"
      71 ?? 0F ?? ?? ?? // invoke-static {v0, v2}, Ljava/lang/String.format(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
      0C 00             // move-result-object v0
    }

    $string  = { 00 04 64 73 6E 30 00 } // dsn0
    $string2 = { 00 07 73 74 75 62 30 30 30 00 } // stub000
    $string3 = { 00 0D 6C 69 62 73 74 75 62 30 30 30 2E 73 6F 00 } // libstub000.so
    $string4 = { 00 0F 63 6F 64 65 5F 63 61 63 68 65 2F 64 73 6E 30 00 } // code_cache/dsn0

  condition:
    is_dex
    and any of ($hash_code*)
    and any of ($string*)
    or 2 of ($class*)
}

rule kiwisec_dex : packer
{
  meta:
    description = "KiwiSec"
    url         = "https://en.kiwisec.com/"
    sample      = "d108652bd1b685765e3ada2b7376e3c3ff67f8162afcf8bad91e0aef79b7b08a"
    author      = "Abhi"
  
  strings:
    $class  = { 00 1E 4C 63 6F 6D 2F 6B 69 77 69 73 65 63
                2F 63 72 61 73 68 2F 43 72 61 73 68 55 74
                69 6C 73 3B 00 } // Lcom/kiwisec/crash/CrashUtils;
    $class2 = { 00 25 4C 63 6F 6D 2F 6B 69 77 69 76 6D 2F
                73 65 63 75 72 69 74 79 2F 53 74 75 62 41
                70 70 6C 69 63 61 74 69 6F 6E 3B 00 } // Lcom/kiwivm/security/StubApplication;
  
  condition:
    is_dex and any of them
}

rule manxi_sec : packer
{
  meta:
    description = "Manxi Security"
    url         = "https://www.manxi-inc.com/en/"
    sample      = "9803121e89d5609215dc736b11cf5cf0a7d56ddfe5ac9ab71eb2b2883f427ac2" // cn.dict.android.pro (6.1.37)
    author      = "Abhi"

  strings:
    $class  = { 00 18 4C 63 6F 6D 2F 6D 61 6E 78 69 2F 73
                68 65 6C 6C 2F 48 65 6C 70 65 72 3B 00 } // Lcom/manxi/shell/Helper;
    $class2 = { 00 1F 4C 63 6F 6D 2F 6D 61 6E 78 69 2F 73
                68 65 6C 6C 2F 4D 58 41 70 70 6C 69 63 61
                74 69 6F 6E 3B 00 } // Lcom/manxi/shell/MXApplication;

  condition:
    is_dex and any of them
}

```

`apkid/rules/dex/protectors.yara`:

```yara
/*
 * Copyright (C) 2023  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

include "common.yara"

rule CNProtect_dex : protector
{
  // https://github.com/rednaga/APKiD/issues/52
  meta:
    description = "CNProtect (anti-disassemble)"
    sample = "5bf6887871ce5f00348b1ec6886f9dd10b5f3f5b85d3d628cf21116548a3b37d"

  strings:
    // code segment of the injected methods plus junk opcodes
    $code_segment = {
	  02 00 01 00 00 00 00 00 ?? ?? ?? ?? 11 00 00 00 00 (1? | 2? | 3? | 4? | 5? | 6? | 7? | 8? | 9? | a? | b? | c0 | c1 | c2 | c3 | c4 | c5 | c6 | c7)
    }

  condition:
    is_dex and
    $code_segment
}

rule whitecryption_dex : protector
{
  // https://github.com/rednaga/APKiD/issues/177
  meta:
    description = "WhiteCryption"
    sample      = "6821bce73b3d1146ef7ec9a2d91742a7f6fc2f8206ca9354d3d553e1b5d551a7"
    url         = "https://www.intertrust.com/products/application-shielding/"
    author      = "Tim 'diff' Strazzere"

  strings:
    // Loader class which doesnt appear to get obfuscated in these versions, plus
    // the surrounding null bytes and sizing used for the dex string table
    // Lcom/whitecryption/jcp/generated/scp;
    $loader = {
      00 25 4C 63 6F 6D 2F 77 68 69 74 65 63 72 79 70
      74 69 6F 6E 2F 6A 63 70 2F 67 65 6E 65 72 61 74
      65 64 2F 73 63 70 3B 00
    }
    // __scpClassInit with surrounding size and null bytes
    $init_stub = { 00 0E 5F 5F 73 63 70 43 6C 61 73 73 49 6E 69 74 00 }

  condition:
    is_dex and ($loader or $init_stub)
}

rule whitecryption_dex_a : protector
{
  meta:
    description = "WhiteCryption"
    url         = "https://www.intertrust.com/products/application-shielding/"
    sample      = "6ca8315fdb3fc2af989dd49806102bc3720b214f2053297b9f1041ab4f2f81b2"
    author      = "Eduardo Novella"

  strings:
    $s1 = "http://www.whitecryption.com"
    $s2 = /\(c\) 20\d{2} whiteCryption/
    $s3 = "http://www.cryptanium.com"
    $s4 = "CryptaniumHighSpeedAes"
    $s5 = "Lcom/cryptanium/skb/"
    $s6 = "SecureKeyBoxJava"

  condition:
    is_dex and 3 of ($s*)
}

rule appdome_dex : protector
{
  // https://github.com/rednaga/APKiD/issues/151
  meta:
    description = "Appdome"
    sample      = "1c6496f1cc8c5799539ee24170c371e8a57547e2eb73c9502c98ff78f44c74cf"
    url         = "https://www.appdome.com/"
    author      = "Tim 'diff' Strazzere"

  strings:
    // Loader class injected into everything, surrounding null bytes and size
    // Lruntime/loading/InjectedActivity;
    $loader = {
      00 22 4C 72 75 6E 74 69 6D 65 2F 6C 6F 61 64 69
      6E 67 2F 49 6E 6A 65 63 74 65 64 41 63 74 69 76
      69 74 79 3B 00
    }

  condition:
    is_dex and $loader
}

rule insidesecure : protector
{
  meta:
    description = "InsideSecure Verimatrix"
    url         = "https://www.verimatrix.com/products/app-shield/"
    sample      = "edb939d77adba5ef5c536c352a4bc25a3a5ff2fe15408c5af9f08b5af583224c" // dk.mitid.app.android v2.3.7
    author      = "Eduardo Novella"

  strings:
    // Loader class injected into everything, surrounding null bytes and size
    // 00 + size + Lcom/insidesecure/core/
    $class = {
      00 ?? 4c 636f 6d2f 696e 7369 6465 7365  6375 7265 2f 63 6f72 652f
    }

  condition:
    is_dex and all of them
}

rule free_rasp_dex : protector
{
  meta:
    description = "FreeRASP"
    sample      = "e10b8772fd9b6aaf8ba030c5bcb324fb9b91f34e893a62bdf238629df856e047"
    url         = "https://www.talsec.app/freerasp-in-app-protection-security-talsec"
    author      = "Fare9"

  strings:
    // Decryption method found in DEX files, since strings will change
    // and other offsets change, we add ?? to some instructions
    $decryption = {
      6e 10 ?? ?? 08 00           // invoke-virtual {v8}, Ljava/lang/String.length()I
      0a 00                       // move-result v0
      db 00 00 02                 // div-int/lit8 v0, v0, 0x2
      23 01 ?? ??                 // new-array v1, v0, [B
      12 02                       // const/4 v2, 0
      12 03                       // const/4 v3, 0
      12 04                       // const/4 v4, 0
      6e 10 ?? ?? 08 00           // invoke-virtual {v8}, Ljava/lang/String.length()I
      0a 05                       // move-result v5
      35 53 28 00                 // if-ge v3, v5, 0x0016c83a
      d8 05 03 01                 // add-int/lit8 v5, v3, 0x1
      6e 20 ?? ?? 38 00           // invoke-virtual {v8, v3}, Ljava/lang/String.charAt(I)C
      0a 03                       // move-result v3
      13 06 10 00                 // const/16 v6, 0x10
      71 20 ?? ?? 63 00           // invoke-static {v3, v6}, Ljava/lang/Character.digit(CI)I
      0a 03                       // move-result v3
      e0 03 03 04                 // shl-int/lit8 v3, v3, 0x4
      8d 33                       // int-to-byte v3, v3
      4f 03 01 04                 // aput-byte v3, v1, v4
      48 03 01 04                 // aget-byte v3, v1, v4
      d8 07 05 01                 // add-int/lit8 v7, v5, 0x1
      6e 20 ?? ?? 58 00           // invoke-virtual {v8, v5}, Ljava/lang/String.charAt(I)C
      0a 05                       // move-result v5
      71 20 ?? ?? 65 00           // invoke-static {v5, v6}, Ljava/lang/Character.digit(CI)I
      0a 05                       // move-result v5
      8d 55                       // int-to-byte v5, v5
      b0 53                       // add-int/2addr v3, v5
      8d 33                       // int-to-byte v3, v3
      4f 03 01 04                 // aput-byte v3, v1, v4
      d8 04 04 01                 // add-int/lit8 v4, v4, 0x1
      01 73                       // move v3, v7
      28 d5                       // goto 0x0016c7e2
      23 08 ?? ??                 // new-array v8, v0, [B
      35 02 12 00                 // if-ge v2, v0, 0x0016c862
      48 03 01 02                 // aget-byte v3, v1, v2
      62 04 ?? ??                 // sget-object v4, Lx0/o;->a [B
      21 45                       // array-length v5, v4
      94 05 02 05                 // rem-int v5, v2, v5
      48 04 04 05                 // aget-byte v4, v4, v5
      b7 43                       // xor-int/2addr v3, v4
      8d 33                       // int-to-byte v3, v3
      4f 03 08 02                 // aput-byte v3, v8, v2
      d8 02 02 01                 // add-int/lit8 v2, v2, 0x1
      28 ef                       // goto 0x0016c83e
      22 00 ?? ??                 // new-instance v0, Ljava/lang/String;
      70 20 ?? ?? 80 00           // invoke-direct {v0, v8}, Ljava/lang/String.<init>([B)V
      11 00                       // return-object v0
    }

  condition:
    is_dex and $decryption
}

rule appiron : protector
{
    meta:
        description = "Secucen AppIron"
        url         = "http://www.secucen.com/app/view/fintech/appIron"
        sample      = "d4f4a24ce6350bc4e23e2170da5b217dd65161aba5eca775d75514e9cdac4d59"
        author      = "dustty0 & Eduardo Novella"

    strings:
      $pkg1 = {
             0023 4c63 6f6d 2f62 6172 756e 2f61 //   .#Lcom/barun/a
        7070 6972 6f6e 2f61 6e64 726f 6964 2f41 // ppiron/android/A
        7070 4972 6f6e 3b00                     // ppIron;.
      }

      $pkg2 = {
                                  00 2d4c 636f  //            .-Lco
        6d2f 7365 6375 6365 6e2f 6170 7069 726f // m/secucen/appiro
        6e65 7870 7265 7373 2f41 7070 4972 6f6e // nexpress/AppIron
        4578 6365 7074 696f 6e3b 00             // Exception;.
      }

      $pkg3 = {
                                 002b 4c63 6f6d //            +Lcom
        2f73 6563 7563 656e 2f61 7070 6972 6f6e // /secucen/appiron
        6578 7072 6573 732f 4170 7049 726f 6e45 // express/AppIronE
        7870 7265 7373 3b00                     // xpress;.
      }

    condition:
      is_dex and any of them
}

rule ahope_appshield : protector
{
    meta:
        description = "Ahope AppShield"
        url         = "http://www.ahope.net/sub/app-shields"
        sample      = "42a4d907caf625ff73d5b6fbbf32b59ba14d6d5a72f28b81bdc76c47db516122"
        author      = "dustty0 & Eduardo Novella"

    strings:
      $pkg1 = {
                                00 234c 636f 6d2f //          .#Lcom/
          6168 6f70 652f 6170 705f 7368 6965 6c64 // ahope/app_shield
          732f 4275 696c 6443 6f6e 6669 673b 00   // s/BuildConfig;.H
      }

      $pkg2 = {
                                00 254c 636f 6d2f //          .%Lcom/
          6168 6f70 652f 6170 705f 7368 6965 6c64 // ahope/app_shield
          732f 5075 7265 4170 7043 6c69 656e 743b // s/PureAppClient;
          00
      }

    condition:
      is_dex and any of them
}

rule vguard : protector
{
  meta:
    description = "VGuard"
    url         = "https://www.vguard.co.kr"
    sample      = "7024bdadb53cbec86a39de845108b182ed2f7b3f0e7c0b876a948e1532ec5b9f"
    author      = "dustty0"

  strings:
    $pkg = {
      001b 4c6b 722f 636f 2f73 646b 2f76 6775 6172 6432 // ..Lkr/co/sdk/vguard2
      2f45 6465 784a 4e49 3b00                          // /EdexJNI;.
    }

  condition:
    is_dex and any of them
}

rule appdefence : protector
{
  meta:
    description = "ExTrus AppDefence"
    url         = "https://www.extrus.co.kr/eng/m/product_01_05.html"
    sample      = "e080380673479d2e182ad7eff5130bb72fe9a228c0a5de9852df23c4e98113b2"
    author      = "dustty0"

  strings:
    $pkg = {
           003e 4c6e 6574 2f65 7874 7275 732f 6578 6166 //   .>Lnet/extrus/exaf
      652f 6170 7064 6566 656e 6365 2f6d 6f64 756c 652f // e/appdefence/module/
      6170 7064 6566 656e 6365 2f44 6566 656e 6365 4170 // appdefence/DefenceAp
      6949 6d70 6c3b 00                                 // iImpl;.
    }

  condition:
    is_dex and all of them
}

rule xiaomi_xsof_sdk : protector
{
  meta:
    description = "Xiaomi Security Open Service Client SDK"
    url         = "https://dev.mi.com/distribute/doc/details?pId=1746"
    sample      = "3a01186dbb3cb550d4b6139c8d82e39e74f7b3cc74966a27232e91c164817fe1"
    author      = "aviraxp"

  strings:
    // .?com.xiaomi.security.xsof.?
    $s = {
      00 ?? 636f 6d2e 7869 616f 6d69 2e73 6563 7572 6974 792e 7873 6f66 2e [1-128] 00
    }

  condition:
    is_dex and #s > 1
}

rule dpt_shell : protector
{
  meta:
    description = "DPT Shell"
    url         = "https://github.com/luoyesiqiu/dpt-shell"
    sample      = "0c4341700f4e685cafc9c86c9112098b75057580ba1f7163bc971347af3712ad"
    author      = "Abhi"

  strings:
    $s1 = { 00 ?? 4C 63 6F 6D 2F 6C 75 6F 79 65 2F 64 70 74 } // .??Lcom/luoye/dpt
    $s2 = { 00 ?? 4C 63 6F 6D 2F 6C 75 6F 79 65 73 69 71 69 75 2F 73 68 65 6C 6C } // .??Lcom/luoyesiqiu/shell
    $s3 = { 00 08 64 70 74 2D 6C 69 62 73 00 } // dpt-libs
    $s4 = { 00 0D 64 70 74 5F 4A 6E 69 42 72 69 64 67 65 00 } // dpt_JniBridge
    $s5 = { 00 09 6C 69 62 64 70 74 2E 73 6F 00 } // libdpt.so

  condition:
    is_dex and any of them
}

rule ahnlab_v3_engine : anti_root
{
  meta:
    description = "Ahnlab V3 Engine"
    url         = "https://www.ahnlab.com/en"
    sample      = "638bad9c6336049f43ac88d7db65c743d9703d732f86f2dc094999b195d63aa2"
    author      = "whoa-mi"

  strings:
    $class = "Lcom/ahnlab/enginesdk/"
  condition:
    is_dex and #class > 10
}

rule nhn_appguard_dex : protector
{
  meta:
    description = "NHN AppGuard"
    url         = "https://www.nhncloud.com/kr/service/security/nhn-appguard"
    sample      = "bafa2a9acf4af696b92e0a1ddcf7f470d49a7f3bc27b5c1b1e3ecbdf17049285" // jp.pjfb
    author      = "Abhi"

  strings:
    $package = { 00 ?? 4C 63 6F 6D 2F 6E 68 6E (63 6C 6F 75 64 | 65 6E 74) 2F 61 70 70 67 75 61 72 64 2F } // .??Lcom/nhn(cloud|ent)/appguard/

  condition:
    is_dex and all of them
}

rule protectt_dex : protector
{
  meta:
    description = "Protectt"
    sample      = "c246d85560599f91e9c3ed7e59df2dd4e21aaf667f3f2965c28c43d9842f5e75" // com.rblbank.mobank
    url         = "https://www.protectt.ai"
    author      = "Abhi"

  strings:
    $class = { 00 1C 4C 61 69 2F 70 72 6F 74 65 63 74 74 2F 61 70 70 2F 73 65 63 75 72 69 74 79 2F 52 3B 00 } // ..Lai/protectt/app/security/R;.

  condition:
    is_dex and all of them
}

rule flutter_security_checker : protector
{
  meta:
    description = "Flutter Security Checker"
    url         = "https://pub.dev/packages/flutter_security_checker"
    sample      = "045d548cfd282d1aa8993efd22846ff49b0c48d99590cc36e3cf6c633dd85bcc" // com.swisssign.swissid.mobile
    author      = "Abhi"

  strings:
    $class = { 00 43 4C 63 6F 6D 2F 70 72 61 76 65 72 61 2F 66 6C 75 74 74 65 72 5F
               73 65 63 75 72 69 74 79 5F 63 68 65 63 6B 65 72 2F 46 6C 75 74 74 65
               72 53 65 63 75 72 69 74 79 43 68 65 63 6B 65 72 50 6C 75 67 69 6E 3B 00 } // Lcom/pravera/flutter_security_checker/FlutterSecurityCheckerPlugin;

  condition:
    is_dex and all of them
}

rule flutterjailbreakdetection : anti_root
{
  meta:
    description = "Flutter Jailbreak Detection (RootBeer)"
    url         = "https://pub.dev/packages/flutter_jailbreak_detection"
    sample      = "045d548cfd282d1aa8993efd22846ff49b0c48d99590cc36e3cf6c633dd85bcc" // com.swisssign.swissid.mobile
    author      = "Abhi"

  strings:
    $class = { 00 46 4C 61 70 70 6D 69 72 65 2F 62 65 2F 66 6C 75 74 74 65 72 6A 61 69
               6C 62 72 65 61 6B 64 65 74 65 63 74 69 6F 6E 2F 46 6C 75 74 74 65 72 4A
               61 69 6C 62 72 65 61 6B 44 65 74 65 63 74 69 6F 6E 50 6C 75 67 69 6E 3B 00 } // Lappmire/be/flutterjailbreakdetection/FlutterJailbreakDetectionPlugin;

  condition:
    is_dex and all of them
}

rule rootbeer : anti_root
{
  meta:
    description = "RootBeer"
    url         = "https://github.com/scottyab/rootbeer.git"
    sample      = "607ec962ba93cc9817129cb693ff0f335f500a297b5a297e71fbb998d0f6849c" // com.scottyab.rootbeer.sample
    author      = "Abhi"

  strings:
    $class = { 00 20 4C 63 6F 6D 2F 73 63 6F 74 74 79 61 62 2F 72
               6F 6F 74 62 65 65 72 2F 52 6F 6F 74 42 65 65 72 3B 00 } // Lcom/scottyab/rootbeer/RootBeer;

  condition:
    is_dex and all of them
}

rule build38 : protector
{
  meta:
    description = "Build38"
    url         = "https://build38.com"
    sample      = "cfbbfca598a9877a381583a7ae2f9e8cde92e7314b21152658bcba5a4e3a0fff" // com.esignus.hashwalletmanager
    author      = "Abhi, ApkUnpacker"

  strings:
    $class        = { 00 15 4C 63 6F 6D 2F 62 75 69 6C 64 33 38 2F 74 61 6B 2F 54 41 4B 3B 00 } // Lcom/build38/tak/TAK;
    $package_name = { 00 0F 63 6F 6D 2E 62 75 69 6C 64 33 38 2E 74 61 6B 00 } // com.build38.tak
    $module_class = { 00 0D 42 75 69 6C 64 33 38 4D 6F 64 75 6C 65 00 } // Build38Module
    $license_name = { 00 0B 6C 69 63 65 6E 73 65 2E 74 61 6B 00 } // license.tak

  condition:
    is_dex and any of them
}

rule shield_sdk : protector
{
  meta:
    description = "Shield SDK"
    url         = "https://shield.com/"
    sample      = "fb4b7f033658b3898e0448955491b448a2c78e1a2325c65fece6ad64f6f6b6d0" // com.mpl.androidapp
    author      = "Abhi"

  strings:
    $class  = { 00 1B 4C 63 6F 6D 2F 73 68 69 65 6C 64 2F 61 6E 64
                72 6F 69 64 2F 53 68 69 65 6C 64 3B 00 } // Lcom/shield/android/Shield;
    $class2 = { 00 29 4C 63 6F 6D 2F 73 68 69 65 6C 64 2F 61 6E 64
                72 6F 69 64 2F 69 6E 74 65 72 6E 61 6C 2F 4E 61 74
                69 76 65 55 74 69 6C 73 3B 00 } // Lcom/shield/android/internal/NativeUtils;
    $class3 = { 00 27 4C 63 6F 6D 2F 73 68 69 65 6C 64 2F 61 6E 64
                72 6F 69 64 2F 63 6F 6D 6D 6F 6E 2F 42 75 69 6C 64
                43 6F 6E 66 69 67 3B 00 } // Lcom/shield/android/common/BuildConfig;
    $class4 = { 00 28 4C 63 6F 6D 2F 73 68 69 65 6C 64 2F 61 6E 64
                72 6F 69 64 2F 63 6F 6D 6D 6F 6E 2F 53 68 69 65 6C
                64 4D 6F 64 75 6C 65 3B 00 } // Lcom/shield/android/common/ShieldModule;

  condition:
    is_dex and any of them
}

rule bugsmirror : protector
{
  meta:
    description = "BugsMirror"
    url         = "https://www.bugsmirror.com/"
    sample      = "c9bbf66ac86bf02663b7bc28a735881d4aeaa8d90e9b8b752e9cf337a26f0bdd"
    author      = "Abhi"

  strings:
    $tag      = { 00 12 42 75 67 73 6D 69 72 72 6F 72 44 65 66 65 6E
                  64 65 72 00 } // BugsMirrorDefender
    $pkg_name = { 00 16 63 6F 6D 2E 62 75 67 73 6D 69 72 72 6F 72 64
                  65 66 65 6E 64 65 72 00 } // com.bugsmirrordefender
    $service  = { 00 35 42 75 67 73 6D 69 72 72 6F 72 44 65 66 65 6E
                  64 65 72 53 65 72 76 69 63 65 73 2E 42 75 67 73 6D
                  69 72 72 6F 72 44 65 66 65 6E 64 65 72 53 65 72 76
                  69 63 65 73 00 } // BugsmirrorDefenderServices.BugsmirrorDefenderServices
    $filter   = { 00 19 63 6F 6D 2E 62 75 67 73 6D 69 72 72 6F 72 2E
                  6D 69 74 69 67 61 74 69 6F 6E 00 } // com.bugsmirror.mitigation
    $class    = { 00 22 4C 63 6F 6D 2F 62 75 67 73 6D 69 72 72 6F 72
                  2F 64 65 66 65 6E 64 65 72 2F 44 65 66 65 6E 64 65
                  72 3B 00 } // Lcom/bugsmirror/defender/Defender;
    $class2   = { 3B 00 1B 4C 63 6F 6D 2F 62 75 67 73 6D 69 72 72 6F
                  72 2F 64 65 66 65 6E 64 65 72 2F 52 3B 00 } // com/bugsmirror/defender/R;
    $class3   = { 00 24 4C 63 6F 6D 2F 62 75 67 73 6D 69 72 72 6F 72
                  64 65 66 65 6E 64 65 72 2F 42 75 69 6C 64 43 6F 6E
                  66 69 67 3B 00 } // Lcom/bugsmirrordefender/BuildConfig;
    $class4   = { 00 45 4C 63 6F 6D 2F 62 75 67 73 6D 69 72 72 6F 72
                  2F 64 65 66 65 6E 64 65 72 61 70 69 2F 67 65 6E 65
                  72 61 74 65 64 2F 42 75 67 73 6D 69 72 72 6F 72 44
                  65 66 65 6E 64 65 72 53 65 72 76 69 63 65 73 47 72
                  70 63 3B 00 } // Lcom/bugsmirror/defenderapi/generated/BugsmirrorDefenderServicesGrpc;

  condition:
   is_dex and any of them
}

rule bshield : protector
{
  meta:
    description = "BShield"
    url         = "https://bshield.io/"
    sample      = "f54fa5cfcd9a5d14a947bbd93bc7bb59e8c2b1b23cc5bcc84c66ad0143e55201"
    author      = "Abhi"

  strings:
    $dat = { 00 0B 42 53 48 49 45 4C 44 5F 44 41 54 00 } // BSHIELD_DAT

  condition:
    is_dex and all of them
}

rule alibaba_sec : protector
{
  meta:
    description = "Alibaba Security SDK"
    url         = "https://www.alibabacloud.com/zh/product/mpaas"
    sample      = "4590673ad6320d9a091d33e5b3b9b652479ddced573bde9c3ded8acba0451d53"
    author      = "Abhi"

  strings:
    $class = { 00 1D 4C 63 6F 6D 2F 61 6C 69 2F 6D 6F 62 69 73 65
               63 65 6E 68 61 6E 63 65 2F 49 6E 69 74 3B 00 } // Lcom/ali/mobisecenhance/Init;

  condition:
    is_dex and all of them
}

rule bureau : protector
{
  meta:
    description = "Bureau"
    url         = "https://bureau.id"
    sample      = "484d8d0f4eb2c2ed66770edfa0ab89bf76f9b84227faea3889ce74b2af8cbbc4"
    author      = "Abhi, ApkUnpacker"

  strings:
    $string = /api\.(stg\.)?bureau\.id/
    $class  = { 00 28 4C 63 6F 6D 2F 62 75 72 65 61 75 2F 64 65 76 69
                63 65 66 69 6E 67 65 72 70 72 69 6E 74 2F 42 75 72
                65 61 75 41 50 49 3B 00 } // Lcom/bureau/devicefingerprint/BureauAPI;
    $class2 = { 00 25 4C 63 6F 6D 2F 62 75 72 65 61 75 2F 62 61 73
                65 2F 6D 6F 64 65 6C 73 2F 42 75 72 65 61 75 43 6F
                6E 66 69 67 3B 00 } // Lcom/bureau/base/models/BureauConfig;
    $class3 = { 00 21 4C 63 6F 6D 2F 62 75 72 65 61 75 2F 63 68 65 63
                6B 52 6F 6F 74 2F 56 65 72 69 66 79 52 6F 6F 74 3B 00 } // Lcom/bureau/checkRoot/VerifyRoot;

  condition:
    is_dex and any of them
}

```

`apkid/rules/dll/common.yara`:

```yara
/*
 * Copyright (C) 2024  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

import "pe"

rule is_dll : file_type
{
  meta:
    description = "DLL"

  condition:
    pe.characteristics and pe.DLL
}


```

`apkid/rules/dll/obfuscators.yara`:

```yara
/*
 * Copyright (C) 2024  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

include "common.yara"

rule beebyte : obfuscator
{
  meta:
    description = "Beebyte"
    url         = "https://www.beebyte.co.uk/"
    sample      = "53fa7054f7112197cfe3ab8adc1afe825c6e6b4a696404f75f75eb894ae77456"
    author      = "Abhi"
  
  strings:
    $name = "\x00Beebyte.Obfuscator\x00"

  condition:
    is_dll and all of them
}

```

`apkid/rules/elf/anti-vm.yara`:

```yara
/*
 * Copyright (C) 2023  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

import "elf"
include "common.yara"

rule check_qemu_entropy : anti_vm
{
  meta:
    description = "Checks for QEMU entropy"
    url = "https://github.com/Fuzion24/AndroidHostileEnvironmentDetection/blob/master/app/jni/emudetect.c"

  strings:
    $a = "atomicallyIncreasingGlobalVarThread"
    $b = "_qemuFingerPrint"

  condition:
    is_elf and any of them
}

```

`apkid/rules/elf/common.yara`:

```yara
/*
 * Copyright (C) 2023  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

import "elf"

rule is_elf : file_type
{
  meta:
    description = "ELF"

  condition:
    elf.number_of_sections >= 0
}

rule is_dart : file_type
{
  meta:
    description = "Dart"

    strings:
        $s1   = "dart:core" ascii
        $s2   = "dart:async" ascii
        $s3   = "_kDartVmSnapshotData" ascii
        $s4   = "_kDartVmSnapshotInstructions" ascii
        $s5   = "flutter_assets" ascii
        $ksnl = { 4B 53 4E 4C } // "KSNL" in hex

  condition:
        is_elf and 2 of ($s*) or $ksnl
}
```

`apkid/rules/elf/obfuscators.yara`:

```yara
/*
 * Copyright (C) 2023  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/


import "elf"
include "common.yara"

rule ollvm_v3_4 : obfuscator
{
  meta:
    description = "Obfuscator-LLVM version 3.4"
    url         = "https://github.com/obfuscator-llvm/obfuscator/wiki"
    sample      = "cd16ad33bf203dbaa9add803a7a0740e3727e8e60c316d33206230ae5b985f25"
    author      = "Eduardo Novella"

  strings:
    // "Obfuscator-clang version 3.4 (tags/RELEASE_34/final) (based on LLVM 3.4svn)"
    $clang_version = "Obfuscator-clang version 3.4 "
    $based_on      = "(based on LLVM 3.4"

  condition:
    is_elf and all of them
}

rule ollvm_v3_5 : obfuscator
{
  meta:
    description = "Obfuscator-LLVM version 3.5"
    url         = "https://github.com/obfuscator-llvm/obfuscator/wiki"
    sample      = "664214969f1b94494a8fc0491407f4440032fc5c922eb0664293d0440c52dbe7"
    author      = "Eduardo Novella"

  strings:
    // "Obfuscator- clang version 3.5.0 (tags/RELEASE_350/final) (based on LLVM 3.5.0svn)"
    $clang_version = "Obfuscator- clang version 3.5.0 "
    $based_on      = "(based on LLVM 3.5"

  condition:
    is_elf and all of them
}

rule ollvm_v3_6_1 : obfuscator
{
  meta:
    description = "Obfuscator-LLVM version 3.6.1"
    url         = "https://github.com/obfuscator-llvm/obfuscator/wiki"
    sample      = "d84b45856b5c95f7a6e96ab0461648f22ad29d1c34a8e85588dad3d89f829208"
    author      = "Eduardo Novella"

  strings:
    // "Obfuscator-LLVM clang version 3.6.1 (tags/RELEASE_361/final) (based on Obfuscator-LLVM 3.6.1)"
    $clang_version = "Obfuscator-LLVM clang version 3.6.1 "
    $based_on      = "(based on Obfuscator-LLVM 3.6.1)"

  condition:
    is_elf and all of them
}

rule ollvm_v4_0 : obfuscator
{
  meta:
    description = "Obfuscator-LLVM version 4.0"
    url         = "https://github.com/obfuscator-llvm/obfuscator/wiki"
    sample      = "aaba570388d0fe25df45480ecf894625be7affefaba24695d8c1528b974c00df"
    author      = "Eduardo Novella"

  strings:
    // "Obfuscator-LLVM clang version 4.0.1  (based on Obfuscator-LLVM 4.0.1)"
    $clang_version = "Obfuscator-LLVM clang version 4.0.1 "
    $based_on      = "(based on Obfuscator-LLVM 4.0.1)"

  condition:
    is_elf and all of them
}

rule ollvm_v5_0_strenc : obfuscator
{
  meta:
    description = "Obfuscator-LLVM version 5.0 (string encryption)"
    url         = "https://github.com/obfuscator-llvm/obfuscator/wiki"
    sample      = "a794a080a92987ce5ed9cf5cd872ef87f9bfb9acd4c07653b615f4beaff3ace2"
    author      = "Eduardo Novella"

  strings:
    // "Obfuscator-LLVM clang version 5.0.2  (based on Obfuscator-LLVM 5.0.2)"
    $clang_version = "Obfuscator-LLVM clang version 5.0."
    $based_on      = "(based on Obfuscator-LLVM 5.0."
    $strenc        = /\.datadiv_decode[\d]{18,20}/  // Enumerating elf.symtab_entries fails!

  condition:
    is_elf and
    all of them
}

rule ollvm_v6_0_strenc : obfuscator
{
  meta:
    description = "Obfuscator-LLVM version 6.0 (string encryption)"
    url         = "https://github.com/obfuscator-llvm/obfuscator/wiki"
    sample      = "f3a2e6c57def9a8b4730965dd66ca0f243689153139758c44718b8c5ef9c1d17"
    author      = "Eduardo Novella"

  strings:
    // "Obfuscator-LLVM clang version 6.0.0 (trunk) (based on Obfuscator-LLVM 6.0.0)"
    // "Obfuscator-LLVM clang version 6.0.0 (trunk) (based on Obfuscator-LLVM 6.0.0git-b9ea5776)"
    $clang_version = "Obfuscator-LLVM clang version 6.0."
    $based_on      = "(based on Obfuscator-LLVM 6.0."

  condition:
    is_elf and
    all of them and
    for any i in (0..elf.symtab_entries): (elf.symtab[i].name matches /\.datadiv_decode[\d]{18,20}/)
}

rule ollvm_v6_0 : obfuscator
{
  meta:
    description = "Obfuscator-LLVM version 6.0"
    url         = "https://github.com/obfuscator-llvm/obfuscator/wiki"
    author      = "Eduardo Novella"

  strings:
    // "Obfuscator-LLVM clang version 6.0.0 (trunk) (based on Obfuscator-LLVM 6.0.0)"
    // "Obfuscator-LLVM clang version 6.0.0 (trunk) (based on Obfuscator-LLVM 6.0.0git-b9ea5776)"
    $clang_version = "Obfuscator-LLVM clang version 6.0."
    $based_on      = "(based on Obfuscator-LLVM 6.0."

  condition:
    is_elf and
    all of them and
    not ollvm_v6_0_strenc
}

rule ollvm_v8_strenc : obfuscator
{
  meta:
    description = "Obfuscator-LLVM version 8.x (string encryption)"
    url         = "https://github.com/obfuscator-llvm/obfuscator/wiki"
    url2        = "https://github.com/heroims/obfuscator"
    sample      = "2c720f5ec740f4c8571dbba205eadba483556c5c387fe88ff25192b25552da0f"
    author      = "Eduardo Novella"

  strings:
    /*
      [0x0000a5bc]> izzq~+obfuscator,ollvm,clang
      0x1 263 262 Android (4751641 based on r328903) clang version 7.0.2 (https://android.googlesource.com/toolchain/clang 003100370607242ddd5815e4a043907ea9004281) (https://android.googlesource.com/toolchain/llvm 1d739ffb0366421d383e04ff80ec2ee591315116) (based on LLVM 7.0.2svn)
      0x108 155 154 Obfuscator-LLVM clang version 8.0.0  (https://github.com/heroims/obfuscator.git 29d9dc8c1bd662f3a73d1b1b009266af1786b7b8) (based on Obfuscator-LLVM 8.0.0)
    */
    $ollvm  = "Obfuscator-LLVM clang version 8."
    $strenc = /\.datadiv_decode[\d]{18,20}/

  condition:
    is_elf and all of them
}

rule ollvm_v8 : obfuscator
{
  meta:
    description = "Obfuscator-LLVM version 8.x"
    url         = "https://github.com/obfuscator-llvm/obfuscator/wiki"
    url2        = "https://github.com/heroims/obfuscator"
    sample      = "2c720f5ec740f4c8571dbba205eadba483556c5c387fe88ff25192b25552da0f"
    author      = "Eduardo Novella"

  strings:
    /*
      [0x0000a5bc]> izzq~+obfuscator,ollvm,clang
      0x1 263 262 Android (4751641 based on r328903) clang version 7.0.2 (https://android.googlesource.com/toolchain/clang 003100370607242ddd5815e4a043907ea9004281) (https://android.googlesource.com/toolchain/llvm 1d739ffb0366421d383e04ff80ec2ee591315116) (based on LLVM 7.0.2svn)
      0x108 155 154 Obfuscator-LLVM clang version 8.0.0  (https://github.com/heroims/obfuscator.git 29d9dc8c1bd662f3a73d1b1b009266af1786b7b8) (based on Obfuscator-LLVM 8.0.0)
    */
    $ollvm = "Obfuscator-LLVM clang version 8."

  condition:
    is_elf and
    all of them and
    not ollvm_v8_strenc
}

rule ollvm_v9 : obfuscator
{
  meta:
    description = "Obfuscator-LLVM version 9.x"
    url         = "https://github.com/obfuscator-llvm/obfuscator/wiki"
    sample      = "a794a080a92987ce5ed9cf5cd872ef87f9bfb9acd4c07653b615f4beaff3ace2"
    sample2     = "198bee8db8765c3e2db35a65ac0ba3232f361b344c3fb74879cbf2f163bafe5a"
    author      = "Eduardo Novella"

  strings:
    /* Android (dev based on r365631) clang version 9.0.6 (https://android.googlesource.com/toolchain/llvm-project)
      (based on Obfuscator-LLVM 9.0.6svn)

      Android (ollvm based on r365631c3) clang version 9.0.9 (https://android.googlesource.com/toolchain/llvm-project a2a1e703c0edb03ba29944e529ccbf457742737b) (based on OLLVM 9.0.9svn)
      */
    $ollvm = /\(based on (Obfuscator-LLVM|OLLVM) 9\./

  condition:
    is_elf and all of them
}

rule ollvm_v9_a : obfuscator
{
  meta:
    description = "Obfuscator-LLVM version 9.x"
    url         = "https://github.com/o2e/OLLVM-9.0.1"
    sample      = "198bee8db8765c3e2db35a65ac0ba3232f361b344c3fb74879cbf2f163bafe5a"
    author      = "Eduardo Novella"

  strings:
    // clang version 9.0.1 (https://github.com/o2e/OLLVM-9.0.1.git 769bcbf3fe6a7d865a7afa9a70dbe907ad905cfb)
    $clang_version = /clang version \d\.\d\.\d (.*)OLLVM(.*)9\./

  condition:
    is_elf and
    any of them and
    not ollvm_v9
}

rule ollvm_v9_strenc : obfuscator
{
  meta:
    description = "Obfuscator-LLVM version 9.x (string encryption)"
    sample      = "2314ec0053d829d424a82f702188fcb525cefce4feeef096f0855339b897a5d1"
    author      = "Eduardo Novella"

  strings:
    $clang_version = /clang version \d\.\d\.\d /
    $strenc        = /\.datadiv_decode[\d]{18,20}/
    $ollvm         = "(based on Obfuscator-LLVM 9."

  condition:
    is_elf and
    not ollvm_v9 and
    all of them
}

rule ollvm_tll : obfuscator
{
  meta:
    description = "Obfuscator-LLVM TLL (string encryption)"
    url         = "https://github.com/yazhiwang/ollvm-tll"
    sample      = "1f010330e9ac90f00d11aa37fdca25c437ad6f4b1302f6d7aa48b91ef22cc107"
    author      = "Eduardo Novella"

  strings:
    /**
      .datadiv_decode7760209850571766755
      Android clang version 5.0.300080  (based on LLVM 5.0.300080)
      clang version 6.0.0 (tags/RELEASE_600/final) (https://github.com/yazhiwang/ollvm-tll.git a38559e4c13359073102793c0a734bb1add3d5ff)
    */
    $clang_version = /clang version \d\.\d\.\d \(tags\/RELEASE\_\d+\/final\)/
    $strenc        = /\.datadiv_decode[\d]{18,20}/
    $url           = "https://github.com/yazhiwang/ollvm-tll"

  condition:
    is_elf and all of them
}

rule ollvm_tll_a : obfuscator
{
  meta:
    description = "Obfuscator-LLVM TLL (string encryption)"
    url         = "https://github.com/yazhiwang/ollvm-tll"
    sample      = "0e5992066f177e2495a2a424201e146c29b78b63a9eb94bce6765691a47e6fd7"
    author      = "Eduardo Novella"

  strings:
    /**
      clang version 6.0.0 (tags/RELEASE_600/final) (git@github.com:enovella/ollvm-tll.git a38559e4c13359073102793c0a734bb1add3d5ff)
    */
    $version = /clang version \d+\.\d+\.\d+ \(.*\) \(.*\/ollvm\-tll\.git [0-9a-f]{40}\)/

  condition:
    is_elf and all of them and not ollvm_tll
}

rule ollvm_armariris : obfuscator
{
  meta:
    description = "Armariris Obfuscator-LLVM (string encryption)"
    url         = "https://github.com/GoSSIP-SJTU/Armariris"
    sample      = "d22c2f53bab6fa2ab7bdb4f7acabb419e3ee3163bb758c4f7a013d07a8b09e12" // aka malware Joker
    author      = "Eduardo Novella"

  strings:
    // clang version 3.9.1 (tags/RELEASE_391/final)
    // clang version 5.0.1 (tags/RELEASE_501/final)
    // .datadiv_decode14660921177804423408
    $clang_version = /clang version \d\.\d\.\d \(tags\/RELEASE\_\d+\/final\)/

  condition:
    is_elf and $clang_version and
    not ollvm_tll and
    for any i in (0..elf.symtab_entries): (elf.symtab[i].name matches /\.datadiv_decode[\d]{18,20}/)
}

rule ollvm_strenc : obfuscator
{
  meta:
    description = "Obfuscator-LLVM version unknown (string encryption)"
    sample      = "73f34f7dd5f5c2eff33fc48371c850a2a3ff0355a2bfa014467478ccb30309e3"
    author      = "Eduardo Novella"

  strings:
    $strenc = /\.datadiv_decode[\d]{18,20}/

  condition:
    is_elf and $strenc and
    not ollvm_tll and
    not ollvm_armariris and
    not ollvm_v5_0_strenc and
    not ollvm_v6_0_strenc and
    not ollvm_v8_strenc and
    not ollvm_v9_strenc
}

rule ollvm_v_regex : obfuscator
{
  meta:
    description = "Obfuscator-LLVM"
    url         = "https://github.com/o2e/OLLVM-9.0.1"
    sample      = "198bee8db8765c3e2db35a65ac0ba3232f361b344c3fb74879cbf2f163bafe5a"
    author      = "Eduardo Novella"

  strings:
    // clang version 9.0.1 (https://github.com/o2e/OLLVM-9.0.1.git 769bcbf3fe6a7d865a7afa9a70dbe907ad905cfb)
    $clang_version = /clang version \d\.\d\.\d (.*)OLLVM/

  condition:
    is_elf and
    any of them and
    not ollvm_v9 and
    not ollvm_v9_a
}

rule ollvm : obfuscator
{
  meta:
    description = "Obfuscator-LLVM version unknown"
    url         = "https://github.com/obfuscator-llvm/obfuscator/wiki"
    author      = "Eduardo Novella"

  strings:
    $ollvm1 = "Obfuscator-LLVM "
    $ollvm2 = "Obfuscator-clang "
    $ollvm3 = "Obfuscator- clang "

  condition:
    is_elf and
    any of them and
    not ollvm_v3_4 and
    not ollvm_v3_5 and
    not ollvm_v3_6_1 and
    not ollvm_v4_0 and
    not ollvm_v5_0_strenc and
    not ollvm_v6_0 and
    not ollvm_v6_0_strenc and
    not ollvm_strenc and
    not ollvm_v8 and
    not ollvm_v8_strenc and
    not ollvm_v9 and
    not ollvm_v9_strenc and
    not ollvm_v_regex
}

rule alipay : obfuscator
{
  meta:
    description = "Alipay"
    url         = "https://www.jianshu.com/p/477af178d7d8"
    sample      = "cbfec478f4860cb503ecb28711fe4767a68b7819d9a0c17cf51aaa77e11eb19a"
    author      = "Eduardo Novella"

  strings:
    /**
        __obfuscator_version
        Alipay  Obfuscator (based on LLVM 4.0.1)
        Alipay clang version 4.0.1  (based on LLVM 4.0.1.Alipay.Obfuscator.Trial)
    */
    $a = "Alipay clang version "
    $b = "Alipay  Obfuscator (based on LLVM "
    $c = "Alipay.Obfuscator."

  condition:
    any of them and is_elf
}

rule byteguard_0_9_3 : obfuscator
{
  meta:
    description = "ByteGuard 0.9.3"
    sample      = "eed4f7b907fe2173935d307dfb0d6aa7098f69db8dfb65e49affd7b7a6c0a5e4"
    samples     = "https://koodous.com/rulesets/5862/apks"
    author      = "Eduardo Novella"

  strings:
    // clang version 6.0.0 (Byteguard 0.6) (git@sysrepo.byted.org:dingbaozeng/native_obfuscator.git 448f20ff6eb06dd336dd81846d6a7dc8ba8c961b)
    // Apple LLVM version 6.0.0 (ByteGuard 0.9.3-af515063)
    $version = /(Apple LLVM|clang) version \d+\.\d+\.\d+ \(Byte(G|g)uard(-| )0\.9\.3/

  condition:
    is_elf and all of them
}

rule byteguard_0_9_2 : obfuscator
{
  meta:
    description = "ByteGuard 0.9.2"
    sample      = "178b1ef3c4ac563604c8a262f0e3651f56995768c8aa13ccc845f33bd6eb0ac2"
    samples     = "https://koodous.com/rulesets/5862/apks"
    author      = "Eduardo Novella"

  strings:
    // clang version 5.0.2 (Byteguard-0.9.2-255c7b5e)
    $version = /(Apple LLVM|clang) version \d+\.\d+\.\d+ \(Byte(G|g)uard(-| )0\.9\.2/

  condition:
    is_elf and all of them
}

rule byteguard_unknown : obfuscator
{
  meta:
    description = "ByteGuard unknown version"
    author      = "Eduardo Novella"

  strings:
    $clang_version = /(Apple LLVM|clang) version \d+\.\d+\.\d+ \(Byte(G|g)uard/

  condition:
    is_elf and $clang_version and
    not byteguard_0_9_2 and
    not byteguard_0_9_3
}

rule ollvm_lsposed : obfuscator
{
  meta:
    description = "LSPosed Obfuscator-LLVM (string encryption)"
    url         = "https://github.com/LSPosed/LSPosed.github.io/releases"
    sample      = "90ffa13afcf084aa3717a59cf5812517223c6cc4a6265cb191c929ef3a198c95/" // Momo, shamiko, and root hiders
    author      = "Eduardo Novella"

  strings:
    // Android (dev, based on r416183c1) clang version 12.0.8 (...)
    // decrypt.e94930e06527fedf
    $exports = /decrypt\.[0-9a-f]{14,16}/

  condition:
    is_elf and
    #exports > 5
    // for any i in (0..elf.symtab_entries): (elf.symtab[i].name matches /decrypt\.[0-9a-f]{14,16}/)
}

rule firehash : obfuscator
{
  meta:
    description = "Firehash"
    url         = "https://firehash.grayhash.com/"
    author      = "Eduardo Novella"

    // original   : https://firehash.grayhash.com/static/sample/dodocrackme_original.apk
    // firehashed : https://firehash.grayhash.com/static/sample/dodocrackme_obfuscated.apk
    sample   = "38e2170a5f272ecae97dddb0dac0c1f39f7f71a4639477764a9154557106dd94"

    // original : 6352f6d0cdc85a42de3ccfd9226dfec28280aa835227acc507043a4403b7e700
    sample2   = "c98af9a777d9633559b7903e21b61b845f7e1766afa74ef85e3380f41265e6b5"

    // original : 727be6789e8f4f6eab66288f957b58800e47a4bacebacc0dd700e8f9a374f116
    sample3   = "423dc9866d1c5f32cabfeb254030d83e11db4d807394a8ff09be47d8bfc38f18"

  strings:
    // Library below heuristic is found inside of is normally named "libaurorabridge.so"
    $segment = ".firehash"
    $opcodes_arm = {
        04 00 2D E5  //  STR     R0, [SP,#var_4]!
        00 00 0F E1  //  MRS     R0, CPSR
        01 00 51 E1  //  CMP     R1, R1
        02 00 00 ?A  //  BNE     loc_F0854
        00 F0 29 E1  //  MSR     CPSR_cf, R0
        04 00 9D E4  //  LDR     R0, [SP+4+var_4],#4
        ?? ?? ?? EA  //  B       loc_F0828
    }

  condition:
    elf.machine == elf.EM_ARM and all of them
}

rule advobfuscator : obfuscator
{
  meta:
    description = "ADVobfuscator"
    url         = "https://github.com/andrivet/ADVobfuscator"
    author      = "Eduardo Novella"
    sample      = "357f0c2ad6bf5cf60c671b090eab134251db63993f52aef512bde5bfa4a1b598"

  strings:
    $s_01 = "_ZNK17ObfuscatedAddressIPFiiiPciS0_S0_EE8originalEv"
    $s_02 = "_ZNK17ObfuscatedAddressIPFiPcEE8originalEv"
    $s_03 = "_ZNK17ObfuscatedAddressIPFvPciEE8originalEv"
    $s_04 = "_ZNK17ObfuscatedAddressIPFvPcS0_EE8originalEv"
    $s_05 = "_ZNK17ObfuscatedAddressIPFvvEE8originalEv"
    $s_06 = "_Z14ObfuscatedCallI17ObfuscatedAddressIPFvvEEJEEvT_DpOT0_"
    $s_07 = "_ZNK17ObfuscatedAddressIPFiPviEE8originalEv"
    $s_08 = "_ZNK17ObfuscatedAddressIPFvPcEE8originalEv"
    $s_09 = "_ZNK17ObfuscatedAddressIPFvP7_JNIEnvEE8originalEv"
    $s_10 = "_ZNK17ObfuscatedAddressIPFvPcS0_iiEE8originalEv"
    $s_11 = "_ZNK17ObfuscatedAddressIPFvcEE8originalEv"
    $s_12 = "_ZNK17ObfuscatedAddressIPFvPviiEE8originalEv"
    $s_13 = /\_ZN\dandrivet\d\dADVobfuscator\d\dMetaString.*decryptEv/

  condition:
    any of them and is_elf
}

rule arxan_arm32 : obfuscator
{
  meta:
    description = "Arxan"
    url         = "https://www.arxan.com/resources/technology/app-code-obfuscation"
    sample      = "5bbb241d41c4150798b5800e62afcb6f49e05755d2fd89c7a9f7e356609c9012"
    author      = "Eduardo Novella"

  strings:
    // Prolog breakage 1 ARM32
    $a = {
      00 10 90 E5    // LDR R1, [R0]
      00 00 81 E0    // ADD R0, R1, R0
      03 10 00 E0    // AND R1, R0, R3
      02 20 A0 E3    // MOV R2, #2
      92 01 01 E0    // MUL R1, R2, R1
      03 00 20 E0    // EOR R0, R0, R3
      01 00 80 E0    // ADD R0, R0, R1
      00 F0 A0 E1    // MOV PC, R0
    }

    // Prolog breakage 2 Thumb2
    $b = {
      4F F0 01 00    // MOV.W   R0, #1
      02 A1          // ADR     R1, loc_191658
      01 FB 00 F0    // MUL.W   R0, R1, R0
      87 46          // MOV     PC, R0
    }

    // Prolog breakage 3 ARM32
    $c = {
      ?? ?? ?? E?
      91 00 00 E0    // MUL     R0, R1, R0
      00 F0 A0 E1    // MOV     PC, R0
    }

  condition:
    (#a > 5 or #b > 5 or #c > 10) and elf.machine == elf.EM_ARM
}

rule arxan_arm64 : obfuscator
{
  meta:
    description = "Arxan"
    url         = "https://www.arxan.com/resources/technology/app-code-obfuscation"
    sample      = "444ae35cea294ca0268adbddf1c39e8a45fcbb4c967c55f23449cf0d1ae6fce6"
    author      = "Eduardo Novella"

  strings:
    /*
     * Prolog breakage 1 ARM64
     * This is how Arxan breaks the functions in basic blocks' sets making the static reverse engineering task very hard to follow.
     * This is a updated version of the previous Arxan 32bits rule.
     */
    $a = {
      09 01 0? 8A   // AND  X9, X8, X11/X12
      4A 00 80 D2   // MOV  X10, #2
      29 7D 0A 9B   // MUL  X9, X9, X10
      08 01 0? CA   // EOR  X8, X8, X11/X12
      08 01 09 8B   // ADD  X8, X8, X9
      00 01 1F D6   // BR   X8
    }

    $b = {
      28 00 80 D2   // MOV  X8, #1
      69 00 00 10   // ADR  X9, loc_XXX
      28 7D 08 9B   // MUL  X8, X9, X8
      00 01 1F D6   // BR   X8
    }

  condition:
    (#a > 3 or #b > 3) and elf.machine == elf.EM_AARCH64
}

rule dexguard_native : obfuscator
{
  meta:
    description = "DexGuard"
    url         = "https://www.guardsquare.com/en/products/dexguard"
    sample      = "ad25035a9ff2ccf44535fd0e5c9d3390f9ba2c4cd68ddf2aa69608494c48ea9e"

    strings:
      // "Java_com_guardsquare_dexguard_runtime_detection_HookDetector"
      $hook_detector = {
        00 4A 61 76 61 5F 63 6F 6D 5F 67 75 61 72 64 73 71 75 61 72 65 5F
        64 65 78 67 75 61 72 64 5F 72 75 6E 74 69 6D 65 5F 64 65 74 65 63
        74 69 6F 6E 5F 48 6F 6F 6B 44 65 74 65 63 74 6F 72
      }

    condition:
      is_elf
      and any of them
}

rule dexguard_native_a : obfuscator
{
  meta:
    description = "DexGuard 9.x"
    url         = "https://www.guardsquare.com/en/products/dexguard"
    sample      = "71b11059820c358fb14a0917430e07cf254e15d5b3337471ad172ad5ceccfa2a"
    author      = "Eduardo Novella"

    strings:
      // Library name is libdgrt (probably DexGuard RunTime)
      $libdgrt     = { 006c 6962 6467 7274 2e73 6f00 } // libdgrt.so
      $s_java_o_   = { 00 4a61 7661 5f6f 5f } // Java_o_
      $s_jnionload = { 004a 4e49 5f4f 6e4c 6f61 6400 } // JNI_OnLoad
      $s_basename  = { 00 6261 7365 6e61 6d65 00 }
      $s_mprotect  = { 006d 7072 6f74 6563 7400 }
      $s_dirname   = { 00 6469 726e 616d 6500 }

    condition:
      is_elf
      and $libdgrt
      and 4 of ($s_*)
      and not dexguard_native
}

rule dexguard_native_arm64 : obfuscator
{
  meta:
    description = "DexGuard 9.x"
    url         = "https://www.guardsquare.com/en/products/dexguard"
    sample      = "fc3fae3de64eceab969b7d91e3a5fbc45c7407bb8d1a5d5018caa86947604713"
    author      = "FrenchYeti & Eduardo Novella"

  strings:
    // Frida detection into /proc/%d/maps
    $hook1 = {
      0b 1d 00 12  //  and        w11,bf,#0xff
      48 15 40 38  //  ldrb       bf,[x10], #0x1
      29 25 1b 53  //  ubfiz      w9,w9,#0x5,#0xa
      29 01 0b 4a  //  eor        w9,w9,w11
      88 ff ff 35  //  cbnz       bf,LAB_00106e44
      e8 c1 86 52  //  mov        bf,#0x360f
      3f 01 08 6b  //  cmp        w9,bf
    }
    $hook2 = {
      6c 1d 00 12  //  and        w12, w11, #0xff
      4b 15 40 38  //  ldrb       w11, [x10],#1
      29 25 1b 53  //  ubfiz      w9, w9, #5, #0xa
      29 01 0c 4a  //  eor        w9, w9, w12
      8b ff ff 35  //  cbnz       w11, loc_85f4
      ea c1 86 52  //  mov        w10, #0x360f
      3f 01 0a 6b  //  cmp        w9, w10
    }
    $hook3 = {
      /* ?? ?? ??*/ // Prolog breakage
      e? c1 86 52   // mov  w8, #0x360f
      1f 00 0? 6b   // cmp  w0, w8
    }

    // Recurring patterns used into several string decryption
    $str1 = {
      6c 69 69 38  //  ldrb       w12,[x11, x9, LSL ]
      8c ?? ?? 11  //  add        w12,w12,??
      6c 69 29 38  //  strb       w12,[x11, x9, LSL ]
      29 05 00 91  //  add        x9,x9,#0x1
      3f ?? ?? f1  //  cmp        x9,??
      ec 17 9f 1a  //  cset       w12,??
    }
    $str2 = {
      30 ?? cc 9b 10 fe ?? d3 10 a6 0d 9b 6f 69 69 38 d0 69 70 38
      0f 02 0f 4a 6f 69 29 38 29 05 00 91 3f ?? ?? f1 ef 17 9f 1a
    }

    // Prolog breakage
    /**
      jint JNI_OnLoad(JavaVM *vm, void *reserved)
      {
        jint result;
        __asm { BR              X8 }
        return result;
      }
    */
    $prolog_breakage1 = {
      e? 03 (0a|09) 4b            // neg w10, w10 | neg w9, w9
      [4-16]                      // obfuscation
      ?? 01 0? 4a                 // eor w?, w?, w?
      [4-16]                      // obfuscation
      ?9 01 0? ??                 // and/sub w?, w1?, w?
      [4-16]                      // obfuscation
      29 7d 40 93                 // sxtw x9, w9
      (ea 03 7d b2 | 0a ?? 80 d2) // mov x10, #8 | mov x10, #0x2e0
      [0-8]                       // obfuscation
      28 21 0a 9b                 // madd x8, x9, x10, x8
      [0-8]                       // obfuscation
      08 01 40 f9                 // ldr x8, [x8]
      00 01 1f d6                 // br x8
    }

    // sample 5f0819ab5247ff992bdd3d3878561c4effa32878cf6e69c174b5ed054c52588f
    $prolog_breakage2 = {
      (4?|5?) d0 3b d5  //  mrs x9, tpidr_el0
      29 15 40 f9       //  ldr x9, [x9, 0x28]
      a9 83 1e f8       //  stur x9, [x29, -0x18]
      08 ?? 40 f9       //  ldr x8, [x8, 0x70]
      00 01 1f d6       //  br x8
    }

    // Binaries have usually >= 6 SVC instructions
    $svc = {
      ?8 ?? ?? ?2  //  mov        x8,??
      [4-32]
      01 00 00 d4  //  svc        0x0
    }

    $obf_export = {
      00 4a617661 5f 6f 5f [1-8] 00 // nullbyte + "Java_o_" + classname + nullbyte
    }

    $export_jnionload = {
      004a 4e49 5f4f 6e4c 6f61 6400 // JNI_OnLoad
    }

  condition:
    elf.machine == elf.EM_AARCH64
    and any of ($str*, $hook*, $prolog_breakage*, $obf_export)
    and $export_jnionload
    and #svc >= 6
    and not dexguard_native
    and not dexguard_native_a
}

rule snapprotect : obfuscator
{
  meta:
    description = "SnapProtect"
    url         = "https://www.snapchat.com/"
    sample      = "6dcd634e41304e41b91b49a3c77872a3c7ce28777bab016bd37f79bc7bb08274"
    author      = "Eduardo Novella"

  strings:
    // "clang version 7.0.0 (snap.protect version 2.4.0 - df15518f469ca4749b08/93d2c161df4b9b202bce)"
    $a = /clang version \d\.\d\.\d \(snap.protect version \d\.\d\.\d/
    $b = " (snap.protect version "

  condition:
    is_elf and 1 of ($a,$b)
}

rule safeengine : obfuscator
{
  meta:
    description = "Safeengine LLVM"
    url         = "https://bbs.pediy.com/thread-195327.htm"
    sample      = "93ec9a03b76fa359a7706aed0682003b76bca971e96462540fddad297817049b"
    author      = "horsicq"

  strings:
    // "Safengine clang version 3.8.0 (trunk 608) (based on LLVM 3.8.0svn)"
    //$clang_version = \0"Safengine clang version "
    $clang_version = { 00 53 61 66 65 6e 67 69 6e 65 20 63 6c 61 6e 67 20 76 65 72 73 69 6f 6e 20 }
    $based_on      = "(based on LLVM "

  condition:
    all of them and is_elf
}

rule hikari : obfuscator
{
  meta:
    description = "Hikari"
    sample      = "f6b936ab06ade3de189a0cf11964f77ea3a6ad081cfd8cc4580cc87bcd7dec70"
    url         = "https://github.com/HikariObfuscator/Hikari"
    author      = "Eduardo Novella"

  strings:
    // clang version 8.0.0 (tags/RELEASE_800/final) (https://gitee.com/chenzimo/Hikari.git ecdf30fa1a4635a76c3b528a41eb48d791f4be95)
    $version = /clang version \d+\.\d+\.\d+ \(.*\) \(.*\/Hikari\.git [0-9a-f]{40}\)/

  condition:
    is_elf and all of them
}

rule dexprotector : obfuscator
{
  meta:
    description = "DexProtector"
    url         = "https://dexprotector.com/"
    sample      = "d506e22003798f8b3a3d3c4a1b08af1cbd64667da6f9ed8cf73bc99ded73da44"
    sample2     = "ed2486674e1cf1dcd9ad7fc17a5c0d50c1790071227ae236c976a1c92386ccff"
    author      = "Eduardo Novella"

  strings:
    /**
     Possibly DPLF stands for "DexProtector Linkable Format"
    - offset -   0 1  2 3  4 5  6 7  8 9  A B  C D  E F  0123456789ABCDEF
    0x00000000  7f45 4c46 0101 0100 4450 4c46 0000 0000  .ELF....DPLF.... // armeabi_v7a
    0x00000000  7f45 4c46 0201 0100 4450 4c46 00e0 0100  .ELF....DPLF.... // Aarch64
    0x00000000  7f45 4c46 0101 0100 4450 4c46 00c0 0100  .ELF....DPLF.... // x86
    0x00000000  7f45 4c46 0201 0100 4450 4c46 00c0 0100  .ELF....DPLF.... // x86_64
    */
    $dp_elf_header = { 7f45 4c46 (01|02) 01 0100 4450 4c46 }

  condition:
    is_elf and $dp_elf_header at 0
}

rule dexprotector_a : obfuscator
{
  meta:
    description = "DexProtector"
    url         = "https://dexprotector.com/"
    sample      = "f2a646f10545810f4aa079565b4d1e508acd143644492f5eec6cfe1406d33035"
    author      = "Eduardo Novella"

  strings:
    /**
     Possibly DPLF stands for "DexProtector Linkable Format"

     Segments:
     4   0x00005000  0x51000 0x0000d000  0x51000 -rw- MAP  LOAD3

    - offset -   0 1  2 3  4 5  6 7  8 9  A B  C D  E F  0123456789ABCDEF
    0x0000d000  4450 4c46 1125 014c b8c5 9972 4631 3e30  DPLF.%.L...rF1>0
    0x0000d010  79d6 681a f96b 84bc 2073 6db2 1ec5 16f2  y.h..k.. sm.....
    */
    $dplf_header = { 44 50 4c 46 } // DPLF

  condition:
   is_elf and
   for any i in (0..elf.number_of_segments):
    (
      elf.segments[i].type == elf.PT_LOAD and
      elf.segments[i].flags == elf.PF_R | elf.PF_W and
      $dplf_header at elf.segments[i].offset
    )
 }

rule dexprotector_alice : obfuscator
{
  meta:
    description = "DexProtector (Alice)"
    url         = "https://licelus.com/products/dexprotector/docs/android/alice"
    sample      = "4f48625f1d4d0a1118478f61855ba96818f3907e46fbf96c55d5cebb8afe59a9"
    author      = "Eduardo Novella"

  strings:
    /**
      libalice.so: /Users/receiver/git/dexprotector/12.7.11/alice-core/src/main/jni/../cpp/alice.cpp
      libalice.so: /Users/receiver/git/dexprotector/12.7.11/alice-core/src/main/jni/../cpp/queue.cpp
      libalice.so: /Users/receiver/git/dexprotector/12.7.11/alice-core/src/main/jni/../cpp/SendScheduler.cpp
      libalice.so: /Users/receiver/git/dexprotector/12.7.11/alice-core/src/main/jni/../cpp/utils.cpp
    */
    $alice_sdk =  /dexprotector\/.*\/alice-core\/.*.cpp/
    $dp_log    = {
      2e64 6578 705f 6372 6173 685f 7469 6d65 7200 6465 7870 5f63 7261 7368 5f00   // dexp_crash_timer.dexp_crash_.
    }

  condition:
    is_elf and any of them
}

rule androidrepublic : obfuscator
{
  meta:
    description = "AndroidRepublic"
    url         = "https://androidrepublic.org/"
    sample      = "b893b45852ccfe4e037a356348042e613c47ae56e554943d8b3998c0cbb3ffb9"
    author      = "Eduardo Novella"

  strings:
    $str1 = { 00 6c 69 62 65 6d 74 72 65 70 75 62 6c 69 63 76 33 2e 73 6f 00 } // .libemtrepublicv3.so.
    $str2 = { 00 61 6e 64 72 6f 69 64 72 65 70 75 62 6c 69 63 2e 6f 72 67 00 } // .androidrepublic.org.
    $str3 = "We are Android Republic, while you snoop around trying to imitate, we are inovating the latest in Android Game modifications www.androidrepublic.org the oldest, the best and the future."

  condition:
    is_elf and 2 of them
}

rule androidrepublic_vip : obfuscator
{
  meta:
    description = "AndroidRepublic VIP"
    url         = "https://androidrepublic.org/"
    sample      = "ea1c69b7ba4f43ddcfb615e3fc5ff87d599232e6df089845a0e663d4bea761e0"
    author      = "Eduardo Novella"

  strings:
    $lib = {
      006c 6962 616e 6472 6f69 6472 6570 7562 6c69 632e 736f 00 // .libandroidrepublic.so.
     }

  condition:
    is_elf and all of them
}

rule ay : obfuscator
{
  meta:
    description = "AY"
    url         = "https://github.com/adamyaxley/Obfuscate"
    sample      = "35b451d7cb3ad93ece0cc1c9119356b7f11876ef116051fa1343bf88f0e2ef75"
    author      = "Eduardo Novella"

  strings:
    $export = /\_ZN2ay\d\dobfuscated_dataILy(.*)decryptEv/

  condition:
    is_elf and all of them
}

rule octopus_codevo : obfuscator
{
  meta:
    description = "Octopus SDK (Codevo)"
    url         = "https://codevo.com.tr/portfolio/"
    sample      = "886777034851adef9068b28c9ea54c52545dc68a7e692abffbc2d90807ead402" // com.garantiemeklilik.cepsube
    author      = "Eduardo Novella"

  strings:
    // octopus_obf::obfuscated_data<10ull,10751603028664370595ull>::~obfuscated_data()
    $export = /\_ZN\d{1,2}octopus_obf\d{1,2}obfuscated_dataILy(.*)Ev/

  condition:
    is_elf and all of them
}

rule epona : protector
{
    meta:
        description = "Quarks AppShield (Epona)"
        url         = "https://www.quarkslab.com/white-box-cryptography/"
        sample      = "db42bc905f5a3e6f67d1726ce358475614627f8356515ba79fc2b0cabbb65522" // euro.pccw.view 5.5.0
        author      = "Eduardo Novella"

    strings:
      $whitebox_crypto = {
        0D 04 40 39   // LDRB  W13, [X0,#1]
        0E 08 40 39   // LDRB  W14, [X0,#2]
        0F 0C 40 39   // LDRB  W15, [X0,#3]
        02 14 40 39   // LDRB  W2, [X0,#5]
        04 1C 40 39   // LDRB  W4, [X0,#7]
        0C 00 40 39   // LDRB  W12, [X0]
        10 10 40 39   // LDRB  W16, [X0,#4]
        03 18 40 39   // LDRB  W3, [X0,#6]
        05 20 40 39   // LDRB  W5, [X0,#8]
        06 24 40 39   // LDRB  W6, [X0,#9]
        07 28 40 39   // LDRB  W7, [X0,#0xA]
        13 2C 40 39   // LDRB  W19, [X0,#0xB]
        14 30 40 39   // LDRB  W20, [X0,#0xC]
        15 34 40 39   // LDRB  W21, [X0,#0xD]
        16 38 40 39   // LDRB  W22, [X0,#0xE]
        00 3C 40 39   // LDRB  W0, [X0,#0xF]
      }

    condition:
      is_elf and any of them
}




```

`apkid/rules/elf/packers.yara`:

```yara
/*
 * Copyright (C) 2023  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

import "elf"
include "common.yara"
include "../apk/packers.yara"

private rule upx_elf32_arm_stub : packer
{
  meta:
    description = "Contains a UPX ARM stub"

  strings:
    $UPX_STUB = { 1E 20 A0 E3 14 10 8F E2 02 00 A0 E3 04 70 A0 E3 00 00 00 EF 7F 00 A0 E3 01 70 A0 E3 00 00 00 EF }

  condition:
    elf.machine == elf.EM_ARM and $UPX_STUB
}

private rule upx_stub : packer
{
  meta:
    description = "Contains a UPX stub"

  condition:
    upx_elf32_arm_stub
}

private rule upx_unmodified : packer
{
  meta:
    description = "Contains an unmodified UPX stub"

  strings:
    $upx = "UPX!"

  condition:
    $upx in (0..200) and $upx in (filesize - 50 .. filesize) and upx_elf32_arm_stub
}

rule upx_sharedlib_unmodifed : packer
{
  meta:
    description = "sharelib UPX"

  strings:
    $upx = "UPX!"

  condition:
    elf.type == elf.ET_DYN
    and $upx in (filesize - 50 .. filesize) and upx_stub
}

rule upx_elf_3_94 : packer
{
  meta:
    description = "UPX 3.94 (unmodified)"

  strings:
    $copyright = "UPX 3.94 Copyright"

  condition:
    upx_unmodified and $copyright
}

rule upx_elf_3_93 : packer
{
  meta:
    description = "UPX 3.93 (unmodified)"

  strings:
    $copyright = "UPX 3.93 Copyright"

  condition:
    upx_unmodified and $copyright
}

// Fixes included for Android shared libs
rule upx_elf_3_92 : packer
{
  meta:
    description = "UPX 3.92 (unmodified)"

  strings:
    $copyright = "UPX 3.92 Copyright"

  condition:
    upx_unmodified and $copyright
}

rule upx_elf_3_91 : packer
{
  meta:
    description = "UPX 3.91 (unmodified)"

  strings:
    $copyright = "UPX 3.91 Copyright"

  condition:
    upx_unmodified and $copyright
}

rule upx_elf_3_09 : packer
{
  meta:
    description = "UPX 3.09 (unmodified)"

  strings:
	  $copyright = "UPX 3.09 Copyright"

  condition:
    upx_unmodified and $copyright
}

rule upx_elf_3_08 : packer
{
  meta:
    description = "UPX 3.08 (unmodified)"

  strings:
    $copyright = "UPX 3.08 Copyright"

  condition:
    upx_unmodified and $copyright
}

rule upx_elf_3_07 : packer
{
  meta:
    description = "UPX 3.07 (unmodified)"

  strings:
    $copyright = "UPX 3.07 Copyright"

  condition:
    upx_unmodified and $copyright
}

rule upx_elf_3_04 : packer
{
  meta:
    description = "UPX 3.04 (unmodified)"

  strings:
    $copyright = "UPX 3.04 Copyright"

  condition:
    upx_unmodified and $copyright
}

rule upx_elf_3_03 : packer
{
  meta:
    description = "UPX 3.03 (unmodified)"

  strings:
    $copyright = "UPX 3.03 Copyright"

  condition:
	  upx_unmodified and $copyright
}

rule upx_elf_3_02 : packer
{
  meta:
    description = "UPX 3.02 (unmodified)"

  strings:
    $copyright = "UPX 3.02 Copyright"

  condition:
    upx_unmodified and $copyright
}

rule upx_elf_3_01 : packer
{
  meta:
    description = "UPX 3.01 (unmodified)"

  strings:
    $copyright = "UPX 3.01 Copyright"

  condition:
    upx_unmodified and $copyright
}

rule upx_elf_bangcle_secneo : packer
{
  meta:
    description = "Bangcle/SecNeo (UPX)"

  strings:
    // They replace UPX! with SEC!
    $sec = "SEC!"

  condition:
    $sec in (0..200) and $sec in (filesize - 50 .. filesize) and upx_stub
}

rule upx_elf_bangcle_secneo_newer : packer
{
  meta:
    description = "newer-style Bangcle/SecNeo (UPX)"

  strings:
    // They replace UPX! with \x03\x02\x01\x00
    $TTO = { 03 02 01 00 }

  condition:
    $TTO in (filesize - 50 .. filesize) and upx_stub
}

rule upx_elf_ijiami : packer
{
  meta:
    description = "Ijiami (UPX)"

  strings:
    // They replace UPX! with AJM!
    $ajm = "AJM!"

  condition:
    $ajm in (filesize - 50 .. filesize) and upx_stub
}

rule upx_elf_joker : packer
{
  meta:
    description = "Joker (UPX)"
    sample = "2de03bc5fc110a3bb2e6f4d6d6e558052b5cae3cb117a1a8c2be08576be0ed58"

  strings:
    // They replace UPX! with ZHSH or TIW°
    $rename1 = "ZHSH"
    // TIW°
    $rename2 = { 54 49 57 B0 }

  condition:
    ($rename1 in (filesize - 50 .. filesize)) or
    ($rename2 in (filesize - 50 .. filesize))
     and upx_stub
}

private rule upx_unknown_version : packer
{
  meta:
    description = "UPX (unknown)"

  condition:
    upx_stub
    // We could extend this for more comprehensive rules, however lower versions than this should not be
    // appears on arm/android devices
    and not (upx_elf_3_01 or upx_elf_3_02 or upx_elf_3_03 or upx_elf_3_04 or upx_elf_3_07 or upx_elf_3_08 or upx_elf_3_09 or upx_elf_3_91 or upx_elf_3_92 or upx_elf_3_93 or upx_elf_3_94)
    and not (upx_elf_ijiami or upx_elf_joker or upx_elf_bangcle_secneo or upx_elf_bangcle_secneo_newer)
}

rule upx_embedded_inside_elf : packer dropper
{
  meta:
    description = "UPX packed ELF embedded in ELF"

  strings:
    $elf_magic = { 7F 45 4C 46 }

  condition:
    $elf_magic at 0 and $elf_magic in (256..filesize)
    and upx_unknown_version
    and not upx_unmodified
    and not upx_sharedlib_unmodifed
}

rule upx_unknown_version_modified : packer
{
  meta:
    description = "UPX (unknown, modified)"

  condition:
    upx_unknown_version
    and not is_apk
    and not upx_unmodified
    and not bangcle
    and not upx_elf_bangcle_secneo
    and not upx_elf_bangcle_secneo_newer
    and not upx_elf_ijiami
    and not upx_elf_joker
    and not ijiami
    and not upx_sharedlib_unmodifed
    and not upx_embedded_inside_elf
}

rule upx_compressed_apk : packer embedded
{
  meta:
    description = "UPX packed ELF embedded in APK"

  condition:
    upx_unknown_version and
    is_apk and
    not (upx_unmodified or ijiami or bangcle or jiagu)
}

rule upx_unknown_version_unmodified : packer
{
  meta:
    description = "UPX (unknown, unmodified)"

  condition:
    upx_unknown_version and
    upx_unmodified and
    not upx_compressed_apk
}

rule promon : packer
{
  meta:
    description = "Promon Shield"
    url         = "https://promon.co/"
    sample      = "6a3352f54d9f5199e4bf39687224e58df642d1d91f1d32b069acd4394a0c4fe0"
    sample2     = "0ef06e0b1511872e711cf3e8e53fee097d13755c9572cfea6d153d708906f45d"
    author      = "Eduardo Novella"

  strings:
    // Library names
    $libshield   = "libshield.so"
    $rnd_libname = /lib[a-z]{10,12}\.so/ // libchhjkikihfch.so || libgiompappkhnb.so

    /**
     Odd ELF segments found:
      .ncc -> Code segment
      .ncd -> Data segment
      .ncu -> Another segment
    */

  condition:
    is_elf and ($libshield or $rnd_libname) and
    (   // Match at least two section names from .ncu, .ncc, .ncd
        (for any i in (0..elf.number_of_sections): (elf.sections[i].name matches /\.ncu/)
            and for any i in (0..elf.number_of_sections): (elf.sections[i].name matches /\.ncc/))  or
        (for any i in (0..elf.number_of_sections): (elf.sections[i].name matches /\.ncu/)
            and for any i in (0..elf.number_of_sections): (elf.sections[i].name matches /\.ncd/))  or
        (for any i in (0..elf.number_of_sections): (elf.sections[i].name matches /\.ncc/)
            and for any i in (0..elf.number_of_sections): (elf.sections[i].name matches /\.ncd/))
    )
}

rule promon_a : packer
{
  meta:
    description = "Promon Shield"
    url         = "https://promon.co/"
    sample      = "77df1956a6842a4e5db65bb9758e46d61eda3592905d3576736b276907b4651b" // com.starfinanz.mobile.android.pushtan
    author      = "Eduardo Novella"

    /**
     Odd ELF segments found:
      .ncc -> Code segment
      .ncd -> Data segment
      .ncu -> Another segment
    */

  condition:
    is_elf and not promon and
    (   // Match at least two section names from .ncu, .ncc, .ncd
        (for any i in (0..elf.number_of_sections): (elf.sections[i].name matches /\.ncu/)
            and for any i in (0..elf.number_of_sections): (elf.sections[i].name matches /\.ncc/))  or
        (for any i in (0..elf.number_of_sections): (elf.sections[i].name matches /\.ncu/)
            and for any i in (0..elf.number_of_sections): (elf.sections[i].name matches /\.ncd/))  or
        (for any i in (0..elf.number_of_sections): (elf.sections[i].name matches /\.ncc/)
            and for any i in (0..elf.number_of_sections): (elf.sections[i].name matches /\.ncd/))
    )
}

rule appsealing_core_2_10_10 : packer
{
  meta:
    description = "AppSealing CORE VERSION 2.10.10"
    url         = "https://www.appsealing.com/"
    sample      = "61a983b032aee2e56159e682ad1588ad30fa8c3957bf849d1afe6f10e1d9645d"
    author      = "zeroload"

  strings:
    $core_ver = "APPSEALING-CORE-VERSION_2.10.10"

  condition:
    is_elf and $core_ver
}

rule appsuit_packer_a : packer
{
  meta:
    description = "AppSuit"
    url         = "http://www.stealien.com/appsuit.html"
    sample      = "3bcb66444b43d1a225ac2dd59387b8aa2ce921b0595708d65753eef6b0ef2165"
    author      = "Eduardo Novella"

  strings:
    $native_lib1 = { 00 6c6962417070537569742e736f   00 } // \0libAppSuit.so\0
    $native_lib2 = { 00 6c6962556e7061636b65722e736f 00 } // \0libUnpacker.so\0

  condition:
    is_elf and all of them
}

rule tencent_elf : packer
{
  meta:
    description = "Mobile Tencent Protect"
    url         = "https://intl.cloud.tencent.com/product/mtp"
    sample      = "7c6024abc61b184ddcc9fa49f9fac1a7e5568d1eab09ee748f8c4987844a3f81"

  strings:
    // getenv liblog.so libz.so libdl.so libc.so libshell.so
    $libs = {
      00 67 65 74 65 6E 76 00 6C 69 62 6C 6F 67 2E 73 6F 00 6C 69 62 7A 2E
      73 6F 00 6C 69 62 64 6C 2E 73 6F 00 6C 69 62 63 2E 73 6F 00 6C 69 62
      73 68 65 6C 6C 2E 73 6F 00
    }

  condition:
    is_elf
    and any of them
}

rule tencent_legu_VMP_elf : packer
{
  meta:
    description = "Tencent's Legu (VMP)"
    url         = "https://github.com/rednaga/APKiD/issues/390"
    sample      = "95ca638cfb80ebbb21e97c202f9c06f7306c6fc9696b4760a401afa9293000f7" // com.youwan.aoao v2.9.2
    author      = "Eduardo Novella"

  strings:
    $lib = { 00 6c69 6278 6756 6970 5365 6375 7269 7479 2e73 6f00 } // .libxgVipSecurity.so.

  condition:
    is_elf and all of them
}

rule tongfu_shield_elf : packer
{
    meta:
        description = "Tongfu shield"
        url         = "https://www.tongfudun.com"
        url2        = "https://www.payegis.com/"
        sample      = "af27533557a47ff6795b0df77ea863bbefafa4974ce2dbf9604a79ce7196d080" // com.kingdee.zhihuiji v6.25.22
        author      = "Eduardo Novella"

    strings:
        $libname = { 00 6c69 6265 6769 732e 736f 00 } // .libegis.so.
        $asset   = { 6173 7365 7473 2f6c 6962 6567 6973 2e61 00 } // assets/libegis.a.
        $class   = { 00 636f 6d2f 7061 7965 6769 732f 4669
                     7273 7441 7070 6c69 6361 7469 6f6e 00 } // .com/payegis/FirstApplication.

    condition:
      is_elf and any of them
}

rule crackproof : packer
{
  meta:
    description = "CrackProof"
    url         = "https://www.hypertech.co.jp/eng/"
    sample      = "312243d9133ced054a850fa933d1f62adb717a232b79469ab2f58be77c9377a4"
    samples     = "https://koodous.com/rulesets/5244/apks"
    author      = "Eduardo Novella"

  strings:
    /**
      int __fastcall j_do_asm_syscall(int svc_nr, void *a2, void *a3, void *a4, void *a5, void *a6, void *a7)
      {
        int r; // r0

        r = do_asm_syscall(a2, a3, a4, a5, a6, a7, 0, svc_nr);
        return sub_4D78C(svc_nr, r);
      }
    */
    $j_do_asm_syscall = {
      00 48 2D E9 //   PUSH {R11,LR}
      04 B0 8D E2 //   ADD  R11, SP, #4
      28 D0 4D E2 //   SUB  SP, SP, #0x28
      10 00 0B E5 //   STR  R0, [R11,#var_10]
      14 10 0B E5 //   STR  R1, [R11,#a1]
      18 20 0B E5 //   STR  R2, [R11,#a2]
      1C 30 0B E5 //   STR  R3, [R11,#a3]
      00 30 A0 E3 //   MOV  R3, #0
      08 30 0B E5 //   STR  R3, [R11,#r]
      08 30 9B E5 //   LDR  R3, [R11,#a6]
      00 30 8D E5 //   STR  R3, [SP,#0x2C+var_2C] ; a5
      0C 30 9B E5 //   LDR  R3, [R11,#a7]
      04 30 8D E5 //   STR  R3, [SP,#0x2C+var_28] ; a6
      00 30 A0 E3 //   MOV  R3, #0
      08 30 8D E5 //   STR  R3, [SP,#0x2C+var_24] ; a7
      10 30 1B E5 //   LDR  R3, [R11,#var_10]
      0C 30 8D E5 //   STR  R3, [SP,#0x2C+svc_nr] ; svc_nr
      14 00 1B E5 //   LDR  R0, [R11,#a1] ; a1
      18 10 1B E5 //   LDR  R1, [R11,#a2] ; a2
      1C 20 1B E5 //   LDR  R2, [R11,#a3] ; a3
      04 30 9B E5 //   LDR  R3, [R11,#a5] ; a4
      ?? ?? ?? EB //   BL   do_asm_syscall
      00 30 A0 E1 //   MOV  R3, R0
      08 30 0B E5 //   STR  R3, [R11,#r]
      08 30 1B E5 //   LDR  R3, [R11,#r]
      10 00 1B E5 //   LDR  R0, [R11,#var_10] ; svc_nr
      03 10 A0 E1 //   MOV  R1, R3  ; r
      ?? ?? ?? EB //   BL   sub_4D78C
      00 30 A0 E1 //   MOV  R3, R0
      08 30 0B E5 //   STR  R3, [R11,#r]
      08 30 1B E5 //   LDR  R3, [R11,#r]
      03 00 A0 E1 //   MOV  R0, R3
      04 D0 4B E2 //   SUB  SP, R11, #4
      00 88 BD E8 //   POP  {R11,PC}
    }

    /**
      int __fastcall do_asm_syscall(void *a1, void *a2, void *a3, void *a4, void *a5, void *a6, void *a7, int svc_nr)
      {
        return linux_eabi_syscall(svc_nr, a1, a2, a3, a4, a5, a6, a7);
      }
    */
    $do_asm_syscall = {
      FE 4F 2D E9  //  PUSH  {R1-R11,LR}
      2C B0 8D E2  //  ADD   R11, SP, #0x2C
      04 40 9B E5  //  LDR   R4, [R11,#a5]
      08 50 9B E5  //  LDR   R5, [R11,#a6]
      0C 60 9B E5  //  LDR   R6, [R11,#a7]
      10 70 9B E5  //  LDR   R7, [R11,#svc_nr]
      00 00 00 EF  //  SVC   0
      FE 8F BD E8  //  POP   {R1-R11,PC}
    }

  condition:
    is_elf and all of them
}

rule crackproof_a : packer
{
  meta:
    description = "CrackProof"
    url         = "https://www.hypertech.co.jp/eng/"
    sample      = "a296f4c1d48b830bb26c6ca7f2889e47756fb4adf0dd86d193a8b60d3bc4ae7d"
    author      = "Eduardo Novella"

  strings:
    /**
      __int64 __usercall init_proc@<X0>(a1@<X1>,  a2@<X2>,  a3@<X3>,  a4@<X4>,  a5@<X5>,  a6@<X6>,  a7@<X7>,  a8@<X8>)
      {
        __int64 v9[30]; // [xsp+0h] [xbp-F0h] BYREF

        v9[28] = a1;
        v9[29] = a2;
        v9[26] = a3;
        v9[27] = a4;
        v9[24] = a5;
        v9[25] = a6;
        v9[22] = a7;
        v9[23] = a8;
        return sub_7F4(v9);
      }
    */
    $init_proc = {
      E1 0B BF A9  //  STP  X1, X2, [SP,#var_10]!
      E3 13 BF A9  //  STP  X3, X4, [SP,#0x10+var_20]!
      E5 1B BF A9  //  STP  X5, X6, [SP,#0x20+var_30]!
      E7 23 BF A9  //  STP  X7, X8, [SP,#0x30+var_40]!
      E9 2B BF A9  //  STP  X9, X10, [SP,#0x40+var_50]!
      EB 33 BF A9  //  STP  X11, X12, [SP,#0x50+var_60]!
      ED 3B BF A9  //  STP  X13, X14, [SP,#0x60+var_70]!
      EF 43 BF A9  //  STP  X15, X16, [SP,#0x70+var_80]!
      F1 4B BF A9  //  STP  X17, X18, [SP,#0x80+var_90]!
      F3 53 BF A9  //  STP  X19, X20, [SP,#0x90+var_A0]!
      F5 5B BF A9  //  STP  X21, X22, [SP,#0xA0+var_B0]!
      F7 63 BF A9  //  STP  X23, X24, [SP,#0xB0+var_C0]!
      F9 6B BF A9  //  STP  X25, X26, [SP,#0xC0+var_D0]!
      FB 73 BF A9  //  STP  X27, X28, [SP,#0xD0+var_E0]!
      FD 7B BF A9  //  STP  X29, X30, [SP,#0xE0+var_F0]!
      E0 03 00 91  //  MOV  X0, SP
      ?? ?? ?? 97  //  BL   sub_7F4
      FD 7B C1 A8  //  LDP  X29, X30, [SP+0xF0+var_F0],#0x10
      FB 73 C1 A8  //  LDP  X27, X28, [SP+0xE0+var_E0],#0x10
      F9 6B C1 A8  //  LDP  X25, X26, [SP+0xD0+var_D0],#0x10
      F7 63 C1 A8  //  LDP  X23, X24, [SP+0xC0+var_C0],#0x10
      F5 5B C1 A8  //  LDP  X21, X22, [SP+0xB0+var_B0],#0x10
      F3 53 C1 A8  //  LDP  X19, X20, [SP+0xA0+var_A0],#0x10
      F1 4B C1 A8  //  LDP  X17, X18, [SP+0x90+var_90],#0x10
      EF 43 C1 A8  //  LDP  X15, X16, [SP+0x80+var_80],#0x10
      ED 3B C1 A8  //  LDP  X13, X14, [SP+0x70+var_70],#0x10
      EB 33 C1 A8  //  LDP  X11, X12, [SP+0x60+var_60],#0x10
      E9 2B C1 A8  //  LDP  X9, X10, [SP+0x50+var_50],#0x10
      E7 23 C1 A8  //  LDP  X7, X8, [SP+0x40+var_40],#0x10
      E5 1B C1 A8  //  LDP  X5, X6, [SP+0x30+var_30],#0x10
      E3 13 C1 A8  //  LDP  X3, X4, [SP+0x20+var_20],#0x10
      E1 0B C1 A8  //  LDP  X1, X2, [SP+0x10+var_10],#0x10
      C0 03 5F D6  //  RET
    }

    /**
      signed __int64 __fastcall do_asm_syscall(void *a1, void *a2, void *a3, void *a4, void *a5, void *a6, void *a7, signed __int64 svc_nr)
      {
        return linux_eabi_syscall(svc_nr, a1, a2, a3, a4, a5, a6, a7);
      }
    */
    $do_asm_syscall = {
      E1 0B BF A9  //  STP  X1, X2, [SP,#var_10]!
      E3 13 BF A9  //  STP  X3, X4, [SP,#0x10+var_20]!
      E5 1B BF A9  //  STP  X5, X6, [SP,#0x20+var_30]!
      E7 23 BF A9  //  STP  X7, X8, [SP,#0x30+var_40]!
      E9 7B BF A9  //  STP  X9, X30, [SP,#0x40+var_50]!
      E8 03 07 AA  //  MOV  X8, X7
      01 00 00 D4  //  SVC  0
      E9 7B C1 A8  //  LDP  X9, X30, [SP+0x50+var_50],#0x10
      E7 23 C1 A8  //  LDP  X7, X8, [SP+0x40+var_40],#0x10
      E5 1B C1 A8  //  LDP  X5, X6, [SP+0x30+var_30],#0x10
      E3 13 C1 A8  //  LDP  X3, X4, [SP+0x20+var_20],#0x10
      E1 0B C1 A8  //  LDP  X1, X2, [SP+0x10+var_10],#0x10
      C0 03 5F D6  //  RET
    }

    /**
      v25 = j_asm_syscall(SYS_mprotect, v32, v29[6], 7LL, 0LL, 0LL, 0LL);
      if ( v34 != 1 )
      {
          v10 = sub_4309D80();
          v11 = -v25;
          v12 = sub_430D114(v17);
          v34 = sub_430E87C(0LL, 0LL, v10, 1LL, 181, 1LL, 5LL, v11, v17, v12);
      }
    */
    $func1 = {
      E2 03 00 2A  //  MOV             W2, W0
      E3 7F 94 B9  //  LDRSW           X3, [SP,#0x14C0+var_44]
      40 1C 80 D2  //  MOV             X0, #0xE2
      04 00 80 D2  //  MOV             X4, #0
      05 00 80 D2  //  MOV             X5, #0
      06 00 80 D2  //  MOV             X6, #0
      ?? ?? ?? 94  //  BL              j_asm_syscall
    }
    $func2 = {
      00 00 80 D2  //  MOV  X0, #0
      01 00 80 D2  //  MOV  X1, #0
      E2 03 14 2A  //  MOV  W2, W20
      23 00 80 52  //  MOV  W3, #1
      A4 16 80 52  //  MOV  W4, #0xB5
      25 00 80 52  //  MOV  W5, #1
      A6 00 80 52  //  MOV  W6, #5
      E7 03 13 2A  //  MOV  W7, W19
      ?? ?? ?? 94  //  BL   sub_430E87C
    }

    /**
      sub_430E87C(0LL, 0LL, v13, 1u, 198u, 1u, 6u, 0, 0LL, 0);
    */
    $func3 = {
      00 00 80 D2  //   MOV             X0, #0
      01 00 80 D2  //   MOV             X1, #0
      23 00 80 52  //   MOV             W3, #1
      C4 18 80 52  //   MOV             W4, #0xC6
      25 00 80 52  //   MOV             W5, #1
      C6 00 80 52  //   MOV             W6, #6
      07 00 80 52  //   MOV             W7, #0
      ?? ?? ?? 94  //   BL              sub_430E87C
    }

    /**
      sub_430E87C(0LL, 0LL, v14, 1LL, 199LL, 1LL, 7LL, 0LL, 0LL, 0);
    */
    $func4 = {
      00 00 80 D2   //   MOV  X0, #0
      01 00 80 D2   //   MOV  X1, #0
      23 00 80 52   //   MOV  W3, #1
      E4 18 80 52   //   MOV  W4, #0xC7
      25 00 80 52   //   MOV  W5, #1
      E6 00 80 52   //   MOV  W6, #7
      07 00 80 52   //   MOV  W7, #0
      ?? ?? ?? 94   //   BL   sub_430E87C
    }

  condition:
    is_elf and $init_proc and $do_asm_syscall and 1 of ($func*)
}

rule jiagu_native : packer
{
  meta:
    description = "Jiagu"
    sample      = "3e83c34f496bd33457ca0a100c90ed229e2c1a9e39fdcaf5670d32455c5d051e"
    url         = "http://jiagu.360.cn/"
    author      = "Govind Sharma"

  strings:
    $a = "libz.so"
    $b = "uncompress"
    $c = "libjiagu"
    $d = "JIAGU_APP_NAME"
    $e = "JIAGU_SO_BASE_NAME"
    $f = "JIAGU_ENCRYPTED_DEX_NAME"
    $g = "JIAGU_HASH_FILE_NAME"

  condition:
    is_elf and ($a and $b and $c) and any of ($d, $e, $f, $g)
}

rule blackmod : packer
{
  meta:
    description = "BlackMod"
    url         = "https://blackmod.net/"
    sample      = "77b1ff2db51896a2c5a0b1a932283d757f5d2285a8c035d212af09d8d373441a"
    author      = "Eduardo Novella"

  strings:
    $libname    = {00 6c6962626d742e736f 00}       // libbmt.so
    $jni_onload = {00 4a4e 495f 4f6e 4c6f 6164 00} // JNI_OnLoad

    $svc_arm32 = {
      // read_0   ; CODE XREF: j__xd
      ?? 7? A0 E3  //   MOV             R7, #3 (read), #4 (write) & #0x142 (openat)
      00 00 00 EF  //   SVC             0
    }

    $svc_arm64 = {
      ?8 0? 80 D2  //  MOV             X8, #63 (read), #64 (write), & #56 (openat)
      01 00 00 D4  //  SVC             0
    }

  condition:
    is_elf and 3 of them
}

rule _5play_ru : packer
{
  meta:
    description = "5play.ru"
    url         = "https://5play.ru"
    sample      = "b0db6d3a98a2e0e255380e5e04c9b461cc1aac06e9be29150318cf4cfbe06887"
    author      = "Eduardo Novella"

  strings:
    $libname    = {00 6c69 6252 4d53 2e73 6f 00}   // libRMS.so
    $jni_onload = {00 4a4e 495f 4f6e 4c6f 6164 00} // JNI_OnLoad

    $svc_arm32 = {
      FF 5F 2D E9   // PUSH  {R0-R12,LR}
      42 71 00 E3   // MOVW  R7, #0x142
      01 20 A0 E1   // MOV   R2, R1
      00 10 A0 E1   // MOV   R1, R0
      63 00 E0 E3   // MOV   R0, #0xFFFFFF9C
      00 00 00 EF   // SVC   0
    }

    $svc_arm64 = {
      08 07 80 D2   // MOV   X8, #56
      E2 03 01 AA   // MOV   X2, X1
      E1 03 00 AA   // MOV   X1, X0
      60 0C 80 12   // MOV   W0, #0xFFFFFF9C
      01 00 00 D4   // SVC   0
    }

  condition:
    is_elf and 3 of them
}

rule liapp_elf : packer
{
  meta:
    description = "LIAPP"
    url         = "https://liapp.lockincomp.com"
    sample      = "29b8c466148bcbe2ee4d1e9f1cc03ceb7e320cd19e7923e0c5a0b8a062758f0f" // com.teamblind.blind
    author      = "Eduardo Novella"

  strings:
    $libname = {  006c 6962 6c69 6170 702e 736f 00 } // libliapp.so

  condition:
    is_elf and all of them
}

rule eversafe_elf : packer
{
    meta:
        description = "Eversafe"
        url         = "https://everspin.global/products/solutions/eversafe-mobile"
        sample      = "00dbb346f3ae0540620eb120ccf00a65af81a07baed5adfdcd2fc620a33ed298"
        author      = "dustty0 & Eduardo Novella"

    strings:
      $lib = {
          006c 6962 6576 6572 7361 6665 2e73 6f00 // .libeversafe.so.
      }

    condition:
      is_elf and any of them
}

rule aegis_elf : packer
{
    meta:
        description = "Aegis"
        url         = "https://androidrepublic.org"
        sample      = "4ca8c5f8ecfa1c36678b1745a2b58872e3f3f5fd14df6dd5fd65d6b8f2677f53"
        author      = "Yehh22 & Eduardo Novella"

    strings:
        $lib1 = { 00 6c69 6261 6567 6973 5f65 2e73 6f00                } // .libaegis_e.so
        $lib2 = { 00 6c69 6261 6567 6973 5f65 5f61 726d 3634 2e73 6f00 } // .libaegis_e_arm64.so.
        $lib3 = { 00 6c69 6261 6567 6973 5f65 5f78 3836 2e73 6f00      } // .libaegis_e_x86.so.
        $url = "https://www.androidrepublic.org"

    condition:
      is_elf and 2 of them
}

rule appguard_elf : packer
{
  meta:
    description = "AppGuard"
    url         = "http://appguard.nprotect.com/en/index.html"
    sample      = "a6e9c876be2b8b936ab9bfe2699811524b8ad3c11305099b34194bb8aad79f1e"
    sample2     = "23cd2af10d46459065ea65b2d40fb706fd4847a1f8ef195cbebf1c6d8d54a48a"
    author      = "Eduardo Novella"

  strings:
    $a = { 00 6C 69 62 41 70 70 47 75 61 72 64 2E 73 6F 00 }  // .libAppGuard.so.
    $b = { 00 23 4C 63 6F 6D 2F 69 6E 63 61 2F 73 65 63 75
           72 69 74 79 2F 41 70 70 47 75 61 72 64 2F 78 43
           6C 61 73 73 3B 00 } //.#Lcom/inca/security/AppGuard/xClass;.

  condition:
    is_elf and any of them
}

rule appguard_elf_b : packer
{
  meta:
    description = "AppGuard"
    url         = "http://appguard.nprotect.com/en/index.html"
    sample      = "94454b39eb50b677afec136b1eaea90895f07a735ae2801618baca16e6a2a19f"
    author      = "Moolakarapaiyan"

  strings:
    $a = { 00 6C 69 62 63 6F 6D 70 61 74 69 62 6C 65 2E 73 6F 00 }  // libcompatible.so
    $b = { 00 ?? 4C 63 6F 6D 2F 69 6E 63 61 2F 73 65 63 75
           72 69 74 79 2F 41 70 70 47 75 61 72 64 2F 78 43
           6C 61 73 73 3B 00 } // #Lcom/inca/security/AppGuard/xClass;

  condition:
    is_elf and any of them
}


rule dxshield_elf : packer
{
  meta:
    description = "DxShield"
    url         = "https://www.nshc.net/home/mobile-security/gxshield/"
    sample      = "64351853f9f1bcaa32598b6d2ecf97097a00989213defa31fb9b3abbba52a445" // com.wemade.nightcrowsglobal v1.0.28
    author      = "Eduardo Novella"

  strings:
    $lib = { 00 6C 69 62 64 78 62 61 73 65 2E 73 6F 00 4C 49 42 43 00 }  // libdxbase.so

  condition:
    is_elf and all of them
}

rule zimperium_zshield : packer
{
  meta:
    description = "Zimperium (zShield)"
    url         = "https://www.zimperium.com/zshield"
    sample      = "9512c46d99cdca1914a9f86870aa1c49845701abe1c63365ba2681d658c19941" // com.dbs.dbspaylah v6.2.0
    author      = "Eduardo Novella"

  strings:
    /**
        while ( linux_eabi_syscall(__NR_mprotect, v7, v203, 5) == -4 )

        do
            v96 = linux_eabi_syscall(v95, v218, v252, (void *)(int)(v91 + 209), v92, v93, v94, (void *)0xC4A0A48FLL);
        while ( v96 == -4 );

        do
            v114 = (unsigned int *)linux_eabi_syscall(__NR_mmap, 0LL, v113, 3, 34, -1, 0LL);
        while ( v114 == (unsigned int *)-4LL );
    */
    $svc = {
          01 00 00 D4   // SVC             0
          1F 10 00 B1   // CMN             X0, #4
    }

    /**
        void init_proc()
        {
        __int64 v0;

        v0 = sub_F208();
        __asm { BR              X0 }
        }
    */
    $init_proc = {
          FE 77 BD A9    //    STP             X30, X29, [SP,#var_30]!
          E0 07 01 A9    //    STP             X0, X1, [SP,#0x30+var_20]
          E2 4F 02 A9    //    STP             X2, X19, [SP,#0x30+var_10]
          ?? 00 00 94    //    BL              sub_F208
          00 00 1F D6    //    BR              X0
    }

    /**
      while ( linux_eabi_syscall(__NR_mprotect, (void *)address, length, 5) == M_MMAP_MAX )
        ;
      ...
      for ( i = 4 << (StatusReg & 0xF); v33 < v31; v33 += v32 )
        __asm { DC              CVAU, X13 }
      __dsb(0xBu);
      for ( j = address & -(__int64)i; j < v31; j += i )
        __asm { IC              IVAU, X12 }
      __dsb(0xBu);
      __isb(0xFu);
    */
    $asm_opcodes = {
        ?? 7B 0B D5    //  DC              CVAU, X12
        ?? ?? ?? 8B    //  ADD             X12, X12, X11
        ?? ?? ?? EB    //  CMP             X12, X8
        ?? ?? ?? 54    //  B.CC            loc_4A924
        [4-32]
        9F 3B 03 D5    // DSB             ISH
        [4-64]
        ?? 75 0B D5    // IC              IVAU, X9
        [4-32]
        9F 3B 03 D5    // DSB             ISH
        DF 3F 03 D5    // ISB
    }

  condition:
    elf.machine == elf.EM_AARCH64 and all of them
}

rule zimperium_zshield_a : packer
{
  meta:
    description = "Zimperium (zShield)"
    url         = "https://www.zimperium.com/zshield"
    sample      = "967d78d489363eee74e86f1b3e2b04d5614dd1d50437ba36b0f898ad802f290d" // com.medtronic.diabetes.minimedmobile.eu
    author      = "Eduardo Novella"

  strings:
    /**
        while ( linux_eabi_syscall(__NR_mprotect, v7, v203, 5) == -4 )

        do
            v96 = linux_eabi_syscall(v95, v218, v252, (void *)(int)(v91 + 209), v92, v93, v94, (void *)0xC4A0A48FLL);
        while ( v96 == -4 );

        do
            v114 = (unsigned int *)linux_eabi_syscall(__NR_mmap, 0LL, v113, 3, 34, -1, 0LL);
        while ( v114 == (unsigned int *)-4LL );
    */
    $svc = {
          01 00 00 D4   // SVC             0
          1F 10 00 B1   // CMN             X0, #4
    }

    /**
        do
            v11 = linux_eabi_syscall(__NR_getpid);
        while ( v11 == -4 );
        do
            v13 = linux_eabi_syscall(__NR_socket, 1, 0x80001, 0);
        while ( v13 == -4 );
    */
    $inline_svc = {
        E0 03 1F AA  //  MOV             X0, XZR
        88 15 80 52  //  MOV             W8, #__NR_getpid
        E1 03 1F AA  //  MOV             X1, XZR
        E2 03 1F AA  //  MOV             X2, XZR
        E3 03 1F AA  //  MOV             X3, XZR
        E4 03 1F AA  //  MOV             X4, XZR
        E5 03 1F AA  //  MOV             X5, XZR
        01 00 00 D4  //  SVC             0
        1F 10 00 B1  //  CMN             X0, #4
        [0-8]        //  B.EQ            loc_197BDC
        E9 03 00 AA  //  MOV             X9, X0
        21 00 80 52  //  MOV             W1, #1
        20 00 80 52  //  MOV             W0, #1
        C8 18 80 52  //  MOV             W8, #__NR_socket
        [4]          //  MOVK            W1, #8,LSL#16
        E2 03 1F AA  //  MOV             X2, XZR
        E3 03 1F AA  //  MOV             X3, XZR
        E4 03 1F AA  //  MOV             X4, XZR
        E5 03 1F AA  //  MOV             X5, XZR
        01 00 00 D4  //  SVC             0
        1F 10 00 B1  //  CMN             X0, #4
    }

    /**
    case 26:
        v17 = v65 - 1922710401;
        v18 = v63 ^ 0x8D57AB8A;
        a4 = v64 - 2041001190;
        a5 = v64 + 1700658760;
        a6 = (void *)(v63 - 1055835315);
        v19 = (void *)(int)(v63 ^ 0x8D57ABBC);
        a2 = (int)(v65 - 1922710401);
        do
        {
          a3 = (__int64)v61;
          a1 = linux_eabi_syscall(v18, v19, (void *)v17, v61, (void *)a4, (void *)a5, a6, a7);
        }
        while ( a1 == -4 );

    */
    $obf_svc = {
        ?? ?? ?? 93  //  SXTW            X9, W8
        ?? ?? ?? 93  //  SXTW            X1, W12
        ?? ?? ?? 93  //  SXTW            X8, W11
        [0-24]
        E0 03 09 AA  // MOV             X0, X9
        [0-8]
        01 00 00 D4  //  SVC             0
        1F 10 00 B1  //  CMN             X0, #4
    }

  condition:
    elf.machine == elf.EM_AARCH64 and ( $inline_svc or $obf_svc) and #svc > 50
}

rule nesun_elf : packer
{
  meta:
    description = "Nesun"
    url         = "http://nesun.cn"
    sample      = "13735b73994231e25393a1847e1111c9741cc112315b3f0d4f775a62ab58ae5d"
    author      = "Abhi"

  strings:
    $origin = { 00 2F 64 61 74 61 2F 64 61 74 61 2F 25 73 2F 2E 7A 70 72 6F 74 65 63 74 2F 25 73 2F 6F 72 69 67 69 6E 2E 61 70 6B 00 }  // /data/data/%s/.zprotect/%s/origin.apk
    $data_path = { 00 2F 64 61 74 61 2F 64 61 74 61 2F 25 73 2F 2E 7A 70 72 6F 74 65 63 74 00 } // /data/data/%s/.zprotect
    $name = { 00 2E 7A 70 72 6F 74 65 63 74 00 } // .zprotect
    $lib = { 00 6C 69 62 7A 70 72 6F 74 65 63 74 2E 73 6F 00 } // libzprotect.so

  condition:
    is_elf and any of them
}

rule gpresto_elf : packer
{
  meta:
    description = "G-Presto (anti-cheat)"
    url         = "https://www.largosoft.co.kr/"
    sample      = "44558c6c758b1ecf42ecda9981240d50c32f42e0d2be4693e37e39f8eb3a3488"
    author      = "Abhi"

  strings:
    $class = { 00 [0-2] 4C 63 6F 6D 2F 62 69 73 68 6F 70
               73 6F 66 74 2F 50 72 65 73 74 6F 2F 53 44 4B
               2F 50 72 65 73 74 6F 3B 00 } // .()Lcom/bishopsoft/Presto/SDK/Presto;.
    $name  = { 00 6C 69 62 41 54 47 5F 4C 2E 73 6F 00 } // libATG_L.so
    $name2 = { (00 | 20) 47 2D 50 72 65 73 74 6F (20 | 00) } // G-Presto
    $name3 = "\x00<Presto_E>\x00"
    $name4 = "\x00largosoft.co.kr\x00"

  condition:
    is_elf
    and $class
    and 2 of ($name*)
}

rule kiwisec_elf : packer
{
  meta:
    description = "KiwiSec"
    url         = "https://en.kiwisec.com/"
    sample      = "d108652bd1b685765e3ada2b7376e3c3ff67f8162afcf8bad91e0aef79b7b08a"
    author      = "Abhi"

  strings:
    $string  = "\x00kiwi_dumper\x00"
    $string2 = "\x00libKwProtectSDK.so\x00"
    $string3 = "\x00libkwsdataenc.so\x00"
    $string4 = "\x00libkiwicrash.so\x00"

    $class  = { 00 63 6F 6D 2F 6B 69 77 69 73 65 63 2F 63 72 61 73
                68 2F 4E 61 74 69 76 65 48 61 6E 64 6C 65 72 00 } // com/kiwisec/crash/NativeHandler
    $class2 = { 00 63 6F 6D 2F 6B 69 77 69 73 65 63 2F 63 72 61 73
                68 2F 43 72 61 73 68 55 74 69 6C 73 00 } // com/kiwisec/crash/CrashUtils

  condition:
    is_elf
    and any of them
}

rule tso_trusteer_sdk : packer
{
  meta:
    description = "Trusteer SDK (TSO) (to be verified!)"
    url         = "https://www.ibm.com/products/trusteer-mobile-sdk"
    sample      = "0cfebe91e6579b292c5ac58f0be6f129eff71f74282ccabb1c4578e341c01388" // uk.co.santander.santanderUK v5.18
    author      = "Eduardo Novella"

  condition:
    is_elf
        and for any i in (0..elf.number_of_segments): (elf.segments[i].type == elf.PT_LOAD)
        and for 2 i in (0..elf.number_of_sections):
            (elf.sections[i].name matches /(\.tsotext|\.tsodata|\.gnu\.version\_x|\.gnu\.version\_y)/)
}

```

`apkid/rules/elf/protectors.yara`:

```yara
/*
 * Copyright (C) 2023  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

import "elf"
include "common.yara"

rule whitecryption_elf : protector
{
  // https://github.com/rednaga/APKiD/issues/177
  meta:
    description = "WhiteCryption"
    sample      = "6821bce73b3d1146ef7ec9a2d91742a7f6fc2f8206ca9354d3d553e1b5d551a7"
    url         = "https://www.intertrust.com/products/application-shielding/"
    author      = "Tim 'diff' Strazzere"

  strings:
    // Currently, it injects the init stub into all classes, so this is a reasonable thing
    // to search for
    $init_stub = "scpClassInit"
    $empty_func = "SCP_EmptyFunction"
    $init_proc_stub = {
        // PUSH {R0-R2,R4,R11,LR}
        17 48 2D E9
        // BL sub_B500
        58 00 00 EB
        // BX R0
        10 FF 2F E1
    }

  condition:
    is_elf and (($init_stub or $empty_func) or $init_proc_stub)
}

rule whitecryption_elf_a : protector
{
  meta:
    description = "WhiteCryption"
    sample      = "a9926158f16d57072940c001a5ef06e4bf600f98d9ca9daeec202f71caa3d7b2"
    url         = "https://www.intertrust.com/products/application-shielding/"
    author      = "Eduardo Novella"

  strings:
    $wcskbox = "whiteCryptionSecureKeyBox"
    $jni     = "Java_com_whitecryption_skb_"
    $libname = "libSecureKeyBoxJava.so"

  condition:
    is_elf and 1 of them
}

rule ahnlab_v3_engine : anti_root
{
  meta:
    description  = "Ahnlab V3 Engine"
    sample1      = "638bad9c6336049f43ac88d7db65c743d9703d732f86f2dc094999b195d63aa2"
    sample2      = "87487409f9fb2f8a2c086f3476a5020c12bea4f18356b45e89c09007791c62fb"
    sample3      = "fc48d65f27b3231db4c068ddc4a63c5ca68843c42b2e989dd626ea6aa2f52b66"
    url          = "https://www.ahnlab.com/en"
    author       = "whoa-mi"

  strings:
    $entry = "engmgr_startRootCheck"

  condition:
    is_elf and all of them
}

rule appdome_elf : protector
{
  // https://github.com/rednaga/APKiD/issues/151
  meta:
    description = "Appdome"
    sample      = "1c6496f1cc8c5799539ee24170c371e8a57547e2eb73c9502c98ff78f44c74cf"
    url         = "https://www.appdome.com/"
    author      = "Tim 'diff' Strazzere"

  strings:
    // Currently these are exported symbols and work across all abi's
    $ad_start = "__start_adinit"
    $ad_stop = "__stop_adinit"
    $hook_start = "__start_hook"
    $hook_stop = "__stop_hook"
    $ipcent_start = "__start_ipcent"
    $ipcent_stop = "__stop_ipcent"

  condition:
    is_elf and (
      ($ad_start and $ad_stop) or
      ($hook_start and $hook_stop) or
      ($ipcent_start and $ipcent_stop)
    )
}

rule appdome_elf_a : protector
{
  meta:
    description = "Appdome"
    sample      = "0143ddce30b16890180cfa71c49520bde4cce706762f4da756e8c4d06283a481"
    url         = "https://www.appdome.com/"
    author      = "Eduardo Novella"

  condition:
    is_elf and not appdome_elf and
      // Match at least 2 section names from hook,.hookname,adinit,.adi,ipcent,ipcsel
      for 2 i in (0..elf.number_of_sections):
        (elf.sections[i].name matches /^(hook|\.hookname|adinit|\.adi|ipcent|ipcsel|\.rhash|\.imtab)$/)
}

rule metafortress : protector
{
  meta:
    description = "InsideSecure MetaFortress"
    url         = "https://www.insidesecure.com/Products/Application-Protection/Software-Protection/Code-Protection"
    sample      = "326632f52eba45609f825ab6746037f2f2b47bfe66fd1aeebd835c8031f4fdb0"
    author      = "Eduardo Novella"

  strings:
    $a = { 00 4d65 7461 466f 7274 7265 7373 3a20 2573 0025 733a 2025 730a 00 } // MetaFortress %s.%s: %s
    $b = { 00 4d65 7461 466f 7274 7265 7373 00 } // MetaFortress
    $c = { 00 4d45 5441 464f 5249 4300 0000 0000 0000 } // "METAFORIC"
    $d = { 00 4a61 7661 5f63 6f6d 5f69 6e73 6964 6573 6563 7572 655f 6863 655f } // Java_com_insidesecure_hce_internal_MatrixHCENativeBridge_

  condition:
    is_elf and (($a and $b) or $c or $d)
}

rule virbox_elf : protector
{
  meta:
    description = "Virbox"
    url         = "https://shell.virbox.com"
    sample      = "dcbe15f9f9e44690e200c04a2aefd15107e5beeafb2eab6d07be85b9f0a42435"
    author      = "Eduardo Novella"

  strings:
    $brand = {  5669 7262 6f78 2050 726f 7465 6374 6f72 0000 } // Virbox Protector

  condition:
    is_elf and $brand
}

rule vkey_elf : protector
{
  meta:
    description = "Vkey (V-OS App Protection)"
    url         = "https://www.v-key.com/products/v-os-app-protection/"
    author      = "Eduardo Novella"
    sample      = "00b745b7c8314c395afa3b01aa24db6e7453c15f19175b7f987988c8b27faa15"

  strings:
    $libname    = "libvosWrapperEx.so"
    $detection1 = "***** FRIDA DETECTED *****"
    $detection2 = "Error creating frida tcp file scan thread"
    $detection3 = "GDB detected!"
    $detection4 = "run_frida_port_scan: reseting map"
    $detection5 = "Error creating emulator detection thread"
    $detection6 = "start_debugger_check"
    $detection7 = "startEmulatorCheck"
    $detection8 = "app_integrity_check_jni: "
    $vos1       = "V-OS.debug"
    $vos2       = "********** V-Key %s: V-OS Firmware Version %d.%d.%d.%d *********"
    $vos3       = "********** V-Key %s: V-OS Firmware (%s) Version %d.%d.%d.%d ****"
    $vos4       = "********** V-Key Release SDK: V-OS Processor"
    $jni1       = "Java_vkey_android_vos_VosWrapper_"
    $jni2       = "Java_vkey_android_vos_VosWrapper_initVOSJNI"
    $jni3       = "Java_vkey_android_vos_VosWrapper_getVADefaultPath"
    $jni4       = "Java_vkey_android_vos_VosWrapper_registerCallback"
    $jni5       = "Java_vkey_android_vos_VosWrapper_setVADefaultPath"

  condition:
    is_elf and $libname and 1 of ($vos*) and 1 of ($detection*) and 1 of ($jni*)
}

rule verimatrix_arm64 : protector
{
  meta:
    description = "InsideSecure Verimatrix"
    url         = "https://www.verimatrix.com/products/app-shield/"
    sample      = "88cb73fbc7371a7ef0ef0efc99c0fcaf129d5fc21bfca8bb5c318dff8f227fcc" // Package: com.bcp.bank.bcp v3.0.4
    author      = "Eduardo Novella"

  strings:
    // Potential crash via division by zero
    // Sample contains ~500 break instructions  (other sample ~80)
    $brk_0_3e8 = {
      00 7D 20 D4   // BRK  #0x3E8
    }

    // Inlined syscall with obfuscated _NR_SYSCALL
    // Payment HCE app sample contains 2.6k inlined syscalls (other sample ~150)
    $svc_0 = {
      01 00 00 D4   // SVC  0
    }

  condition:
    elf.machine == elf.EM_AARCH64
    and #svc_0 >= 50
    and #brk_0_3e8 >= 50
    and for any i in (0..elf.number_of_segments): (elf.segments[i].type == elf.PT_LOAD)
    and for any i in (0..elf.number_of_segments): (elf.segments[i].type == elf.PT_NULL)
    and not for any i in (0..elf.number_of_sections): (elf.sections[i].name == ".text")
}

rule verimatrix_arm64_a : protector
{
  meta:
    description = "InsideSecure Verimatrix"
    url         = "https://www.verimatrix.com/products/app-shield/"
    sample      = "edb939d77adba5ef5c536c352a4bc25a3a5ff2fe15408c5af9f08b5af583224c" // dk.mitid.app.android v2.3.7
    author      = "Eduardo Novella"

  strings:
    /**
      .mfrt:0000000000AFCC98             ; Segment type: Pure data
      .mfrt:0000000000AFCC98                             AREA .mfrt, DATA
      .mfrt:0000000000AFCC98                             ; ORG 0xAFCC98
      .mfrt:0000000000AFCC98 04 EC 82 5F+                DCQ 0x4BDB66335F82EC04
      .mfrt:0000000000AFCCA0 FA 45 E6 0C                 DCD 0xCE645FA
      .mfrt:0000000000AFCCA0             ; .mfrt         ends
    */

    // Sample contains 25 inlined syscalls
    $svc_0 = {
      01 00 00 D4   // SVC  0
    }

    /**
      do
        {
          __asm { SYS             #3, c7, c11, #1, X12 }
          i += c;
        }
        while ( i < len );
      }
      v30 = (unsigned int)(4 << (StatusReg & 0xF));
      v31 = v3 & -v30;
      __dsb(0xBu);
      for ( ; v31 < len; v31 += v30 )
        __asm { SYS             #3, c7, c5, #1, X10 }
      __isb(0xFu);
      ret = ((__int64 (__fastcall *)(_QWORD *))v3)(v33);
      linux_eabi_syscall(__NR_munmap, (void *)v3, 0x4000u);
    */
    $asm_sys_dsb_isb = {
      2C 7B 0B D5   // SYS #3, c7, c11, #1, X12
      [12-64]
      9F 3B 03 D5   // DSB ISH
      [0-32]
      2A 75 0B D5   // SYS #3, c7, c5, #1, X10
      [12-64]
      DF 3F 03 D5   // ISB
    }

    // "libsdfgebg.so"
    $libname = /lib[a-z]{6,14}\.so/

  condition:
    elf.machine == elf.EM_AARCH64
    and $asm_sys_dsb_isb
    and $libname
    and #svc_0 >= 15
    and for any i in (0..elf.number_of_segments): (elf.segments[i].type == elf.PT_LOAD)
    and for any i in (0..elf.number_of_sections): (elf.sections[i].name matches /\.mfrt/)
}

rule verimatrix_arm64_b : protector
{
  meta:
    description = "InsideSecure Verimatrix"
    url         = "https://www.verimatrix.com/products/app-shield/"
    sample      = "e5acdf85e32675bed3cb8aa43fdfbc42117d7bee74f180db86db23e09895db9d" // dk.mitid.app.android
    author      = "Eduardo Novella"

  strings:
    /**
    if ( v14 < v3 + 0x3FFF )
    {
      do
      {
        __asm { DC              CVAU, X12 }
        v14 += v12;
      }
      while ( v14 < (unsigned __int64)v13 );
    }
    __dsb(0xBu);
    v19 = (unsigned int)(4 << (StatusReg & 0xF));
    for ( j = v3 & -v19; j < (unsigned __int64)v13; j += v19 )
      __asm { IC              IVAU, X10 }
    __dsb(0xBu);
    __isb(0xFu);
    v4 = ((__int64 (__fastcall *)(_QWORD *))v3)(v23);
    v21 = linux_eabi_syscall(__NR_munmap, v5, 0x4000u);
    */
    $asm_dc_dsb_ic_isb = {
      2C 7B 0B D5  // DC   CVAU, X12
      [12-32]
      9F 3B 03 D5  // DSB  ISH
      [12-32]
      2A 75 0B D5  // IC   IVAU, X10
      [12-32]
      DF 3F 03 D5  // ISB
    }

    /**
        v3 = (unsigned __int64)linux_eabi_syscall(__NR_mmap, 0, 0x4000u, 7, 34, -1, 0);
    */
    $svc_mmap = {
        ?? 03 1F AA // MOV  X11, XZR
        ?? 1B 80 52 // MOV  W12, #0xDE
        ?? 00 88 52 // MOV  W13, #0x4000
        ?? 00 80 52 // MOV  W14, #7
        ?? 04 80 52 // MOV  W15, #0x22
        [4-32]
        01 00 00 D4 // SVC 0
    }
    /**
        linux_eabi_syscall(__NR_munmap, v5, 0x4000u);
    */
    $svc_munmap = {
        ?? 1A 80 52  //  MOV   W11, #0xD7
        ?? 00 88 52  //  MOV   W12, #0x4000
        [4-32]
        01 00 00 D4  //  SVC   0
    }

    $s_jnionload = { 004a 4e49 5f4f 6e4c 6f61 6400 } // JNI_OnLoad

  condition:
    elf.machine == elf.EM_AARCH64 and all of them
    and for any i in (0..elf.number_of_segments): (elf.segments[i].type == elf.PT_LOAD)
}

rule verimatrix_arm64_c : protector
{
  meta:
    description = "InsideSecure Verimatrix"
    url         = "https://www.verimatrix.com/products/app-shield/"
    sample      = "41aab8bad66ab3ee47d8133488084e87abd271e2865d5715fb36269d967a2571"
    author      = "FrenchYeti"

  strings:
    // byte sequence from .rodata, used into JNI_OnLoad
    /**
      void sub_AD1468()
        {
          _QWORD v0[2]; // [xsp+40h] [xbp-A1480h] BYREF
          int v1; // [xsp+50h] [xbp-A1470h]
          int v2; // [xsp+54h] [xbp-A146Ch]
          _QWORD v3[2]; // [xsp+60h] [xbp-A1460h] BYREF
          __int64 v4; // [xsp+70h] [xbp-A1450h]
          _QWORD v5[2]; // [xsp+80h] [xbp-A1440h] BYREF
          int v6; // [xsp+90h] [xbp-A1430h]
          int v7; // [xsp+94h] [xbp-A142Ch]
          char v8[660496]; // [xsp+A8h] [xbp-A1418h] BYREF
          __int64 v9; // [xsp+A14B8h] [xbp-8h]

          v9 = *(_QWORD *)(_ReadStatusReg(ARM64_SYSREG(3, 3, 13, 0, 2)) + 40);
          v5[1] = v5;
          v7 = 0xB8A89888;
          v5[0] = v5;
          v4 = 0xB8A89888BCAC9C8BLL;
          v3[0] = v3;
          v3[1] = v3;
          v0[0] = v3;
          v0[1] = v0;
          v2 = 0xB8A89888;
          v6 = 1;
          v1 = 0;
          sub_ADCB58(v8, 0LL, 0xA1410LL);
          LODWORD(v4) = 1;
          JUMPOUT(0xAD1524LL);
        }
    */
    $rodata_pattern = {
      ?? ?? ?? ?? 88 98 a8 b8
      ?? ?? ?? ?? 94 a4 b4 c4
      ?? ?? ?? ?? 88 98 a8 b8
      ?? ?? ?? ?? 94 a4 b4 c4
    }

    // common pattern
    $opcodes = {
      ?3 ?? ?? 54 //  b.cc    ??
      29 0d ?0 12 //  and     w9, w9, #0xf
      49 21 c9 1a //  lsl     w9, w10, w9
      ea 03 09 cb //  neg     x10, x9
      ?a 0? ?? 8a //  and     x10, ??, ??
      5f 01 ?? eb //  cmp     x10, ??
      9f 3b 03 d5 //  dsb     ISH
      ?2 ?? ?? 54 //  b.cs    ??
      2a 75 0b d5 //  ic      x10
      4a 01 09 8b //  add     x10, x10, x9
      5f 01 ?? eb //  cmp     x10, ??
      ?3 ?? ?? 54 //  b.cc    ??
      [0-4]
      df 3f 03 d5 //  isb
    }

  condition:
    elf.machine == elf.EM_AARCH64
    and all of them
    and not verimatrix_arm64_a
}

rule protectt : protector
{
  meta:
    description = "Protectt"
    sample      = "c246d85560599f91e9c3ed7e59df2dd4e21aaf667f3f2965c28c43d9842f5e75" // com.rblbank.mobank
    url         = "https://www.protectt.ai"
    author      = "Eduardo Novella"

  strings:
    $lib1 = "libprotectt-native-lib.so"
    $lib2 = "libprotecttai.so"
    $lib3 = "libapp-protectt-native-lib.so"

  condition:
    is_elf and 1 of them
}

rule googleIntegrityProtection : protector
{
  meta:
    description = "Google Play Integrity"
    url         = "https://developer.android.com/games/playgames/integrity"
    sample      = "607e256868c012dda10aaff07fdd24928d86122c715078406fb21aae7a2b8a44"
    author      = "Eduardo Novella"

    strings:
      $export_jnionload      = { 004a 4e49 5f4f 6e4c 6f61 6400 } // JNI_OnLoad
      $export_jnionunload    = { 004a 4e49 5f4f 6e55 6e6c 6f61 6400 } // JNI_OnUnLoad
      $export_ExecuteProgram = { 00  4578 6563 7574 6550 726f 6772 616d 00  } // ExecuteProgram
      $lib_name              = { 00 6c69 6270 6169 7269 7063 6f72  652e 736f 00} // libpairipcore.so

    condition:
      is_elf and all of them
}

rule ahope_appshield : protector
{
    meta:
        description = "Ahope AppShield"
        url         = "http://www.ahope.net/sub/app-shields"
        sample      = "42a4d907caf625ff73d5b6fbbf32b59ba14d6d5a72f28b81bdc76c47db516122"
        author      = "dustty0 & Eduardo Novella"

    strings:
      $lib = {
        00 6c69 6261 686f 7065 [0-2] 2e73 6f00  // .libahope.so.
      }

    condition:
      is_elf and any of them
}


rule appcamo : protector
{
    meta:
        description = "AppCamo"
        url         = "http://appcamo.com/s2/s2_1.php"
        sample      = "b8bf8e44eff2f4557f050d19534624dc3df5053f7793eb409b98c18c475d969b"
        author      = "dustty0 & Eduardo Novella"

    strings:
      $log = { 00 6170 7063 616d 6f 00} // .appcamo.
      $lib = { 00 6c69 6261 6c69 622e 736f 00} // .libalib.so.
      $lod = { 00 6461 6c76 696b 2f73 7973 7465 6d2f 4465 7843 6c61 7373 4c6f 6164 6572 00} // dalvik/system/DexClassLoader

    condition:
      is_elf and 2 of them
}

rule appsealing : protector
{
    meta:
        description = "Appsealing"
        url         = "https://www.appsealing.com/"
        sample      = "803b7b1e25fa879438ebb31e7f8bbcc7292ecda9750bdd0266e589fe4469bc10" // com.drishti.academy.app
        author      = "Eduardo Novella"

    strings:
      // .libcovault-appsec.so.
      $str1 = { 00 6c69 6263 6f76 6175 6c74 2d61 7070 7365 632e 736f 00 }
      // .%s/appsealing.dex.
      $str2 = { 00 2573 2f61 7070 7365 616c 696e 672e 6465 7800 }
      // .APPSEALING-CORE-VERSION_
      $str3 = { 00 4150 5053 4541 4c49 4e47 2d43 4f52 452d 5645 5253 494f 4e5f }
      $str4 = {        00 284c 616e 6472 6f69 642f 636f  //    .(Landroid/co
                6e74 656e 742f 436f 6e74 6578 743b 4c63  // ntent/Context;Lc
                6f6d 2f69 6e6b 612f 6170 7073 6561 6c69  // om/inka/appseali
                6e67 2f41 7070 5365 616c 696e 6741 7070  // ng/AppSealingApp
                6c69 6361 7469 6f6e 3b4c 6a61 7661 2f6c  // lication;Ljava/l
                616e 672f 436c 6173 734c 6f61 6465 723b  // ang/ClassLoader;
                4c61 6e64 726f 6964 2f63 6f6e 7465 6e74  // Landroid/content
                2f72 6573 2f41 7373 6574 4d61 6e61 6765  // /res/AssetManage
                723b 4c6a 6176 612f 6c61 6e67 2f53 7472  // r;Ljava/lang/Str
                696e 673b 4c6a 6176 612f 6c61 6e67 2f53  // ing;Ljava/lang/S
                7472 696e 673b 4c6a 6176 612f 6c61 6e67  // tring;Ljava/lang
                2f53 7472 696e 673b 294c 6a61 7661 2f6c  // /String;)Ljava/l
                616e 672f 5374 7269 6e67 3b00            // ang/String;.
    }
    $str5 = {  00 636f 6d2f 696e 6b61 2f61 7070 // ....com/inka/app
        7365 616c 696e 672f 4170 7053 6561 6c69 // sealing/AppSeali
        6e67 4170 706c 6963 6174 696f 6e00      // ngApplication...
    }
    $str6 = {          49 6e69 7469 6174 6520  //  .......Initiate
      4170 7053 6561 6c69 6e67 2053 6563 7572  // AppSealing Secur
      6974 7920 3a20 4152 4d36 3420 2843 6f72  // ity : ARM64 (Cor
      6520 5665 7273 696f 6e20 3d20 2573 2900  // e Version = %s).
    }

    condition:
      is_elf and 2 of them
}

rule zimperium_zdefend : protector
{
    meta:
        description = "Zimperium (zDefend)"
        url         = "https://www.zimperium.com/zdefend/"
        sample      = "9512c46d99cdca1914a9f86870aa1c49845701abe1c63365ba2681d658c19941" // com.dbs.dbspaylah.apk v6.2.0
        author      = "Eduardo Novella"

    strings:
      $lib = { 00 6c69 625a 4465 6665 6e64 2e73 6f00 } // .libZDefend.so.
      $zimperium = "zimperium"

    condition:
      is_elf and $lib and #zimperium > 10
}

rule zimperium_z9 : protector
{
    meta:
        description = "Zimperium (z9)"
        url         = "https://www.zimperium.com/machine-learning-z9-technology"
        sample      = "ed2f6935a4420034ec8dade23ec458ef1440c5021402c142e0b020308e0145fc" // com.chase.sig.android v4.484
        author      = "Eduardo Novella"

    strings:
      $lib = { 00 6c69 627a 392e73 6f00 } // .libz9.so.
      $zimperium = "zimperium"

    condition:
      is_elf and $lib and #zimperium > 10
}

rule zimperium_zcloud : protector
{
    meta:
        description = "Zimperium (zcloud)"
        url         = "https://www.zimperium.com/zdefend"
        sample      = "ed2f6935a4420034ec8dade23ec458ef1440c5021402c142e0b020308e0145fc" // com.chase.sig.android v4.484
        author      = "Eduardo Novella"

    strings:
      $lib = { 006c 6962 7a63 6c6f 7564 2e73  6f00 } // .libzcloud.so.
      $zimperium = "zimperium"

    condition:
      is_elf and $lib and #zimperium > 10
}

rule msa_sdk : protector
{
  meta:
      description = "MSA SDK"
      url         = "http://msa-alliance.cn"
      sample      = "fe4afda0c51fa08237859c3b14c2b35bd2c2a65d098a57857454f0ace354ad45" // tv.danmaku.bili
      author      = "Abhi"

  strings:
    $string  = "mprotect"
    $libs    = { 00 6C 69 62 6D 73 61 6F 61 69 64 (61 75 74 68 | 73 65 63 ) 2E 73 6F 00 }  // .libmsaoaidauth.so. || .libmsaoaidsec.so.

  condition:
    is_elf and all of them
}

rule nhn_appguard : protector
{
  meta:
      description = "NHN AppGuard"
      url         = "https://www.nhncloud.com/kr/service/security/nhn-appguard"
      sample      = "bafa2a9acf4af696b92e0a1ddcf7f470d49a7f3bc27b5c1b1e3ecbdf17049285" // jp.pjfb
      author      = "Abhi"

  strings:
    $payload = { (00 ?? | ??) 61 70 70 67 75 61 72 64 5F 68 65 61 64 65
                 72 2D 3E 47 65 74 (45 6E 63 72 79 70 74 65 64 | 4F 72
                 69 67 69 6E 61 6C) 50 61 79 6C 6F 61 64 4C 65 6E 67 74
                 68 28 29 } // appguard_header->Get(Encrypted|Original)PayloadLength()
    $class   = /\d{2}ComNhnentAppguardAppguardJavaClass(Impl)?\x00/
    $class2  = /\d{2}AppGuardCallbackJavaClass(Impl)?\x00/
    $str_app = { 00 28 28 61 70 70 67 75 61 72 64 5F 61 70 70 6C 69 63 61 74
                 69 6F 6E 5F 29 29 20 (3D | 21) 3D 20 28 6E 75 6C 6C 70 74 72 29 } // .((appguard_application_)) (=|!)= (nullptr)
    $lib     = { 00 6C 69 62 6C 6F 61 64 65 72 2E 73 6F 00 } // .libloader.so.

  condition:
    is_elf and any of ($class*) and ( $lib or $str_app or $payload )
}

rule easyprotector : protector
{
  meta:
      description = "EasyProtector"
      url         = "https://github.com/lamster2018/EasyProtector"
      sample      = "788ebabd9b5464c5e86b3832e4a7b6e7c91cce5603ff17f214429400ba3bb2b9" // net.crigh.cgsport
      author      = "Abhi"

  strings:
    $lib  = "\x00libantitrace.so\x00"
    $log  = "\x00I was be traced...trace pid:%d\x00"
    $log2 = "\x00ptrace myself...\x00"

  condition:
    is_elf and all of them
}

rule rootbeer: anti_root
{
  meta:
    description = "RootBeer"
    url         = "https://github.com/scottyab/rootbeer.git"
    sample      = "607ec962ba93cc9817129cb693ff0f335f500a297b5a297e71fbb998d0f6849c" // com.scottyab.rootbeer.sample
    author      = "Abhi"

  strings:
    $class = { 00 4A 61 76 61 5F 63 6F 6D 5F [-] 5F 72 6F 6F 74 62 65 65 72
               5F 52 6F 6F 74 42 65 65 72 4E 61 74 69 76 65 5F 63 68 65 63
               6B 46 6F 72 52 6F 6F 74 00 } // Java_com_scottyab_rootbeer_RootBeerNative_checkForRoot
    $lib   = { 00 6C 69 62 74 6F 6F 6C 43 68 65 63 6B 65 72 2E 73 6F 00 } // libtoolChecker.so
    $name  = { 00 52 6F 6F 74 42 65 65 72 00 } // RootBeer

  condition:
    is_elf and 2 of them
}

rule build38 : protector
{
  meta:
    description = "Build38"
    url         = "https://build38.com"
    sample      = "cfbbfca598a9877a381583a7ae2f9e8cde92e7314b21152658bcba5a4e3a0fff" // com.esignus.hashwalletmanager
    author      = "Abhi"

  strings:
    $lib   = { 00 6C 69 62 74 61 6B 2E 73 6F 00 } // libtak.so
    $class = { 4C 63 6F 6D 2F 62 75 69 6C 64 33 38 2F 74 61 6B 2F 4E 61 74 69 76 65 52 65 73 70 6F 6E 73 65 3B 00 } // Lcom/build38/tak/NativeResponse;

  condition:
    is_elf and any of them
}

rule dpt_shell : protector
{
  meta:
    description = "DPT Shell"
    url         = "https://github.com/luoyesiqiu/dpt-shell"
    sample      = "0c4341700f4e685cafc9c86c9112098b75057580ba1f7163bc971347af3712ad"
    author      = "Abhi"

  strings:
    $libname = "\x00libdpt.so\x00"
    $bhook   = "\x00bytehook_tag\x00"

  condition:
    is_elf and
    any of them and
    for any i in (0 .. elf.number_of_sections): (
      elf.sections[i].name == ".bitcode"
    )
}

rule free_rasp_dart : protector
{
  meta:
    description = "FreeRASP"
    url         = "https://www.talsec.app/freerasp-in-app-protection-security-talsec"
    sample      = "b1f8b110ef85e6a90b000ec625be2a51e6bf7fa8d17859f158f06bfe0078beb4" // net.corepass.app
    author      = "Eduardo Novella"

  strings:
    $s1 = "\x00package:freerasp/src/errors/talsec_exception.dart\x00"
    $s2 = "\x00package:freerasp/src/models/talsec_config.dart\x00"
    $s3 = "\x00package:freerasp/src/talsec.dart\x00"
    $s4 = "\x00talsec-failure\x00"
    $s5 = "\x00TalsecException\x00"
    $s6 = "\x00TalsecController\x00"

  condition:
    is_dart and any of them
}

rule shield_sdk : protector
{
  meta:
    description = "Shield SDK"
    url         = "https://shield.com/"
    sample      = "fb4b7f033658b3898e0448955491b448a2c78e1a2325c65fece6ad64f6f6b6d0" // com.mpl.androidapp
    author      = "Abhi"

  strings:
    $lib   = { 00 6C 69 62 63 61 73 68 73 68 69 65 6C 64 61 62
               63 2D 6E 61 74 69 76 65 2D 6C 69 62 2E 73 6F 00 } // libcashshieldabc-native-lib.so
    $class = { 00 63 6F 6D 2F 73 68 69 65 6C 64 2F 61 6E 64 72
               6F 69 64 2F 69 6E 74 65 72 6E 61 6C 2F 4E 61 74
               69 76 65 55 74 69 6C 73 00 } // com/shield/android/internal/NativeUtils

  condition:
    is_elf and all of them
}

rule bugsmirror : protector
{
  meta:
    description = "BugsMirror"
    url         = "https://www.bugsmirror.com/"
    sample      = "c9bbf66ac86bf02663b7bc28a735881d4aeaa8d90e9b8b752e9cf337a26f0bdd"
    author      = "Abhi"

  strings:
    // libdefender.so as dependency of libsettings.so doesn't starts with null-byte
    $name  = { 6C 69 62 64 65 66 65 6E 64 65 72 2E 73 6F 00 } // libdefender.so

  condition:
    is_elf and
    all of them and
    for any i in (0 .. elf.number_of_sections): (
      elf.sections[i].name == ".crypted"
    )
}

rule bshield : protector
{
  meta:
    description = "BShield"
    url         = "https://bshield.io/"
    sample      = "f54fa5cfcd9a5d14a947bbd93bc7bb59e8c2b1b23cc5bcc84c66ad0143e55201"
    author      = "Abhi"

  strings:
    $class  = { 00 4C 69 6F 2F 62 73 68 69 65 6C 64 2F 63 61 6C
                6C 62 61 63 6B 2F 53 68 69 65 6C 64 44 61 74 61
                50 72 6F 74 65 63 74 69 6F 6E 3B 00 } // Lio/bshield/callback/ShieldDataProtection;
    $class2 = { 00 69 6F 2F 62 73 68 69 65 6C 64 2F 63 61 6C 6C
                62 61 63 6B 2F 53 68 69 65 6C 64 44 61 74 61 50
                72 6F 74 65 63 74 69 6F 6E 00 } // io/bshield/callback/ShieldDataProtection

  condition:
    is_elf and any of them
}

rule denuvo_elf : protector
{
  meta:
    description = "Denuvo"
    url         = "https://irdeto.com/denuvo/anti-tamper"
    sample      = "f7d1cd97b5d61da16b804daf6cd1199fe822745f9066596988d30a934441f6fc"
    author      = "Abhi"


  strings:
    $libvmpc = "\x00libvmpc.so\x00"

  condition:
    is_elf and all of them
}

rule bureau : protector
{
  meta:
    description = "Bureau"
    url         = "https://bureau.id"
    sample      = "484d8d0f4eb2c2ed66770edfa0ab89bf76f9b84227faea3889ce74b2af8cbbc4"
    author      = "Abhi, ApkUnpacker"

  strings:
    $lib  = /lib(bureau\-.*|secure_keys|ndkdatacollector)\.so/
    $cm   = { 00 4A 61 76 61 5F 63 6F 6D 5F 62 75 72 65 61 75 5F
              63 68 65 63 6B 52 6F 6F 74 5F 56 65 72 69 66 79 52
              6F 6F 74 4E 61 74 69 76 65 5F 63 68 65 63 6B 46 6F
              72 52 6F 6F 74 00 } // Java_com_bureau_checkRoot_VerifyRootNative_checkForRoot
    $cm2  = { 00 4A 61 76 61 5F 63 6F 6D 5F 62 75 72 65 61 75 5F
              64 65 76 69 63 65 66 69 6E 67 65 72 70 72 69 6E 74
              5F 73 65 63 75 72 69 74 79 5F 53 65 63 75 72 65 4A
              4E 49 5F 67 65 74 4B 65 79 00 } // Java_com_bureau_devicefingerprint_security_SecureJNI_getKey
    $cm3  = { 00 4A 61 76 61 5F 63 6F 6D 5F 62 75 72 65 61 75 5F
              64 65 76 69 63 65 66 69 6E 67 65 72 70 72 69 6E 74
              5F 74 6F 6F 6C 73 5F 4E 44 4B 4D 61 70 70 65 72 73
              5F 63 68 65 63 6B 46 72 69 64 61 00 } // Java_com_bureau_devicefingerprint_tools_NDKMappers_checkFrida

  condition:
    is_elf and any of them
}

```

`apkid/rules/res/common.yara`:

```yara
/*
 * Copyright (C) 2024  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

rule is_res : file_type
{
  meta:
    description = "RES"

  strings:
    // Common patterns in resources.arsc (package ID, resource type,..)
    $magic = { 02 00 0C 00 }
    $type1 = { 01 00 1C 00 }
    $type2 = { 03 00 00 00 }
    $type3 = { 00 02 00 00 }

  condition:
    $magic at 0 and 1 of ($type*)
}


```

`apkid/rules/res/obfuscators.yara`:

```yara
/*
 * Copyright (C) 2024  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

include "common.yara"

rule mtprotector_res : obfuscator
{
  meta:
    description = "MT Protector"
    url         = "https://mt2.cn/download/"
    sample      = "462475fb14ef7b979d1102a61d334cffcdcfc24183be37af868d1dc681bc7126"
    author      = "Eduardo Novella"

  strings:
    $sign = {
      0000 0c0c                         // extra bytes
      4d54 5f50 726f 7465 6374 6f72 00  // ..MT_Protector.
    }

  condition:
    is_res and all of them
}

```

`apkid/rules/res/protectors.yara`:

```yara
/*
 * Copyright (C) 2024  RedNaga. https://rednaga.io
 * All rights reserved. Contact: rednaga@protonmail.com
 *
 *
 * This file is part of APKiD
 *
 *
 * Commercial License Usage
 * ------------------------
 * Licensees holding valid commercial APKiD licenses may use this file
 * in accordance with the commercial license agreement provided with the
 * Software or, alternatively, in accordance with the terms contained in
 * a written agreement between you and RedNaga.
 *
 *
 * GNU General Public License Usage
 * --------------------------------
 * Alternatively, this file may be used under the terms of the GNU General
 * Public License version 3.0 as published by the Free Software Foundation
 * and appearing in the file LICENSE.GPL included in the packaging of this
 * file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 * information to ensure the GNU General Public License version 3.0
 * requirements will be met.
 *
 **/

include "common.yara"

rule bugsmirror : protector
{
    meta:
      description = "BugsMirror"
      url         = "https://www.bugsmirror.com/"
      sample      = "c9bbf66ac86bf02663b7bc28a735881d4aeaa8d90e9b8b752e9cf337a26f0bdd"
      author      = "Abhi"

    strings:
      $comment  = { 00 ?? ?? 53 65 63 75 72 65 64 20 62 79 20
                    42 75 67 73 6D 69 72 72 6F 72 00 } // Secured by Bugsmirror
      $comment2 = { ?? 73 65 63 75 72 65 64 5F 62 79 5F 62 75
                    67 73 6D 69 72 72 6F 72 00 } // secured_by_bugsmirror

    condition:
      is_res and any of them
}
```

`docker/apkid.sh`:

```sh
#!/usr/bin/env bash

# This will simply take the argument passed to it,
# parse the directory and bind it as a read-only mount point on the container
# and pass in the filename as the argument to APKiD
#
# This can easily be set to an alias and added to your .profile or whatever

FILES=()
ARGS=()

for arg in "$@"; do
    if [[ -e "$arg" ]]; then
        FILES+=("$arg")
    else
        ARGS+=("$arg")
    fi
done

if [[ ${#FILES[@]} -eq 0 ]]; then
    docker run --rm -i rednaga:apkid "${ARGS[@]}"
    exit 0
fi

FIRST_FILE="${FILES[0]}"
INPUT_DIR=$(cd "$(dirname "$FIRST_FILE")" && pwd -P)

MAPPED_FILES=()
for file in "${FILES[@]}"; do
    MAPPED_FILES+=("/input/$(basename "$file")")
done

docker run --rm --volume "$INPUT_DIR":/input:ro -i rednaga:apkid "${ARGS[@]}" "${MAPPED_FILES[@]}"

```

`prep-release.py`:

```py
#!/usr/bin/env python
"""
 Copyright (C) 2023  RedNaga. https://rednaga.io
 All rights reserved. Contact: rednaga@protonmail.com


 This file is part of APKiD


 Commercial License Usage
 ------------------------
 Licensees holding valid commercial APKiD licenses may use this file
 in accordance with the commercial license agreement provided with the
 Software or, alternatively, in accordance with the terms contained in
 a written agreement between you and RedNaga.


 GNU General Public License Usage
 --------------------------------
 Alternatively, this file may be used under the terms of the GNU General
 Public License version 3.0 as published by the Free Software Foundation
 and appearing in the file LICENSE.GPL included in the packaging of this
 file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 information to ensure the GNU General Public License version 3.0
 requirements will be met.
"""

import os
import sys
from codecs import open
from typing import Dict, Set

from apkid.output import colorize_tag
from apkid.rules import RulesManager


def convert_readme():
    print("[*] Converting Markdown README to reStructuredText")
    import pypandoc
    rst = pypandoc.convert_file('README.md', 'rst')
    with open('README.rst', 'w+', encoding='utf-8') as f:
        f.write(rst)
    print(f"[*] Finished converting to README.rst ({len(rst)} bytes)")


if __name__ == '__main__':
    print("[*] Compiling Yara files")
    rules_manager = RulesManager()
    rules = rules_manager.compile()
    rules_count = rules_manager.save()
    print(f"[*] Saved {rules_count} rules to {rules_manager.rules_path}")
    print(f"[*] Rules hash: {rules_manager.hash}")

    tag_to_identifiers: Dict[str, Set[str]] = {}
    for rule in rules:
        for t in rule.tags:
            if t not in tag_to_identifiers:
                tag_to_identifiers[t] = set()
            tag_to_identifiers[t].add(rule.identifier)
    tag_counts = dict([(k, len(v)) for k, v in tag_to_identifiers.items()])
    print("[*] Rule tag counts:")
    for tag in sorted(tag_counts.keys()):
        count = tag_counts[tag]
        if sys.stdout.isatty():
            print(f" |-> {colorize_tag(tag)}: {count}")
        else:
            print(f" |-> {tag}: {count}")

    if len(sys.argv) > 1:
        if sys.argv[1] == 'register':
            print("[*] Registering ...")
            os.system('python setup.py register')
        if sys.argv[1] == 'readme':
            convert_readme()

    print("[*] Finished preparing APKiD for release.")

```

`setup.cfg`:

```cfg
[bdist_wheel]
universal=1

[metadata]
description-file = README.md

```

`setup.py`:

```py
#!/usr/bin/env python
"""
 Copyright (C) 2023  RedNaga. https://rednaga.io
 All rights reserved. Contact: rednaga@protonmail.com


 This file is part of APKiD


 Commercial License Usage
 ------------------------
 Licensees holding valid commercial APKiD licenses may use this file
 in accordance with the commercial license agreement provided with the
 Software or, alternatively, in accordance with the terms contained in
 a written agreement between you and RedNaga.


 GNU General Public License Usage
 --------------------------------
 Alternatively, this file may be used under the terms of the GNU General
 Public License version 3.0 as published by the Free Software Foundation
 and appearing in the file LICENSE.GPL included in the packaging of this
 file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 information to ensure the GNU General Public License version 3.0
 requirements will be met.
"""

from codecs import open
from os import path, walk

from setuptools import setup, find_packages

import apkid

here = path.abspath(path.dirname(__file__))

with open(path.join(here, 'README.rst'), encoding='utf-8') as f:
    long_description = f.read()


def package_files(directory):
    paths = []
    for (filepath, directories, filenames) in walk(directory):
        for filename in filenames:
            paths.append(path.join(filepath, filename))
    return paths


install_requires = [
    'yara-python-dex>=1.0.1',
]

dev_requires = [
    'mypy',
    'pypandoc',
    'twine',
]

test_requires = [
    'delayed-assert',
    'factory_boy',
    'mock',
    'pytest',
    'pytest-cov',
    'pytest-factoryboy',
    'pytest-flask',
    'pytest-runner',
    'tox',
]

setup(
    name=apkid.__title__,
    version=apkid.__version__,
    description="Android Package Identifier",
    long_description=long_description,
    url='https://github.com/rednaga/APKiD',
    author=apkid.__author__,
    author_email='rednaga@protonmail.com',
    license=apkid.__license__,
    classifiers=[
        'Development Status :: 5 - Production/Stable',
        'Environment :: Console',
        'Intended Audience :: Science/Research',
        'License :: OSI Approved :: GNU General Public License v3 (GPLv3)',
        'License :: Other/Proprietary License',
        'Natural Language :: English',
        'Programming Language :: Python :: 3.6',
        'Programming Language :: Python :: 3.7',
        'Topic :: Security',
        'Topic :: Utilities',
    ],
    keywords='android analysis reversing malware apk dex dalvik',
    packages=find_packages(exclude=['docs', 'tests']),
    package_data={
        'rules': package_files('apkid/rules/'),
    },
    include_package_data=True,
    install_requires=install_requires,
    extras_require={
        'dev': dev_requires,
        'test': test_requires,
    },
    zip_safe=False,
    entry_points={
        'console_scripts': [
            'apkid=apkid.main:main',
        ],
    },
)

```

`tests/conftest.py`:

```py
"""
 Copyright (C) 2023  RedNaga. https://rednaga.io
 All rights reserved. Contact: rednaga@protonmail.com


 This file is part of APKiD


 Commercial License Usage
 ------------------------
 Licensees holding valid commercial APKiD licenses may use this file
 in accordance with the commercial license agreement provided with the
 Software or, alternatively, in accordance with the terms contained in
 a written agreement between you and RedNaga.


 GNU General Public License Usage
 --------------------------------
 Alternatively, this file may be used under the terms of the GNU General
 Public License version 3.0 as published by the Free Software Foundation
 and appearing in the file LICENSE.GPL included in the packaging of this
 file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 information to ensure the GNU General Public License version 3.0
 requirements will be met.
"""

import yara

import pytest

from apkid.apkid import Scanner, Options
from apkid.rules import RulesManager


@pytest.fixture
def rules_manager():
    return RulesManager()


@pytest.fixture
def options():
    return Options()


@pytest.fixture
def rules():
    return yara.compile(source='rule dummy { condition: true }')


@pytest.fixture
def scanner(rules: yara.Rules, options):
    return Scanner(rules=rules, options=options)

```

`tests/factories.py`:

```py
"""
 Copyright (C) 2023  RedNaga. https://rednaga.io
 All rights reserved. Contact: rednaga@protonmail.com


 This file is part of APKiD


 Commercial License Usage
 ------------------------
 Licensees holding valid commercial APKiD licenses may use this file
 in accordance with the commercial license agreement provided with the
 Software or, alternatively, in accordance with the terms contained in
 a written agreement between you and RedNaga.


 GNU General Public License Usage
 --------------------------------
 Alternatively, this file may be used under the terms of the GNU General
 Public License version 3.0 as published by the Free Software Foundation
 and appearing in the file LICENSE.GPL included in the packaging of this
 file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 information to ensure the GNU General Public License version 3.0
 requirements will be met.
"""

import io
import json
import os
import tempfile
import zipfile
from typing import Dict, Union, IO


def load_data(file_path: str, is_json: bool = False) -> Union[str, dict]:
    data_path = os.path.join(os.path.dirname(os.path.realpath(__file__)), 'data')
    full_path = os.path.join(data_path, file_path)
    with open(full_path, 'r') as f:
        data = f.read()

    if is_json:
        return json.loads(data)
    return data


def make_zip(entries: Dict[str, bytes]) -> io.BytesIO:
    memory_file = io.BytesIO()
    with zipfile.ZipFile(memory_file, 'a', zipfile.ZIP_DEFLATED) as zf:
        for name, content in entries.items():
            zf.writestr(name, content)

        for entry in zf.filelist:
            entry.create_system = 0
    memory_file.seek(0)
    return memory_file


def make_temp_zip(entries: Dict[str, bytes]) -> IO:
    with make_zip(entries) as file_obj:
        tz = tempfile.NamedTemporaryFile()
        tz.write(file_obj.read())
    tz.flush()
    return tz


def make_temp_file(content: bytes) -> IO:
    tz = tempfile.NamedTemporaryFile()
    tz.write(content)
    tz.flush()
    return tz

```

`tests/test_rules.py`:

```py
"""
 Copyright (C) 2023  RedNaga. https://rednaga.io
 All rights reserved. Contact: rednaga@protonmail.com


 This file is part of APKiD


 Commercial License Usage
 ------------------------
 Licensees holding valid commercial APKiD licenses may use this file
 in accordance with the commercial license agreement provided with the
 Software or, alternatively, in accordance with the terms contained in
 a written agreement between you and RedNaga.


 GNU General Public License Usage
 --------------------------------
 Alternatively, this file may be used under the terms of the GNU General
 Public License version 3.0 as published by the Free Software Foundation
 and appearing in the file LICENSE.GPL included in the packaging of this
 file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 information to ensure the GNU General Public License version 3.0
 requirements will be met.
"""

import warnings


def test_rules_compile(rules_manager):
    rules = rules_manager.compile()
    assert rules


def test_lint_rules(rules_manager):
    for r in rules_manager.compile():
        if len(r.tags) == 0:
            warnings.warn(f"rule has no tags: {r.identifier}", stacklevel=0)

        if 'description' not in r.meta:
            warnings.warn(f"rule has no description: {r.identifier}", stacklevel=0)

        if ('packer' in r.tags or 'protector' in r.tags or 'obfuscator' in r.tags) \
                and 'sample' not in r.meta:
            warnings.warn(f"rule has no reference sample: {r.identifier}", stacklevel=0)

```

`tests/test_scanner.py`:

```py
"""
 Copyright (C) 2023  RedNaga. https://rednaga.io
 All rights reserved. Contact: rednaga@protonmail.com


 This file is part of APKiD


 Commercial License Usage
 ------------------------
 Licensees holding valid commercial APKiD licenses may use this file
 in accordance with the commercial license agreement provided with the
 Software or, alternatively, in accordance with the terms contained in
 a written agreement between you and RedNaga.


 GNU General Public License Usage
 --------------------------------
 Alternatively, this file may be used under the terms of the GNU General
 Public License version 3.0 as published by the Free Software Foundation
 and appearing in the file LICENSE.GPL included in the packaging of this
 file. Please visit http://www.gnu.org/copyleft/gpl.html and review the
 information to ensure the GNU General Public License version 3.0
 requirements will be met.
"""

from apkid.apkid import Scanner
from .factories import make_temp_zip, make_temp_file, make_zip


def test_scan_with_dummy_zip(scanner: Scanner):
    zip_entries = {'dummy': b'hello'}
    with make_temp_zip(zip_entries) as tz:
        results = scanner.scan_file(tz.name)

    assert tz.name in results
    assert len(results) == 1
    assert len(results[tz.name]) > 0


def test_scan_with_unscannable_file(scanner: Scanner):
    with make_temp_file(b'hello') as tz:
        results = scanner.scan_file(tz.name)

    assert len(results) == 0


def test_scan_with_zip_with_dex(scanner: Scanner):
    zip_entries = {'classes.dex': b'dex\nnot a real dex!'}
    with make_temp_zip(zip_entries) as tz:
        results = scanner.scan_file(tz.name)

    for key in (tz.name, f'{tz.name}!classes.dex'):
        assert key in results
        assert len(results[key]) > 0


def test_scan_with_nested_zips(scanner: Scanner):
    third_layer = {
        '3.dex': b'dex\n'
    }
    second_layer = {
        '3.zip': make_zip(third_layer).read(),
        '2.dex': b'dex\n',
    }
    first_layer = {
        '2.zip': make_zip(second_layer).read(),
        '1.dex': b'dex\n',
    }
    zero_layer = {
        '1.zip': make_zip(first_layer).read(),
        '0.dex': b'dex\n',
    }

    scanner.options.scan_depth = 2
    with make_temp_zip(zero_layer) as tz:
        results = scanner.scan_file(tz.name)

    for key in (
            tz.name, f'{tz.name}!0.dex', f'{tz.name}!1.zip', f'{tz.name}!1.zip!1.dex', f'{tz.name}!1.zip!2.zip',
            f'{tz.name}!1.zip!2.zip!2.dex', f'{tz.name}!1.zip!2.zip!3.zip'
    ):
        assert key in results
        assert len(results[key]) > 0

```