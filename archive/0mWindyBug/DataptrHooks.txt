Project Path: arc_0mWindyBug_DataptrHooks_5x8oenae

Source Tree:

```txt
arc_0mWindyBug_DataptrHooks_5x8oenae
├── NtConvertBetweenAuxiliaryCounterAndPerformanceCounterHook
│   ├── DataptrHook
│   │   ├── DataptrHook.vcxproj
│   │   ├── DataptrHook.vcxproj.filters
│   │   ├── DataptrHook.vcxproj.user
│   │   ├── main.cpp
│   │   └── x64
│   │       └── Release
│   │           ├── DataptrHook.exe.recipe
│   │           ├── DataptrHook.iobj
│   │           ├── DataptrHook.ipdb
│   │           ├── DataptrHook.log
│   │           └── vc143.pdb
│   ├── DataptrHook.sln
│   ├── DataptrHookDriver
│   │   ├── DataptrHookDriver.inf
│   │   ├── DataptrHookDriver.vcxproj
│   │   ├── DataptrHookDriver.vcxproj.filters
│   │   ├── defs.h
│   │   ├── main.cpp
│   │   └── x64
│   │       └── Release
│   │           ├── DataptrHookDriver.inf
│   │           ├── DataptrHookDriver.log
│   │           ├── DataptrHookDriver.sys.recipe
│   │           └── vc143.pdb
│   └── x64
│       └── Release
│           ├── DataptrHook.pdb
│           ├── DataptrHookDriver
│           │   ├── DataptrHookDriver.inf
│           │   ├── DataptrHookDriver.sys
│           │   └── dataptrhookdriver.cat
│           ├── DataptrHookDriver.cer
│           ├── DataptrHookDriver.inf
│           ├── DataptrHookDriver.pdb
│           └── DataptrHookDriver.sys
├── README.md
└── SeQueryCodeIntegrityHook
    ├── SeCodeIntegrityQueryHookDriver
    │   ├── SeCodeIntegrityQueryHookDriver.inf
    │   ├── SeCodeIntegrityQueryHookDriver.vcxproj
    │   ├── SeCodeIntegrityQueryHookDriver.vcxproj.filters
    │   ├── defs.h
    │   ├── main.c
    │   └── x64
    │       └── Release
    │           ├── SeCodeIntegrityQueryHookDriver.inf
    │           ├── SeCodeIntegrityQueryHookDriver.log
    │           ├── SeCodeIntegrityQueryHookDriver.sys.recipe
    │           └── vc143.pdb
    ├── SeQueryCodeIntegrityHook
    │   ├── SeQueryCodeIntegrityHook.vcxproj
    │   ├── SeQueryCodeIntegrityHook.vcxproj.filters
    │   ├── SeQueryCodeIntegrityHook.vcxproj.user
    │   ├── main.cpp
    │   └── x64
    │       └── Release
    │           ├── SeQueryCodeIntegrityHook.exe.recipe
    │           ├── SeQueryCodeIntegrityHook.iobj
    │           ├── SeQueryCodeIntegrityHook.ipdb
    │           ├── SeQueryCodeIntegrityHook.log
    │           └── vc143.pdb
    ├── SeQueryCodeIntegrityHook.sln
    └── x64
        └── Release
            ├── SeCodeIntegrityQueryHookDriver
            │   ├── SeCodeIntegrityQueryHookDriver.inf
            │   ├── SeCodeIntegrityQueryHookDriver.sys
            │   └── secodeintegrityqueryhookdriver.cat
            ├── SeCodeIntegrityQueryHookDriver.cer
            ├── SeCodeIntegrityQueryHookDriver.inf
            ├── SeCodeIntegrityQueryHookDriver.pdb
            ├── SeCodeIntegrityQueryHookDriver.sys
            └── SeQueryCodeIntegrityHook.pdb

```

`NtConvertBetweenAuxiliaryCounterAndPerformanceCounterHook/DataptrHook.sln`:

```sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.2.32505.173
MinimumVisualStudioVersion = 10.0.40219.1
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "DataptrHook", "DataptrHook\DataptrHook.vcxproj", "{230D7FA2-9284-4724-8926-980552209CC1}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "DataptrHookDriver", "DataptrHookDriver\DataptrHookDriver.vcxproj", "{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|ARM64 = Debug|ARM64
		Debug|x64 = Debug|x64
		Debug|x86 = Debug|x86
		Release|ARM64 = Release|ARM64
		Release|x64 = Release|x64
		Release|x86 = Release|x86
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{230D7FA2-9284-4724-8926-980552209CC1}.Debug|ARM64.ActiveCfg = Debug|x64
		{230D7FA2-9284-4724-8926-980552209CC1}.Debug|ARM64.Build.0 = Debug|x64
		{230D7FA2-9284-4724-8926-980552209CC1}.Debug|x64.ActiveCfg = Debug|x64
		{230D7FA2-9284-4724-8926-980552209CC1}.Debug|x64.Build.0 = Debug|x64
		{230D7FA2-9284-4724-8926-980552209CC1}.Debug|x86.ActiveCfg = Debug|Win32
		{230D7FA2-9284-4724-8926-980552209CC1}.Debug|x86.Build.0 = Debug|Win32
		{230D7FA2-9284-4724-8926-980552209CC1}.Release|ARM64.ActiveCfg = Release|x64
		{230D7FA2-9284-4724-8926-980552209CC1}.Release|ARM64.Build.0 = Release|x64
		{230D7FA2-9284-4724-8926-980552209CC1}.Release|x64.ActiveCfg = Release|x64
		{230D7FA2-9284-4724-8926-980552209CC1}.Release|x64.Build.0 = Release|x64
		{230D7FA2-9284-4724-8926-980552209CC1}.Release|x86.ActiveCfg = Release|Win32
		{230D7FA2-9284-4724-8926-980552209CC1}.Release|x86.Build.0 = Release|Win32
		{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}.Debug|ARM64.ActiveCfg = Debug|ARM64
		{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}.Debug|ARM64.Build.0 = Debug|ARM64
		{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}.Debug|ARM64.Deploy.0 = Debug|ARM64
		{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}.Debug|x64.ActiveCfg = Debug|x64
		{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}.Debug|x64.Build.0 = Debug|x64
		{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}.Debug|x64.Deploy.0 = Debug|x64
		{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}.Debug|x86.ActiveCfg = Debug|x64
		{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}.Debug|x86.Build.0 = Debug|x64
		{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}.Debug|x86.Deploy.0 = Debug|x64
		{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}.Release|ARM64.ActiveCfg = Release|ARM64
		{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}.Release|ARM64.Build.0 = Release|ARM64
		{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}.Release|ARM64.Deploy.0 = Release|ARM64
		{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}.Release|x64.ActiveCfg = Release|x64
		{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}.Release|x64.Build.0 = Release|x64
		{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}.Release|x64.Deploy.0 = Release|x64
		{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}.Release|x86.ActiveCfg = Release|x64
		{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}.Release|x86.Build.0 = Release|x64
		{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}.Release|x86.Deploy.0 = Release|x64
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {779DE40D-B823-484D-8C97-685741FD7E7C}
	EndGlobalSection
EndGlobal

```

`NtConvertBetweenAuxiliaryCounterAndPerformanceCounterHook/DataptrHook/DataptrHook.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <Keyword>Win32Proj</Keyword>
    <ProjectGuid>{230d7fa2-9284-4724-8926-980552209cc1}</ProjectGuid>
    <RootNamespace>DataptrHook</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="main.cpp" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`NtConvertBetweenAuxiliaryCounterAndPerformanceCounterHook/DataptrHook/DataptrHook.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;c++;cppm;ixx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;h++;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="main.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`NtConvertBetweenAuxiliaryCounterAndPerformanceCounterHook/DataptrHook/DataptrHook.vcxproj.user`:

```user
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="Current" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup />
</Project>
```

`NtConvertBetweenAuxiliaryCounterAndPerformanceCounterHook/DataptrHook/main.cpp`:

```cpp
#include <Windows.h>
#include <iostream>

PVOID(NTAPI* NtConvertBetweenAuxiliaryCounterAndPerformanceCounter)(ULONG64, PVOID, PVOID, PVOID);
typedef struct _HOOK_DATA
{
	DWORD Magic;
	int ControlCode;
}HOOK_DATA, * PHOOK_DATA;


int main()
{
	std::cout << "[*] resolving NtConvertBetweenAuxiliaryCounterAndPerformanceCounter from ntdll.dll" << std::endl;
	*(PVOID*)&NtConvertBetweenAuxiliaryCounterAndPerformanceCounter = GetProcAddress(GetModuleHandle(L"ntdll.dll"), "NtConvertBetweenAuxiliaryCounterAndPerformanceCounter");
	if (!NtConvertBetweenAuxiliaryCounterAndPerformanceCounter)
	{
		std::cerr << "[*} failed to resolve NtConvertBetweenAuxiliaryCounterAndPerformanceCounter" << std::endl;
		return -1;
	}
	std::cout << "[*] resolved NtConvertBetweenAuxiliaryCounterAndPerformanceCounter" << std::endl;

	std::cout << "[*} sending command to driver" << std::endl;
	HOOK_DATA Data;
	Data.Magic = 0x77FF77FF;
	Data.ControlCode = 7;
	PVOID pData = (PVOID)&Data;
	INT64 Status = 0;

	NtConvertBetweenAuxiliaryCounterAndPerformanceCounter(1, &pData, &Status, 0);




	return 0; 
}
```

`NtConvertBetweenAuxiliaryCounterAndPerformanceCounterHook/DataptrHook/x64/Release/DataptrHook.exe.recipe`:

```recipe
<?xml version="1.0" encoding="utf-8"?>
<Project>
  <ProjectOutputs>
    <ProjectOutput>
      <FullPath>C:\Users\dorge\source\repos\DataptrHook\x64\Release\DataptrHook.exe</FullPath>
    </ProjectOutput>
  </ProjectOutputs>
  <ContentFiles />
  <SatelliteDlls />
  <NonRecipeFileRefs />
</Project>
```

`NtConvertBetweenAuxiliaryCounterAndPerformanceCounterHook/DataptrHook/x64/Release/DataptrHook.log`:

```log
  main.cpp
  Generating code
  Previous IPDB not found, fall back to full compilation.
  All 11 functions were compiled because no usable IPDB/IOBJ from previous compilation was found.
  Finished generating code
  DataptrHook.vcxproj -> C:\Users\dorge\source\repos\DataptrHook\x64\Release\DataptrHook.exe

```

`NtConvertBetweenAuxiliaryCounterAndPerformanceCounterHook/DataptrHookDriver/DataptrHookDriver.inf`:

```inf
;
; DataptrHookDriver.inf
;

[Version]
Signature="$WINDOWS NT$"
Class=System
ClassGuid={4d36e97d-e325-11ce-bfc1-08002be10318}
Provider=%ManufacturerName%
DriverVer=
CatalogFile=DataptrHookDriver.cat
PnpLockdown=1

;This template is supported for OS version 17763 (Windows 10 version 1809) and after.
;For Windows OS prior to Windows 10 1809 set DefaultDestDir = 12
[DestinationDirs]
DefaultDestDir = 13


[SourceDisksNames]
1 = %DiskName%,,,""

[SourceDisksFiles]


[Manufacturer]

[Standard.NT$ARCH$]


[Strings]
ManufacturerName="<Your manufacturer name>" ;TODO: Replace with your manufacturer name
DiskName="DataptrHookDriver Source Disk"

```

`NtConvertBetweenAuxiliaryCounterAndPerformanceCounterHook/DataptrHookDriver/DataptrHookDriver.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|ARM64">
      <Configuration>Debug</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|ARM64">
      <Configuration>Release</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <ProjectGuid>{8176F7B8-7A81-4AAB-AEA2-DCCF75C57566}</ProjectGuid>
    <TemplateGuid>{dd38f7fc-d7bd-488b-9242-7d8754cde80d}</TemplateGuid>
    <TargetFrameworkVersion>v4.5</TargetFrameworkVersion>
    <MinimumVisualStudioVersion>12.0</MinimumVisualStudioVersion>
    <Configuration>Debug</Configuration>
    <Platform Condition="'$(Platform)' == ''">x64</Platform>
    <RootNamespace>DataptrHookDriver</RootNamespace>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="PropertySheets">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <DriverSign>
      <FileDigestAlgorithm>sha256</FileDigestAlgorithm>
    </DriverSign>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <DriverSign>
      <FileDigestAlgorithm>sha256</FileDigestAlgorithm>
    </DriverSign>
    <ClCompile>
      <TreatWarningAsError>false</TreatWarningAsError>
    </ClCompile>
  </ItemDefinitionGroup>
  <ItemGroup>
    <Inf Include="DataptrHookDriver.inf" />
  </ItemGroup>
  <ItemGroup>
    <FilesToPackage Include="$(TargetPath)" />
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="main.cpp" />
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="defs.h" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`NtConvertBetweenAuxiliaryCounterAndPerformanceCounterHook/DataptrHookDriver/DataptrHookDriver.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hpp;hxx;hm;inl;inc;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
    <Filter Include="Driver Files">
      <UniqueIdentifier>{8E41214B-6785-4CFE-B992-037D68949A14}</UniqueIdentifier>
      <Extensions>inf;inv;inx;mof;mc;</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <Inf Include="DataptrHookDriver.inf">
      <Filter>Driver Files</Filter>
    </Inf>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="main.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="defs.h">
      <Filter>Header Files</Filter>
    </ClInclude>
  </ItemGroup>
</Project>
```

`NtConvertBetweenAuxiliaryCounterAndPerformanceCounterHook/DataptrHookDriver/defs.h`:

```h
#pragma once
#include <ntifs.h>
#include <ntddk.h>
#include <ntimage.h>
#include <minwindef.h>
#include <intrin.h>
#include <ntddndis.h>
#include <strsafe.h>
#define NT_SUCCESS(Status) (((NTSTATUS)(Status)) >= 0)

typedef unsigned char BYTE, * PBYTE, * LPBYTE;



typedef struct _PEB_LDR_DATA {
	BYTE Reserved1[8];
	PVOID Reserved2[3];
	LIST_ENTRY InMemoryOrderModuleList;
} PEB_LDR_DATA, * PPEB_LDR_DATA;

typedef struct _RTL_DRIVE_LETTER_CURDIR
{
	USHORT Flags;
	USHORT Length;
	ULONG TimeStamp;
	UNICODE_STRING DosPath;
} RTL_DRIVE_LETTER_CURDIR, * PRTL_DRIVE_LETTER_CURDIR;

#define RTL_MAX_DRIVE_LETTERS 32

typedef struct _CURDIR
{
	UNICODE_STRING DosPath;
	HANDLE Handle;
} CURDIR, * PCURDIR;





typedef enum _DCMB_CALLBACK_TYPE {
	LoadImageCallback,
	ProcessCreationCallback,
	ThreadCreationCallback,
	ProcessObjectCreationCallback,
	ThreadObjectCreationCallback,
	RegistryCallback,
	DriverVerificationCallback
} DCMB_CALLBACK_TYPE;

typedef enum _SYSTEM_INFORMATION_CLASS {
	SystemBasicInformation = 0,
	SystemPerformanceInformation = 2,
	SystemTimeOfDayInformation = 3,
	SystemProcessInformation = 5,
	SystemProcessorPerformanceInformation = 8,
	SystemInterruptInformation = 23,
	SystemExceptionInformation = 33,
	SystemRegistryQuotaInformation = 37,
	SystemLookasideInformation = 45,
	SystemCodeIntegrityInformation = 103,
	SystemPolicyInformation = 134,
} SYSTEM_INFORMATION_CLASS;


typedef struct _KLDR_DATA_TABLE_ENTRY
{
	LIST_ENTRY InLoadOrderLinks;
	PVOID ExceptionTable;
	ULONG ExceptionTableSize;
	PVOID GpValue;
	PNON_PAGED_DEBUG_INFO NonPagedDebugInfo;
	PVOID DllBase;
	PVOID EntryPoint;
	ULONG SizeOfImage;
	UNICODE_STRING FullDllName;
	UNICODE_STRING BaseDllName;
	ULONG Flags;
	USHORT LoadCount;
	USHORT __Unused5;
	PVOID SectionPointer;
	ULONG CheckSum;
	PVOID LoadedImports;
	PVOID PatchInformation;
} KLDR_DATA_TABLE_ENTRY, * PKLDR_DATA_TABLE_ENTRY;

typedef struct _REGISTRY_CALLBACK_ITEM
{
	LIST_ENTRY Item;
	DWORD64 Unknown1[2];
	DWORD64 Context;
	DWORD64 Function;
	UNICODE_STRING Altitude;
	DWORD64 Unknown2[2];
} REGISTRY_CALLBACK_ITEM, * PREGISTRY_CALLBACK_ITEM;

typedef struct OB_CALLBACK_ENTRY_t {
	LIST_ENTRY CallbackList; // linked element tied to _OBJECT_TYPE.CallbackList
	OB_OPERATION Operations; // bitfield : 1 for Creations, 2 for Duplications
	BOOL Enabled;            // self-explanatory
	struct OB_CALLBACK_t* Entry;      // points to the structure in which it is included
	POBJECT_TYPE ObjectType; // points to the object type affected by the callback
	POB_PRE_OPERATION_CALLBACK PreOperation;      // callback function called before each handle operation
	POB_POST_OPERATION_CALLBACK PostOperation;     // callback function called after each handle operation
	KSPIN_LOCK Lock;         // lock object used for synchronization
} OB_CALLBACK_ENTRY, * POB_CALLBACK_ENTRY;

typedef struct _CALLBACK_OBJECT
{
	ULONG Signature;
	KSPIN_LOCK Lock;
	LIST_ENTRY RegisteredCallbacks;
	BOOLEAN AllowMultipleCallbacks;
	UCHAR reserved[3];
} CALLBACK_OBJECT;

typedef struct _CALLBACK_REGISTRATION
{
	LIST_ENTRY Link;
	PCALLBACK_OBJECT CallbackObject;
	PCALLBACK_FUNCTION CallbackFunction;
	PVOID CallbackContext;
	ULONG Busy;
	BOOLEAN UnregisterWaiting;
} CALLBACK_REGISTRATION, * PCALLBACK_REGISTRATION;



typedef NTSTATUS(NTAPI* PROTOTYPE_ZWQUERYSYSTEMINFORMATION)(SYSTEM_INFORMATION_CLASS info, PVOID infoinout, ULONG len, PULONG retLen);

typedef struct _RTL_PROCESS_MODULE_INFORMATION
{
	ULONG Section;
	PVOID MappedBase;
	PVOID ImageBase;
	ULONG ImageSize;
	ULONG Flags;
	USHORT LoadOrderIndex;
	USHORT InitOrderIndex;
	USHORT LoadCount;
	USHORT OffsetToFileName;
	CHAR FullPathName[256];
} RTL_PROCESS_MODULE_INFORMATION, * PRTL_PROCESS_MODULE_INFORMATION;

typedef struct _RTL_PROCESS_MODULES
{
	ULONG NumberOfModules;
	RTL_PROCESS_MODULE_INFORMATION Modules[1];
} RTL_PROCESS_MODULES, * PRTL_PROCESS_MODULES;

typedef struct _RTL_USER_PROCESS_PARAMETERS
{
	ULONG MaximumLength;	//6c0
	ULONG Length;//6c0
	ULONG Flags;//0
	ULONG DebugFlags;//0
	HANDLE ConsoleHandle;//NULL
	ULONG ConsoleFlags;//0
	HANDLE StandardInput;//NULL
	HANDLE StandardOutput;//NULL
	HANDLE StandardError;//NULL
	CURDIR CurrentDirectory;
	UNICODE_STRING DllPath;
	UNICODE_STRING ImagePathName;
	UNICODE_STRING CommandLine;
	PWSTR Environment;
	ULONG StartingX;
	ULONG StartingY;
	ULONG CountX;
	ULONG CountY;
	ULONG CountCharsX;
	ULONG CountCharsY;
	ULONG FillAttribute;
	ULONG WindowFlags;
	ULONG ShowWindowFlags;
	UNICODE_STRING WindowTitle;
	UNICODE_STRING DesktopInfo;
	UNICODE_STRING ShellInfo;
	UNICODE_STRING RuntimeData;
	RTL_DRIVE_LETTER_CURDIR CurrentDirectories[RTL_MAX_DRIVE_LETTERS];
#if (NTDDI_VERSION >= NTDDI_LONGHORN)
	SIZE_T EnvironmentSize;
#endif
#if (NTDDI_VERSION >= NTDDI_WIN7)
	SIZE_T EnvironmentVersion;
#endif
} RTL_USER_PROCESS_PARAMETERS, * PRTL_USER_PROCESS_PARAMETERS;


typedef struct _PEB {
	BYTE Reserved1[2];
	BYTE BeingDebugged;
	BYTE Reserved2[1];
	PVOID Reserved3[2];
	PPEB_LDR_DATA Ldr;
	PRTL_USER_PROCESS_PARAMETERS ProcessParameters;
	PVOID Reserved4[3];
	PVOID AtlThunkSListPtr;
	PVOID Reserved5;
	ULONG Reserved6;
	PVOID Reserved7;
	ULONG Reserved8;
	ULONG AtlThunkSListPtr32;
	PVOID Reserved9[45];
	BYTE Reserved10[96];
	PVOID PostProcessInitRoutine;
	BYTE Reserved11[128];
	PVOID Reserved12[1];
	ULONG SessionId;
} PEB, * PPEB;

// Modified LDR_DATA_TABLE_ENTRY definition (this one includes BaseDllName field and has InMemoryOrderLinks at the top for easier processing)
typedef struct _LDR_DATA_TABLE_ENTRY {
	/*LIST_ENTRY InLoadOrderLinks;*/
	LIST_ENTRY InMemoryOrderLinks;
	LIST_ENTRY InInitializationOrderList;
	PVOID DllBase;
	PVOID EntryPoint;
	PVOID Reserved3;
	UNICODE_STRING FullDllName;
	UNICODE_STRING BaseDllName;
} LDR_DATA_TABLE_ENTRY, * PLDR_DATA_TABLE_ENTRY;

typedef struct _TEB {
	PVOID Reserved1[12];
	PPEB ProcessEnvironmentBlock;
	PVOID Reserved2[399];
	BYTE Reserved3[1952];
	PVOID TlsSlots[64];
	BYTE Reserved4[8];
	PVOID Reserved5[26];
	PVOID ReservedForOle;  // Windows 2000 only
	PVOID Reserved6[4];
	PVOID TlsExpansionSlots;
} TEB, * PTEB;







/*
	NtCreateFile
*/
#define InitializeObjectAttributes( p, n, a, r, s ) { \
    (p)->Length = sizeof( OBJECT_ATTRIBUTES );          \
    (p)->RootDirectory = r;                             \
    (p)->Attributes = a;                                \
    (p)->ObjectName = n;                                \
    (p)->SecurityDescriptor = s;                        \
    (p)->SecurityQualityOfService = NULL;               \
    }

#define FILE_SYNCHRONOUS_IO_NONALERT	0x00000020

/*
	valid values for the attributes field
*/
#define OBJ_INHERIT                         0x00000002L
#define OBJ_PERMANENT                       0x00000010L
#define OBJ_EXCLUSIVE                       0x00000020L
#define OBJ_CASE_INSENSITIVE                0x00000040L
#define OBJ_OPENIF                          0x00000080L
#define OBJ_OPENLINK                        0x00000100L
#define OBJ_KERNEL_HANDLE                   0x00000200L
#define OBJ_FORCE_ACCESS_CHECK              0x00000400L
#define OBJ_IGNORE_IMPERSONATED_DEVICEMAP   0x00000800L
#define OBJ_DONT_REPARSE                    0x00001000L
#define OBJ_VALID_ATTRIBUTES                0x00001FF2



/*
	NtQueryInformationFile
*/


#define FileStandardInformation 5 // QUERY: FILE_STANDARD_INFORMATION



/*
	NtOpenProcess
*/


typedef struct _SYSTEM_PROCESS_INFO
{
	ULONG                   NextEntryOffset;
	ULONG                   NumberOfThreads;
	LARGE_INTEGER           Reserved[3];
	LARGE_INTEGER           CreateTime;
	LARGE_INTEGER           UserTime;
	LARGE_INTEGER           KernelTime;
	UNICODE_STRING          ImageName;
	ULONG                   BasePriority;
	HANDLE                  ProcessId;
	HANDLE                  InheritedFromProcessId;
}SYSTEM_PROCESS_INFO, * PSYSTEM_PROCESS_INFO;


/*
	NtCreateUserProcess
*/

#define RTL_USER_PROCESS_PARAMETERS_NORMALIZED   0x01

// ProcessFlags
#define PROCESS_CREATE_FLAGS_PROTECTED_PROCESS 0x00000040
#define PROCESS_CREATE_FLAGS_CREATE_SESSION 0x00000080 // ?
#define PROCESS_CREATE_FLAGS_INHERIT_FROM_PARENT 0x00000100
#define PROCESS_CREATE_FLAGS_SUSPENDED 0x00000200
#define PROCESS_CREATE_FLAGS_EXTENDED_UNKNOWN 0x00000400

// ThreadFlags
#define THREAD_CREATE_FLAGS_CREATE_SUSPENDED 0x00000001
#define THREAD_CREATE_FLAGS_SKIP_THREAD_ATTACH 0x00000002 // ?
#define THREAD_CREATE_FLAGS_HIDE_FROM_DEBUGGER 0x00000004
#define THREAD_CREATE_FLAGS_HAS_SECURITY_DESCRIPTOR 0x00000010 // ?
#define THREAD_CREATE_FLAGS_ACCESS_CHECK_IN_TARGET 0x00000020 // ?
#define THREAD_CREATE_FLAGS_INITIAL_THREAD 0x00000080
// end_rev

// windows-internals-book:"Chapter 5" 
typedef enum _PS_CREATE_STATE {
	PsCreateInitialState,
	PsCreateFailOnFileOpen,
	PsCreateFailOnSectionCreate,
	PsCreateFailExeFormat,
	PsCreateFailMachineMismatch,
	PsCreateFailExeName, // Debugger specified
	PsCreateSuccess,
	PsCreateMaximumStates
} PS_CREATE_STATE;

typedef struct _PS_CREATE_INFO {
	SIZE_T Size;
	PS_CREATE_STATE State;
	union {
		// PsCreateInitialState
		struct {
			union {
				ULONG InitFlags;
				struct {
					UCHAR WriteOutputOnExit : 1;
					UCHAR DetectManifest : 1;
					UCHAR IFEOSkipDebugger : 1;
					UCHAR IFEODoNotPropagateKeyState : 1;
					UCHAR SpareBits1 : 4;
					UCHAR SpareBits2 : 8;
					USHORT ProhibitedImageCharacteristics : 16;
				};
			};
			ACCESS_MASK AdditionalFileAccess;
		} InitState;

		// PsCreateFailOnSectionCreate
		struct {
			HANDLE FileHandle;
		} FailSection;

		// PsCreateFailExeFormat
		struct {
			USHORT DllCharacteristics;
		} ExeFormat;

		// PsCreateFailExeName
		struct {
			HANDLE IFEOKey;
		} ExeName;

		// PsCreateSuccess
		struct {
			union {
				ULONG OutputFlags;
				struct {
					UCHAR ProtectedProcess : 1;
					UCHAR AddressSpaceOverride : 1;
					UCHAR DevOverrideEnabled : 1; // from Image File Execution Options
					UCHAR ManifestDetected : 1;
					UCHAR ProtectedProcessLight : 1;
					UCHAR SpareBits1 : 3;
					UCHAR SpareBits2 : 8;
					USHORT SpareBits3 : 16;
				};
			};
			HANDLE FileHandle;
			HANDLE SectionHandle;
			ULONGLONG UserProcessParametersNative;
			ULONG UserProcessParametersWow64;
			ULONG CurrentParameterFlags;
			ULONGLONG PebAddressNative;
			ULONG PebAddressWow64;
			ULONGLONG ManifestAddress;
			ULONG ManifestSize;
		} SuccessState;
	};
} PS_CREATE_INFO, * PPS_CREATE_INFO;

// begin_rev
#define PS_ATTRIBUTE_NUMBER_MASK 0x0000ffff
#define PS_ATTRIBUTE_THREAD 0x00010000 // can be used with threads
#define PS_ATTRIBUTE_INPUT 0x00020000 // input only
#define PS_ATTRIBUTE_ADDITIVE 0x00040000 /// Is an additional option (see ProcThreadAttributeValue in WinBase.h)
// end_rev

typedef enum _PS_ATTRIBUTE_NUM {
	PsAttributeParentProcess, // in HANDLE
	PsAttributeDebugPort, // in HANDLE
	PsAttributeToken, // in HANDLE
	PsAttributeClientId, // out PCLIENT_ID
	PsAttributeTebAddress, // out PTEB
	PsAttributeImageName, // in PWSTR
	PsAttributeImageInfo, // out PSECTION_IMAGE_INFORMATION
	PsAttributeMemoryReserve, // in PPS_MEMORY_RESERVE
	PsAttributePriorityClass, // in UCHAR
	PsAttributeErrorMode, // in ULONG
	PsAttributeStdHandleInfo, // 10, in PPS_STD_HANDLE_INFO
	PsAttributeHandleList, // in PHANDLE
	PsAttributeGroupAffinity, // in PGROUP_AFFINITY
	PsAttributePreferredNode, // in PUSHORT
	PsAttributeIdealProcessor, // in PPROCESSOR_NUMBER
	PsAttributeUmsThread, // see UpdateProceThreadAttributeList in msdn (CreateProcessA/W...) in PUMS_CREATE_THREAD_ATTRIBUTES
	PsAttributeMitigationOptions, // in UCHAR
	PsAttributeProtectionLevel,
	PsAttributeSecureProcess, // since THRESHOLD (Virtual Secure Mode, Device Guard)
	PsAttributeJobList,
	PsAttributeMax
} PS_ATTRIBUTE_NUM;

#define PsAttributeValue(Number, Thread, Input, Additive) \
    (((Number) & PS_ATTRIBUTE_NUMBER_MASK) | \
    ((Thread) ? PS_ATTRIBUTE_THREAD : 0) | \
    ((Input) ? PS_ATTRIBUTE_INPUT : 0) | \
    ((Additive) ? PS_ATTRIBUTE_ADDITIVE : 0))

typedef struct _PS_ATTRIBUTE {
	ULONGLONG Attribute;				/// PROC_THREAD_ATTRIBUTE_XXX | PROC_THREAD_ATTRIBUTE_XXX modifiers, see ProcThreadAttributeValue macro and Windows Internals 6 (372)
	SIZE_T Size;						/// Size of Value or *ValuePtr
	union {
		ULONG_PTR Value;				/// Reserve 8 bytes for data (such as a Handle or a data pointer)
		PVOID ValuePtr;					/// data pointer
	};
	PSIZE_T ReturnLength;				/// Either 0 or specifies size of data returned to caller via "ValuePtr"
} PS_ATTRIBUTE, * PPS_ATTRIBUTE;

typedef struct _PS_ATTRIBUTE_LIST {
	SIZE_T TotalLength;					/// sizeof(PS_ATTRIBUTE_LIST)
	PS_ATTRIBUTE Attributes[2];			/// Depends on how many attribute entries should be supplied to NtCreateUserProcess
} PS_ATTRIBUTE_LIST, * PPS_ATTRIBUTE_LIST;
```

`NtConvertBetweenAuxiliaryCounterAndPerformanceCounterHook/DataptrHookDriver/main.cpp`:

```cpp
#include "defs.h"
#include <ntddk.h>

#define DATA_PTR_OFFSET 0x0000000000c00928

PVOID g_OriginalAddress = nullptr;
PVOID* g_DataPtr = nullptr;

typedef INT64(*NtConvertBetweenAuxiliaryCounterAndPerformanceCounterPtr)(PVOID, PVOID, PVOID);

typedef struct _HOOK_DATA
{
    DWORD Magic;
    int ControlCode;
}HOOK_DATA, *PHOOK_DATA;


PCHAR GetNameFromFullName(PCHAR FullName) {
    SIZE_T FullNameLength = strlen(FullName);

    for (SIZE_T i = FullNameLength; i > 0; i--) {
        if (*(FullName + i) == '\\') {
            return FullName + i + 1;
        }
    }

    return NULL;
}

PVOID GetNtoskrnlBase()
{
    
    PVOID LocalIntBase = NULL;
    PRTL_PROCESS_MODULES ModuleInformation = NULL;
    NTSTATUS result;
    ULONG SizeNeeded;
    SIZE_T InfoRegionSize;
    BOOL output = FALSE;
    PROTOTYPE_ZWQUERYSYSTEMINFORMATION ZwQuerySystemInformation;
    UNICODE_STRING ZQSIname;
    // Get addr of zqsi
    RtlInitUnicodeString(&ZQSIname, L"ZwQuerySystemInformation");
    ZwQuerySystemInformation = (PROTOTYPE_ZWQUERYSYSTEMINFORMATION)MmGetSystemRoutineAddress(&ZQSIname);
    // Get info size 
    result = ZwQuerySystemInformation((SYSTEM_INFORMATION_CLASS)0x0B, NULL, 0, &SizeNeeded);
    if (result != 0xC0000004)
    {
        return NULL;
    }
    InfoRegionSize = SizeNeeded;
    // Get Info 
    while (result == 0xC0000004)
    {
        InfoRegionSize += 0x1000;
        ModuleInformation = (PRTL_PROCESS_MODULES)ExAllocatePool(NonPagedPoolNx, InfoRegionSize);
        if (ModuleInformation == NULL)
        {
            return NULL;
        }
        result = ZwQuerySystemInformation((SYSTEM_INFORMATION_CLASS)0x0B, (PVOID)ModuleInformation, (ULONG)InfoRegionSize, &SizeNeeded);
        if (!NT_SUCCESS(result))
        {
            return NULL;
        }
        // Enumerate through loaded drivers
        for (DWORD i = 0; i < ModuleInformation->NumberOfModules; i++)
        {
            if (!strcmp(GetNameFromFullName((PCHAR)ModuleInformation->Modules[i].FullPathName), "ntoskrnl.exe"))
            {
                PVOID base = ModuleInformation->Modules[i].ImageBase;
                ExFreePool(ModuleInformation);
                return base;

            }
        }

    }
    ExFreePool(ModuleInformation);
    return nullptr;
}



INT64 Hook(PVOID UserMessage, PVOID Status, PVOID v13)
{
    DbgPrint("[*] NtConvertBetweenAuxiliaryCounterAndPerformanceCounter was called!\n");
    NtConvertBetweenAuxiliaryCounterAndPerformanceCounterPtr OriginalFunction = (NtConvertBetweenAuxiliaryCounterAndPerformanceCounterPtr)g_OriginalAddress;
    if (!ExGetPreviousMode() == UserMode)
    {
        DbgPrint("[*] kernel mode request , retruning...\n");
        return OriginalFunction(UserMessage, Status, v13);
    }

    PHOOK_DATA UserData = (PHOOK_DATA)UserMessage;
    if (UserData->Magic == 0x77FF77FF)
    {
        DbgPrint("[*] Received control number %d from client!\n", UserData->ControlCode);
        return NULL;
    }
    else
    {
        DbgPrint("[*] magic didnt match , calling original function...\n");
        return OriginalFunction(UserMessage, Status, v13);
    }
}


bool PlaceHook()
{
    PVOID KernelBase = GetNtoskrnlBase();
    if (!KernelBase)
        return false;
    DbgPrint("[*] ntoskrnl.exe at 0x%p\n", KernelBase);


    g_DataPtr = (PVOID*)((ULONG_PTR)KernelBase + DATA_PTR_OFFSET);
    if (!MmIsAddressValid(g_DataPtr))
        return false;

    g_OriginalAddress = *g_DataPtr;

    DbgPrint("[*] placing hook on 0x%p ( original function at 0x%p , hook at 0x%p)\n", g_DataPtr, g_OriginalAddress, Hook);

    InterlockedExchange64((volatile LONG64*)g_DataPtr, (LONG64)Hook);

    return true;

}

void RemoveHook()
{
    InterlockedExchange64((volatile LONG64*)g_DataPtr, (LONG64)g_OriginalAddress);
}

void DriverUnload(PDRIVER_OBJECT DriverObject)
{
    UNREFERENCED_PARAMETER(DriverObject);
    RemoveHook();
    DbgPrint("[*] driver unloaded\n");
}



EXTERN_C NTSTATUS DriverEntry(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)
{
	UNREFERENCED_PARAMETER(RegistryPath);
	NTSTATUS status = STATUS_SUCCESS;
    DriverObject->DriverUnload = DriverUnload;

	DbgPrint("[*] driver loading\n");
    
    if (!PlaceHook())
    {
        DbgPrint("[*] failed to place hook on data ptr\n");
    }



    DbgPrint("[*] successfully placed data ptr hook!\n");



	return status;
}
```

`NtConvertBetweenAuxiliaryCounterAndPerformanceCounterHook/DataptrHookDriver/x64/Release/DataptrHookDriver.inf`:

```inf
;
; DataptrHookDriver.inf
;

[Version]
Signature="$WINDOWS NT$"
Class=System
ClassGuid={4d36e97d-e325-11ce-bfc1-08002be10318}
Provider=%ManufacturerName%
DriverVer = 03/23/2024,15.1.17.850
CatalogFile=DataptrHookDriver.cat
PnpLockdown=1

;This template is supported for OS version 17763 (Windows 10 version 1809) and after.
;For Windows OS prior to Windows 10 1809 set DefaultDestDir = 12
[DestinationDirs]
DefaultDestDir = 13


[SourceDisksNames]
1 = %DiskName%,,,""

[SourceDisksFiles]


[Manufacturer]

[Standard.NTamd64]


[Strings]
ManufacturerName="<Your manufacturer name>" ;TODO: Replace with your manufacturer name
DiskName="DataptrHookDriver Source Disk"

```

`NtConvertBetweenAuxiliaryCounterAndPerformanceCounterHook/DataptrHookDriver/x64/Release/DataptrHookDriver.log`:

```log
  Building 'DataptrHookDriver' with toolset 'WindowsKernelModeDriver10.0' and the 'Desktop' target platform.
  Stamping x64\Release\DataptrHookDriver.inf
  Stamping [Version] section with DriverVer=03/23/2024,15.1.17.850
C:\Users\dorge\source\repos\DataptrHook\DataptrHookDriver\DataptrHookDriver.inf(28-28): warning 2083: Section [standard.ntamd64] not referenced or used.
  DataptrHookDriver.vcxproj -> C:\Users\dorge\source\repos\DataptrHook\x64\Release\DataptrHookDriver.sys
  .........................
  Signability test complete.
  
  Errors:
  None
  
  Warnings:
  None
  
  Catalog generation complete.
  C:\Users\dorge\source\repos\DataptrHook\x64\Release\DataptrHookDriver\dataptrhookdriver.cat
  Done Adding Additional Store
  Successfully signed: C:\Users\dorge\source\repos\DataptrHook\x64\Release\DataptrHookDriver\dataptrhookdriver.cat
  

```

`NtConvertBetweenAuxiliaryCounterAndPerformanceCounterHook/DataptrHookDriver/x64/Release/DataptrHookDriver.sys.recipe`:

```recipe
<?xml version="1.0" encoding="utf-8"?>
<Project>
  <ProjectOutputs>
    <ProjectOutput>
      <FullPath>C:\Users\dorge\source\repos\DataptrHook\x64\Release\DataptrHookDriver.sys</FullPath>
    </ProjectOutput>
  </ProjectOutputs>
  <ContentFiles />
  <SatelliteDlls />
  <NonRecipeFileRefs />
</Project>
```

`NtConvertBetweenAuxiliaryCounterAndPerformanceCounterHook/x64/Release/DataptrHookDriver.inf`:

```inf
;
; DataptrHookDriver.inf
;

[Version]
Signature="$WINDOWS NT$"
Class=System
ClassGuid={4d36e97d-e325-11ce-bfc1-08002be10318}
Provider=%ManufacturerName%
DriverVer = 03/23/2024,15.1.17.850
CatalogFile=DataptrHookDriver.cat
PnpLockdown=1

;This template is supported for OS version 17763 (Windows 10 version 1809) and after.
;For Windows OS prior to Windows 10 1809 set DefaultDestDir = 12
[DestinationDirs]
DefaultDestDir = 13


[SourceDisksNames]
1 = %DiskName%,,,""

[SourceDisksFiles]


[Manufacturer]

[Standard.NTamd64]


[Strings]
ManufacturerName="<Your manufacturer name>" ;TODO: Replace with your manufacturer name
DiskName="DataptrHookDriver Source Disk"

```

`NtConvertBetweenAuxiliaryCounterAndPerformanceCounterHook/x64/Release/DataptrHookDriver/DataptrHookDriver.inf`:

```inf
;
; DataptrHookDriver.inf
;

[Version]
Signature="$WINDOWS NT$"
Class=System
ClassGuid={4d36e97d-e325-11ce-bfc1-08002be10318}
Provider=%ManufacturerName%
DriverVer = 03/23/2024,15.1.17.850
CatalogFile=DataptrHookDriver.cat
PnpLockdown=1

;This template is supported for OS version 17763 (Windows 10 version 1809) and after.
;For Windows OS prior to Windows 10 1809 set DefaultDestDir = 12
[DestinationDirs]
DefaultDestDir = 13


[SourceDisksNames]
1 = %DiskName%,,,""

[SourceDisksFiles]


[Manufacturer]

[Standard.NTamd64]


[Strings]
ManufacturerName="<Your manufacturer name>" ;TODO: Replace with your manufacturer name
DiskName="DataptrHookDriver Source Disk"

```

`README.md`:

```md
# DataptrHooks
ntoskrnl .data pointer hook on NtConvertBetweenAuxiliaryCounterAndPerformanceCounter for UM-KM communication 

# Motivation 
the standard way to communicate between a usermode client and a kernel mode driver is through IOCTLs 

IOCTLs require the driver to create both DriverObject & DeviceObject , and the User can send I/O to the device over a  Symbolic Link 

Speaking specifically of mapped drivers , this makes it extremly trivial to detect. all we have to do is traverse all DriverObjects on the system (feaisble via ZwOpenDirectoryObject + ObReferenceObjectByHandle) and for each driver make sure the DriverObject->DriverInit member points to a module in the PsLoadedModuleList 

thus , mapped drivers evolved and started hijacking IRP_MJ_DEVICE_CONTROL dispatch routines of legitimate loaded drivers , this is also fairly trivial to detect by looking for dispatch hooks and patches 

In order to communicate with our mapped driver undetected , we need another way 

#  .data pointers 
The idea is simple , we want to find a kernel function that:
* calls another function by a .data pointer (allows us to steal the control flow without patching .text or triggering PatchGuard!) 
* can be triggered from UserMode (well , so we want to use it whenever we have a message to send to the driver from usermode ...) 
* gets at least one useful argument (so we can pass data to our driver)

# Sounds good , but how do we find a .data pointer ?
we can take advantage of control flow guard by searching for '_guard_dispatch' prefixed calls , to elaborate : 

when a module is compiled with /guard:cf , the compiler will analyze control flow for indirect call targets at compile time and insert code (ie _guard_dispatch_icall and others) to verify the targets at runtime 
so , simply put , looking for _guard_dispatch calls will lead us to indirect calls 

we can follow that by ALT+T in IDA to find all occurences of _guard_dispatch in ntoskrnl (or any other module that is somewhat exposed to usermode, like win32k.sys, win32kfull.sys etc)

CTRL + F  to find Nt prefixed functions ( being syscalls they can be called from Usermode) 

lastly , we need to reverse the function , mainly to  : 
* understand the code path that leads to the indirect call -  can we trigger it from UM ?
* understand the function prototype , can you use it for the way you communicate ?
* find the corresponding native api function and call it accordingly in your client


# PoC : NtConvertBetweenAuxiliaryCounterAndPerformanceCounter 
the function converts the specified auxiliary counter value to the corresponding performance counter value; optionally provides the estimated conversion error in nanoseconds due to latencies and maximum possible drift , but we dont care about that!
what we do care about , is the fact the function is calling nt!HalpTimerConvertAuxiliaryCounterToPerformanceCounter by a .data pointer in HalPrivateDispatchTable : ) 

![windbgdataptr](https://github.com/0mWindyBug/DataptrHook/assets/139051196/bac23e2e-d6d3-443a-8446-9bcb08583ccd)

In addition , we can pass a pointer (to a pointer) to a struct to it , and it will pass it along to HalpTimerConvertAuxiliaryCounterToPerformanceCounter , which we can hook(by only replacing a pointer and retrive the sent data (identifying our client requests using a predefined magic)

![ntaux](https://github.com/0mWindyBug/DataptrHook/assets/139051196/7c5fbbb0-854a-4828-86fa-eb179846ba74)

the PoC demonstrates exactly that , but keep in mind this specific poitner has been used for a while now in the game hacking community so Anti Cheats will clap you, its best you find your own pointer 

![datahook](https://github.com/0mWindyBug/DataptrHook/assets/139051196/28431f37-104c-4179-ad20-4424cea915ac)


# PoC : CiQueryInformation 
the function is called by SeCodeIntegrityQueryInformation through a .data pointer in SeSiCallbacks , and SeCodeIntegrityQueryInformation is called when calling NtQuerySystemInformation with SystemCodeIntegrityInformation , as shown below : ) 

![SeQueryCiInfo](https://github.com/0mWindyBug/DataptrHook/assets/139051196/068e207c-9636-4c92-b4e2-7bd9f3d45e69)

![Screenshot 2024-03-30 100336](https://github.com/0mWindyBug/DataptrHook/assets/139051196/7c02631e-10ee-42f4-bf8f-ae509238739b)



As we did with NtConvertBetweenAuxiliaryCounterAndPerformanceCounter , we make the pointer point to our driver defined function 

the hook filters out requests (checking previous mode and magic) 

note the SYSTEM_CODE_INTEGRITY_INFORMATION.Lentgh structure member must be initialzied with 8 , otherwise NTQSI will return STATUS_INFO_LENGTH_MISMATCH 

to have more control , the SYSTEM_CODE_INTEGRITY_INFORMATION's second ULONG member is splitted into two INT16 members (keeping the overall struct size the same) 

![datapocci](https://github.com/0mWindyBug/DataptrHook/assets/139051196/80afcd13-50c3-4ebf-839c-7ef9223e945f)





```

`SeQueryCodeIntegrityHook/SeCodeIntegrityQueryHookDriver/SeCodeIntegrityQueryHookDriver.inf`:

```inf
;
; SeCodeIntegrityQueryHookDriver.inf
;

[Version]
Signature="$WINDOWS NT$"
Class=System
ClassGuid={4d36e97d-e325-11ce-bfc1-08002be10318}
Provider=%ManufacturerName%
DriverVer=
CatalogFile=SeCodeIntegrityQueryHookDriver.cat
PnpLockdown=1

;This template is supported for OS version 17763 (Windows 10 version 1809) and after.
;For Windows OS prior to Windows 10 1809 set DefaultDestDir = 12
[DestinationDirs]
DefaultDestDir = 13


[SourceDisksNames]
1 = %DiskName%,,,""

[SourceDisksFiles]


[Manufacturer]

[Standard.NT$ARCH$]


[Strings]
ManufacturerName="<Your manufacturer name>" ;TODO: Replace with your manufacturer name
DiskName="SeCodeIntegrityQueryHookDriver Source Disk"

```

`SeQueryCodeIntegrityHook/SeCodeIntegrityQueryHookDriver/SeCodeIntegrityQueryHookDriver.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|ARM64">
      <Configuration>Debug</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|ARM64">
      <Configuration>Release</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <ProjectGuid>{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}</ProjectGuid>
    <TemplateGuid>{dd38f7fc-d7bd-488b-9242-7d8754cde80d}</TemplateGuid>
    <TargetFrameworkVersion>v4.5</TargetFrameworkVersion>
    <MinimumVisualStudioVersion>12.0</MinimumVisualStudioVersion>
    <Configuration>Debug</Configuration>
    <Platform Condition="'$(Platform)' == ''">x64</Platform>
    <RootNamespace>SeCodeIntegrityQueryHookDriver</RootNamespace>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="PropertySheets">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <Inf2CatUseLocalTime>true</Inf2CatUseLocalTime>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <DriverSign>
      <FileDigestAlgorithm>sha256</FileDigestAlgorithm>
    </DriverSign>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <DriverSign>
      <FileDigestAlgorithm>sha256</FileDigestAlgorithm>
    </DriverSign>
    <Link>
      <AdditionalOptions>/INTEGRITYCHECK %(AdditionalOptions)</AdditionalOptions>
    </Link>
    <ClCompile>
      <TreatWarningAsError>false</TreatWarningAsError>
    </ClCompile>
  </ItemDefinitionGroup>
  <ItemGroup>
    <Inf Include="SeCodeIntegrityQueryHookDriver.inf" />
  </ItemGroup>
  <ItemGroup>
    <FilesToPackage Include="$(TargetPath)" />
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="main.c" />
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="defs.h" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`SeQueryCodeIntegrityHook/SeCodeIntegrityQueryHookDriver/SeCodeIntegrityQueryHookDriver.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hpp;hxx;hm;inl;inc;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
    <Filter Include="Driver Files">
      <UniqueIdentifier>{8E41214B-6785-4CFE-B992-037D68949A14}</UniqueIdentifier>
      <Extensions>inf;inv;inx;mof;mc;</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <Inf Include="SeCodeIntegrityQueryHookDriver.inf">
      <Filter>Driver Files</Filter>
    </Inf>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="main.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="defs.h">
      <Filter>Header Files</Filter>
    </ClInclude>
  </ItemGroup>
</Project>
```

`SeQueryCodeIntegrityHook/SeCodeIntegrityQueryHookDriver/defs.h`:

```h
#pragma once
#include <ntifs.h>
#include <ntddk.h>
#include <ntimage.h>
#include <minwindef.h>
#include <intrin.h>
#include <ntddndis.h>
#include <strsafe.h>
#define NT_SUCCESS(Status) (((NTSTATUS)(Status)) >= 0)

typedef unsigned char BYTE, * PBYTE, * LPBYTE;



typedef struct _PEB_LDR_DATA {
	BYTE Reserved1[8];
	PVOID Reserved2[3];
	LIST_ENTRY InMemoryOrderModuleList;
} PEB_LDR_DATA, * PPEB_LDR_DATA;

typedef struct _RTL_DRIVE_LETTER_CURDIR
{
	USHORT Flags;
	USHORT Length;
	ULONG TimeStamp;
	UNICODE_STRING DosPath;
} RTL_DRIVE_LETTER_CURDIR, * PRTL_DRIVE_LETTER_CURDIR;

#define RTL_MAX_DRIVE_LETTERS 32

typedef struct _CURDIR
{
	UNICODE_STRING DosPath;
	HANDLE Handle;
} CURDIR, * PCURDIR;





typedef enum _DCMB_CALLBACK_TYPE {
	LoadImageCallback,
	ProcessCreationCallback,
	ThreadCreationCallback,
	ProcessObjectCreationCallback,
	ThreadObjectCreationCallback,
	RegistryCallback,
	DriverVerificationCallback
} DCMB_CALLBACK_TYPE;

typedef enum _SYSTEM_INFORMATION_CLASS {
	SystemBasicInformation = 0,
	SystemPerformanceInformation = 2,
	SystemTimeOfDayInformation = 3,
	SystemProcessInformation = 5,
	SystemProcessorPerformanceInformation = 8,
	SystemInterruptInformation = 23,
	SystemExceptionInformation = 33,
	SystemRegistryQuotaInformation = 37,
	SystemLookasideInformation = 45,
	SystemCodeIntegrityInformation = 103,
	SystemPolicyInformation = 134,
} SYSTEM_INFORMATION_CLASS;


typedef struct _KLDR_DATA_TABLE_ENTRY
{
	LIST_ENTRY InLoadOrderLinks;
	PVOID ExceptionTable;
	ULONG ExceptionTableSize;
	PVOID GpValue;
	PNON_PAGED_DEBUG_INFO NonPagedDebugInfo;
	PVOID DllBase;
	PVOID EntryPoint;
	ULONG SizeOfImage;
	UNICODE_STRING FullDllName;
	UNICODE_STRING BaseDllName;
	ULONG Flags;
	USHORT LoadCount;
	USHORT __Unused5;
	PVOID SectionPointer;
	ULONG CheckSum;
	PVOID LoadedImports;
	PVOID PatchInformation;
} KLDR_DATA_TABLE_ENTRY, * PKLDR_DATA_TABLE_ENTRY;

typedef struct _REGISTRY_CALLBACK_ITEM
{
	LIST_ENTRY Item;
	DWORD64 Unknown1[2];
	DWORD64 Context;
	DWORD64 Function;
	UNICODE_STRING Altitude;
	DWORD64 Unknown2[2];
} REGISTRY_CALLBACK_ITEM, * PREGISTRY_CALLBACK_ITEM;

typedef struct OB_CALLBACK_ENTRY_t {
	LIST_ENTRY CallbackList; // linked element tied to _OBJECT_TYPE.CallbackList
	OB_OPERATION Operations; // bitfield : 1 for Creations, 2 for Duplications
	BOOL Enabled;            // self-explanatory
	struct OB_CALLBACK_t* Entry;      // points to the structure in which it is included
	POBJECT_TYPE ObjectType; // points to the object type affected by the callback
	POB_PRE_OPERATION_CALLBACK PreOperation;      // callback function called before each handle operation
	POB_POST_OPERATION_CALLBACK PostOperation;     // callback function called after each handle operation
	KSPIN_LOCK Lock;         // lock object used for synchronization
} OB_CALLBACK_ENTRY, * POB_CALLBACK_ENTRY;

typedef struct _CALLBACK_OBJECT
{
	ULONG Signature;
	KSPIN_LOCK Lock;
	LIST_ENTRY RegisteredCallbacks;
	BOOLEAN AllowMultipleCallbacks;
	UCHAR reserved[3];
} CALLBACK_OBJECT;

typedef struct _CALLBACK_REGISTRATION
{
	LIST_ENTRY Link;
	PCALLBACK_OBJECT CallbackObject;
	PCALLBACK_FUNCTION CallbackFunction;
	PVOID CallbackContext;
	ULONG Busy;
	BOOLEAN UnregisterWaiting;
} CALLBACK_REGISTRATION, * PCALLBACK_REGISTRATION;



typedef NTSTATUS(NTAPI* PROTOTYPE_ZWQUERYSYSTEMINFORMATION)(SYSTEM_INFORMATION_CLASS info, PVOID infoinout, ULONG len, PULONG retLen);

typedef struct _RTL_PROCESS_MODULE_INFORMATION
{
	ULONG Section;
	PVOID MappedBase;
	PVOID ImageBase;
	ULONG ImageSize;
	ULONG Flags;
	USHORT LoadOrderIndex;
	USHORT InitOrderIndex;
	USHORT LoadCount;
	USHORT OffsetToFileName;
	CHAR FullPathName[256];
} RTL_PROCESS_MODULE_INFORMATION, * PRTL_PROCESS_MODULE_INFORMATION;

typedef struct _RTL_PROCESS_MODULES
{
	ULONG NumberOfModules;
	RTL_PROCESS_MODULE_INFORMATION Modules[1];
} RTL_PROCESS_MODULES, * PRTL_PROCESS_MODULES;

typedef struct _RTL_USER_PROCESS_PARAMETERS
{
	ULONG MaximumLength;	//6c0
	ULONG Length;//6c0
	ULONG Flags;//0
	ULONG DebugFlags;//0
	HANDLE ConsoleHandle;//NULL
	ULONG ConsoleFlags;//0
	HANDLE StandardInput;//NULL
	HANDLE StandardOutput;//NULL
	HANDLE StandardError;//NULL
	CURDIR CurrentDirectory;
	UNICODE_STRING DllPath;
	UNICODE_STRING ImagePathName;
	UNICODE_STRING CommandLine;
	PWSTR Environment;
	ULONG StartingX;
	ULONG StartingY;
	ULONG CountX;
	ULONG CountY;
	ULONG CountCharsX;
	ULONG CountCharsY;
	ULONG FillAttribute;
	ULONG WindowFlags;
	ULONG ShowWindowFlags;
	UNICODE_STRING WindowTitle;
	UNICODE_STRING DesktopInfo;
	UNICODE_STRING ShellInfo;
	UNICODE_STRING RuntimeData;
	RTL_DRIVE_LETTER_CURDIR CurrentDirectories[RTL_MAX_DRIVE_LETTERS];
#if (NTDDI_VERSION >= NTDDI_LONGHORN)
	SIZE_T EnvironmentSize;
#endif
#if (NTDDI_VERSION >= NTDDI_WIN7)
	SIZE_T EnvironmentVersion;
#endif
} RTL_USER_PROCESS_PARAMETERS, * PRTL_USER_PROCESS_PARAMETERS;


typedef struct _PEB {
	BYTE Reserved1[2];
	BYTE BeingDebugged;
	BYTE Reserved2[1];
	PVOID Reserved3[2];
	PPEB_LDR_DATA Ldr;
	PRTL_USER_PROCESS_PARAMETERS ProcessParameters;
	PVOID Reserved4[3];
	PVOID AtlThunkSListPtr;
	PVOID Reserved5;
	ULONG Reserved6;
	PVOID Reserved7;
	ULONG Reserved8;
	ULONG AtlThunkSListPtr32;
	PVOID Reserved9[45];
	BYTE Reserved10[96];
	PVOID PostProcessInitRoutine;
	BYTE Reserved11[128];
	PVOID Reserved12[1];
	ULONG SessionId;
} PEB, * PPEB;

// Modified LDR_DATA_TABLE_ENTRY definition (this one includes BaseDllName field and has InMemoryOrderLinks at the top for easier processing)
typedef struct _LDR_DATA_TABLE_ENTRY {
	/*LIST_ENTRY InLoadOrderLinks;*/
	LIST_ENTRY InMemoryOrderLinks;
	LIST_ENTRY InInitializationOrderList;
	PVOID DllBase;
	PVOID EntryPoint;
	PVOID Reserved3;
	UNICODE_STRING FullDllName;
	UNICODE_STRING BaseDllName;
} LDR_DATA_TABLE_ENTRY, * PLDR_DATA_TABLE_ENTRY;

typedef struct _TEB {
	PVOID Reserved1[12];
	PPEB ProcessEnvironmentBlock;
	PVOID Reserved2[399];
	BYTE Reserved3[1952];
	PVOID TlsSlots[64];
	BYTE Reserved4[8];
	PVOID Reserved5[26];
	PVOID ReservedForOle;  // Windows 2000 only
	PVOID Reserved6[4];
	PVOID TlsExpansionSlots;
} TEB, * PTEB;







/*
	NtCreateFile
*/
#define InitializeObjectAttributes( p, n, a, r, s ) { \
    (p)->Length = sizeof( OBJECT_ATTRIBUTES );          \
    (p)->RootDirectory = r;                             \
    (p)->Attributes = a;                                \
    (p)->ObjectName = n;                                \
    (p)->SecurityDescriptor = s;                        \
    (p)->SecurityQualityOfService = NULL;               \
    }

#define FILE_SYNCHRONOUS_IO_NONALERT	0x00000020

/*
	valid values for the attributes field
*/
#define OBJ_INHERIT                         0x00000002L
#define OBJ_PERMANENT                       0x00000010L
#define OBJ_EXCLUSIVE                       0x00000020L
#define OBJ_CASE_INSENSITIVE                0x00000040L
#define OBJ_OPENIF                          0x00000080L
#define OBJ_OPENLINK                        0x00000100L
#define OBJ_KERNEL_HANDLE                   0x00000200L
#define OBJ_FORCE_ACCESS_CHECK              0x00000400L
#define OBJ_IGNORE_IMPERSONATED_DEVICEMAP   0x00000800L
#define OBJ_DONT_REPARSE                    0x00001000L
#define OBJ_VALID_ATTRIBUTES                0x00001FF2



/*
	NtQueryInformationFile
*/


#define FileStandardInformation 5 // QUERY: FILE_STANDARD_INFORMATION



/*
	NtOpenProcess
*/


typedef struct _SYSTEM_PROCESS_INFO
{
	ULONG                   NextEntryOffset;
	ULONG                   NumberOfThreads;
	LARGE_INTEGER           Reserved[3];
	LARGE_INTEGER           CreateTime;
	LARGE_INTEGER           UserTime;
	LARGE_INTEGER           KernelTime;
	UNICODE_STRING          ImageName;
	ULONG                   BasePriority;
	HANDLE                  ProcessId;
	HANDLE                  InheritedFromProcessId;
}SYSTEM_PROCESS_INFO, * PSYSTEM_PROCESS_INFO;


/*
	NtCreateUserProcess
*/

#define RTL_USER_PROCESS_PARAMETERS_NORMALIZED   0x01

// ProcessFlags
#define PROCESS_CREATE_FLAGS_PROTECTED_PROCESS 0x00000040
#define PROCESS_CREATE_FLAGS_CREATE_SESSION 0x00000080 // ?
#define PROCESS_CREATE_FLAGS_INHERIT_FROM_PARENT 0x00000100
#define PROCESS_CREATE_FLAGS_SUSPENDED 0x00000200
#define PROCESS_CREATE_FLAGS_EXTENDED_UNKNOWN 0x00000400

// ThreadFlags
#define THREAD_CREATE_FLAGS_CREATE_SUSPENDED 0x00000001
#define THREAD_CREATE_FLAGS_SKIP_THREAD_ATTACH 0x00000002 // ?
#define THREAD_CREATE_FLAGS_HIDE_FROM_DEBUGGER 0x00000004
#define THREAD_CREATE_FLAGS_HAS_SECURITY_DESCRIPTOR 0x00000010 // ?
#define THREAD_CREATE_FLAGS_ACCESS_CHECK_IN_TARGET 0x00000020 // ?
#define THREAD_CREATE_FLAGS_INITIAL_THREAD 0x00000080
// end_rev

// windows-internals-book:"Chapter 5" 
typedef enum _PS_CREATE_STATE {
	PsCreateInitialState,
	PsCreateFailOnFileOpen,
	PsCreateFailOnSectionCreate,
	PsCreateFailExeFormat,
	PsCreateFailMachineMismatch,
	PsCreateFailExeName, // Debugger specified
	PsCreateSuccess,
	PsCreateMaximumStates
} PS_CREATE_STATE;

typedef struct _PS_CREATE_INFO {
	SIZE_T Size;
	PS_CREATE_STATE State;
	union {
		// PsCreateInitialState
		struct {
			union {
				ULONG InitFlags;
				struct {
					UCHAR WriteOutputOnExit : 1;
					UCHAR DetectManifest : 1;
					UCHAR IFEOSkipDebugger : 1;
					UCHAR IFEODoNotPropagateKeyState : 1;
					UCHAR SpareBits1 : 4;
					UCHAR SpareBits2 : 8;
					USHORT ProhibitedImageCharacteristics : 16;
				};
			};
			ACCESS_MASK AdditionalFileAccess;
		} InitState;

		// PsCreateFailOnSectionCreate
		struct {
			HANDLE FileHandle;
		} FailSection;

		// PsCreateFailExeFormat
		struct {
			USHORT DllCharacteristics;
		} ExeFormat;

		// PsCreateFailExeName
		struct {
			HANDLE IFEOKey;
		} ExeName;

		// PsCreateSuccess
		struct {
			union {
				ULONG OutputFlags;
				struct {
					UCHAR ProtectedProcess : 1;
					UCHAR AddressSpaceOverride : 1;
					UCHAR DevOverrideEnabled : 1; // from Image File Execution Options
					UCHAR ManifestDetected : 1;
					UCHAR ProtectedProcessLight : 1;
					UCHAR SpareBits1 : 3;
					UCHAR SpareBits2 : 8;
					USHORT SpareBits3 : 16;
				};
			};
			HANDLE FileHandle;
			HANDLE SectionHandle;
			ULONGLONG UserProcessParametersNative;
			ULONG UserProcessParametersWow64;
			ULONG CurrentParameterFlags;
			ULONGLONG PebAddressNative;
			ULONG PebAddressWow64;
			ULONGLONG ManifestAddress;
			ULONG ManifestSize;
		} SuccessState;
	};
} PS_CREATE_INFO, * PPS_CREATE_INFO;

// begin_rev
#define PS_ATTRIBUTE_NUMBER_MASK 0x0000ffff
#define PS_ATTRIBUTE_THREAD 0x00010000 // can be used with threads
#define PS_ATTRIBUTE_INPUT 0x00020000 // input only
#define PS_ATTRIBUTE_ADDITIVE 0x00040000 /// Is an additional option (see ProcThreadAttributeValue in WinBase.h)
// end_rev

typedef enum _PS_ATTRIBUTE_NUM {
	PsAttributeParentProcess, // in HANDLE
	PsAttributeDebugPort, // in HANDLE
	PsAttributeToken, // in HANDLE
	PsAttributeClientId, // out PCLIENT_ID
	PsAttributeTebAddress, // out PTEB
	PsAttributeImageName, // in PWSTR
	PsAttributeImageInfo, // out PSECTION_IMAGE_INFORMATION
	PsAttributeMemoryReserve, // in PPS_MEMORY_RESERVE
	PsAttributePriorityClass, // in UCHAR
	PsAttributeErrorMode, // in ULONG
	PsAttributeStdHandleInfo, // 10, in PPS_STD_HANDLE_INFO
	PsAttributeHandleList, // in PHANDLE
	PsAttributeGroupAffinity, // in PGROUP_AFFINITY
	PsAttributePreferredNode, // in PUSHORT
	PsAttributeIdealProcessor, // in PPROCESSOR_NUMBER
	PsAttributeUmsThread, // see UpdateProceThreadAttributeList in msdn (CreateProcessA/W...) in PUMS_CREATE_THREAD_ATTRIBUTES
	PsAttributeMitigationOptions, // in UCHAR
	PsAttributeProtectionLevel,
	PsAttributeSecureProcess, // since THRESHOLD (Virtual Secure Mode, Device Guard)
	PsAttributeJobList,
	PsAttributeMax
} PS_ATTRIBUTE_NUM;

#define PsAttributeValue(Number, Thread, Input, Additive) \
    (((Number) & PS_ATTRIBUTE_NUMBER_MASK) | \
    ((Thread) ? PS_ATTRIBUTE_THREAD : 0) | \
    ((Input) ? PS_ATTRIBUTE_INPUT : 0) | \
    ((Additive) ? PS_ATTRIBUTE_ADDITIVE : 0))

typedef struct _PS_ATTRIBUTE {
	ULONGLONG Attribute;				/// PROC_THREAD_ATTRIBUTE_XXX | PROC_THREAD_ATTRIBUTE_XXX modifiers, see ProcThreadAttributeValue macro and Windows Internals 6 (372)
	SIZE_T Size;						/// Size of Value or *ValuePtr
	union {
		ULONG_PTR Value;				/// Reserve 8 bytes for data (such as a Handle or a data pointer)
		PVOID ValuePtr;					/// data pointer
	};
	PSIZE_T ReturnLength;				/// Either 0 or specifies size of data returned to caller via "ValuePtr"
} PS_ATTRIBUTE, * PPS_ATTRIBUTE;

typedef struct _PS_ATTRIBUTE_LIST {
	SIZE_T TotalLength;					/// sizeof(PS_ATTRIBUTE_LIST)
	PS_ATTRIBUTE Attributes[2];			/// Depends on how many attribute entries should be supplied to NtCreateUserProcess
} PS_ATTRIBUTE_LIST, * PPS_ATTRIBUTE_LIST;
```

`SeQueryCodeIntegrityHook/SeCodeIntegrityQueryHookDriver/main.c`:

```c
#include "defs.h"
#include <ntddk.h>

#define DATA_PTR_OFFSET 0x0000000000c1d958

PVOID g_OriginalAddress = NULL;
PVOID* g_DataPtr = NULL;

typedef INT64(*CiCodeIntegrityPtr)(INT64 InfoBuffer, INT64 InfoLength, INT64 Size, INT64 v);

typedef struct _HOOK_STRUCT_CODE_INTEGRITY_INFO {
    ULONG   Length;
    UINT16   Magic;
    UINT16   ControlCode;

} HOOK_STRUCT_CODE_INTEGRITY_INFO, * PHOOK_STRUCT_CODE_INTEGRITY_INFO;


PCHAR GetNameFromFullName(PCHAR FullName) {
    SIZE_T FullNameLength = strlen(FullName);

    for (SIZE_T i = FullNameLength; i > 0; i--) {
        if (*(FullName + i) == '\\') {
            return FullName + i + 1;
        }
    }

    return NULL;
}

PVOID GetNtoskrnlBase()
{

    PVOID LocalIntBase = NULL;
    PRTL_PROCESS_MODULES ModuleInformation = NULL;
    NTSTATUS result;
    ULONG SizeNeeded;
    SIZE_T InfoRegionSize;
    BOOL output = FALSE;
    PROTOTYPE_ZWQUERYSYSTEMINFORMATION ZwQuerySystemInformation;
    UNICODE_STRING ZQSIname;
    // Get addr of zqsi
    RtlInitUnicodeString(&ZQSIname, L"ZwQuerySystemInformation");
    ZwQuerySystemInformation = (PROTOTYPE_ZWQUERYSYSTEMINFORMATION)MmGetSystemRoutineAddress(&ZQSIname);
    // Get info size 
    result = ZwQuerySystemInformation((SYSTEM_INFORMATION_CLASS)0x0B, NULL, 0, &SizeNeeded);
    if (result != 0xC0000004)
    {
        return NULL;
    }
    InfoRegionSize = SizeNeeded;
    // Get Info 
    while (result == 0xC0000004)
    {
        InfoRegionSize += 0x1000;
        ModuleInformation = (PRTL_PROCESS_MODULES)ExAllocatePool(NonPagedPoolNx, InfoRegionSize);
        if (ModuleInformation == NULL)
        {
            return NULL;
        }
        result = ZwQuerySystemInformation((SYSTEM_INFORMATION_CLASS)0x0B, (PVOID)ModuleInformation, (ULONG)InfoRegionSize, &SizeNeeded);
        if (!NT_SUCCESS(result))
        {
            return NULL;
        }
        // Enumerate through loaded drivers
        for (DWORD i = 0; i < ModuleInformation->NumberOfModules; i++)
        {
            if (!strcmp(GetNameFromFullName((PCHAR)ModuleInformation->Modules[i].FullPathName), "ntoskrnl.exe"))
            {
                PVOID base = ModuleInformation->Modules[i].ImageBase;
                ExFreePool(ModuleInformation);
                return base;

            }
        }

    }
    ExFreePool(ModuleInformation);
    return NULL;
}



INT64 Hook(PVOID InfoBuffer, INT64 InfoLength, INT64 Size, INT64 v)
{
    DbgPrint("[*] CiQueryInformation was called!\n");
    CiCodeIntegrityPtr OriginalFunction = (CiCodeIntegrityPtr)g_OriginalAddress;
    if (!ExGetPreviousMode() == UserMode)
    {
        DbgPrint("[*] kernel mode request , retruning...\n");
        return OriginalFunction(InfoBuffer, InfoLength, Size,v);
    }

    PHOOK_STRUCT_CODE_INTEGRITY_INFO UserData = (PHOOK_STRUCT_CODE_INTEGRITY_INFO)InfoBuffer;
    if (UserData->Magic == 0x7775)
    {
        DbgPrint("[*] Received control number %d from client!\n", UserData->ControlCode);
        return NULL;
    }
    else
    {
        DbgPrint("[*] magic didnt match , calling original function...\n");
        return OriginalFunction(InfoBuffer, InfoLength, Size,v);
    }
}


BOOLEAN PlaceHook()
{
    PVOID KernelBase = GetNtoskrnlBase();
    if (!KernelBase)
        return FALSE;
    DbgPrint("[*] ntoskrnl.exe at 0x%p\n", KernelBase);


    g_DataPtr = (PVOID*)((ULONG_PTR)KernelBase + DATA_PTR_OFFSET);
    if (!MmIsAddressValid(g_DataPtr))
        return FALSE;

    g_OriginalAddress = *g_DataPtr;

    DbgPrint("[*] placing hook on 0x%p ( original function at 0x%p , hook at 0x%p)\n", g_DataPtr, g_OriginalAddress, Hook);

    InterlockedExchange64((volatile LONG64*)g_DataPtr, (LONG64)Hook);

    return TRUE;

}

void RemoveHook()
{
    InterlockedExchange64((volatile LONG64*)g_DataPtr, (LONG64)g_OriginalAddress);
}



void DriverUnload(PDRIVER_OBJECT DriverObject)
{
    UNREFERENCED_PARAMETER(DriverObject);
    RemoveHook();
    DbgPrint("[*] driver unloaded\n");
}



EXTERN_C NTSTATUS DriverEntry(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)
{
    UNREFERENCED_PARAMETER(RegistryPath);
    NTSTATUS status = STATUS_SUCCESS;
    DriverObject->DriverUnload = DriverUnload;

    DbgPrint("[*] driver loading\n");

    if (!PlaceHook())
    {
        DbgPrint("[*] failed to place hook on data ptr\n");
    }



    DbgPrint("[*] successfully placed data ptr hook!\n");



    return status;
}
```

`SeQueryCodeIntegrityHook/SeCodeIntegrityQueryHookDriver/x64/Release/SeCodeIntegrityQueryHookDriver.inf`:

```inf
;
; SeCodeIntegrityQueryHookDriver.inf
;

[Version]
Signature="$WINDOWS NT$"
Class=System
ClassGuid={4d36e97d-e325-11ce-bfc1-08002be10318}
Provider=%ManufacturerName%
DriverVer = 03/30/2024,9.58.23.582
CatalogFile=SeCodeIntegrityQueryHookDriver.cat
PnpLockdown=1

;This template is supported for OS version 17763 (Windows 10 version 1809) and after.
;For Windows OS prior to Windows 10 1809 set DefaultDestDir = 12
[DestinationDirs]
DefaultDestDir = 13


[SourceDisksNames]
1 = %DiskName%,,,""

[SourceDisksFiles]


[Manufacturer]

[Standard.NTamd64]


[Strings]
ManufacturerName="<Your manufacturer name>" ;TODO: Replace with your manufacturer name
DiskName="SeCodeIntegrityQueryHookDriver Source Disk"

```

`SeQueryCodeIntegrityHook/SeCodeIntegrityQueryHookDriver/x64/Release/SeCodeIntegrityQueryHookDriver.log`:

```log
  Building 'SeCodeIntegrityQueryHookDriver' with toolset 'WindowsKernelModeDriver10.0' and the 'Desktop' target platform.
  Stamping x64\Release\SeCodeIntegrityQueryHookDriver.inf
  Stamping [Version] section with DriverVer=03/30/2024,9.58.23.582
C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\SeCodeIntegrityQueryHookDriver\SeCodeIntegrityQueryHookDriver.inf(28-28): warning 2083: Section [standard.ntamd64] not referenced or used.
  main.c
C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\SeCodeIntegrityQueryHookDriver\defs.h(270,1): warning C4005: 'OBJ_VALID_ATTRIBUTES': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntdef.h(1810): message : see previous definition of 'OBJ_VALID_ATTRIBUTES'
C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\SeCodeIntegrityQueryHookDriver\defs.h(353,6): warning C4201: nonstandard extension used: nameless struct/union
C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\SeCodeIntegrityQueryHookDriver\defs.h(354,5): warning C4201: nonstandard extension used: nameless struct/union
C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\SeCodeIntegrityQueryHookDriver\defs.h(386,6): warning C4201: nonstandard extension used: nameless struct/union
C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\SeCodeIntegrityQueryHookDriver\defs.h(387,5): warning C4201: nonstandard extension used: nameless struct/union
C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\SeCodeIntegrityQueryHookDriver\defs.h(398,3): warning C4201: nonstandard extension used: nameless struct/union
C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\SeCodeIntegrityQueryHookDriver\defs.h(444,3): warning C4201: nonstandard extension used: nameless struct/union
C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\SeCodeIntegrityQueryHookDriver\main.c(56,51): warning C4996: 'ExAllocatePool': ExAllocatePool is deprecated, use ExAllocatePool2.
C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\SeCodeIntegrityQueryHookDriver\main.c(39,10): warning C4189: 'output': local variable is initialized but not referenced
C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\SeCodeIntegrityQueryHookDriver\main.c(34,11): warning C4189: 'LocalIntBase': local variable is initialized but not referenced
C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\SeCodeIntegrityQueryHookDriver\main.c(92,43): warning C4047: 'function': 'INT64' differs in levels of indirection from 'PVOID'
C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\SeCodeIntegrityQueryHookDriver\main.c(92,33): warning C4024: 'OriginalFunction': different types for formal and actual parameter 1
C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\SeCodeIntegrityQueryHookDriver\main.c(99,20): warning C4047: 'return': 'INT64' differs in levels of indirection from 'void *'
C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\SeCodeIntegrityQueryHookDriver\main.c(104,43): warning C4047: 'function': 'INT64' differs in levels of indirection from 'PVOID'
C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\SeCodeIntegrityQueryHookDriver\main.c(104,33): warning C4024: 'OriginalFunction': different types for formal and actual parameter 1
  SeCodeIntegrityQueryHookDriver.vcxproj -> C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\x64\Release\SeCodeIntegrityQueryHookDriver.sys
  Done Adding Additional Store
  Successfully signed: C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\x64\Release\SeCodeIntegrityQueryHookDriver.sys
  
  .........................
  Signability test complete.
  
  Errors:
  None
  
  Warnings:
  None
  
  Catalog generation complete.
  C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\x64\Release\SeCodeIntegrityQueryHookDriver\secodeintegrityqueryhookdriver.cat
  Done Adding Additional Store
  Successfully signed: C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\x64\Release\SeCodeIntegrityQueryHookDriver\secodeintegrityqueryhookdriver.cat
  

```

`SeQueryCodeIntegrityHook/SeCodeIntegrityQueryHookDriver/x64/Release/SeCodeIntegrityQueryHookDriver.sys.recipe`:

```recipe
<?xml version="1.0" encoding="utf-8"?>
<Project>
  <ProjectOutputs>
    <ProjectOutput>
      <FullPath>C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\x64\Release\SeCodeIntegrityQueryHookDriver.sys</FullPath>
    </ProjectOutput>
  </ProjectOutputs>
  <ContentFiles />
  <SatelliteDlls />
  <NonRecipeFileRefs />
</Project>
```

`SeQueryCodeIntegrityHook/SeQueryCodeIntegrityHook.sln`:

```sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.2.32505.173
MinimumVisualStudioVersion = 10.0.40219.1
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "SeQueryCodeIntegrityHook", "SeQueryCodeIntegrityHook\SeQueryCodeIntegrityHook.vcxproj", "{265C1434-379A-480F-B797-F36D09EC6505}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "SeCodeIntegrityQueryHookDriver", "SeCodeIntegrityQueryHookDriver\SeCodeIntegrityQueryHookDriver.vcxproj", "{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|ARM64 = Debug|ARM64
		Debug|x64 = Debug|x64
		Debug|x86 = Debug|x86
		Release|ARM64 = Release|ARM64
		Release|x64 = Release|x64
		Release|x86 = Release|x86
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{265C1434-379A-480F-B797-F36D09EC6505}.Debug|ARM64.ActiveCfg = Debug|x64
		{265C1434-379A-480F-B797-F36D09EC6505}.Debug|ARM64.Build.0 = Debug|x64
		{265C1434-379A-480F-B797-F36D09EC6505}.Debug|x64.ActiveCfg = Debug|x64
		{265C1434-379A-480F-B797-F36D09EC6505}.Debug|x64.Build.0 = Debug|x64
		{265C1434-379A-480F-B797-F36D09EC6505}.Debug|x86.ActiveCfg = Debug|Win32
		{265C1434-379A-480F-B797-F36D09EC6505}.Debug|x86.Build.0 = Debug|Win32
		{265C1434-379A-480F-B797-F36D09EC6505}.Release|ARM64.ActiveCfg = Release|x64
		{265C1434-379A-480F-B797-F36D09EC6505}.Release|ARM64.Build.0 = Release|x64
		{265C1434-379A-480F-B797-F36D09EC6505}.Release|x64.ActiveCfg = Release|x64
		{265C1434-379A-480F-B797-F36D09EC6505}.Release|x64.Build.0 = Release|x64
		{265C1434-379A-480F-B797-F36D09EC6505}.Release|x86.ActiveCfg = Release|Win32
		{265C1434-379A-480F-B797-F36D09EC6505}.Release|x86.Build.0 = Release|Win32
		{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}.Debug|ARM64.ActiveCfg = Debug|ARM64
		{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}.Debug|ARM64.Build.0 = Debug|ARM64
		{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}.Debug|ARM64.Deploy.0 = Debug|ARM64
		{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}.Debug|x64.ActiveCfg = Debug|x64
		{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}.Debug|x64.Build.0 = Debug|x64
		{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}.Debug|x64.Deploy.0 = Debug|x64
		{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}.Debug|x86.ActiveCfg = Debug|x64
		{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}.Debug|x86.Build.0 = Debug|x64
		{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}.Debug|x86.Deploy.0 = Debug|x64
		{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}.Release|ARM64.ActiveCfg = Release|ARM64
		{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}.Release|ARM64.Build.0 = Release|ARM64
		{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}.Release|ARM64.Deploy.0 = Release|ARM64
		{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}.Release|x64.ActiveCfg = Release|x64
		{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}.Release|x64.Build.0 = Release|x64
		{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}.Release|x64.Deploy.0 = Release|x64
		{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}.Release|x86.ActiveCfg = Release|x64
		{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}.Release|x86.Build.0 = Release|x64
		{0D3B63F2-7992-4D02-A87E-BDBFD01536B6}.Release|x86.Deploy.0 = Release|x64
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {560BE2E5-A23A-49DC-8B58-A5B194F528C4}
	EndGlobalSection
EndGlobal

```

`SeQueryCodeIntegrityHook/SeQueryCodeIntegrityHook/SeQueryCodeIntegrityHook.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <Keyword>Win32Proj</Keyword>
    <ProjectGuid>{265c1434-379a-480f-b797-f36d09ec6505}</ProjectGuid>
    <RootNamespace>SeQueryCodeIntegrityHook</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="main.cpp" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`SeQueryCodeIntegrityHook/SeQueryCodeIntegrityHook/SeQueryCodeIntegrityHook.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;c++;cppm;ixx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;h++;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="main.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`SeQueryCodeIntegrityHook/SeQueryCodeIntegrityHook/SeQueryCodeIntegrityHook.vcxproj.user`:

```user
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="Current" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup />
</Project>
```

`SeQueryCodeIntegrityHook/SeQueryCodeIntegrityHook/main.cpp`:

```cpp
#include <iostream>
#include <Windows.h>
#include <winternl.h>
#include <ntstatus.h>

#define Log(content) std::wcout << content
#pragma comment(lib,"ntdll.lib")

typedef struct _HOOK_STRUCT_CODE_INTEGRITY_INFO {
	ULONG   Length;
	UINT16   Magic;
	UINT16 ControlCode;

} HOOK_STRUCT_CODE_INTEGRITY_INFO, * PHOOK_STRUCT_CODE_INTEGRITY_INFO;
int main()
{

	void* LastBuffer = nullptr;
	void* InfoBuffer = nullptr;
	ULONG ReturnLength;
	HOOK_STRUCT_CODE_INTEGRITY_INFO CodeIntegrityInfo;
	CodeIntegrityInfo.Length = 8;
	CodeIntegrityInfo.Magic = 0x7775;
	CodeIntegrityInfo.ControlCode = 0x1212;

	NTSTATUS status = NtQuerySystemInformation(SystemCodeIntegrityInformation, &CodeIntegrityInfo, sizeof(SYSTEM_CODEINTEGRITY_INFORMATION), &ReturnLength);
	if (!NT_SUCCESS(status))
	{
		Log(L"[-] NtQuerySystemInformation failed with status 0x" << std::hex << status << std::endl);
		return -1;
	}

	Log(L"[-] successfully made a query for code integrity information" << std::endl);
	
	return 0;
}
```

`SeQueryCodeIntegrityHook/SeQueryCodeIntegrityHook/x64/Release/SeQueryCodeIntegrityHook.exe.recipe`:

```recipe
<?xml version="1.0" encoding="utf-8"?>
<Project>
  <ProjectOutputs>
    <ProjectOutput>
      <FullPath>C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\x64\Release\SeQueryCodeIntegrityHook.exe</FullPath>
    </ProjectOutput>
  </ProjectOutputs>
  <ContentFiles />
  <SatelliteDlls />
  <NonRecipeFileRefs />
</Project>
```

`SeQueryCodeIntegrityHook/SeQueryCodeIntegrityHook/x64/Release/SeQueryCodeIntegrityHook.log`:

```log
  main.cpp
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(66,1): warning C4005: 'STATUS_WAIT_0': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2549): message : see previous definition of 'STATUS_WAIT_0'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(223,1): warning C4005: 'STATUS_ABANDONED_WAIT_0': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2550): message : see previous definition of 'STATUS_ABANDONED_WAIT_0'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(246,1): warning C4005: 'STATUS_USER_APC': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2551): message : see previous definition of 'STATUS_USER_APC'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(282,1): warning C4005: 'STATUS_TIMEOUT': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2552): message : see previous definition of 'STATUS_TIMEOUT'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(291,1): warning C4005: 'STATUS_PENDING': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2553): message : see previous definition of 'STATUS_PENDING'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(747,1): warning C4005: 'DBG_EXCEPTION_HANDLED': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2554): message : see previous definition of 'DBG_EXCEPTION_HANDLED'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(756,1): warning C4005: 'DBG_CONTINUE': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2555): message : see previous definition of 'DBG_CONTINUE'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(831,1): warning C4005: 'STATUS_SEGMENT_NOTIFICATION': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2556): message : see previous definition of 'STATUS_SEGMENT_NOTIFICATION'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(994,1): warning C4005: 'STATUS_FATAL_APP_EXIT': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2557): message : see previous definition of 'STATUS_FATAL_APP_EXIT'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(1332,1): warning C4005: 'DBG_REPLY_LATER': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2558): message : see previous definition of 'DBG_REPLY_LATER'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(1350,1): warning C4005: 'DBG_TERMINATE_THREAD': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2559): message : see previous definition of 'DBG_TERMINATE_THREAD'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(1359,1): warning C4005: 'DBG_TERMINATE_PROCESS': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2560): message : see previous definition of 'DBG_TERMINATE_PROCESS'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(1368,1): warning C4005: 'DBG_CONTROL_C': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2561): message : see previous definition of 'DBG_CONTROL_C'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(1377,1): warning C4005: 'DBG_PRINTEXCEPTION_C': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2562): message : see previous definition of 'DBG_PRINTEXCEPTION_C'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(1386,1): warning C4005: 'DBG_RIPEXCEPTION': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2563): message : see previous definition of 'DBG_RIPEXCEPTION'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(1395,1): warning C4005: 'DBG_CONTROL_BREAK': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2564): message : see previous definition of 'DBG_CONTROL_BREAK'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(1404,1): warning C4005: 'DBG_COMMAND_EXCEPTION': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2565): message : see previous definition of 'DBG_COMMAND_EXCEPTION'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(1413,1): warning C4005: 'DBG_PRINTEXCEPTION_WIDE_C': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2566): message : see previous definition of 'DBG_PRINTEXCEPTION_WIDE_C'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(1445,1): warning C4005: 'STATUS_GUARD_PAGE_VIOLATION': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2567): message : see previous definition of 'STATUS_GUARD_PAGE_VIOLATION'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(1456,1): warning C4005: 'STATUS_DATATYPE_MISALIGNMENT': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2568): message : see previous definition of 'STATUS_DATATYPE_MISALIGNMENT'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(1467,1): warning C4005: 'STATUS_BREAKPOINT': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2569): message : see previous definition of 'STATUS_BREAKPOINT'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(1478,1): warning C4005: 'STATUS_SINGLE_STEP': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2570): message : see previous definition of 'STATUS_SINGLE_STEP'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(1781,1): warning C4005: 'STATUS_LONGJUMP': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2571): message : see previous definition of 'STATUS_LONGJUMP'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(1808,1): warning C4005: 'STATUS_UNWIND_CONSOLIDATE': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2572): message : see previous definition of 'STATUS_UNWIND_CONSOLIDATE'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(1923,1): warning C4005: 'DBG_EXCEPTION_NOT_HANDLED': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2573): message : see previous definition of 'DBG_EXCEPTION_NOT_HANDLED'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(2090,1): warning C4005: 'STATUS_ACCESS_VIOLATION': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2574): message : see previous definition of 'STATUS_ACCESS_VIOLATION'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(2099,1): warning C4005: 'STATUS_IN_PAGE_ERROR': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2575): message : see previous definition of 'STATUS_IN_PAGE_ERROR'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(2117,1): warning C4005: 'STATUS_INVALID_HANDLE': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2576): message : see previous definition of 'STATUS_INVALID_HANDLE'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(2162,1): warning C4005: 'STATUS_INVALID_PARAMETER': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2577): message : see previous definition of 'STATUS_INVALID_PARAMETER'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(2262,1): warning C4005: 'STATUS_NO_MEMORY': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2578): message : see previous definition of 'STATUS_NO_MEMORY'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(2319,1): warning C4005: 'STATUS_ILLEGAL_INSTRUCTION': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2579): message : see previous definition of 'STATUS_ILLEGAL_INSTRUCTION'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(2400,1): warning C4005: 'STATUS_NONCONTINUABLE_EXCEPTION': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2580): message : see previous definition of 'STATUS_NONCONTINUABLE_EXCEPTION'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(2409,1): warning C4005: 'STATUS_INVALID_DISPOSITION': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2581): message : see previous definition of 'STATUS_INVALID_DISPOSITION'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(3342,1): warning C4005: 'STATUS_ARRAY_BOUNDS_EXCEEDED': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2582): message : see previous definition of 'STATUS_ARRAY_BOUNDS_EXCEEDED'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(3352,1): warning C4005: 'STATUS_FLOAT_DENORMAL_OPERAND': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2583): message : see previous definition of 'STATUS_FLOAT_DENORMAL_OPERAND'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(3362,1): warning C4005: 'STATUS_FLOAT_DIVIDE_BY_ZERO': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2584): message : see previous definition of 'STATUS_FLOAT_DIVIDE_BY_ZERO'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(3372,1): warning C4005: 'STATUS_FLOAT_INEXACT_RESULT': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2585): message : see previous definition of 'STATUS_FLOAT_INEXACT_RESULT'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(3382,1): warning C4005: 'STATUS_FLOAT_INVALID_OPERATION': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2586): message : see previous definition of 'STATUS_FLOAT_INVALID_OPERATION'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(3392,1): warning C4005: 'STATUS_FLOAT_OVERFLOW': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2587): message : see previous definition of 'STATUS_FLOAT_OVERFLOW'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(3402,1): warning C4005: 'STATUS_FLOAT_STACK_CHECK': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2588): message : see previous definition of 'STATUS_FLOAT_STACK_CHECK'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(3412,1): warning C4005: 'STATUS_FLOAT_UNDERFLOW': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2589): message : see previous definition of 'STATUS_FLOAT_UNDERFLOW'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(3422,1): warning C4005: 'STATUS_INTEGER_DIVIDE_BY_ZERO': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2590): message : see previous definition of 'STATUS_INTEGER_DIVIDE_BY_ZERO'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(3432,1): warning C4005: 'STATUS_INTEGER_OVERFLOW': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2591): message : see previous definition of 'STATUS_INTEGER_OVERFLOW'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(3442,1): warning C4005: 'STATUS_PRIVILEGED_INSTRUCTION': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2592): message : see previous definition of 'STATUS_PRIVILEGED_INSTRUCTION'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(4388,1): warning C4005: 'STATUS_STACK_OVERFLOW': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2593): message : see previous definition of 'STATUS_STACK_OVERFLOW'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(4905,1): warning C4005: 'STATUS_DLL_NOT_FOUND': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2594): message : see previous definition of 'STATUS_DLL_NOT_FOUND'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(4934,1): warning C4005: 'STATUS_ORDINAL_NOT_FOUND': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2595): message : see previous definition of 'STATUS_ORDINAL_NOT_FOUND'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(4944,1): warning C4005: 'STATUS_ENTRYPOINT_NOT_FOUND': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2596): message : see previous definition of 'STATUS_ENTRYPOINT_NOT_FOUND'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(4954,1): warning C4005: 'STATUS_CONTROL_C_EXIT': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2597): message : see previous definition of 'STATUS_CONTROL_C_EXIT'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(5032,1): warning C4005: 'STATUS_DLL_INIT_FAILED': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2598): message : see previous definition of 'STATUS_DLL_INIT_FAILED'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(6029,1): warning C4005: 'STATUS_CONTROL_STACK_VIOLATION': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2599): message : see previous definition of 'STATUS_CONTROL_STACK_VIOLATION'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(7623,1): warning C4005: 'STATUS_FLOAT_MULTIPLE_FAULTS': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2600): message : see previous definition of 'STATUS_FLOAT_MULTIPLE_FAULTS'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(7633,1): warning C4005: 'STATUS_FLOAT_MULTIPLE_TRAPS': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2601): message : see previous definition of 'STATUS_FLOAT_MULTIPLE_TRAPS'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(7765,1): warning C4005: 'STATUS_REG_NAT_CONSUMPTION': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2602): message : see previous definition of 'STATUS_REG_NAT_CONSUMPTION'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(8748,1): warning C4005: 'STATUS_HEAP_CORRUPTION': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2603): message : see previous definition of 'STATUS_HEAP_CORRUPTION'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(8976,1): warning C4005: 'STATUS_STACK_BUFFER_OVERRUN': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2604): message : see previous definition of 'STATUS_STACK_BUFFER_OVERRUN'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(9103,1): warning C4005: 'STATUS_INVALID_CRUNTIME_PARAMETER': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2605): message : see previous definition of 'STATUS_INVALID_CRUNTIME_PARAMETER'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(9166,1): warning C4005: 'STATUS_ASSERTION_FAILURE': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2606): message : see previous definition of 'STATUS_ASSERTION_FAILURE'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(10075,1): warning C4005: 'STATUS_ENCLAVE_VIOLATION': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2607): message : see previous definition of 'STATUS_ENCLAVE_VIOLATION'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(10736,1): warning C4005: 'STATUS_INTERRUPTED': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2608): message : see previous definition of 'STATUS_INTERRUPTED'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(10745,1): warning C4005: 'STATUS_THREAD_NOT_RUNNING': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2609): message : see previous definition of 'STATUS_THREAD_NOT_RUNNING'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(11057,1): warning C4005: 'STATUS_ALREADY_REGISTERED': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2610): message : see previous definition of 'STATUS_ALREADY_REGISTERED'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(14940,1): warning C4005: 'STATUS_SXS_EARLY_DEACTIVATION': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2612): message : see previous definition of 'STATUS_SXS_EARLY_DEACTIVATION'
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared\ntstatus.h(14949,1): warning C4005: 'STATUS_SXS_INVALID_DEACTIVATION': macro redefinition
C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um\winnt.h(2613): message : see previous definition of 'STATUS_SXS_INVALID_DEACTIVATION'
  Generating code
  1 of 12 functions ( 8.3%) were compiled, the rest were copied from previous compilation.
    0 functions were new in current compilation
    0 functions had inline decision re-evaluated but remain unchanged
  Finished generating code
  SeQueryCodeIntegrityHook.vcxproj -> C:\Users\dorge\source\repos\SeQueryCodeIntegrityHook\x64\Release\SeQueryCodeIntegrityHook.exe

```

`SeQueryCodeIntegrityHook/x64/Release/SeCodeIntegrityQueryHookDriver.inf`:

```inf
;
; SeCodeIntegrityQueryHookDriver.inf
;

[Version]
Signature="$WINDOWS NT$"
Class=System
ClassGuid={4d36e97d-e325-11ce-bfc1-08002be10318}
Provider=%ManufacturerName%
DriverVer = 03/30/2024,9.58.23.582
CatalogFile=SeCodeIntegrityQueryHookDriver.cat
PnpLockdown=1

;This template is supported for OS version 17763 (Windows 10 version 1809) and after.
;For Windows OS prior to Windows 10 1809 set DefaultDestDir = 12
[DestinationDirs]
DefaultDestDir = 13


[SourceDisksNames]
1 = %DiskName%,,,""

[SourceDisksFiles]


[Manufacturer]

[Standard.NTamd64]


[Strings]
ManufacturerName="<Your manufacturer name>" ;TODO: Replace with your manufacturer name
DiskName="SeCodeIntegrityQueryHookDriver Source Disk"

```

`SeQueryCodeIntegrityHook/x64/Release/SeCodeIntegrityQueryHookDriver/SeCodeIntegrityQueryHookDriver.inf`:

```inf
;
; SeCodeIntegrityQueryHookDriver.inf
;

[Version]
Signature="$WINDOWS NT$"
Class=System
ClassGuid={4d36e97d-e325-11ce-bfc1-08002be10318}
Provider=%ManufacturerName%
DriverVer = 03/30/2024,9.58.23.582
CatalogFile=SeCodeIntegrityQueryHookDriver.cat
PnpLockdown=1

;This template is supported for OS version 17763 (Windows 10 version 1809) and after.
;For Windows OS prior to Windows 10 1809 set DefaultDestDir = 12
[DestinationDirs]
DefaultDestDir = 13


[SourceDisksNames]
1 = %DiskName%,,,""

[SourceDisksFiles]


[Manufacturer]

[Standard.NTamd64]


[Strings]
ManufacturerName="<Your manufacturer name>" ;TODO: Replace with your manufacturer name
DiskName="SeCodeIntegrityQueryHookDriver Source Disk"

```