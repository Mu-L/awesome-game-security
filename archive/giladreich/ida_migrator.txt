Project Path: arc_giladreich_ida_migrator_0577ih9p

Source Tree:

```txt
arc_giladreich_ida_migrator_0577ih9p
├── LICENSE
├── docs
│   └── README.md
├── media
│   ├── exporter_1.png
│   ├── exporter_2.png
│   ├── ida_migrator.png
│   ├── ida_migrator.psd
│   ├── importer_1.png
│   ├── importer_2.png
│   └── intro.png
└── source
    ├── ida_migrator
    │   ├── __init__.py
    │   ├── export_dialog.py
    │   ├── import_dialog.py
    │   ├── intro_dialog.py
    │   ├── migrator_dialog.py
    │   ├── plugin.py
    │   ├── ui
    │   │   ├── IntroDialog.ui
    │   │   └── MigratorDialog.ui
    │   └── utility.py
    └── ida_migrator.py

```

`LICENSE`:

```
MIT License

Copyright (c) 2020-present Gilad Reich

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

```

`docs/README.md`:

```md

<p align="center"><img src="/media/ida_migrator.png" width=700 height=200></p>

# IDA Migrator Plugin

IDA Migrator plugin aids migrating function names, structures and enums from one database instance to another.

This comes in handy when:
* Moving to a newer version of IDA that does better analysis and you don't want to change in the new instance type information or variable names of the decompiled functions.
* The current idb instance fails to decompile a function or the decompilation looks wrong in comparison to another idb instance of the same binary.
* Experimenting on another idb instance before making major changes on the current instance.
* A lightweight easy way of creating small incremental backups from the current work.
* For w/e reason, the current idb instance you're working on gets corrupted.


IDA Migrator plugin developed using PyQt, hence should work on all platforms.

## Getting Started

Download links can be found [here](https://github.com/giladreich/ida_migrator/releases).

Copy the files under the `source` directory and put them under your IDA installation `plugins` directory.

Start your current IDA instance you want to migrate from and then press `CTRL+SHIFT+D` to show the plugin's UI. Alternative; open it through the `Edit -> Plugins -> IDA Migrator` menu:

![Intro](/media/intro.png)


### Step 1 - Exporting Data

Clicking the `Export` button will show all functions of the current database instance:

![Exporter UI](/media/exporter_1.png)

Hint: You can uncheck any functions you want to exclude from exporting.

Once you click the `Start Export` button, it will ask you where would you like to export the files; One is the `*symbols*.json` storing addresses and function names and the other is `*types*.idc` having all the structures and enums information:

![Exporter Files](/media/exporter_2.png)


### Step 2 - Importing Data

In the new idb instance, open the plugin again and click on the `Import` button, which will then ask you to provide the `*symbols*.json` file:

![Importer UI](/media/importer_1.png)

Same procedure from here, just that once you click the `Start Import` button, it will ask you if you would like to import structures and enums as well from the exported `*types*.idc` file, that's optional for you to choose.

Note that it will only rename functions that does not have the same name and will output what functions has been affected in IDA's console:

![Importer Results](/media/importer_2.png)


## Contributing

Pull-Requests are greatly appreciated should you like to contribute to the project.

Same goes for opening issues; if you have any suggestions, feedback or you found any bugs, please do not hesitate to open an [issue](https://github.com/giladreich/ida_migrator/issues).

## Authors

* **Gilad Reich** - *Initial work* - [giladreich](https://github.com/giladreich)

See also the list of [contributors](https://github.com/giladreich/ida_migrator/graphs/contributors) who participated in this project.

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.


```

`source/ida_migrator.py`:

```py
from ida_migrator.plugin import IdaMigratorPlugin

def PLUGIN_ENTRY(*args, **kwargs):
    return IdaMigratorPlugin(*args, **kwargs)

```

`source/ida_migrator/__init__.py`:

```py
import os

VERSION = '2.0.1'
PLUGIN_NAME = "IDA Migrator"
PLUGIN_DIR = os.path.dirname(os.path.realpath(__file__))
IDA_DIR = os.path.abspath(os.path.join(PLUGIN_DIR, '..', '..'))
UI_DIR = os.path.join(PLUGIN_DIR, 'ui')

```

`source/ida_migrator/export_dialog.py`:

```py
from ida_migrator.migrator_dialog import *
from ida_migrator.utility import log_info


class ExportDialog(MigratorDialog):

    def __init__(self, *args, **kwargs):
        super(ExportDialog, self).__init__(*args, **kwargs)
        self.setWindowTitle("Exporter")
        self._ui.lblTitle.setText(self._ui.lblTitle.text().replace('XXXX', 'export'))
        self._ui.btnStart.setText("Start Export")

    def populate_function_names(self):
        log_info('Loading functions...')
        total = 0
        for seg in idautils.Segments():
            total += len(list(idautils.Functions(seg, idc.get_segm_end(seg))))

        self.tblFunctions.setRowCount(total)
        index = 0
        for seg in idautils.Segments():
            for func in idautils.Functions(seg, idc.get_segm_end(seg)):
                address = POINTER_FMT.format(func)
                function = idc.get_func_name(func)
                self.append_table_item(index, address, function)
                index += 1
        log_info('Finished loading functions.')

    def process_pe_info(self):
        info = idaapi.get_inf_structure()

        bits = 0xFF
        if info.is_64bit():
            bits = 64
        elif info.is_32bit():
            bits = 32

        data = {
            'exe': idc.get_root_filename(),
            'arch': "x{}_bit".format(bits),
            'file_type': idaapi.get_file_type_name(),
            'base_addr': POINTER_FMT.format(idaapi.get_imagebase()),
            'db_path': idaapi.get_input_file_path()
        }

        return data

    def process_functions(self):
        names = list()
        rowCount = self.tblFunctions.rowCount()
        count_added = 0
        for row in range(rowCount):
            cbx = self.tblFunctions.item(row, col_CheckBox)
            if not cbx or cbx.checkState() != Qt.Checked:
                continue

            name = {
                'address': self.tblFunctions.item(row, col_Address).text(),
                'name': self.tblFunctions.item(row, col_Name).text()
            }
            count_added += 1
            names.append(name)

        return names, count_added

    def on_start_clicked(self):
        file, ext = os.path.splitext(idc.get_idb_path())
        selected_dir = QFileDialog.getExistingDirectory(self, "Select Path to Export Files", os.path.dirname(file))
        if not selected_dir:
            return

        if os.name == 'nt':
            selected_dir = selected_dir.replace('/', '\\')

        file_name = os.path.basename(file)

        datetime = time.strftime("%Y%m%d-%H%M%S")
        file_json = "{}_symbols_{}.json".format(file_name, datetime)
        file_path_json = os.path.join(selected_dir, file_json)
        log_info("Exporting to {}", file_json)
        functions, count = self.process_functions()
        payload = {
            'bpe_info': self.process_pe_info(),
            'functions_count': count,
            'functions': functions
        }
        with open(file_path_json, "w") as f:
            json.dump(payload, f, indent=4, sort_keys=True)

        # NOTE(Gilad): Alternative Solution:
        # Call idc.process_ui_action('ProduceHeader') to produce C header file and then
        # on import idc.process_ui_action('LoadHeaderFile'). Only issue might be with parsing errors.
        # Parsing .IDC file is less error prone in this scenario.
        file_types = "{}_types_{}.idc".format(file_name, datetime)
        file_path_types = os.path.join(selected_dir, file_types)
        if not idc.gen_file(idc.OFILE_IDC, file_types, 0, idc.BADADDR, idc.GENFLG_IDCTYPE):
            QMessageBox.error(self, "FAILED", "Failed to generate type information file.")
        os.rename(file_types, file_path_types)

        QMessageBox.information(self, "Successfully Exported",
                                """Exported path:\n{}\n{}
                                \nYou can now use the Importer and select these files to import in another database instance."""
                                .format(file_path_json, file_path_types))

```

`source/ida_migrator/import_dialog.py`:

```py
from ida_migrator.migrator_dialog import *
from ida_migrator.utility import log_info


class ImportDialog(MigratorDialog):

    def __init__(self, file_path, *args, **kwargs):
        self.file_path = file_path
        super(ImportDialog, self).__init__(*args, **kwargs)
        self.setWindowTitle("Importer")
        self._ui.lblTitle.setText(self._ui.lblTitle.text().replace('XXXX', 'import'))
        self._ui.btnStart.setText("Start Import")

    def populate_function_names(self):
        log_info('Loading functions...')
        with open(self.file_path, "r") as f:
            parsed_json = json.loads(f.read())
            self.tblFunctions.setRowCount(parsed_json['functions_count'])
            index = 0
            for func in parsed_json['functions']:
                self.append_table_item(index, func['address'], func['name'])
                index += 1
        log_info('Finished loading functions.')

    def rename_functions(self):
        row_count = self.tblFunctions.rowCount()
        renamed_count = 0
        for row in range(row_count):
            cbx = self.tblFunctions.item(row, col_CheckBox)
            if not cbx or cbx.checkState() != Qt.Checked:
                continue

            address_str = self.tblFunctions.item(row, col_Address).text()
            address = int(address_str, 16)
            name = self.tblFunctions.item(row, col_Name).text()
            curr_name = idc.get_func_name(address)
            if not name or not curr_name or name == curr_name:
                continue

            if idaapi.set_name(address, str(name), idaapi.SN_NOWARN):
                log_info("{} - Renamed {} to {}", address_str, curr_name, name)
                renamed_count += 1
            else:
                log_info("Failed renaming: {}. Disable SN_NOWARN to see why.", address_str)

        return renamed_count

    def on_start_clicked(self):
        count = self.rename_functions()
        log_info("{} functions has been renamed.", count)

        answer = QMessageBox.question(self, 'Yes | No',
                """Would you like to import type information as well? (structs, enums)
                \nYou will need to provide the exported IDC file.""",
                QMessageBox.Yes | QMessageBox.No, QMessageBox.Yes)

        if answer == QMessageBox.Yes:
            # idc.process_ui_action('Execute')
            dir_path = os.path.dirname(idc.get_idb_path())
            file_path, _ = QFileDialog.getOpenFileName(self, "Select File to Import", dir_path, "IDC Script (*.idc)")
            if file_path:
                ida_expr.exec_idc_script(None, str(file_path), "main", None, 0)

        QMessageBox.information(self, "Successfully Imported",
                                "Successfully renamed {} functions.".format(count))

```

`source/ida_migrator/intro_dialog.py`:

```py
import os
import json

import idc

from PyQt5 import uic
from PyQt5.QtCore import Qt
from PyQt5.QtWidgets import QFileDialog

from ida_migrator import UI_DIR
from ida_migrator.utility import log_info
from ida_migrator.export_dialog import ExportDialog
from ida_migrator.import_dialog import ImportDialog


Ui_IntroDialog, IntroDialogBase = uic.loadUiType(
    os.path.join(UI_DIR, 'IntroDialog.ui')
)

class IntroDialog(IntroDialogBase):

    def __init__(self, *args, **kwargs):
        super(IntroDialog, self).__init__(*args, **kwargs)
        self.setWindowFlags(self.windowFlags() & ~Qt.WindowContextHelpButtonHint)

        self._export_dialog = None
        self._import_dialog = None

        self._ui = Ui_IntroDialog()
        self._ui.setupUi(self)
        self._ui.btnExport.clicked.connect(self.on_export_clicked)
        self._ui.btnImport.clicked.connect(self.on_import_clicked)

    def on_export_clicked(self):
        self._export_dialog = ExportDialog(self)
        self._export_dialog.show()

    def on_import_clicked(self):
        dir_path = os.path.dirname(idc.get_idb_path())
        file_path, _ = QFileDialog.getOpenFileName(self, 'Select File to Import',
                                                   dir_path, 'Dump file (*.json)')
        if not file_path:
            return

        self._import_dialog = ImportDialog(file_path, self)
        self._import_dialog.show()

```

`source/ida_migrator/migrator_dialog.py`:

```py
import os
import json
import time

import idc
import idaapi
import idautils
import ida_expr

from ida_migrator import UI_DIR
from ida_migrator.utility import log_info

from PyQt5 import uic
from PyQt5.QtCore import Qt, QTimer
from PyQt5.QtWidgets import (QMessageBox, QHeaderView,
                             QTableWidget, QTableWidgetItem,
                             QLineEdit, QFileDialog )

Ui_MigratorDialog, MigratorDialogBase = uic.loadUiType(
    os.path.join(UI_DIR, 'MigratorDialog.ui')
)

POINTER_FMT = "0x{:016X}" if idaapi.get_inf_structure().is_64bit() else "0x{:08X}"

# Table columns
col_CheckBox = 0
col_Address  = 1
col_Name     = 2

# Search debounce/delay time
FILTER_DEBOUNCE_PERIOD = 500


class MigratorDialog(MigratorDialogBase):

    def __init__(self, *args, **kwargs):
        super(MigratorDialog, self).__init__(*args, **kwargs)
        self.setWindowFlags(self.windowFlags() & ~Qt.WindowContextHelpButtonHint)
        self._ui = Ui_MigratorDialog()
        self._ui.setupUi(self)

        self.filter_timer = QTimer()
        self.filter_timer.setSingleShot(True)
        self.filter_text = ""
        self.tblFunctions = self._ui.tblFunctions

        self.connect_slots()
        self.adjust_table_layout()
        self.populate_function_names()

    def connect_slots(self):
        self._ui.btnStart.clicked.connect(self.on_start_clicked)
        self._ui.tbxSearch.textChanged.connect(self.on_search_textchanged)
        self.filter_timer.timeout.connect(self.filter_items)

    def adjust_table_layout(self):
        checkbox_width = 22
        self.tblFunctions.setColumnWidth(col_CheckBox, checkbox_width)
        self.tblFunctions.horizontalHeader().setSectionResizeMode(col_CheckBox, QHeaderView.Fixed)
        self.tblFunctions.horizontalHeader().setStretchLastSection(True)
        # self.tblFunctions.setSelectionMode(QAbstractItemView.NoSelection)
        self.tblFunctions.setFocusPolicy(Qt.NoFocus)

    # virtual
    def populate_function_names(self):
        log_info("BASE - populate_function_names")

    def append_table_item(self, index, address, function):
        # cbx = QCheckBox(self)
        # cbx.setChecked(True)
        # cbx.setStyleSheet("margin-left:10%;")
        # self.tblFunctions.setCellWidget(index, col_CheckBox, cbx)
        cbx = QTableWidgetItem()
        cbx.setCheckState(Qt.Checked)
        cbx.setTextAlignment(Qt.AlignCenter)
        cbx.setFlags(Qt.NoItemFlags | Qt.ItemIsEnabled | Qt.ItemIsUserCheckable | Qt.ItemIsSelectable)
        self.tblFunctions.setItem(index, col_CheckBox, cbx)
        self.tblFunctions.setItem(index, col_Address, QTableWidgetItem(address))
        self.tblFunctions.setItem(index, col_Name, QTableWidgetItem(function))

    # virtual
    def on_start_clicked(self):
        log_info("BASE - on_start_clicked")

    def on_search_textchanged(self, text):
        self.filter_text = text
        self.filter_timer.start(FILTER_DEBOUNCE_PERIOD)

    # TODO(Gilad): Convert this to use Qt Model/View architecture (QAbstractItemView)
    def filter_items(self):
        filter = self.filter_text.lower()
        rowCount = self.tblFunctions.rowCount()
        colCount = self.tblFunctions.columnCount()
        for row in range(rowCount):
            match = False
            for col in range(1, colCount):
                item = self.tblFunctions.item(row, col)
                if item.text().lower().find(filter) != -1:
                    match = True
                    break
            self.tblFunctions.setRowHidden(row, not match)
```

`source/ida_migrator/plugin.py`:

```py
import os

import idaapi

from PyQt5.Qt import qApp
from PyQt5.QtCore import QObject

from ida_migrator import VERSION, PLUGIN_NAME
from ida_migrator.utility import log_info
from ida_migrator.intro_dialog import IntroDialog


class IdaMigratorPlugin(QObject, idaapi.plugin_t):

    flags = idaapi.PLUGIN_FIX
    comment = "Migrating from one database instance to another."
    help = "help"
    wanted_name = PLUGIN_NAME
    wanted_hotkey = "Ctrl-Shift-D"

    def __init__(self, *args, **kwargs):
        QObject.__init__(self, *args, **kwargs)
        idaapi.plugin_t.__init__(self)
        self._intro_dialog = None

    def init(self):
        log_info("Successfully loaded plugin - v{}", VERSION)
        return idaapi.PLUGIN_KEEP

    def run(self, arg):
        self._intro_dialog = IntroDialog(qApp.activeWindow())
        self._intro_dialog.setWindowTitle("{} - v{}".format(PLUGIN_NAME, VERSION))
        self._intro_dialog.show()

    def term(self):
        pass

```

`source/ida_migrator/ui/IntroDialog.ui`:

```ui
<?xml version="1.0" encoding="UTF-8"?>
<ui version="4.0">
 <class>IntroDialog</class>
 <widget class="QDialog" name="IntroDialog">
  <property name="geometry">
   <rect>
    <x>0</x>
    <y>0</y>
    <width>393</width>
    <height>194</height>
   </rect>
  </property>
  <property name="windowTitle">
   <string>IDA Migrator</string>
  </property>
  <layout class="QVBoxLayout" name="verticalLayout">
   <item>
    <widget class="QLabel" name="lblIntro">
     <property name="font">
      <font>
       <pointsize>10</pointsize>
      </font>
     </property>
     <property name="text">
      <string>&lt;html&gt;&lt;head/&gt;&lt;body&gt;&lt;p&gt;IDA Migrator allows you to easily migrate function names, structures and enums from one database instance to another.&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/giladreich/ida_migrator&quot;&gt;&lt;span style=&quot; text-decoration: underline; color:#0000ff;&quot;&gt;github.com/giladreich/ida_migrator&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;What would you like to do?&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;</string>
     </property>
     <property name="textFormat">
      <enum>Qt::RichText</enum>
     </property>
     <property name="scaledContents">
      <bool>true</bool>
     </property>
     <property name="wordWrap">
      <bool>true</bool>
     </property>
     <property name="openExternalLinks">
      <bool>true</bool>
     </property>
    </widget>
   </item>
   <item>
    <layout class="QHBoxLayout" name="horizontalLayout">
     <item>
      <widget class="QPushButton" name="btnExport">
       <property name="font">
        <font>
         <family>MS Shell Dlg 2</family>
         <pointsize>12</pointsize>
        </font>
       </property>
       <property name="text">
        <string>Export</string>
       </property>
      </widget>
     </item>
     <item>
      <widget class="QPushButton" name="btnImport">
       <property name="font">
        <font>
         <family>MS Shell Dlg 2</family>
         <pointsize>12</pointsize>
        </font>
       </property>
       <property name="text">
        <string>Import</string>
       </property>
      </widget>
     </item>
     <item>
      <widget class="QPushButton" name="btnCancel">
       <property name="font">
        <font>
         <family>MS Shell Dlg 2</family>
         <pointsize>12</pointsize>
        </font>
       </property>
       <property name="text">
        <string>Cancel</string>
       </property>
      </widget>
     </item>
    </layout>
   </item>
  </layout>
 </widget>
 <resources/>
 <connections>
  <connection>
   <sender>btnCancel</sender>
   <signal>clicked()</signal>
   <receiver>IntroDialog</receiver>
   <slot>close()</slot>
   <hints>
    <hint type="sourcelabel">
     <x>352</x>
     <y>100</y>
    </hint>
    <hint type="destinationlabel">
     <x>394</x>
     <y>120</y>
    </hint>
   </hints>
  </connection>
 </connections>
</ui>

```

`source/ida_migrator/ui/MigratorDialog.ui`:

```ui
<?xml version="1.0" encoding="UTF-8"?>
<ui version="4.0">
 <class>MigratorDialog</class>
 <widget class="QDialog" name="MigratorDialog">
  <property name="geometry">
   <rect>
    <x>0</x>
    <y>0</y>
    <width>467</width>
    <height>344</height>
   </rect>
  </property>
  <property name="windowTitle">
   <string>XXXX</string>
  </property>
  <property name="sizeGripEnabled">
   <bool>true</bool>
  </property>
  <layout class="QVBoxLayout" name="verticalLayout">
   <item>
    <widget class="QLabel" name="lblTitle">
     <property name="font">
      <font>
       <pointsize>11</pointsize>
       <weight>75</weight>
       <bold>true</bold>
       <underline>false</underline>
      </font>
     </property>
     <property name="text">
      <string>Functions to XXXX:</string>
     </property>
    </widget>
   </item>
   <item>
    <widget class="QLineEdit" name="tbxSearch">
     <property name="placeholderText">
      <string>Search...</string>
     </property>
    </widget>
   </item>
   <item>
    <widget class="QTableWidget" name="tblFunctions">
     <property name="sizeAdjustPolicy">
      <enum>QAbstractScrollArea::AdjustToContents</enum>
     </property>
     <attribute name="horizontalHeaderCascadingSectionResizes">
      <bool>false</bool>
     </attribute>
     <attribute name="verticalHeaderCascadingSectionResizes">
      <bool>false</bool>
     </attribute>
     <column>
      <property name="text">
       <string/>
      </property>
     </column>
     <column>
      <property name="text">
       <string>Address</string>
      </property>
     </column>
     <column>
      <property name="text">
       <string>Name</string>
      </property>
     </column>
    </widget>
   </item>
   <item>
    <layout class="QHBoxLayout" name="horizontalLayout">
     <item>
      <widget class="QPushButton" name="btnStart">
       <property name="font">
        <font>
         <pointsize>10</pointsize>
        </font>
       </property>
       <property name="text">
        <string>XXXX</string>
       </property>
      </widget>
     </item>
     <item>
      <widget class="QPushButton" name="btnCancel">
       <property name="font">
        <font>
         <pointsize>10</pointsize>
        </font>
       </property>
       <property name="text">
        <string>Cancel</string>
       </property>
      </widget>
     </item>
    </layout>
   </item>
  </layout>
 </widget>
 <resources/>
 <connections>
  <connection>
   <sender>btnCancel</sender>
   <signal>clicked()</signal>
   <receiver>MigratorDialog</receiver>
   <slot>close()</slot>
   <hints>
    <hint type="sourcelabel">
     <x>436</x>
     <y>324</y>
    </hint>
    <hint type="destinationlabel">
     <x>465</x>
     <y>306</y>
    </hint>
   </hints>
  </connection>
 </connections>
</ui>

```

`source/ida_migrator/utility.py`:

```py
from ida_migrator import PLUGIN_NAME

# log_info("Message: {} - {}", "Hello", 123)
def log_info(fmt, *args):
    print("[{}]: {}".format(PLUGIN_NAME, fmt.format(*args)))

```