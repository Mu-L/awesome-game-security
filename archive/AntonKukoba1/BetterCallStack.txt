Project Path: arc_AntonKukoba1_BetterCallStack_uoyn5na2

Source Tree:

```txt
arc_AntonKukoba1_BetterCallStack_uoyn5na2
├── BetterCallStack
│   ├── BetterCallStack.cpp
│   ├── BetterCallStack.vcxproj
│   ├── BetterCallStack.vcxproj.filters
│   └── BetterCallStack.vcxproj.user
├── BetterCallStack.sln
└── README.md

```

`BetterCallStack.sln`:

```sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 16
VisualStudioVersion = 16.0.33920.266
MinimumVisualStudioVersion = 10.0.40219.1
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "BetterCallStack", "BetterCallStack\BetterCallStack.vcxproj", "{CB5986D5-E7D2-4F37-B21C-C07E76973234}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|x64 = Debug|x64
		Debug|x86 = Debug|x86
		Release|x64 = Release|x64
		Release|x86 = Release|x86
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{CB5986D5-E7D2-4F37-B21C-C07E76973234}.Debug|x64.ActiveCfg = Debug|x64
		{CB5986D5-E7D2-4F37-B21C-C07E76973234}.Debug|x64.Build.0 = Debug|x64
		{CB5986D5-E7D2-4F37-B21C-C07E76973234}.Debug|x86.ActiveCfg = Debug|Win32
		{CB5986D5-E7D2-4F37-B21C-C07E76973234}.Debug|x86.Build.0 = Debug|Win32
		{CB5986D5-E7D2-4F37-B21C-C07E76973234}.Release|x64.ActiveCfg = Release|x64
		{CB5986D5-E7D2-4F37-B21C-C07E76973234}.Release|x64.Build.0 = Release|x64
		{CB5986D5-E7D2-4F37-B21C-C07E76973234}.Release|x86.ActiveCfg = Release|Win32
		{CB5986D5-E7D2-4F37-B21C-C07E76973234}.Release|x86.Build.0 = Release|Win32
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {78637C60-DBFB-4C38-8D0E-3FCF01D8AD42}
	EndGlobalSection
EndGlobal

```

`BetterCallStack/BetterCallStack.cpp`:

```cpp
#include <ida.hpp>
#include <idd.hpp>
#include <dbg.hpp>
#include <loader.hpp>
#include <kernwin.hpp>
#include <segment.hpp>
#include <Windows.h>
#include <DbgHelp.h>

BOOL CALLBACK MyReadProcessMemoryRoutine(
    HANDLE hProcess,
    DWORD64 lpBaseAddress,
    PVOID lpBuffer,
    DWORD nSize,
    LPDWORD lpNumberOfBytesRead
)
{
    auto nRead = get_bytes(lpBuffer, nSize, lpBaseAddress, 0, nullptr);
    if (nRead <= 0)
        return FALSE;

    *lpNumberOfBytesRead = nRead;

    return TRUE;
}

BOOL CALLBACK MySymbolCallback
(
    HANDLE hProcess,
    ULONG ActionCode,
    ULONG64 CallbackData,
    ULONG64 UserContext
)
{
    if (ActionCode == CBA_READ_MEMORY)
    {
        IMAGEHLP_CBA_READ_MEMORY * memRead = (IMAGEHLP_CBA_READ_MEMORY*)CallbackData;
        return MyReadProcessMemoryRoutine(hProcess, memRead->addr, memRead->buf, memRead->bytes, memRead->bytesread);
    }

    return FALSE;
}

#define MAX_CALLSTACK_FRAMES 100

void MakeCallStack(HANDLE hThread, CONTEXT & context, call_stack_t * callstack_info) 
{
    DWORD processId = GetProcessIdOfThread(hThread);
    HANDLE hProcess = OpenProcess(PROCESS_VM_READ | PROCESS_SUSPEND_RESUME | PROCESS_QUERY_INFORMATION, FALSE, processId);
    if (!hProcess)
        return;

    SymSetOptions(SYMOPT_DEFERRED_LOADS);
    CHAR system32Path[MAX_PATH] = {0};
    GetSystemDirectoryA(system32Path, sizeof(system32Path));
    qstrncat(system32Path, ";", sizeof(system32Path));
    SymInitialize(hProcess, system32Path, TRUE);
    SymRegisterCallback64(hProcess, &MySymbolCallback, 0);

    STACKFRAME64 stackFrame;
    memset(&stackFrame, 0, sizeof(stackFrame));
    stackFrame.AddrPC.Mode = AddrModeFlat;
    stackFrame.AddrStack.Mode = AddrModeFlat;
    stackFrame.AddrFrame.Mode = AddrModeFlat;
    stackFrame.AddrBStore.Mode = AddrModeFlat;

    stackFrame.AddrPC.Offset = context.Rip;
    stackFrame.AddrStack.Offset = context.Rsp;
    stackFrame.AddrFrame.Offset = context.Rbp;
    stackFrame.AddrBStore.Offset = context.Rbp;

    for (DWORD frame = 0; frame < MAX_CALLSTACK_FRAMES; frame++) 
    {

        bool is64 = getinf_flag(INF_LFLAGS, LFLG_64BIT);
        auto machine = IMAGE_FILE_MACHINE_AMD64;
        if (!is64)
            machine = IMAGE_FILE_MACHINE_I386;

        if (!StackWalk64(machine, hProcess, hThread, &stackFrame, &context, &MyReadProcessMemoryRoutine, SymFunctionTableAccess64, SymGetModuleBase64, NULL) || 
            !stackFrame.AddrPC.Offset)
            break;

        ea_t call_ea = stackFrame.AddrPC.Offset;
        ea_t func_ea = stackFrame.AddrFrame.Offset;  
        ea_t frame_pointer = stackFrame.AddrFrame.Offset;

        call_stack_info_t stack_info;
        stack_info.callea = call_ea;
        stack_info.funcea = getseg(call_ea)->start_ea;
        stack_info.fp = frame_pointer;
        stack_info.funcok = false;
        callstack_info->push_back(stack_info);
    }

    SymCleanup(hProcess);
    CloseHandle(hProcess);
}

struct idd_listener : event_listener_t
{
    virtual ssize_t idaapi on_event(ssize_t notification_code, va_list va) override
    {
        if (notification_code != debugger_t::ev_update_call_stack)
            return 0;

        ssize_t result = 0;
        if (get_process_state() != DSTATE_RUN)
        {
            thid_t tid = va_arg(va, thid_t);
            call_stack_t* trace = va_arg(va, call_stack_t*);

            HANDLE hThread = OpenThread(THREAD_GET_CONTEXT | THREAD_SUSPEND_RESUME | THREAD_QUERY_INFORMATION, FALSE, tid);
            if (hThread == NULL)
                return 0;

            CONTEXT context;
            memset(&context, 0, sizeof(CONTEXT));
            context.ContextFlags = CONTEXT_FULL;
            if (GetThreadContext(hThread, &context))
            {
                MakeCallStack(hThread, context, trace);
                result = 1;
            }

            CloseHandle(hThread);
        }
        return result;
    }
};

plugmod_t * idaapi init(void) 
{
    if (!is_debugger_on() || (ph.id != PLFM_386))
        return PLUGIN_SKIP;

    idd_listener* listener = new idd_listener();
    
    hook_event_listener(HT_IDD, listener, listener);
    return PLUGIN_KEEP;
}

static char comment[] = "IDA Stack Trace Plugin";
static char help[] = "This plugin collects and prints the call stack of the current thread.\n";
static char wanted_name[] = "IDA Stack Trace Plugin";
static char wanted_hotkey[] = "Alt-F12";

plugin_t PLUGIN =
{
  IDP_INTERFACE_VERSION,
  PLUGIN_HIDE,         // Plugin flags
  init,                // Initialize
  nullptr,                // Terminate. Optional. Called when the plugin is unloaded
  nullptr,                 // Main plugin function. Optional. Unused in this example
  comment,             // Comment. Can be NULL
  help,                // Help. Can be NULL
  wanted_name,         // Plugin name. Can be NULL
  wanted_hotkey        // Hotkey for the plugin. Can be NULL
};
```

`BetterCallStack/BetterCallStack.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <Keyword>Win32Proj</Keyword>
    <ProjectGuid>{cb5986d5-e7d2-4f37-b21c-c07e76973234}</ProjectGuid>
    <RootNamespace>BetterCallStack</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>DynamicLibrary</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>DynamicLibrary</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <LinkIncremental>true</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <LinkIncremental>false</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <LinkIncremental>true</LinkIncremental>
    <IncludePath>D:\Tools\IDA\SDK\7.7\idasdk77\include;$(IncludePath)</IncludePath>
    <LibraryPath>D:\Tools\IDA\SDK\7.7\idasdk77\lib\x64_win_vc_64;D:\Tools\IDA\SDK\7.7\idasdk77\lib\x64_win_vc_64_s;$(LibraryPath)</LibraryPath>
    <OutDir>D:\Tools\IDA\IDA Pro 7.7 SP1 (x86, x64, ARM64)\plugins\</OutDir>
    <TargetName>$(ProjectName)64</TargetName>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <LinkIncremental>false</LinkIncremental>
    <IncludePath>D:\Tools\IDA\SDK\7.7\idasdk77\include;$(IncludePath)</IncludePath>
    <LibraryPath>D:\Tools\IDA\SDK\7.7\idasdk77\lib\x64_win_vc_64;D:\Tools\IDA\SDK\7.7\idasdk77\lib\x64_win_vc_64_s;$(LibraryPath)</LibraryPath>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>_DEBUG;_CONSOLE;__EA64__;_WINDOWS;_USRDLL;WIN32;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
      <AdditionalDependencies>Dbghelp.lib;ida.lib;pro.lib;%(AdditionalDependencies)</AdditionalDependencies>
      <AdditionalOptions>/EXPORT:PLUGIN %(AdditionalOptions)</AdditionalOptions>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
      <AdditionalDependencies>Dbghelp.lib;ida.lib;pro.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="BetterCallStack.cpp" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`BetterCallStack/BetterCallStack.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;c++;cppm;ixx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;h++;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="BetterCallStack.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`BetterCallStack/BetterCallStack.vcxproj.user`:

```user
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="Current" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <LocalDebuggerCommand>D:\Tools\IDA\IDA Pro 7.7 SP1 (x86, x64, ARM64)\ida64.exe</LocalDebuggerCommand>
    <DebuggerFlavor>WindowsLocalDebugger</DebuggerFlavor>
  </PropertyGroup>
</Project>
```

`README.md`:

```md
# BetterCallStack

## IDA 7.7 plugin to improve the call stack for Windows x64 debugger

Setup the include directory and libraries path in BetterCallStack project to point at appropriate IDA SDK directories. And then just build it. Put BetterCallStack64.dll into IDA plugins directory. That's it.

The plugin will automatically run when debugger is on. 

Without the plugin:
![image](https://github.com/AntonKukoba1/BetterCallStack/assets/35240638/9ff8423f-598e-4c17-b8c8-8127ff9a3788)

With the plugin:
![image](https://github.com/AntonKukoba1/BetterCallStack/assets/35240638/5e322e42-2d61-4dee-ab87-3859b538fd72)

So the call stack becomes as accurate as the one shown in ProcessExplorer or Windbg

```