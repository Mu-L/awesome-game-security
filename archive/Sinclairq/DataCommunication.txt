Project Path: arc_Sinclairq_DataCommunication_ygzww5km

Source Tree:

```txt
arc_Sinclairq_DataCommunication_ygzww5km
├── DataCommunication.sln
├── LICENSE
├── README.md
├── driver
│   ├── core.cpp
│   ├── core.h
│   ├── driver.inf
│   ├── driver.vcxproj
│   ├── driver.vcxproj.filters
│   ├── driver.vcxproj.user
│   ├── main.cpp
│   ├── stdafx.h
│   ├── structs.h
│   ├── util.cpp
│   └── util.h
└── usermode
    ├── comms.cpp
    ├── comms.h
    ├── main.cpp
    ├── stdafx.h
    ├── usermode.vcxproj
    ├── usermode.vcxproj.filters
    ├── usermode.vcxproj.user
    ├── util.cpp
    └── util.h

```

`DataCommunication.sln`:

```sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 16
VisualStudioVersion = 16.0.30413.136
MinimumVisualStudioVersion = 10.0.40219.1
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "driver", "driver\driver.vcxproj", "{4A9C2A65-D849-44DB-AFB5-207F816B23A2}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "usermode", "usermode\usermode.vcxproj", "{786C3084-F5E7-436A-9A2C-179597FA177D}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|ARM = Debug|ARM
		Debug|ARM64 = Debug|ARM64
		Debug|x64 = Debug|x64
		Debug|x86 = Debug|x86
		Release|ARM = Release|ARM
		Release|ARM64 = Release|ARM64
		Release|x64 = Release|x64
		Release|x86 = Release|x86
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Debug|ARM.ActiveCfg = Debug|ARM
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Debug|ARM.Build.0 = Debug|ARM
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Debug|ARM.Deploy.0 = Debug|ARM
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Debug|ARM64.ActiveCfg = Debug|ARM64
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Debug|ARM64.Build.0 = Debug|ARM64
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Debug|ARM64.Deploy.0 = Debug|ARM64
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Debug|x64.ActiveCfg = Debug|x64
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Debug|x64.Build.0 = Debug|x64
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Debug|x64.Deploy.0 = Debug|x64
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Debug|x86.ActiveCfg = Debug|Win32
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Debug|x86.Build.0 = Debug|Win32
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Debug|x86.Deploy.0 = Debug|Win32
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Release|ARM.ActiveCfg = Release|ARM
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Release|ARM.Build.0 = Release|ARM
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Release|ARM.Deploy.0 = Release|ARM
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Release|ARM64.ActiveCfg = Release|ARM64
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Release|ARM64.Build.0 = Release|ARM64
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Release|ARM64.Deploy.0 = Release|ARM64
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Release|x64.ActiveCfg = Release|x64
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Release|x64.Build.0 = Release|x64
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Release|x64.Deploy.0 = Release|x64
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Release|x86.ActiveCfg = Release|Win32
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Release|x86.Build.0 = Release|Win32
		{4A9C2A65-D849-44DB-AFB5-207F816B23A2}.Release|x86.Deploy.0 = Release|Win32
		{786C3084-F5E7-436A-9A2C-179597FA177D}.Debug|ARM.ActiveCfg = Debug|Win32
		{786C3084-F5E7-436A-9A2C-179597FA177D}.Debug|ARM64.ActiveCfg = Debug|Win32
		{786C3084-F5E7-436A-9A2C-179597FA177D}.Debug|x64.ActiveCfg = Debug|x64
		{786C3084-F5E7-436A-9A2C-179597FA177D}.Debug|x64.Build.0 = Debug|x64
		{786C3084-F5E7-436A-9A2C-179597FA177D}.Debug|x86.ActiveCfg = Debug|Win32
		{786C3084-F5E7-436A-9A2C-179597FA177D}.Debug|x86.Build.0 = Debug|Win32
		{786C3084-F5E7-436A-9A2C-179597FA177D}.Release|ARM.ActiveCfg = Release|Win32
		{786C3084-F5E7-436A-9A2C-179597FA177D}.Release|ARM64.ActiveCfg = Release|Win32
		{786C3084-F5E7-436A-9A2C-179597FA177D}.Release|x64.ActiveCfg = Release|x64
		{786C3084-F5E7-436A-9A2C-179597FA177D}.Release|x64.Build.0 = Release|x64
		{786C3084-F5E7-436A-9A2C-179597FA177D}.Release|x86.ActiveCfg = Release|Win32
		{786C3084-F5E7-436A-9A2C-179597FA177D}.Release|x86.Build.0 = Release|Win32
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {A1D10BFF-3694-4B5C-B324-22C2F866D9E8}
	EndGlobalSection
EndGlobal

```

`LICENSE`:

```
MIT License

Copyright (c) 2020 sinclair

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

```

`README.md`:

```md
# DataCommunication
A kernelmode driver swapping a .data pointer in the kernel to perform communication between the kernel and usermode.

# Information
DISCLAIMER! This will trigger PG (PatchGuard) on 2004 (untested on others.) If you try to use this raw project your system will crash after a while.

The driver will take care of the hook on the .data function residing in ntoskrnl.exe, so the driver must be loaded first.
Once the driver is loaded, run the program with the correct arguments to see if the communication has been setup correctly.

# Features
- Pattern Scanner
- Fast communication to perform r/w operations and else.
- Get the base of any process relative to it's process ID.
- etc...

# Usage

![Example](https://i.imgur.com/BPhGvSk.png)
This PoC has only been tested on 2004, but may work on 1909, and 1903.

```

`driver/core.cpp`:

```cpp
#pragma once
#include "core.h"

namespace Core {

	BOOL ReadVirtualMemory(PVOID dest, PVOID src, size_t size) {

		size_t pSize;
		if (NT_SUCCESS(MmCopyVirtualMemory(PsGetCurrentProcess(), src, 
			PsGetCurrentProcess(), dest, size, KernelMode, &pSize)
			) && size == pSize) {
			return TRUE;
		}

		return FALSE;
	}

	BOOL WriteVirtualMemory(PVOID dest, PVOID src, size_t size) {

		if (NT_SUCCESS(MmCopyVirtualMemory(PsGetCurrentProcess(), dest,
			PsGetCurrentProcess(), src, size, KernelMode, &size))) {
			return TRUE;
		}

		return FALSE;
	}

	PVOID GetModuleBase(LPCSTR moduleName) {

		PVOID moduleBase = NULL;
		ULONG info = 0;
		NTSTATUS status = ZwQuerySystemInformation(SystemModuleInformation, 0, info, &info);

		if (!info) {
			return moduleBase;
		}

		PRTL_PROCESS_MODULES modules = (PRTL_PROCESS_MODULES)ExAllocatePoolWithTag(NonPagedPool, info, 'HEIL');

		status = ZwQuerySystemInformation(SystemModuleInformation, modules, info, &info);

		if (!NT_SUCCESS(status)) {
			return moduleBase;
		}

		PRTL_PROCESS_MODULE_INFORMATION module = modules->Modules;


		if (modules->NumberOfModules > 0) {

			if (!moduleName) {
				moduleBase = modules->Modules[0].ImageBase;
			}
			else {

				for (auto i = 0; i < modules->NumberOfModules; i++) {

					if (!strcmp((CHAR*)module[i].FullPathName, moduleName)) {
						moduleBase = module[i].ImageBase;
					}
				}
			}
		}

		if (modules) {
			ExFreePoolWithTag(modules, 'HEIL');
		}

		return moduleBase;
	}

}
```

`driver/core.h`:

```h
#pragma once
#include "stdafx.h"

namespace Core {
	BOOL ReadVirtualMemory(PVOID dest, PVOID src, size_t size);
	BOOL WriteVirtualMemory(PVOID dest, PVOID src, size_t size);
	PVOID GetModuleBase(LPCSTR moduleName);
}
```

`driver/driver.inf`:

```inf
;
; DrvCommunication.inf
;

[Version]
Signature="$WINDOWS NT$"
Class=Sample ; TODO: edit Class
ClassGuid={78A1C341-4539-11d3-B88D-00C04FAD5171} ; TODO: edit ClassGuid
Provider=%ManufacturerName%
CatalogFile=DrvCommunication.cat
DriverVer= ; TODO: set DriverVer in stampinf property pages
PnpLockDown=1

[DestinationDirs]
DefaultDestDir = 12
DrvCommunication_Device_CoInstaller_CopyFiles = 11

; ================= Class section =====================

[ClassInstall32]
Addreg=SampleClassReg

[SampleClassReg]
HKR,,,0,%ClassName%
HKR,,Icon,,-5

[SourceDisksNames]
1 = %DiskName%,,,""

[SourceDisksFiles]
DrvCommunication.sys  = 1,,
WdfCoInstaller$KMDFCOINSTALLERVERSION$.dll=1 ; make sure the number matches with SourceDisksNames

;*****************************************
; Install Section
;*****************************************

[Manufacturer]
%ManufacturerName%=Standard,NT$ARCH$

[Standard.NT$ARCH$]
%DrvCommunication.DeviceDesc%=DrvCommunication_Device, Root\DrvCommunication ; TODO: edit hw-id

[DrvCommunication_Device.NT]
CopyFiles=Drivers_Dir

[Drivers_Dir]
DrvCommunication.sys

;-------------- Service installation
[DrvCommunication_Device.NT.Services]
AddService = DrvCommunication,%SPSVCINST_ASSOCSERVICE%, DrvCommunication_Service_Inst

; -------------- DrvCommunication driver install sections
[DrvCommunication_Service_Inst]
DisplayName    = %DrvCommunication.SVCDESC%
ServiceType    = 1               ; SERVICE_KERNEL_DRIVER
StartType      = 3               ; SERVICE_DEMAND_START
ErrorControl   = 1               ; SERVICE_ERROR_NORMAL
ServiceBinary  = %12%\DrvCommunication.sys

;
;--- DrvCommunication_Device Coinstaller installation ------
;

[DrvCommunication_Device.NT.CoInstallers]
AddReg=DrvCommunication_Device_CoInstaller_AddReg
CopyFiles=DrvCommunication_Device_CoInstaller_CopyFiles

[DrvCommunication_Device_CoInstaller_AddReg]
HKR,,CoInstallers32,0x00010000, "WdfCoInstaller$KMDFCOINSTALLERVERSION$.dll,WdfCoInstaller"

[DrvCommunication_Device_CoInstaller_CopyFiles]
WdfCoInstaller$KMDFCOINSTALLERVERSION$.dll

[DrvCommunication_Device.NT.Wdf]
KmdfService =  DrvCommunication, DrvCommunication_wdfsect
[DrvCommunication_wdfsect]
KmdfLibraryVersion = $KMDFVERSION$

[Strings]
SPSVCINST_ASSOCSERVICE= 0x00000002
ManufacturerName="<Your manufacturer name>" ;TODO: Replace with your manufacturer name
ClassName="Samples" ; TODO: edit ClassName
DiskName = "DrvCommunication Installation Disk"
DrvCommunication.DeviceDesc = "DrvCommunication Device"
DrvCommunication.SVCDESC = "DrvCommunication Service"

```

`driver/driver.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|ARM">
      <Configuration>Debug</Configuration>
      <Platform>ARM</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|ARM">
      <Configuration>Release</Configuration>
      <Platform>ARM</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|ARM64">
      <Configuration>Debug</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|ARM64">
      <Configuration>Release</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <ProjectGuid>{4A9C2A65-D849-44DB-AFB5-207F816B23A2}</ProjectGuid>
    <TemplateGuid>{1bc93793-694f-48fe-9372-81e2b05556fd}</TemplateGuid>
    <TargetFrameworkVersion>v4.5</TargetFrameworkVersion>
    <MinimumVisualStudioVersion>12.0</MinimumVisualStudioVersion>
    <Configuration>Debug</Configuration>
    <Platform Condition="'$(Platform)' == ''">Win32</Platform>
    <RootNamespace>driver</RootNamespace>
    <ProjectName>driver</ProjectName>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
    <Driver_SpectreMitigation>false</Driver_SpectreMitigation>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="PropertySheets">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <EnableInf2cat>false</EnableInf2cat>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>TurnOffAllWarnings</WarningLevel>
    </ClCompile>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <TreatWarningAsError>false</TreatWarningAsError>
      <BufferSecurityCheck>false</BufferSecurityCheck>
    </ClCompile>
    <Link>
      <GenerateDebugInformation>false</GenerateDebugInformation>
    </Link>
    <Link>
      <ProgramDatabaseFile />
      <EntryPointSymbol>DriverEntry</EntryPointSymbol>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <Inf Include="driver.inf" />
  </ItemGroup>
  <ItemGroup>
    <FilesToPackage Include="$(TargetPath)" />
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="core.cpp" />
    <ClCompile Include="main.cpp" />
    <ClCompile Include="util.cpp" />
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="core.h" />
    <ClInclude Include="stdafx.h" />
    <ClInclude Include="structs.h" />
    <ClInclude Include="util.h" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`driver/driver.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hpp;hxx;hm;inl;inc;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
    <Filter Include="Driver Files">
      <UniqueIdentifier>{8E41214B-6785-4CFE-B992-037D68949A14}</UniqueIdentifier>
      <Extensions>inf;inv;inx;mof;mc;</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="core.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
    <ClCompile Include="main.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
    <ClCompile Include="util.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="core.h">
      <Filter>Driver Files</Filter>
    </ClInclude>
    <ClInclude Include="stdafx.h">
      <Filter>Driver Files</Filter>
    </ClInclude>
    <ClInclude Include="structs.h">
      <Filter>Driver Files</Filter>
    </ClInclude>
    <ClInclude Include="util.h">
      <Filter>Driver Files</Filter>
    </ClInclude>
  </ItemGroup>
  <ItemGroup>
    <Inf Include="driver.inf">
      <Filter>Driver Files</Filter>
    </Inf>
  </ItemGroup>
</Project>
```

`driver/driver.vcxproj.user`:

```user
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="Current" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <SignMode>Off</SignMode>
  </PropertyGroup>
</Project>
```

`driver/main.cpp`:

```cpp
#pragma once
#include "stdafx.h"

PVOID(__fastcall* NtCompareSigningLevelsOrig)(PVOID, PVOID);

PVOID NtCompareSigningLevelsHook(Communication* arg0, PBYTE arg1) {

	/*
	* Simple check to make sure the call was from usermode.
	*/
	if (ExGetPreviousMode() != UserMode) {
		return NtCompareSigningLevelsOrig(arg0, arg1);
	}

	Communication comms = {};
	if(!Core::ReadVirtualMemory(&comms, arg0, sizeof(Communication)) || comms.Reason != COMMUNICATION_KEY) {
		return NtCompareSigningLevelsOrig(arg0, arg1);
	}

	printf("[mapper] called w reason -> 0x%x", comms.Reason);
	
	auto args = (Communication*)arg0;

	switch (comms.Request) {

		case Request::GETBASE: {

			if (comms.processID) {
				PEPROCESS process = { 0 };
				PsLookupProcessByProcessId((HANDLE)args->processID, &process);
				args->Outbase = PsGetProcessSectionBaseAddress(process);
				ObDereferenceObject(process);
			}
			break;
		}
	}

	return NULL;
}

NTSTATUS DriverEntry(PDRIVER_OBJECT driver, PUNICODE_STRING regPath) {

	RTL_OSVERSIONINFOW info = { 0 };

	if (!info.dwBuildNumber) {
		RtlGetVersion(&info);
	}

	printf("[mapper] os version -> %d", info.dwBuildNumber);

	auto base = Core::GetModuleBase(0);

	if (!base) {
		return STATUS_FAILED_DRIVER_ENTRY;
	}

	printf("[mapper] ntoskrnl.exe -> 0x%x", base);

	auto addr = Util::FindPattern(base, 
				"\x4C\x8B\x05\x00\x00\x00\x00\x33\xC0\x4D\x85\xC0\x74\x08\x49\x8B\xC0\xE8\x00\x00\x00\x00\xF7\xD8",
				"xxx????xxxxxxxxxxx????xx");

	if (!addr) {
		printf("[mapper] Unable to find signature!");
		return STATUS_FAILED_DRIVER_ENTRY;
	}

	addr = RVA(addr, 7);
	printf("[mapper] addr -> 0x%x", addr);

	*(PVOID*)&NtCompareSigningLevelsOrig =
			InterlockedExchangePointer(
				(volatile PVOID*)addr,
				NtCompareSigningLevelsHook
			);

	printf("[mapper] swapped pointer -> 0x%x to 0x%x", addr, &NtCompareSigningLevelsHook);

	return STATUS_SUCCESS;
}

```

`driver/stdafx.h`:

```h
#pragma once
#include <ntifs.h>
#include <ntddk.h>
#include <windef.h>
#include <ntimage.h>

#include "structs.h"

#define RVA(addr, size)			((PBYTE)(addr + *(DWORD*)(addr + ((size) - 4)) + size))
#define printf(text, ...)		(DbgPrintEx(0, 0, text, ##__VA_ARGS__))
#define WINVER_2004				(19041)
#define COMMUNICATION_KEY		(0xDEADBEEF)

enum Request {
	GETBASE = 0,
	READPROCESSMEMORY = 1,
	WRITEPROCESSMEMORY = 2,
	OPENHANDLE = 3,
};

struct Communication {

	Request Request;
	DWORD processID;
	DWORD Reason; // must be 0xDEADBEEF....
	PVOID Outbase; // output image base for process.

	/*
	* READ/WRITE PROCESS MEMORY.
	*/
	PVOID Address;
	PVOID result;
	size_t size;
};

extern "C" NTSTATUS ZwQuerySystemInformation(SYSTEM_INFORMATION_CLASS systemInformationClass, PVOID systemInformation, ULONG systemInformationLength, PULONG returnLength);
extern "C" NTSTATUS NTAPI MmCopyVirtualMemory(PEPROCESS SourceProcess, PVOID SourceAddress, PEPROCESS TargetProcess, PVOID TargetAddress, SIZE_T BufferSize, KPROCESSOR_MODE PreviousMode, PSIZE_T ReturnSize);
extern "C" NTKERNELAPI PVOID PsGetProcessSectionBaseAddress(PEPROCESS Process);

#include "memory.h"
#include "util.h"
#include "core.h"
```

`driver/structs.h`:

```h
#pragma once
#include "stdafx.h"

typedef enum _SYSTEM_INFORMATION_CLASS
{
	SystemInformationClassMin = 0,
	SystemBasicInformation = 0,
	SystemProcessorInformation = 1,
	SystemPerformanceInformation = 2,
	SystemTimeOfDayInformation = 3,
	SystemPathInformation = 4,
	SystemNotImplemented1 = 4,
	SystemProcessInformation = 5,
	SystemProcessesAndThreadsInformation = 5,
	SystemCallCountInfoInformation = 6,
	SystemCallCounts = 6,
	SystemDeviceInformation = 7,
	SystemConfigurationInformation = 7,
	SystemProcessorPerformanceInformation = 8,
	SystemProcessorTimes = 8,
	SystemFlagsInformation = 9,
	SystemGlobalFlag = 9,
	SystemCallTimeInformation = 10,
	SystemNotImplemented2 = 10,
	SystemModuleInformation = 11,
	SystemLocksInformation = 12,
	SystemLockInformation = 12,
	SystemStackTraceInformation = 13,
	SystemNotImplemented3 = 13,
	SystemPagedPoolInformation = 14,
	SystemNotImplemented4 = 14,
	SystemNonPagedPoolInformation = 15,
	SystemNotImplemented5 = 15,
	SystemHandleInformation = 16,
	SystemObjectInformation = 17,
	SystemPageFileInformation = 18,
	SystemPagefileInformation = 18,
	SystemVdmInstemulInformation = 19,
	SystemInstructionEmulationCounts = 19,
	SystemVdmBopInformation = 20,
	SystemInvalidInfoClass1 = 20,
	SystemFileCacheInformation = 21,
	SystemCacheInformation = 21,
	SystemPoolTagInformation = 22,
	SystemInterruptInformation = 23,
	SystemProcessorStatistics = 23,
	SystemDpcBehaviourInformation = 24,
	SystemDpcInformation = 24,
	SystemFullMemoryInformation = 25,
	SystemNotImplemented6 = 25,
	SystemLoadImage = 26,
	SystemUnloadImage = 27,
	SystemTimeAdjustmentInformation = 28,
	SystemTimeAdjustment = 28,
	SystemSummaryMemoryInformation = 29,
	SystemNotImplemented7 = 29,
	SystemNextEventIdInformation = 30,
	SystemNotImplemented8 = 30,
	SystemEventIdsInformation = 31,
	SystemNotImplemented9 = 31,
	SystemCrashDumpInformation = 32,
	SystemExceptionInformation = 33,
	SystemCrashDumpStateInformation = 34,
	SystemKernelDebuggerInformation = 35,
	SystemContextSwitchInformation = 36,
	SystemRegistryQuotaInformation = 37,
	SystemLoadAndCallImage = 38,
	SystemPrioritySeparation = 39,
	SystemPlugPlayBusInformation = 40,
	SystemNotImplemented10 = 40,
	SystemDockInformation = 41,
	SystemNotImplemented11 = 41,
	SystemInvalidInfoClass2 = 42,
	SystemProcessorSpeedInformation = 43,
	SystemInvalidInfoClass3 = 43,
	SystemCurrentTimeZoneInformation = 44,
	SystemTimeZoneInformation = 44,
	SystemLookasideInformation = 45,
	SystemSetTimeSlipEvent = 46,
	SystemCreateSession = 47,
	SystemDeleteSession = 48,
	SystemInvalidInfoClass4 = 49,
	SystemRangeStartInformation = 50,
	SystemVerifierInformation = 51,
	SystemAddVerifier = 52,
	SystemSessionProcessesInformation = 53,
	SystemInformationClassMax
} SYSTEM_INFORMATION_CLASS;

typedef struct _RTL_PROCESS_MODULE_INFORMATION
{
	HANDLE Section;
	PVOID MappedBase;
	PVOID ImageBase;
	ULONG ImageSize;
	ULONG Flags;
	USHORT LoadOrderIndex;
	USHORT InitOrderIndex;
	USHORT LoadCount;
	USHORT OffsetToFileName;
	UCHAR  FullPathName[256];

} RTL_PROCESS_MODULE_INFORMATION, * PRTL_PROCESS_MODULE_INFORMATION;

typedef struct _RTL_PROCESS_MODULES
{
	ULONG NumberOfModules;
	RTL_PROCESS_MODULE_INFORMATION Modules[1];

} RTL_PROCESS_MODULES, * PRTL_PROCESS_MODULES;

```

`driver/util.cpp`:

```cpp
#pragma once
#include "util.h"


namespace Util {

	PIMAGE_NT_HEADERS getHeader(PVOID module) {
		return (PIMAGE_NT_HEADERS)((PBYTE)module + PIMAGE_DOS_HEADER(module)->e_lfanew);
	}

    PBYTE FindPattern(PVOID module, DWORD size, LPCSTR pattern, LPCSTR mask) {

        auto checkMask = [](PBYTE buffer, LPCSTR pattern, LPCSTR mask) -> BOOL
        {
            for (auto x = buffer; *mask; pattern++, mask++, x++) {
                auto addr = *(BYTE*)(pattern);
                if (addr != *x && *mask != '?')
                    return FALSE;
            }

            return TRUE;
        };

        for (auto x = 0; x < size - strlen(mask); x++) {

            auto addr = (PBYTE)module + x;
            if (checkMask(addr, pattern, mask))
                return addr;
        }

        return NULL;
    }

    PBYTE FindPattern(PVOID base, LPCSTR pattern, LPCSTR mask) {

        auto header = getHeader(base);
        auto section = IMAGE_FIRST_SECTION(header);

        for (auto x = 0; x < header->FileHeader.NumberOfSections; x++, section++) {

            /*
            * Avoids non paged memory,
            * As well as greatly speeds up the process of scanning 30+ sections.
            */
            if (!memcmp(section->Name, ".text", 5) || !memcmp(section->Name, "PAGE", 4)) {
                auto addr = FindPattern((PBYTE)base + section->VirtualAddress, section->Misc.VirtualSize, pattern, mask);
                if (addr) {
                    printf("[mapper] Found in Section -> [ %s ]", section->Name);
                    return addr;
                }
            }
        }

        return NULL;
    }
}

```

`driver/util.h`:

```h
#pragma once
#include "stdafx.h"

namespace Util {

	PIMAGE_NT_HEADERS getHeader(PVOID module);
	PBYTE FindPattern(PVOID base, LPCSTR pattern, LPCSTR mask);
}
```

`usermode/comms.cpp`:

```cpp
#pragma once
#include "comms.h"

NTSTATUS(*NtCompareSigningLevels)(PVOID, PVOID) = nullptr;

namespace Comms {

	BOOL Setup(LPCSTR routineName) {
		auto ntdll = LoadLibraryA("ntdll.dll");
		if (!ntdll) {
			PRINTF("[mapper] failed to load ntdll!\n");
			return FALSE;
		}

		auto addr = GetProcAddress(ntdll, routineName);
		if (!addr) {
			PRINTF("[mapper] failed to find routine address!\n");
			return FALSE;
		}

		*(PVOID*)&NtCompareSigningLevels = addr;
		return TRUE;
	}

	PVOID GetBaseAddress(DWORD processID) {
		Communication request = {};
		SecureZeroMemory(&request, sizeof(Communication));

		request.Request = Request::GETBASE;
		request.Reason = 0xDEADBEEF;
		request.processID = processID;
		request.Outbase = 0;

		NtCompareSigningLevels(&request, 0);
		return request.Outbase;
	}
}
```

`usermode/comms.h`:

```h
#pragma once
#include "stdafx.h"

enum Request {
	GETBASE = 0,
	READPROCESSMEMORY = 1,
	WRITEPROCESSMEMORY = 2,
	OPENHANDLE = 3,
};

struct Communication {

	Request Request;
	DWORD processID;
	DWORD Reason; // must be 0xDEADBEEF....
	PVOID Outbase; // output image base for process.

	/*
	* READ/WRITE PROCESS MEMORY.
	*/
	PVOID Address;
	PVOID result;
	size_t size;
};

namespace Comms {
	BOOL Setup(LPCSTR routineName);
	PVOID GetBaseAddress(DWORD processID);
}
```

`usermode/main.cpp`:

```cpp
#pragma once
#include "stdafx.h"


int main(int argc, char* argv[]) {

	SetConsoleTitleA("communication p0c v1.0");

	if (argc < 2) {
		PRINTF("[mapper] invalid args! args are : usermode.exe processName\n");
		return -1;
	}

	if (!Comms::Setup("NtCompareSigningLevels")) {
		PRINTF("[mapper] failed to initialize communication!\n");
		return -1;
	}

	auto procID = Util::GetProcessID(StrToWstr(argv[1]).c_str());
	if (!procID) {
		PRINTF("[mapper] process not found!\n");
	}

	PRINTF("[mapper] Process ID -> %d\n", procID);

	auto base = Comms::GetBaseAddress(procID);
	if (!base) {
		PRINTF("[mapper] failed to get base address of process id -> %d\n", procID);
	}

	PRINTF("[mapper] Image Base -> 0x%x\n", base);
	
	std::getchar();
	return 0;
}
```

`usermode/stdafx.h`:

```h
#pragma once
#include <Windows.h>
#include <TlHelp32.h>
#include <iostream>

#define PRINTF(text, ...)		(printf_s(text, ##__VA_ARGS__))
#define StrToWstr(string)		(std::wstring(string, &string[strlen(string)]))
#include "comms.h"
#include "util.h"
```

`usermode/usermode.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="comms.cpp" />
    <ClCompile Include="main.cpp" />
    <ClCompile Include="util.cpp" />
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="comms.h" />
    <ClInclude Include="stdafx.h" />
    <ClInclude Include="util.h" />
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <Keyword>Win32Proj</Keyword>
    <ProjectGuid>{786c3084-f5e7-436a-9a2c-179597fa177d}</ProjectGuid>
    <RootNamespace>usermode</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <LinkIncremental>true</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <LinkIncremental>false</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <LinkIncremental>true</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <LinkIncremental>false</LinkIncremental>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`usermode/usermode.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;c++;cppm;ixx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;h++;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="comms.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
    <ClCompile Include="main.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
    <ClCompile Include="util.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="comms.h">
      <Filter>Header Files</Filter>
    </ClInclude>
    <ClInclude Include="stdafx.h">
      <Filter>Header Files</Filter>
    </ClInclude>
    <ClInclude Include="util.h">
      <Filter>Header Files</Filter>
    </ClInclude>
  </ItemGroup>
</Project>
```

`usermode/usermode.vcxproj.user`:

```user
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="Current" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup />
</Project>
```

`usermode/util.cpp`:

```cpp
#pragma once
#include "util.h"

namespace Util {

	DWORD GetProcessID(LPCWSTR processName) {
		HANDLE handle = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, NULL);
		DWORD procID = NULL;

		if (handle == INVALID_HANDLE_VALUE)
			return procID;

		PROCESSENTRY32W entry = { 0 };
		entry.dwSize = sizeof(PROCESSENTRY32W);

		if (Process32FirstW(handle, &entry)) {
			if (!_wcsicmp(processName, entry.szExeFile)) {
				procID = entry.th32ProcessID;
			}
			else while (Process32NextW(handle, &entry)) {
				if (!_wcsicmp(processName, entry.szExeFile)) {
					procID = entry.th32ProcessID;
				}
			}
		}

		CloseHandle(handle);
		return procID;
	}
}
```

`usermode/util.h`:

```h
#pragma once
#include "stdafx.h"

namespace Util {
	DWORD GetProcessID(LPCWSTR processName);
}
```