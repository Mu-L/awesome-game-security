Project Path: arc_ys1231_MoveCertificate_qo2e0ckx

Source Tree:

```txt
arc_ys1231_MoveCertificate_qo2e0ckx
â”œâ”€â”€ CODE_OF_CONDUCT.md
â”œâ”€â”€ LICENSE
â”œâ”€â”€ META-INF
â”‚   â””â”€â”€ com
â”‚       â””â”€â”€ google
â”‚           â””â”€â”€ android
â”‚               â”œâ”€â”€ update-binary
â”‚               â””â”€â”€ updater-script
â”œâ”€â”€ README.assets
â”‚   â”œâ”€â”€ 20221109212126575.png
â”‚   â””â”€â”€ 2024-02-19_01.27.27.png
â”œâ”€â”€ README.en.md
â”œâ”€â”€ README.md
â”œâ”€â”€ README.tr.md
â”œâ”€â”€ changelog.md
â”œâ”€â”€ customize.sh
â”œâ”€â”€ module.prop
â”œâ”€â”€ post-fs-data.sh
â”œâ”€â”€ service.sh
â”œâ”€â”€ system.prop
â””â”€â”€ update.json

```

`CODE_OF_CONDUCT.md`:

```md
# Contributor Covenant Code of Conduct

## Our Pledge

We as members, contributors, and leaders pledge to make participation in our
community a harassment-free experience for everyone, regardless of age, body
size, visible or invisible disability, ethnicity, sex characteristics, gender
identity and expression, level of experience, education, socio-economic status,
nationality, personal appearance, race, religion, or sexual identity
and orientation.

We pledge to act and interact in ways that contribute to an open, welcoming,
diverse, inclusive, and healthy community.

## Our Standards

Examples of behavior that contributes to a positive environment for our
community include:

* Demonstrating empathy and kindness toward other people
* Being respectful of differing opinions, viewpoints, and experiences
* Giving and gracefully accepting constructive feedback
* Accepting responsibility and apologizing to those affected by our mistakes,
  and learning from the experience
* Focusing on what is best not just for us as individuals, but for the
  overall community

Examples of unacceptable behavior include:

* The use of sexualized language or imagery, and sexual attention or
  advances of any kind
* Trolling, insulting or derogatory comments, and personal or political attacks
* Public or private harassment
* Publishing others' private information, such as a physical or email
  address, without their explicit permission
* Other conduct which could reasonably be considered inappropriate in a
  professional setting

## Enforcement Responsibilities

Community leaders are responsible for clarifying and enforcing our standards of
acceptable behavior and will take appropriate and fair corrective action in
response to any behavior that they deem inappropriate, threatening, offensive,
or harmful.

Community leaders have the right and responsibility to remove, edit, or reject
comments, commits, code, wiki edits, issues, and other contributions that are
not aligned to this Code of Conduct, and will communicate reasons for moderation
decisions when appropriate.

## Scope

This Code of Conduct applies within all community spaces, and also applies when
an individual is officially representing the community in public spaces.
Examples of representing our community include using an official e-mail address,
posting via an official social media account, or acting as an appointed
representative at an online or offline event.

## Enforcement

Instances of abusive, harassing, or otherwise unacceptable behavior may be
reported to the community leaders responsible for enforcement at
docs(docs): :memo: Add a code of conduct  Add a code of conduct to your project.
All complaints will be reviewed and investigated promptly and fairly.

All community leaders are obligated to respect the privacy and security of the
reporter of any incident.

## Enforcement Guidelines

Community leaders will follow these Community Impact Guidelines in determining
the consequences for any action they deem in violation of this Code of Conduct:

### 1. Correction

**Community Impact**: Use of inappropriate language or other behavior deemed
unprofessional or unwelcome in the community.

**Consequence**: A private, written warning from community leaders, providing
clarity around the nature of the violation and an explanation of why the
behavior was inappropriate. A public apology may be requested.

### 2. Warning

**Community Impact**: A violation through a single incident or series
of actions.

**Consequence**: A warning with consequences for continued behavior. No
interaction with the people involved, including unsolicited interaction with
those enforcing the Code of Conduct, for a specified period of time. This
includes avoiding interactions in community spaces as well as external channels
like social media. Violating these terms may lead to a temporary or
permanent ban.

### 3. Temporary Ban

**Community Impact**: A serious violation of community standards, including
sustained inappropriate behavior.

**Consequence**: A temporary ban from any sort of interaction or public
communication with the community for a specified period of time. No public or
private interaction with the people involved, including unsolicited interaction
with those enforcing the Code of Conduct, is allowed during this period.
Violating these terms may lead to a permanent ban.

### 4. Permanent Ban

**Community Impact**: Demonstrating a pattern of violation of community
standards, including sustained inappropriate behavior,  harassment of an
individual, or aggression toward or disparagement of classes of individuals.

**Consequence**: A permanent ban from any sort of public interaction within
the community.

## Attribution

This Code of Conduct is adapted from the [Contributor Covenant][homepage],
version 2.0, available at
https://www.contributor-covenant.org/version/2/0/code_of_conduct.html.

Community Impact Guidelines were inspired by [Mozilla's code of conduct
enforcement ladder](https://github.com/mozilla/diversity).

[homepage]: https://www.contributor-covenant.org

For answers to common questions about this code of conduct, see the FAQ at
https://www.contributor-covenant.org/faq. Translations are available at
https://www.contributor-covenant.org/translations.

```

`LICENSE`:

```
                                 Apache License
                           Version 2.0, January 2004
                        http://www.apache.org/licenses/

   TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION

   1. Definitions.

      "License" shall mean the terms and conditions for use, reproduction,
      and distribution as defined by Sections 1 through 9 of this document.

      "Licensor" shall mean the copyright owner or entity authorized by
      the copyright owner that is granting the License.

      "Legal Entity" shall mean the union of the acting entity and all
      other entities that control, are controlled by, or are under common
      control with that entity. For the purposes of this definition,
      "control" means (i) the power, direct or indirect, to cause the
      direction or management of such entity, whether by contract or
      otherwise, or (ii) ownership of fifty percent (50%) or more of the
      outstanding shares, or (iii) beneficial ownership of such entity.

      "You" (or "Your") shall mean an individual or Legal Entity
      exercising permissions granted by this License.

      "Source" form shall mean the preferred form for making modifications,
      including but not limited to software source code, documentation
      source, and configuration files.

      "Object" form shall mean any form resulting from mechanical
      transformation or translation of a Source form, including but
      not limited to compiled object code, generated documentation,
      and conversions to other media types.

      "Work" shall mean the work of authorship, whether in Source or
      Object form, made available under the License, as indicated by a
      copyright notice that is included in or attached to the work
      (an example is provided in the Appendix below).

      "Derivative Works" shall mean any work, whether in Source or Object
      form, that is based on (or derived from) the Work and for which the
      editorial revisions, annotations, elaborations, or other modifications
      represent, as a whole, an original work of authorship. For the purposes
      of this License, Derivative Works shall not include works that remain
      separable from, or merely link (or bind by name) to the interfaces of,
      the Work and Derivative Works thereof.

      "Contribution" shall mean any work of authorship, including
      the original version of the Work and any modifications or additions
      to that Work or Derivative Works thereof, that is intentionally
      submitted to Licensor for inclusion in the Work by the copyright owner
      or by an individual or Legal Entity authorized to submit on behalf of
      the copyright owner. For the purposes of this definition, "submitted"
      means any form of electronic, verbal, or written communication sent
      to the Licensor or its representatives, including but not limited to
      communication on electronic mailing lists, source code control systems,
      and issue tracking systems that are managed by, or on behalf of, the
      Licensor for the purpose of discussing and improving the Work, but
      excluding communication that is conspicuously marked or otherwise
      designated in writing by the copyright owner as "Not a Contribution."

      "Contributor" shall mean Licensor and any individual or Legal Entity
      on behalf of whom a Contribution has been received by Licensor and
      subsequently incorporated within the Work.

   2. Grant of Copyright License. Subject to the terms and conditions of
      this License, each Contributor hereby grants to You a perpetual,
      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
      copyright license to reproduce, prepare Derivative Works of,
      publicly display, publicly perform, sublicense, and distribute the
      Work and such Derivative Works in Source or Object form.

   3. Grant of Patent License. Subject to the terms and conditions of
      this License, each Contributor hereby grants to You a perpetual,
      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
      (except as stated in this section) patent license to make, have made,
      use, offer to sell, sell, import, and otherwise transfer the Work,
      where such license applies only to those patent claims licensable
      by such Contributor that are necessarily infringed by their
      Contribution(s) alone or by combination of their Contribution(s)
      with the Work to which such Contribution(s) was submitted. If You
      institute patent litigation against any entity (including a
      cross-claim or counterclaim in a lawsuit) alleging that the Work
      or a Contribution incorporated within the Work constitutes direct
      or contributory patent infringement, then any patent licenses
      granted to You under this License for that Work shall terminate
      as of the date such litigation is filed.

   4. Redistribution. You may reproduce and distribute copies of the
      Work or Derivative Works thereof in any medium, with or without
      modifications, and in Source or Object form, provided that You
      meet the following conditions:

      (a) You must give any other recipients of the Work or
          Derivative Works a copy of this License; and

      (b) You must cause any modified files to carry prominent notices
          stating that You changed the files; and

      (c) You must retain, in the Source form of any Derivative Works
          that You distribute, all copyright, patent, trademark, and
          attribution notices from the Source form of the Work,
          excluding those notices that do not pertain to any part of
          the Derivative Works; and

      (d) If the Work includes a "NOTICE" text file as part of its
          distribution, then any Derivative Works that You distribute must
          include a readable copy of the attribution notices contained
          within such NOTICE file, excluding those notices that do not
          pertain to any part of the Derivative Works, in at least one
          of the following places: within a NOTICE text file distributed
          as part of the Derivative Works; within the Source form or
          documentation, if provided along with the Derivative Works; or,
          within a display generated by the Derivative Works, if and
          wherever such third-party notices normally appear. The contents
          of the NOTICE file are for informational purposes only and
          do not modify the License. You may add Your own attribution
          notices within Derivative Works that You distribute, alongside
          or as an addendum to the NOTICE text from the Work, provided
          that such additional attribution notices cannot be construed
          as modifying the License.

      You may add Your own copyright statement to Your modifications and
      may provide additional or different license terms and conditions
      for use, reproduction, or distribution of Your modifications, or
      for any such Derivative Works as a whole, provided Your use,
      reproduction, and distribution of the Work otherwise complies with
      the conditions stated in this License.

   5. Submission of Contributions. Unless You explicitly state otherwise,
      any Contribution intentionally submitted for inclusion in the Work
      by You to the Licensor shall be under the terms and conditions of
      this License, without any additional terms or conditions.
      Notwithstanding the above, nothing herein shall supersede or modify
      the terms of any separate license agreement you may have executed
      with Licensor regarding such Contributions.

   6. Trademarks. This License does not grant permission to use the trade
      names, trademarks, service marks, or product names of the Licensor,
      except as required for reasonable and customary use in describing the
      origin of the Work and reproducing the content of the NOTICE file.

   7. Disclaimer of Warranty. Unless required by applicable law or
      agreed to in writing, Licensor provides the Work (and each
      Contributor provides its Contributions) on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
      implied, including, without limitation, any warranties or conditions
      of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
      PARTICULAR PURPOSE. You are solely responsible for determining the
      appropriateness of using or redistributing the Work and assume any
      risks associated with Your exercise of permissions under this License.

   8. Limitation of Liability. In no event and under no legal theory,
      whether in tort (including negligence), contract, or otherwise,
      unless required by applicable law (such as deliberate and grossly
      negligent acts) or agreed to in writing, shall any Contributor be
      liable to You for damages, including any direct, indirect, special,
      incidental, or consequential damages of any character arising as a
      result of this License or out of the use or inability to use the
      Work (including but not limited to damages for loss of goodwill,
      work stoppage, computer failure or malfunction, or any and all
      other commercial damages or losses), even if such Contributor
      has been advised of the possibility of such damages.

   9. Accepting Warranty or Additional Liability. While redistributing
      the Work or Derivative Works thereof, You may choose to offer,
      and charge a fee for, acceptance of support, warranty, indemnity,
      or other liability obligations and/or rights consistent with this
      License. However, in accepting such obligations, You may act only
      on Your own behalf and on Your sole responsibility, not on behalf
      of any other Contributor, and only if You agree to indemnify,
      defend, and hold each Contributor harmless for any liability
      incurred by, or claims asserted against, such Contributor by reason
      of your accepting any such warranty or additional liability.

   END OF TERMS AND CONDITIONS

   APPENDIX: How to apply the Apache License to your work.

      To apply the Apache License to your work, attach the following
      boilerplate notice, with the fields enclosed by brackets "[]"
      replaced with your own identifying information. (Don't include
      the brackets!)  The text should be enclosed in the appropriate
      comment syntax for the file format. We also recommend that a
      file or class name and description of purpose be included on the
      same "printed page" as the copyright notice for easier
      identification within third-party archives.

   Copyright [yyyy] [name of copyright owner]

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

```

`META-INF/com/google/android/update-binary`:

```
#!/sbin/sh

#################
# Initialization
#################

umask 022

# echo before loading util_functions
ui_print() { echo "$1"; }

require_new_magisk() {
  ui_print "*******************************"
  ui_print " Please install Magisk v20.4+! "
  ui_print "*******************************"
  exit 1
}

#########################
# Load util_functions.sh
#########################

OUTFD=$2
ZIPFILE=$3

mount /data 2>/dev/null

[ -f /data/adb/magisk/util_functions.sh ] || require_new_magisk
. /data/adb/magisk/util_functions.sh
[ $MAGISK_VER_CODE -lt 20400 ] && require_new_magisk

install_module
exit 0
```

`META-INF/com/google/android/updater-script`:

```
#MAGISK

```

`README.en.md`:

```md
# [Move Certificate](https://github.com/ys1231/MoveCertificate)

[ä¸­æ–‡](README.md) | [TÃ¼rkÃ§e](README.tr.md)

A `Magisk/KernelSU/APatch` module for moving user certificates to system certificates. Supports `Android 7-15`.
If your phone has an official image, you might need this module. If you compile your own ROM, you can either build it in or manually move it using `remount`.

# Usage

1. After exporting the certificate, simply `push` it to your phone and install it normally through system settings, then restart. No format conversion needed.
2. Can be used with [appproxy](https://github.com/ys1231/appproxy) VPN proxy tool.

## Manual Certificate Installation to System Certificate Directory

- **This method will overwrite existing certificates, designed for multiple computers and built-in certificates**
- Normally, this scenario is not needed.

0. If the certificate has been moved before or built into the source code, you'll find that direct installation through the system doesn't actually install the certificate. This scenario needs to be preserved.

1. Export the packet capture software certificate and convert it to pem format
2. Get the certificate hash

```shell
# For pem certificates (Android system uses der, so the moved certificate needs to be converted to der)
## 1. Calculate hash
### For OpenSSL versions above 1.0
openssl x509 -inform PEM -subject_hash_old -in cacert.pem
### For OpenSSL versions below 1.0
openssl x509 -inform PEM -subject_hash -in cacert.pem
## 2. Convert to der
openssl x509 -in cacert.pem -outform der -out cacert.der
mv cacert.der 02e06844.0

# For der certificates
## 1. First convert to pem to calculate hash
openssl x509 -in cacert.der -inform der -outform pem -out cacert.pem
openssl x509 -inform PEM -subject_hash_old -in cacert.pem
## 1.1 Or directly calculate der
openssl x509 -in cacert.der -inform der -subject_hash_old -noout
## 2. Rename certificate to hash.0
mv cacert.der 02e06844.0
# Or directly extract the certificate from the user directory after phone installation, no need to worry about calculation and format conversion.
```

4. Manually rename the certificate file (before conversion) to `02e06844.0`, or coexist as `02e06844.1`
5. `adb push 02e06844.0  /data/local/tmp/cert/`
6. After pushing the certificate to the phone, restart to take effect.

# Test Results
![2024-02-19_01.27.27](README.assets/2024-02-19_01.27.27.png)

## Star History

[![Star History Chart](https://api.star-history.com/svg?repos=ys1231/MoveCertificate&type=Date)](https://star-history.com/#ys1231/MoveCertificate&Date)

# References:
- http://www.zhuoyue360.com/crack/60.html
- https://topjohnwu.github.io/Magisk/guides.html#boot-scripts
- https://github.com/Magisk-Modules-Repo/movecert
- https://github.com/andyacer/movecert
- https://book.hacktricks.xyz/v/cn/mobile-pentesting/android-app-pentesting/install-burp-certificate#android-14-zhi-hou 
- https://kernelsu.org/zh_CN/guide/module.html 
```

`README.md`:

```md
# [Move Certificate](https://github.com/ys1231/MoveCertificate)

[English](README.en.md) | [TÃ¼rkÃ§e](README.tr.md)

è¿™æ˜¯ä¸€ä¸ª`Magisk/KernelSU/APatch`æ¨¡å— ç”¨äºŽç§»åŠ¨ç”¨æˆ·è¯ä¹¦åˆ°ç³»ç»Ÿè¯ä¹¦.æ”¯æŒ`Android 7-15`
å¦‚æžœæ‰‹æœºæ˜¯å®˜æ–¹é•œåƒ,å¯èƒ½å°±éœ€è¦å€ŸåŠ©æ¨¡å—,å¦‚æžœæ˜¯è‡ªå·±ç¼–è¯‘çš„ç›´æŽ¥å†…ç½®æˆ–è€…`remount`æ‰‹åŠ¨ç§»ä¸€ä¸‹å°±è¡Œäº†.

# ä½¿ç”¨æ–¹æ³•

1. å¯¼å‡ºè¯ä¹¦åŽç›´æŽ¥`push`åˆ°æ‰‹æœº,ä½¿ç”¨ç³»ç»Ÿè®¾ç½®æ­£å¸¸å®‰è£…è¯ä¹¦,å®Œäº†é‡å¯å³å¯,ä¸éœ€è¦æ ¼å¼è½¬æ¢.
2. å¯æ­é… [appproxy](https://github.com/ys1231/appproxy) vpnä»£ç†å·¥å…·.

## æ‰‹åŠ¨å®‰è£…è¯ä¹¦åˆ°ç³»ç»Ÿè¯ä¹¦ç›®å½•

- **æ­¤æ–¹æ³•ä¼šè¦†ç›–å·²æœ‰çš„è¯ä¹¦ï¼Œä¸“ä¸ºå¤šå°ç”µè„‘å’Œå†…ç½®è¯ä¹¦å‡†å¤‡**
- æ­£å¸¸æƒ…å†µä¸‹,ä¸éœ€è¦æ­¤åœºæ™¯.

0. å¦‚æžœè¯ä¹¦å·²ç»ç§»åŠ¨è¿‡æˆ–è€…å†…ç½®åˆ°æºç ä¸­ï¼Œä¼šå‘çŽ°ç›´æŽ¥é€šè¿‡ç³»ç»Ÿå®‰è£…ï¼Œå®žé™…è¯ä¹¦å¹¶æ²¡æœ‰è¢«å®‰è£…è¿›åŽ»ï¼Œéœ€è¦ä¿ç•™è¿™ç§åœºæ™¯

1. å¯¼å‡ºæŠ“åŒ…è½¯ä»¶è¯ä¹¦ è½¬æ¢ è¯ä¹¦ä¸º pem æ ¼å¼
2. ~~`adb shell "mkdir -p  /data/local/tmp/cert"`~~
3. èŽ·å–è¯ä¹¦hash

```shell
# pem è¯ä¹¦ Android ç³»ç»Ÿä½¿ç”¨ der æ‰€ä»¥ç§»åŠ¨åŽçš„è¯ä¹¦æ ¼å¼éœ€è¦è½¬æˆ der
## 1. è®¡ç®— hash
### ä¸åŒopensslç‰ˆæœ¬ 1.0ä»¥ä¸Šçš„
openssl x509 -inform PEM -subject_hash_old -in cacert.pem
### ä¸åŒopensslç‰ˆæœ¬ 1.0ä»¥ä¸‹çš„
openssl x509 -inform PEM -subject_hash -in cacert.pem
## 2. è½¬der
openssl x509 -in cacert.pem -outform der -out cacert.der
mv cacert.der 02e06844.0

# der è¯ä¹¦ 
## 1. å…ˆè½¬ pem è®¡ç®—hash
openssl x509 -in cacert.der -inform der -outform pem -out cacert.pem
openssl x509 -inform PEM -subject_hash_old -in cacert.pem
## 1.1 æˆ–è€…ç›´æŽ¥è®¡ç®— der
openssl x509 -in cacert.der -inform der -subject_hash_old -noout
## 2. é‡å‘½åè¯ä¹¦ä¸º hashå€¼.0
mv cacert.der 02e06844.0
# æˆ–è€…ç›´æŽ¥ä½¿ç”¨æ‰‹æœºå®‰è£…åŽ,æå–ç”¨æˆ·ç›®å½•çš„è¯ä¹¦å‡ºæ¥,å°±ä¸éœ€è¦è€ƒè™‘è®¡ç®—å’Œæ ¼å¼è½¬æ¢é—®é¢˜.
```

![20221109212126575](README.assets/20221109212126575.png)

4. æ‰‹åŠ¨ä¿®æ”¹è¯ä¹¦(**è½¬æ¢å‰**)æ–‡ä»¶åä¸º`02e06844.0`,æˆ–è€…å…±å­˜`02e06844.1`
5. ~~`mkdir /data/local/tmp/cert`  è¿™ä¸ªcertç›®å½•éœ€è¦è‡ªå·±åˆ›å»º~~
6. `adb push 02e06844.0  /data/local/tmp/cert/`
7. è¯ä¹¦æŽ¨åˆ°æ‰‹æœºåŽ,é‡å¯å³å¯ç”Ÿæ•ˆï¼Œçªç„¶å‘çŽ°å¾—ä¿ç•™è¿™ç§åœºæ™¯ã€‚

# ä½¿ç”¨å®žæµ‹
![2024-02-19_01.27.27](README.assets/2024-02-19_01.27.27.png)

## Star History

[![Star History Chart](https://api.star-history.com/svg?repos=ys1231/MoveCertificate&type=Date)](https://star-history.com/#ys1231/MoveCertificate&Date)

# å‚è€ƒé“¾æŽ¥:
- http://www.zhuoyue360.com/crack/60.html
- https://topjohnwu.github.io/Magisk/guides.html#boot-scripts
- https://github.com/Magisk-Modules-Repo/movecert
- https://github.com/andyacer/movecert
- https://book.hacktricks.xyz/v/cn/mobile-pentesting/android-app-pentesting/install-burp-certificate#android-14-zhi-hou 
- https://kernelsu.org/zh_CN/guide/module.html

```

`README.tr.md`:

```md
# [Move Certificate](https://github.com/ys1231/MoveCertificate)

[English](README.en.md) | [ä¸­æ–‡](README.md)

KullanÄ±cÄ± sertifikalarÄ±nÄ± sistem sertifikalarÄ±na taÅŸÄ±mak iÃ§in bir `Magisk/KernelSU/APatch` modÃ¼lÃ¼. `Android 7-15` destekler.
EÄŸer telefonunuz resmi bir imaja sahipse, bu modÃ¼le ihtiyacÄ±nÄ±z olabilir. Kendi ROM'unuzu derliyorsanÄ±z, sertifikayÄ± doÄŸrudan iÃ§ine ekleyebilir veya `remount` kullanarak manuel olarak taÅŸÄ±yabilirsiniz.

# KullanÄ±m

1. SertifikayÄ± dÄ±ÅŸa aktardÄ±ktan sonra, doÄŸrudan telefonunuza `push` yapÄ±n ve sistem ayarlarÄ± Ã¼zerinden normal ÅŸekilde yÃ¼kleyin, ardÄ±ndan yeniden baÅŸlatÄ±n. Format dÃ¶nÃ¼ÅŸÃ¼mÃ¼ne gerek yoktur.
2. [appproxy](https://github.com/ys1231/appproxy) VPN proxy aracÄ± ile kullanÄ±labilir.

## Sistem Sertifika Dizinine Manuel Sertifika Kurulumu

- **Bu yÃ¶ntem mevcut sertifikalarÄ±n Ã¼zerine yazar, birden fazla bilgisayar ve yerleÅŸik sertifikalar iÃ§in tasarlanmÄ±ÅŸtÄ±r**
- Normalde bu senaryoya ihtiyaÃ§ yoktur.

0. EÄŸer sertifika daha Ã¶nce taÅŸÄ±nmÄ±ÅŸsa veya kaynak koduna yerleÅŸtirilmiÅŸse, sistem Ã¼zerinden doÄŸrudan kurulumun aslÄ±nda sertifikayÄ± kurmadÄ±ÄŸÄ±nÄ± gÃ¶receksiniz. Bu senaryo korunmalÄ±dÄ±r.

1. Paket yakalama yazÄ±lÄ±mÄ± sertifikasÄ±nÄ± dÄ±ÅŸa aktarÄ±n ve pem formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼n
2. Sertifika hash'ini alÄ±n

```shell
# pem sertifikalarÄ± iÃ§in (Android sistemi der kullanÄ±r, bu yÃ¼zden taÅŸÄ±nan sertifikanÄ±n der'ye dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmesi gerekir)
## 1. Hash hesapla
### OpenSSL 1.0 Ã¼stÃ¼ versiyonlar iÃ§in
openssl x509 -inform PEM -subject_hash_old -in cacert.pem
### OpenSSL 1.0 altÄ± versiyonlar iÃ§in
openssl x509 -inform PEM -subject_hash -in cacert.pem
## 2. der'ye dÃ¶nÃ¼ÅŸtÃ¼r
openssl x509 -in cacert.pem -outform der -out cacert.der
mv cacert.der 02e06844.0

# der sertifikalarÄ± iÃ§in
## 1. Ã–nce hash hesaplamak iÃ§in pem'e dÃ¶nÃ¼ÅŸtÃ¼r
openssl x509 -in cacert.der -inform der -outform pem -out cacert.pem
openssl x509 -inform PEM -subject_hash_old -in cacert.pem
## 1.1 DoÄŸrudan der hesaplayÄ±n
openssl x509 -in cacert.der -inform der -subject_hash_old -noout
## 2. SertifikayÄ± hash.0 olarak yeniden adlandÄ±r
mv cacert.der 02e06844.0
# Veya telefon kurulumundan sonra doÄŸrudan kullanÄ±cÄ± dizininden sertifikayÄ± Ã§Ä±karabilirsiniz, hesaplama ve format dÃ¶nÃ¼ÅŸÃ¼mÃ¼ endiÅŸesine gerek yok.
```

4. Sertifika dosyasÄ±nÄ± (dÃ¶nÃ¼ÅŸtÃ¼rmeden Ã¶nce) manuel olarak `02e06844.0` olarak yeniden adlandÄ±rÄ±n veya `02e06844.1` olarak birlikte var olun
5. `adb push 02e06844.0  /data/local/tmp/cert/`
6. SertifikayÄ± telefona gÃ¶nderdikten sonra, etkili olmasÄ± iÃ§in yeniden baÅŸlatÄ±n.

# Test SonuÃ§larÄ±
![2024-02-19_01.27.27](README.assets/2024-02-19_01.27.27.png)

## YÄ±ldÄ±z GeÃ§miÅŸi

[![Star History Chart](https://api.star-history.com/svg?repos=ys1231/MoveCertificate&type=Date)](https://star-history.com/#ys1231/MoveCertificate&Date)

# Referanslar:
- http://www.zhuoyue360.com/crack/60.html
- https://topjohnwu.github.io/Magisk/guides.html#boot-scripts
- https://github.com/Magisk-Modules-Repo/movecert
- https://github.com/andyacer/movecert
- https://book.hacktricks.xyz/v/cn/mobile-pentesting/android-app-pentesting/install-burp-certificate#android-14-zhi-hou 
- https://kernelsu.org/zh_CN/guide/module.html 
```

`changelog.md`:

```md
- feat(sh): :fire: #45 Compatible with AdGuard
- 1. Compatible with AdGuard, Skip "AdGuard Intermediate CA"
---
- chore(UI): :tada: Adapt to dark mode
---
- Merge pull request #41 from SafaSafari/iyue
- fix android 14 system ca
---
- fix(webui): ðŸ› #34 ä¿®å¤è¯†åˆ«è¯ä¹¦å¤±è´¥
- fix(webui): ðŸ› #34 Failed to repair recognition certificate
---
- build(webroot): :fire: è¯†åˆ«è¯ä¹¦ä¼˜åŒ–
- build(webroot): :fire: Recognition Certificate Optimization
```

`customize.sh`:

```sh
##########################################################################################
#
# Magisk Module Installer Script
#
##########################################################################################

# skip all default installation steps
SKIPUNZIP=0

# Set what you want to display when installing your module

print_modname() {
  ui_print " "
  ui_print "*******************************"
  ui_print " Supports Android7-15 move cert"
  ui_print "*******************************"
  ui_print " "
}

# Copy/extract your module files into $MODDIR in on_install.

on_install() {

  # F_TARGETDIR="$MODDIR/system/etc/security/cacerts/"
  D_CERTIFICATE="$MODPATH/certificates"

  # mkdir -p "$F_TARGETDIR"
  # create temp cert
  D_TMP_CERT=/data/local/tmp/cert

  if [ -f "$D_TMP_CERT" ]; then
    ui_print "- ${D_TMP_CERT} found"
  else
    ui_print "- create ${D_TMP_CERT}"
    mkdir -p -m 777 "$D_TMP_CERT"
  fi
  # ui_print "- mkdir $MODPATH/certificates"
  mkdir -p -m 755 "$D_CERTIFICATE"
  mkdir -p -m 755 /data/misc/user/0/cacerts-added
}

# You can add more functions to assist your custom script code
print_modname
on_install

```

`module.prop`:

```prop
id=MoveCertificate
name=MoveCertificate
version=v1.5.5
versionCode=22
author=Contributors
description=Supports magiskv20.4+/kernelsu/APatch Android 7-15 move certificates
updateJson=https://pfile.ys1231.cn/modules/MoveCertificate/update.json

```

`post-fs-data.sh`:

```sh
#!/system/bin/sh
# Do NOT assume where your module will be located.
# ALWAYS use $MODDIR if you need to know where this script
# and module is placed.
# This will make sure your module will still work
# if Magisk change its mount point in the future
MODDIR=${0%/*}

# This script will be executed in post-fs-data mode
# Android 14 cannot be earlier than Zygote
sdk_version=$(getprop ro.build.version.sdk)
# debug
#sdk_version=34
sdk_version_number=$(expr "$sdk_version" + 0)

# add logcat
LOG_PATH="$MODDIR/install.log"
LOG_TAG="iyue"

## Keep only one up-to-date log
echo "[$LOG_TAG] Keep only one up-to-date log" >$LOG_PATH
print_log() {
    echo "[$LOG_TAG] $@" >>$LOG_PATH
}

# PATH DIR
## TMPDIR
TMP_CERT_DIR=$MODDIR/certificates

## Custom certificate directory
CUSTOM_CERT_DIR=/data/local/tmp/cert

## User certificate directory
USER_CERT_DIR=/data/misc/user/0/cacerts-added

## System certificate directory
SYSTEM_CERT_DIR=/system/etc/security/cacerts

## Apex conscrypt directory
APEX_CONSCRYPT_DIR=/apex/com.android.conscrypt/cacerts


move_custom_cert() {
    if [ "$(ls -A $CUSTOM_CERT_DIR)" ]; then
        cp -f $CUSTOM_CERT_DIR/* $TMP_CERT_DIR
        cp -f $CUSTOM_CERT_DIR/* $USER_CERT_DIR
    else
        print_log "The directory $CUSTOM_CERT_DIR is empty."
    fi
    print_log "Install $CUSTOM_CERT_DIR status:$?"
}

fix_user_permissions() {
    # "Fix permissions of the system certificate directory"
    chown -R root:root $USER_CERT_DIR/
    chmod -R 666 $USER_CERT_DIR/
    chown system:system $USER_CERT_DIR
    chmod 755 $USER_CERT_DIR
    print_log "fix user certificate permissions status:$?"
}

fix_system_permissions() {
    chown root:root $SYSTEM_CERT_DIR/
    chown -R root:root $SYSTEM_CERT_DIR/
    chmod -R 644 $SYSTEM_CERT_DIR/
    chmod 755 $SYSTEM_CERT_DIR/
    chcon u:object_r:system_file:s0 $SYSTEM_CERT_DIR/*
    print_log "fix permissions $SYSTEM_CERT_DIR status:$?"
}

fix_system_permissions14() {
    chown -R system:system "$1"
    chown root:shell "$1"
    chmod -R 644 "$1"
    chmod 755 "$1"
    print_log "fix permissions: $?"
}

set_selinux_context(){
    [ "$(getenforce)" = "Enforcing" ] || return 0
    default_selinux_context=u:object_r:system_security_cacerts_file:s0
    selinux_context=$(ls -Zd $1 | awk '{print $1}')

    if [ -n "$selinux_context" ] && [ "$selinux_context" != "?" ]; then
        chcon -R $selinux_context $2
    else
        chcon -R $default_selinux_context $2
    fi
}

compatible(){
    # compatible adguard or other
    # Hash 47ec1af8 is for "AdGuard Intermediate CA" intermediate.
    print_log "Compatible adguard"
    cert_dir=$TMP_CERT_DIR
    print_log "Running compatibility cleanup for potentially conflicting certificates."

    # Remove by filename pattern (hash: 47ec1af8.*)
    rm -f "$cert_dir"/47ec1af8.*
    print_log "Removed files matching '47ec1af8.*'."

    # Remove by content string "Guard Personal Intermediate"
    for cert_file in "$cert_dir"/*; do
        # Ensure it is a file before trying to read it
        if [ -f "$cert_file" ]; then
            # Use grep -q for a silent, efficient check
            if grep -q "Guard Personal Intermediate" "$cert_file"; then
                print_log "Removing file containing 'Guard Personal Intermediate': $(basename "$cert_file")"
                rm -f "$cert_file"
            fi
        fi
    done
    print_log "Compatibility cleanup status:$?"
}

# Android version <= 13 execute
if [ "$sdk_version_number" -le 33 ]; then
    print_log "start move cert !"
    print_log "current sdk version is $sdk_version_number"
    print_log "Backup $SYSTEM_CERT_DIR"
    cp -u $SYSTEM_CERT_DIR/* $TMP_CERT_DIR
    print_log "Backup $USER_CERT_DIR"
    cp -u $USER_CERT_DIR/* $TMP_CERT_DIR
    # Android 13 or lower versions perform
    move_custom_cert
    fix_user_permissions
    compatible
    selinux_context=$(ls -Zd $SYSTEM_CERT_DIR | awk '{print $1}')
    mount -t tmpfs tmpfs $SYSTEM_CERT_DIR
    print_log "mount $SYSTEM_CERT_DIR status:$?"
    
    cp -f $TMP_CERT_DIR/* $SYSTEM_CERT_DIR
    
    print_log "Install $SYSTEM_CERT_DIR status:$?"
    fix_system_permissions
    print_log "certificates installed"
    [ "$(getenforce)" = "Enforcing" ] || return 0
    default_selinux_context=u:object_r:system_security_cacerts_file:s0
    if [ -n "$selinux_context" ] && [ "$selinux_context" != "?" ]; then
        chcon -R $selinux_context $SYSTEM_CERT_DIR
    else
        chcon -R $default_selinux_context $SYSTEM_CERT_DIR
    fi
else

    print_log "start move cert !"
    print_log "current sdk version is $sdk_version_number"
    
    print_log "Backup $APEX_CONSCRYPT_DIR"
    cp -u $APEX_CONSCRYPT_DIR/* $TMP_CERT_DIR
    print_log "Backup $USER_CERT_DIR"
    cp -u $USER_CERT_DIR/* $TMP_CERT_DIR
    move_custom_cert
    fix_user_permissions
    fix_system_permissions14 $TMP_CERT_DIR
    compatible
    
    mount -t tmpfs tmpfs $SYSTEM_CERT_DIR
    print_log "mount $SYSTEM_CERT_DIR status:$?"
    cp -f $TMP_CERT_DIR/* $SYSTEM_CERT_DIR
    print_log "find system conscrypt directory"
    apex_dir=$(find /apex -type d -name "com.android.conscrypt@*")
    print_log "find conscrypt directory: $apex_dir"

    set_selinux_context $APEX_CONSCRYPT_DIR $SYSTEM_CERT_DIR
    # These two directories are mapped to the same block
    mount -o bind $SYSTEM_CERT_DIR $APEX_CONSCRYPT_DIR
    print_log "mount bind $SYSTEM_CERT_DIR $APEX_CONSCRYPT_DIR status:$?"
    mount -o bind $SYSTEM_CERT_DIR $apex_dir/cacerts
    print_log "mount bind $SYSTEM_CERT_DIR $apex_dir/cacerts status:$?"
    for pid in 1 $(pgrep zygote) $(pgrep zygote64); do
            nsenter --mount=/proc/${pid}/ns/mnt -- mount --rbind $SYSTEM_CERT_DIR $APEX_CONSCRYPT_DIR
            nsenter --mount=/proc/${pid}/ns/mnt -- mount --rbind $SYSTEM_CERT_DIR $apex_dir/cacerts
    done
    print_log "certificates installed"
fi

```

`service.sh`:

```sh
#!/system/bin/sh
# Do NOT assume where your module will be located.
# ALWAYS use $MODDIR if you need to know where this script
# and module is placed.
# This will make sure your module will still work
# if Magisk change its mount point in the future
MODDIR=${0%/*}

```

`system.prop`:

```prop
# This file will be read by resetprop
# Example: Change dpi
# ro.sf.lcd_density=320

```

`update.json`:

```json
{
    "versionCode": 22,
    "version": "v1.5.5",
    "zipUrl": "https://pfile.ys1231.cn/modules/MoveCertificate/MoveCertificate-v1.5.5.zip",
    "changelog": "https://pfile.ys1231.cn/modules/MoveCertificate/changelog.md"
}
```