Project Path: arc_repnz_apc-research_4ce3m2dw

Source Tree:

```txt
arc_repnz_apc-research_4ce3m2dw
├── 32bitApc
│   ├── 32BitApc.c
│   ├── 32bitApc.vcxproj
│   └── 32bitApc.vcxproj.filters
├── AlertableStateApcPending
│   ├── AlertableStateApcPending.c
│   ├── AlertableStateApcPending.vcxproj
│   └── AlertableStateApcPending.vcxproj.filters
├── ApcDllInjector
│   ├── ApcDllInjector.c
│   ├── ApcDllInjector.vcxproj
│   └── ApcDllInjector.vcxproj.filters
├── ApcLib
│   ├── ApcLib.c
│   ├── ApcLib.cpp
│   ├── ApcLib.h
│   ├── ApcLib.vcxproj
│   ├── ApcLib.vcxproj.filters
│   ├── PEParser.h
│   └── PeParser.c
├── ApcRaceConditionExample
│   ├── ApcRaceConditionExample.c
│   ├── ApcRaceConditionExample.vcxproj
│   └── ApcRaceConditionExample.vcxproj.filters
├── ApcResearch.sln
├── ApcRoutineUseContextRecord
│   ├── ApcRoutineUseContextRecord.c
│   ├── ApcRoutineUseContextRecord.vcxproj
│   └── ApcRoutineUseContextRecord.vcxproj.filters
├── InitialNtTestAlert
│   ├── InitialNtTestAlert.c
│   ├── InitialNtTestAlert.vcxproj
│   └── InitialNtTestAlert.vcxproj.filters
├── InitialNtTestAlertCreateProcessInjection
│   ├── InitialNtTestAlertCreateProcessInjection.c
│   ├── InitialNtTestAlertCreateProcessInjection.filters
│   └── InitialNtTestAlertCreateProcessInjection.vcxproj
├── MemoryReserveApc
│   ├── MemoryReserveApc.c
│   ├── MemoryReserveApc.vcxproj
│   └── MemoryReserveApc.vcxproj.filters
├── NtWaitForSingleObjectUserApc
│   ├── NtWaitForSingleObjectUserApc.c
│   ├── NtWaitForSingleObjectUserApc.vcxproj
│   └── NtWaitForSingleObjectUserApc.vcxproj.filters
├── NullApcRoutine
│   ├── NullApcRoutine.c
│   ├── NullApcRoutine.vcxproj
│   └── NullApcRoutine.vcxproj.filters
├── QueueApcAndNtTestAlert
│   ├── QueueApcAndNtTestAlert.c
│   ├── QueueApcAndNtTestAlert.vcxproj
│   └── QueueApcAndNtTestAlert.vcxproj.filters
├── QueueMultipleUserAPCs
│   ├── QueueMultipleUserAPCs.c
│   ├── QueueMultipleUserAPCs.vcxproj
│   └── QueueMultipleUserAPCs.vcxproj.filters
├── README.md
├── SimpleUserApcDriver
│   ├── KeApc.h
│   ├── SimpleUserApc.c
│   ├── SimpleUserApc.h
│   ├── SimpleUserApcControl.h
│   ├── SimpleUserApcDevice.c
│   ├── SimpleUserApcDevice.h
│   ├── SimpleUserApcDriver.inf
│   ├── SimpleUserApcDriver.vcxproj
│   ├── SimpleUserApcDriver.vcxproj.filters
│   └── SimpleUserApcDrv.c
├── SimpleUserApcDriverTester
│   ├── SimpleUserApcDriverTester.c
│   ├── SimpleUserApcDriverTester.cpp
│   ├── SimpleUserApcDriverTester.vcxproj
│   └── SimpleUserApcDriverTester.vcxproj.filters
├── SimpleUserApcWaitTester
│   ├── SimpleUserApcWait.c
│   ├── SimpleUserApcWaitTester.c
│   ├── SimpleUserApcWaitTester.h
│   ├── SimpleUserApcWaitTester.vcxproj
│   ├── SimpleUserApcWaitTester.vcxproj.filters
│   ├── UserApcToAlertableWaitingThread.c
│   ├── UserApcToNonAlertableThread.c
│   └── UserApcToRunningThread.c
├── SpecialUserApcExample
│   ├── SpecialUserApcExample.c
│   ├── SpecialUserApcExample.vcxproj
│   └── SpecialUserApcExample.vcxproj.filters
├── Wow64To64bitInjector
│   ├── Wow64To64bitInjector.c
│   ├── Wow64To64bitInjector.vcxproj
│   ├── Wow64To64bitInjector.vcxproj.filters
│   ├── x64Call.c
│   └── x64Call.h
└── x64ToWow64ApcInjector
    ├── x64ToWow64ApcInjector.c
    ├── x64ToWow64ApcInjector.vcxproj
    └── x64ToWow64ApcInjector.vcxproj.filters

```

`32bitApc/32BitApc.c`:

```c
#include <windows.h>
#include <stdio.h>

VOID 
WINAPI
ApcCode(
	ULONG_PTR dwData
	)
{
	printf("32 bit code!\n");
}

int main()
{
	QueueUserAPC(ApcCode, GetCurrentThread(), 0);

	SleepEx(INFINITE, TRUE);
}
```

`32bitApc/32bitApc.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <ProjectGuid>{3AEF9A17-BA05-48F2-A50A-78D67C8897F3}</ProjectGuid>
    <RootNamespace>My32bitApc</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="32BitApc.c" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`32bitApc/32bitApc.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="32BitApc.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`AlertableStateApcPending/AlertableStateApcPending.c`:

```c
#include <Windows.h>
#include <winternl.h>
#include <stdio.h>

VOID
ApcCode(
	ULONG_PTR dwData
	)
{
	UNREFERENCED_PARAMETER(dwData);

	printf("Hello from APC!\n");
}	

int main(
	int argc, 
	const char** argv
	)
{
	UNREFERENCED_PARAMETER(argc);
	UNREFERENCED_PARAMETER(argv);

	HANDLE EventHandle;
	NTSTATUS Status;

	printf("Queueing APC..\n");

	QueueUserAPC(ApcCode, GetCurrentThread(), 0);

	EventHandle = CreateEvent(NULL, FALSE, FALSE, NULL);
	
	printf("Sleeping forever...\n");

	Status = NtWaitForSingleObject(EventHandle, TRUE, NULL);
	
	printf("Status = 0x%08X\n", Status);

	return 0;
}
```

`AlertableStateApcPending/AlertableStateApcPending.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <ProjectGuid>{3BD37804-D9E8-4DB8-8571-C34316C06B0A}</ProjectGuid>
    <RootNamespace>AlertableStateApcPending</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <AdditionalDependencies>ntdll.lib;kernel32.lib;user32.lib;gdi32.lib;winspool.lib;comdlg32.lib;advapi32.lib;shell32.lib;ole32.lib;oleaut32.lib;uuid.lib;odbc32.lib;odbccp32.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <AdditionalDependencies>ntdll.lib;kernel32.lib;user32.lib;gdi32.lib;winspool.lib;comdlg32.lib;advapi32.lib;shell32.lib;ole32.lib;oleaut32.lib;uuid.lib;odbc32.lib;odbccp32.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="AlertableStateApcPending.c" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`AlertableStateApcPending/AlertableStateApcPending.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="AlertableStateApcPending.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`ApcDllInjector/ApcDllInjector.c`:

```c
#include <Windows.h>
#include <stdio.h>
#include <winternl.h>
#include <ApcLib/ApcLib.h>


typedef enum _APC_TYPE {
	ApcTypeWin32,
	ApcTypeNative,
	ApcTypeSpecial
} APC_TYPE;

typedef struct _APC_INJECTOR_ARGS {
	APC_TYPE ApcType;
	PCSTR DllPath;
	ULONG ProcessId;
	ULONG ThreadId;
} APC_INJECTOR_ARGS, * PAPC_INJECTOR_ARGS;

VOID
ParseArguments(
	__in int ArgumentCount,
	__in const char** Arguments,
	__out PAPC_INJECTOR_ARGS Args)
{
	if (ArgumentCount < 4) {
		printf("Missing arguments!\n");
		printf("ApcDllInjector.exe <native/win32/special> <process_id> <dll_path> [thread_id]\n");
		exit(-1);
	}

	Args->ProcessId = atoi(Arguments[2]);
	Args->DllPath = Arguments[3];
	Args->ThreadId = 0;
	Args->ApcType = ApcTypeWin32;

	if (ArgumentCount > 4) {
		Args->ThreadId = atoi(Arguments[4]);
	}

	if (strcmp(Arguments[1], "native") == 0) {
		Args->ApcType = ApcTypeNative;
	}
	else if (strcmp(Arguments[1], "win32") == 0) {
		Args->ApcType = ApcTypeWin32;
	}
	else if (strcmp(Arguments[1], "special") == 0) {
		Args->ApcType = ApcTypeSpecial;
	}
	else {
		printf("Invalid injection mode '%s'\n", Arguments[1]);
		exit(-1);
	}
}

int main(int argc, const char** argv) {

	APC_INJECTOR_ARGS Args;
	NTSTATUS Status;
	HANDLE ThreadHandle;
	HANDLE ProcessHandle;
	PVOID RemoteLibraryAddress;

	InitializeApcLib();

	ParseArguments(argc, argv, &Args);

	OpenTargetHandles(
			Args.ProcessId,
			Args.ThreadId,
			&ProcessHandle,
			&ThreadHandle
		);

	RemoteLibraryAddress = WriteLibraryNameToRemote(ProcessHandle, Args.DllPath);


	switch (Args.ApcType) {
	case ApcTypeWin32: {
		if (!QueueUserAPC((PAPCFUNC)LoadLibraryAPtr, ThreadHandle, (ULONG_PTR)RemoteLibraryAddress)) {
			printf("QueueUserAPC Error! 0x%08X\n", GetLastError());
			exit(-1);
		}
	}
					   break;
	case ApcTypeNative: {
		Status = NtQueueApcThread(
			ThreadHandle,
			(PPS_APC_ROUTINE)LoadLibraryAPtr,
			RemoteLibraryAddress,
			NULL,
			NULL
		);

		if (!NT_SUCCESS(Status)) {
			printf("NtQueueApcThread Failed: 0x%08X\n", Status);
			exit(-1);
		}
	}
						break;
	case ApcTypeSpecial: {
		USER_APC_OPTION UserApcOption;
		UserApcOption.UserApcFlags = QueueUserApcFlagsSpecialUserApc;

		Status = NtQueueApcThreadEx(
			ThreadHandle,
			UserApcOption,
			(PPS_APC_ROUTINE)LoadLibraryAPtr,
			RemoteLibraryAddress,
			NULL,
			NULL
		);

		if (!NT_SUCCESS(Status)) {
			printf("NtQueueApcThreadEx Failed: 0x%08X\n", Status);
			exit(-1);
		}
	}
						 break;
	default:
		break;
	}

	return 0;
}
```

`ApcDllInjector/ApcDllInjector.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <ProjectGuid>{E3D4D731-EE94-420D-83E6-09774A1E1607}</ProjectGuid>
    <RootNamespace>ApcDllInjector</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
      <AdditionalIncludeDirectories>$(SolutionDir)</AdditionalIncludeDirectories>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
      <AdditionalIncludeDirectories>$(SolutionDir)</AdditionalIncludeDirectories>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <AdditionalIncludeDirectories>$(SolutionDir)</AdditionalIncludeDirectories>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <AdditionalIncludeDirectories>$(SolutionDir)</AdditionalIncludeDirectories>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="ApcDllInjector.c" />
  </ItemGroup>
  <ItemGroup>
    <ProjectReference Include="..\ApcLib\ApcLib.vcxproj">
      <Project>{a2e5d416-54aa-47a7-afbd-247a56e28679}</Project>
    </ProjectReference>
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`ApcDllInjector/ApcDllInjector.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="ApcDllInjector.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`ApcLib/ApcLib.c`:

```c
#include "ApcLib.h"
#include "PeParser.h"
#include <stdio.h>
#include <winternl.h>
#include <psapi.h>

PNT_GET_NEXT_THREAD NtGetNextThread;
PNT_QUEUE_APC_THREAD NtQueueApcThread;
PNT_QUEUE_APC_THREAD RtlQueueApcWow64Thread;
PNT_QUEUE_APC_THREAD_EX NtQueueApcThreadEx;
PLOAD_LIBRARY_A LoadLibraryAPtr;
PLDR_LOAD_DLL LdrLoadDllPtr;

VOID
InitializeApcLib(
	VOID
)
{
	HMODULE NtdllHandle = GetModuleHandleA("ntdll.dll");
	HMODULE Kernel32Handle = GetModuleHandleA("kernel32.dll");

	NtGetNextThread = (PNT_GET_NEXT_THREAD)GetProcAddress(NtdllHandle, "NtGetNextThread");
	NtQueueApcThread = (PNT_QUEUE_APC_THREAD)GetProcAddress(NtdllHandle, "NtQueueApcThread");
	RtlQueueApcWow64Thread = (PNT_QUEUE_APC_THREAD)GetProcAddress(NtdllHandle, "RtlQueueApcWow64Thread");
	NtQueueApcThreadEx = (PNT_QUEUE_APC_THREAD_EX)GetProcAddress(NtdllHandle, "NtQueueApcThreadEx");
	LdrLoadDllPtr = (PLDR_LOAD_DLL)GetProcAddress(NtdllHandle, "LdrLoadDll");
	LoadLibraryAPtr = (PLOAD_LIBRARY_A)GetProcAddress(Kernel32Handle, "LoadLibraryA");
}

PVOID 
WriteLibraryNameToRemote(
	HANDLE ProcessHandle,
	PCSTR Library
	)
{
	SIZE_T LibraryLength = strlen(Library);

	PVOID LibraryRemoteAddress = VirtualAllocEx(
		ProcessHandle,
		NULL,
		LibraryLength + 1,
		MEM_RESERVE | MEM_COMMIT,
		PAGE_READWRITE
	);

	if (!LibraryRemoteAddress) {
		printf("Cannot allocate memory for library path. Error: 0x%08X\n", GetLastError());
		exit(-1);
	}

	if (!WriteProcessMemory(
		ProcessHandle,
		LibraryRemoteAddress,
		Library,
		LibraryLength + 1,
		NULL
	)) {
		printf("Cannot write library path to remote process. Error: 0x%08X\n", GetLastError());
		exit(-1);
	}

	return LibraryRemoteAddress;
}


VOID
OpenTargetHandles(
	__in ULONG ProcessId,
	__in_opt ULONG ThreadId,
	__out PHANDLE ProcessHandle,
	__out PHANDLE ThreadHandle
	)
{
	NTSTATUS Status;

	*ProcessHandle = OpenProcess(
		PROCESS_QUERY_INFORMATION |
		PROCESS_VM_OPERATION |
		PROCESS_VM_READ |
		PROCESS_VM_WRITE,
		FALSE,
		ProcessId
	);

	if (!*ProcessHandle) {
		printf("Cannot open process handle: 0x%08X\n", GetLastError());
		exit(-1);
	}

	if (ThreadId) {
		*ThreadHandle = OpenThread(THREAD_SET_CONTEXT, FALSE, ThreadId);

		if (!*ThreadHandle) {
			printf("Cannt open thread handle 0x%08X\n", GetLastError());
			exit(-1);
		}
	}
	else {
		Status = NtGetNextThread(
			*ProcessHandle,
			NULL,
			THREAD_SET_CONTEXT,
			0,
			0,
			ThreadHandle
		);

		if (!NT_SUCCESS(Status)) {
			printf("Cannot open thread handle 0x%08X\n", Status);
			exit(-1);
		}
	}
}


BOOLEAN
Is32BitProcess(
	HANDLE ProcessHandle
	)
{
	USHORT ProcessMachine;
	USHORT NativeMachine;

	if (!IsWow64Process2(ProcessHandle, &ProcessMachine, &NativeMachine)) {
		printf("IsWow64Process2 Failed: 0x%08X\n", GetLastError());
		exit(-1);
	}

	return ProcessMachine == IMAGE_FILE_MACHINE_I386;
}


ULONG64
DecodeWow64ApcRoutine(
	ULONG64 ApcRoutine
)
{
	return (ULONG64)(-((INT64)ApcRoutine >> 2));
}

ULONG64
EncodeWow64ApcRoutine(
	ULONG64 ApcRoutine
)
{
	return (ULONG64)((-(INT64)ApcRoutine) << 2);
}


PVOID 
GetRemoteModuleAddress(
	HANDLE ProcessHandle,
	PCSTR ModuleName
	)
{
	HMODULE ProcessModules[50];
	DWORD ProcessModulesByteCount;
	DWORD ProcessModulesCount;
	DWORD ModuleBaseNameLength;
	CHAR ModuleFileName[MAX_PATH];
	RtlZeroMemory(ProcessModules, sizeof(ProcessModules));

	if (!EnumProcessModulesEx(ProcessHandle, ProcessModules, sizeof(ProcessModules), &ProcessModulesByteCount, LIST_MODULES_32BIT)) {
		printf("EnumProcessModules Failed. 0x%08X\n", GetLastError());
		exit(-1);
	}

	ProcessModulesCount = ProcessModulesByteCount / sizeof(HMODULE);

	for (DWORD i = 0; i < ProcessModulesCount; i++) {

		ModuleBaseNameLength = GetModuleBaseNameA(ProcessHandle, ProcessModules[i], &ModuleFileName[0], sizeof(ModuleFileName) - 1);

		if (ModuleBaseNameLength == 0) {
			continue;
		}

		if (!_stricmp(ModuleFileName, ModuleName)) {
			return (PVOID)ProcessModules[i];
		}
	}

	return NULL;
}

PVOID
QueryWow64LoadLibraryAddress(
	HANDLE ProcessHandle
	)
{

	PVOID Kernel32Address = NULL;
	ULONG LoadLibraryAOffset;

	Kernel32Address = GetRemoteModuleAddress(ProcessHandle, "kernel32.dll");

	LoadLibraryAOffset = GetExportOffset("c:\\windows\\syswow64\\kernel32.dll", "LoadLibraryA");

	return OffsetPtr(Kernel32Address, LoadLibraryAOffset);
}

PVOID 
WriteUnicodeLibraryNameToRemote(
	HANDLE ProcessHandle,
	PCSTR LibraryPath
	)
{
	PWSTR UnicodeLibraryPath = AsciiStringToUnicodeString(LibraryPath);
	USHORT LibraryBytesCount = (USHORT)(wcslen(UnicodeLibraryPath) * sizeof(WCHAR));
	USHORT AllocationBytesCount = LibraryBytesCount + 1 + sizeof(UNICODE_STRING);

	PVOID LibraryRemoteAddress = VirtualAllocEx(
		ProcessHandle,
		NULL,
		AllocationBytesCount,
		MEM_RESERVE | MEM_COMMIT,
		PAGE_READWRITE
	);

	if (!LibraryRemoteAddress) {
		printf("Cannot allocate memory for library path. Error: 0x%08X\n", GetLastError());
		exit(-1);
	}


	PUNICODE_STRING LocalUnicodeString = (PUNICODE_STRING)HeapAlloc(GetProcessHeap(), 0, AllocationBytesCount);

	if (LocalUnicodeString == NULL) {
		exit(-1);
	}

	RtlZeroMemory(LocalUnicodeString, AllocationBytesCount);

	LocalUnicodeString->MaximumLength = LibraryBytesCount;
	LocalUnicodeString->Length = LibraryBytesCount;
	LocalUnicodeString->Buffer = (PWCHAR)(((PUCHAR)LibraryRemoteAddress) + sizeof(UNICODE_STRING));

	RtlCopyMemory((((PUCHAR)LocalUnicodeString) + sizeof(UNICODE_STRING)), UnicodeLibraryPath, LibraryBytesCount);

	if (!WriteProcessMemory(
		ProcessHandle,
		LibraryRemoteAddress,
		LocalUnicodeString,
		sizeof(UNICODE_STRING) + LibraryBytesCount + 1,
		NULL
	)) {
		printf("Cannot write library path to remote process. Error: 0x%08X\n", GetLastError());
		exit(-1);
	}

	return LibraryRemoteAddress;
}



PWSTR
AsciiStringToUnicodeString(
	PCSTR AsciiString
	)
{
	USHORT Length = (USHORT)strlen(AsciiString);
	PWSTR UnicodeString = (PWSTR)malloc(Length * 2);

	if (UnicodeString == NULL) {
		printf("Failed allocating unicode string.");
		exit(-1);
	}

	if (MultiByteToWideChar(CP_OEMCP, 0, AsciiString, Length + 1, UnicodeString, Length + 1) != (Length + 1)) {
		printf("Cannot convert command line to utf-16 0x%08X\n", GetLastError());
		exit(-1);
	}

	return UnicodeString;
}
```

`ApcLib/ApcLib.cpp`:

```cpp
#include "ApcLib.h"

VOID
InitializeApi(
	VOID
	)
{
	HMODULE NtdllHandle = GetModuleHandle("ntdll.dll");
	HMODULE Kernel32Handle = GetModuleHandle("kernel32.dll");

	NtGetNextThread = (PNT_GET_NEXT_THREAD)GetProcAddress(NtdllHandle, "NtGetNextThread");
	NtQueueApcThread = (PNT_QUEUE_APC_THREAD)GetProcAddress(NtdllHandle, "NtQueueApcThread");
	NtQueueApcThreadEx = (PNT_QUEUE_APC_THREAD_EX)GetProcAddress(NtdllHandle, "NtQueueApcThreadEx");
	LoadLibraryAPtr = GetProcAddress(Kernel32Handle, "LoadLibraryA");
}

```

`ApcLib/ApcLib.h`:

```h
#pragma once
#include <windows.h>

typedef
VOID
(NTAPI *PPS_APC_ROUTINE)(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	);

typedef
NTSTATUS
(NTAPI* PNT_QUEUE_APC_THREAD)(
	HANDLE ThreadHandle,
	PPS_APC_ROUTINE ApcRoutine,
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	);


typedef enum _QUEUE_USER_APC_FLAGS {
	QueueUserApcFlagsNone,
	QueueUserApcFlagsSpecialUserApc,
	QueueUserApcFlagsMaxValue
} QUEUE_USER_APC_FLAGS;


typedef union _USER_APC_OPTION {
	ULONG_PTR UserApcFlags;
	HANDLE MemoryReserveHandle;
} USER_APC_OPTION, * PUSER_APC_OPTION;


typedef 
NTSTATUS
(NTAPI* PNT_QUEUE_APC_THREAD_EX)(
	IN HANDLE ThreadHandle,
	IN USER_APC_OPTION UserApcOption,
	IN PPS_APC_ROUTINE ApcRoutine,
	IN PVOID SystemArgument1 OPTIONAL,
	IN PVOID SystemArgument2 OPTIONAL,
	IN PVOID SystemArgument3 OPTIONAL
	);


typedef
NTSTATUS
(NTAPI* PNT_GET_NEXT_THREAD)(
	_In_ HANDLE ProcessHandle,
	_In_ HANDLE ThreadHandle,
	_In_ ACCESS_MASK DesiredAccess,
	_In_ ULONG HandleAttributes,
	_In_ ULONG Flags,
	_Out_ PHANDLE NewThreadHandle
	);


typedef 
HMODULE
(NTAPI* PLOAD_LIBRARY_A)(
	PCSTR LibraryName
	);


typedef struct _UNICODE_STRING *PUNICODE_STRING;

typedef
HMODULE
(NTAPI* PLDR_LOAD_DLL)(
	PWCHAR PathToFile,
	ULONG Flags,
	PUNICODE_STRING ModuleFileName,
	PHANDLE ModuleHandle
	);


extern PNT_GET_NEXT_THREAD NtGetNextThread;
extern PNT_QUEUE_APC_THREAD NtQueueApcThread;
extern PNT_QUEUE_APC_THREAD_EX NtQueueApcThreadEx;
extern PLOAD_LIBRARY_A LoadLibraryAPtr;
extern PLDR_LOAD_DLL LdrLoadDllPtr;
extern PNT_QUEUE_APC_THREAD RtlQueueApcWow64Thread;

VOID
InitializeApcLib(
	VOID
	);


PVOID
WriteLibraryNameToRemote(
	HANDLE ProcessHandle,
	PCSTR Library
	);


VOID
OpenTargetHandles(
	__in ULONG ProcessId,
	__in_opt ULONG ThreadId,
	__out PHANDLE ProcessHandle,
	__out PHANDLE ThreadHandle
	);

BOOLEAN
Is32bitDll(
	PCSTR DllFilePath
	);


BOOLEAN
Is32BitProcess(
	HANDLE ProcessHandle
	);

ULONG
GetExportOffset(
	PCSTR LibraryPath,
	PCSTR ExportName
	);

ULONG64
DecodeWow64ApcRoutine(
	ULONG64 ApcRoutine
	);

ULONG64
EncodeWow64ApcRoutine(
	ULONG64 ApcRoutine
	);

PVOID 
QueryWow64LoadLibraryAddress(
	HANDLE ProcessHandle
	);

PVOID
WriteUnicodeLibraryNameToRemote(
	HANDLE ProcessHandle,
	PCSTR Library
	);



PWSTR
AsciiStringToUnicodeString(
	PCSTR AsciiString
	);


```

`ApcLib/ApcLib.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <ProjectGuid>{A2E5D416-54AA-47A7-AFBD-247A56E28679}</ProjectGuid>
    <Keyword>Win32Proj</Keyword>
    <RootNamespace>ApcLib</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>StaticLibrary</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>StaticLibrary</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>StaticLibrary</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>StaticLibrary</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <LinkIncremental>true</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <LinkIncremental>true</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <LinkIncremental>false</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <LinkIncremental>false</LinkIncremental>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <PrecompiledHeader>NotUsing</PrecompiledHeader>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;_DEBUG;_LIB;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
      <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Windows</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <PrecompiledHeader>NotUsing</PrecompiledHeader>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>_DEBUG;_LIB;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
      <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Windows</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <PrecompiledHeader>NotUsing</PrecompiledHeader>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;NDEBUG;_LIB;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
      <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>
      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Windows</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <PrecompiledHeader>NotUsing</PrecompiledHeader>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>NDEBUG;_LIB;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
      <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>
      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Windows</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="ApcLib.c" />
    <ClCompile Include="PeParser.c" />
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="ApcLib.h" />
    <ClInclude Include="PeParser.h" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`ApcLib/ApcLib.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="ApcLib.c">
      <Filter>Source Files</Filter>
    </ClCompile>
    <ClCompile Include="PeParser.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="ApcLib.h">
      <Filter>Header Files</Filter>
    </ClInclude>
    <ClInclude Include="PeParser.h">
      <Filter>Header Files</Filter>
    </ClInclude>
  </ItemGroup>
</Project>
```

`ApcLib/PEParser.h`:

```h
#pragma once
#include <Windows.h>
#include <winternl.h>


FORCEINLINE
PVOID
OffsetPtr(
	PVOID BaseAddress,
	ULONG Offset
)
{
	ULONG_PTR BaseAddressUlong = (ULONG_PTR)BaseAddress;

	return (PVOID)(BaseAddressUlong + Offset);
}

FORCEINLINE
ULONG
OffsetFromBase(
	PVOID BaseAddress,
	PVOID Address
)
{
	ULONG_PTR BaseAddressUlong = (ULONG_PTR)BaseAddress;
	ULONG_PTR AddressUlong = (ULONG_PTR)Address;

	return (ULONG)(AddressUlong - BaseAddressUlong);
}


BOOLEAN
Is32bitDll(
	PCSTR DllFilePath
	);

ULONG
GetExportOffset(
	PCSTR LibraryPath,
	PCSTR ExportName
	);
```

`ApcLib/PeParser.c`:

```c
#include "PeParser.h"
#include <stdio.h>

PBYTE
ReadAllFileBytes(
	PCSTR FilePath,
	PDWORD FileSize
)
{
	HANDLE FileHandle;
	PBYTE FileAllocation;
	DWORD NumberOfBytesRead;

	FileHandle = CreateFileA(
		FilePath,
		GENERIC_READ,
		FILE_SHARE_READ,
		NULL,
		OPEN_ALWAYS,
		FILE_ATTRIBUTE_NORMAL,
		NULL
	);

	if (FileHandle == INVALID_HANDLE_VALUE) {
		printf("Cannot find wow64 kernel32 DLL 0x%08X\n", GetLastError());
		exit(-1);
	}

	*FileSize = GetFileSize(FileHandle, NULL);

	if (*FileSize == INVALID_FILE_SIZE) {
		printf("Cannot find wow64 kernel32 DLL size 0x%08X\n", GetLastError());
		exit(-1);
	}

	FileAllocation = malloc(*FileSize);

	if (!ReadFile(
		FileHandle,
		FileAllocation,
		*FileSize,
		&NumberOfBytesRead,
		NULL
	)) {
		printf("Cannot read wow64 kernel32 0x%08X\n", GetLastError());
		exit(-1);
	}

	CloseHandle(FileHandle);

	return (PBYTE)FileAllocation;
}

PIMAGE_SECTION_HEADER
GetContainingSection(
	PIMAGE_NT_HEADERS32 ImageNtHeaders,
	ULONG_PTR RelativeVirtualAddress
)
{
	PIMAGE_SECTION_HEADER ImageSectionHeaders = OffsetPtr(ImageNtHeaders, sizeof(IMAGE_NT_HEADERS32));

	for (ULONG i = 0; i < ImageNtHeaders->FileHeader.NumberOfSections; i++) {
		if (RelativeVirtualAddress >= ImageSectionHeaders[i].VirtualAddress &&
			RelativeVirtualAddress < (ImageSectionHeaders[i].VirtualAddress + ImageSectionHeaders[i].SizeOfRawData)) {
			return &ImageSectionHeaders[i];
		}
	}

	return NULL;
}

ULONG
GetImageFileOffset(
	PIMAGE_DOS_HEADER ImageDosHeader,
	ULONG_PTR RelativeVirtualAddress
)
{
	PIMAGE_NT_HEADERS32 ImageNtHeaders = (PIMAGE_NT_HEADERS32)OffsetPtr(ImageDosHeader, ImageDosHeader->e_lfanew);

	if (ImageNtHeaders->Signature != IMAGE_NT_SIGNATURE) {
		exit(-1);
	}

	PIMAGE_SECTION_HEADER Section = GetContainingSection(ImageNtHeaders, RelativeVirtualAddress);
	
	ULONG SectionOffset = (ULONG)(RelativeVirtualAddress - Section->VirtualAddress);
	
	return Section->PointerToRawData + SectionOffset;
}

PVOID
GetImageFilePointer(
	PIMAGE_DOS_HEADER ImageDosHeader,
	ULONG_PTR RelativeVirtualAddress
	)
{
	ULONG FileOffset = GetImageFileOffset(ImageDosHeader, RelativeVirtualAddress);

	return OffsetPtr(ImageDosHeader, FileOffset);
}

ULONG
GetExportRva(
	PIMAGE_DOS_HEADER ImageDosHeader,
	PIMAGE_EXPORT_DIRECTORY ImageExportDirectory,
	PCSTR FunctionName
	)
{
	PDWORD AddressOfFunctions = GetImageFilePointer(ImageDosHeader, ImageExportDirectory->AddressOfFunctions);
	PDWORD AddressOfNames = GetImageFilePointer(ImageDosHeader, ImageExportDirectory->AddressOfNames);
	PUSHORT AddressOfNamesOrdinals = GetImageFilePointer(ImageDosHeader, ImageExportDirectory->AddressOfNameOrdinals);
	PCSTR CurrentName;

	for (ULONG i = 0; i < ImageExportDirectory->NumberOfNames; i++) {
		CurrentName = GetImageFilePointer(ImageDosHeader, AddressOfNames[i]);

		if (!strcmp(CurrentName, FunctionName)) {
			DWORD Ordinal;
			DWORD FunctionRva;

			Ordinal = AddressOfNamesOrdinals[i];
			FunctionRva = AddressOfFunctions[Ordinal];

			return FunctionRva;
		}
	}

	return 0;
}

ULONG
GetExportOffset(
	PCSTR LibraryPath,
	PCSTR ExportName
	)
{
	DWORD FileSize;
	ULONG FunctionRva;
	PIMAGE_DOS_HEADER ImageDosHeader;
	PIMAGE_NT_HEADERS32 ImageNtHeaders;
	PIMAGE_DATA_DIRECTORY ExportDataDirectory;
	PIMAGE_EXPORT_DIRECTORY ExportDirectory;

	ImageDosHeader = (PIMAGE_DOS_HEADER)ReadAllFileBytes(LibraryPath, &FileSize);

	if (FileSize <= 1000 ||
		ImageDosHeader->e_magic != IMAGE_DOS_SIGNATURE ||
		(ULONG)ImageDosHeader->e_lfanew >= (FileSize - sizeof(IMAGE_NT_HEADERS32))) {
		exit(-1);
	}

	ImageNtHeaders = (PIMAGE_NT_HEADERS32)OffsetPtr(ImageDosHeader, ImageDosHeader->e_lfanew);

	if (ImageNtHeaders->Signature != IMAGE_NT_SIGNATURE) {
		exit(-1);
	}

	ExportDataDirectory = (PIMAGE_DATA_DIRECTORY)(&ImageNtHeaders->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT]);
	
	ExportDirectory = (PIMAGE_EXPORT_DIRECTORY)GetImageFilePointer(ImageDosHeader, ExportDataDirectory->VirtualAddress);

	FunctionRva = GetExportRva(ImageDosHeader, ExportDirectory, ExportName);

	free(ImageDosHeader);

	return FunctionRva;
}



BOOLEAN
Is32bitDll(
	PCSTR DllFilePath
	)
{
	CHAR DllBuffer[512];
	DWORD NumberOfBytesRead;
	HANDLE DllFileHandle;

	DllFileHandle = CreateFileA(
		DllFilePath,
		GENERIC_READ,
		FILE_SHARE_READ,
		NULL,
		OPEN_ALWAYS,
		FILE_ATTRIBUTE_NORMAL,
		NULL
	);

	if (DllFileHandle == INVALID_HANDLE_VALUE) {
		printf("Cannot open file: 0x%08X\n", GetLastError());
		exit(-1);
	}

	if (!ReadFile(
		DllFileHandle,
		&DllBuffer[0],
		sizeof(DllBuffer),
		&NumberOfBytesRead,
		NULL
	)) {
		printf("Cannot read the DLL file. 0x%08X\n", GetLastError());
		exit(-1);
	}

	CloseHandle(DllFileHandle);
	DllFileHandle = NULL;

	PIMAGE_DOS_HEADER ImageDosHeader = (PIMAGE_DOS_HEADER)&DllBuffer[0];

	if (ImageDosHeader->e_magic != IMAGE_DOS_SIGNATURE || ImageDosHeader->e_lfanew >= 500) {
		printf("Invalid PE file\n");
		exit(-1);
	}

	PIMAGE_NT_HEADERS ImageNtHeaders = (PIMAGE_NT_HEADERS)OffsetPtr(ImageDosHeader, ImageDosHeader->e_lfanew);

	if (ImageNtHeaders->Signature != IMAGE_NT_SIGNATURE) {
		printf("Invalid PE file\n");
		exit(-1);
	}

	if (ImageNtHeaders->FileHeader.Machine == IMAGE_FILE_MACHINE_I386) {
		return TRUE;

	}
	else if (ImageNtHeaders->FileHeader.Machine == IMAGE_FILE_MACHINE_AMD64) {
		return FALSE;
	}
	else {
		printf("Invalid PE file.\n");
		exit(-1);
	}

}
```

`ApcRaceConditionExample/ApcRaceConditionExample.c`:

```c
#include <Windows.h>
#include <stdio.h>
#include <winternl.h>

typedef
VOID
(*PPS_APC_ROUTINE)(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	);

typedef enum _QUEUE_USER_APC_FLAGS {
	QueueUserApcFlagsNone,
	QueueUserApcFlagsSpecialUserApc,
	QueueUserApcFlagsMaxValue
} QUEUE_USER_APC_FLAGS;

typedef union _USER_APC_OPTION {
	ULONG_PTR UserApcFlags;
	HANDLE MemoryReserveHandle;
} USER_APC_OPTION, * PUSER_APC_OPTION;


typedef NTSTATUS
(NTAPI* PNT_QUEUE_APC_THREAD_EX)(
	IN HANDLE ThreadHandle,
	IN USER_APC_OPTION UserApcOption,
	IN PPS_APC_ROUTINE ApcRoutine,
	IN PVOID SystemArgument1 OPTIONAL,
	IN PVOID SystemArgument2 OPTIONAL,
	IN PVOID SystemArgument3 OPTIONAL
	);

VOID
ApcRoutine(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
);


PNT_QUEUE_APC_THREAD_EX NtQueueApcThreadEx;
RTL_CRITICAL_SECTION gItemsListLock;
DWORD ItemList[1000];
DWORD CurrentItemIndex;

DWORD
WINAPI
UseListWorker(
	PVOID Parameter
	);

VOID
ChangeListApcRoutine(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
);

int 
main(
	VOID
	) 
{
	HANDLE ThreadHandle;
	USER_APC_OPTION UserApcOption;
	NTSTATUS Status;

	NtQueueApcThreadEx = (PNT_QUEUE_APC_THREAD_EX)GetProcAddress(GetModuleHandle("ntdll.dll"), "NtQueueApcThreadEx");
	
	if (!NtQueueApcThreadEx) {
		printf("wtf? before win7.\n");
		return -1;
	}

	RtlZeroMemory(&ItemList, sizeof(ItemList));
	CurrentItemIndex = 0;
	InitializeCriticalSection(&gItemsListLock);

	ThreadHandle = CreateThread(NULL, 0, UseListWorker, NULL, 0, NULL);

	while (TRUE) {
		UserApcOption.UserApcFlags = QueueUserApcFlagsSpecialUserApc;

		Status = NtQueueApcThreadEx(
					ThreadHandle,
					UserApcOption,
					ChangeListApcRoutine,
					NULL,
					NULL,
					NULL
				);

		if (!NT_SUCCESS(Status)) {
			printf("NtQueueApcThreadEx Failed! 0x%08X\n", Status);
			exit(-1);
		}

		Sleep(200);
	}

}

DWORD
WINAPI
UseListWorker(
	PVOID Parameter
	)
{

	while (TRUE) {
		EnterCriticalSection(&gItemsListLock);

		for (ULONG i = 0; i < 1000; i++) {
			ItemList[i] = 1;
		}

		Sleep(1000);

		for (ULONG i = 0; i < 1000; i++) {
			if (ItemList[i] != 1) {
				printf("What?? I acquired the lock, how come the array changed?\n");
				exit(-1);
			}
		}

		LeaveCriticalSection(&gItemsListLock);

		Sleep(500);
	}

}

VOID
ChangeListApcRoutine(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	)
{
	EnterCriticalSection(&gItemsListLock);

	for (ULONG i = 0; i < 1000; i++) {
		ItemList[i] = 2;
	}

	LeaveCriticalSection(&gItemsListLock);
}
```

`ApcRaceConditionExample/ApcRaceConditionExample.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <ProjectGuid>{32B9E40B-4226-4ADE-939A-536D83A93D17}</ProjectGuid>
    <RootNamespace>ApcRaceConditionExample</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="ApcRaceConditionExample.c" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`ApcRaceConditionExample/ApcRaceConditionExample.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="ApcRaceConditionExample.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`ApcResearch.sln`:

```sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 16
VisualStudioVersion = 16.0.29123.88
MinimumVisualStudioVersion = 10.0.40219.1
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "MemoryReserveApc", "MemoryReserveApc\MemoryReserveApc.vcxproj", "{D2B1205E-B346-4AF5-A7B6-31E0D98E318E}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "SpecialUserApcExample", "SpecialUserApcExample\SpecialUserApcExample.vcxproj", "{6B327562-86D7-4BB8-B798-D152CF955276}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "ApcDllInjector", "ApcDllInjector\ApcDllInjector.vcxproj", "{E3D4D731-EE94-420D-83E6-09774A1E1607}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "ApcRaceConditionExample", "ApcRaceConditionExample\ApcRaceConditionExample.vcxproj", "{32B9E40B-4226-4ADE-939A-536D83A93D17}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "ApcRoutineUseContextRecord", "ApcRoutineUseContextRecord\ApcRoutineUseContextRecord.vcxproj", "{7231B11E-60AF-44A5-89D1-703A16D91375}"
EndProject
Project("{2150E333-8FDC-42A3-9474-1A3956D46DE8}") = "Solution Items", "Solution Items", "{E22D9EB3-5C6B-4C9D-9060-6D626EAABD6C}"
	ProjectSection(SolutionItems) = preProject
		README.md = README.md
	EndProjectSection
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "InitialNtTestAlert", "InitialNtTestAlert\InitialNtTestAlert.vcxproj", "{AC5BE339-DBE9-4BDF-AFC3-56F2A983BCA7}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "NtWaitForSingleObjectUserApc", "NtWaitForSingleObjectUserApc\NtWaitForSingleObjectUserApc.vcxproj", "{B574E10D-C173-427A-A1E0-14C70060B5F1}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "InitialNtTestAlertCreateProcessInjection", "InitialNtTestAlertCreateProcessInjection\InitialNtTestAlertCreateProcessInjection.vcxproj", "{C7FE0E49-4619-4340-89C6-BA9CEDA2F250}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "SimpleUserApcDriver", "SimpleUserApcDriver\SimpleUserApcDriver.vcxproj", "{0931E78A-75A0-4F92-8F26-A5B54D918AA4}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "SimpleUserApcDriverTester", "SimpleUserApcDriverTester\SimpleUserApcDriverTester.vcxproj", "{43F0DFFF-A641-408C-8882-4B593A7AA373}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "SimpleUserApcWaitTester", "SimpleUserApcWaitTester\SimpleUserApcWaitTester.vcxproj", "{201BCC66-5D46-4554-B592-75FD70C41643}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "AlertableStateApcPending", "AlertableStateApcPending\AlertableStateApcPending.vcxproj", "{3BD37804-D9E8-4DB8-8571-C34316C06B0A}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "QueueApcAndNtTestAlert", "QueueApcAndNtTestAlert\QueueApcAndNtTestAlert.vcxproj", "{A0EBAC29-5E77-4962-B0D3-0E7B3680491B}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "QueueMultipleUserAPCs", "QueueMultipleUserAPCs\QueueMultipleUserAPCs.vcxproj", "{A1F1C700-3B2A-496C-9F9B-6FCB2BA57DD0}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "32bitApc", "32bitApc\32bitApc.vcxproj", "{3AEF9A17-BA05-48F2-A50A-78D67C8897F3}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "NullApcRoutine", "NullApcRoutine\NullApcRoutine.vcxproj", "{26AE58AB-A71A-4E71-A99A-D3770F06C20F}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "x64ToWow64ApcInjector", "x64ToWow64ApcInjector\x64ToWow64ApcInjector.vcxproj", "{01CBB56D-9103-48DD-A82A-7AB3F60A8D78}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "Wow64To64bitInjector", "Wow64To64bitInjector\Wow64To64bitInjector.vcxproj", "{256C1B91-FF94-48D6-8A32-23993151D840}"
EndProject
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "ApcLib", "ApcLib\ApcLib.vcxproj", "{A2E5D416-54AA-47A7-AFBD-247A56E28679}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|x64 = Debug|x64
		Debug|x86 = Debug|x86
		Release|x64 = Release|x64
		Release|x86 = Release|x86
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{D2B1205E-B346-4AF5-A7B6-31E0D98E318E}.Debug|x64.ActiveCfg = Debug|x64
		{D2B1205E-B346-4AF5-A7B6-31E0D98E318E}.Debug|x64.Build.0 = Debug|x64
		{D2B1205E-B346-4AF5-A7B6-31E0D98E318E}.Debug|x86.ActiveCfg = Debug|Win32
		{D2B1205E-B346-4AF5-A7B6-31E0D98E318E}.Release|x64.ActiveCfg = Release|x64
		{D2B1205E-B346-4AF5-A7B6-31E0D98E318E}.Release|x64.Build.0 = Release|x64
		{D2B1205E-B346-4AF5-A7B6-31E0D98E318E}.Release|x86.ActiveCfg = Release|Win32
		{D2B1205E-B346-4AF5-A7B6-31E0D98E318E}.Release|x86.Build.0 = Release|Win32
		{6B327562-86D7-4BB8-B798-D152CF955276}.Debug|x64.ActiveCfg = Debug|x64
		{6B327562-86D7-4BB8-B798-D152CF955276}.Debug|x64.Build.0 = Debug|x64
		{6B327562-86D7-4BB8-B798-D152CF955276}.Debug|x86.ActiveCfg = Debug|Win32
		{6B327562-86D7-4BB8-B798-D152CF955276}.Release|x64.ActiveCfg = Release|x64
		{6B327562-86D7-4BB8-B798-D152CF955276}.Release|x64.Build.0 = Release|x64
		{6B327562-86D7-4BB8-B798-D152CF955276}.Release|x86.ActiveCfg = Release|Win32
		{6B327562-86D7-4BB8-B798-D152CF955276}.Release|x86.Build.0 = Release|Win32
		{E3D4D731-EE94-420D-83E6-09774A1E1607}.Debug|x64.ActiveCfg = Debug|x64
		{E3D4D731-EE94-420D-83E6-09774A1E1607}.Debug|x64.Build.0 = Debug|x64
		{E3D4D731-EE94-420D-83E6-09774A1E1607}.Debug|x86.ActiveCfg = Debug|Win32
		{E3D4D731-EE94-420D-83E6-09774A1E1607}.Release|x64.ActiveCfg = Release|x64
		{E3D4D731-EE94-420D-83E6-09774A1E1607}.Release|x64.Build.0 = Release|x64
		{E3D4D731-EE94-420D-83E6-09774A1E1607}.Release|x86.ActiveCfg = Release|Win32
		{E3D4D731-EE94-420D-83E6-09774A1E1607}.Release|x86.Build.0 = Release|Win32
		{32B9E40B-4226-4ADE-939A-536D83A93D17}.Debug|x64.ActiveCfg = Debug|x64
		{32B9E40B-4226-4ADE-939A-536D83A93D17}.Debug|x64.Build.0 = Debug|x64
		{32B9E40B-4226-4ADE-939A-536D83A93D17}.Debug|x86.ActiveCfg = Debug|Win32
		{32B9E40B-4226-4ADE-939A-536D83A93D17}.Release|x64.ActiveCfg = Release|x64
		{32B9E40B-4226-4ADE-939A-536D83A93D17}.Release|x64.Build.0 = Release|x64
		{32B9E40B-4226-4ADE-939A-536D83A93D17}.Release|x86.ActiveCfg = Release|Win32
		{32B9E40B-4226-4ADE-939A-536D83A93D17}.Release|x86.Build.0 = Release|Win32
		{7231B11E-60AF-44A5-89D1-703A16D91375}.Debug|x64.ActiveCfg = Debug|x64
		{7231B11E-60AF-44A5-89D1-703A16D91375}.Debug|x64.Build.0 = Debug|x64
		{7231B11E-60AF-44A5-89D1-703A16D91375}.Debug|x86.ActiveCfg = Debug|Win32
		{7231B11E-60AF-44A5-89D1-703A16D91375}.Release|x64.ActiveCfg = Release|x64
		{7231B11E-60AF-44A5-89D1-703A16D91375}.Release|x64.Build.0 = Release|x64
		{7231B11E-60AF-44A5-89D1-703A16D91375}.Release|x86.ActiveCfg = Release|Win32
		{7231B11E-60AF-44A5-89D1-703A16D91375}.Release|x86.Build.0 = Release|Win32
		{AC5BE339-DBE9-4BDF-AFC3-56F2A983BCA7}.Debug|x64.ActiveCfg = Debug|x64
		{AC5BE339-DBE9-4BDF-AFC3-56F2A983BCA7}.Debug|x64.Build.0 = Debug|x64
		{AC5BE339-DBE9-4BDF-AFC3-56F2A983BCA7}.Debug|x86.ActiveCfg = Debug|Win32
		{AC5BE339-DBE9-4BDF-AFC3-56F2A983BCA7}.Release|x64.ActiveCfg = Release|x64
		{AC5BE339-DBE9-4BDF-AFC3-56F2A983BCA7}.Release|x64.Build.0 = Release|x64
		{AC5BE339-DBE9-4BDF-AFC3-56F2A983BCA7}.Release|x86.ActiveCfg = Release|Win32
		{AC5BE339-DBE9-4BDF-AFC3-56F2A983BCA7}.Release|x86.Build.0 = Release|Win32
		{B574E10D-C173-427A-A1E0-14C70060B5F1}.Debug|x64.ActiveCfg = Debug|x64
		{B574E10D-C173-427A-A1E0-14C70060B5F1}.Debug|x64.Build.0 = Debug|x64
		{B574E10D-C173-427A-A1E0-14C70060B5F1}.Debug|x86.ActiveCfg = Debug|Win32
		{B574E10D-C173-427A-A1E0-14C70060B5F1}.Release|x64.ActiveCfg = Release|x64
		{B574E10D-C173-427A-A1E0-14C70060B5F1}.Release|x64.Build.0 = Release|x64
		{B574E10D-C173-427A-A1E0-14C70060B5F1}.Release|x86.ActiveCfg = Release|Win32
		{B574E10D-C173-427A-A1E0-14C70060B5F1}.Release|x86.Build.0 = Release|Win32
		{C7FE0E49-4619-4340-89C6-BA9CEDA2F250}.Debug|x64.ActiveCfg = Debug|x64
		{C7FE0E49-4619-4340-89C6-BA9CEDA2F250}.Debug|x64.Build.0 = Debug|x64
		{C7FE0E49-4619-4340-89C6-BA9CEDA2F250}.Debug|x86.ActiveCfg = Debug|Win32
		{C7FE0E49-4619-4340-89C6-BA9CEDA2F250}.Release|x64.ActiveCfg = Release|x64
		{C7FE0E49-4619-4340-89C6-BA9CEDA2F250}.Release|x64.Build.0 = Release|x64
		{C7FE0E49-4619-4340-89C6-BA9CEDA2F250}.Release|x86.ActiveCfg = Release|Win32
		{C7FE0E49-4619-4340-89C6-BA9CEDA2F250}.Release|x86.Build.0 = Release|Win32
		{0931E78A-75A0-4F92-8F26-A5B54D918AA4}.Debug|x64.ActiveCfg = Debug|x64
		{0931E78A-75A0-4F92-8F26-A5B54D918AA4}.Debug|x64.Build.0 = Debug|x64
		{0931E78A-75A0-4F92-8F26-A5B54D918AA4}.Debug|x64.Deploy.0 = Debug|x64
		{0931E78A-75A0-4F92-8F26-A5B54D918AA4}.Debug|x86.ActiveCfg = Debug|Win32
		{0931E78A-75A0-4F92-8F26-A5B54D918AA4}.Release|x64.ActiveCfg = Release|x64
		{0931E78A-75A0-4F92-8F26-A5B54D918AA4}.Release|x64.Build.0 = Release|x64
		{0931E78A-75A0-4F92-8F26-A5B54D918AA4}.Release|x64.Deploy.0 = Release|x64
		{0931E78A-75A0-4F92-8F26-A5B54D918AA4}.Release|x86.ActiveCfg = Release|Win32
		{0931E78A-75A0-4F92-8F26-A5B54D918AA4}.Release|x86.Build.0 = Release|Win32
		{0931E78A-75A0-4F92-8F26-A5B54D918AA4}.Release|x86.Deploy.0 = Release|Win32
		{43F0DFFF-A641-408C-8882-4B593A7AA373}.Debug|x64.ActiveCfg = Debug|x64
		{43F0DFFF-A641-408C-8882-4B593A7AA373}.Debug|x64.Build.0 = Debug|x64
		{43F0DFFF-A641-408C-8882-4B593A7AA373}.Debug|x86.ActiveCfg = Debug|Win32
		{43F0DFFF-A641-408C-8882-4B593A7AA373}.Release|x64.ActiveCfg = Release|x64
		{43F0DFFF-A641-408C-8882-4B593A7AA373}.Release|x64.Build.0 = Release|x64
		{43F0DFFF-A641-408C-8882-4B593A7AA373}.Release|x86.ActiveCfg = Release|Win32
		{43F0DFFF-A641-408C-8882-4B593A7AA373}.Release|x86.Build.0 = Release|Win32
		{201BCC66-5D46-4554-B592-75FD70C41643}.Debug|x64.ActiveCfg = Debug|x64
		{201BCC66-5D46-4554-B592-75FD70C41643}.Debug|x64.Build.0 = Debug|x64
		{201BCC66-5D46-4554-B592-75FD70C41643}.Debug|x86.ActiveCfg = Debug|Win32
		{201BCC66-5D46-4554-B592-75FD70C41643}.Release|x64.ActiveCfg = Release|x64
		{201BCC66-5D46-4554-B592-75FD70C41643}.Release|x64.Build.0 = Release|x64
		{201BCC66-5D46-4554-B592-75FD70C41643}.Release|x86.ActiveCfg = Release|Win32
		{201BCC66-5D46-4554-B592-75FD70C41643}.Release|x86.Build.0 = Release|Win32
		{3BD37804-D9E8-4DB8-8571-C34316C06B0A}.Debug|x64.ActiveCfg = Debug|x64
		{3BD37804-D9E8-4DB8-8571-C34316C06B0A}.Debug|x64.Build.0 = Debug|x64
		{3BD37804-D9E8-4DB8-8571-C34316C06B0A}.Debug|x86.ActiveCfg = Debug|Win32
		{3BD37804-D9E8-4DB8-8571-C34316C06B0A}.Release|x64.ActiveCfg = Release|x64
		{3BD37804-D9E8-4DB8-8571-C34316C06B0A}.Release|x64.Build.0 = Release|x64
		{3BD37804-D9E8-4DB8-8571-C34316C06B0A}.Release|x86.ActiveCfg = Release|Win32
		{3BD37804-D9E8-4DB8-8571-C34316C06B0A}.Release|x86.Build.0 = Release|Win32
		{A0EBAC29-5E77-4962-B0D3-0E7B3680491B}.Debug|x64.ActiveCfg = Debug|x64
		{A0EBAC29-5E77-4962-B0D3-0E7B3680491B}.Debug|x64.Build.0 = Debug|x64
		{A0EBAC29-5E77-4962-B0D3-0E7B3680491B}.Debug|x86.ActiveCfg = Debug|Win32
		{A0EBAC29-5E77-4962-B0D3-0E7B3680491B}.Release|x64.ActiveCfg = Release|x64
		{A0EBAC29-5E77-4962-B0D3-0E7B3680491B}.Release|x64.Build.0 = Release|x64
		{A0EBAC29-5E77-4962-B0D3-0E7B3680491B}.Release|x86.ActiveCfg = Release|Win32
		{A0EBAC29-5E77-4962-B0D3-0E7B3680491B}.Release|x86.Build.0 = Release|Win32
		{A1F1C700-3B2A-496C-9F9B-6FCB2BA57DD0}.Debug|x64.ActiveCfg = Debug|x64
		{A1F1C700-3B2A-496C-9F9B-6FCB2BA57DD0}.Debug|x64.Build.0 = Debug|x64
		{A1F1C700-3B2A-496C-9F9B-6FCB2BA57DD0}.Debug|x86.ActiveCfg = Debug|Win32
		{A1F1C700-3B2A-496C-9F9B-6FCB2BA57DD0}.Release|x64.ActiveCfg = Release|x64
		{A1F1C700-3B2A-496C-9F9B-6FCB2BA57DD0}.Release|x64.Build.0 = Release|x64
		{A1F1C700-3B2A-496C-9F9B-6FCB2BA57DD0}.Release|x86.ActiveCfg = Release|Win32
		{A1F1C700-3B2A-496C-9F9B-6FCB2BA57DD0}.Release|x86.Build.0 = Release|Win32
		{3AEF9A17-BA05-48F2-A50A-78D67C8897F3}.Debug|x64.ActiveCfg = Debug|x64
		{3AEF9A17-BA05-48F2-A50A-78D67C8897F3}.Debug|x86.ActiveCfg = Debug|Win32
		{3AEF9A17-BA05-48F2-A50A-78D67C8897F3}.Debug|x86.Build.0 = Debug|Win32
		{3AEF9A17-BA05-48F2-A50A-78D67C8897F3}.Release|x64.ActiveCfg = Release|x64
		{3AEF9A17-BA05-48F2-A50A-78D67C8897F3}.Release|x64.Build.0 = Release|x64
		{3AEF9A17-BA05-48F2-A50A-78D67C8897F3}.Release|x86.ActiveCfg = Release|Win32
		{3AEF9A17-BA05-48F2-A50A-78D67C8897F3}.Release|x86.Build.0 = Release|Win32
		{26AE58AB-A71A-4E71-A99A-D3770F06C20F}.Debug|x64.ActiveCfg = Debug|x64
		{26AE58AB-A71A-4E71-A99A-D3770F06C20F}.Debug|x64.Build.0 = Debug|x64
		{26AE58AB-A71A-4E71-A99A-D3770F06C20F}.Debug|x86.ActiveCfg = Debug|Win32
		{26AE58AB-A71A-4E71-A99A-D3770F06C20F}.Release|x64.ActiveCfg = Release|x64
		{26AE58AB-A71A-4E71-A99A-D3770F06C20F}.Release|x64.Build.0 = Release|x64
		{26AE58AB-A71A-4E71-A99A-D3770F06C20F}.Release|x86.ActiveCfg = Release|Win32
		{26AE58AB-A71A-4E71-A99A-D3770F06C20F}.Release|x86.Build.0 = Release|Win32
		{01CBB56D-9103-48DD-A82A-7AB3F60A8D78}.Debug|x64.ActiveCfg = Debug|x64
		{01CBB56D-9103-48DD-A82A-7AB3F60A8D78}.Debug|x64.Build.0 = Debug|x64
		{01CBB56D-9103-48DD-A82A-7AB3F60A8D78}.Debug|x86.ActiveCfg = Debug|Win32
		{01CBB56D-9103-48DD-A82A-7AB3F60A8D78}.Release|x64.ActiveCfg = Release|x64
		{01CBB56D-9103-48DD-A82A-7AB3F60A8D78}.Release|x64.Build.0 = Release|x64
		{01CBB56D-9103-48DD-A82A-7AB3F60A8D78}.Release|x86.ActiveCfg = Release|Win32
		{01CBB56D-9103-48DD-A82A-7AB3F60A8D78}.Release|x86.Build.0 = Release|Win32
		{256C1B91-FF94-48D6-8A32-23993151D840}.Debug|x64.ActiveCfg = Debug|x64
		{256C1B91-FF94-48D6-8A32-23993151D840}.Debug|x86.ActiveCfg = Debug|Win32
		{256C1B91-FF94-48D6-8A32-23993151D840}.Debug|x86.Build.0 = Debug|Win32
		{256C1B91-FF94-48D6-8A32-23993151D840}.Release|x64.ActiveCfg = Release|x64
		{256C1B91-FF94-48D6-8A32-23993151D840}.Release|x64.Build.0 = Release|x64
		{256C1B91-FF94-48D6-8A32-23993151D840}.Release|x86.ActiveCfg = Release|Win32
		{256C1B91-FF94-48D6-8A32-23993151D840}.Release|x86.Build.0 = Release|Win32
		{A2E5D416-54AA-47A7-AFBD-247A56E28679}.Debug|x64.ActiveCfg = Debug|x64
		{A2E5D416-54AA-47A7-AFBD-247A56E28679}.Debug|x64.Build.0 = Debug|x64
		{A2E5D416-54AA-47A7-AFBD-247A56E28679}.Debug|x86.ActiveCfg = Debug|Win32
		{A2E5D416-54AA-47A7-AFBD-247A56E28679}.Debug|x86.Build.0 = Debug|Win32
		{A2E5D416-54AA-47A7-AFBD-247A56E28679}.Release|x64.ActiveCfg = Release|x64
		{A2E5D416-54AA-47A7-AFBD-247A56E28679}.Release|x64.Build.0 = Release|x64
		{A2E5D416-54AA-47A7-AFBD-247A56E28679}.Release|x86.ActiveCfg = Release|Win32
		{A2E5D416-54AA-47A7-AFBD-247A56E28679}.Release|x86.Build.0 = Release|Win32
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {35CB6C3A-0F43-4453-B9A0-A58A51F7702F}
	EndGlobalSection
EndGlobal

```

`ApcRoutineUseContextRecord/ApcRoutineUseContextRecord.c`:

```c
#include <Windows.h>
#include <stdio.h>
#include <winternl.h>

typedef
VOID
(*PPS_APC_ROUTINE)(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3,
	PVOID ContextRecord
	);

typedef NTSTATUS
(NTAPI* PNT_QUEUE_APC_THREAD)(
	IN HANDLE ThreadHandle,
	IN PPS_APC_ROUTINE ApcRoutine,
	IN PVOID SystemArgument1 OPTIONAL,
	IN PVOID SystemArgument2 OPTIONAL,
	IN PVOID SystemArgument3 OPTIONAL
	);

VOID
PrintApcPreviousRIP(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3,
	PCONTEXT ContextRecord
);

PNT_QUEUE_APC_THREAD NtQueueApcThread;

int 
main(
	int argc,
	const char** argv
	)
{
	NtQueueApcThread = (PNT_QUEUE_APC_THREAD)(GetProcAddress(GetModuleHandle("ntdll.dll"), "NtQueueApcThread"));
	
	NtQueueApcThread(
		GetCurrentThread(),
		PrintApcPreviousRIP,
		NULL,
		NULL,
		NULL
	);

	SleepEx(0, TRUE);

	return 0;
}


VOID
PrintApcPreviousRIP(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3,
	PCONTEXT ContextRecord
	)
{
	printf("RIP = 0x%08I64X\n", (ULONG_PTR)ContextRecord->Rip);
}
```

`ApcRoutineUseContextRecord/ApcRoutineUseContextRecord.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <ProjectGuid>{7231B11E-60AF-44A5-89D1-703A16D91375}</ProjectGuid>
    <RootNamespace>ApcRoutineUseContextRecord</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="ApcRoutineUseContextRecord.c" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`ApcRoutineUseContextRecord/ApcRoutineUseContextRecord.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="ApcRoutineUseContextRecord.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`InitialNtTestAlert/InitialNtTestAlert.c`:

```c
#include <Windows.h>
#include <stdio.h>
#include <winternl.h>


VOID
WINAPI
ApcRoutine(
	ULONG_PTR dwData
	);


DWORD
WINAPI
NewThread(
	PVOID ThreadArgument
	);

int
main(
	int argc,
	const char** argv
)
{
	HANDLE ThreadHandle = CreateThread(
								NULL,
								0,
								NewThread,
								NULL,
								CREATE_SUSPENDED,
								NULL
							);
		
	
	if (!QueueUserAPC(
		ApcRoutine,
		ThreadHandle,
		0
	)) {
		printf("Error queueing APC\n");
	}	

	printf("APC Queued. Calling ResumeThread..\n");

	ResumeThread(ThreadHandle);

	WaitForSingleObject(ThreadHandle, INFINITE);

	return 0;
}

VOID
WINAPI
ApcRoutine(
	ULONG_PTR dwData
)
{
	printf("Inside the ApcRoutine.\n");
}


DWORD
WINAPI
NewThread(
	PVOID ThreadArgument
	)
{
	printf("Inside the thread.\n");
	return 0;
}

```

`InitialNtTestAlert/InitialNtTestAlert.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <ProjectGuid>{AC5BE339-DBE9-4BDF-AFC3-56F2A983BCA7}</ProjectGuid>
    <RootNamespace>InitialNtTestAlert</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="InitialNtTestAlert.c" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`InitialNtTestAlert/InitialNtTestAlert.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="InitialNtTestAlert.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`InitialNtTestAlertCreateProcessInjection/InitialNtTestAlertCreateProcessInjection.c`:

```c
#include <Windows.h>
#include <winternl.h>
#include <stdio.h>

typedef
VOID
(*PPS_APC_ROUTINE)(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	);

typedef
NTSTATUS
(NTAPI* PNT_QUEUE_APC_THREAD)(
	IN HANDLE ThreadHandle,
	IN PPS_APC_ROUTINE ApcRoutine,
	IN PVOID SystemArgument1 OPTIONAL,
	IN PVOID SystemArgument2 OPTIONAL,
	IN PVOID SystemArgument3 OPTIONAL
	);


PVOID WriteLibraryNameToRemote(
	HANDLE ProcessHandle,
	PCWSTR Library
);

PNT_QUEUE_APC_THREAD NtQueueApcThread;

int
main(
	VOID
	)
{
	PROCESS_INFORMATION ProcessInformation;
	STARTUPINFO StartupInfo;
	PVOID LdrLoadDll;
	PVOID RemoteLibAddress;
	NTSTATUS Status;

	NtQueueApcThread = (PNT_QUEUE_APC_THREAD)(GetProcAddress(GetModuleHandle("ntdll"), "NtQueueApcThread"));
	LdrLoadDll = GetProcAddress(GetModuleHandle("ntdll"), "LdrLoadDll");

	RtlZeroMemory(&StartupInfo, sizeof(StartupInfo));
	RtlZeroMemory(&ProcessInformation, sizeof(PROCESS_INFORMATION));

	StartupInfo.cb = sizeof(StartupInfo);

	if (!CreateProcessA(
		"c:\\windows\\system32\\write.exe",
		NULL, NULL, NULL, FALSE,
		CREATE_SUSPENDED,
		NULL, NULL,
		&StartupInfo,
		&ProcessInformation
	)){
		printf("Error creating new process: 0x%08X\n", GetLastError());
		exit(-1);
	}


	RemoteLibAddress = WriteLibraryNameToRemote(ProcessInformation.hProcess, L"jscript.dll");

	Status = NtQueueApcThread(
				ProcessInformation.hThread, 
				(PPS_APC_ROUTINE)LdrLoadDll, 
				NULL, // PathToFile
				0,  // Flags
				RemoteLibAddress // ModuleFileName
				//
				// ModuleHandle is written to the _CONTEXT structure passed
				// to KiUserApcDispatcher.
				//
			);

	if (!NT_SUCCESS(Status)) {
		printf("NtQueueApcThread 0x%08X\n", Status);
	}

	ResumeThread(ProcessInformation.hThread);
}

PVOID WriteLibraryNameToRemote(
	HANDLE ProcessHandle,
	PCWSTR Library
)
{
	USHORT LibraryLength = (USHORT)(wcslen(Library) * sizeof(WCHAR));
	USHORT AllocationLength = LibraryLength+1+sizeof(UNICODE_STRING);

	PVOID LibraryRemoteAddress = VirtualAllocEx(
		ProcessHandle,
		NULL,
		AllocationLength,
		MEM_RESERVE | MEM_COMMIT,
		PAGE_READWRITE
	);

	if (!LibraryRemoteAddress) {
		printf("Cannot allocate memory for library path. Error: 0x%08X\n", GetLastError());
		exit(-1);
	}
	PUNICODE_STRING LocalUnicodeString = (PUNICODE_STRING)HeapAlloc(GetProcessHeap(), 0, AllocationLength);

	if (LocalUnicodeString == NULL) {
		exit(-1);
	}

	RtlZeroMemory(LocalUnicodeString, AllocationLength);
	
	LocalUnicodeString->MaximumLength = LibraryLength;
	LocalUnicodeString->Length = LibraryLength;
	LocalUnicodeString->Buffer = (PWCHAR) (((PUCHAR)LibraryRemoteAddress)+sizeof(UNICODE_STRING));
	
	RtlCopyMemory((((PUCHAR)LocalUnicodeString)+sizeof(UNICODE_STRING)), Library, LibraryLength);

	if (!WriteProcessMemory(
		ProcessHandle,
		LibraryRemoteAddress,
		LocalUnicodeString,
		sizeof(UNICODE_STRING) + LibraryLength + 1,
		NULL
	)) {
		printf("Cannot write library path to remote process. Error: 0x%08X\n", GetLastError());
		exit(-1);
	}

	return LibraryRemoteAddress;
}
```

`InitialNtTestAlertCreateProcessInjection/InitialNtTestAlertCreateProcessInjection.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="InitialNtTestAlertCreateProcessInjection.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`InitialNtTestAlertCreateProcessInjection/InitialNtTestAlertCreateProcessInjection.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <ProjectGuid>{C7FE0E49-4619-4340-89C6-BA9CEDA2F250}</ProjectGuid>
    <RootNamespace>InitialNtTestAlertCreateProcessInjection</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
    <ProjectName>InitialNtTestAlertCreateProcessInjection</ProjectName>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <LinkIncremental>false</LinkIncremental>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
      <SupportJustMyCode>false</SupportJustMyCode>
      <DebugInformationFormat>ProgramDatabase</DebugInformationFormat>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <AdditionalDependencies>ntdll.lib;kernel32.lib;user32.lib;gdi32.lib;winspool.lib;comdlg32.lib;advapi32.lib;shell32.lib;ole32.lib;oleaut32.lib;uuid.lib;odbc32.lib;odbccp32.lib;%(AdditionalDependencies)</AdditionalDependencies>
      <AdditionalOptions>/Release %(AdditionalOptions)</AdditionalOptions>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <AdditionalDependencies>ntdll.lib;kernel32.lib;user32.lib;gdi32.lib;winspool.lib;comdlg32.lib;advapi32.lib;shell32.lib;ole32.lib;oleaut32.lib;uuid.lib;odbc32.lib;odbccp32.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <AdditionalDependencies>ntdll.lib;kernel32.lib;user32.lib;gdi32.lib;winspool.lib;comdlg32.lib;advapi32.lib;shell32.lib;ole32.lib;oleaut32.lib;uuid.lib;odbc32.lib;odbccp32.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <AdditionalDependencies>ntdll.lib;kernel32.lib;user32.lib;gdi32.lib;winspool.lib;comdlg32.lib;advapi32.lib;shell32.lib;ole32.lib;oleaut32.lib;uuid.lib;odbc32.lib;odbccp32.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="InitialNtTestAlertCreateProcessInjection.c" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`MemoryReserveApc/MemoryReserveApc.c`:

```c
#include <Windows.h>
#include <stdio.h>
#include <winternl.h>


typedef
VOID
(*PPS_APC_ROUTINE)(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	);

typedef
NTSTATUS
(NTAPI *PNT_QUEUE_APC_THREAD_EX)(
	IN HANDLE ThreadHandle,
	IN HANDLE MemoryReserveHandle,
	IN PPS_APC_ROUTINE ApcRoutine,
	IN PVOID SystemArgument1 OPTIONAL,
	IN PVOID SystemArgument2 OPTIONAL,
	IN PVOID SystemArgument3 OPTIONAL
	);

typedef enum _MEMORY_RESERVE_OBJECT_TYPE {
	MemoryReserveObjectTypeUserApc,
	MemoryReserveObjectTypeIoCompletion
} MEMORY_RESERVE_OBJECT_TYPE, PMEMORY_RESERVE_OBJECT_TYPE;

typedef
NTSTATUS
(NTAPI *PNT_ALLOCATE_RESERVE_OBJECT)(
	__out PHANDLE MemoryReserveHandle,
	__in_opt POBJECT_ATTRIBUTES ObjectAttributes,
	__in ULONG Type
);

VOID
ExampleApcRoutine(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	);

PNT_ALLOCATE_RESERVE_OBJECT NtAllocateReserveObject;
PNT_QUEUE_APC_THREAD_EX NtQueueApcThreadEx;

int main(
	int argc,
	const char** argv
	)
{
	NTSTATUS Status;
	HANDLE MemoryReserveHandle;

	NtQueueApcThreadEx = (PNT_QUEUE_APC_THREAD_EX)GetProcAddress(GetModuleHandle("ntdll.dll"), "NtQueueApcThreadEx");
	NtAllocateReserveObject = (PNT_ALLOCATE_RESERVE_OBJECT)GetProcAddress(GetModuleHandle("ntdll.dll"), "NtAllocateReserveObject");
	
	if (!NtQueueApcThreadEx || !NtAllocateReserveObject) {
		printf("wtf before win7.\n");
		exit(0x1337);
	}

	Status = NtAllocateReserveObject(&MemoryReserveHandle, NULL, MemoryReserveObjectTypeUserApc);

	if (!NT_SUCCESS(Status)) {
		printf("NtAllocateReserveObject Failed! 0x%08X\n", Status);
		return -1;
	}

	while (TRUE) {
		//
		// Queue the APC to the current thread.
		//
		Status = NtQueueApcThreadEx(
					GetCurrentThread(),
					MemoryReserveHandle,
					ExampleApcRoutine,
					NULL,
					NULL,
					NULL
				);

		if (!NT_SUCCESS(Status)) {
			printf("NtQueueApcThreadEx Failed! 0x%08X\n", Status);
			return -1;
		}

		//
		// Enter alertable state to execute the APC.
		//
		SleepEx(0, TRUE);
	}

	return 0;
}

VOID
ExampleApcRoutine(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
)
{
	Sleep(500); 

	printf("This is the weird loop!\n");
}
```

`MemoryReserveApc/MemoryReserveApc.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <ProjectGuid>{D2B1205E-B346-4AF5-A7B6-31E0D98E318E}</ProjectGuid>
    <RootNamespace>MemoryReserveApc</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="MemoryReserveApc.c" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`MemoryReserveApc/MemoryReserveApc.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="MemoryReserveApc.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`NtWaitForSingleObjectUserApc/NtWaitForSingleObjectUserApc.c`:

```c
#include <Windows.h>
#include <winternl.h>
#pragma warning(push)
#pragma warning(disable: 4005) // macro redefinition
#include <ntstatus.h>
#pragma warning(pop)
#include <stdio.h>

DWORD
WINAPI
WorkerThread(
	PVOID EventHandleArg
);

VOID
UserApc(
	VOID
);

HANDLE gEventHandle;



int main() 
{
	HANDLE ThreadHandle;

	gEventHandle = CreateEvent(NULL, TRUE, FALSE, NULL);
	ThreadHandle = CreateThread(NULL, 0, WorkerThread, gEventHandle, 0, NULL);

	
	for (int i=0; i<10; i++){
		Sleep(500);
		
		QueueUserAPC((PAPCFUNC)UserApc, ThreadHandle, 0);
	}

}

VOID
UserApc(
	VOID
)
{
	printf("User APC is delivered.\n");
}

DWORD
WINAPI
WorkerThread(
	PVOID ThreadParam
	) 
{
	UNREFERENCED_PARAMETER(ThreadParam);
	
	NTSTATUS Status;

	while (TRUE) {
		Status = NtWaitForSingleObject(gEventHandle, TRUE, NULL);

		if (Status == STATUS_USER_APC) {
			printf("Status == STATUS_USER_APC\n");
		}
		else {
			printf("Status == 0x%08X\n", Status);
		}
	}
}
```

`NtWaitForSingleObjectUserApc/NtWaitForSingleObjectUserApc.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <ProjectGuid>{B574E10D-C173-427A-A1E0-14C70060B5F1}</ProjectGuid>
    <RootNamespace>NtWaitForSingleObjectUserApc</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <AdditionalDependencies>ntdll.lib;kernel32.lib;user32.lib;gdi32.lib;winspool.lib;comdlg32.lib;advapi32.lib;shell32.lib;ole32.lib;oleaut32.lib;uuid.lib;odbc32.lib;odbccp32.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <AdditionalDependencies>ntdll.lib;kernel32.lib;user32.lib;gdi32.lib;winspool.lib;comdlg32.lib;advapi32.lib;shell32.lib;ole32.lib;oleaut32.lib;uuid.lib;odbc32.lib;odbccp32.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <AdditionalDependencies>ntdll.lib;kernel32.lib;user32.lib;gdi32.lib;winspool.lib;comdlg32.lib;advapi32.lib;shell32.lib;ole32.lib;oleaut32.lib;uuid.lib;odbc32.lib;odbccp32.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <AdditionalDependencies>ntdll.lib;kernel32.lib;user32.lib;gdi32.lib;winspool.lib;comdlg32.lib;advapi32.lib;shell32.lib;ole32.lib;oleaut32.lib;uuid.lib;odbc32.lib;odbccp32.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="NtWaitForSingleObjectUserApc.c" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`NtWaitForSingleObjectUserApc/NtWaitForSingleObjectUserApc.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="NtWaitForSingleObjectUserApc.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`NullApcRoutine/NullApcRoutine.c`:

```c
#include <Windows.h>
#include <stdio.h>

typedef
VOID
(*PPS_APC_ROUTINE)(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	);

typedef
NTSTATUS
(NTAPI* PNT_QUEUE_APC_THREAD)(
	HANDLE ThreadHandle,
	PPS_APC_ROUTINE ApcRoutine,
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	);


PNT_QUEUE_APC_THREAD NtQueueApcThread;

VOID ApcCode(ULONG_PTR dwData)
{
	printf("ApcCode.\n");
}

int main()
{
	NtQueueApcThread = (PNT_QUEUE_APC_THREAD)GetProcAddress(GetModuleHandle("ntdll"), "NtQueueApcThread");

	QueueUserAPC(ApcCode, GetCurrentThread(), 0);

	NtQueueApcThread(GetCurrentThread(), NULL, NULL, NULL, NULL);
}
```

`NullApcRoutine/NullApcRoutine.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <ProjectGuid>{26AE58AB-A71A-4E71-A99A-D3770F06C20F}</ProjectGuid>
    <RootNamespace>NullApcRoutine</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="NullApcRoutine.c" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`NullApcRoutine/NullApcRoutine.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="NullApcRoutine.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`QueueApcAndNtTestAlert/QueueApcAndNtTestAlert.c`:

```c
#include <Windows.h>
#include <winternl.h>
#include <stdio.h>

typedef
NTSTATUS
(*PNT_TEST_ALERT)(
		VOID
	);

VOID
NTAPI
ApcCode(
	ULONG_PTR dwData
	)
{
	printf("Hello from APC!\n");
}


int main(
	int argc,
	const char** argv
	)
{
	HMODULE hNtdll = GetModuleHandle("ntdll.dll");

	PNT_TEST_ALERT NtTestAlert = (PNT_TEST_ALERT)(GetProcAddress(hNtdll, "NtTestAlert"));
	
	printf("Queueing APC..\n");

	QueueUserAPC(ApcCode, GetCurrentThread(), 0);
	
	printf("Calling NtTestAlert...\n");

	NtTestAlert();

	printf("After NtTestAlert..\n");

	return 0;

}
```

`QueueApcAndNtTestAlert/QueueApcAndNtTestAlert.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <ProjectGuid>{A0EBAC29-5E77-4962-B0D3-0E7B3680491B}</ProjectGuid>
    <RootNamespace>QueueApcAndNtTestAlert</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="QueueApcAndNtTestAlert.c" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`QueueApcAndNtTestAlert/QueueApcAndNtTestAlert.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="QueueApcAndNtTestAlert.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`QueueMultipleUserAPCs/QueueMultipleUserAPCs.c`:

```c
#include <Windows.h>
#include <stdio.h>

VOID
NTAPI
ApcCode1(
	ULONG_PTR dwData
	)
{
	printf("Hello from ApcCode1\n");
}

VOID 
NTAPI
ApcCode2(
	ULONG_PTR dwData
	)
{
	printf("Hello from ApcCode2\n");
}


int main(
	int argc,
	const char** argv
	)
{
	printf("Queueing APCs..\n");

	QueueUserAPC(ApcCode1, GetCurrentThread(), 0);
	QueueUserAPC(ApcCode2, GetCurrentThread(), 0);
		
	printf("Entering alertable state..\n");

	SleepEx(0, TRUE);

	printf("Exiting..\n");
}
```

`QueueMultipleUserAPCs/QueueMultipleUserAPCs.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <ProjectGuid>{A1F1C700-3B2A-496C-9F9B-6FCB2BA57DD0}</ProjectGuid>
    <RootNamespace>QueueMultipleUserAPCs</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="QueueMultipleUserAPCs.c" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`QueueMultipleUserAPCs/QueueMultipleUserAPCs.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="QueueMultipleUserAPCs.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`README.md`:

```md
# APC Internals Research Code

This repo will contain all the code related to the APC research including reverse engineered sources.

### ApcLib

A library with common functionality related to the supplied samples.

### ApcDllInjector

Allows to inject a DLL using a user mode APC from user mode.

```
ApcDllInjector.exe <native/win32/special> <process_id> <dll_path> [thread_id]
```

- native: Uses NtQueueApcThread
- win32: Uses QueueUserAPC
- special: Uses NtQueueApcThreadEx with the special flag.

The dll_path is written to the remote process using WriteProcessMemory.

The target of the APC is LoadLibrary.

### ApcRaceConditionExample

This is an example of a possible race condition that can occur if Special APCs are used without caution. 

### ApcRoutineUseContextRecord

This is an example of an APC routine that uses the hidden context argument. It prints the RIP at the point the APC "interrupted" the
thread.

### MemoryReserveApc

This is an example of using Memory Reserve object to reuse the memory of a KAPC object.

### SpecialUserApcExample

This is an example showing how special kernel APC is delivered to a thread even if it's not an alertable state.

### InitialNtTestAlert

This shows how we can abuse the NtTestAlert call that is called before the win32 start address of the
thread to execute an APC.

### NtWaitForSingleObjectUserApc

This test shows how NtWaitForSingleObject returns STATUS_USER_APC when an APC is delivered to the thread. 
WaitForSingleObject() is a wrapper that simply ignores this value and waits again.

### InitialNtTestAlertCreateProcessInjection

This is an example of an injection technique that uses the initial NtTestAlert.

### AlertableStateApcPending

This example shows what happens when you enter an alertable state after queueing an APC.

### QueueApcAndNtTestAlert

This example shows how NtTestAlert can be used to execute pending APCs.

### SimpleUserApcDriver

A driver that lets a user mode caller to run 2 functions:

1 - SimpleNtQueueApcThread: A simple implementation that shows how a user APC can be queued from 
kernel mode.

2 - SimpleNtWaitForSingleObject: A simple implementation of NtWaitForSingleObject for event objects.

### SimpleUserApcDriverTester

Test the SimpleNtQueueApcThread function.

### SimpleUserApcWaitTester

Test the SimpleNtWaitForSingleObject function.

### 32bitApc

A x86 sample that uses QueueUserAPC. Can be used to debug the Wow64 APC.

### NullApcRoutine

A sample that can be used to debug a user APC with a null ApcRoutine. This is 
interesting because it actually creates a KernelMode APC.

### QueueMultipleUserAPCs

A sample that shows the behavior with multiple pending APCs.


### Wow64To64bitInjector

Shows how a Wow64 process can queue an APC in a 64 bit process.

### x64ToWow64ApcInjector

Shows how a 64 bit process can queue an APC in a Wow64 process. The APC can be one of 2 kinds:

1. A 64 bit APC. used to execute a 64 bit ApcRoutine.
2. A Wow64 APC: The ApcRoutine should run in a Wow64 environment.
```

`SimpleUserApcDriver/KeApc.h`:

```h
#pragma once
#include <ntifs.h>

typedef enum _KAPC_ENVIRONMENT {
	OriginalApcEnvironment,
	AttachedApcEnvironment,
	CurrentApcEnvironment,
	InsertApcEnvironment
} KAPC_ENVIRONMENT;

typedef
VOID
(*PKNORMAL_ROUTINE) (
	IN PVOID NormalContext,
	IN PVOID SystemArgument1,
	IN PVOID SystemArgument2
	);

typedef
VOID
(*PKKERNEL_ROUTINE) (
	IN PKAPC Apc,
	IN OUT PKNORMAL_ROUTINE* NormalRoutine,
	IN OUT PVOID* NormalContext,
	IN OUT PVOID* SystemArgument1,
	IN OUT PVOID* SystemArgument2
	);

typedef
VOID
(*PKRUNDOWN_ROUTINE) (
	IN  PKAPC Apc
	);


//
// KeInitializeApc:
//
//	This function initializes the members of the KAPC object.
//
//	Apc: The pointer to the APC object that was allocated in a non-paged area.
//
//  Thread: The pointer to the target thread object.
//
//  Environment: Not relevant to user APCs - OriginalApcEnvironment.
//
//  RundownRoutine: A function that should free the APC. This function will run in case 
//					the thread terminates and the APC did not execute.
//
//	KernelRoutine: A function that executes at APC_LEVEL before the user APC is delivered to 
//				   the user mode thread. This function should free the APC. 
//
//	NormalRoutine: A pointer to the APC routine in user mode. 
//
//	ApcMode: The mode of the APC. For user mode APCs, set to UserMode.
//
//	NormalContext: A parameter that is passed as the first argument of the NormalRoutine.
//
VOID
KeInitializeApc(
	IN  PKAPC Apc,
	IN  PKTHREAD Thread,
	IN  KAPC_ENVIRONMENT Environment,
	IN  PKKERNEL_ROUTINE KernelRoutine,
	IN  PKRUNDOWN_ROUTINE RundownRoutine OPTIONAL,
	IN  PKNORMAL_ROUTINE NormalRoutine OPTIONAL,
	IN  KPROCESSOR_MODE ApcMode OPTIONAL,
	IN  PVOID NormalContext OPTIONAL
);



//
// KeInsertQueueApc:
//
//	Apc: The pointer to the APC object that was initialized using KeInitializeApc.
//
//	SystemArgument1: This is the second argument of the APC routine in user mode.
//
//	SystemArgument2: This is the third argument of the APC routine in user mode.
//
//	Increment: Optional priority increment that is given to the thread in case the thread is signaled.
//
//
BOOLEAN
KeInsertQueueApc(
	IN  PKAPC Apc,
	IN  PVOID SystemArgument1,
	IN  PVOID SystemArgument2,
	IN  KPRIORITY Increment
);
```

`SimpleUserApcDriver/SimpleUserApc.c`:

```c
#include "SimpleUserApc.h"

NTSTATUS
SimpleNtQueueApcThread(
	HANDLE ThreadHandle,
	PPS_APC_ROUTINE ApcRoutine,
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
)
{
	NTSTATUS Status = STATUS_SUCCESS;
	PKAPC Apc = NULL;
	PETHREAD TargetThread = NULL;
	BOOLEAN Inserted = FALSE;

	//
	// Obtain pointer to KTHREAD of the target thread.
	// Verify the handle has THREAD_SET_CONTEXT access.
	//
	Status = ObReferenceObjectByHandle(
		ThreadHandle,
		THREAD_SET_CONTEXT,
		*PsThreadType,
		UserMode,
		&TargetThread,
		NULL
	);

	if (!NT_SUCCESS(Status)) {
		TargetThread = NULL;
		goto Cleanup;
	}

	//
	// Allocate the KAPC object which represents the APC object in the non-paged pool.
	//
	Apc = ExAllocatePoolWithTag(
		NonPagedPoolNx,
		sizeof(KAPC),
		'CPAK'
	);

	if (Apc == NULL) {
		Status = STATUS_NO_MEMORY;
		goto Cleanup;
	}

	//
	// Initialize the members of the KAPC object.
	//
	KeInitializeApc(
		Apc,
		TargetThread,
		OriginalApcEnvironment,
		(PKKERNEL_ROUTINE)ExFreePool,
		(PKRUNDOWN_ROUTINE)ExFreePool,
		ApcRoutine,
		UserMode,
		SystemArgument1
	);

	//
	// Insert the APC into the user queue of the target thread.
	// If the thread is in an alertable wait, signal the thread to execute the APC.
	//
	Inserted = KeInsertQueueApc(Apc, SystemArgument2, SystemArgument3, 0);

	//
	// If the insertion failed (typically because target thread is in 
	// the middle of termination) return an error.
	//
	if (!Inserted) {
		Status = STATUS_UNSUCCESSFUL;
		goto Cleanup;
	}

	Status = STATUS_SUCCESS;

Cleanup:
	if (Apc) {
		ExFreePool(Apc);
	}

	if (TargetThread) {
		ObDereferenceObject(TargetThread);
	}
	
	return Status;
}


//
// A simpler implementation of NtWaitForSingleObject for event objects.
// This can be used to demostrate how user APCs can signal waits.
//
NTSTATUS
SimpleNtWaitForSingleObject(
	HANDLE Object,
	BOOLEAN Alertable,
	PLARGE_INTEGER Timeout
	)
{
	PKEVENT UserEvent = NULL;
	NTSTATUS Status;

	Status = ObReferenceObjectByHandle(
				Object,
				SYNCHRONIZE,
				*ExEventObjectType,
				UserMode,
				&UserEvent,
				NULL
			);

	if (!NT_SUCCESS(Status)) {
		goto Cleanup;
	}

	Status = KeWaitForSingleObject(
				UserEvent,
				UserRequest,
				UserMode,
				Alertable,
				Timeout
			);

Cleanup:
	if (UserEvent) {
		ObDereferenceObject(UserEvent);
	}

	return Status;
}
```

`SimpleUserApcDriver/SimpleUserApc.h`:

```h
#pragma once
#include "KeApc.h"


typedef VOID
(*PPS_APC_ROUTINE)(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	);


NTSTATUS
SimpleNtQueueApcThread(
	HANDLE ThreadHandle,
	PPS_APC_ROUTINE ApcRoutine,
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	);

NTSTATUS
SimpleNtWaitForSingleObject(
	HANDLE Event,
	BOOLEAN Alertable,
	PLARGE_INTEGER Timeout
	);
```

`SimpleUserApcDriver/SimpleUserApcControl.h`:

```h
#pragma once

#define SIMPLE_USER_APC_DEVICE_NAME_W L"SimpleUserApcDevice"
#define SIMPLE_USER_APC_DEVICE_NAME_A "SimpleUserApcDevice"

typedef VOID
(*PPS_APC_ROUTINE)(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	);


typedef struct _SIMPLE_QUEUE_APC_THREAD {
	HANDLE ThreadHandle;
	PPS_APC_ROUTINE ApcRoutine;
	PVOID SystemArgument1;
	PVOID SystemArgument2;
	PVOID SystemArgument3;
} SIMPLE_QUEUE_APC_THREAD, *PSIMPLE_QUEUE_APC_THREAD;

#define IOCTL_SIMPLE_USER_APC_QUEUE CTL_CODE(FILE_DEVICE_UNKNOWN, 0x1, METHOD_BUFFERED, FILE_ANY_ACCESS)



typedef struct _SIMPLE_USER_APC_WAIT {
	HANDLE Event;
	BOOLEAN Alertable;
	LARGE_INTEGER Timeout;
} SIMPLE_USER_APC_WAIT, *PSIMPLE_USER_APC_WAIT;

#define IOCTL_SIMPLE_USER_APC_WAIT CTL_CODE(FILE_DEVICE_UNKNOWN, 0x2, METHOD_BUFFERED, FILE_ANY_ACCESS)

```

`SimpleUserApcDriver/SimpleUserApcDevice.c`:

```c
#include "SimpleUserApcDevice.h"
#include "SimpleUserApcControl.h"
#include "SimpleUserApc.h"


NTSTATUS
SimpleUserApcDefaultSuccess(
	PDEVICE_OBJECT DeviceObject,
	PIRP Irp
	);

NTSTATUS
SimpleUserApcIoControlDispatch(
	PDEVICE_OBJECT DeviceObject,
	PIRP Irp
	);

static UNICODE_STRING gDeviceName = RTL_CONSTANT_STRING(L"\\Device\\" SIMPLE_USER_APC_DEVICE_NAME_W);
static UNICODE_STRING gDeviceSymbolicLink = RTL_CONSTANT_STRING(L"\\??\\" SIMPLE_USER_APC_DEVICE_NAME_W);
static PDEVICE_OBJECT gDeviceObject = NULL;

NTSTATUS
SimpleUserApcInitializeDevice(
	PDRIVER_OBJECT DriverObject
	)
{
	struct {
		BOOLEAN InitializedDevice;
	} CleanupState = {0};

	NTSTATUS Status;

	Status = IoCreateDevice(
			DriverObject,
			0,
			&gDeviceName,
			FILE_DEVICE_UNKNOWN,
			0,
			TRUE,
			&gDeviceObject
		);

	if (!NT_SUCCESS(Status)) {
		goto Cleanup;
	}
	
	CleanupState.InitializedDevice = TRUE;

	Status = IoCreateSymbolicLink(&gDeviceSymbolicLink, &gDeviceName);

	if (!NT_SUCCESS(Status)) {
		goto Cleanup;
	}

	DriverObject->MajorFunction[IRP_MJ_CREATE] = SimpleUserApcDefaultSuccess;
	DriverObject->MajorFunction[IRP_MJ_CLOSE] = SimpleUserApcDefaultSuccess;
	DriverObject->MajorFunction[IRP_MJ_DEVICE_CONTROL] = SimpleUserApcIoControlDispatch;
	
	Status = STATUS_SUCCESS;

Cleanup:
	if (!NT_SUCCESS(Status)) {
		if (CleanupState.InitializedDevice) {
			IoDeleteDevice(gDeviceObject);
		}
	}

	return Status;
}

VOID
SimpleUserApcDeleteDevice(
	VOID
	)
{
	IoDeleteSymbolicLink(&gDeviceSymbolicLink);
	IoDeleteDevice(gDeviceObject);
}

NTSTATUS
SimpleUserApcDefaultSuccess(
	PDEVICE_OBJECT DeviceObject,
	PIRP Irp
	)
{
	UNREFERENCED_PARAMETER(DeviceObject);
	UNREFERENCED_PARAMETER(Irp);

	Irp->IoStatus.Status = STATUS_SUCCESS;
	Irp->IoStatus.Information = 0;
	IoCompleteRequest(Irp, IO_NO_INCREMENT);
	return STATUS_SUCCESS;
}

NTSTATUS
SimpleUserApcIoControlDispatch(
	PDEVICE_OBJECT DeviceObject,
	PIRP Irp
	)
{
	UNREFERENCED_PARAMETER(DeviceObject);


	NTSTATUS Status = STATUS_SUCCESS;
	PIO_STACK_LOCATION IoStackLocation = IoGetCurrentIrpStackLocation(Irp);
	

	switch (IoStackLocation->Parameters.DeviceIoControl.IoControlCode) {
	case IOCTL_SIMPLE_USER_APC_QUEUE: {
		if (IoStackLocation->Parameters.DeviceIoControl.InputBufferLength != sizeof(SIMPLE_QUEUE_APC_THREAD)) {
			Status = STATUS_INFO_LENGTH_MISMATCH;
			goto Cleanup;
		}

		PSIMPLE_QUEUE_APC_THREAD QueueApcArguments = (PSIMPLE_QUEUE_APC_THREAD)Irp->AssociatedIrp.SystemBuffer;
		
		Status = SimpleNtQueueApcThread(
			QueueApcArguments->ThreadHandle,
			QueueApcArguments->ApcRoutine,
			QueueApcArguments->SystemArgument1,
			QueueApcArguments->SystemArgument2,
			QueueApcArguments->SystemArgument3
		);
	}
	break;
	case IOCTL_SIMPLE_USER_APC_WAIT: {
		if (IoStackLocation->Parameters.DeviceIoControl.InputBufferLength != sizeof(SIMPLE_USER_APC_WAIT)) {
			Status = STATUS_INFO_LENGTH_MISMATCH;
			goto Cleanup;
		}

		PSIMPLE_USER_APC_WAIT Wait = (PSIMPLE_USER_APC_WAIT)Irp->AssociatedIrp.SystemBuffer;

		Status = SimpleNtWaitForSingleObject(
			Wait->Event,
			Wait->Alertable,
			&Wait->Timeout
		);
	}
	break;
	default:
	break;
	}

Cleanup:
	Irp->IoStatus.Status = Status;
	Irp->IoStatus.Information = 0;

	IoCompleteRequest(Irp, IO_NO_INCREMENT);

	return Status;
}
```

`SimpleUserApcDriver/SimpleUserApcDevice.h`:

```h
#pragma once
#include <ntifs.h>

NTSTATUS
SimpleUserApcInitializeDevice(
	PDRIVER_OBJECT DriverObject
	);

VOID
SimpleUserApcDeleteDevice(
	VOID
	);
```

`SimpleUserApcDriver/SimpleUserApcDriver.inf`:

```inf
;
; SimpleUserApcDriver.inf
;

[Version]
Signature="$WINDOWS NT$"
Class=System
ClassGuid={4d36e97d-e325-11ce-bfc1-08002be10318}
Provider=%ManufacturerName%
DriverVer=
CatalogFile=SimpleUserApcDriver.cat

[DestinationDirs]
DefaultDestDir = 12


[SourceDisksNames]
1 = %DiskName%,,,""

[SourceDisksFiles]


[Manufacturer]
%ManufacturerName%=Standard,NT$ARCH$

[Standard.NT$ARCH$]


[Strings]
ManufacturerName="<Your manufacturer name>" ;TODO: Replace with your manufacturer name
ClassName=""
DiskName="SimpleUserApcDriver Source Disk"

```

`SimpleUserApcDriver/SimpleUserApcDriver.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <ProjectGuid>{0931E78A-75A0-4F92-8F26-A5B54D918AA4}</ProjectGuid>
    <TemplateGuid>{dd38f7fc-d7bd-488b-9242-7d8754cde80d}</TemplateGuid>
    <TargetFrameworkVersion>v4.5</TargetFrameworkVersion>
    <MinimumVisualStudioVersion>12.0</MinimumVisualStudioVersion>
    <Configuration>Debug</Configuration>
    <Platform Condition="'$(Platform)' == ''">Win32</Platform>
    <RootNamespace>SimpleUserApcDriver</RootNamespace>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>WDM</DriverType>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="PropertySheets">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <EnableInf2cat>false</EnableInf2cat>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <EnableInf2cat>false</EnableInf2cat>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <EnableInf2cat>false</EnableInf2cat>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <EnableInf2cat>false</EnableInf2cat>
  </PropertyGroup>
  <ItemGroup>
    <Inf Include="SimpleUserApcDriver.inf" />
  </ItemGroup>
  <ItemGroup>
    <FilesToPackage Include="$(TargetPath)" />
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="SimpleUserApc.c" />
    <ClCompile Include="SimpleUserApcDevice.c" />
    <ClCompile Include="SimpleUserApcDrv.c" />
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="KeApc.h" />
    <ClInclude Include="SimpleUserApc.h" />
    <ClInclude Include="SimpleUserApcControl.h" />
    <ClInclude Include="SimpleUserApcDevice.h" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`SimpleUserApcDriver/SimpleUserApcDriver.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hpp;hxx;hm;inl;inc;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
    <Filter Include="Driver Files">
      <UniqueIdentifier>{8E41214B-6785-4CFE-B992-037D68949A14}</UniqueIdentifier>
      <Extensions>inf;inv;inx;mof;mc;</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <Inf Include="SimpleUserApcDriver.inf">
      <Filter>Driver Files</Filter>
    </Inf>
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="KeApc.h">
      <Filter>Header Files</Filter>
    </ClInclude>
    <ClInclude Include="SimpleUserApc.h">
      <Filter>Header Files</Filter>
    </ClInclude>
    <ClInclude Include="SimpleUserApcDevice.h">
      <Filter>Header Files</Filter>
    </ClInclude>
    <ClInclude Include="SimpleUserApcControl.h">
      <Filter>Header Files</Filter>
    </ClInclude>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="SimpleUserApcDrv.c">
      <Filter>Source Files</Filter>
    </ClCompile>
    <ClCompile Include="SimpleUserApc.c">
      <Filter>Source Files</Filter>
    </ClCompile>
    <ClCompile Include="SimpleUserApcDevice.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`SimpleUserApcDriver/SimpleUserApcDrv.c`:

```c
#include <ntifs.h>
#include "SimpleUserApcDevice.h"

NTSTATUS
SimplerUserApcDriverUnload(
	PDRIVER_OBJECT DriverObject
	);

NTSTATUS
DriverEntry(
	PDRIVER_OBJECT DriverObject,
	PUNICODE_STRING RegistryKey
	)
{
	UNREFERENCED_PARAMETER(DriverObject);
	UNREFERENCED_PARAMETER(RegistryKey);
	
	DriverObject->DriverUnload = SimplerUserApcDriverUnload;

	return SimpleUserApcInitializeDevice(DriverObject);
}

NTSTATUS
SimplerUserApcDriverUnload(
	PDRIVER_OBJECT DriverObject
	)
{
	UNREFERENCED_PARAMETER(DriverObject);

	SimpleUserApcDeleteDevice();

	return STATUS_SUCCESS;
}
```

`SimpleUserApcDriverTester/SimpleUserApcDriverTester.c`:

```c
#include <windows.h>
#include <winioctl.h>
#include <SimpleUserApcDriver/SimpleUserApcControl.h>
#include <stdio.h>

VOID
DriverQueueApc(
	HANDLE ThreadHandle,
	PPS_APC_ROUTINE ApcRoutine,
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	);

DWORD
WINAPI
ApcThread(
	PVOID ThreadArgument
	)
{
	printf("ApcThread.\n");

	return 0;
}

VOID
MyCustomApc(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	)
{
	printf("MyCustomApc!\n");
}

int main(int argc, const char** argv)
{
	
	HANDLE ThreadHandle = CreateThread(
							NULL,
							0,
							ApcThread,
							NULL,
							CREATE_SUSPENDED,
							NULL
						);

	if (ThreadHandle == NULL) {
		printf("CreateThread Failed: 0x%08X\n", GetLastError());
		exit(-1);
	}

	DriverQueueApc(
		ThreadHandle,
		MyCustomApc,
		NULL,
		NULL,
		NULL
	);

	ResumeThread(ThreadHandle);
	WaitForSingleObject(ThreadHandle, INFINITE);
}

VOID
DriverQueueApc(
	HANDLE ThreadHandle,
	PPS_APC_ROUTINE ApcRoutine,
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	)
{

	HANDLE ApcDeviceHandle = NULL;
	SIMPLE_QUEUE_APC_THREAD QueueApcArgs;
	DWORD IoctlBytesReturned;

	RtlZeroMemory(&QueueApcArgs, sizeof(QueueApcArgs));

	QueueApcArgs.ThreadHandle = ThreadHandle;
	QueueApcArgs.ApcRoutine = ApcRoutine;
	QueueApcArgs.SystemArgument1 = SystemArgument1;
	QueueApcArgs.SystemArgument2 = SystemArgument2;
	QueueApcArgs.SystemArgument3 = SystemArgument3;

	ApcDeviceHandle = CreateFileA(
		"\\\\.\\" SIMPLE_USER_APC_DEVICE_NAME_A,
		FILE_ALL_ACCESS,
		0,
		NULL,
		OPEN_ALWAYS,
		FILE_ATTRIBUTE_NORMAL,
		NULL
	);

	if (ApcDeviceHandle == INVALID_HANDLE_VALUE) {
		printf("CreateFileA: Cannot open device 0x%08X\n", GetLastError());
		exit(-1);
	}

	
	if (!DeviceIoControl(
		ApcDeviceHandle,
		IOCTL_SIMPLE_USER_APC_QUEUE,
		&QueueApcArgs,
		sizeof(QueueApcArgs),
		NULL,
		0,
		&IoctlBytesReturned,
		NULL
	)) {
		printf("DeviceIoControl Failed! 0x%08X\n", GetLastError());
		CloseHandle(ApcDeviceHandle);
		exit(-1);
	}
	
	CloseHandle(ApcDeviceHandle);
}
```

`SimpleUserApcDriverTester/SimpleUserApcDriverTester.cpp`:

```cpp
#include <windows.h>
#include <winioctl.h>
#include <SimpleUserApcDriver/SimpleUserApcControl.h>
#include <stdio.h>

VOID
DriverQueueApc(
	HANDLE ThreadHandle,
	PPS_APC_ROUTINE ApcRoutine,
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	);

DWORD
ApcThread(
	PVOID ThreadArgument
	)
{
	printf("ApcThread.\n");

	return 0;
}

VOID
MyCustomApc(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	)
{
	printf("MyCustomApc!\n");
}

int main(int argc, const char** argv)
{
	
	HANDLE ThreadHandle = CreateThread(
							NULL,
							0,
							ApcThread,
							NULL,
							CREATE_SUSPENDED,
							NULL
						);

	if (ThreadHandle == NULL) {
		printf("CreateThread Failed: 0x%08X\n", GetLastError());
		exit(-1);
	}

	DriverQueueApc(
		ThreadHandle,
		MyCustomApc,
		NULL,
		NULL,
		NULL
	);

	ResumeThread(ThreadHandle);
	WaitForSingleObject(ThreadHandle, INFINITE);
}

VOID
DriverQueueApc(
	HANDLE ThreadHandle,
	PPS_APC_ROUTINE ApcRoutine,
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	)
{

	HANDLE ApcDeviceHandle = NULL;
	SIMPLE_QUEUE_APC_THREAD QueueApcArgs;
	DWORD IoctlBytesReturned;

	RtlZeroMemory(&QueueApcArgs, sizeof(QueueApcArgs));

	QueueApcArgs.ThreadHandle = ThreadHandle;
	QueueApcArgs.ApcRoutine = ApcRoutine;
	QueueApcArgs.SystemArgument1 = SystemArgument1;
	QueueApcArgs.SystemArgument2 = SystemArgument2;
	QueueApcArgs.SystemArgument3 = SystemArgument3;

	ApcDeviceHandle = CreateFileA(
		"\\\\.\\" SIMPLE_USER_APC_DEVICE_NAME_A,
		FILE_ALL_ACCESS,
		0,
		NULL,
		OPEN_ALWAYS,
		FILE_ATTRIBUTE_NORMAL,
		NULL
	);

	if (ApcDeviceHandle == INVALID_HANDLE_VALUE) {
		printf("CreateFileA: Cannot open device 0x%08X\n", GetLastError());
		exit(-1);
	}

	
	if (!DeviceIoControl(
		ApcDeviceHandle,
		IOCTL_SIMPLE_USER_APC_QUEUE,
		&QueueApcArgs,
		sizeof(QueueApcArgs),
		NULL,
		0,
		&IoctlBytesReturned,
		NULL
	)) {
		printf("DeviceIoControl Failed! 0x%08X\n", GetLastError());
		CloseHandle(ApcDeviceHandle);
		exit(-1);
	}
	
	CloseHandle(ApcDeviceHandle);
}
```

`SimpleUserApcDriverTester/SimpleUserApcDriverTester.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <ProjectGuid>{43F0DFFF-A641-408C-8882-4B593A7AA373}</ProjectGuid>
    <RootNamespace>SimpleUserApcDriverTester</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <AdditionalIncludeDirectories>$(SolutionDir)</AdditionalIncludeDirectories>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <AdditionalIncludeDirectories>$(SolutionDir)</AdditionalIncludeDirectories>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <AdditionalIncludeDirectories>$(SolutionDir)</AdditionalIncludeDirectories>
      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <AdditionalIncludeDirectories>$(SolutionDir)</AdditionalIncludeDirectories>
      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="SimpleUserApcDriverTester.c" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`SimpleUserApcDriverTester/SimpleUserApcDriverTester.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="SimpleUserApcDriverTester.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`SimpleUserApcWaitTester/SimpleUserApcWait.c`:

```c
#include <windows.h>
#include <winioctl.h>
#include <SimpleUserApcDriver/SimpleUserApcControl.h>
#include <stdio.h>
#include <winternl.h>

VOID
MyCustomApc(
	ULONG_PTR dwData
)
{
	printf("MyCustomApc!\n");
}

NTSTATUS
DriverWaitForEvent(
	HANDLE EventHandle,
	BOOLEAN Alertable,
	LARGE_INTEGER Timeout
)
{

	HANDLE ApcDeviceHandle = NULL;
	NTSTATUS Status;
	SIMPLE_USER_APC_WAIT WaitArgs;
	IO_STATUS_BLOCK IoStatusBlock;


	RtlZeroMemory(&WaitArgs, sizeof(WaitArgs));
	RtlZeroMemory(&IoStatusBlock, sizeof(IoStatusBlock));

	WaitArgs.Event = EventHandle;
	WaitArgs.Alertable = Alertable;
	WaitArgs.Timeout = Timeout;

	ApcDeviceHandle = CreateFileA(
		"\\\\.\\" SIMPLE_USER_APC_DEVICE_NAME_A,
		FILE_ALL_ACCESS,
		0,
		NULL,
		OPEN_ALWAYS,
		FILE_ATTRIBUTE_NORMAL,
		NULL
	);

	if (ApcDeviceHandle == INVALID_HANDLE_VALUE) {
		printf("CreateFileA: Cannot open device 0x%08X\n", GetLastError());
		exit(-1);
	}

	Status = NtDeviceIoControlFile(
		ApcDeviceHandle,
		NULL,
		NULL,
		NULL,
		&IoStatusBlock,
		IOCTL_SIMPLE_USER_APC_WAIT,
		&WaitArgs,
		sizeof(WaitArgs),
		NULL,
		0
	);

	if (Status = STATUS_USER_APC) {
		printf("STATUS_USER_APC!\n");
	}
	else {
		exit(-1);
	}

	CloseHandle(ApcDeviceHandle);
	return Status;
}
```

`SimpleUserApcWaitTester/SimpleUserApcWaitTester.c`:

```c
#include "SimpleUserApcWaitTester.h"


int main(int argc, const char** argv)
{
	UserApcToAlertableWaitingThread();

	UserApcToAlertableWaitingThread();
	
}


```

`SimpleUserApcWaitTester/SimpleUserApcWaitTester.h`:

```h
#pragma once
#include <Windows.h>

#define T_RELATIVE(Timeout) ((ULONGLONG)(-((LONGLONG)Timeout)))
#define T_MILLISECONDS(Milliseconds) (10000*((ULONGLONG)Milliseconds))
#define T_SECONDS(Seconds) (T_MILLISECONDS(1000*((ULONGLONG)Seconds)))

NTSTATUS
DriverWaitForEvent(
	HANDLE EventHandle,
	BOOLEAN Alertable,
	LARGE_INTEGER Timeout
);

VOID
MyCustomApc(
	ULONG_PTR dwData
	);

VOID
UserApcToAlertableWaitingThread(
	VOID
	);


VOID
UserApcToNonAlertableThread(
	VOID
	);	
```

`SimpleUserApcWaitTester/SimpleUserApcWaitTester.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <ProjectGuid>{201BCC66-5D46-4554-B592-75FD70C41643}</ProjectGuid>
    <RootNamespace>SimpleUserApcWaitTester</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
      <AdditionalIncludeDirectories>$(SolutionDir)</AdditionalIncludeDirectories>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <AdditionalDependencies>ntdll.lib;kernel32.lib;user32.lib;gdi32.lib;winspool.lib;comdlg32.lib;advapi32.lib;shell32.lib;ole32.lib;oleaut32.lib;uuid.lib;odbc32.lib;odbccp32.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
      <AdditionalIncludeDirectories>$(SolutionDir)</AdditionalIncludeDirectories>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <AdditionalDependencies>ntdll.lib;kernel32.lib;user32.lib;gdi32.lib;winspool.lib;comdlg32.lib;advapi32.lib;shell32.lib;ole32.lib;oleaut32.lib;uuid.lib;odbc32.lib;odbccp32.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="UserApcToAlertableWaitingThread.c" />
    <ClCompile Include="UserApcToNonAlertableThread.c" />
    <ClCompile Include="SimpleUserApcWait.c" />
    <ClCompile Include="SimpleUserApcWaitTester.c" />
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="SimpleUserApcWaitTester.h" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`SimpleUserApcWaitTester/SimpleUserApcWaitTester.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="SimpleUserApcWaitTester.c">
      <Filter>Source Files</Filter>
    </ClCompile>
    <ClCompile Include="SimpleUserApcWait.c">
      <Filter>Source Files</Filter>
    </ClCompile>
    <ClCompile Include="UserApcToAlertableWaitingThread.c">
      <Filter>Source Files</Filter>
    </ClCompile>
    <ClCompile Include="UserApcToNonAlertableThread.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="SimpleUserApcWaitTester.h">
      <Filter>Header Files</Filter>
    </ClInclude>
  </ItemGroup>
</Project>
```

`SimpleUserApcWaitTester/UserApcToAlertableWaitingThread.c`:

```c
#include <Windows.h>
#include "SimpleUserApcWaitTester.h"
#include <stdio.h>

DWORD
WINAPI
AlertableWaitingThread(
	PVOID ThreadArgument
	)
{
	printf("AlertableWaitingThread, going to wait..\n");

	HANDLE EventHandle = CreateEventA(NULL, TRUE, FALSE, NULL);

	LARGE_INTEGER Timeout;
	Timeout.QuadPart = T_RELATIVE(T_SECONDS(1000));

	DriverWaitForEvent(EventHandle, TRUE, Timeout);

	printf("Exited wait!");
	return 0;
}


VOID
UserApcToAlertableWaitingThread(
	VOID
	)
{
	HANDLE ThreadHandle = CreateThread(
		NULL,
		0,
		AlertableWaitingThread,
		NULL,
		0,
		NULL
	);

	if (ThreadHandle == NULL) {
		printf("CreateThread Failed: 0x%08X\n", GetLastError());
		exit(-1);
	}

	SetThreadPriority(ThreadHandle, THREAD_PRIORITY_TIME_CRITICAL);

	Sleep(2000);

	if (!QueueUserAPC(MyCustomApc, ThreadHandle, 0)) {
		printf("QueueUserAPC Error: 0x%08X\n", GetLastError());
	}

	WaitForSingleObject(ThreadHandle, INFINITE);
}
```

`SimpleUserApcWaitTester/UserApcToNonAlertableThread.c`:

```c
#include <Windows.h>
#include "SimpleUserApcWaitTester.h"
#include <stdio.h>

DWORD
WINAPI
NonAlertableThread(
	PVOID ThreadArgument
)
{
	LARGE_INTEGER Timeout;

	printf("NonAlertableThread, sleeping (non-alertable)..\n");

	HANDLE EventHandle = CreateEventA(NULL, TRUE, FALSE, NULL);

	//
	// Sleep for 10 seconds.
	//
	Sleep(10*1000);

	printf("Entering alertable state!\n");
	
	Timeout.QuadPart = T_RELATIVE(T_SECONDS(1000));

	DriverWaitForEvent(EventHandle, TRUE, Timeout);

	printf("Exited wait!");

	return 0;
}


VOID
UserApcToNonAlertableThread(
	VOID
)
{
	HANDLE ThreadHandle = CreateThread(
		NULL,
		0,
		NonAlertableThread,
		NULL,
		0,
		NULL
	);

	if (ThreadHandle == NULL) {
		printf("CreateThread Failed: 0x%08X\n", GetLastError());
		exit(-1);
	}

	Sleep(2000);

	if (!QueueUserAPC(MyCustomApc, ThreadHandle, 0)) {
		printf("QueueUserAPC Error: 0x%08X\n", GetLastError());
	}

	WaitForSingleObject(ThreadHandle, INFINITE);
}
```

`SimpleUserApcWaitTester/UserApcToRunningThread.c`:

```c
#include <Windows.h>
#include "SimpleUserApcWaitTester.h"


DWORD
NonAlertableThread(
	PVOID ThreadArgument
)
{
	LARGE_INTEGER Timeout;

	printf("NonAlertableThread, sleeping (non-alertable)..\n");

	HANDLE EventHandle = CreateEventA(NULL, TRUE, FALSE, NULL);

	//
	// Sleep for 10 seconds.
	//
	Sleep(10*1000);

	printf("Entering alertable state!\n");
	
	Timeout.QuadPart = T_RELATIVE(T_SECONDS(1000));

	DriverWaitForEvent(EventHandle, TRUE, Timeout);

	return 0;
}


VOID
UserApcToNonAlertableThread(
	VOID
)
{
	HANDLE ThreadHandle = CreateThread(
		NULL,
		0,
		NonAlertableThread,
		NULL,
		0,
		NULL
	);

	if (ThreadHandle == NULL) {
		printf("CreateThread Failed: 0x%08X\n", GetLastError());
		exit(-1);
	}

	Sleep(2000);

	if (!QueueUserAPC(MyCustomApc, ThreadHandle, 0)) {
		printf("QueueUserAPC Error: 0x%08X\n", GetLastError());
	}

	WaitForSingleObject(ThreadHandle, INFINITE);
}
```

`SpecialUserApcExample/SpecialUserApcExample.c`:

```c
#include <Windows.h>
#include <stdio.h>
#include <winternl.h>


typedef
VOID
(*PPS_APC_ROUTINE)(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	);

typedef enum _QUEUE_USER_APC_FLAGS {
	QueueUserApcFlagsNone,
	QueueUserApcFlagsSpecialUserApc,
	QueueUserApcFlagsMaxValue
} QUEUE_USER_APC_FLAGS;

typedef union _USER_APC_OPTION {
	ULONG_PTR UserApcFlags;
	HANDLE MemoryReserveHandle;
} USER_APC_OPTION, *PUSER_APC_OPTION;


typedef NTSTATUS
(NTAPI* PNT_QUEUE_APC_THREAD_EX)(
	IN HANDLE ThreadHandle,
	IN USER_APC_OPTION UserApcOption,
	IN PPS_APC_ROUTINE ApcRoutine,
	IN PVOID SystemArgument1 OPTIONAL,
	IN PVOID SystemArgument2 OPTIONAL,
	IN PVOID SystemArgument3 OPTIONAL
	);

VOID
ApcRoutine(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
);

int main(
	int argc,
	const char** argv
	)
{
	PNT_QUEUE_APC_THREAD_EX NtQueueApcThreadEx;
	USER_APC_OPTION UserApcOption;
	NTSTATUS Status;

	NtQueueApcThreadEx = (PNT_QUEUE_APC_THREAD_EX)(GetProcAddress(GetModuleHandle("ntdll.dll"), "NtQueueApcThreadEx"));
	
	if (!NtQueueApcThreadEx) {
		printf("wtf, before win7\n");
		return -1;
	}

	UserApcOption.UserApcFlags = QueueUserApcFlagsSpecialUserApc;

	while (TRUE) {
		//
		// This will force the current thread to execute the special user APC,
		// Although the current thread does not enter alertable state.
		//
		Status = NtQueueApcThreadEx(
					GetCurrentThread(),
					UserApcOption,
					ApcRoutine,
					NULL,
					NULL,
					NULL
				);

		if (!NT_SUCCESS(Status)) {
			printf("NtQueueApcThreadEx Failed! 0x%08X\n", Status);
			return -1;
		}

		//
		// This sleep does not enter alertable state.
		//
		Sleep(500);
	}

	

}

VOID
ApcRoutine(
	PVOID SystemArgument1,
	PVOID SystemArgument2,
	PVOID SystemArgument3
	)
{
	printf("What? I'm was not alertable!\n");
	Sleep(100);
}
```

`SpecialUserApcExample/SpecialUserApcExample.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <ProjectGuid>{6B327562-86D7-4BB8-B798-D152CF955276}</ProjectGuid>
    <RootNamespace>SpecialUserApcExample</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="SpecialUserApcExample.c" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`SpecialUserApcExample/SpecialUserApcExample.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="SpecialUserApcExample.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`Wow64To64bitInjector/Wow64To64bitInjector.c`:

```c
#include <ApcLib/ApcLib.h>
#include <stdio.h>
#include <winternl.h>
#include "x64Call.h"

typedef struct _WOW64_TO_64BIT_INJECTOR_ARGS {
	PCSTR DllPath;
	ULONG TargetProcessId;
	ULONG TargetThreadId;
} WOW64_TO_64BIT_INJECTOR_ARGS, *PWOW64_TO_64BIT_INJECTOR_ARGS;


VOID 
ParseArguments(
	__in int argc, 
	__in const char** argv,
	__out PWOW64_TO_64BIT_INJECTOR_ARGS Args
	)
{
	argc--;
	argv++;

	RtlZeroMemory(Args, sizeof(WOW64_TO_64BIT_INJECTOR_ARGS));

	if (argc < 2) {
		printf("Wow64To64bitInjector.exe <dll_path> <process_id> [thread_id]\n");
		exit(-1);
	}

	Args->DllPath = argv[0];
	Args->TargetProcessId = atoi(argv[1]);

	if (argc >= 3) {
		Args->TargetProcessId = atoi(argv[2]);
	}
}

__declspec(align(16))
typedef struct _NT_QUEUE_APC_THREAD_ARGS {
	DWORD64 ThreadHandle;
	DWORD64 ApcRoutine;
	DWORD64 SystemArgument1;
	DWORD64 SystemArgument2;
	DWORD64 SystemArgument3;
} NT_QUEUE_APC_THREAD_ARGS, *PNT_QUEUE_APC_THREAD_ARGS;


int main(int argc, const char** argv)
{
	NTSTATUS Status;
	HANDLE ProcessHandle;
	HANDLE ThreadHandle;
	WOW64_TO_64BIT_INJECTOR_ARGS Args;
	NT_QUEUE_APC_THREAD_ARGS QueueApcArgs;
	PVOID RemoteLibraryPath;
	DWORD64 NtQueueApcThreadAddress;

	RtlZeroMemory(&QueueApcArgs, sizeof(QueueApcArgs));
	
	InitializeApcLib();

	ParseArguments(argc, argv, &Args);
	
	OpenTargetHandles(Args.TargetProcessId, Args.TargetThreadId, &ProcessHandle, &ThreadHandle);

	//
	// Write the path of the DLL to the remote process
	//
	RemoteLibraryPath = WriteUnicodeLibraryNameToRemote(ProcessHandle, Args.DllPath);

	//
	// Save the 64 bit arguments on a struct
	//
	QueueApcArgs.ThreadHandle = (DWORD64)ThreadHandle;
	QueueApcArgs.ApcRoutine = x64_GetNtdllProcedure("LdrLoadDll");
	QueueApcArgs.SystemArgument1 = 0;
	QueueApcArgs.SystemArgument2 = 0;
	QueueApcArgs.SystemArgument3 = (DWORD64)RemoteLibraryPath;
	
	//
	// Find the address of the system call routine in NTDLL
	//
	NtQueueApcThreadAddress = x64_GetSyscallAddress("NtQueueApcThread");

	//
	// Invoke the system call
	//
	Status = x64_InvokeSyscall(NtQueueApcThreadAddress, &QueueApcArgs, sizeof(QueueApcArgs));

	if (!NT_SUCCESS(Status)) {
		printf("NtQueueApcThread Error: 0x%08X\n", Status);
		return -1;
	}


}
```

`Wow64To64bitInjector/Wow64To64bitInjector.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <ProjectGuid>{256C1B91-FF94-48D6-8A32-23993151D840}</ProjectGuid>
    <RootNamespace>Wow64To64bitInjector</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
    <Import Project="$(VCTargetsPath)\BuildCustomizations\masm.props" />
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <AdditionalIncludeDirectories>$(SolutionDir)</AdditionalIncludeDirectories>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <AdditionalIncludeDirectories>$(SolutionDir)</AdditionalIncludeDirectories>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <AdditionalIncludeDirectories>$(SolutionDir)</AdditionalIncludeDirectories>
      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <AdditionalIncludeDirectories>$(SolutionDir)</AdditionalIncludeDirectories>
      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="Wow64To64bitInjector.c" />
    <ClCompile Include="x64Call.c" />
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="x64Call.h" />
  </ItemGroup>
  <ItemGroup>
    <ProjectReference Include="..\ApcLib\ApcLib.vcxproj">
      <Project>{a2e5d416-54aa-47a7-afbd-247a56e28679}</Project>
    </ProjectReference>
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
    <Import Project="$(VCTargetsPath)\BuildCustomizations\masm.targets" />
  </ImportGroup>
</Project>
```

`Wow64To64bitInjector/Wow64To64bitInjector.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="Wow64To64bitInjector.c">
      <Filter>Source Files</Filter>
    </ClCompile>
    <ClCompile Include="x64Call.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="x64Call.h">
      <Filter>Header Files</Filter>
    </ClInclude>
  </ItemGroup>
</Project>
```

`Wow64To64bitInjector/x64Call.c`:

```c
/*
	This is taken from https://gist.github.com/Cr4sh/76b66b612a5d1dc2c614 with some modifications.
	Credit to github.com/Cr4sh for this implementation and Rewolf http://blog.rewolf.pl/blog/?p=102.
*/

#include <Windows.h>
#include <winternl.h>
#include "x64Call.h"
#pragma warning(push)

//
// Disable illegal instruction size warning.
// This happens because we emit 64 bit instructions in a 32 bit compiler.
//
#pragma warning(disable: 4409) 

#define DB(_val_) __asm __emit (_val_)

// code selectors
#define CS_32   0x23
#define CS_64   0x33

#define RAX     0
#define RCX     1
#define RDX     2
#define RBX     3
#define RSP     4
#define RBP     5
#define RSI     6
#define RDI     7
#define R8      8
#define R9      9
#define R10     10
#define R11     11
#define R12     12
#define R13     13
#define R14     14
#define R15     15

#define X64_PUSH(_r_) DB(0x48 | ((_r_) >> 3)) DB(0x50 | ((_r_) & 7))
#define X64_POP(_r_)  DB(0x48 | ((_r_) >> 3)) DB(0x58 | ((_r_) & 7))

// Switch processor to long mode
#define X64_ENTER_CS(_cs_)                                                                  \
    {                                                                                       \
        DB(0x6a) DB(_cs_)                               /*  push   @cs                  */  \
        DB(0xe8) DB(0x00) DB(0x00) DB(0x00) DB(0x00)    /*  call   $+5                  */  \
        DB(0x83) DB(0x04) DB(0x24) DB(0x05)             /*  add    dword [esp], 5       */  \
        DB(0xcb)                                        /*  retf                        */  \
    }

// Switch processor to WOW64 mode
#define X64_EXIT_CS(_cs_)                                                                   \
    {                                                                                       \
        DB(0xe8) DB(0x00) DB(0x00) DB(0x00) DB(0x00)    /*  call   $+5                  */  \
        DB(0xc7) DB(0x44) DB(0x24) DB(0x04) DB(_cs_)    /*  mov    dword [rsp + 4], @cs */  \
        DB(0x00) DB(0x00) DB(0x00)                                                          \
        DB(0x83) DB(0x04) DB(0x24) DB(0x0d)             /*  add    dword [rsp], 0xD     */  \
        DB(0xcb)                                        /*  retf                        */  \
    }

// 64-bit assembly helpers
#define X64_ENTER() X64_ENTER_CS(CS_64)
#define X64_EXIT() X64_EXIT_CS(CS_32)

#define GET_NEXT_ARG() i < ArgsCount ? Args[i++] : 0

DWORD 
x64_Call(
	DWORD64 ProcAddress, 
	PDWORD64 Args, 
	DWORD ArgsCount
	)
{
	DWORD Retval = 0, OldStack = 0, i = 0;

	DWORD64 _rcx = GET_NEXT_ARG();
	DWORD64 _rdx = GET_NEXT_ARG();
	DWORD64 _r8 = GET_NEXT_ARG();
	DWORD64 _r9 = GET_NEXT_ARG();

	DWORD64 StackArgs = 0;
	DWORD64 StackArgsCount = 0;

	if (ArgsCount > 4)
	{
		StackArgs = (DWORD64)& Args[3];
		StackArgsCount = ArgsCount - 4;
	}

	__asm
	{
		push    ebx
		push    esi
		push    edi

		/**
		 * Stack align for 64-bit mode.
		 */
		 mov     OldStack, esp
		 and esp, 0xfffffff0

		 /**
		  * Swith to the long mode.
		  */
		  X64_ENTER()

		  /**
		   * Copy register arguments.
		   */
		   push    _rcx
		   X64_POP(RCX)

		   push    _rdx
		   X64_POP(RDX)

		   push    _r8
		   X64_POP(R8)

		   push    _r9
		   X64_POP(R9)

		   /**
			* Push stack arguments.
			*/
			push    StackArgs
			X64_POP(RDI)

			push    StackArgsCount
			X64_POP(RSI)

			test    esi, esi
			jz      _call

			_loop_push :

		push[edi + esi * 8]
			sub     esi, 1
			jnz     _loop_push

			_call :
		/**
		 * Perform a function call.
		 */
		push    ProcAddress
			X64_POP(RAX)

			sub     esp, 0x20
			call    eax
			add     esp, 0x20

			/**
			 * Save returned status code.
			 */
			mov     Retval, eax

			/**
			 * Remove syscall arguments from the stack.
			 */
			push    StackArgsCount
			X64_POP(RSI)

			test    esi, esi
			jz      _end

			_loop_pop :

		pop     edi
			sub     esi, 1
			jnz     _loop_pop

			_end :

		/**
		 * Swith back to the 32-bit mode.
		 */
		X64_EXIT()

			mov     esp, OldStack

			pop     edi
			pop     esi
			pop     ebx
	}

	return Retval;
}

//
// This function is used to copy memory from a 64 bit address.
// It happens when we want to read information from the 64 bit TEB / PEB.
// This is done to read the base address and parse the export table of the 64 bit NTDLL.
//
void x64_Memcpy(PVOID Dest, DWORD64 Source, DWORD64 Len)
{
	DWORD64 Destination = (DWORD64)Dest;

	__asm
	{
		push    esi
		push    edi

		/**
		 * Switch to the long mode.
		 */
		 X64_ENTER()

		 /**
		  * Copy register arguments.
		  */
		  push    Destination
		  X64_POP(RDI)

		  push    Source
		  X64_POP(RSI)

		  push    Len
		  X64_POP(RCX)

		  /**
		   * Perform memory regio copying.
		   */
		   rep movsb

		   /**
			* Swith back to the 32-bit mode.
			*/
			X64_EXIT()

			pop     edi
			pop     esi
	}
}

DWORD64 x64_GetTeb(void)
{
	LARGE_INTEGER Retval;
	Retval.QuadPart = 0;

	__asm
	{
		/**
		 * Swith to the long mode.
		 */
		X64_ENTER()

		X64_PUSH(R12)
		pop Retval.LowPart

		/**
		 * Swith back to the 32-bit mode.
		 */
		 X64_EXIT()
	}

	return Retval.QuadPart;
}

#define TEB64_ProcessEnvironmentBlock 0x60

DWORD64 x64_GetPeb(void)
{
	DWORD64 Peb = 0;
	DWORD64 Teb = x64_GetTeb();

	x64_Memcpy(&Peb, Teb + TEB64_ProcessEnvironmentBlock, sizeof(Peb));

	return Peb;
}

typedef DWORD64 PTR64;

#include <pshpack8.h>

typedef struct _LIST_ENTRY_64
{
	PTR64 Flink;
	PTR64 Blink;

} LIST_ENTRY_64;

typedef struct _UNICODE_STRING_64
{
	USHORT Length;
	USHORT MaximumLength;
	PTR64 Buffer;

} UNICODE_STRING64,
* PUNICODE_STRING64;

typedef struct _STRING_64
{
	USHORT Length;
	USHORT MaximumLength;
	PTR64 Buffer;

} ANSI_STRING_64,
* PANSI_STRING_64;

typedef struct _LDR_DATA_TABLE_ENTRY_64
{
	LIST_ENTRY_64 InLoadOrderModuleList;
	LIST_ENTRY_64 InMemoryOrderModuleList;
	LIST_ENTRY_64 InInitializationOrderModuleList;
	PTR64 DllBase;
	PTR64 EntryPoint;
	ULONG SizeOfImage;
	UNICODE_STRING64 FullDllName;
	UNICODE_STRING64 BaseDllName;
	ULONG Flags;
	USHORT LoadCount;
	USHORT TlsIndex;
	LIST_ENTRY_64 HashLinks;
	PTR64 SectionPointer;
	ULONG CheckSum;
	ULONG TimeDateStamp;

} LDR_DATA_TABLE_ENTRY_64,
* PLDR_DATA_TABLE_ENTRY_64;

typedef struct _PEB_LDR_DATA_64
{
	ULONG Length;
	BOOLEAN Initialized;
	PTR64 SsHandle;
	LIST_ENTRY_64 ModuleListLoadOrder;
	LIST_ENTRY_64 ModuleListMemoryOrder;
	LIST_ENTRY_64 ModuleListInitOrder;

} PEB_LDR_DATA_64,
* PPEB_LDR_DATA_64;

#include <poppack.h>

#define PEB64_Ldr 0x18

PSTR 
GetNameFromFullPath(
	PSTR Path
	)
{
	PSTR Name = Path;

	for (SIZE_T i = 0; i < strlen(Path); i++)
	{
		if (Path[i] == '\\' || Path[i] == '/')
		{
			Name = Path + i + 1;
		}
	}

	return Name;
}


DWORD64 
x64_GetModuleBase(
	PCSTR ModuleName
	)
{
	// get PEB pointer
	PTR64 Peb = x64_GetPeb();
	LIST_ENTRY_64 ListEntry;

	// get loader tables
	PTR64 LdrData = 0;
	x64_Memcpy(&LdrData, Peb + PEB64_Ldr, sizeof(LdrData));

	// get loaded modules list head
	PTR64 Head = LdrData + FIELD_OFFSET(PEB_LDR_DATA_64, ModuleListLoadOrder);
	x64_Memcpy(&ListEntry, Head, sizeof(ListEntry));

	PTR64 Entry = ListEntry.Flink;

	// parse loaded module list
	while (Entry != Head)
	{
		x64_Memcpy(&ListEntry, Entry, sizeof(ListEntry));

		// get module information
		LDR_DATA_TABLE_ENTRY_64 LdrData;
		DWORD64 Addr = (DWORD64)CONTAINING_RECORD(Entry, LDR_DATA_TABLE_ENTRY_64, InLoadOrderModuleList);
		x64_Memcpy(&LdrData, Addr, sizeof(LdrData));

		// get module name
		WCHAR FullDllNameCopy[MAX_PATH];
		DWORD64 dwCopyLen = min((DWORD64)LdrData.FullDllName.Length, sizeof(FullDllNameCopy) - sizeof(WCHAR));
		ZeroMemory(FullDllNameCopy, sizeof(FullDllNameCopy));
		x64_Memcpy(&FullDllNameCopy, LdrData.FullDllName.Buffer, dwCopyLen);

		char FullDllNameAscii[MAX_PATH];
		WideCharToMultiByte(CP_ACP, 0, FullDllNameCopy, -1, FullDllNameAscii, MAX_PATH, NULL, NULL);
		_strlwr_s(FullDllNameAscii, MAX_PATH - 1);

		if (!strcmp(GetNameFromFullPath(FullDllNameAscii), ModuleName))
		{
			return LdrData.DllBase;
		}

		Entry = ListEntry.Flink;
	}

	return 0;
}

DWORD64 
x64_GetProcAddressEx(
	DWORD64 ModuleBase, 
	PSTR ProcedureName
	)
{
	// get DOS header
	IMAGE_DOS_HEADER DosHeader;
	x64_Memcpy(&DosHeader, ModuleBase, sizeof(DosHeader));

	// get NT headers
	IMAGE_NT_HEADERS64 Headers;
	x64_Memcpy(&Headers, ModuleBase + DosHeader.e_lfanew, sizeof(Headers));

	DWORD ExportAddr = Headers.OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress;
	DWORD ExportSize = Headers.OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].Size;

	if (ExportAddr)
	{
		// get export directory
		IMAGE_EXPORT_DIRECTORY Export;
		x64_Memcpy(&Export, ModuleBase + ExportAddr, sizeof(Export));

		// parse exports
		for (DWORD i = 0; i < Export.NumberOfFunctions; i++)
		{
			// get function name
			DWORD NameAddr = 0;
			x64_Memcpy(&NameAddr, ModuleBase + Export.AddressOfNames + i * sizeof(DWORD), sizeof(NameAddr));

			char CurrentProcedureName[MAX_PATH];
			ZeroMemory(CurrentProcedureName, sizeof(CurrentProcedureName));
			x64_Memcpy(&CurrentProcedureName, ModuleBase + NameAddr, strlen(ProcedureName) + 1);

			if (!strcmp(CurrentProcedureName, ProcedureName))
			{
				// get function address
				USHORT Ordinal = 0;
				x64_Memcpy(&Ordinal, ModuleBase + Export.AddressOfNameOrdinals + i * sizeof(USHORT), sizeof(Ordinal));

				DWORD Addr = 0;
				x64_Memcpy(&Addr, ModuleBase + Export.AddressOfFunctions + Ordinal * sizeof(DWORD), sizeof(Addr));

				// check for the forwarded export
				if (Addr > ExportAddr &&
					Addr < ExportAddr + ExportSize)
				{
					return 0;
				}

				return ModuleBase + Addr;
			}
		}
	}

	return 0;
}

__declspec(align(16))
typedef struct _GET_PROC_ADDRESS_PARAMS
{
	PTR64 FunctionAddress;
	ANSI_STRING_64 FunctionName;
	char Name[MAX_PATH];

} GET_PROC_ADDRESS_PARAMS,
* PGET_PROC_ADDRESS_PARAMS;

typedef NTSTATUS(WINAPI* func_LdrGetProcedureAddress)(
	HMODULE ModuleHandle,
	PANSI_STRING FunctionName,
	WORD Oridinal,
	PVOID* FunctionAddress
	);

DWORD64 m_LdrGetProcedureAddress = 0;

DWORD64 x64_GetProcAddress(DWORD64 ModuleBase, PCSTR ProcedureName)
{
	if (m_LdrGetProcedureAddress == 0)
	{
		// get ntdll!LdrGetProcedureAddress()
		DWORD64 Ntdll = x64_GetModuleBase("ntdll.dll");
		m_LdrGetProcedureAddress = x64_GetProcAddressEx(Ntdll, "LdrGetProcedureAddress");
		if (m_LdrGetProcedureAddress == 0)
		{
			return 0;
		}
	}

	/*
		Arguments addresses must have a proper alignment, so
		we allocating them at separate memory page instead of the stack.
	*/
	PGET_PROC_ADDRESS_PARAMS Params = (PGET_PROC_ADDRESS_PARAMS)VirtualAlloc(
		NULL, sizeof(GET_PROC_ADDRESS_PARAMS),
		MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE
	);
	if (Params == NULL)
	{
		return 0;
	}

	// setup ntdll!LdrGetProcedureAddress() arguments
	strcpy_s(Params->Name, sizeof(Params->Name), ProcedureName);

	Params->FunctionName.Buffer = (PTR64)& Params->Name;
	Params->FunctionName.MaximumLength =
		Params->FunctionName.Length = (USHORT)strlen(Params->Name);

	Params->FunctionAddress = 0;

	DWORD64 Args[] =
	{
		ModuleBase,
		(DWORD64)& Params->FunctionName, 0,
		(DWORD64)& Params->FunctionAddress
	};

	// perform x64 function call
	DWORD64 Status = x64_Call(m_LdrGetProcedureAddress, Args, 4);
	DWORD64 Retval = Params->FunctionAddress;

	VirtualFree(Params, 0, MEM_RELEASE);

	if (NT_SUCCESS(Status))
	{
		return Retval;
	}

	return 0;
}

DWORD64
x64_GetSyscallAddress(
	PCSTR SyscallName
	)
{
	return x64_GetProcAddress(x64_GetModuleBase("ntdll.dll"), SyscallName);
}

NTSTATUS
x64_InvokeSyscall(
	DWORD64 SyscallAddress,
	PVOID Args,
	DWORD ArgsSize
	)
{
	PVOID AlignedParameters;

	if (!SyscallAddress) {
		return STATUS_INVALID_PARAMETER;
	}

	AlignedParameters = VirtualAlloc(
					NULL, 
					ArgsSize,
					MEM_COMMIT | MEM_RESERVE,
					PAGE_READWRITE
				);

	if (!AlignedParameters) {
		return STATUS_NO_MEMORY;
	}

	RtlCopyMemory(AlignedParameters, Args, ArgsSize);

	DWORD Ret = x64_Call(SyscallAddress, (PDWORD64)AlignedParameters, ArgsSize / sizeof(DWORD64));

	VirtualFree(AlignedParameters, 0, MEM_RELEASE);

	return (NTSTATUS)Ret;
}



DWORD64
x64_GetNtdllProcedure(
	PCSTR ProcedureName
	)
{
	return x64_GetProcAddress(x64_GetModuleBase("ntdll.dll"), ProcedureName);
}

//
// Read the comment at the top.
//
#pragma warning(pop)
```

`Wow64To64bitInjector/x64Call.h`:

```h
#pragma once
#include <Windows.h>


ULONG
x64_Call(
	DWORD64 ProcAddress,
	PDWORD64 Args, 
	DWORD ArgsCount
	);

DWORD64
x64_GetSyscallAddress(
	PCSTR SyscallName
	);

NTSTATUS
x64_InvokeSyscall(
	DWORD64 SyscallAddress,
	PVOID Args,
	DWORD ArgsSize
	);

DWORD64 
x64_GetModuleBase(
	PCSTR ModuleName
	);

DWORD64
x64_GetNtdllProcedure(
	PCSTR ProcedureName
	);

```

`x64ToWow64ApcInjector/x64ToWow64ApcInjector.c`:

```c
#include <ApcLib/ApcLib.h>
#include <stdio.h>
#include <winternl.h>

typedef struct _X64_TO_WOW64_CMD_ARGS {
	PCSTR DllPath;
	ULONG TargetProcessId;
	ULONG TargetThreadId;
} X64_TO_WOW64_CMD_ARGS, *PX64_TO_WOW64_CMD_ARGS;

X64_TO_WOW64_CMD_ARGS 
ParseArguments(
	int argc,
	const char** argv
	)
{
	X64_TO_WOW64_CMD_ARGS Args;
	RtlZeroMemory(&Args, sizeof(Args));

	if (argc < 3) {
		printf("Missing arguments.\n");
		printf("x64ToWow64ApcInjector.exe <dll_path> <process_id> <thread_id>\n");
		exit(-1);
	}

	Args.DllPath = argv[1];
	Args.TargetProcessId = atoi(argv[2]);

	if (argc >= 4) {
		Args.TargetThreadId = atoi(argv[3]);
	}

	return Args;
}

int main(
	int argc,
	const char** argv
	)
{
	NTSTATUS Status;
	HANDLE ProcessHandle;
	HANDLE ThreadHandle;
	BOOL IsWow64;
	PVOID RemoteLibraryPath;
	PVOID LoadLibraryAWowAddress;
	
	InitializeApcLib();

	X64_TO_WOW64_CMD_ARGS Args = ParseArguments(argc, argv);

	OpenTargetHandles(
		Args.TargetProcessId,
		Args.TargetThreadId,
		&ProcessHandle,
		&ThreadHandle
	);

	if (!IsWow64Process(ProcessHandle, &IsWow64)) {
		printf("IsWow64Process Failed. 0x%08X\n", GetLastError());
		exit(-1);
	}

	if (!IsWow64) {
		printf("Target process is not a wow64 process.\n");
		exit(-1);
	}


	//
	// Ok now we have 2 choices:
	//
	// - If the DLL is a 32 bit DLL, we need to create a Wow64 APC
	// - If the DLL is a 64 bit DLL, we need to create a normal APC to ntdll,
	//   because the 64 bit kernel32 is not loaded.
	//

	if (Is32bitDll(Args.DllPath)) {
		//
		// The DLL we want to load is a 32 bit DLL.
		// First, we need to write the path of the library to the remote process.
		//
		RemoteLibraryPath = WriteLibraryNameToRemote(ProcessHandle, Args.DllPath);

		//
		// To load this library, we can use the 32 bit LoadLibraryA routine inside kernel32.
		// To find the address of this routine, we can do the following:
		//	- Parse the kernel32.dll DLL from disk and find the offset of LoadLibraryA from the ImageBase.
		//	- Find the base of this DLL using EnumProcessModules and add the offset.
		//
		LoadLibraryAWowAddress = QueryWow64LoadLibraryAddress(ProcessHandle);
		
		//
		// Because the APC needs to run in a Wow64 environment, we need to encode the routine.
		//
		PPS_APC_ROUTINE ApcRoutine = (PPS_APC_ROUTINE)EncodeWow64ApcRoutine((ULONG64)LoadLibraryAWowAddress);

		//
		// Use NtQueueApcThread to queue the APC.
		//
		Status = NtQueueApcThread(
			ThreadHandle,
			ApcRoutine,
			RemoteLibraryPath,
			NULL,
			NULL
		);

		/*
		ntdll has a routine called "RtlQueueApcWow64Thread" which can be used to perform the encoding.

		Status = RtlQueueApcWow64Thread(
					ThreadHandle,
					LoadLibraryAWowAddress,
					RemoteLibraryPath,
					NULL,
					NULL
				);
		*/
	}
	else {
		//
		// The DLL is a 64 bit DLL and we want to load it to a 32 bit process.
		// We can use ntdll!LdrLoadDll to do it.
		//
		RemoteLibraryPath = WriteUnicodeLibraryNameToRemote(ProcessHandle, Args.DllPath);

		Status = NtQueueApcThread(
			ThreadHandle,
			(PPS_APC_ROUTINE)LdrLoadDllPtr,
			NULL,
			0,
			RemoteLibraryPath
		);
	}

	if (!NT_SUCCESS(Status)){
		printf("NtQueueApcThread Failed. 0x%08X\n", GetLastError());
		exit(-1);
	}
}
```

`x64ToWow64ApcInjector/x64ToWow64ApcInjector.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <ProjectGuid>{01CBB56D-9103-48DD-A82A-7AB3F60A8D78}</ProjectGuid>
    <RootNamespace>x64ToWow64ApcInjector</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <AdditionalIncludeDirectories>$(SolutionDir)</AdditionalIncludeDirectories>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <AdditionalIncludeDirectories>$(SolutionDir)</AdditionalIncludeDirectories>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <AdditionalIncludeDirectories>$(SolutionDir)</AdditionalIncludeDirectories>
      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <AdditionalIncludeDirectories>$(SolutionDir)</AdditionalIncludeDirectories>
      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="x64ToWow64ApcInjector.c" />
  </ItemGroup>
  <ItemGroup>
    <ProjectReference Include="..\ApcLib\ApcLib.vcxproj">
      <Project>{a2e5d416-54aa-47a7-afbd-247a56e28679}</Project>
    </ProjectReference>
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`x64ToWow64ApcInjector/x64ToWow64ApcInjector.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="x64ToWow64ApcInjector.c">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```