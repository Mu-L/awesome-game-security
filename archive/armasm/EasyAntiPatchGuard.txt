Project Path: arc_armasm_EasyAntiPatchGuard_90fczhj9

Source Tree:

```txt
arc_armasm_EasyAntiPatchGuard_90fczhj9
├── EasyAntiPatchGuard
│   ├── DriverEntry.cpp
│   ├── EasyAntiPatchGuard.vcxproj
│   ├── EasyAntiPatchGuard.vcxproj.filters
│   └── GetKernelBase.asm
├── EasyAntiPatchGuard.sln
├── EasyAntiPatchGuard.sys
└── README.md

```

`EasyAntiPatchGuard.sln`:

```sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 16
VisualStudioVersion = 16.0.30225.117
MinimumVisualStudioVersion = 10.0.40219.1
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "EasyAntiPatchGuard", "EasyAntiPatchGuard\EasyAntiPatchGuard.vcxproj", "{411CB14A-126A-447B-AE93-1DAFFDF60853}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|ARM = Debug|ARM
		Debug|ARM64 = Debug|ARM64
		Debug|x64 = Debug|x64
		Debug|x86 = Debug|x86
		Release|ARM = Release|ARM
		Release|ARM64 = Release|ARM64
		Release|x64 = Release|x64
		Release|x86 = Release|x86
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Debug|ARM.ActiveCfg = Debug|ARM
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Debug|ARM.Build.0 = Debug|ARM
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Debug|ARM.Deploy.0 = Debug|ARM
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Debug|ARM64.ActiveCfg = Debug|ARM64
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Debug|ARM64.Build.0 = Debug|ARM64
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Debug|ARM64.Deploy.0 = Debug|ARM64
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Debug|x64.ActiveCfg = Debug|x64
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Debug|x64.Build.0 = Debug|x64
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Debug|x64.Deploy.0 = Debug|x64
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Debug|x86.ActiveCfg = Debug|Win32
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Debug|x86.Build.0 = Debug|Win32
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Debug|x86.Deploy.0 = Debug|Win32
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Release|ARM.ActiveCfg = Release|ARM
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Release|ARM.Build.0 = Release|ARM
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Release|ARM.Deploy.0 = Release|ARM
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Release|ARM64.ActiveCfg = Release|ARM64
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Release|ARM64.Build.0 = Release|ARM64
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Release|ARM64.Deploy.0 = Release|ARM64
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Release|x64.ActiveCfg = Release|x64
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Release|x64.Build.0 = Release|x64
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Release|x64.Deploy.0 = Release|x64
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Release|x86.ActiveCfg = Release|Win32
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Release|x86.Build.0 = Release|Win32
		{411CB14A-126A-447B-AE93-1DAFFDF60853}.Release|x86.Deploy.0 = Release|Win32
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {4359229B-1071-41EA-B9B6-47F54A49C3E9}
	EndGlobalSection
EndGlobal

```

`EasyAntiPatchGuard/DriverEntry.cpp`:

```cpp
#include <ntifs.h>
#include <ntimage.h>
#include <intrin.h>
#define uint64_t unsigned long long
#define uint32_t unsigned long
#define uint16_t unsigned short


extern "C" uintptr_t GetKernelBase();

typedef struct _RUNTIME_FUNCTION
{
	ULONG BeginAddress;
	ULONG EndAddress;
	ULONG UnwindData;
} RUNTIME_FUNCTION, *PRUNTIME_FUNCTION;

extern "C"
PRUNTIME_FUNCTION
RtlLookupFunctionEntry(
	IN ULONG64 ControlPc,
	OUT PULONG64 ImageBase,
	IN OUT PVOID HistoryTable OPTIONAL
);


bool easy_anti_patchguard(uintptr_t search_base) {
	const auto dos_header = reinterpret_cast<PIMAGE_DOS_HEADER>(search_base);
	const auto pNtHeader = reinterpret_cast<PIMAGE_NT_HEADERS>(reinterpret_cast<PUCHAR>(search_base) + dos_header->
		e_lfanew);
	const auto section_size = pNtHeader->FileHeader.NumberOfSections;
	const auto sections_array = reinterpret_cast<PIMAGE_SECTION_HEADER>(reinterpret_cast<PUCHAR>(pNtHeader) + sizeof(
		IMAGE_NT_HEADERS));

	uint32_t KiTimerDispatch[3]{0};

	for (auto i = 0; i < section_size; i++) {
		//INITKDBG
		if (*reinterpret_cast<uint64_t*>(sections_array[i].Name) == 0x4742444B54494E49) {
			const auto scan_base = (PUCHAR)(search_base) + sections_array[i].VirtualAddress;
			const auto scan_size = max(sections_array[i].SizeOfRawData, sections_array[i].Misc.VirtualSize);
			for (int i = 0; i < scan_size - 2; i++) {
				const auto start_address = (ULONG64)scan_base + i;
				if (*(uint16_t*)start_address == 0x9C48) {
					//pushfq
					ULONG64 image_base = 0;
					if (const auto runtime_table = RtlLookupFunctionEntry(start_address, &image_base, 0)) {
						const auto va = image_base + runtime_table->BeginAddress;
						if (start_address - va <= 0x20) {

							KiTimerDispatch[0] = *(uint32_t*)(va);
							KiTimerDispatch[1] = *(uint32_t*)(va + sizeof(uint32_t));
							KiTimerDispatch[2] = *(uint32_t*)(va + sizeof(uint32_t) * 2);
							DbgPrint("KiTimerDispatch :%p \n", va);
							break;
						}
					}
				}

			}
			break;
		}
	}

	if (KiTimerDispatch[0] == 0) {
		return false;
	}

	for (auto i = 0; i < section_size; i++) {
		//.text
		if (*reinterpret_cast<uint32_t*>(sections_array[i].Name) == 0x7865742E) {
			const auto scan_base = (PUCHAR)(search_base) + sections_array[i].VirtualAddress;
			const auto scan_size = max(sections_array[i].SizeOfRawData, sections_array[i].Misc.VirtualSize);
			for (int i = 0; i < scan_size - 10; i++) {
				const auto p1 = *reinterpret_cast<uint32_t*>(scan_base + i) & 0x00ffffff;
				const auto p2 = *reinterpret_cast<uint32_t*>(scan_base + i + 6) & 0xffffff00;
				if (p1 == 0x1D8B4C && p2 == 0xC0854800) {
					const auto _guard_icall_handler = scan_base + i;
					DbgPrint("_guard_icall_handler:%p\n", _guard_icall_handler);

					/*
					cmp     dword ptr ds:[rax], 0x1131482E   //     xor     qword ptr cs:[rcx],rdx
					je      ret
					cmp     dword ptr ds:[rax], 0x48513148   //     KiDpcDispatch
					je      ret
					cmp     dword ptr ds:[rax], 0x11111111   //		KiTimerDispatch[0]
					jne     ok
					cmp     qword ptr ds:[rax+0x4], 0x22222222  //	KiTimerDispatch[1]
					jne     ok
					cmp     qword ptr ds:[rax+0x8], 0x33333333  //	KiTimerDispatch[2]
					jne     ok
					ret
					jmp     rax
					 */

					unsigned char patch_code[] = {
						0x81, 0x38, 0x2E, 0x48, 0x31, 0x11, 0x74, 0x22, 0x81, 0x38, 0x48, 0x31, 0x51, 0x48, 0x74, 0x1A,
						0x81, 0x38, 0x11, 0x11, 0x11, 0x11, 0x75, 0x13, 0x81, 0x78, 0x04, 0x22, 0x22, 0x22, 0x22, 0x75,
						0x0A, 0x81, 0x78, 0x08, 0x22, 0x22, 0x22, 0x22, 0x75, 0x01, 0xC3, 0xFF, 0xE0
					};
					*(uint32_t*)(&patch_code[0x12]) = KiTimerDispatch[0];
					*(uint32_t*)(&patch_code[0x1B]) = KiTimerDispatch[1];
					*(uint32_t*)(&patch_code[0x24]) = KiTimerDispatch[2];
					const auto irql = __readcr8();
					KeRaiseIrqlToDpcLevel();
					__writecr0(__readcr0() & 0xfffffffffffeffff);

					memcpy(_guard_icall_handler, patch_code, sizeof(patch_code));

					__writecr0(__readcr0() | 0x10000);
					__writecr8(irql);
					break;
				}
			}
			break;
		}
	}
	return true;
}

EXTERN_C
NTSTATUS DriverEntry(
	IN PDRIVER_OBJECT DriverObject,
	IN PUNICODE_STRING RegistryPath
) {
	easy_anti_patchguard(GetKernelBase());
	return STATUS_UNSUCCESSFUL;
}

```

`EasyAntiPatchGuard/EasyAntiPatchGuard.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|ARM">
      <Configuration>Debug</Configuration>
      <Platform>ARM</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|ARM">
      <Configuration>Release</Configuration>
      <Platform>ARM</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|ARM64">
      <Configuration>Debug</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|ARM64">
      <Configuration>Release</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <ProjectGuid>{411CB14A-126A-447B-AE93-1DAFFDF60853}</ProjectGuid>
    <TemplateGuid>{1bc93793-694f-48fe-9372-81e2b05556fd}</TemplateGuid>
    <TargetFrameworkVersion>v4.5</TargetFrameworkVersion>
    <MinimumVisualStudioVersion>12.0</MinimumVisualStudioVersion>
    <Configuration>Debug</Configuration>
    <Platform Condition="'$(Platform)' == ''">Win32</Platform>
    <RootNamespace>EasyAntiPatchGuard</RootNamespace>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
    <Driver_SpectreMitigation>false</Driver_SpectreMitigation>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="PropertySheets">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <ControlFlowGuard>false</ControlFlowGuard>
      <WarningLevel>Level3</WarningLevel>
      <TreatWarningAsError>false</TreatWarningAsError>
    </ClCompile>
    <Link>
      <EntryPointSymbol>DriverEntry</EntryPointSymbol>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <FilesToPackage Include="$(TargetPath)" />
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="DriverEntry.cpp" />
  </ItemGroup>
  <ItemGroup>
    <MASM Include="GetKernelBase.asm" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`EasyAntiPatchGuard/EasyAntiPatchGuard.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hpp;hxx;hm;inl;inc;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
    <Filter Include="Driver Files">
      <UniqueIdentifier>{8E41214B-6785-4CFE-B992-037D68949A14}</UniqueIdentifier>
      <Extensions>inf;inv;inx;mof;mc;</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="DriverEntry.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
  <ItemGroup>
    <MASM Include="GetKernelBase.asm">
      <Filter>Source Files</Filter>
    </MASM>
  </ItemGroup>
</Project>
```

`EasyAntiPatchGuard/GetKernelBase.asm`:

```asm
.CODE
PUBLIC GetKernelBase
GetKernelBase PROC
mov     rax, qword ptr gs:[18h]
mov     rcx, [rax+38h]
mov     rax, 0FFFFFFFFFFFFF000h
and     rax, [rcx+4h]
jmp      while_start
search_mem_start:
add     rax, 0FFFFFFFFFFFFF000h
while_start: 
xor     ecx, ecx
jmp      search_mem_check
search_mem_next: 
add     rcx, 1
cmp     rcx, 0FF9h
jz       search_mem_start
search_mem_check:  
cmp     byte ptr[rax+rcx], 48h
jnz     search_mem_next
cmp     byte ptr[rax+rcx+1], 8Dh
jnz     search_mem_next
cmp     byte ptr[rax+rcx+2], 1Dh
jnz     search_mem_next
cmp     byte ptr[rax+rcx+6], 0FFh
jnz     search_mem_next
mov     r8d,[rax+rcx+3]
lea     edx,[rcx+r8]
add     edx, eax
add     edx, 7
test    edx, 0FFFh
jnz      search_mem_next
mov     rdx, 0FFFFFFFF00000000h
and     rdx, rax
add     r8d, eax
lea     eax,[rcx+r8]
add     eax, 7
or      rax, rdx
ret     
GetKernelBase ENDP
END
```

`README.md`:

```md
# EasyAntiPatchGuard

------


##Support System

> *  >= Win8   (Win8 - Win10 21H4)


## How to use

#### 1.Build EasyAntiPatchGuard.sln
#### 2.Load EasyAntiPatchGuard.sys

## Detail
as we know, patchguard execution chain:

On pgentry -> 
CmpAppendDllSection(decrypt context)-> 
ExQueueWorkItem -> 
FsRtlMdlReadCompleteDevEx -> 
MmAllocateIndependentPages/ExAllocatePoolWithTag ->
re encrypt context -> 
Insert New context ->
FreePool/Page current context.

some pgentry(apc,dpc,..):
```c++
00 fffffd0c`0d40d868 fffff802`0a52410d     0xffffc405`84a020d8
01 fffffd0c`0d40d870 fffff802`0a467de5     nt!KiDispatchCallout+0x1cd
02 fffffd0c`0d40d8e0 fffff802`0a465b77     nt!KiDeliverApc+0x2b5
03 fffffd0c`0d40d990 fffff802`0a464d7f     nt!KiSwapThread+0x827
04 fffffd0c`0d40da40 fffff802`0a464623     nt!KiCommitThreadWait+0x14f
05 fffffd0c`0d40dae0 fffff802`0a5c7b12     nt!KeWaitForSingleObject+0x233
06 fffffd0c`0d40dbd0 fffff802`0a517e25     nt!PopIrpWorkerControl+0x22
07 fffffd0c`0d40dc10 fffff802`0a5fd0d8     nt!PspSystemThreadStartup+0x55
08 fffffd0c`0d40dc60 00000000`00000000     nt!KiStartSystemThread+0x28

06 ffffc381`53d460f0 fffff803`137cc052     nt!ExpTimerDpcRoutine$filt$1+0x493
07 ffffc381`53d46130 fffff803`137fe942     nt!_C_specific_handler+0xa2
08 ffffc381`53d461a0 fffff803`1372bf97     nt!RtlpExecuteHandlerForException+0x12
09 ffffc381`53d461d0 fffff803`1372ab86     nt!RtlDispatchException+0x297
0a ffffc381`53d468f0 fffff803`137f6912     nt!KiDispatchException+0x186
0b ffffc381`53d46fb0 fffff803`137f68e0     nt!KxExceptionDispatchOnExceptionStack+0x12
0c ffffd88a`c62452c8 fffff803`13807ba5     nt!KiExceptionDispatchOnExceptionStackContinue
0d ffffd88a`c62452d0 fffff803`138038e0     nt!KiExceptionDispatch+0x125
0e ffffd88a`c62454b0 fffff803`1380014d     nt!KiGeneralProtectionFault+0x320
0f ffffd88a`c6245640 fffff803`13800182     nt!KiCustomRecurseRoutine0+0xd
10 ffffd88a`c6245670 fffff803`13873ce9     nt!KiCustomAccessRoutine0+0x22
11 ffffd88a`c62456a0 fffff803`1360781e     nt!ExpTimerDpcRoutine+0x155d29
12 ffffd88a`c6245860 fffff803`13606b04     nt!KiExecuteAllDpcs+0x30e
13 ffffd88a`c62459d0 fffff803`137f95ee     nt!KiRetireDpcList+0x1f4
14 ffffd88a`c6245c60 00000000`00000000     nt!KiIdleLoop+0x9e


0d fffff802`29b82b80 fffff802`247cc154     nt!CmpEnableLazyFlushDpcRoutine$fin$1+0x16a
0e fffff802`29b82be0 fffff802`247fe9c2     nt!_C_specific_handler+0x1a4
0f fffff802`29b82c50 fffff802`2472c484     nt!RtlpExecuteHandlerForUnwind+0x12
10 fffff802`29b82c80 fffff802`24720574     nt!RtlUnwindEx+0x2c4
11 fffff802`29b833a0 fffff802`247cd6d3     nt!RtlUnwind+0xa4
12 fffff802`29b83900 fffff802`24810701     nt!local_unwind+0x23
13 fffff802`29b83930 fffff802`247cc154     nt!CmpEnableLazyFlushDpcRoutine$fin$0+0x34
14 fffff802`29b83970 fffff802`247fe9c2     nt!_C_specific_handler+0x1a4
15 fffff802`29b839e0 fffff802`2472c484     nt!RtlpExecuteHandlerForUnwind+0x12
16 fffff802`29b83a10 fffff802`247cc095     nt!RtlUnwindEx+0x2c4
17 fffff802`29b84130 fffff802`247fe942     nt!_C_specific_handler+0xe5
18 fffff802`29b841a0 fffff802`2472bf97     nt!RtlpExecuteHandlerForException+0x12
19 fffff802`29b841d0 fffff802`2472ab86     nt!RtlDispatchException+0x297
1a fffff802`29b848f0 fffff802`247f6912     nt!KiDispatchException+0x186
1b fffff802`29b84fb0 fffff802`247f68e0     nt!KxExceptionDispatchOnExceptionStack+0x12
1c fffff802`29b6f348 fffff802`24807ba5     nt!KiExceptionDispatchOnExceptionStackContinue
1d fffff802`29b6f350 fffff802`248038e0     nt!KiExceptionDispatch+0x125
1e fffff802`29b6f530 fffff802`247fff0d     nt!KiGeneralProtectionFault+0x320
1f fffff802`29b6f6c0 fffff802`247ffd8d     nt!KiCustomRecurseRoutine7+0xd
20 fffff802`29b6f6f0 fffff802`247ffa8d     nt!KiCustomRecurseRoutine6+0xd
21 fffff802`29b6f720 fffff802`247ffb4d     nt!KiCustomRecurseRoutine5+0xd
22 fffff802`29b6f750 fffff802`247ffb82     nt!KiCustomRecurseRoutine4+0xd
23 fffff802`29b6f780 fffff802`24723877     nt!KiCustomAccessRoutine4+0x22
24 fffff802`29b6f7b0 fffff802`24644f12     nt!CmpEnableLazyFlushDpcRoutine+0x97
25 fffff802`29b6f8e0 fffff802`24606eed     nt!KiProcessExpiredTimerList+0x172
26 fffff802`29b6f9d0 fffff802`247f95ee     nt!KiRetireDpcList+0x5dd
27 fffff802`29b6fc60 00000000`00000000     nt!KiIdleLoop+0x9e
```

execute pgentry:
```c++
 {
  v32 = *(_QWORD *)pg_entry ^ 0x85131481131482Ei64;
  *(_DWORD *)pg_entry = 0xAD1B6FF5;
  *(_DWORD *)pg_entry ^= 0xBC2A27DB;  //decrypt to xor     qword ptr cs:[rcx],rdx
  ((void (__fastcall *)(unsigned __int64, __int64, _QWORD, _QWORD))pg_entry)(pg_entry, v32, 0i64, 0i64);
 }
```
asm:
```asm
.text:00000001403240F9   mov     rdx, [rbp+arg_0]
.text:00000001403240FD   xor     eax, 0BC2A27DBh
.text:0000000140324102   mov     [r10], eax
.text:0000000140324105   mov     rax, r10
.text:0000000140324108   call    _guard_dispatch_icall
```
  
CmpAppendDllSection and FsRtlMdlReadCompleteDevEx executes very fast. Most of the time is the encrypted context state. so we hook _guard_dispatch_icall and check target is 
2e483111        xor     qword ptr cs:[rcx],rdx
```asm
cmp     dword ptr ds:[rax], 0x1131482E 
je      ret:
jmp     rax
ret
```

## Result
```asm
0: kd> u guard_dispatch_icall
nt!guard_dispatch_icall:
fffff803`3c7fe620 81382e483111    cmp     dword ptr [rax],1131482Eh
fffff803`3c7fe626 7402            je      nt!guard_dispatch_icall+0xa (fffff803`3c7fe62a)
fffff803`3c7fe628 ffe0            jmp     rax
fffff803`3c7fe62a c3              ret
fffff803`3c7fe62b 8d7a00          lea     edi,[rdx]
fffff803`3c7fe62e 0000            add     byte ptr [rax],al
fffff803`3c7fe630 4d85db          test    r11,r11
fffff803`3c7fe633 741c            je      nt!guard_dispatch_icall+0x31 (fffff803`3c7fe651)
0: kd> bp fffff803`3c7fe62a
0: kd> g
nt!DbgBreakPointWithStatus:
fffff803`3c7fd920 cc              int     3
0: kd> g
Breakpoint 2 hit
nt!guard_dispatch_icall+0xa:
fffff803`3c7fe62a c3              ret
0: kd> kn
 # Child-SP          RetAddr               Call Site
00 fffff803`42b838a8 fffff803`3c810bcf     nt!guard_dispatch_icall+0xa
01 fffff803`42b838b0 fffff803`3c7cc154     nt!IopIrpStackProfilerDpcRoutine$fin$1+0x153
02 fffff803`42b83910 fffff803`3c7f16f2     nt!_C_specific_handler+0x1a4
03 fffff803`42b83980 fffff803`3c7fe9c2     nt!_GSHandlerCheck_SEH+0x6a
04 fffff803`42b839b0 fffff803`3c72c484     nt!RtlpExecuteHandlerForUnwind+0x12
05 fffff803`42b839e0 fffff803`3c7cc095     nt!RtlUnwindEx+0x2c4
06 fffff803`42b84100 fffff803`3c7f16f2     nt!_C_specific_handler+0xe5
07 fffff803`42b84170 fffff803`3c7fe942     nt!_GSHandlerCheck_SEH+0x6a
08 fffff803`42b841a0 fffff803`3c72bf97     nt!RtlpExecuteHandlerForException+0x12
09 fffff803`42b841d0 fffff803`3c72ab86     nt!RtlDispatchException+0x297
0a fffff803`42b848f0 fffff803`3c7f6912     nt!KiDispatchException+0x186
0b fffff803`42b84fb0 fffff803`3c7f68e0     nt!KxExceptionDispatchOnExceptionStack+0x12
0c fffff803`42b6f1c8 fffff803`3c807ba5     nt!KiExceptionDispatchOnExceptionStackContinue
0d fffff803`42b6f1d0 fffff803`3c8038e0     nt!KiExceptionDispatch+0x125
0e fffff803`42b6f3b0 fffff803`3c7ffa8d     nt!KiGeneralProtectionFault+0x320
0f fffff803`42b6f540 fffff803`3c7ffb4d     nt!KiCustomRecurseRoutine5+0xd
10 fffff803`42b6f570 fffff803`3c7ffe4d     nt!KiCustomRecurseRoutine4+0xd
11 fffff803`42b6f5a0 fffff803`3c7ffccd     nt!KiCustomRecurseRoutine3+0xd
12 fffff803`42b6f5d0 fffff803`3c7ffd02     nt!KiCustomRecurseRoutine2+0xd
13 fffff803`42b6f600 fffff803`3c723b1a     nt!KiCustomAccessRoutine2+0x22
14 fffff803`42b6f630 fffff803`3c60781e     nt!IopIrpStackProfilerDpcRoutine+0x23a
15 fffff803`42b6f860 fffff803`3c606b04     nt!KiExecuteAllDpcs+0x30e
16 fffff803`42b6f9d0 fffff803`3c7f95ee     nt!KiRetireDpcList+0x1f4
17 fffff803`42b6fc60 00000000`00000000     nt!KiIdleLoop+0x9e
0: kd> g
Breakpoint 2 hit
nt!guard_dispatch_icall+0xa:
fffff803`3c7fe62a c3              ret
0: kd> kn
 # Child-SP          RetAddr               Call Site
00 fffff803`42b840e8 fffff803`3c80fa6f     nt!guard_dispatch_icall+0xa
01 fffff803`42b840f0 fffff803`3c7cc052     nt!CmpLazyFlushDpcRoutine$filt$1+0x517
02 fffff803`42b84130 fffff803`3c7fe942     nt!_C_specific_handler+0xa2
03 fffff803`42b841a0 fffff803`3c72bf97     nt!RtlpExecuteHandlerForException+0x12
04 fffff803`42b841d0 fffff803`3c72ab86     nt!RtlDispatchException+0x297
05 fffff803`42b848f0 fffff803`3c7f6912     nt!KiDispatchException+0x186
06 fffff803`42b84fb0 fffff803`3c7f68e0     nt!KxExceptionDispatchOnExceptionStack+0x12
07 fffff803`42b6f368 fffff803`3c807ba5     nt!KiExceptionDispatchOnExceptionStackContinue
08 fffff803`42b6f370 fffff803`3c8038e0     nt!KiExceptionDispatch+0x125
09 fffff803`42b6f550 fffff803`3c7ffa8d     nt!KiGeneralProtectionFault+0x320
0a fffff803`42b6f6e0 fffff803`3c7ffac2     nt!KiCustomRecurseRoutine5+0xd
0b fffff803`42b6f710 fffff803`3c8729fb     nt!KiCustomAccessRoutine5+0x22
0c fffff803`42b6f740 fffff803`3c644f12     nt!CmpLazyFlushDpcRoutine+0x1574ab
0d fffff803`42b6f8e0 fffff803`3c6072e9     nt!KiProcessExpiredTimerList+0x172
0e fffff803`42b6f9d0 fffff803`3c7f95ee     nt!KiRetireDpcList+0x9d9
0f fffff803`42b6fc60 00000000`00000000     nt!KiIdleLoop+0x9e
```
## Todo

- [ ] Wait in a loop until there is no pg workitem running
```c++
for(;;){
    if(find_decrypt_context() == 0)
       break;
    KeSleep(100);
}
```
- [x] fix KiTimerDispatch entry check
- [x] fix KiDpcDispatch entry check

```