Project Path: arc_Saukiya_Arknights_4t_n4h7f

Source Tree:

```txt
arc_Saukiya_Arknights_4t_n4h7f
├── Data
│   ├── Attribute.cs
│   ├── Char
│   │   ├── CharData.cs
│   │   ├── CharEnum.cs
│   │   ├── CharManager.cs
│   │   └── CharMeta.cs
│   ├── Dungeon
│   │   ├── DungeonManager.cs
│   │   └── DungeonMeta.cs
│   ├── Item
│   │   ├── ItemIconComponent.cs
│   │   ├── ItemManager.cs
│   │   ├── ItemMeta.cs
│   │   ├── ItemStack.cs
│   │   └── ItemType.cs
│   ├── Monster
│   │   ├── MonsterData.cs
│   │   └── MonsterManager.cs
│   └── Player
│       ├── PlayerData.cs
│       ├── PlayerManager.cs
│       └── Squad.cs
├── Event
│   ├── Event.cs
│   ├── EventHandler.cs
│   ├── EventSystem.cs
│   └── Listener.cs
├── Game
│   ├── Contorller
│   │   ├── CharController.cs
│   │   └── Sub
│   │       └── AMIYA.cs
│   ├── Dungeon.cs
│   ├── Entity
│   │   ├── Char.cs
│   │   ├── Entity.cs
│   │   └── Monster.cs
│   ├── Event
│   │   ├── CreateEntityEvent.cs
│   │   ├── EntityEvent.cs
│   │   └── RemoveEntityEvent.cs
│   ├── GameManager.cs
│   ├── State.cs
│   └── TargetSelector.cs
├── GameStart.cs
├── LuaScripts
│   ├── Global
│   │   └── Global.lua.txt
│   └── UI
│       ├── CharUI.lua.txt
│       └── HomeUI.lua.txt
├── Manager
│   ├── ABManager.cs
│   ├── LuaEnvManager.cs
│   ├── ShopItemDataList.cs
│   ├── ShopManager.cs
│   └── SoundManager.cs
├── README.md
├── Settings
│   └── GameSettings.cs
├── UI
│   ├── RuaUI.cs
│   ├── Sub
│   │   ├── CharInfoUI.cs
│   │   ├── CharSelectUI.cs
│   │   ├── CommonDialogUI.cs
│   │   ├── GameLoseUI.cs
│   │   ├── GameUI.cs
│   │   ├── GameWinUI.cs
│   │   ├── HouseUI.cs
│   │   ├── ItemInfoUI.cs
│   │   ├── LoginUI.cs
│   │   ├── SelectDungeonUI.cs
│   │   ├── SettingUI.cs
│   │   ├── ShopUI.cs
│   │   └── SquadUI.cs
│   ├── UIBase.cs
│   └── UIManager.cs
└── Utils
    ├── Asset.cs
    ├── Delay.cs
    ├── Expand.cs
    ├── Injection.cs
    └── Single.cs

```

`Data/Attribute.cs`:

```cs
using System;
using UnityEngine;

namespace Data {

    [Serializable]
    public class Attribute {
        [SerializeField]
        protected float maxHealth;
        [SerializeField]
        protected float atk;
        // 防御力
        [SerializeField]
        protected float def;
        // 魔法抗性
        [SerializeField]
        protected float magicResistance;
        // 攻击速度
        [SerializeField]
        protected float atkSpeed;
        
        public float GetMaxHealth() => maxHealth;
        public float GetAtk() => atk;
        public float GetDef() => def;
        public float GetMagicResistance() => magicResistance;
        public float GetAtkSpeed() => atkSpeed;
        public void SetMaxHealth(float value) => maxHealth = value;
        public void SetAtk(float value) => atk = value;
        public void SetDef(float value) => def = value;
        public void SetMagicResistance(float value) => magicResistance = value;
        public void SetAtkSpeed(float value) => atkSpeed = value;
    }

    [Serializable]
    public class MonsterAttribute : Attribute {
        [SerializeField]
        private float moveSpeed;
        
        public float GetMoveSpeed() => moveSpeed;
        public void SetMoveSpeed(float value) => moveSpeed = value;
    }
    
    // 与怪物存在共用问题
    [Serializable]
    public class CharAttribute : Attribute {

        // 再部署时间
        [SerializeField]
        private int respawnTime;

        // 部署费用
        [SerializeField]
        private int cost;

        // 阻挡数
        [SerializeField]
        private int block;

        // 攻击间隔测试代码
        public static double AttackInterval(float atkSpeed) {
            return 1 / (Mathf.Clamp(atkSpeed,10,600) / 100);
        }

        public int GetRespawnTime() => respawnTime;
        public int GetCost() => cost;
        public int GetBlock() => block;
     
        public void SetRespawnTime(int value) => respawnTime = value;
        public void SetCost(int value) => cost = value;
        public void SetBlock(int value) => block = value;
        
        
        public static CharAttribute operator +(CharAttribute a, CharAttribute b) {
            return new CharAttribute {
                maxHealth = a.maxHealth + b.maxHealth,
                atk = a.atk + b.atk,
                def = a.def + b.def,
                magicResistance = a.magicResistance + b.magicResistance,
                respawnTime = a.respawnTime + b.respawnTime,
                cost = a.cost + b.cost,
                block = a.block + b.block,
                atkSpeed = a.atkSpeed + b.atkSpeed
            };
        }
        
        public static CharAttribute operator -(CharAttribute a, CharAttribute b) {
            return new CharAttribute {
                maxHealth = a.maxHealth - b.maxHealth,
                atk = a.atk - b.atk,
                def = a.def - b.def,
                magicResistance = a.magicResistance - b.magicResistance,
                respawnTime = a.respawnTime - b.respawnTime,
                cost = a.cost - b.cost,
                block = a.block - b.block,
                atkSpeed = a.atkSpeed - b.atkSpeed
            };
        }
        
        public static CharAttribute operator *(CharAttribute a, int amount) {
            return new CharAttribute {
                maxHealth = a.maxHealth * amount,
                atk = a.atk * amount,
                def = a.def * amount,
                magicResistance = a.magicResistance * amount,
                respawnTime = a.respawnTime * amount,
                cost = a.cost * amount,
                block = a.block * amount,
                atkSpeed = a.atkSpeed * amount
            };
        }
    }
}
```

`Data/Char/CharData.cs`:

```cs
using System;
using UnityEngine;

namespace Data.Char {
    // 角色数据
    [Serializable]
    public class CharData {
        
        // 角色ID
        [SerializeField]
        private string id;

        // 阶级(0-2)
        [SerializeField]
        private int elite;

        // 等级 (0 - getMaxLevel)
        [SerializeField]
        private int level;

        // 经验 
        [SerializeField]
        private int exp;

        // 信赖值
        [SerializeField]
        private int trust;
        
        // 元数据 (不存储）
        private CharMeta data;

        public CharData(string id) {
            this.id = id;
        }

        public string GetId() => id;
        public int GetElite() => elite;
        public int GetLevel() => level;
        public int GetExp() => exp;
        public int GetTrust() => trust;
        public CharMeta GetCharMeta() => data != null ? data : data = CharManager.Inst().GetMeta(id);

        public CharAttribute GetAttribute() {
            return GetCharMeta().GetLevelAttributes()[elite] * level + GetCharMeta().GetEliteAttributes()[elite];
        }

        // 最大精英等级
        public int GetMaxElite() {
            return CharMeta.GetMaxElite(data.GetRarity());
        }
        
        // 最大等级
        public int GetMaxLevel() {
            return CharMeta.GetMaxLevel(data.GetRarity(),elite);
        }
        
        // 获得最大经验值
        public int GetMaxExp() {
            return CharMeta.GetMaxExp(elite,level);
        }
    }
}
```

`Data/Char/CharEnum.cs`:

```cs
using System.ComponentModel;

namespace Data.Char {
    
    // 角色标签
    public enum CharTag {
        [Description("治疗")]
        ZHI_LIAO,
        [Description("支援")]
        ZHI_YUAN,
        [Description("输出")]
        SHU_CHU,
        [Description("群攻")]
        QUN_GONG,
        [Description("减速")]
        JIAN_SU,
        [Description("生存")]
        SHENG_CUN,
        [Description("防护")]
        FAGN_HU,
        [Description("削弱")]
        XUE_RUO,
        [Description("位移")]
        WEI_YI,
        [Description("控场")]
        KONG_CHANG,
        [Description("爆发")]
        BAO_FA,
        [Description("召唤")]
        ZHAO_HUAN,
        [Description("快速复活")]
        KUAI_SU_FU_HUO,
        [Description("费用回复")]
        FEI_YONG_HUI_FU,
        [Description("新手")]
        XIN_SHOU
    }
    
    // 角色职业
    public enum CharProfession {
        [Description("先锋")]
        XIAN_FENG,
        [Description("近卫")]
        JIN_WEI,
        [Description("狙击")]
        JU_JI,
        [Description("重装")]
        ZHONG_ZHUANG,
        [Description("医疗")]
        YI_LIAO,
        [Description("辅助")]
        FU_ZHU,
        [Description("术师")]
        SHU_SHI,
        [Description("特种")]
        TE_ZHONG
    }

    public enum CharPosition {
        [Description("近战位")]
        JIN_ZHAN,
        [Description("远程位")]
        YUAN_CHENG
    }

    public enum CharCamp {
        NULL,
        [Description("巴别塔")]
        BBT,
        [Description("黑钢")]
        HG,
        [Description("卡西米尔")]
        KXME,
        [Description("罗德岛")]
        LDD,
        [Description("龙门")]
        LM,
        [Description("雷姆必拓")]
        LMBT,
        [Description("拉特兰")]
        LTL,
        [Description("莱塔尼亚")]
        LTNY,
        [Description("莱茵生命")]
        LYSM,
        [Description("企鹅物流")]
        QEWL,
        [Description("深海猎人")]
        SHLR,
        [Description("维多利亚")]
        WDLY,
        [Description("乌萨斯")]
        WSS,
        [Description("谢拉格")]
        XLG,
        [Description("汐斯塔")]
        XST
    }
}
```

`Data/Char/CharManager.cs`:

```cs
using System.Collections.Generic;
using System.Text.RegularExpressions;
using Settings;
using Tools;
using UnityEngine;

namespace Data.Char {
    /**
     * 角色元数据控制器
     */
    public class CharManager : Single<CharManager> {
        // 元数据
        private Dictionary<string, CharMeta> metaDictionary = new Dictionary<string, CharMeta>();
        // 阵营
        private Dictionary<string, Sprite> campImage = new Dictionary<string,Sprite>();
        // 卡图
        private Dictionary<string, Sprite> cardGroundImage = new Dictionary<string,Sprite>();
        // 精英图
        private Dictionary<string, Sprite> eliteImage = new Dictionary<string,Sprite>();
        // 职业small图
        private Dictionary<string, Sprite> professionImage = new Dictionary<string,Sprite>();
        // 职业small图
        private Dictionary<string, Sprite> professionSmallImage = new Dictionary<string,Sprite>();
        // 职业small图
        private Dictionary<string, Sprite> starImage = new Dictionary<string,Sprite>();

        public CharManager() {
            foreach (Sprite sprite in Asset.LoadAll<Sprite>("Sprite/Char","Camp")) {
                campImage.Add(sprite.name, sprite);
            }
            foreach (Sprite sprite in Asset.LoadAll<Sprite>("Sprite/Char","CardGround")) {
                if (Regex.IsMatch(sprite.name, @"^\d_.+")) {
                    cardGroundImage.Add(sprite.name, sprite);
                }
            }
            foreach (Sprite sprite in Asset.LoadAll<Sprite>("Sprite/Char","Elite")) {
                eliteImage.Add(sprite.name, sprite);
            }
            foreach (Sprite sprite in Asset.LoadAll<Sprite>("Sprite/Char","Profession")) {
                professionImage.Add(sprite.name, sprite);
            }
            foreach (Sprite sprite in Asset.LoadAll<Sprite>("Sprite/Char","ProfessionSmall")) {
                professionSmallImage.Add(sprite.name, sprite);
            }
            foreach (Sprite sprite in Asset.LoadAll<Sprite>("Sprite/Char","Star")) {
                starImage.Add(sprite.name, sprite);
            }
        }

        // 获取对象
        public CharMeta GetMeta(string id) => metaDictionary.ContainsKey(id) ? metaDictionary[id] : LoadMeta(id);

        // 加载LoadMeta数据
        private CharMeta LoadMeta(string id) {
            CharMeta meta = Asset.Load<CharMeta>(GameSettings.CHAR_META_PATH, id);
            meta.SetId(id);
            metaDictionary.Add(id, meta);
            return meta;
        }
        
        public Sprite GetCampImage(string str) {
            return campImage[str];
        }
        
        public Sprite GetCardGroundImage(string str) {
            return cardGroundImage[str];
        }
        
        public Sprite GetCharEliteImage(string str) {
            return eliteImage[str];
        }
        
        public Sprite GetProfessionImage(CharProfession profession) {
            return professionImage[profession.ToString()];
        }
        
        public Sprite GetProfessionSmallImage(CharProfession profession) {
            return professionSmallImage[profession.ToString()];
        }
        
        public Sprite GetStarImage(string str) {
            return starImage[str];
        }
    }
}
```

`Data/Char/CharMeta.cs`:

```cs
using System;
using System.Collections.Generic;
using Spine;
using Spine.Unity;
using UnityEngine;
using UnityEngine.Serialization;

namespace Data.Char {
    // 角色元数据
    [Serializable]
    [CreateAssetMenu(fileName = "CharID", menuName = "ArkNight/CharMeta")]
    public class CharMeta : ScriptableObject {
        // 角色类型枚举
        private string id;

        [Header("中文名"),SerializeField]
        private string chineseName;

        [Header("英文名"),SerializeField]
        private string englishName;

        [Header("稀有度"),Range(1,6),SerializeField]
        private int rarity;

        [Header("职业"),SerializeField]
        private CharProfession profession;

        [Header("位置"),SerializeField]
        private CharPosition charPosition;
        
        [Header("阵营"),SerializeField]
        private CharCamp camp;

        [Header("标签"),SerializeField]
        private CharTag[] tags;

        [Header("精英属性[0/1/2]"),SerializeField]
        private CharAttribute[] eliteAttributes;

        [Header("等级属性[0/1/2]"),SerializeField]
        private CharAttribute[] levelAttributes;

        [Header("攻击范围"),SerializeField]
        private string[] atkRange;
        
        private List<Vector3> attackRange;

        [Header("天赋名"),SerializeField]
        private string[] talent;

        [Header("特性"),SerializeField]
        private string feature;

        [Header("立绘"),SerializeField]
        private Sprite image1;
        
        [Header("卡贴"),SerializeField]
        private Sprite image2;
        
        [Header("头像"),SerializeField]
        private Sprite image3;

        [Header("骨骼"), SerializeField]
        private SkeletonDataAsset skeleton;

        
        public string GetId() => id;
        public string GetChineseName() => chineseName;
        public string GetEnglishName() => englishName;
        public int GetRarity() => rarity;
        public CharProfession GetProfession() => profession;
        public CharPosition GetPosition() => charPosition;
        public CharCamp getCamp() => camp;
        public CharTag[] GetTags() => tags;
        public CharAttribute[] GetEliteAttributes() => eliteAttributes;
        public CharAttribute[] GetLevelAttributes() => levelAttributes;
        public List<Vector3> GetAttackRange() => attackRange;
        public string[] GetTalent() => talent;
        public string GetFeature() => feature;
        public Sprite GetImage() => image1;
        public Sprite GetCharImage() => image2;
        public Sprite GetAvatar() => image3;
        public SkeletonDataAsset GetSkeleton() => skeleton;
        
        internal string SetId(string value) => id = value;
        

        public void OnEnable() {
            //计算攻击范围
            //缺点：没有中心点 比如 oooo /n oxoo /n oooo x为中心点
            //优点：够用
            attackRange = new List<Vector3>();
            for (int x = 0; x < atkRange.Length; x++) {
                string str = atkRange[x];
                for (int z = 0; z < str.Length; z++) {
                    if (str[z] != 'o') continue;
                    attackRange.Add(new Vector3(x, 0, z));
                    if (x != 0) attackRange.Add(new Vector3(-x, 0, z));
                }
            }
        }

        /**
         * 获得最大精英值
         * rarity - 稀有度
         */
        public static int GetMaxElite(int rarity) {
            switch (rarity) {
                case 1:
                case 2:
                    return 0;
                case 3:
                    return 1;
                case 4:
                case 5:
                case 6:
                    return 2;
                default:
                    return -1;
            }
        }

        /**
         * 获得最大等级
         * rarity - 稀有度
         * elite - 当前精英阶级
         */
        public static int GetMaxLevel(int rarity,int elite) {
            switch (rarity) {
                case 1:
                case 2:
                    if (elite == 0) return 30;
                    break;
                case 3:
                    if (elite == 0) return 40;
                    if (elite == 1) return 55;
                    break;
                case 4:
                    return elite == 0 ? 45 : elite == 1 ? 60 : 70;
                case 5:
                    return elite == 0 ? 50 : elite == 1 ? 70 : 80;
                case 6:
                    return elite == 0 ? 50 : elite == 1 ? 80 : 90;
            }
            return -1;
        }

        /**
         * 获得最大经验值
         * elite - 当前精英阶级
         * level - 当前等级
         */
        public static int GetMaxExp(int elite,int level) {
            switch (elite) {
                case 0:
                    return 100 + level * 20;
                case 1:
                    return 120 + level * 60;
                case 2:
                    return 120 + level * 120;
            }
            return -1;
        }
    }
}
```

`Data/Dungeon/DungeonManager.cs`:

```cs
using System.Collections.Generic;
using Settings;
using Tools;

namespace Data.Dungeon {
    public class DungeonManager : Single<DungeonManager> {
        // 元数据
        private Dictionary<string, DungeonMeta> metaDictionary = new Dictionary<string, DungeonMeta>();
        
        // 获取元数据
        public DungeonMeta GetMeta(string id) => metaDictionary.ContainsKey(id) ? metaDictionary[id] : LoadMeta(id);
        
        // 加载LoadMeta数据
        private DungeonMeta LoadMeta(string id) {
            DungeonMeta meta = Asset.Load<DungeonMeta>(GameSettings.DUNGEON_META_PATH, id);
            meta.SetId(id);
            metaDictionary.Add(id, meta);
            return meta;
        }
    }
}
```

`Data/Dungeon/DungeonMeta.cs`:

```cs
using System;
using Data.Item;
using UnityEngine;
using UnityEngine.Serialization;

namespace Data.Dungeon {
    [Serializable]
    [CreateAssetMenu(fileName = "DungeonID", menuName = "ArkNight/DungeonMeta")]
    public class DungeonMeta : ScriptableObject {
        // 关卡ID
        private string id;
        

        [Header("关卡名"), SerializeField]
        private string name;

        [Header("预制体"), SerializeField]
        private GameObject dungeonPrefab;

        [Header("所需理智"), SerializeField]
        private int reason;

        [Header("道具奖励"), SerializeField]
        private ItemStack[] reward;

        [Header("关卡描述"), SerializeField]
        private string description;

        public string GetId() => id;
        public string GetName() => name;
        public GameObject GetDungeonPrefab() => dungeonPrefab;
        public int GetReason() => reason;
        public ItemStack[] GetReward() => reward;
        public string GetDescription() => description;
        
        internal string SetId(string value) => id = value;
    }
}
```

`Data/Item/ItemIconComponent.cs`:

```cs
using System;
using UnityEngine;
using UnityEngine.Events;
using UnityEngine.UI;

namespace Data.Item {
    public class ItemIconComponent : MonoBehaviour {

        public Image ground;
        public Image icon;
        public Text amount;
        
        private ItemMeta meta;

        public ItemMeta GetMeta() => meta;
        
        public void SetMeta(ItemMeta value) {
            meta = value;
            ground.sprite = ItemManager.Inst().GetItemGround(meta.GetRarity());
            icon.sprite = meta.GetIcon();
        }

        public void SetAmount(int value) {
            if (amount) {
                if (value >= 10000) {
                    amount.text = $"{value / 10000f:0.#}万";
                } else {
                    amount.text = $"{value}";
                }
                LayoutRebuilder.ForceRebuildLayoutImmediate(amount.transform.parent as RectTransform);
            }
        }

        public void AddListener(UnityAction method) {
            GetComponent<Button>().onClick.AddListener(method);
        }

        public void RemoveAllListeners() {
            GetComponent<Button>().onClick.RemoveAllListeners();
        }
    }
}
```

`Data/Item/ItemManager.cs`:

```cs
using System.Collections.Generic;
using Settings;
using Tools;
using UnityEngine;

namespace Data.Item {
    public class ItemManager : Single<ItemManager> {
        private Dictionary<int, ItemMeta> metaDictionary = new Dictionary<int,ItemMeta>();
        private Dictionary<int, Sprite> itemGround = new Dictionary<int,Sprite>();

        public ItemManager() {
            // ItemGround
            Sprite[] sprites = Asset.LoadAll<Sprite>("Sprite/Item","ItemGround");
            foreach (Sprite sprite in sprites) {
                if (!sprite.name.StartsWith("item_ground_")) continue;
                itemGround.Add(int.Parse(sprite.name.Substring(12)), sprite);
            }
        }

        public Sprite GetItemGround(int i) {
            if (i > 0 && i < 7) {
                return itemGround[i];
            }
            return null;
        }

        // 获取对象
        public ItemMeta GetMeta(int id) {
            return metaDictionary.ContainsKey(id) ? metaDictionary[id] : LoadMeta(id);
        }

        private ItemMeta LoadMeta(int id) {
            ItemMeta meta = Asset.Load<ItemMeta>(GameSettings.ITEM_META_PATH , id.ToString());
            metaDictionary.Add(id, meta);
            return meta;
        }
    }
}
```

`Data/Item/ItemMeta.cs`:

```cs
using System;
using UnityEngine;

namespace Data.Item {
    // 物品元数据
    [Serializable]
    [CreateAssetMenu(fileName = "ItemID", menuName = "ArkNight/ItemMeta")]
    public class ItemMeta : ScriptableObject {
        // ID
        [Header("数字ID"),SerializeField]
        private int id;
        // 名字
        [Header("名字"),SerializeField]
        private new string name;
        // 图标
        [Header("图标"),SerializeField]
        private Sprite icon;    
        // 稀有度
        [Header("稀有度"),Range(1,6),SerializeField]
        private int rarity;
        // 类型
        [Header("类型"),SerializeField]
        private ItemType type;
        // 用途
        [Header("用途"),SerializeField]
        private string useInfo;
        // 描述
        [Header("描述"),SerializeField]
        private string description;
        // 获得方式
        [Header("获得方式"),SerializeField]
        private string waysObtain;

        public int GetID() => id;

        public string GetName() => name;

        public Sprite GetIcon() => icon;

        public int GetRarity() => rarity;

        public ItemType GetItemType() => type;

        public string GetUseInfo() => useInfo;

        public string GetDescription() => description;

        public string GetWaysObtain() => waysObtain;
    }
}
```

`Data/Item/ItemStack.cs`:

```cs
using System;
using UnityEngine;

namespace Data.Item {
    // 物品堆
    [Serializable]
    public class ItemStack {
        // 物品ID
        [SerializeField]
        private int id;
        // 物品数量
        [SerializeField]
        private int amount;

        private ItemMeta meta;
        
        public ItemStack(int id,int amount) {
            this.id = id;
            this.amount = amount;
        }

        public int GetId() => id;
        public int GetAmount() => amount;
        public ItemMeta GetItemMeta() => meta ? meta : meta = ItemManager.Inst().GetMeta(id);

        public void SetAmount(int amount) => this.amount = amount;

        public ItemStack Clone() {
            return new ItemStack(id, amount);
        }
    }
}
```

`Data/Item/ItemType.cs`:

```cs
using System.ComponentModel;

namespace Data.Item {
    public enum ItemType {
        [Description("基础物品")]
        JI_CHU,
        [Description("养成材料")]
        YANG_CHENG
    }
}
```

`Data/Monster/MonsterData.cs`:

```cs
using System;
using Spine.Unity;
using UnityEngine;

namespace Data.Monster {
    [Serializable]
    [CreateAssetMenu(fileName = "MonsterName", menuName = "ArkNight/MonsterMeta")]
    public class MonsterData : ScriptableObject {
        private string id;

        [Header("属性"), SerializeField]
        internal MonsterAttribute attribute;

        [Header("骨骼"), SerializeField]
        internal SkeletonDataAsset skeleton;

        [Header("动画名翻译"), SerializeField]
        internal AnimationsName[] animationsNames;

        internal string this[string value] {
            get {
                if (animationsNames != null) {
                    foreach (AnimationsName animationsName in animationsNames) {
                        if (animationsName.name == value) {
                            return animationsName.target;
                        }
                    }
                }
                return value;
            }
        }
        
        public string GetId() => id;
        internal string SetId(string value) => id = value;
        
        [Serializable]
        public class AnimationsName {
            [SerializeField]
            internal string name;
            [SerializeField]
            internal string target;
        }
    }
}
```

`Data/Monster/MonsterManager.cs`:

```cs
using System.Collections.Generic;
using Settings;
using Tools;

namespace Data.Monster {
    public class MonsterManager : Single<MonsterManager> {
        // 元数据
        private Dictionary<string, MonsterData> metaDictionary = new Dictionary<string, MonsterData>();
        
        public MonsterData GetMeta(string id) => metaDictionary.ContainsKey(id) ? metaDictionary[id] : LoadMeta(id);

        // 加载LoadMeta数据
        private MonsterData LoadMeta(string id) {
            MonsterData data = Asset.Load<MonsterData>(GameSettings.MONSTER_META_PATH, id);
            data.SetId(id);
            metaDictionary.Add(id, data);
            return data;
        }
    }
}
```

`Data/Player/PlayerData.cs`:

```cs
using System;
using System.Collections.Generic;
using System.Linq;
using Data.Char;
using Data.Item;
using UnityEngine;

namespace Data.Player {
    [Serializable]
    [CreateAssetMenu(fileName = "PlayerData",menuName = "ArkNight/PlayerData")]
    public class PlayerData : ScriptableObject {
        
        // 名字
        [SerializeField]
        private new string name;
        
        // 密码
        [SerializeField]
        private string password;
        
        // 等级
        [SerializeField]
        private int level;

        // 经验
        [SerializeField]
        private int exp;

        // 理智
        [SerializeField]
        private int reason;

        // 角色数据 (预加载所有已知元数据)
        [SerializeField]
        private List<CharData> charList;

        // 队伍数据 (队伍名 + 角色类型)
        [SerializeField]
        private string[] squad;

        // 桌面角色
        [SerializeField]
        private string desktopChar;

        // 物品数据
        [SerializeField]
        private List<ItemStack> items;

        // 权限
        [SerializeField]
        private List<string> permissions;

        public string GetName() => name;
        public string GetPassword() => password;
        public int GetLevel() => level;
        public int GetExp() => exp;
        public int GetReason() => reason;
        public int GetMaxLevel() => 120;
        public int GetMaxExp() => GetMaxExp(level);
        public int GetMaxReason() => GetMaxReason(level);
        public List<CharData> GetCharList() => charList;

        public string[] GetSquad() {
            if (squad == null || squad.Length != 4) {
                squad = new string[4];
            }
            return squad;
        }
        public string GetDesktopChar() => desktopChar;
        public List<ItemStack> GetItems() => items;
        public List<string> GetPermissions() => permissions;
        
        public void SetLevel(int value) => level = value;
        public void SetExp(int value) => exp = value;
        public void SetReason(int value) => reason = value;
        public void ResetSquad() => squad = new string[4];

        public void Initialization(string name,string password) {
            this.name = name;
            this.password = password;
            reason = GetMaxReason();
            
            charList = new List<CharData> {
                new CharData("AMIYA")
            };
            ResetSquad();
            items = new List<ItemStack> {
                new ItemStack(0, 5),
                new ItemStack(1, 500),
                new ItemStack(2, 1000)
            };
            permissions = new List<string>();
        }
        
        // 最大经验值
        public static int GetMaxExp(int level) {
            if (level < 1) return 500;
            if (level < 2) return 800;
            if (level < 28) return 80 * level + 1000;
            if (level < 34) return 100 * level + 160;
            if (level < 50) return 300 * level - 6300;
            if (level < 65) return 500 * level - 16500;
            if (level < 101) return 1000 * level - 49000;
            if (level < 110) return 2000 * level - 150000;
            if (level < 120) return 3000 * level - 260000;
            return -1;
        }

        public static int GetMaxReason(int level) {
            if (level < 5) return 80 + 2 * level;
            if (level < 35) return 85 + level;
            if (level < 85) return 113 + level / 5;
            if (level < 100) return 130;
            if (level < 120) return (int) (105.75 + level / 4D);
            return -1;
        }

        public void ItemSort() {
            items.Sort((a,b) => a.GetId() == b.GetId() ? 0 : a.GetId() > b.GetId() ? 1 : -1);
        }
        
        public CharData GetCharData(string id) {
            return charList.FirstOrDefault(charData => charData.GetId() == id);
        }

        public ItemStack GetItemStack(int id) {
            return items.FirstOrDefault(itemStack => itemStack.GetId() == id);
        }

        public int GetItemAmount(int id) {
            ItemStack itemStack = GetItemStack(id);
            return itemStack?.GetAmount() ?? 0;
        }

        public void AddItem(ItemStack item) => AddItem(item.GetId(), item.GetAmount());

        public void AddItem(int id, int amount) {
            ItemStack itemStack = GetItemStack(id);
            if (itemStack != null) {
                itemStack.SetAmount(itemStack.GetAmount() + amount);
            } else {
                items.Add(new ItemStack(id, amount));
                ItemSort();
            }
        }

        public void TakeItem(ItemStack item) => TakeItem(item.GetId(), item.GetAmount());
        
        public void TakeItem(int id, int amount) {
            ItemStack itemStack = GetItemStack(id);
            if (itemStack != null && itemStack.GetAmount() >= amount) {
                itemStack.SetAmount(itemStack.GetAmount() - amount);
                if (itemStack.GetAmount() == 0) {
                    items.Remove(itemStack);
                }
            } else {
                throw new Exception("玩家没有该物品，扣款失败");
            }
        }

        public bool HasItem(ItemStack item) => HasItem(item.GetId(), item.GetAmount());

        public bool HasItem(int id, int amount) => GetItemAmount(id) >= amount;
    }
}
```

`Data/Player/PlayerManager.cs`:

```cs
using System;
using System.Collections.Generic;
using Tools;
using UnityEngine;

namespace Data.Player {
    public class PlayerManager : Single<PlayerManager> {
        
        private List<PlayerData> list = new List<PlayerData>();
        
        private PlayerData playerData;

        public PlayerManager() {
            list.Add(Asset.Load<PlayerData>("Data/User", "Saukiya"));
            list.Add(Asset.Load<PlayerData>("Data/User", "Test"));
        }

        public PlayerData Get() {
            return playerData;
        }

        public PlayerData Login(string name,string password) {
            playerData = null;
            foreach (PlayerData data in list) {
                if (data.GetName() == name && data.GetPassword() == password) {
                    playerData = data;
                    data.ItemSort();
                    break;
                }
            }
            return playerData;
        }

        public void Register(string name,string password) {
            if (list.Find(data => data.name == name) != null) {
                throw new Exception("已存在该用户");
            }
            PlayerData playerData = ScriptableObject.CreateInstance<PlayerData>();
            playerData.Initialization(name, password);
            list.Add(playerData);
        }

        public void Exit() {
            playerData = null;
        }
    }
}
```

`Data/Player/Squad.cs`:

```cs
using System;
using Data.Char;
using UnityEngine;

namespace Data.Player {
    [Serializable]
    public class Squad {
        [SerializeField]
        private string name;
        [SerializeField]
        private string[] chars;

        public Squad() {
            name = "";
            chars = new string[12];
        }

        public string GetName() => name;

        public string[] GetChars() => chars;

        public void SetName(string name) => this.name = name;

        public void SetChars(string[] chars) => this.chars = chars;
    }
}
```

`Event/Event.cs`:

```cs
namespace Script.Event {
    public abstract class Event {
        
    }
}
```

`Event/EventHandler.cs`:

```cs
using System;

namespace Script.Event {
    public class EventHandler : Attribute {
        
    }
}    
```

`Event/EventSystem.cs`:

```cs
using System;
using System.Collections.Generic;
using System.Reflection;
using Tools;

namespace Script.Event {
    public class EventSystem : Single<EventSystem> {

        // 事件 - 对象 - 方法  <Event, <Listener, List<MethodInfo>>>
        private Dictionary<Type, Dictionary<Listener, List<MethodInfo>>> dic = new Dictionary<Type, Dictionary<Listener, List<MethodInfo>>>();

        /**
         * 添加监听器
         */
        public void AddListener(Listener listener) {
            MethodInfo[] methodInfos = listener.GetType().GetMethods(BindingFlags.NonPublic | BindingFlags.Instance | BindingFlags.Public | BindingFlags.IgnoreReturn);
            foreach (MethodInfo methodInfo in methodInfos) {
                if (methodInfo.ReturnType == typeof(void) && Attribute.GetCustomAttribute(methodInfo, typeof(EventHandler)) != null) {
                    // 判断是否符合要求
                    if (methodInfo.GetParameters().Length != 1) {
                        throw new Exception("方法: " + methodInfo.Name + " 的参数数量不为1!");
                    }
                    Type eventType = methodInfo.GetParameters()[0].ParameterType;
                    if (eventType.IsAbstract) {
                        throw new Exception("方法: " + methodInfo.Name + " 未使用可实例化参数!");
                    }
                    if (!eventType.IsSubclassOf(typeof(Event))) {
                        throw new Exception("方法: " + methodInfo.Name + " 的参数未继承于Event!");
                    }
                    // 符合条件的添加方式
                    if (!dic.TryGetValue(eventType, out Dictionary<Listener, List<MethodInfo>> listenerList)) {
                        listenerList = new Dictionary<Listener, List<MethodInfo>>();
                        dic.Add(eventType, listenerList);
                    }
                    if (!listenerList.TryGetValue(listener, out List<MethodInfo> methods)) {
                        methods = new List<MethodInfo>();
                        listenerList.Add(listener, methods);
                    }
                    methods.Add(methodInfo);
                }
            }
        }

        /**
         * 删除监听器
         */
        public void RemoveListener(Listener listener) {
            MethodInfo[] methodInfos = listener.GetType().GetMethods(BindingFlags.NonPublic | BindingFlags.Instance | BindingFlags.Public | BindingFlags.IgnoreReturn);
            foreach (MethodInfo methodInfo in methodInfos) {
                if (methodInfo.ReturnType == typeof(void) && Attribute.GetCustomAttribute(methodInfo, typeof(EventHandler)) != null && methodInfo.GetParameters().Length == 1) {
                    Type eventType = methodInfo.GetParameters()[0].ParameterType;
                    if (!eventType.IsAbstract && eventType.IsSubclassOf(typeof(Event)) && dic.TryGetValue(eventType, out Dictionary<Listener, List<MethodInfo>> listenerList) && listenerList.ContainsKey(listener)) {
                        listenerList.Remove(listener);
                    }
                }
            }
        }
        
        
        /**
         * 通知事件
         */
        public void Call(Event callEvent) {
            if (dic.TryGetValue(callEvent.GetType(), out Dictionary<Listener, List<MethodInfo>> listenerList)) {
                foreach (KeyValuePair<Listener,List<MethodInfo>> entry in listenerList) {
                    Listener listener = entry.Key;
                    foreach (MethodInfo methodInfo in entry.Value) {
                        methodInfo.Invoke(listener, new object[] {callEvent});
                    }
                }
            }
        }

        // 使用示范
        // public static void Main() {
        //     Inst().AddListener(new TestListener());
        //     Inst().AddListener(new ZzzZzzListener());
        //     Listener listener = new ZzzZzzListener();
        //     Inst().AddListener(listener);
        //     Console.WriteLine();
        //     Console.WriteLine("等待2秒");
        //     Console.WriteLine();
        //     Thread.Sleep(2000);
        //     Inst().Call(new TestEvent("小明", " 去吃饭了"));
        //     Inst().Call(new QVQEvent("芳芳", 233));
        //     Console.WriteLine();
        //     Inst().RemoveListener(listener);
        //     Thread.Sleep(2000);
        //     Console.WriteLine();
        //     Console.WriteLine("延迟2秒");
        //     Thread.Sleep(1000);
        //     Console.WriteLine("Call Event");
        //     Inst().Call(new TestEvent("小王", " 去上网了"));
        //     Inst().Call(new QVQEvent("吱吱吱吱", 666));
        // }
    }
}
```

`Event/Listener.cs`:

```cs
namespace Script.Event {
    public interface Listener {
        
    }
}
```

`Game/Contorller/CharController.cs`:

```cs
namespace Scripts.Game {
    public class CharController {
        //鸽了
    }
}
```

`Game/Contorller/Sub/AMIYA.cs`:

```cs
namespace Scripts.Game {
    public class AMIYA : CharController {
    }
}
```

`Game/Dungeon.cs`:

```cs
using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using Data.Char;
using Data.Dungeon;
using Data.Monster;
using Script.Event;
using Scripts.Game.Event;
using UI;
using UnityEngine;

namespace Scripts.Game {
    public class Dungeon : MonoBehaviour {
        internal static Dungeon inst { get; private set; }

        // 对局数据
        public DungeonMeta dungeonMeta;

        // 金币
        public float cost;

        // 生命值
        public int health;

        // 波次(时间-出生点-目标点-怪物ID)
        public List<SpawnData> spawnList;

        // 击杀+走向终点的数量
        internal int skillAmount;

        // 关卡总数量
        internal int monsterSize;

        // 运行中的实体
        internal List<Entity> list;

        // 副本涩像机
        internal new Camera camera;
        internal Vector3 cameraPosition;

        // 关卡状态机
        internal StateManager sa;

        public void Awake() {
            inst = this;
            monsterSize = spawnList.Sum(spawnData => spawnData.amount);
            list = new List<Entity>();
            camera = transform.GetComponent<Camera>("Camera");
            cameraPosition = camera.transform.position;
            // 设置状态机，静止、运行、胜利、失败
            sa = new StateManager();
            sa.AddStatus("Idle", new State());
            sa.AddStatus("Run", new State()
                .OnEnter(() => { StartCoroutine(SpawnMonster()); })
                .OnStay(() => { cost = Mathf.Min(cost + Time.deltaTime, 99); })
                .OnExit(() => { StopCoroutine(SpawnMonster()); })
                .AddCondition("Win", () => health > 0 && skillAmount == monsterSize)
                .AddCondition("Lose", () => health == 0));
            sa.AddStatus("Win", new State()
                .OnEnter(() => {
                    Time.timeScale = 1;
                    UIManager.Inst().Show("GameWinUI");
                }));
            sa.AddStatus("Lose", new State()
                .OnEnter(() => {
                    Time.timeScale = 1;
                    UIManager.Inst().Show("GameLoseUI");
                }));
            sa.Name = "Idle";
        }

        public void Start() {
            UIManager.Inst().Show("GameUI");
        }

        IEnumerator SpawnMonster() {
            foreach (SpawnData spawnData in spawnList) {
                yield return new WaitForSeconds(spawnData.time);
                for (int i = 0; i < spawnData.amount; i++) {
                    Monster monster = new Monster(spawnData, Instantiate(GameManager.Inst().monsterPrefab, transform));
                    list.Add(monster);
                    EventSystem.Inst().Call(new CreateEntityEvent(monster));
                    if (i != spawnData.amount - 1) {
                        yield return new WaitForSeconds(spawnData.interval);
                    }
                }
            }
        }

        public void Update() {
            sa.Tick();
            for (int i = list.Count - 1; i >= 0; i--) {
                list[i].Update();
            }
        }

        public void SpawnChar(Transform block, CharData data, Vector3 direction) {
            Char c = new Char(data, Instantiate(GameManager.Inst().charPrefab, block), direction);
            cost -= data.GetAttribute().GetCost();
            list.Add(c);
            EventSystem.Inst().Call(new CreateEntityEvent(c));
        }

        public void Remove(Entity entity) {
            EventSystem.Inst().Call(new RemoveEntityEvent(entity));
            Destroy(entity.transform.gameObject);
            list.Remove(entity);
        }

        public void OnDestroy() {
            inst = null;
        }

        [Serializable]
        public class SpawnData {
            [SerializeField]
            internal string monsterID;

            [SerializeField]
            internal int time;

            [SerializeField]
            internal int amount;

            [SerializeField]
            internal float interval;

            [SerializeField]
            internal Transform spawnPoint;

            [SerializeField]
            internal Transform[] paths;

            [SerializeField]
            internal float[] timeIdle;

            public MonsterData GetMeta() {
                return MonsterManager.Inst().GetMeta(monsterID);
            }
        }
    }
}
```

`Game/Entity/Char.cs`:

```cs
using System.Collections.Generic;
using Data;
using Data.Char;
using Manager;
using Tools;
using UnityEngine;

namespace Scripts.Game {
    public class Char : Entity {
        internal CharData data;
        internal new CharAttribute attribute;
        internal TargetSelector<Monster> ts;
        
        //方向
        private Transform dir;
        //当前阻挡数
        internal int block;
        
        private CharController controller;
        //临时代码
        internal Monster target;

        private float timeAtk;


        public Char(CharData data, Transform transform, Vector3 direction) : base(transform, data.GetAttribute()) {
            this.data = data;
            transform.forward = Vector3.forward;
            //设置骨骼
            sa.skeletonDataAsset = data.GetCharMeta().GetSkeleton();
            sa.Initialize(true);
            attribute = data.GetAttribute();
            //攻击间隔
            timeAtk = attribute.GetAtkSpeed();
            
            // 设置阻挡数
            block = data.GetAttribute().GetBlock();
            // 设置方向
            dir = transform.Find("Dir");
            dir.forward = direction;
            model.localScale = new Vector3(1, 1, direction.z > 0 ? -1 : 1);
            SetFace(direction);

            ts = new TargetSelector<Monster>(dir, data.GetCharMeta().GetAttackRange());
            //设置排序方法 - 暂时没有依据距离来判定进远，仅通过剩余移动节点判断优先级
            ts.SetSort((a, b) => (a.spawnData.paths.Length - a.index).CompareTo(b.spawnData.paths.Length - b.index));

            
            state.AddStatus("Idle", new State()
                .OnEnter(() => {
                    sa.loop = true;
                    sa.AnimationName = "Idle";
                })
                .AddCondition("Attack", () => {
                    List<Monster> targets = ts.GetTargets();
                    if (targets.Count <= 0) return false;
                    target = targets[0];
                    return true;
                }));
            
            state.AddStatus("Attack", new State()
                .OnEnter(() => {
                    sa.loop = true;
                    sa.AnimationName = "Attack";
                })
                .OnStay(() => {
                    // 攻速占用
                    // if (!(timeAtk >= attribute.GetAtkSpeed())) return;
                    // sa.loop = false;
                    // sa.AnimationName = "Attack";
                    // Debug.Log("Attack: " + target);
                    // timeAtk = 0;
                })
                .AddCondition("Idle", () => target == null));

            state.AddStatus("Die", new State()
                .OnEnter(() => {
                    sa.loop = false;
                    sa.AnimationName = "Die";
                }));
            state.AddCondition("Die", isDead);

            sa.state.Start += entry => {
                if (entry.Animation.Name == "Attack") {
                    SetFace(target.transform.position - transform.position);
                }
            };
            sa.state.Complete += entry => {
                switch (entry.Animation.Name) {
                    case "Die":
                        Delay.add(() => Dungeon.inst.Remove(this), 1);
                        break;
                    case "Attack":
                        if (sa.AnimationName == "Die") return;
                        List<Monster> targets = ts.GetTargets();
                        if (targets.Count > 0) {
                            target = targets[0];
                            SetFace(target.transform.position - transform.position);
                        } else {
                            target = null;
                        }
                        break;
                    case "Start":
                        state.Name = "Idle";
                        break;
                }
            };
            DamageType type = data.GetCharMeta().GetProfession() == CharProfession.SHU_SHI ? DamageType.Magic : DamageType.Physical;
            sa.state.Event += (entry, e) => {
                if (e.Data.Name == "OnAttack" && target != null && !target.isDead()) {
                    target.damage(attribute.GetAtk(), type);
                }
            };
        }
        
        public override void Update() {
            timeAtk += Time.deltaTime;
            base.Update();
        }
    }
}
```

`Game/Entity/Entity.cs`:

```cs
using Data;
using Spine.Unity;
using UnityEngine;

namespace Scripts.Game {
    public abstract class Entity {
        internal Transform transform;
        internal Transform model;
        internal SkeletonAnimation sa;
        internal StateManager state;
        internal Attribute attribute;
        internal float health;
        internal int face = 1;

        public Entity(Transform transform, Attribute attribute) {
            this.transform = transform;
            this.attribute = attribute;
            health = attribute.GetMaxHealth();
            model = transform.Find("Model");
            sa = model.GetComponent<SkeletonAnimation>("Skeleton");
            state = new StateManager();
        }

        public virtual void Update() {
            state.Tick();
            model.localScale = new Vector3(1, 1, Mathf.Lerp(model.localScale.z, face, Time.deltaTime * 8f));
        }

        public float GetHealth() {
            return health;
        }

        public void SetHealth(float value) {
            health = value;
        }

        public bool isDead() {
            return health <= 0;
        }

        public void damage(float damage, DamageType type) {
            if (type == DamageType.Physical) {
                health -= Mathf.Max(damage * 0.05f, damage - attribute.GetDef()); //物理：攻击 - 防御
            } else {
                health -= Mathf.Max(damage * 0.05f, damage * 0.01f * (100 - attribute.GetMagicResistance())); //法术：
            }
        }

        public void SetFace(Vector3 vec) {
            if (vec.z > 0.5) {
                face = -1;
            } else if (vec.z < -0.5) {
                face = 1;
            }
        }
    }

    public enum DamageType {
        Physical,
        Magic
    }
}
```

`Game/Entity/Monster.cs`:

```cs
using System.Collections.Generic;
using Data;
using Data.Monster;
using Manager;
using Tools;
using UnityEngine;
using Random = UnityEngine.Random;
using SpawnData = Scripts.Game.Dungeon.SpawnData;

namespace Scripts.Game {
    public class Monster : Entity {
        internal MonsterData data;
        internal new MonsterAttribute attribute;
        internal TargetSelector<Char> ts;
        
        internal SpawnData spawnData;
        internal Char target;
        public int index;
        private float timeAtk;

        public Monster(SpawnData spawnData, Transform transform) : base(transform, spawnData.GetMeta().attribute) {
            data = spawnData.GetMeta();
            attribute = data.attribute;
            sa.skeletonDataAsset = data.skeleton;
            sa.Initialize(true);
            transform.position = spawnData.spawnPoint.position;

            //攻击间隔
            timeAtk = attribute.GetAtkSpeed();
            
            this.spawnData = spawnData;
            //停止间隔
            float timeIdle = index <= spawnData.timeIdle.Length - 1 ? spawnData.timeIdle[index] : 0;
            
            // 目标选择器
            // 这里放的transform是不会改变朝向的 需要注意下（但是现在的Monster只有近战攻击呢 ^ ^
            ts = new TargetSelector<Char>(transform, new[] {Vector3.zero});
            
            model.localScale = new Vector3(1, 1, (spawnData.paths[index].position - transform.position).z > 0 ? -1 : 1);
            //创建一个名为 Moving 的状态
            state.AddStatus("Moving", new State()
                //启动方法
                .OnEnter(() => {
                    sa.loop = true;
                    sa.AnimationName = data["Move_Loop"];
                })
                //持续方法
                .OnStay(() => {
                    if (index <= spawnData.paths.Length - 1) {
                        Vector3 vec = (spawnData.paths[index].position - transform.position).normalized;
                        SetFace(vec);
                        transform.Translate(Time.deltaTime * attribute.GetMoveSpeed() * vec);
                        if (Vector3.Distance(spawnData.paths[index].position, transform.position) <= 0.1f) {
                            index++;
                            timeIdle = index <= spawnData.timeIdle.Length - 1 ? spawnData.timeIdle[index] : 0;
                        }
                    } else {
                        Dungeon.inst.health -= 1;
                        Dungeon.inst.skillAmount += 1;
                        Dungeon.inst.Remove(this);
                    }
                })
                //跳出判断
                .AddCondition("Attack", () => {
                    List<Char> targets = ts.GetTargets();
                    if (targets.Count > 0 && targets[0].block > 0) {
                        target = targets[0];
                        target.block -= 1;
                        //被阻挡时小幅度偏移
                        transform.Translate((target.transform.position - transform.position) * 0.2f);
                        transform.Translate(Quaternion.Euler(0, 90, 0) * (transform.position - target.transform.position) * Random.Range(0.5f, -0.5f));
                        return true;
                    }
                    return false;
                })
                .AddCondition("Idle", () => timeIdle > 0)
            );

            // 停止状态
            state.AddStatus("Idle", new State()
                .OnEnter(() => {
                    sa.loop = true;
                    sa.AnimationName = "Idle";
                })
                .OnStay(() => {
                    timeIdle -= Time.deltaTime;
                })
                .AddCondition("Moving", () => timeIdle <= 0)
                .AddCondition("Attack", () => {
                    List<Char> targets = ts.GetTargets();
                    if (targets.Count > 0 && targets[0].block > 0) {
                        target = targets[0];
                        target.block -= 1;
                        //被阻挡时小幅度偏移
                        transform.Translate((target.transform.position - transform.position) * 0.2f);
                        transform.Translate(Quaternion.Euler(0, 90, 0) * (transform.position - target.transform.position) * Random.Range(0.5f, -0.5f));
                        return true;
                    }
                    return false;
                })
            );
            
            state.AddStatus("Attack", new State()
                .OnStay(() => {
                    if (!(timeAtk >= attribute.GetAtkSpeed())) return;
                    sa.loop = false;
                    sa.AnimationName = "Attack";
                    timeAtk = 0;
                })
                .AddCondition("Moving", () => target == null));

            state.AddStatus("Die", new State()
                .OnEnter(() => {
                    sa.loop = false;
                    sa.AnimationName = "Die";
                    Dungeon.inst.skillAmount += 1;
                    if (target != null) {
                        //死亡返还阻挡值
                        target.block += 1;
                    }
                }));
            // 总状态条件 - 死亡
            state.AddCondition("Die", isDead);

            // 动画机事件
            sa.state.Complete += entry => {
                switch (entry.Animation.Name) {
                    case "Die":
                        Delay.add(() => Dungeon.inst.Remove(this), 1);
                        break;
                    case "Attack":
                        if (sa.AnimationName == "Die") return;
                        sa.loop = true;
                        sa.AnimationName = "Idle";
                        if (target != null) {
                            if (target.isDead() || !Dungeon.inst.list.Contains(target)) {
                                target = null;
                            }
                        }
                        break;
                }
            };

            // 自定义动画机事件
            sa.state.Event += (entry, e) => {
                if (e.Data.Name == "OnAttack" && target != null && !target.isDead()) {
                    target.damage(attribute.GetAtk(), DamageType.Physical);
                }
            };

            //默认状态
            state.Name = "Moving";
        }

        public override void Update() {
            // if (target != null) {
            //     if (target.isDead() || !Dungeon.inst.list.Contains(target)) {
            //         target = null;
            //     }
            // }
            timeAtk += Time.deltaTime;
            base.Update();
        }
    }
}
```

`Game/Event/CreateEntityEvent.cs`:

```cs
namespace Scripts.Game.Event {
    public class CreateEntityEvent : EntityEvent {
        public CreateEntityEvent(Entity entity) : base(entity) { }
    }
}
```

`Game/Event/EntityEvent.cs`:

```cs
namespace Scripts.Game.Event {
    public abstract class EntityEvent : Script.Event.Event {
        
        internal Entity entity;
        
        public EntityEvent(Entity entity) {
            this.entity = entity;
        }
    }
}
```

`Game/Event/RemoveEntityEvent.cs`:

```cs
namespace Scripts.Game.Event {
    public class RemoveEntityEvent : EntityEvent{
        public RemoveEntityEvent(Entity entity) : base(entity) { }
    }
}
```

`Game/GameManager.cs`:

```cs
using Tools;
using UnityEngine;

namespace Scripts.Game {
    public class GameManager : MonoSingle<GameManager> {

        internal Transform monsterPrefab;
        internal Transform charPrefab;
        internal Transform charPlacePrefab;
        internal Transform atkRangeDisplay;
        internal AudioClip clip;
        internal AudioClip loop_clip;
        
        protected override void Initialization() {
            monsterPrefab = Asset.Load<Transform>("Prefab/Game", "MonsterPrefab");
            charPrefab = Asset.Load<Transform>("Prefab/Game", "CharPrefab");
            charPlacePrefab = Asset.Load<Transform>("Prefab/Game", "CharPlacePrefab");
            atkRangeDisplay = Asset.Load<Transform>("Prefab/Game", "AtkRangeDisplay");
            clip = Asset.Load<AudioClip>("Audio/Music/Game", "m_bat_indust_intro");
            loop_clip = Asset.Load<AudioClip>("Audio/Music/Game", "m_bat_indust_loop");
        }

        public void StarGame(string dungeonName) {
            
        }
    }
}
```

`Game/State.cs`:

```cs
using System;
using System.Collections.Generic;
using System.Linq;

namespace Scripts.Game {
    // 状态管理
    public class StateManager {
        //状态机列表
        private Dictionary<string, State> dic = new Dictionary<string, State>();

        //总状态更改条件
        private Dictionary<string, Func<bool>> conditions = new Dictionary<string, Func<bool>>();

        //当前状态
        private State current;

        internal string Name {
            get => current?.name;
            set {
                if (value == Name || !dic.TryGetValue(value, out State next)) return;
                current?.exit();
                next.enter();
                current = next;
            }
        }

        // 添加一个状态机
        public void AddStatus(string name, State state) {
            dic.Add(name, state);
            state.name = name;
        }

        // 更新
        public void Tick() {
            if (current == null) return;
            current.stay();
            //总条件跳转
            foreach (KeyValuePair<string, Func<bool>> entry in conditions.Where(entry => entry.Key != Name && entry.Value())) {
                Name = entry.Key;
                return;
            }
            //子条件跳转
            foreach (KeyValuePair<string, Func<bool>> entry in current.conditions.Where(entry => entry.Value())) {
                Name = entry.Key;
                return;
            }
        }

        // 添加总状态机条件
        public void AddCondition(string status, Func<bool> condition) {
            conditions.Add(status, condition);
        }

        // 清理
        public void Clear() {
            dic.Clear();
            conditions.Clear();
        }
    }

    // 状态委托
    public class State {
        private static Action EmptyAction = () => { };

        internal string name;
        internal Action enter = EmptyAction;
        internal Action stay = EmptyAction;
        internal Action exit = EmptyAction;

        internal Dictionary<string, Func<bool>> conditions = new Dictionary<string, Func<bool>>();

        // 设置进入方法
        public State OnEnter(Action action) {
            enter = action;
            return this;
        }

        // 设置持续方法(Update)
        public State OnStay(Action action) {
            stay = action;
            return this;
        }

        // 设置退出方法
        public State OnExit(Action action) {
            exit = action;
            return this;
        }

        // 添加状态跳转条件
        public State AddCondition(string status, Func<bool> condition) {
            conditions.Add(status, condition);
            return this;
        }
    }
}
```

`Game/TargetSelector.cs`:

```cs
using System.Collections.Generic;
using System.Linq;
using UnityEngine;

namespace Scripts.Game {
    // 目标选择器
    // 虽然很单一 但是够用
    public class TargetSelector<T> where T : Entity {
        // 运行方式？Entity实例化的时候实例化

        private Transform transform;
        private List<Vector3> range;
        private List<Entity> entityList = Dungeon.inst.list;

        // internal T this[int value] => GetTargets()[value];

        private SortPackage<T> sort;

        // 实例化方式：给予一个带有方向的坐标
        public TargetSelector(Transform transform, IEnumerable<Vector3> range) {
            this.transform = transform;
            this.range = new List<Vector3>(range);
        }

        // 获得目标列表
        public List<T> GetTargets() {
            List<T> list = new List<T>();
            foreach (Vector3 position in range.Select(vector => Quaternion.LookRotation(transform.forward) * vector).Select(position => position + transform.position)) {
                // list.AddRange(entityList.Where(entity => entity.GetType() == typeof(T) && entity.transform.position.Round() == position.Round() && !entity.isDead()).Cast<T>());
                list.AddRange(entityList.Where(entity => entity.GetType() == typeof(T) && Vector3.Distance(entity.transform.position, position) < 0.7 && !entity.isDead()).Cast<T>());
            }
            if (sort != null) list.Sort(sort);
            return list;
        }

        //设置排序方法
        public void SetSort(SortPackage<T>.CompareDelegate cd) {
            sort = new SortPackage<T>(cd);
        }
    }

    
    // 用委托封装排序接口（为什么要封装？？C#的接口为什么为什么不能像JJJJJJJJJJJava那样子）
    public class SortPackage<T> : IComparer<T> where T : Entity {
        internal CompareDelegate cd;

        public SortPackage(CompareDelegate cd) {
            this.cd = cd;
        }
        
        public delegate int CompareDelegate(T a, T b);
        public int Compare(T x, T y) {
            return cd(x, y);
        }
    }
}
```

`GameStart.cs`:

```cs
using Data.Player;
using Manager;
using Scripts.Game;
using UI;
using UnityEngine;

namespace Scripts {
    public class GameStart : MonoBehaviour {
        private void Awake() {
            GameManager.Inst();
            LuaEnvManager.Inst();
            UIManager.Inst().Show("LoginUI");
            Destroy(gameObject);
        }
    }
}
```

`LuaScripts/Global/Global.lua.txt`:

```txt
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Saukiya.
--- DateTime: 2020/8/13 16:32
--- 全局环境

Mathf = CS.UnityEngine.Mathf

GameObject = CS.UnityEngine.GameObject

Color = CS.UnityEngine.Color

Vector3 = CS.UnityEngine.Vector3

Vector2 = CS.UnityEngine.Vector2

Quaternion = CS.UnityEngine.Quaternion

Debug = CS.UnityEngine.Debug

Input = CS.UnityEngine.Input

Time = CS.UnityEngine.Time

Screen = CS.UnityEngine.Screen

Object = CS.UnityEngine.Object

DOTween = CS.DG.Tweening.DOTween

DateTime = CS.System.DateTime

Asset = CS.Tools.Asset

Delay = CS.Manager.Delay

CharInfoUI = CS.UI.Sub.CharInfoUI;
---单例 Single
---@type Manager.SoundManager
SoundManager = CS.Manager.SoundManager.Inst()
---@type Data.Player.PlayerManager
PlayerManager = CS.Data.Player.PlayerManager.Inst()
---@type UI.UIManager
UIManager = CS.UI.UIManager.Inst()
---@type Data.Item.ItemManager
ItemManager = CS.Data.Item.ItemManager.Inst()
---@type Data.Char.CharManager
CharManager = CS.Data.Char.CharManager.Inst()
--[[---@type Manager.ABManager]]
--ABManager = CS.Manager.ABManager.Inst()
```

`LuaScripts/UI/CharUI.lua.txt`:

```txt
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Saukiya.
--- DateTime: 2020/8/17 0:43
---
---干员界面
---@type UnityEngine.RectTransform
cardPrefab = cardPrefab

--排序方式+筛选方式


--卡牌对象缓存
local CardList = {}

--排序-设置层级-添加监听
function init()
    tog_level.onValueChanged:AddListener(function(boo)
        if boo then
            sortLevel()
            SetSibling()
        end
    end)
    tog_rarity.onValueChanged:AddListener(function(boo)
        if boo then
            sortRarity()
            SetSibling()
        end
    end)
end

--创建卡牌并更新卡牌数据
function updateView()
    local dataList = PlayerManager:Get():GetCharList()
    --双列表最大值循环
    for i = 1, math.max(dataList.Count, #CardList) do
        --如果i在dataList范围内--则设置CardList的数据并激活
        if i < dataList.Count + 1 then
            --如果i在CardList范围外，则创建预制体
            if #CardList < i then
                local charCard = getCharCard(GameObject.Instantiate(cardPrefab, cardPrefab.parent))
                table.insert(CardList, charCard)
            end
            CardList[i]:setData(dataList[i - 1])
            CardList[i].gameObject.name = CardList[i].data:GetCharMeta():GetEnglishName();
            CardList[i]:setActive(true)
        else
            --如果i在dataList范围外，则失活CardList中的GameObject
            CardList[i]:setActive(false)
        end
    end
    --执行排序的方法
    if tog_level.isOn then
        sortLevel()
    else
        sortRarity()
    end
    SetSibling()
end

---根据transform返回一个卡片对象（由于Lua层感觉不好互相沟通 所以受限用这种方法
---@param transform UnityEngine.Transform
function getCharCard(transform)
    transform:DOScaleY(3,0.3)
    local CharCard = {
        data,
        gameObject = transform.gameObject,
        name = transform:Find("txt_name"):GetComponent("Text"),
        level = transform:Find("txt_level"):GetComponent("Text"),
        expPercentage = transform:Find("img_exp_ground/img_exp_percentage"):GetComponent("Image"),
        charCard = transform:Find("img_char_card"):GetComponent("Image"),
        rarity1 = transform:Find("img_rarity_1"):GetComponent("Image"),
        rarity2 = transform:Find("img_rarity_2"):GetComponent("Image"),
        rarity3 = transform:Find("img_rarity_3"):GetComponent("Image"),
        rarity4 = transform:Find("img_rarity_4"):GetComponent("Image"),
        rarityStar = transform:Find("img_rarity_star"):GetComponent("Image"),
        profession = transform:Find("img_profession"):GetComponent("Image"),
        eliteImage = transform:Find("img_elite"):GetComponent("Image")
    }
    --设置data并更新数据
    function CharCard:setData(data)
        self.data = data
        local charMeta = self.data:GetCharMeta()
        local rarity = charMeta:GetRarity()
        self.name.text = charMeta:GetChineseName()
        self.charCard.sprite = charMeta:GetCharImage()
        self.rarity1.sprite = CharManager:GetCardGroundImage(rarity .. "_1")
        self.rarity2.sprite = CharManager:GetCardGroundImage(rarity .. "_2")
        self.rarity3.sprite = CharManager:GetCardGroundImage(rarity .. "_3")
        self.rarity4.sprite = CharManager:GetCardGroundImage(rarity .. "_4")
        self.rarityStar.sprite = CharManager:GetCardGroundImage(rarity .. "_star")
        self.profession.sprite = CharManager:GetProfessionSmallImage(charMeta:GetProfession())
        self:update();
    end

    function CharCard:update()
        self.level.text = self.data:GetLevel()
        self.expPercentage.fillAmount = self.data:GetExp() / self.data:GetMaxExp()
        self.eliteImage.gameObject:SetActive(self.data:GetElite() > 0)
        if self.data:GetElite() > 0 then
            self.eliteImage.sprite = CharManager:GetCharEliteImage("card_" .. self.data:GetElite())
        end
    end

    function CharCard:setActive(boo)
        self.gameObject:SetActive(boo)
    end

    transform:GetComponent("Button").onClick:AddListener(function()
        --打开界面
        local list = {}-- 与C# string[] 对接
        local index
        for i, v in ipairs(CardList) do
            if v.gameObject.activeSelf then
                if v.data == CharCard.data then
                    index = i
                end
                table.insert(list, v.data:GetCharMeta():GetId())
            end
        end
        CharInfoUI.Show(list, index - 1)
    end)
    return CharCard
end

function show()
    self:BaseShow()
    self.canvasGroup.alpha = 0
    self.canvasGroup:DOFade(1, 0.4)
end

function hide(destroy)
    self.canvasGroup:DOFade(0, 0.4):OnComplete(function()
        self:BaseHide(destroy)
    end)
end

function sortLevel()
    --等级排序
    table.sort(CardList, function(a, b)
        if a.gameObject.activeSelf and b.gameObject.activeSelf then
            if a.data:GetElite() == b.data:GetElite() then
                --精英阶级如果相同
                if a.data:GetLevel() == b.data:GetLevel() then
                    --等级如果相同
                    return a.data:GetExp() > b.data:GetExp()--比较经验
                end
                return a.data:GetLevel() > b.data:GetLevel()
            end
            return a.data:GetElite() > b.data:GetElite()
        end
        return a.gameObject.activeSelf and not b.gameObject.activeSelf--激活的gameObject在前，没激活的在后
    end)
end

function sortRarity()
    --稀有度排序
    table.sort(CardList, function(a, b)
        if a.gameObject.activeSelf and b.gameObject.activeSelf then
            if a.data:GetCharMeta():GetRarity() == b.data:GetCharMeta():GetRarity() then
                --如果稀有度相同
                if a.data:GetElite() == b.data:GetElite() then
                    --排序精英、等级、硬件
                    if a.data:GetLevel() == b.data:GetLevel() then
                        return a.data:GetExp() > b.data:GetExp()
                    end
                    return a.data:GetLevel() > b.data:GetLevel()
                end
                return a.data:GetElite() > b.data:GetElite()
            end
            return a.data:GetCharMeta():GetRarity() > b.data:GetCharMeta():GetRarity()--比较经验
        end
        return a.gameObject.activeSelf and not b.gameObject.activeSelf--激活的gameObject在前，没激活的在后
    end)
end

function SetSibling()
    --修改位置
    for i, v in ipairs(CardList) do
        v.gameObject.transform:SetSiblingIndex(i)
    end
end
```

`LuaScripts/UI/HomeUI.lua.txt`:

```txt
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Saukiya.
--- DateTime: 2020/8/14 1:36
---
---主界面

---@type UI.RuaUI
self = self

local clip = Asset.Load("Audio/Music/Home", "m_sys_void_intro")
local loop_clip = Asset.Load("Audio/Music/Home", "m_sys_void_loop")

local target = Vector2.zero
local current = Vector2.zero
local CanvasSizeExceptTwo = UIManager:GetCanvasSize() / 2;

---@type Data.Player.PlayerData
local data;

function update()---刷新时间 - 跟随鼠标
    time.text = DateTime.Now:ToString("yyyy/MM/dd/ HH:mm")
    if screenHasMouse() then
        target = Input.mousePosition;
        --- 这里遇到Vector3不能转Vector2的坑 自定义运算符倒是能支持
        target = (Vector2(target.x, target.y) - CanvasSizeExceptTwo) / CanvasSizeExceptTwo
    end
    current = Vector2.Lerp(current, target, 1.5 * Time.deltaTime)
    local rotationLocalPosition = move1.localPosition
    rotationLocalPosition.x = current.x * 50
    rotationLocalPosition.y = current.y * -30
    move1.localPosition = rotationLocalPosition

    local euler = move2.localRotation.eulerAngles
    rotationLocalPosition = move2.localPosition
    euler.y = current.x * -3
    euler.x = current.y * 4
    rotationLocalPosition.y = -current.y * 30
    move2.localPosition = rotationLocalPosition
    move2.rotation = Quaternion.Euler(euler)
end

function show()
    self:BaseShow()
    SoundManager:PlayMusic(clip, false, function ()
        SoundManager:PlayMusic(loop_clip, true);
    end)
    self.canvasGroup.alpha = 0
    self.canvasGroup:DOFade(1, 0.5)
    
    data = PlayerManager:Get()
end

function hide(destroy)
    self.canvasGroup:DOFade(0, 0.5):OnComplete(function()
        self:BaseHide(destroy)
    end)
end

function updateView()
    playerName.text = data:GetName()
    playerLevel.text = tostring(data:GetLevel() + 1)
    expPercentage.fillAmount = data:GetExp() / data:GetMaxExp()
    reason.text = tostring(data:GetReason())
    maxReason.text = tostring(data:GetMaxReason())
    sourceStone.text = "0"
    syntheticJade.text = "0"
    dragonCoin.text = "0"

    sourceStone.text = tostring(data:GetItemAmount(0));
    syntheticJade.text = tostring(data:GetItemAmount(1));
    dragonCoin.text = tostring(data:GetItemAmount(2));
    item = data:GetItemStack(1)
end

function screenHasMouse()
    local vector3 = Input.mousePosition
    return vector3.x <= Screen.width and vector3.x > 0 and vector3.y <= Screen.height and vector3.y > 0
end
```

`Manager/ABManager.cs`:

```cs
using System.Collections.Generic;
using System.IO;
using Tools;
using UnityEngine;

namespace Manager {
    public class ABManager : Single<ABManager> {
        /// <summary>
        /// 加载过并且未卸载的AB包
        /// </summary>
        private Dictionary<string, AssetBundle> loadedDic = new Dictionary<string, AssetBundle>();

        /// <summary>
        /// 单一的总包
        /// </summary>
        private AssetBundle single;

        /// <summary>
        /// 总的构建清单
        /// </summary>
        private AssetBundleManifest manifest;

        /// <summary>
        /// ab包的路径
        /// </summary>
        private string abPath = "";

        public string ABPath {
            get {
                if (abPath == "") {
                    #if UNITY_STANDALONE_WIN
                    abPath = Application.streamingAssetsPath + "/";
                    #elif UNITY_ANDROID || UNITY_IOS
                    abPath = Application.persistentDataPath + "/";
                    #endif
                }
                return abPath;
            }
        }

        /// <summary>
        /// 总的AB包的名字
        /// </summary>
        public string SingleABName {
            get {
                //可能平台不同，总的AB包的名字可能不同
                #if UNITY_STANDALONE_WIN
                return "Win";
                #elif UNITY_ANDROID
            return "Android";
                #elif UNITY_IOS
            return "IOS";
                #else
            Debug.LogError("未指定该平台的名字");
                #endif
                return "";
            }
        }

        /// <summary>
        /// 加载AB包
        /// </summary>
        /// <returns></returns>
        public AssetBundle LoadAssetBundle(string abName) {
            //要加载依赖项，要先获取依赖，要获取依赖，先加载到总的构建清单

            //先判断总包是否加载过
            if (single == null) {
                if (!File.Exists(ABPath + SingleABName)) {
                    Debug.LogWarning($"未找到路径: {ABPath}{SingleABName}");
                    return null;
                }
                single = AssetBundle.LoadFromFile(ABPath + SingleABName);
            }

            //再判断构建清单是否加载过
            if (manifest == null) {
                //从总包里加载构建清单
                manifest = single.LoadAsset<AssetBundleManifest>("AssetBundleManifest");
            }

            //获取要加载AB包的依赖项
            string[] deps = manifest.GetAllDependencies(abName);
            //遍历数据加载依赖项
            for (int i = 0; i < deps.Length; i++) {
                string depABName = deps[i];
                //方法本身就是加载AB包的， 在调用本身就是加载另一个AB包
                //两个AB包相互依赖的情况下，递归会造成死循环
                //LoadAssetBundle(depABName);

                //判断是否加载过
                if (!loadedDic.ContainsKey(depABName)) {
                    AssetBundle depAB = AssetBundle.LoadFromFile(ABPath + depABName);
                    loadedDic.Add(depABName, depAB);
                }
            }

            //是否加载过
            if (!loadedDic.TryGetValue(abName, out AssetBundle ab)) {
                //没找到， 未加载过，或加载过之后卸载了, 
                //需要重新加载
                //加载该ab包前，需要先加载它的依赖项
                if (File.Exists(ABPath + abName)) {
                    //依赖都加载完毕了
                    //在加载当前的AB包
                    ab = AssetBundle.LoadFromFile(ABPath + abName);
                    //Debug.Log("加载了 " + abName + " 包");
                    //将加载进来的AB包添加到字典中
                    loadedDic.Add(abName, ab);
                }
            }
            return ab;
        }


        /// <summary>
        /// 卸载AB包
        /// </summary>
        public void UnloadAssetBundle(string abName, bool unloadAllObjects = false) {
            //是否加载了
            AssetBundle ab = null;
            if (loadedDic.TryGetValue(abName, out ab)) {
                //卸载
                ab.Unload(unloadAllObjects);
                //将其从字典中移除
                loadedDic.Remove(abName);
                // Debug.Log("卸载了：" + abName);
            }
        }

        /// <summary>
        /// 卸载全部的AB包
        /// </summary>
        /// <param name="unloadAllObjects"></param>
        public void UnloadAll(bool unloadAllObjects = false) {
            //遍历字典的值
            foreach (AssetBundle assetbundle in loadedDic.Values) {
                assetbundle.Unload(unloadAllObjects);
            }
            //清空字典，不清空的的情况下，键值对还存在，只不过是值为null
            loadedDic.Clear();
        }


        /// <summary>
        /// 从指定的AB包中加载指定名字的资源 T为资源类型
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="assetName"></param>
        /// <param name="abName"></param>
        /// <returns></returns>
        public T LoadAsset<T>(string assetName, string abName)
            where T : Object {
            //先获取AB包, 利用加载AB包的方法获取AB包，即使之前加载过，方法内部判断了不会重复的加载
            AssetBundle ab = LoadAssetBundle(abName);
            if (ab != null && ab.Contains(assetName)) {
                //从AB包中获取资源
                T asset = ab.LoadAsset<T>(assetName);
                return asset;
            }
            //复用非泛型方法
            //Object asset = LoadAsset(assetName, abName, typeof(T));
            //return asset as T;
            return default(T);
        }


        public Object LoadAsset(string assetName, string abName, System.Type type) {
            //先获取AB包
            AssetBundle ab = LoadAssetBundle(abName);
            if (ab != null) {
                //从ab包中获取资源
                Object asset = ab.LoadAsset(assetName, type);
                return asset;
            }
            return null;
        }
    }
}
```

`Manager/LuaEnvManager.cs`:

```cs
using System.IO;
using System.Text;
using Tools;
using UnityEngine;
using XLua;

namespace Manager {
    public class LuaEnvManager : Single<LuaEnvManager> {
        private const string luaScriptsFolder = "LuaScripts/";

        //管理Lua的虚拟机
        private LuaEnv luaEnv;

        public LuaEnv LuaEnv() => luaEnv;

        /// <summary>
        /// 只要管理器存在了，虚拟机就存在
        /// </summary>
        protected override void Initialization() {
            luaEnv = new LuaEnv();
            luaEnv.AddLoader(LuaFolderLoader);
            luaEnv.AddLoader(AssetLoader);
            luaEnv.DoString("require('Global.Global')", "chunk", luaEnv.Global);
        }

        public void DoFile(string luaFileName, string chunkName = "chunk", LuaTable env = null) {
            luaEnv.DoString($"require('{luaFileName}')", "chunk", env);
        }

        private static byte[] LuaFolderLoader(ref string filepath) {
            filepath = luaScriptsFolder + filepath.Replace(".", "/") + ".lua.txt";
            string scriptPath = Path.Combine(Application.dataPath, filepath);
            return !File.Exists(scriptPath) ? null : Encoding.UTF8.GetBytes(File.ReadAllText(scriptPath));
        }

        public static string LoadLuaText(string filepath) {
            filepath = luaScriptsFolder + filepath.Replace(".", "/") + ".lua";
            string[] args = filepath.Split('/');
            string name = args[args.Length - 1];
            TextAsset textAsset = Asset.Load<TextAsset>(filepath.Substring(0, filepath.Length - name.Length), name);
            return textAsset == null ? null : textAsset.text;
        }

        // 从AB包中加载lua文件
        private static byte[] AssetLoader(ref string filepath) {
            //从AB包中获取文件
            filepath = luaScriptsFolder + filepath.Replace(".", "/") + ".lua";
            string[] args = filepath.Split('/');
            string name = args[args.Length - 1];
            TextAsset textAsset = Asset.Load<TextAsset>(filepath.Substring(0, filepath.Length - name.Length), name);
            return textAsset == null ? null : textAsset.bytes;
        }
    }
}
```

`Manager/ShopItemDataList.cs`:

```cs
using System;
using System.Collections.Generic;
using UnityEngine;

namespace Manager {
    [Serializable]
    [CreateAssetMenu(fileName = "ShopItemDataList", menuName = "ArkNight/ShopItemDataList")]
    public class ShopItemDataList : ScriptableObject {
        public List<ShopItemData> list = new List<ShopItemData>();
    }
    //
}
```

`Manager/ShopManager.cs`:

```cs
using System;
using System.Collections.Generic;
using Data.Item;
using Tools;
using UnityEngine;

namespace Manager {
    public class ShopManager : Single<ShopManager> {
        private List<ShopItemData> list = Asset.Load<ShopItemDataList>("Data/Shop", "ShopItemDataList").list;

        public List<ShopItemData> GetShopItems(int priceID) {
            return list.FindAll(i => i.GetPrice().GetId() == priceID);
        }
    }

    [Serializable]
    public class ShopItemData {
        [SerializeField]
        private ItemStack sellItem;
        [SerializeField]
        private ItemStack priceItem;

        public ItemStack GetSell() => sellItem;
        public ItemStack GetPrice() => priceItem;
    }
}
```

`Manager/SoundManager.cs`:

```cs
using System;
using System.Collections;
using DG.Tweening;
using Settings;
using Tools;
using UnityEngine;

namespace Manager {
    public class SoundManager : MonoSingle<SoundManager> {

        private AudioSource soundEffect;
        private AudioSource music;
        private AudioSource voice;
        private Coroutine cor;
        

        protected override void Initialization() {
            soundEffect = AddAudio("SoundEffect");
            music = AddAudio("Music");
            voice = AddAudio("Voice");
            UpdateData();
        }

        public AudioSource AddAudio(string name = "AudioSource") {
            GameObject gameObject = new GameObject(name);
            gameObject.transform.parent = transform;
            return gameObject.AddComponent<AudioSource>();
        }

        // 播放音频 （参数：音频，是否循环，回调函数）
        public void PlayMusic(AudioClip clip, bool loop, Action action = null) {
            if (cor != null) {//停止之前的携程
                StopCoroutine(cor);
                cor = null;
            }
            if (!loop && GameSettings.SOUND_MUSIC_ENABLE) {// 如果不是循环并且音乐频道为开启，则是淡入淡出播放
                DOTween.To(() => music.volume, value => music.volume = value, 0, 1).OnComplete(() => {
                    DOTween.To(() => music.volume, value => music.volume = value, GameSettings.SOUND_MUSIC_VALUE / 100f, 1);
                    music.clip = clip;
                    music.loop = false;
                    music.Play();
                    if (action != null) {//如果存在回调函数，则创建协程 -- 因为延迟函数所以要多些一行
                        cor = StartCoroutine(startYingPingJiShi(clip, action));
                    }
                });
            } else {//循环模式则直接切歌
                music.volume = GameSettings.SOUND_MUSIC_VALUE / 100f;
                music.clip = clip;
                music.loop = loop;
                music.Play();
                if (action != null) {//如果存在回调函数，则创建协程
                    cor = StartCoroutine(startYingPingJiShi(clip, action));
                }
            }
        }

        // 播放完后音频回调函数
        IEnumerator startYingPingJiShi(AudioClip clip, Action action) {
            yield return  new WaitForSeconds(clip.length);
            cor = null;//清理携程变量
            action();
        }

        public void PlayEffect(AudioClip clip) {
            soundEffect.PlayOneShot(clip);
        }

        public void StopMusic() {
            DOTween.To(() => music.volume, value => music.volume = value, 0, 1).OnComplete(() => {
                music.Stop();
            });

        }

        public void UpdateData() {
            soundEffect.volume = GameSettings.SOUND_SOUND_EFFECT_ENABLE ? GameSettings.SOUND_SOUND_EFFECT_VALUE / 100f : 0;
            music.volume = GameSettings.SOUND_MUSIC_ENABLE ? GameSettings.SOUND_MUSIC_VALUE / 100f : 0;
            voice.volume = GameSettings.SOUND_VOICE_ENABLE ? GameSettings.SOUND_VOICE_VALUE / 100f : 0;
        }
    }
}
```

`README.md`:

```md
# Arknights
[Unity] 明日方舟复刻源码 （不含资源）

### [视频演示](https://www.bilibili.com/video/BV15U4y1H7LX)

```

`Settings/GameSettings.cs`:

```cs
using Tools;

namespace Settings {
    public class GameSettings {
        public const string CHAR_META_PATH = @"Meta/Char";
        
        public const string MONSTER_META_PATH = @"Meta/Monster";
        
        public const string DUNGEON_META_PATH = @"Meta/Dungeon";

        public const string ITEM_META_PATH = @"Meta/Item";

        public const string UI_PREFAB_PATH = @"Prefab/UI";

        public static bool GAME_KEEP_SPEED = true;
        
        public static bool GAME_PERFORMANCE = false;
        
        public static int GAME_PROFILED_SCREEN = 0;
        
        public static bool SOUND_SOUND_EFFECT_ENABLE = true;
        
        public static int SOUND_SOUND_EFFECT_VALUE = 100;
        
        public static bool SOUND_MUSIC_ENABLE = true;
        
        public static int SOUND_MUSIC_VALUE = 100;
        
        public static bool SOUND_VOICE_ENABLE = true;
        
        public static int SOUND_VOICE_VALUE = 100;
    }
}
```

`UI/RuaUI.cs`:

```cs
using System;
using Manager;
using Tools;
using XLua;

namespace UI {

    [CSharpCallLua]
    public class RuaUI : UIBase { // LUA脚本启动器
        public Injection[] injections;

        private static LuaEnv luaEnv;
        private static LuaEnv LuaEnv => luaEnv ?? (luaEnv = LuaEnvManager.Inst().LuaEnv());
        
        private LuaTable scriptEnv;
        private Action luaUpdate;
        private Action luaUpdateView;
        private Action luaShow;
        private Action<bool> luaHide;


        public override void Init() { // 初始化
            scriptEnv = LuaEnv.NewTable();
            LuaTable meta = LuaEnv.NewTable();
            meta.Set("__index", LuaEnv.Global); //设置元表
            scriptEnv.SetMetaTable(meta);
            meta.Dispose();
            
            scriptEnv.Set("self", this);
            foreach (Injection injection in injections) {//带入脚本变量
                scriptEnv.Set(injection.name, injection.value);
            }
            LuaEnv.DoString(LuaEnvManager.LoadLuaText("UI." + Name), "chunk", scriptEnv);
            
            scriptEnv.Get("update", out luaUpdate);
            scriptEnv.Get("updateView", out luaUpdateView);
            scriptEnv.Get("show", out luaShow);
            scriptEnv.Get("hide", out luaHide);
            scriptEnv.Get<Action>("init")?.Invoke();
        }


        private void Update() { //更新
            luaUpdate?.Invoke();
        }


        public override void UpdateView() { //更新
            luaUpdateView?.Invoke();
        }

        public override void Show() {
            luaShow?.Invoke();
        }

        public override void Hide(bool destroy = false) {
            if (luaHide != null)
                luaHide(destroy);
            else {
                base.Hide(destroy);
            }
        }


        public LuaTable GetScriptEnv() => scriptEnv;
        public void BaseShow() => base.Show(); // lua层无法调用被覆盖的父类方法
        public void BaseHide(bool destroy = false) => base.Hide(destroy); // lua层无法调用被覆盖的父类方法
    }
}
```

`UI/Sub/CharInfoUI.cs`:

```cs
using System;
using System.Collections.Generic;
using System.Linq;
using Data;
using Data.Char;
using Data.Player;
using DG.Tweening;
using UnityEngine;
using UnityEngine.EventSystems;
using UnityEngine.UI;
using Object = UnityEngine.Object;

namespace UI.Sub {
    public class CharInfoUI : UIBase, IPointerDownHandler, IPointerUpHandler {
        public RectTransform prefab;
        public Transform professionHelp;

        private bool dragging;
        private float moveLocal = 0.5f;
        private string[] list;
        private PlayerData playerData;
        private ScrollRect scrollRect;
        private Transform[] prefabs = new Transform[3];
        private LinkedList<CharPrefab> charPrefabs = new LinkedList<CharPrefab>();

        public override void Init() {
            scrollRect = GetComponent<ScrollRect>();
            playerData = PlayerManager.Inst().Get();
            prefab.sizeDelta = UIManager.Inst().GetCanvasSize();
            for (int i = 0; i < 3; i++) {
                prefabs[i] = Instantiate(prefab, prefab.parent);
                prefabs[i].gameObject.name = "CharPrefabs_" + i;
                charPrefabs.AddLast(new CharPrefab(prefabs[i]));
            }
            prefab.gameObject.SetActive(false);

            CanvasGroup professionHelp_canvasGroup = professionHelp.GetComponent<CanvasGroup>();
            Button professionHelp_button = professionHelp.GetComponent<Button>();
            professionHelp_button.onClick.AddListener(() => { professionHelp_canvasGroup.DOFade(0, 0.3f).OnComplete(() => { professionHelp.gameObject.SetActive(false); }); });
            foreach (Transform prefab in prefabs) {
                prefab.GetComponent<Button>("CharInfoPanel/LowerLeftPanel/img_profession").onClick.AddListener(() => {
                    professionHelp.gameObject.SetActive(true);
                    professionHelp_canvasGroup.alpha = 0;
                    professionHelp_canvasGroup.DOFade(1, 0.3f).OnComplete(() => { professionHelp_button.enabled = true; });
                });
            }
        }

        public static void ShowSingle(string value) {
            CharInfoUI ui = UIManager.Inst().Show("CharInfoUI") as CharInfoUI;
            ui.list = new[] {value};
            ui.charPrefabs.ElementAt(0).SetData(ui.playerData.GetCharData(value));
            ui.charPrefabs.ElementAt(1).transform.gameObject.SetActive(false);
            ui.charPrefabs.ElementAt(2).transform.gameObject.SetActive(false);
        }
        
        public static void Show(string[] list, int index) {
            CharInfoUI ui = UIManager.Inst().Show("CharInfoUI") as CharInfoUI;
            ui.list = list;
            index = (index == 0 ? list.Length : index) - 1;
            for (int i = 0; i < 3; i++, index = Math.Abs(index + 1) % list.Length) {
                CharPrefab cp = ui.charPrefabs.ElementAt(i);
                cp.index = index;
                cp.SetData(ui.playerData.GetCharData(list[index]));
                cp.transform.gameObject.SetActive(true);
            }
            ui.scrollRect.enabled = list.Length != 1;
        }

        public override void Show() {
            base.Show();
            canvasGroup.alpha = 0;
            canvasGroup.DOFade(1, 0.3f);
        }

        public override void Hide(bool destroy = false) {
            canvasGroup.DOFade(0, 0.2f).OnComplete(() => { base.Hide(destroy); });
        }

        // 按下
        public void OnPointerDown(PointerEventData eventData) {
            dragging = true;
        }

        // 松开 获得向量 + 滑轮位置，计算需要去到的位置
        public void OnPointerUp(PointerEventData eventData) {
            dragging = false;
            float normalizedPosition = scrollRect.horizontalNormalizedPosition;
            moveLocal = normalizedPosition < 0.3 ? 0 : normalizedPosition > 0.7 ? 1 : 0.5f;
            if (moveLocal == 0.5) {
                if (scrollRect.velocity.x > 200) {
                    moveLocal = 0;
                } else if (scrollRect.velocity.x < -200) {
                    moveLocal = 1;
                }
            }
            scrollRect.velocity = Vector2.zero;
        }

        // 检测是否为松开，松开则向量插值到要去的位置，与位置距离0.2以内时修改CharPrefab层级+数据
        private void Update() {
            foreach (CharPrefab charPrefab in charPrefabs) {
                charPrefab.canvasGroup.alpha = Mathf.Clamp(1 - Mathf.Abs(charPrefab.transform.position.x) / 200, 0.2f, 1);
            }
            if (!dragging) {
                scrollRect.horizontalNormalizedPosition = Mathf.Lerp(scrollRect.horizontalNormalizedPosition, moveLocal, Time.deltaTime * 8f);
                if (moveLocal != 0.5 && Mathf.Abs(moveLocal - scrollRect.horizontalNormalizedPosition) < 0.2) {
                    CharPrefab c;
                    if (moveLocal == 0) {
                        c = charPrefabs.Last.Value;
                        c.transform.SetAsFirstSibling();
                        c.index = (charPrefabs.First.Value.index == 0 ? list.Length : charPrefabs.First.Value.index) - 1;
                        charPrefabs.RemoveLast();
                        charPrefabs.AddFirst(c);
                        moveLocal = 0.5f;
                        scrollRect.horizontalNormalizedPosition = 0.5f + scrollRect.horizontalNormalizedPosition;
                    } else {
                        c = charPrefabs.First.Value;
                        c.transform.SetAsLastSibling();
                        c.index = Math.Abs(charPrefabs.Last.Value.index + 1) % list.Length;
                        charPrefabs.RemoveFirst();
                        charPrefabs.AddLast(c);
                        moveLocal = 0.5f;
                        scrollRect.horizontalNormalizedPosition = 0.5f - (1 - scrollRect.horizontalNormalizedPosition);
                    }
                    c.SetData(playerData.GetCharData(list[c.index]));
                }
            }
        }

        public class CharPrefab {//角色面板
            internal RectTransform transform;
            internal CanvasGroup canvasGroup;
            internal int index;
            internal CharData charData;

            private Text txt_health;
            private Text txt_atk;
            private Text txt_def;
            private Text txt_magic_resistance;
            private Text txt_respawn_time;
            private Text txt_cost;
            private Text txt_block;
            private Text txt_atk_speed;
            private Image img_health_percentage;
            private Image img_atk_percentage;
            private Image img_def_percentage;
            private Image img_magic_resistance_percentage;

            private Button btn_add_exp;
            private Text txt_level;
            private Text txt_max_level;
            private Text txt_exp;
            private Image img_exp_percentage;

            private Image img_elite;
            private Button btn_add_elite;

            private List<Transform> talents = new List<Transform>();

            public CharPrefab(Transform transform) {
                transform.gameObject.SetActive(true);
                this.transform = transform as RectTransform;
                canvasGroup = transform.GetComponent<CanvasGroup>();

                txt_health = transform.GetComponent<Text>("CharInfoPanel/MiddleLeftPanel/Health/txt_value");
                txt_atk = transform.GetComponent<Text>("CharInfoPanel/MiddleLeftPanel/Atk/txt_value");
                txt_def = transform.GetComponent<Text>("CharInfoPanel/MiddleLeftPanel/Def/txt_value");
                txt_magic_resistance = transform.GetComponent<Text>("CharInfoPanel/MiddleLeftPanel/MagicResistance/txt_value");
                txt_respawn_time = transform.GetComponent<Text>("CharInfoPanel/MiddleLeftPanel/RespawnTime/txt_value");
                txt_cost = transform.GetComponent<Text>("CharInfoPanel/MiddleLeftPanel/Cost/txt_value");
                txt_block = transform.GetComponent<Text>("CharInfoPanel/MiddleLeftPanel/Block/txt_value");
                txt_atk_speed = transform.GetComponent<Text>("CharInfoPanel/MiddleLeftPanel/AtkSpeed/txt_value");
                img_health_percentage = transform.GetComponent<Image>("CharInfoPanel/MiddleLeftPanel/Health/img_ground/img_value_percentage");
                img_atk_percentage = transform.GetComponent<Image>("CharInfoPanel/MiddleLeftPanel/Atk/img_ground/img_value_percentage");
                img_def_percentage = transform.GetComponent<Image>("CharInfoPanel/MiddleLeftPanel/Def/img_ground/img_value_percentage");
                img_magic_resistance_percentage = transform.GetComponent<Image>("CharInfoPanel/MiddleLeftPanel/MagicResistance/img_ground/img_value_percentage");

                btn_add_exp = transform.GetComponent<Button>("CharInfoPanel/RightPanel/Level");
                txt_level = transform.GetComponent<Text>("CharInfoPanel/RightPanel/Level/txt_level");
                txt_max_level = transform.GetComponent<Text>("CharInfoPanel/RightPanel/Level/txt_max_level");
                txt_exp = transform.GetComponent<Text>("CharInfoPanel/RightPanel/Level/Image/txt_exp");
                img_exp_percentage = transform.GetComponent<Image>("CharInfoPanel/RightPanel/Level/img_exp_ground/img_exp_percentage");

                img_elite = transform.GetComponent<Image>("CharInfoPanel/RightPanel/Elite/img_elite");
                btn_add_elite = transform.GetComponent<Button>("CharInfoPanel/RightPanel/Elite");
            }

            public void SetData(CharData data) {
                charData = data;
                init();
            }

            public void init() {
                CharMeta meta = charData.GetCharMeta();
                transform.GetComponent<Image>("img_char").sprite = meta.GetImage();
                transform.GetComponent<Image>("img_camp").sprite = CharManager.Inst().GetCampImage(meta.getCamp().ToString());

                transform.GetComponent<Text>("CharInfoPanel/MiddleLeftPanel/Trust/txt_trust_percentage").text = charData.GetTrust() + "%";
                transform.GetComponent<Image>("CharInfoPanel/MiddleLeftPanel/Trust/img_trust_percentage").fillAmount = charData.GetTrust() / 200f;
                transform.GetComponent<Image>("CharInfoPanel/LowerLeftPanel/img_rarity").sprite = CharManager.Inst().GetStarImage("info_" + meta.GetRarity());
                transform.GetComponent<Text>("CharInfoPanel/LowerLeftPanel/txt_english_name").text = meta.GetEnglishName();
                transform.GetComponent<Text>("CharInfoPanel/LowerLeftPanel/txt_chinese_name").text = meta.GetChineseName();
                transform.GetComponent<Image>("CharInfoPanel/LowerLeftPanel/img_profession").sprite = CharManager.Inst().GetProfessionImage(meta.GetProfession());
                transform.GetComponent<Text>("CharInfoPanel/LowerLeftPanel/img_tag_ground/txt_tag").text = meta.GetTags().Aggregate(" ", (current, charTag) => current + (charTag.GetName() + " "));
                transform.GetComponent<Text>("CharInfoPanel/LowerLeftPanel/img_position_ground/txt_position").text = meta.GetPosition().GetName();

                btn_add_exp.onClick.RemoveAllListeners();
                btn_add_exp.onClick.AddListener(() => { Debug.Log("click [add_exp] to: " + meta.GetChineseName()); });
                btn_add_elite.onClick.RemoveAllListeners();
                btn_add_elite.onClick.AddListener(() => { Debug.Log("click [add_elite] to: " + meta.GetChineseName()); });

                transform.GetComponent<Text>("CharInfoPanel/RightPanel/Feature/txt_feature").text = meta.GetFeature();
                Transform talentTran = transform.Find("CharInfoPanel/RightPanel/Talent/List/img_ground");
                foreach (Transform talent in talents) {
                    Destroy(talent.gameObject);
                }
                talents.Clear();
                foreach (string s in meta.GetTalent()) {
                    Transform talent = Object.Instantiate(talentTran, talentTran.parent);
                    talent.gameObject.SetActive(true);
                    talents.Add(talent);
                    talent.GetComponent<Text>("txt_talent").text = s;
                }
                update();
            }

            public void update() {
                CharAttribute charAttribute = charData.GetAttribute();
                txt_health.text = $"{charAttribute.GetMaxHealth():0}";
                txt_atk.text = $"{charAttribute.GetAtk():0}";
                txt_def.text = $"{charAttribute.GetDef():0}";
                txt_magic_resistance.text = $"{charAttribute.GetMagicResistance():0}";
                txt_respawn_time.text = charAttribute.GetRespawnTime() > 60 ? "慢" : charAttribute.GetRespawnTime() > 40 ? "中等" : "较快";
                txt_cost.text = $"{charAttribute.GetCost():0}";
                txt_block.text = $"{charAttribute.GetBlock():0}";
                txt_atk_speed.text = charAttribute.GetAtkSpeed() >= 1.6 ? "慢" : charAttribute.GetAtkSpeed() >= 1.2 ? "较慢" : charAttribute.GetAtkSpeed() >= 1 ? "中等" : charAttribute.GetAtkSpeed() >= 0.8 ? "快" : "非常快";

                img_health_percentage.fillAmount = charAttribute.GetMaxHealth() / 5000;
                img_atk_percentage.fillAmount = charAttribute.GetAtk() / 1000;
                img_def_percentage.fillAmount = charAttribute.GetDef() / 1000;
                img_magic_resistance_percentage.fillAmount = charAttribute.GetMagicResistance() / 100;

                txt_level.text = $"{charData.GetLevel()}";
                txt_max_level.text = $"{charData.GetMaxLevel()}";
                txt_exp.text = $"<color=#EECB04>{charData.GetExp()}</color>/{charData.GetMaxExp()}";
                img_exp_percentage.fillAmount = (float) charData.GetExp() / charData.GetMaxExp();

                img_elite.sprite = CharManager.Inst().GetCharEliteImage("big_" + charData.GetElite());
            }
        }
    }
}
```

`UI/Sub/CharSelectUI.cs`:

```cs
using System.Collections.Generic;
using System.Linq;
using Data.Char;
using Data.Player;
using DG.Tweening;
using UnityEngine;
using UnityEngine.UI;

namespace UI.Sub {
    public class CharSelectUI : UIBase {

        private PlayerData data;
        private string initialSelect;
        private string currentSelect;
        private List<CharCard> list;

        private Transform prefab;
        private RectTransform leftPanel;
        private RectTransform upPanel;
        private RectTransform downPanel;
        private CanvasGroup infoGroup;
        private Text char_name;
        private Text char_level;
        private Text char_health;
        private Text char_atk;
        private Text char_def;
        private Text char_magic_resistance;
        private Text char_respawn_time;
        private Text char_cost;
        private Text char_block;
        private Text char_atk_speed;
        private Toggle sort_rarity;
        private Toggle sort_level;

        public override void Init() {
            list = new List<CharCard>();
            prefab = transform.Find("RightPanel/ItemList/CharPrefab");
            leftPanel = transform.Find("LeftPanel") as RectTransform;
            upPanel = transform.Find("UpPanel") as RectTransform;
            downPanel = transform.Find("DownPanel") as RectTransform;
            infoGroup = leftPanel.GetComponent<CanvasGroup>("INFO");
            char_name = leftPanel.GetComponent<Text>("INFO/CharName");
            char_level = leftPanel.GetComponent<Text>("INFO/CharLevel");
            char_health = leftPanel.GetComponent<Text>("INFO/Attribute/health/Value");
            char_atk = leftPanel.GetComponent<Text>("INFO/Attribute/atk/Value");
            char_def = leftPanel.GetComponent<Text>("INFO/Attribute/def/Value");
            char_magic_resistance = leftPanel.GetComponent<Text>("INFO/Attribute/magic_resistance/Value");
            char_respawn_time = leftPanel.GetComponent<Text>("INFO/Attribute/respawn_time/Value");
            char_cost = leftPanel.GetComponent<Text>("INFO/Attribute/cost/Value");
            char_block = leftPanel.GetComponent<Text>("INFO/Attribute/block/Value");
            char_atk_speed = leftPanel.GetComponent<Text>("INFO/Attribute/atk_speed/Value");
            sort_rarity = upPanel.GetComponent<Toggle>("Sort/tog_rarity");
            sort_level = upPanel.GetComponent<Toggle>("Sort/tog_level");

            // 提升等级(打开干员详情UI)
            leftPanel.GetComponent<Button>("CharInfoButton").onClick.AddListener(() => {
                if (data.GetCharData(currentSelect) != null) {
                    CharInfoUI.ShowSingle(currentSelect);
                }
            });

            // 确认替换(保存并关闭CharSelectUI、刷新SquadUI)
            downPanel.GetComponent<Button>("OKButton").onClick.AddListener(() => {
                // 防止连击
                if (state != UIState.Show) return;
                CharData charData = data.GetCharData(initialSelect);
                for (int i = 0; i < data.GetSquad().Length; i++) {
                    if (charData == null && !string.IsNullOrEmpty(data.GetSquad()[i])) continue;
                    if (charData != null && data.GetSquad()[i] != charData.GetId()) continue;
                    data.GetSquad()[i] = currentSelect;
                    Hide("CharSelectUI");
                    UIManager.Inst().Update("SquadUI");
                    break;
                }
            });
            // 排序
            sort_level.onValueChanged.AddListener(boo => {
                if (!boo) return;
                list.Sort(SortLevel);
                UpdateView();
            });
            sort_rarity.onValueChanged.AddListener(boo => {
                if (!boo) return;
                list.Sort(SortRarity);
                UpdateView();
            });
        }

        public int SortLevel(CharCard a, CharCard b) {
            if (a.transform.gameObject.activeSelf && b.transform.gameObject.activeSelf) {
                if (a.data.GetId() == currentSelect) return 1;
                if (b.data.GetId() == currentSelect) return -1;
                if (a.data.GetElite() == b.data.GetElite()) {
                    if (a.data.GetLevel() == b.data.GetLevel()) {
                        return a.data.GetExp().CompareTo(b.data.GetExp());
                    }
                    return a.data.GetLevel().CompareTo(b.data.GetLevel());
                }
                return a.data.GetElite().CompareTo(b.data.GetElite());
            }
            return a.transform.gameObject.activeSelf.CompareTo(!b.transform.gameObject.activeSelf);
        }

        public int SortRarity(CharCard a, CharCard b) {
            if (a.transform.gameObject.activeSelf && b.transform.gameObject.activeSelf) {
                if (a.data.GetId() == currentSelect) return 1;
                if (b.data.GetId() == currentSelect) return -1;
                return a.data.GetCharMeta().GetRarity().CompareTo(b.data.GetCharMeta().GetRarity());
            }
            return a.transform.gameObject.activeSelf.CompareTo(!b.transform.gameObject.activeSelf);
        }

        public override void UpdateView() {
            foreach (CharCard charCard in list) {
                charCard.transform.SetAsFirstSibling();
                charCard.select.gameObject.SetActive(charCard.transform.gameObject.activeSelf && charCard.data.GetId() == currentSelect);
            }
            infoGroup.DOFade(0.3f, 0.1f).OnComplete(() => {
                CharData charData = data.GetCharData(currentSelect);
                if (charData != null) {
                    char_name.text = charData.GetCharMeta().GetChineseName();
                    char_level.text = $"<color=#008BB9>{charData.GetLevel()}</color><size=80>/{charData.GetMaxLevel()}</size>";
                    char_health.text = charData.GetAttribute().GetMaxHealth().ToString();
                    char_atk.text = charData.GetAttribute().GetAtk().ToString();
                    char_def.text = charData.GetAttribute().GetDef().ToString();
                    char_magic_resistance.text = charData.GetAttribute().GetMagicResistance().ToString();
                    char_respawn_time.text = charData.GetAttribute().GetRespawnTime().ToString();
                    char_cost.text = charData.GetAttribute().GetCost().ToString();
                    char_block.text = charData.GetAttribute().GetBlock().ToString();
                    char_atk_speed.text = charData.GetAttribute().GetAtkSpeed().ToString();
                } else {
                    char_name.text = "--";
                    char_level.text = "<color=#008BB9>-</color>/-";
                    char_health.text = "--";
                    char_atk.text = "--";
                    char_def.text = "--";
                    char_magic_resistance.text = "--";
                    char_respawn_time.text = "--";
                    char_cost.text = "--";
                    char_block.text = "--";
                    char_atk_speed.text = "--";
                }
                infoGroup.DOFade(1f, 0.1f);
            });
        }

        public static void Show(string select) {
            CharSelectUI ui = UIManager.Inst().Show("CharSelectUI") as CharSelectUI;
            ui.data = PlayerManager.Inst().Get();
            ui.initialSelect = select;
            ui.currentSelect = select;
            List<CharData> dataList = new List<CharData>(ui.data.GetCharList()).FindAll(d => !ui.data.GetSquad().Contains(d.GetId()) || d.GetId() == select);
            for (int i = 0; i < dataList.Count || i < ui.list.Count; i++) {
                if (i < dataList.Count) {
                    if (ui.list.Count <= i) {
                        ui.list.Add(new CharCard(ui, Instantiate(ui.prefab, ui.prefab.parent)));
                    }
                    CharCard card = ui.list[i];
                    card.SetData(dataList[i]);
                }
                ui.list[i].transform.gameObject.SetActive(i < dataList.Count);
            }
            if (ui.sort_level.isOn) {
                ui.list.Sort(ui.SortLevel);
            } else {
                ui.list.Sort(ui.SortRarity);
            }
            ui.UpdateView();
        }

        public override void Show() {
            base.Show();
            leftPanel.anchoredPosition = new Vector2(-300, 0);
            leftPanel.DOAnchorPosX(0, 0.4f);
            upPanel.anchoredPosition = new Vector2(0, 120);
            upPanel.DOAnchorPosY(0, 0.3f).SetDelay(0.1f);
            downPanel.anchoredPosition = new Vector2(0, -120);
            downPanel.DOAnchorPosY(0, 0.3f).SetDelay(0.1f);
            canvasGroup.alpha = 0;
            canvasGroup.DOFade(1, 0.3f);
            
            
        }

        public override void Hide(bool destroy = false) {
            leftPanel.DOAnchorPosX(-300, 0.4f);
            upPanel.DOAnchorPosY(120, 0.3f).SetDelay(0.1f);
            downPanel.DOAnchorPosY(-120, 0.3f).SetDelay(0.1f);
            canvasGroup.DOFade(0, 0.3f).SetDelay(0.1f).OnComplete(() => { base.Hide(destroy); });
        }

        public class CharCard {
            private CharSelectUI ui;
            internal Transform transform;
            internal Transform select;
            internal CharData data;

            private Text name;
            private Text level;
            private Image expPercentage;
            private Image charCard;
            private Image rarity1;
            private Image rarity2;
            private Image rarity3;
            private Image rarity4;
            private Image rarityStar;
            private Image profession;
            private Image eliteImage;

            public CharCard(CharSelectUI ui, Transform transform) {
                this.ui = ui;
                this.transform = transform;
                transform.gameObject.SetActive(true);
                select = transform.Find("img_select");
                name = transform.GetComponent<Text>("txt_name");
                level = transform.GetComponent<Text>("txt_level");
                expPercentage = transform.GetComponent<Image>("img_exp_ground/img_exp_percentage");
                charCard = transform.GetComponent<Image>("img_char_card");
                rarity1 = transform.GetComponent<Image>("img_rarity_1");
                rarity2 = transform.GetComponent<Image>("img_rarity_2");
                rarity3 = transform.GetComponent<Image>("img_rarity_3");
                rarity4 = transform.GetComponent<Image>("img_rarity_4");
                rarityStar = transform.GetComponent<Image>("img_rarity_star");
                profession = transform.GetComponent<Image>("img_profession");
                eliteImage = transform.GetComponent<Image>("img_elite");
                transform.GetComponent<Button>().onClick.AddListener(OnClick);
            }

            public void SetData(CharData data) {
                transform.gameObject.SetActive(data != null);
                if (data != null && this.data != data) {
                    CharMeta charMeta = data.GetCharMeta();
                    int rarity = charMeta.GetRarity();
                    name.text = charMeta.GetChineseName();
                    charCard.sprite = charMeta.GetCharImage();
                    rarity1.sprite = CharManager.Inst().GetCardGroundImage(rarity + "_1");
                    rarity2.sprite = CharManager.Inst().GetCardGroundImage(rarity + "_2");
                    rarity3.sprite = CharManager.Inst().GetCardGroundImage(rarity + "_3");
                    rarity4.sprite = CharManager.Inst().GetCardGroundImage(rarity + "_4");
                    rarityStar.sprite = CharManager.Inst().GetCardGroundImage(rarity + "_star");
                    profession.sprite = CharManager.Inst().GetProfessionSmallImage(charMeta.GetProfession());
                }
                this.data = data;
                if (data != null) Update();
            }

            public void Update() {
                level.text = data.GetLevel().ToString();
                expPercentage.fillAmount = data.GetExp() / (float) data.GetMaxExp();
                eliteImage.gameObject.SetActive(data.GetElite() > 0);
                if (data.GetElite() > 0) {
                    eliteImage.sprite = CharManager.Inst().GetCharEliteImage("card_" + data.GetElite());
                }
            }

            private void OnClick() {
                ui.currentSelect = ui.currentSelect == data.GetId() ? null : data.GetId();
                ui.UpdateView();
            }
        }
    }
}
```

`UI/Sub/CommonDialogUI.cs`:

```cs
using System;
using DG.Tweening;
using UnityEngine;
using UnityEngine.Events;
using UnityEngine.UI;

namespace UI.Sub {
    public class CommonDialogUI : UIBase {

        public Image blur;

        public GameObject blackGround;
        public GameObject whiteGround;

        public Text message;

        public GameObject mode_One;
        public GameObject mode_Two;
        
        public Button mode_One_back;
        
        public Button mode_Two_enter;
        public Button mode_Two_back;

        private GroundType type;
        private Mode mode;
        
        public override void Show() {
            base.Show();
            
            Material blurryShader = blur.material;
            blurryShader.SetFloat("_Size",0);
            float value = 0;
            DOTween.To(() => value,v => value = v,160,0.5f).OnUpdate(() => blurryShader.SetFloat("_Size", value));
            
            canvasGroup.alpha = 0;
            canvasGroup.DOFade(1,0.3f).OnComplete(() => {
                mode_One_back.onClick.AddListener(() => UIManager.Inst().Hide(Name));
                mode_Two_back.onClick.AddListener(() => UIManager.Inst().Hide(Name));
                mode_Two_enter.onClick.AddListener(() => UIManager.Inst().Hide(Name));
            });
        }

        public override void Hide(bool destroy = false) {
            mode_One_back.onClick.RemoveAllListeners();
            mode_Two_back.onClick.RemoveAllListeners();
            mode_Two_enter.onClick.RemoveAllListeners();
            Material blurryShader = blur.material;
            float value = blurryShader.GetFloat("_Size");
            DOTween.To(() => value,v => value = v,0,0.2f).OnUpdate(() => blurryShader.SetFloat("_Size", value));
            canvasGroup.DOFade(0,0.2f).OnComplete(() => {
                blackGround.SetActive(false);
                whiteGround.SetActive(false);
                mode_Two.SetActive(false);
                mode_One.SetActive(false);
                base.Hide(destroy);
            });
        }

        public static CommonDialogUI Message(GroundType type,string message) {
            CommonDialogUI ui = UIManager.Inst().Show("CommonDialogUI") as CommonDialogUI;
            ui.Initialization(type, Mode.ONE, message);
            return ui;
        }

        public static CommonDialogUI Message(GroundType type,string message, UnityAction enterMethod) {
            CommonDialogUI ui = UIManager.Inst().Show("CommonDialogUI") as CommonDialogUI;
            ui.Initialization(type, Mode.TWO, message);
            ui.mode_Two_enter.onClick.AddListener(enterMethod);
            return ui;
        }

        private void Initialization(GroundType type, Mode mode, string message) {
            this.type = type;
            this.mode = mode;
            this.message.color = GetText();
            this.message.text = message;
            GetGround().SetActive(true);
            GetMode().SetActive(true);
        }

        public void AddBackListener(UnityAction method) {
            GetBackButton().onClick.AddListener(method);
        }

        private GameObject GetGround() {
            return type == GroundType.WHITE ? whiteGround : blackGround;
        }

        private Color GetText() {
            return type == GroundType.WHITE ? Color.black : Color.white;
        }

        private GameObject GetMode() {
            return mode == Mode.ONE ? mode_One : mode_Two;
        }

        private Button GetBackButton() {
            return mode == Mode.ONE ? mode_One_back : mode_Two_back;
        }

        private Button GetEnterButton() {
            return mode == Mode.TWO ? mode_Two_enter : null;
        }

        public enum GroundType {
            WHITE,
            BLACK
        }

        public enum Mode {
            ONE,
            TWO
        }
    }
}
```

`UI/Sub/GameLoseUI.cs`:

```cs
using DG.Tweening;
using Manager;
using Tools;
using UnityEngine;
using UnityEngine.UI;

namespace UI.Sub {
    public class GameLoseUI : UIBase {
        
        public Image blur;

        private Tweener tweener;

        public override void Init() {
            blur = GetComponent<Image>();
        }
        
        public override void Show() {
            base.Show();
            Material blurryShader = blur.material;
            blurryShader.SetFloat("_Size",0);
            float value = 0;
            DOTween.To(() => value,v => value = v,160,0.8f).OnUpdate(() => blurryShader.SetFloat("_Size",value)).OnComplete(() => {
                GetComponent<Button>().onClick.AddListener(Click);
            });
            canvasGroup.alpha = 0;
            canvasGroup.DOFade(1,0.6f);

            tweener = transform.GetComponent<Text>("Text").DOFade(0.4f, 1f).SetLoops(-1, LoopType.Yoyo);
        }

        public override void Hide(bool destroy = false) {
            GetComponent<Button>().onClick.RemoveListener(Click);
            Material blurryShader = blur.material;
            float value = blurryShader.GetFloat("_Size");
            DOTween.To(() => value,v => value = v,0,0.5f).OnUpdate(() => blurryShader.SetFloat("_Size",value));
            canvasGroup.DOFade(0,0.5f).OnComplete(() => { {base.Hide(destroy);} });
            tweener.Kill();
        }

        public void Click() {
            UIManager.Inst().Hide("GameLoseUI", true);
            UIManager.Inst().Hide("GameUI", true);
            Delay.add(() => UIManager.Inst().Show("HomeUI"), 2);
        }
    }
}
```

`UI/Sub/GameUI.cs`:

```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Globalization;
using System.Linq;
using Data.Char;
using Data.Player;
using DG.Tweening;
using Manager;
using Script.Event;
using Scripts.Game;
using Scripts.Game.Event;
using Spine.Unity;
using Tools;
using UnityEngine;
using UnityEngine.EventSystems;
using UnityEngine.UI;
using Char = Scripts.Game.Char;
using EventHandler = Script.Event.EventHandler;
using EventSystem = Script.Event.EventSystem;

namespace UI.Sub {
    public class GameUI : UIBase, Listener {
        private static Vector2 screenScale;
        
        public Sprite[] professions;

        internal PlayerData data;
        internal Dungeon dungeon;

        private Transform healthBarPrefab;
        private Transform cardPrefab;

        private Toggle tog_speed;
        private Text txt_killMonsterAndMax;
        private Text txt_health;
        private Text txt_cost;
        private Transform tra_cost_float;
        internal PlacePanel placePanel;
        internal List<CharCard> charList;
        internal List<HealthBar> barList;

        private Image blackGround;

        public override void Init() {
            charList = new List<CharCard>();
            barList = new List<HealthBar>();
            healthBarPrefab = transform.Find("HealthBarList/HealthBarPrefab");
            cardPrefab = transform.Find("CharList/CharPrefab");
            txt_killMonsterAndMax = transform.GetComponent<Text>("Title/KillMonsterValue");
            txt_health = transform.GetComponent<Text>("Title/HealthValue");
            txt_cost = transform.GetComponent<Text>("CostPanel/Value");
            tra_cost_float = transform.Find("CostPanel/ValueFloat");

            healthBarPrefab.gameObject.SetActive(false);
            cardPrefab.gameObject.SetActive(false);
            cardPrefab.gameObject.AddComponent<CharCard>();

            placePanel = transform.Find("PlacePanel/Plate/Handle").gameObject.AddComponent<PlacePanel>();
            blackGround = transform.GetComponent<Image>("BlackGround");
            //变速
            tog_speed = transform.GetComponent<Toggle>("SpeedToggle");
            Image speed1 = tog_speed.transform.GetComponent<Image>("Speed1");
            Image speed2 = tog_speed.transform.GetComponent<Image>("Speed2");
            speed2.gameObject.SetActive(false);
            tog_speed.onValueChanged.AddListener(boo => {
                speed1.gameObject.SetActive(!boo);
                speed2.gameObject.SetActive(boo);
                tog_speed.graphic = boo ? speed2 : speed1;
                Time.timeScale = boo ? 2 : 1;
            });
            
            //返回
            transform.GetComponent<Button>("BackButton").onClick.AddListener(() => {
                CommonDialogUI.Message(CommonDialogUI.GroundType.BLACK, "确定要退出本场战斗?", () => {
                    UIManager.Inst().Hide("GameUI", true);
                    Delay.add(() => UIManager.Inst().Show("HomeUI"), 2);
                });
            });
            screenScale = UIManager.Inst().GetCanvasSize() / new Vector2(Screen.width, Screen.height);
        }

        public void Update() {
            if (dungeon) {
                txt_cost.text = Math.Floor(dungeon.cost).ToString(CultureInfo.InvariantCulture);
                tra_cost_float.localScale = new Vector3((float) (dungeon.cost - Math.Floor(dungeon.cost)), 1, 1);
                txt_killMonsterAndMax.text = $"{dungeon.skillAmount}/{dungeon.monsterSize}";
                txt_health.text = $"{dungeon.health}";
                foreach (HealthBar bar in barList.Where(bar => bar.transform)) {
                    bar.update();
                }
            }
        }
        
        [EventHandler]
        void OnCreateEvent(CreateEntityEvent e) {
            barList.Add(new HealthBar(Instantiate(healthBarPrefab, healthBarPrefab.parent), e.entity));
            if (!(e.entity is Char entity)) return;
            foreach (CharCard charCard in charList.Where(charCard => charCard.data.GetId() == entity.data.GetId())) {
                charCard.transform.gameObject.SetActive(false);
            }
        }

        [EventHandler]
        void OnRemoveEvent(RemoveEntityEvent e) {
            for (int i = 0; i < barList.Count; i++) {
                if (barList[i].entity != e.entity) continue;
                HealthBar bar = barList[i];
                barList.RemoveAt(i);
                bar.group.DOFade(0, 0.5f).OnComplete(() => {
                    Destroy(bar.transform.gameObject);
                });
                return;
            }
        }

        public override void Show() {
            base.Show();
            data = PlayerManager.Inst().Get();
            dungeon = Dungeon.inst;
            SoundManager.Inst().PlayMusic(GameManager.Inst().clip, false, () => { SoundManager.Inst().PlayMusic(GameManager.Inst().loop_clip, true); });
            foreach (string charID in data.GetSquad()) {
                CharData charData = data.GetCharData(charID);
                if (charData == null) continue;
                CharCard charCard = Instantiate(cardPrefab, cardPrefab.parent).GetComponent<CharCard>();
                charCard.gameObject.SetActive(true);
                charCard.Init(this, charData);
                charList.Add(charCard);
            }
            blackGround.gameObject.SetActive(true);
            blackGround.DOFade(0, 1f).SetDelay(1).OnComplete(() => {
                blackGround.gameObject.SetActive(false);
                dungeon.sa.Name = "Run";
            });
            
            EventSystem.Inst().AddListener(this);
        }

        public override void Hide(bool destroy = false) {
            EventSystem.Inst().RemoveListener(this);
            blackGround.gameObject.SetActive(true);
            SoundManager.Inst().StopMusic();
            blackGround.DOFade(1, 1f).OnComplete(() => {
                // 清理过期的骨骼
                foreach (CharCard charCard in charList.Where(charCard => charCard.place)) {
                    Destroy(charCard.place);
                }
                Destroy(Dungeon.inst.transform.gameObject);
                base.Hide(true);
            });
            
        }

        public Sprite GetProfessionSprite(CharProfession type) {
            return professions.FirstOrDefault(profession => profession.name == type.ToString());
        }

        public class HealthBar {
            internal Entity entity;
            internal RectTransform transform;
            internal CanvasGroup group;
            private Transform lerp;
            private Image health;
            
            public HealthBar(Transform transform, Entity entity) {
                transform.gameObject.SetActive(true);
                this.transform = transform as RectTransform;
                this.entity = entity;
                group = transform.GetComponent<CanvasGroup>();
                lerp = transform.Find("Lerp");
                health = transform.GetComponent<Image>("Health");
                health.color = Color.green;
            }

            public void update() {
                transform.anchoredPosition = (Dungeon.inst.camera.WorldToScreenPoint(entity.transform.position) - new Vector3(0, 50, 0)) * screenScale;
                float percentage = Mathf.Clamp(entity.health / entity.attribute.GetMaxHealth(), 0, 1);
                
                group.alpha = Mathf.Lerp(group.alpha, percentage == 1 ? 0 : 1, Time.deltaTime * 3);
                health.color = Color.Lerp(Color.red, Color.green, percentage);
                health.transform.localScale = new Vector3(percentage, 1, 1);
                lerp.localScale = new Vector3(Mathf.Lerp(lerp.localScale.x, percentage, Time.deltaTime * 3), 1, 1);
            }
        }
        
        // 放置面板：用于确认塔的方向
        public class PlacePanel : MonoBehaviour, IDragHandler, IPointerUpHandler, IPointerDownHandler {
            //界面
            private RectTransform panel;

            //盘子
            private RectTransform plate;

            //句柄
            private Transform handle;
            
            //Group
            private CanvasGroup group;

            //骨骼对象
            private Transform place;
            
            // 放置方块
            private Transform block;
            
            // 干员数据
            private CharData data;

            //距离
            private const short radius = 220;

            //最终点
            private Vector2 dir = Vector2.zero;

            private List<Transform> atkRangedisplays; 


            public void Awake() {
                plate = transform.parent as RectTransform;
                panel = plate.parent as RectTransform;
                handle = plate.Find("Handle");
                group = panel.GetComponent<CanvasGroup>();
                atkRangedisplays = new List<Transform>();
                
                panel.GetComponent<Button>("Cancel").onClick.AddListener(Cancel);
                panel.gameObject.SetActive(false);
            }

            public void Place(Transform place, Transform block, CharData data) {
                this.place = place;
                this.block = block;
                this.data = data;
                // 求关卡摄像机与block的相对rotation、屏幕坐标，赋值给transform；
                panel.gameObject.SetActive(true);
                group.alpha = 0;
                group.DOFade(1, 0.2f);
                Camera camera = Dungeon.inst.camera;
                Vector3 position = place.position;
                camera.transform.DOMove(Vector3.ClampMagnitude(position + new Vector3(-4.5f, 7, 1f) - camera.transform.position, 1), 0.3f).SetRelative(true).OnUpdate(() =>
                    panel.anchoredPosition = camera.WorldToScreenPoint(position) * screenScale);
            }

            public void Cancel() {
                dir = Vector2.zero;
                Vector3 position = place.position;
                clearAtkRange();
                Destroy(place.gameObject);
                handle.localPosition = Vector2.zero;
                group.DOFade(0, 0.2f).SetDelay(0.1f).OnComplete(() => { panel.gameObject.SetActive(false); });
                Camera camera = Dungeon.inst.camera;
                camera.transform.DOMove(Dungeon.inst.cameraPosition, 0.3f).OnUpdate(() => {
                    panel.anchoredPosition = camera.WorldToScreenPoint(position) * screenScale;
                });
            }

            public void OnDrag(PointerEventData eventData) {
                if (RectTransformUtility.ScreenPointToLocalPointInRectangle(plate, eventData.position, eventData.pressEventCamera, out Vector2 localPoint)) {
                    localPoint *= Math.Min(1, radius / (Math.Abs(localPoint.x) + Math.Abs(localPoint.y)));
                    if (dir != Vector2.zero) {
                        if (Vector2.Distance(dir, localPoint) > radius * 0.45f) {
                            dir = Vector2.zero;
                            // 清理预制体
                            clearAtkRange();
                        }
                    } else {
                        if (Math.Abs(localPoint.x) > radius * 0.7f) {
                            dir = new Vector2(localPoint.x > 0 ? radius : -radius, 0);
                        } else if (Math.Abs(localPoint.y) > radius * 0.7f) {
                            dir = new Vector2(0, localPoint.y > 0 ? radius : -radius);
                        }
                        if (dir != Vector2.zero) {
                            // 生成预制体
                            Vector3 position = block.position + new Vector3(0, 1, 0);
                            Quaternion rotation = Quaternion.Euler(90, 0, 0);
                            Quaternion qua = Quaternion.LookRotation(new Vector3(dir.y, 0, -dir.x));
                            foreach (Vector3 vector3 in data.GetCharMeta().GetAttackRange()) {
                                if (Physics.Raycast(position + qua * vector3, Vector3.down, out RaycastHit hitInfo, 4, 1 << LayerMask.NameToLayer("Ground"))) {
                                    atkRangedisplays.Add(Instantiate(GameManager.Inst().atkRangeDisplay, hitInfo.point + new Vector3(0, 0.1f, 0), rotation));
                                }
                            }
                        }
                    }
                    handle.localPosition = dir != Vector2.zero ? dir : localPoint;
                }
            }

            public void clearAtkRange() {
                foreach (Transform atkRangedisplay in atkRangedisplays) {
                    Destroy(atkRangedisplay.gameObject);
                }
                atkRangedisplays.Clear();
            }

            public void OnPointerUp(PointerEventData eventData) {
                if (dir == Vector2.zero) {
                    handle.localPosition = Vector2.zero;
                } else {
                    // 提示处理完毕
                    dir = dir.normalized;
                    Dungeon.inst.SpawnChar(block, data, new Vector3(dir.y, 0, -dir.x));
                    Cancel();
                }
            }

            public void OnPointerDown(PointerEventData eventData) { }
        }

        // 卡牌预制体：用来拖拽放置到场景中
        public class CharCard : MonoBehaviour, IDragHandler, IPointerDownHandler, IPointerUpHandler {
            private Image img_charImage;
            private Text txt_cost;
            private Image img_profession;
            internal CharData data;
            private GameObject black;

            private int cost;
            
            // 骨骼体
            internal Transform place;
            // 吸附方块
            private Transform block;
            private GameUI ui;

            private void Awake() {
                img_charImage = transform.GetComponent<Image>("Panel/CharImage");
                txt_cost = transform.GetComponent<Text>("Panel/Cost/Value");
                img_profession = transform.GetComponent<Image>("Panel/Profession");
                black = transform.Find("Panel/Black").gameObject;
            }

            public void Init(GameUI ui, CharData data) {
                //
                this.ui = ui;
                this.data = data;
                cost = data.GetAttribute().GetCost();
                img_charImage.sprite = data.GetCharMeta().GetAvatar();
                txt_cost.text = cost.ToString();
                img_profession.sprite = ui.GetProfessionSprite(data.GetCharMeta().GetProfession());
            }

            public void Update() {
                black.gameObject.SetActive(ui.dungeon.cost < cost);
            }

            // 操作行为：drag触发->检查是否在拖拽骨骼中->是#继续调整骨骼位置+选中当前目标/否#创建拖拽骨骼
            public void OnDrag(PointerEventData eventData) {
                // 检查是否存在骨骼
                if (!place) {
                    if (ui.dungeon.cost < data.GetAttribute().GetCost() || ui.placePanel.gameObject.activeInHierarchy) {
                        eventData.dragging = false;
                        return;
                    }
                    //TODO SELECT THIS
                    place = Instantiate(GameManager.Inst().charPlacePrefab);
                    SkeletonAnimation sa = place.GetComponent<SkeletonAnimation>("Model/Skeleton");
                    sa.skeletonDataAsset = data.GetCharMeta().GetSkeleton();
                    sa.Initialize(true);
                }
                Ray ray = ui.dungeon.camera.ScreenPointToRay(eventData.position);
                // 无block坐标时
                // 判断hitInfo.point 与 hit.collider 的距离是否 <0.5 && hitInfo.collider是否存在子物体， 是的话赋值block坐标， 不是的话不处理
                // 有block坐标时
                // 判断block坐标与hit.point 是否 > 0.75, 是的话block坐标置空
                // 判断
                if (Physics.Raycast(ray, out RaycastHit hitInfo, 15, 1 << LayerMask.NameToLayer("Ground"))) {
                    Collider collider = hitInfo.collider;
                    if (block) {
                        if (Vector3.Distance(block.position, hitInfo.point) > 0.6) {
                            block = null;
                        }
                    }
                    if (!block) {
                        if (hitInfo.collider.CompareTag(data.GetCharMeta().GetPosition().ToString())) {
                            if (Vector3.Distance(collider.transform.position, hitInfo.point) < 0.3 && collider.transform.childCount == 0) {
                                block = collider.transform;
                            }
                        }
                    }
                } else {
                    block = null;
                }

                if (block) {
                    place.position = block.position;
                } else {
                    place.position = ray.origin - (ray.origin.y - 0.3f) / ray.direction.y * ray.direction;
                }
            }

            public void OnPointerDown(PointerEventData eventData) { }

            // 卡池#抬起事件
            public void OnPointerUp(PointerEventData eventData) {
                // 检查是否存在拖拽体（骨骼）
                if (place) {
                    // 检查是否依附于方块
                    if (block) {
                        // 打开放置面板
                        ui.placePanel.Place(place, block, data);
                        place = null;
                    } else {
                        // 吹毁拖拽体
                        Destroy(place.gameObject);
                    }
                }
            }
        }
    }
}
```

`UI/Sub/GameWinUI.cs`:

```cs
using System;
using Data.Char;
using Data.Dungeon;
using Data.Player;
using DG.Tweening;
using Manager;
using Scripts.Game;
using Tools;
using UnityEngine;
using UnityEngine.UI;
using Random = System.Random;

namespace UI.Sub {
    public class GameWinUI : UIBase {
        private RectTransform do1;
        private RectTransform do2;
        private Image black;
        private Image blur;

        private Button panel;
        private Image charImage;

        public override void Init() {
            do1 = transform.Find("Do1") as RectTransform;
            do2 = transform.Find("Do2") as RectTransform;
            black = transform.GetComponent<Image>("Black");

            blur = transform.GetComponent<Image>();
            Material blurryShader = blur.material;
            blurryShader.SetFloat("_Size", 160);

            panel = transform.GetComponent<Button>("Panel");
            charImage = panel.transform.GetComponent<Image>("CharImage");
            panel.onClick.AddListener(() => {
                UIManager.Inst().Hide("GameWinUI", true);
                UIManager.Inst().Hide("GameUI", true);
                Delay.add(() => UIManager.Inst().Show("HomeUI"), 2);
            });
        }

        public override void Show() {
            base.Show();
            do1.gameObject.SetActive(true);
            do2.gameObject.SetActive(true);
            Vector2 do2AnchoredPosition = do2.anchoredPosition;
            do2AnchoredPosition.x = -2200;
            do2.anchoredPosition = do2AnchoredPosition;
            black.gameObject.SetActive(true);
            panel.gameObject.SetActive(false);
            blur.enabled = false;
            black.color = new Color(0, 0, 0, 0.0001f);
            do2.DOAnchorPosX(0, 0.6f).SetDelay(0.3f).OnComplete(() => {
                do2.DOAnchorPosX(2200, 0.6f).SetDelay(0.5f);
                black.DOFade(1, 0.4f).SetDelay(0.8f).OnComplete(() => {
                    do1.gameObject.SetActive(false);
                    do2.gameObject.SetActive(false);
                    blur.enabled = true;
                    //激活面板 获取Dungeon数据、刷新。
                    PlayerData playerData = PlayerManager.Inst().Get();
                    DungeonMeta dungeonMeta = Dungeon.inst.dungeonMeta;
                    CharData data;
                    do {
                        data = playerData.GetCharData(playerData.GetSquad()[new Random().Next(playerData.GetSquad().Length)]);
                    } while (data == null);
                    charImage.sprite = data.GetCharMeta().GetImage();
                    panel.transform.GetComponent<Text>("DownPanel/ID").text = dungeonMeta.GetId();
                    panel.transform.GetComponent<Text>("DownPanel/Name").text = dungeonMeta.GetName();
                    panel.gameObject.SetActive(true);
                    charImage.color = new Color(1, 1, 1, 0);
                    black.DOFade(0, 0.4f).OnComplete(() => {
                        black.gameObject.SetActive(false);
                        charImage.DOFade(1, 0.7f);
                    });
                });
            });
        }

        public override void Hide(bool destroy = false) {
            black.gameObject.SetActive(true);
            black.DOFade(1, 1.2f).OnComplete(() => { base.Hide(destroy); });
        }
    }
}
```

`UI/Sub/HouseUI.cs`:

```cs
using System.Collections.Generic;
using Data.Item;
using Data.Player;
using DG.Tweening;
using UnityEngine;
using UnityEngine.UI;

namespace UI.Sub {
    public class HouseUI : UIBase {

        public Toggle ALL;
        public Toggle JI_CHU;
        public Toggle YANG_CHENG;
        public ItemIconComponent prefab;

        private List<ItemIconComponent> list = new List<ItemIconComponent>();
        private PlayerData data;
        
        public override void Init() {
            Text allText = ALL.transform.GetComponentInChildren<Text>();
            ALL.onValueChanged.AddListener(value => {
                if (value) ShowItem(ItemType.JI_CHU,ItemType.YANG_CHENG);
                allText.DOColor(value ? Color.white : Color.black, 0.2f);
            });
            Text ji_chuText = JI_CHU.transform.GetComponentInChildren<Text>();
            JI_CHU.onValueChanged.AddListener(value => {
                if (value) ShowItem(ItemType.JI_CHU);
                ji_chuText.DOColor(value ? Color.white : Color.black, 0.2f);
            });
            Text yang_chengText = YANG_CHENG.transform.GetComponentInChildren<Text>();
            YANG_CHENG.onValueChanged.AddListener(value => {
                if (value) ShowItem(ItemType.YANG_CHENG);
                yang_chengText.DOColor(value ? Color.white : Color.black, 0.2f);
            });
        }

        // 筛选物品
        private void ShowItem(params ItemType[] type) {
            List<ItemType> types = new List<ItemType>(type);
            foreach (ItemIconComponent itemIconComponent in list) {
                itemIconComponent.gameObject.SetActive(types.Contains(itemIconComponent.GetMeta().GetItemType()));
            }
        }

        public override void UpdateView() {
            data = PlayerManager.Inst().Get();
            List<ItemStack> dataList = data.GetItems();
            for (int i = 0; i < dataList.Count || i < list.Count; i++) {
                if (i < dataList.Count) {
                    ItemStack itemStack = dataList[i];
                    if (list.Count <= i) {
                        list.Add(Instantiate(prefab, prefab.transform.parent));
                    }
                    ItemIconComponent iic = list[i];
                    iic.SetMeta(itemStack.GetItemMeta());
                    iic.SetAmount(itemStack.GetAmount());
                    iic.gameObject.name = itemStack.GetId().ToString();
                    iic.RemoveAllListeners();
                    iic.AddListener(() => ItemInfoUI.Show(itemStack));
                }
                list[i].gameObject.SetActive(i < dataList.Count);
            }
            if (ALL.isOn) {
                ShowItem(ItemType.JI_CHU,ItemType.YANG_CHENG);
            } else {
                ShowItem(JI_CHU.isOn ? ItemType.JI_CHU : ItemType.YANG_CHENG);
            }
        }

        public override void Show() {
            base.Show();
            canvasGroup.alpha = 0;
            canvasGroup.DOFade(1,0.3f);
        }

        public override void Hide(bool destroy = false) {
            canvasGroup.DOFade(0,0.2f).OnComplete(() => {
                base.Hide(destroy);
            });
        }
    }
}
```

`UI/Sub/ItemInfoUI.cs`:

```cs
using Data.Item;
using Data.Player;
using DG.Tweening;
using UnityEngine;
using UnityEngine.UI;

namespace UI.Sub {
    public class ItemInfoUI : UIBase {
        public Image blur;

        [Header("图标")]
        public Image icon;

        [Header("名字")]
        public Text itemName;

        [Header("用途")]
        public Text useInfo;

        [Header("描述")]
        public Text description;

        [Header("获得方式")]
        public Text waysObtain;

        [Header("库存")]
        public Text amount;

        private ItemStack item;

        public static void Show(ItemStack item) {
            ItemInfoUI ui = UIManager.Inst().Show("ItemInfoUI") as ItemInfoUI;
            ui.item = item;
            ItemMeta meta = item.GetItemMeta();
            ui.icon.sprite = meta.GetIcon();
            ui.itemName.text = meta.GetName();
            ui.useInfo.text = meta.GetUseInfo();
            ui.description.text = meta.GetDescription();
            ui.waysObtain.text = meta.GetWaysObtain();
            ui.amount.text = item.GetAmount().ToString();

            LayoutRebuilder.ForceRebuildLayoutImmediate(ui.itemName.transform.parent as RectTransform);
            LayoutRebuilder.ForceRebuildLayoutImmediate(ui.useInfo.transform.parent as RectTransform);
        }

        public override void Show() {
            base.Show();
            Material blurryShader = blur.material;
            blurryShader.SetFloat("_Size",0);
            float value = 0;
            DOTween.To(() => value,v => value = v,160,0.5f).OnUpdate(() => blurryShader.SetFloat("_Size",value));
            canvasGroup.alpha = 0;
            canvasGroup.DOFade(1,0.3f);
        }

        public override void Hide(bool destroy = false) {
            Material blurryShader = blur.material;
            float value = blurryShader.GetFloat("_Size");
            DOTween.To(() => value,v => value = v,0,0.2f).OnUpdate(() => blurryShader.SetFloat("_Size",value));
            canvasGroup.DOFade(0,0.2f).OnComplete(() => { base.Hide(destroy); });
        }
    }
}
```

`UI/Sub/LoginUI.cs`:

```cs
using System;
using Data.Player;
using DG.Tweening;
using Manager;
using Tools;
using UnityEngine;
using UnityEngine.UI;

namespace UI.Sub {
    public class LoginUI : UIBase {
        
        public RectTransform sphere;
        public Camera sphereCamera;
        public CanvasGroup backGround;

        public CanvasGroup homePanel;
        public CanvasGroup loginPanel;
        public CanvasGroup registerPanel;
        public CanvasGroup loadingPanel;
        public CanvasGroup lowerRightPanel;

        public Button home_login;
        public Button home_register;
        
        public InputField login_userName;
        public InputField login_password;
        public Button login_enter;
        public Button login_back;
        
        public InputField register_userName;
        public InputField register_password;
        public InputField register_rePassword;
        public Toggle register_toggle;
        public Button register_enter;
        public Button register_back;

        public RectTransform loading_bar1;
        public RectTransform loading_bar2;
        
        private Color black = new Color(0, 0, 0, 0);
        private Color red = new Color(0.74f, 0.36f, 0.36f, 0);

        private AudioClip clip;
        private AudioClip loop_clip;
        
        public override void Init() {
            clip = Asset.Load<AudioClip>("Audio/Music/Login", "m_sys_title_intro");
            loop_clip = Asset.Load<AudioClip>("Audio/Music/Login", "m_sys_title_loop");
            
            homePanel.gameObject.SetActive(true);
            loginPanel.gameObject.SetActive(false);
            registerPanel.gameObject.SetActive(false);
            loadingPanel.gameObject.SetActive(false);
            
            home_login.onClick.AddListener(() => {
                homePanel.DOFade(0,0.5f).OnComplete(() => {
                    homePanel.gameObject.SetActive(false);
                    loginPanel.gameObject.SetActive(true);
                    loginPanel.DOFade(1,0.5f);
                    backGround.DOFade(1,0.5f);
                    // sphere.DOLocalMove(new Vector3(0,65,-800),1f);
                    sphere.DOAnchorPosY(0,1f);
                    sphereCamera.DOColor(black,1f);
                });
            });
            
            login_back.onClick.AddListener(() => {
                loginPanel.DOFade(0,0.5f).OnComplete(() => {
                    login_password.text = "";
                    loginPanel.gameObject.SetActive(false);
                    homePanel.gameObject.SetActive(true);
                    homePanel.DOFade(1,0.5f);
                    backGround.DOFade(0,0.5f).SetDelay(0.5f);
                    // sphere.DOLocalMove(new Vector3(0,263,-830),1f).SetEase(Ease.Linear);
                    sphere.DOAnchorPosY(263,1f).SetEase(Ease.Linear);
                    sphereCamera.DOColor(red,1f);
                    // sphere.DOScale(1.5f,1f).SetEase(Ease.Linear);
                });
            });
            
            home_register.onClick.AddListener(() => {
                homePanel.DOFade(0,0.5f).OnComplete(() => {
                    homePanel.gameObject.SetActive(false);
                    registerPanel.gameObject.SetActive(true);
                    registerPanel.DOFade(1,0.5f);
                    backGround.DOFade(1,0.5f);
                    // sphere.DOLocalMove(new Vector3(0,80,-800),1f);
                    sphere.DOAnchorPosY(140,1f);
                    sphereCamera.DOColor(black,1f);
                });
            });
            
            register_back.onClick.AddListener(() => {
                registerPanel.DOFade(0,0.5f).OnComplete(() => {
                    register_password.text = "";
                    register_rePassword.text = "";
                    registerPanel.gameObject.SetActive(false);
                    homePanel.gameObject.SetActive(true);
                    homePanel.DOFade(1,0.5f);
                    backGround.DOFade(0,0.5f).SetDelay(0.5f);
                    // sphere.DOLocalMove(new Vector3(0,100,-830),1f).SetEase(Ease.Linear);
                    sphere.DOAnchorPosY(263,1f).SetEase(Ease.Linear);
                    sphereCamera.DOColor(red,1f);
                    // sphere.DOScale(1.5f,1f).SetEase(Ease.Linear);
                });
            });
            
            login_enter.onClick.AddListener(() => {
                string userName = login_userName.text;
                string password = login_password.text;
                PlayerData playerData = PlayerManager.Inst().Login(userName,password);
                if (playerData == null) {
                    CommonDialogUI.Message(CommonDialogUI.GroundType.BLACK, "用户名或密码错误 请重新登录");
                    return;
                }
                // 登陆界面消失
                lowerRightPanel.DOFade(0,0.5f);
                
                loginPanel.DOFade(0,0.5f).OnComplete(() => {
                    // LoadingPanel界面显示
                    lowerRightPanel.gameObject.SetActive(false);
                    loadingPanel.alpha = 0f;
                    loadingPanel.gameObject.SetActive(true);
                    loadingPanel.DOFade(1,0.5f);
                    Text bar1Text = loading_bar1.transform.GetComponentInChildren<Text>();
                    Text bar2Text = loading_bar2.transform.GetComponentInChildren<Text>();
                    float value = 0.02f;
                    bar1Text.text = $"{value * 200:0.##}%";
                    bar2Text.text = $"{value * 200:0.##}%";
                    // 球移动
                    
                    // sphere.DOLocalMove(new Vector3(0,10,-700),1f).SetEase(Ease.Linear).OnComplete(() => {
                    sphere.DOScale(0.8f,1f).SetEase(Ease.Linear);
                    sphere.DOAnchorPosY(-540, 1f).SetEase(Ease.Linear).OnComplete(() => {
                        // 进度条移动
                        DOTween.To(() => value,v => value = v,0.5f,3f).SetEase(Ease.InQuint)
                            .OnUpdate(() => {
                                Vector2 vector = loading_bar1.anchorMax;
                                vector.x = value;
                                loading_bar1.anchorMax = vector;
                                vector = loading_bar2.anchorMin;
                                vector.x = 1 - value;
                                loading_bar2.anchorMin = vector;

                                bar1Text.text = $"{value * 200:0.##}%";
                                bar2Text.text = $"{value * 200:0.##}%";
                            })
                            .OnComplete(() => {
                                DOTween.To(() => value,z => value = z,0f,0.5f).OnComplete(() => {
                                    Delay.add(() => UIManager.Inst().Show("HomeUI"), 2);
                                    UIManager.Inst().Hide(Name, true);
                                });
                            });
                    });
                });
            });
            
            register_enter.onClick.AddListener(() => {
                string userName = register_userName.text;
                string password = register_password.text;
                string rePassword = register_rePassword.text;

                if (userName.Length < 3) {
                    CommonDialogUI.Message(CommonDialogUI.GroundType.BLACK, "用户名不得小于三位");
                    return;
                }

                if (password != rePassword) {
                    CommonDialogUI.Message(CommonDialogUI.GroundType.BLACK, "密码不一致");
                    return;
                }

                if (password.Length < 6 || password.Length > 18) {
                    CommonDialogUI.Message(CommonDialogUI.GroundType.BLACK, "密码为<color=#00B0FF>6-18</color>位的数字，字母，字符(可包含!#$%&*,.:;^`~)");
                    return;
                }

                if (!register_toggle.isOn) {
                    CommonDialogUI.Message(CommonDialogUI.GroundType.BLACK, "需同意<color=#00B0FF>注册协议</color>和<color=#00B0FF>隐私协议</color>");
                    return;
                }

                try {
                    PlayerManager.Inst().Register(userName, password);
                }
                catch (Exception e) {
                    CommonDialogUI.Message(CommonDialogUI.GroundType.BLACK, e.Message);
                    return;
                }
                
                CommonDialogUI.Message(CommonDialogUI.GroundType.WHITE, "注册成功")
                    .AddBackListener(() => {
                    registerPanel.DOFade(0,0.5f).OnComplete(() => {
                        registerPanel.gameObject.SetActive(false);
                        homePanel.gameObject.SetActive(true);
                        homePanel.DOFade(1,0.5f);
                        backGround.DOFade(0,0.5f).SetDelay(0.5f);
                        sphere.DOAnchorPosY(263,1f).SetEase(Ease.Linear);
                    });
                });
            });
            
        }

        public override void Show() {
            base.Show();
            SoundManager.Inst().PlayMusic(clip, false, () => {
                SoundManager.Inst().PlayMusic(loop_clip, true);
            });
            canvasGroup.alpha = 0;
            canvasGroup.DOFade(1,0.5f); 
        }

        public override void Hide(bool destroy = false) {
            canvasGroup.DOFade(0,2f).OnComplete(() => {
                base.Hide(destroy);
            });
        }
    }
}
```

`UI/Sub/SelectDungeonUI.cs`:

```cs
using Data;
using Data.Dungeon;
using Data.Player;
using DG.Tweening;
using Manager;
using Scripts.Game;
using Tools;
using UnityEngine;
using UnityEngine.UI;

namespace UI.Sub {
    public class SelectDungeonUI : UIBase {

        private InfoPanel infoPanel;
        
        public override void Init() {
            infoPanel = new InfoPanel(transform.Find("InfoPanel"));
            Ground ground = new Ground(transform.Find("Ground"));
            transform.GetComponent<ScrollRect>("Scroll").onValueChanged.AddListener(vec => {
                ground.SetLoc(vec.x);
                if (infoPanel.data) {
                    infoPanel.Hide();
                }
            });
        }

        public override void UpdateView() {
            infoPanel.Update();
        }
        public override void Show() {
            base.Show();
            canvasGroup.alpha = 0;
            canvasGroup.DOFade(1,0.3f);
        }

        public override void Hide(bool destroy = false) {
            canvasGroup.DOFade(0,0.2f).OnComplete(() => {
                base.Hide(destroy);
            });
        }

        // 查看对局关卡数据-UI按钮调用
        public void OpenDungeonInfo(string str) {
            DungeonMeta dungeonMeta = DungeonManager.Inst().GetMeta(str);
            // 显示数据到panel，然后设置panel的Canvas Group;
            infoPanel.Show(dungeonMeta);
        }

        private class InfoPanel {
            private CanvasGroup group;
            
            private Text txt_reason;
            private Text txt_name;
            private Text txt_id;
            private Text txt_description;
            private Text txt_required;

            internal DungeonMeta data;

            internal InfoPanel(Transform transform) {
                group = transform.GetComponent<CanvasGroup>();
                txt_reason = transform.GetComponent<Text>("TitleGround/Reason");
                txt_name = transform.GetComponent<Text>("NameGround/Name");
                txt_id = transform.GetComponent<Text>("NameGround/ID");
                txt_description = transform.GetComponent<Text>("Description");
                txt_required = transform.GetComponent<Text>("EnterButton/Image/Required");
                transform.GetComponent<Button>("EnterButton").onClick.AddListener(() => {
                    if (!data) return;
                    PlayerData playerData = PlayerManager.Inst().Get();
                    if (playerData.GetReason() < data.GetReason()) {
                        CommonDialogUI.Message(CommonDialogUI.GroundType.BLACK, "理智不足，无法进入战斗");
                        return;
                    }
                    GameObject prefab = data.GetDungeonPrefab();
                    playerData.SetReason(playerData.GetReason() - data.GetReason());
                    // 防止点击两次
                    data = null;
                    UIManager.Inst().Hide("HomeUI", true);
                    Delay.add(() => UIManager.Inst().Hide("SelectDungeonUI", true), 1);
                    Delay.add(() => Instantiate(prefab), 2);
                });
                group.gameObject.SetActive(false);
            }

            internal void Show(DungeonMeta data) {
                if (!this.data) {
                    group.alpha = 0;
                    group.gameObject.SetActive(true);
                    group.DOFade(1, 0.5f);
                }
                this.data = data;
                Update();
            }

            internal void Hide() {
                data = null;
                group.DOFade(0, 0.3f).OnComplete(() => {
                    group.gameObject.SetActive(false);
                });
                
            }

            internal void Update() {
                PlayerData playerData = PlayerManager.Inst().Get();
                txt_reason.text = $"{playerData.GetReason()}/{playerData.GetMaxReason()}";
                if (!data) return;
                txt_name.text = data.GetName();
                txt_id.text = data.GetId();
                txt_description.text = data.GetDescription();
                txt_required.text = $"-{data.GetReason()}";
            }

        }
        
        private class Ground {
            private RectTransform transform;
            private StateManager sa = new StateManager();

            internal Ground(Transform transform) {
                this.transform = transform as RectTransform;
                Image ground1 = transform.GetComponent<Image>("Ground1");
                Image ground2 = transform.GetComponent<Image>("Ground2");
                sa.AddStatus("1", new State()
                    .OnEnter(() => {
                        ground1.DOFade(1, 0.4f);
                        ground2.DOFade(0, 0.4f);
                    }));
                sa.AddStatus("2", new State()
                    .OnEnter(() => {
                        ground1.DOFade(0, 0.4f);
                        ground2.DOFade(1, 0.4f);
                    }));
                ground2.color = new Color(1, 1, 1, 0);
                SetLoc(0);
            }

            internal void SetLoc(float value) {
                if (value > 0.6) {
                    sa.Name = "2";
                } else if (value < 0.4) {
                    sa.Name = "1";
                }
                transform.anchorMin = new Vector2(value, 0);
                transform.anchorMax = new Vector2(value, 1);
                transform.pivot = new Vector2(value, 0.5f);
            }
        }
    }
}
```

`UI/Sub/SettingUI.cs`:

```cs
using Data.Player;
using DG.Tweening;
using Settings;
using Manager;
using UnityEngine;
using UnityEngine.UI;

namespace UI.Sub {
    public class SettingUI : UIBase {
        public Image blur;

        public ToggleController game_keep_speed;
        public ToggleController game_performance;
        public Slider game_profileScreen;
        public Button game_exit;

        public ToggleController sound_soundEffect;
        public Slider sound_soundEffect_value;
        public ToggleController sound_music;
        public Slider sound_music_value;
        public ToggleController sound_voice;
        public Slider sound_voice_value;

        public override void Init() {
            game_keep_speed.Initialization(GameSettings.GAME_KEEP_SPEED);
            game_performance.Initialization(GameSettings.GAME_PERFORMANCE);
            game_profileScreen.value = GameSettings.GAME_PROFILED_SCREEN;
            sound_soundEffect.Initialization(GameSettings.SOUND_SOUND_EFFECT_ENABLE);
            sound_soundEffect_value.value = GameSettings.SOUND_SOUND_EFFECT_VALUE;
            sound_music.Initialization(GameSettings.SOUND_MUSIC_ENABLE);
            sound_music_value.value = GameSettings.SOUND_MUSIC_VALUE;
            sound_voice.Initialization(GameSettings.SOUND_VOICE_ENABLE);
            sound_voice_value.value = GameSettings.SOUND_VOICE_VALUE;
            
            game_keep_speed.onValueChanged.AddListener(value => GameSettings.GAME_KEEP_SPEED = value);
            game_performance.onValueChanged.AddListener(value => GameSettings.GAME_PERFORMANCE = value);
            game_profileScreen.onValueChanged.AddListener(value => {
                GameSettings.GAME_PROFILED_SCREEN = (int) value;
            });

            sound_soundEffect.onValueChanged.AddListener(value => {
                GameSettings.SOUND_SOUND_EFFECT_ENABLE = value;
                SoundManager.Inst().UpdateData();
            });
            sound_soundEffect_value.onValueChanged.AddListener(value => {
                GameSettings.SOUND_SOUND_EFFECT_VALUE = (int) value;
                SoundManager.Inst().UpdateData();
            });
            sound_music.onValueChanged.AddListener(value => {
                GameSettings.SOUND_MUSIC_ENABLE = value;
                SoundManager.Inst().UpdateData();
            });
            sound_music_value.onValueChanged.AddListener(value => {
                GameSettings.SOUND_MUSIC_VALUE = (int) value;
                SoundManager.Inst().UpdateData();
            });
            sound_voice.onValueChanged.AddListener(value => {
                GameSettings.SOUND_VOICE_ENABLE = value;
                SoundManager.Inst().UpdateData();
            });
            sound_voice_value.onValueChanged.AddListener(value => {
                GameSettings.SOUND_VOICE_VALUE = (int) value;
                SoundManager.Inst().UpdateData();
            });

            game_exit.onClick.AddListener(() => {
                CommonDialogUI.Message(CommonDialogUI.GroundType.WHITE,"即将返回登陆界面，是否继续？",() => {
                    PlayerManager.Inst().Exit();
                    UIManager.Inst().Hide("HomeUI",true);
                    UIManager.Inst().Hide("SettingUI",true);
                    UIManager.Inst().Hide("HouseUI",true);
                    UIManager.Inst().Hide("CharUI",true);
                    float v = 0;
                    DOTween.To(() => v,value => v = value,3,2f).OnComplete(() => UIManager.Inst().Show("LoginUI"));
                });
            });
        }

        public override void Show() {
            base.Show();
            Material blurryShader = blur.material;
            blurryShader.SetFloat("_Size",0);
            float value = 0;
            DOTween.To(() => value,v => value = v,160,0.5f).OnUpdate(() => blurryShader.SetFloat("_Size",value));
            canvasGroup.alpha = 0;
            canvasGroup.DOFade(1,0.3f);
        }

        public override void Hide(bool destroy = false) {
            Material blurryShader = blur.material;
            float value = blurryShader.GetFloat("_Size");
            DOTween.To(() => value,v => value = v,0,0.2f).OnUpdate(() => blurryShader.SetFloat("_Size",value));
            canvasGroup.DOFade(0,0.2f).OnComplete(() => { base.Hide(destroy); });
        }
    }
}
```

`UI/Sub/ShopUI.cs`:

```cs
using System;
using System.Collections.Generic;
using Data.Item;
using Data.Player;
using DG.Tweening;
using Manager;
using Tools;
using UnityEngine;
using UnityEngine.UI;

namespace UI.Sub {
    public class ShopUI : UIBase {
        public Sprite zzpz_icon;
        public Sprite gjpz_icon;
        public Sprite cgpz_icon;
        public Transform shopItemPrefab;

        private Text cur_zzpz;
        private Text cur_gjpz;
        private Text cur_cgpz;
        private Text cur_lmb;
        private Text cur_ys;
        
        private AudioClip clip;
        private AudioClip loop_clip;
        
        private PlayerData data;
        private ShopItemPanel shopItemPanel;
        private List<ShopItem> list = new List<ShopItem>();

        public override void Init() {
            shopItemPanel = new ShopItemPanel(this, transform.Find("ShopItemPanel"));
            shopItemPanel.transform.gameObject.SetActive(false);
            cur_zzpz = transform.GetComponent<Text>("CurrencyPanel/ZZPZ/ValueGround/txt_value");
            cur_gjpz = transform.GetComponent<Text>("CurrencyPanel/GJPZ/ValueGround/txt_value");
            cur_cgpz = transform.GetComponent<Text>("CurrencyPanel/CGPZ/ValueGround/txt_value");
            cur_lmb = transform.GetComponent<Text>("CurrencyPanel/LMB/ValueGround/txt_value");
            cur_ys = transform.GetComponent<Text>("CurrencyPanel/YS/ValueGround/txt_value");
            clip = Asset.Load<AudioClip>("Audio/Music/Shop", "m_sys_shop_intro");
            loop_clip = Asset.Load<AudioClip>("Audio/Music/Shop", "m_sys_shop_loop");
        }

        public void GiveYs(int size) {
            data.AddItem(0, size);
            UpdateView();
        }

        public override void Show() {
            base.Show();
            canvasGroup.alpha = 0;
            canvasGroup.DOFade(1, 0.3f);
            SoundManager.Inst().PlayMusic(clip, false, () => {
                SoundManager.Inst().PlayMusic(loop_clip, true);
            });
        }

        public override void Hide(bool destroy = false) {
            canvasGroup.DOFade(0, 0.2f).OnComplete(() => { 
                base.Hide(destroy);
            });
            UIManager.Inst().Show("HomeUI");
        }

        public override void UpdateView() {
            data = PlayerManager.Inst().Get();
            cur_zzpz.text = data.GetItemAmount(6).ToString();
            cur_gjpz.text = data.GetItemAmount(7).ToString();
            cur_cgpz.text = data.GetItemAmount(8).ToString();
            cur_lmb.text = data.GetItemAmount(2).ToString();
            cur_ys.text = data.GetItemAmount(0).ToString();
        }

        public void ShowPriceItem(int id) {
            List<ShopItemData> dataList = ShopManager.Inst().GetShopItems(id);
            for (int i = 0; i < dataList.Count || i < list.Count; i++) {
                if (i < dataList.Count) {
                    if (list.Count <= i) {
                        list.Add(new ShopItem(this,Instantiate(shopItemPrefab, shopItemPrefab.parent)));
                    }
                    list[i].SetShopData(dataList[i]);
                    list[i].transform.gameObject.SetActive(true);
                } else {
                    list[i].transform.gameObject.SetActive(false);
                }
            }
        }
        
        public Sprite GetPriceIcon(int id) {
            switch (id) {
                case 6:
                    return zzpz_icon;
                case 7:
                    return gjpz_icon;
                case 8:
                    return cgpz_icon;
            }
            return null;
        }
        
        public class ShopItem {
            internal Transform transform;
            private ShopUI ui;
            
            private ItemIconComponent iic;
            private Text txt_name;
            private Image img_icon;
            private Text txt_price;

            public ShopItem(ShopUI ui, Transform transform) {
                this.transform = transform;
                this.ui = ui;
                iic = transform.GetComponent<ItemIconComponent>();
                txt_name = transform.GetComponent<Text>("Name_Ground/Text");
                img_icon = transform.GetComponent<Image>("Price_Ground/Layout/Price_Icon");
                txt_price = transform.GetComponent<Text>("Price_Ground/Layout/Price");
            }

            public void SetShopData(ShopItemData data) {
                iic.SetMeta(data.GetSell().GetItemMeta());
                iic.SetAmount(data.GetSell().GetAmount());
                txt_name.text = data.GetSell().GetItemMeta().GetName();
                img_icon.sprite = ui.GetPriceIcon(data.GetPrice().GetId());
                txt_price.text = data.GetPrice().GetAmount().ToString();
                iic.RemoveAllListeners();
                iic.AddListener(() => {
                    ui.shopItemPanel.SetShopData(data);
                    ui.shopItemPanel.Show();
                });
            }
        }
        
        public class ShopItemPanel {
            internal Transform transform;
            private CanvasGroup canvasGroup;
            private Material blurryShader;
            private ShopUI ui;
            private ShopItemData data;
            
            private Text txt_sell_name;
            private Image img_sell_use_image;
            private Text txt_sell_use_info;
            private Text txt_sell_amount;
            private Image img_price_icon;
            private Text txt_price_amount;
            private Text txt_buy_amount;
            private Image img_all_price_icon;
            private Text txt_all_price_amount;

            private int buy_amount;
            private int all_price_amount;

            private void SetBuyAmount(int value) {
                buy_amount = value;
                txt_buy_amount.text = value.ToString();
                all_price_amount = data.GetPrice().GetAmount() * value;
                txt_all_price_amount.text = all_price_amount.ToString();
            }

            public ShopItemPanel(ShopUI ui, Transform transform) {
                this.transform = transform;
                this.ui = ui;
                canvasGroup = transform.GetComponent<CanvasGroup>();
                blurryShader = transform.GetComponent<Image>().material;
                txt_sell_name = transform.GetComponent<Text>("ItemNameGround/Text");
                img_sell_use_image = transform.GetComponent<Image>("ItemIconGround/Image");
                txt_sell_use_info = transform.GetComponent<Text>("ItemUseInfo");
                txt_sell_amount = transform.GetComponent<Text>("ItemAmountGround/ItemAmount");
                img_price_icon = transform.GetComponent<Image>("PriceIcon");
                txt_price_amount = transform.GetComponent<Text>("PriceAmount");
                txt_buy_amount = transform.GetComponent<Text>("BuyAmountGround/Text");
                img_all_price_icon = transform.GetComponent<Image>("AllPriceIcon");
                txt_all_price_amount = transform.GetComponent<Text>("AllPriceAmount");
                transform.GetComponent<Button>("CloseButton").onClick.AddListener(Hide);// 关闭界面事件
                
                transform.GetComponent<Button>("AddButton").onClick.AddListener(() => {
                    // 增加数量事件
                    if (ui.data.HasItem(data.GetPrice().GetId(), data.GetPrice().GetAmount() * (buy_amount + 1))) {
                        SetBuyAmount(Math.Min(buy_amount + 1, 99));
                    }
                });
                transform.GetComponent<Button>("TakeButton").onClick.AddListener(() => {
                    // 减少数量事件
                    SetBuyAmount(Math.Max(buy_amount - 1, 0));
                });
                transform.GetComponent<Button>("MinButton").onClick.AddListener(() => {
                    // 最少数量事件
                    SetBuyAmount(ui.data.HasItem(data.GetPrice()) ? 1 : 0);
                });
                transform.GetComponent<Button>("MaxButton").onClick.AddListener(() => {
                    // 最多数量事件
                    SetBuyAmount(Math.Min(ui.data.GetItemAmount(data.GetPrice().GetId()) / data.GetPrice().GetAmount(), 99));
                });
                transform.GetComponent<Button>("BuyButton").onClick.AddListener(() => {
                    // 购买事件
                    if (buy_amount == 0) return;
                    ui.data.AddItem(data.GetSell().GetId(), data.GetSell().GetAmount() * buy_amount);
                    ui.data.TakeItem(data.GetPrice().GetId(), all_price_amount);
                    CommonDialogUI.Message(CommonDialogUI.GroundType.WHITE, "购买成功: " + data.GetSell().GetItemMeta().GetName() + " x " + (data.GetSell().GetAmount() * buy_amount)).AddBackListener(Hide);
                    ui.UpdateView();
                });
            }

            public void SetShopData(ShopItemData data) {
                this.data = data;
                ItemMeta sellMeta = data.GetSell().GetItemMeta();
                txt_sell_name.text = sellMeta.GetName();
                img_sell_use_image.sprite = sellMeta.GetIcon();
                txt_sell_use_info.text = sellMeta.GetUseInfo();
                txt_sell_amount.text = "x " + data.GetSell().GetAmount();
                img_price_icon.sprite = ui.GetPriceIcon(data.GetPrice().GetId());
                txt_price_amount.text = data.GetPrice().GetAmount().ToString();
                SetBuyAmount(0);
                img_all_price_icon.sprite = ui.GetPriceIcon(data.GetPrice().GetId());
                
            }

            public void Show() {
                blurryShader.SetFloat("_Size",0);
                float value = 0;
                DOTween.To(() => value,v => value = v,160,0.5f).OnUpdate(() => blurryShader.SetFloat("_Size",value));
                transform.gameObject.SetActive(true);
                canvasGroup.alpha = 0;
                canvasGroup.DOFade(1, 0.3f);
                LayoutRebuilder.ForceRebuildLayoutImmediate(txt_sell_name.transform.parent as RectTransform);
            }

            public void Hide() {
                float value = blurryShader.GetFloat("_Size");
                DOTween.To(() => value,v => value = v,0,0.2f).OnUpdate(() => blurryShader.SetFloat("_Size",value));
                canvasGroup.DOFade(0, 0.2f).OnComplete(() => {
                    transform.gameObject.SetActive(false);
                });
            }
        }
    }
}
```

`UI/Sub/SquadUI.cs`:

```cs
using System.Collections.Generic;
using System.Linq;
using Data.Char;
using Data.Player;
using DG.Tweening;
using UnityEngine;
using UnityEngine.UI;

namespace UI.Sub {
    public class SquadUI : UIBase {
        private Transform card_prefab;
        private RectTransform charList;
        private RectTransform deleteButton;
        
        private PlayerData data;
        private List<CharCard> charCards;

        public override void Init() {
            
            card_prefab = transform.Find("DownPanel/CharList/CardPrefab");
            charList = card_prefab.parent as RectTransform;
            deleteButton = transform.Find("DeleteButton") as RectTransform;
            
            charCards = new List<CharCard>();
            for (int i = 0; i < 4; i++) {
                charCards.Add(new CharCard(Instantiate(card_prefab, card_prefab.parent)));
            }
            deleteButton.GetComponent<Button>().onClick.AddListener(() => {
                if (data.GetSquad().Any(name => data.GetCharData(name) != null)) {
                    CommonDialogUI.Message(CommonDialogUI.GroundType.WHITE, "是否确认移除当前编队中的所有干员?", () => {
                        data.ResetSquad();
                        UpdateView();
                    });
                }
            });
        }

        public override void UpdateView() {
            data = PlayerManager.Inst().Get();
            for (int i = 0; i < 4; i++) {
                CharData charData = data.GetCharData(data.GetSquad()[i]);
                CharCard charCard = charCards[i];
                charCard.transform.DOScale(0.9f, 0.1f).OnComplete(() => {
                    charCard.SetData(charData);
                    charCard.transform.DOScale(1f, 0.15f);
                });
            }
        }

        public override void Show() {
            base.Show();
            charList.localScale = new Vector3(1, 1, 1);
            charList.anchoredPosition = new Vector2(300, 0);
            charList.DOAnchorPosX(0, 0.5f);
            deleteButton.anchoredPosition = new Vector2(0, 0);
            deleteButton.DOAnchorPosY(-150, 0.3f);
            canvasGroup.alpha = 0;
            canvasGroup.DOFade(1, 0.3f);
        }

        public override void Hide(bool destroy = false) {
            charList.DOScale(0.9f, 0.5f);
            charList.DOAnchorPosX(-300, 0.5f);
            deleteButton.DOAnchorPosY(0, 0.3f);
            canvasGroup.DOFade(0, 0.3f).OnComplete(() => { base.Hide(destroy); });
        }

        public class CharCard {
            internal Transform transform;
            private Transform empty;
            private Transform exist;

            private CharData data;
            
            private Text name;
            private Text level;
            private Image expPercentage;
            private Image charCard;
            private Image rarity1;
            private Image rarity2;
            private Image rarity3;
            private Image rarity4;
            private Image rarityStar;
            private Image profession;
            private Image eliteImage;
            
            public CharCard(Transform transform) {
                this.transform = transform;
                transform.gameObject.SetActive(true);
                
                empty = transform.Find("Empty");
                exist = transform.Find("Exist");
                name = exist.GetComponent<Text>("txt_name");
                level = exist.GetComponent<Text>("txt_level");
                expPercentage = exist.GetComponent<Image>("img_exp_ground/img_exp_percentage");
                charCard = exist.GetComponent<Image>("img_char_card");
                rarity1 = exist.GetComponent<Image>("img_rarity_1");
                rarity2 = exist.GetComponent<Image>("img_rarity_2");
                rarity3 = exist.GetComponent<Image>("img_rarity_3");
                rarity4 = exist.GetComponent<Image>("img_rarity_4");
                rarityStar = exist.GetComponent<Image>("img_rarity_star");
                profession = exist.GetComponent<Image>("img_profession");
                eliteImage = exist.GetComponent<Image>("img_elite");
                empty.GetComponent<Button>().onClick.AddListener(OnClick);
                exist.GetComponent<Button>().onClick.AddListener(OnClick);
            }

            public void SetData(CharData data) {
                empty.gameObject.SetActive(data == null);
                exist.gameObject.SetActive(data != null);
                if (data != null && this.data != data) {
                    CharMeta charMeta = data.GetCharMeta();
                    int rarity = charMeta.GetRarity();
                    name.text = charMeta.GetChineseName();
                    charCard.sprite = charMeta.GetCharImage();
                    rarity1.sprite = CharManager.Inst().GetCardGroundImage(rarity + "_1");
                    rarity2.sprite = CharManager.Inst().GetCardGroundImage(rarity + "_2");
                    rarity3.sprite = CharManager.Inst().GetCardGroundImage(rarity + "_3");
                    rarity4.sprite = CharManager.Inst().GetCardGroundImage(rarity + "_4");
                    rarityStar.sprite = CharManager.Inst().GetCardGroundImage(rarity + "_star");
                    profession.sprite = CharManager.Inst().GetProfessionSmallImage(charMeta.GetProfession());
                }
                this.data = data;
                if (data != null) Update();
            }

            public void Update() {
                level.text = data.GetLevel().ToString();
                expPercentage.fillAmount = data.GetExp() / (float) data.GetMaxExp();
                eliteImage.gameObject.SetActive(data.GetElite() > 0);
                if (data.GetElite() > 0) {
                    eliteImage.sprite = CharManager.Inst().GetCharEliteImage("card_" + data.GetElite());
                }
            }

            private void OnClick() {
                CharSelectUI.Show(data?.GetId());
            }
        }
    }
}
```

`UI/UIBase.cs`:

```cs
using Manager;
using UnityEngine;
using XLua;

namespace UI {
    [CSharpCallLua]
    public abstract class UIBase : MonoBehaviour {
        public new GameObject gameObject { get; private set; }
        public new RectTransform transform { get; private set; }
        public CanvasGroup canvasGroup { get; private set; }
        internal string Name;

        internal UIState state = UIState.Hide;

        public bool debug;
        
        private void Awake() {
            gameObject = base.gameObject;
            transform = base.transform as RectTransform;
            canvasGroup = GetComponent<CanvasGroup>();
            if (debug) {
                gameObject.SetActive(true);
                Init();
                Show();
            }
        }

        public virtual void Init() { }
        
        public virtual void UpdateView() { }

        public virtual void Show() {
            gameObject.SetActive(true);
        }

        public virtual void Hide(bool destroy = false) {
            gameObject.SetActive(false);
            if (destroy) UIManager.Inst().UnLoad(Name);
        }

        public void Show(string value) => UIManager.Inst().Show(value);

        public void Hide(string value) => UIManager.Inst().Hide(value);

        public void HideAndDestroy(string value) => UIManager.Inst().Hide(value,true);

        public void PlayEffect(AudioClip clip) => SoundManager.Inst().PlayEffect(clip);
    }

    // [Serializable]
    // public class Injection {
    //     public string name;
    //     public Object value;
    // }

    public enum UIState {
        Show,
        Hide
    }
}
```

`UI/UIManager.cs`:

```cs
using System.Collections.Generic;
using Settings;
using Tools;
using UnityEngine;
using UnityEngine.UI;

namespace UI {
    public class UIManager : Single<UIManager> {
        private Dictionary<string, UIBase> uiDictionary = new Dictionary<string, UIBase>();

        private GameObject camera;
        private GameObject canvas;

        private Vector2 canvasSize;

        public GameObject GetCamera() => camera;
        public GameObject GetCanvas() => canvas;
        public Vector2 GetCanvasSize() => canvasSize;

        protected override void Initialization() {
            //克隆画布摄像机 + 画布
            camera = Object.Instantiate(Asset.Load<GameObject>(GameSettings.UI_PREFAB_PATH, "Camera"));
            camera.name = "UIManager";
            canvas = camera.transform.Find("Canvas").gameObject;
            // camera.AddComponent<UIComponent>();
            //画布不能随着场景的切换而销毁
            //该项目是以宽进行适配，所以宽不变, 注意：你用的时候，要确定你的项目画布是以什么方式适配的
            canvasSize = canvas.GetComponent<CanvasScaler>().referenceResolution;
            //高根据屏幕的分辨率的宽高比来计算
            // 分辨率.宽 / 分辨率.高 = 画布.宽 / 画布.高
            // 画布.高 = 画布.宽 / (分辨率.宽 / 分辨率.高) = 画布.宽 * 分辨率.高 / 分辨率.宽
            canvasSize.x = canvasSize.y * Screen.width / Screen.height;
            // canvasSize.y = canvasSize.x * Screen.height / Screen.width;
            Object.DontDestroyOnLoad(camera);
        }

        // 打开
        public UIBase Show(string type) {
            if (!uiDictionary.TryGetValue(type, out UIBase ui)) ui = Load(type);
            ui.transform.SetAsLastSibling();
            ui.Show();
            ui.UpdateView();
            if (ui.state != UIState.Hide) return ui;
            ui.state = UIState.Show;
            return ui;
        }

        public void Update(string type) {
            if (uiDictionary.TryGetValue(type, out UIBase ui)) ui.UpdateView();
        }
        
        // 关闭
        public void Hide(string type, bool destroy = false) {
            if (!uiDictionary.ContainsKey(type)) return;
            UIBase ui = uiDictionary[type];
            if (ui.state == UIState.Show) {
                ui.Hide(destroy);
                ui.state = UIState.Hide;
            } else if (destroy) {
                UnLoad(type);
            }
        }

        // 加载
        private UIBase Load(string type) {
            GameObject obj = Object.Instantiate(Asset.Load<GameObject>(GameSettings.UI_PREFAB_PATH, type), canvas.transform);
            obj.name = type;
            UIBase ui = obj.GetComponent<UIBase>();
            ui.Name = type;
            ui.Init();
            uiDictionary.Add(type, ui);
            return ui;
        }

        // 卸载
        public void UnLoad(string type) {
            if (!uiDictionary.ContainsKey(type)) return;
            UIBase ui = uiDictionary[type];
            uiDictionary.Remove(type);
            Object.Destroy(ui.gameObject);
        }
    }
}
```

`Utils/Asset.cs`:

```cs
using System.IO;
using Manager;
using UnityEngine;

namespace Tools {
    public class Asset {
        public static T Load<T>(string path, string name) where T : Object {
            return ABManager.Inst().LoadAsset<T>(name, path) ?? Resources.Load<T>(Path.Combine(path, name));
        }
        
        public static Object Load(string path, string name) {
            return ABManager.Inst().LoadAsset<Object>(name, path) ?? Resources.Load(Path.Combine(path, name));
        }

        public static T[] LoadAll<T>(string path, string name) where T : Object {
            return Resources.LoadAll<T>(Path.Combine(path, name));
        }
        
        public static Object[] LoadAll(string path, string name) {
            return Resources.LoadAll(Path.Combine(path, name));
        }
    }
}
```

`Utils/Delay.cs`:

```cs
using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

namespace Tools {
    public class Delay : MonoSingle<Delay> {
        
        private List<ActionPackage> actions = new List<ActionPackage>();
        
        public static void add(Action action, float time) {
            Inst().actions.Add(new ActionPackage(action, time));
        }

        private void Update() {
            for (int i = actions.Count - 1; i >= 0; i--) {
                if (actions[i].time > 0) {
                    actions[i].time -= Time.deltaTime;
                } else {
                    actions[i].action();
                    actions.RemoveAt(i);
                }
            }
        }

        private class ActionPackage {
            internal Action action;
            internal float time;
            
            internal ActionPackage(Action action, float time) {
                this.action = action;
                this.time = time;
            }
        }
    }
}
```

`Utils/Expand.cs`:

```cs
using System;
using System.ComponentModel;
using System.Reflection;
using System.Runtime.CompilerServices;
using UnityEngine;
using Object = UnityEngine.Object;

public static class Expand {
    // 标签名字
    public static string GetName(this Enum value) {
        Type temType = value.GetType();
        MemberInfo[] memberInfos = temType.GetMember(value.ToString());
        if (memberInfos.Length == 0) return value.ToString();
        object[] objs = memberInfos[0].GetCustomAttributes(typeof(DescriptionAttribute),false);
        return objs.Length > 0 ? ((DescriptionAttribute) objs[0]).Description : value.ToString();
    }

    // 查找子物体的组件
    public static T GetComponent<T>(this Transform value, string path) where T : Object {
        return value.Find(path).GetComponent<T>();
    }

    public static Vector3 Round(this Vector3 vector3) {
        return new Vector3(Mathf.Round(vector3.x), Mathf.Round(vector3.y), Mathf.Round(vector3.z));
    }
}
```

`Utils/Injection.cs`:

```cs
using System;
using Object = UnityEngine.Object;

namespace Tools {
    [Serializable]
    public class Injection {
        public string name;
        public Object value;
    }
}
```

`Utils/Single.cs`:

```cs
using UnityEngine;

namespace Tools {

    public abstract class Single<T> where T : Single<T>,new() {
        private static T inst;
        public static T Inst() {
            if (inst != null) return inst;
            inst = new T();
            inst.Initialization();
            return inst;
        }

        protected virtual void Initialization() { }
    }

    public abstract class MonoSingle<T> : MonoBehaviour where T : MonoSingle<T> {
        private static T inst;
        
        public static T Inst() {
            if (inst) return inst;
            GameObject gameObject = new GameObject(typeof(T).Name);
            inst = gameObject.AddComponent<T>();
            DontDestroyOnLoad(gameObject);
            return inst;
        }
        
        protected virtual void Initialization() { }

        private void Awake() {
            Initialization();
        }
    }
}
```