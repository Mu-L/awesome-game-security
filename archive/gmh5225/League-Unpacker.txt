Project Path: arc_gmh5225_League-Unpacker_0tg9eyn5

Source Tree:

```txt
arc_gmh5225_League-Unpacker_0tg9eyn5
├── README.md
├── Release
│   └── Unpackman.dll
├── Unpackman
│   ├── Main.cpp
│   ├── Unpackman.filters
│   ├── Unpackman.vcxproj
│   └── Unpackman.vcxproj.user
└── Unpackman.sln

```

`README.md`:

```md
## Unpackman

This tool decrypts the protected .text section (containing code) so that you can open the executable in a disassembler. It does not resolve relocations, so you need to manually input the base address when disassembling!

### Usage

Use your favorite DLL injector to inject the DLL into League of Legends.exe.

```

`Unpackman.sln`:

```sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio 15
VisualStudioVersion = 15.0.27703.2000
MinimumVisualStudioVersion = 10.0.40219.1
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "Unpackman", "Unpackman\Unpackman.vcxproj", "{1CA969CE-EDC9-41A3-A617-E68274A72754}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|x64 = Debug|x64
		Debug|x86 = Debug|x86
		Release|x64 = Release|x64
		Release|x86 = Release|x86
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{1CA969CE-EDC9-41A3-A617-E68274A72754}.Debug|x64.ActiveCfg = Debug|x64
		{1CA969CE-EDC9-41A3-A617-E68274A72754}.Debug|x64.Build.0 = Debug|x64
		{1CA969CE-EDC9-41A3-A617-E68274A72754}.Debug|x86.ActiveCfg = Debug|Win32
		{1CA969CE-EDC9-41A3-A617-E68274A72754}.Debug|x86.Build.0 = Debug|Win32
		{1CA969CE-EDC9-41A3-A617-E68274A72754}.Release|x64.ActiveCfg = Release|x64
		{1CA969CE-EDC9-41A3-A617-E68274A72754}.Release|x64.Build.0 = Release|x64
		{1CA969CE-EDC9-41A3-A617-E68274A72754}.Release|x86.ActiveCfg = Release|Win32
		{1CA969CE-EDC9-41A3-A617-E68274A72754}.Release|x86.Build.0 = Release|Win32
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {F9DC9705-1DBE-4AF0-B13E-050F4AC88800}
	EndGlobalSection
EndGlobal

```

`Unpackman/Main.cpp`:

```cpp
#include <Windows.h>
#include <cstdio>

typedef NTSTATUS(__stdcall* ZwRaiseException_t)(PEXCEPTION_RECORD ExceptionRecord, PCONTEXT ThreadContext, BOOLEAN HandleException);
ZwRaiseException_t raiseExceptionFunc;

void PrintSingleCharacter(char c)
{
	DWORD written;
	WriteConsoleA(GetStdHandle(STD_OUTPUT_HANDLE), &c, 1, &written, NULL);
}

void PrintMessage(const char* fmt, ...)
{
	char buf[4096];
	va_list args;
	va_start(args, fmt);
	vsnprintf_s(buf, 4096, fmt, args);
	char* bufptr = buf;
	while (*bufptr)
	{
		if (*bufptr == '~')
		{
			++bufptr;
			SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), *bufptr);
		}
		else
		{
			PrintSingleCharacter(*bufptr);
		}
		++bufptr;
	}
	PrintSingleCharacter('\n');
	va_end(args);
}

__declspec(naked) void FinishThread()
{
	__asm {
		push 0 // STATUS_SUCCESS
		push -2 // ZwCurrentThread()
		call TerminateThread
	}
}

unsigned char codeBuf[52428800];
unsigned char leagueBuf[52428800];

DWORD_PTR baseTextAddress = 0;

DWORD WINAPI GetProtectedMemory(PVOID Address)
{
	CONTEXT ctx;
	EXCEPTION_RECORD exr;

	MEMORY_BASIC_INFORMATION mbi;
	memset(&mbi, 0, sizeof(mbi));
	VirtualQuery(Address, &mbi, sizeof(mbi));

	if (mbi.Protect == PAGE_NOACCESS)
	{
		RtlCaptureContext(&ctx);

		memset(&exr, 0, sizeof(EXCEPTION_RECORD));

		ctx.Eip = (DWORD)FinishThread;
		exr.ExceptionAddress = (PVOID)Address;
		exr.NumberParameters = 2;
		exr.ExceptionCode = EXCEPTION_ACCESS_VIOLATION;
		exr.ExceptionInformation[1] = (ULONG_PTR)Address;

		raiseExceptionFunc(&exr, &ctx, 1);
	}

	TerminateThread(GetCurrentThread(), 0);
	return 0;
}

void EnsureMemoryIsDecrypted(PVOID Address)
{
	HANDLE hThread = CreateThread(NULL, 0, GetProtectedMemory, Address, NULL, 0);
	WaitForSingleObject(hThread, INFINITE);
	CloseHandle(hThread);
}

DWORD WINAPI DoStuff(LPVOID lpParameter)
{
	AllocConsole();
	SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 15);

	DWORD textPageCount = 0;

	PIMAGE_DOS_HEADER imageDosHeader = (PIMAGE_DOS_HEADER)GetModuleHandleA(NULL);
	PIMAGE_NT_HEADERS imageNtHeaders = (PIMAGE_NT_HEADERS)((DWORD_PTR)imageDosHeader + imageDosHeader->e_lfanew);
	DWORD sectionCount = imageNtHeaders->FileHeader.NumberOfSections;
	PIMAGE_SECTION_HEADER imageSection = (PIMAGE_SECTION_HEADER)((DWORD_PTR)&imageNtHeaders->OptionalHeader + imageNtHeaders->FileHeader.SizeOfOptionalHeader);
	for (DWORD i = 0; i < sectionCount; ++i)
	{
		if (strcmp((const char*)(imageSection + i)->Name, ".text") == 0)
		{
			baseTextAddress = (DWORD_PTR)imageDosHeader + (imageSection + i)->PointerToRawData;
			textPageCount = (imageSection + i)->SizeOfRawData / 0x1000;
			break;
		}
	}

	for (DWORD i = 0; i < textPageCount; ++i)
	{
		LPVOID mem = (LPVOID)(baseTextAddress + i * 0x1000);
		EnsureMemoryIsDecrypted(mem);
		memcpy((unsigned char*)codeBuf + ((DWORD_PTR)mem - baseTextAddress), mem, 0x1000);

		if ((i + 1) % 200 == 0 || i + 1 == textPageCount)
			PrintMessage("Sections decrypted: ~%c%d/%d~%c", 11, i + 1, textPageCount, 15);
	}

	DWORD fileWritten;
	HANDLE hFile = CreateFileA("League of Legends.exe", GENERIC_READ, FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE, NULL, OPEN_EXISTING, 0, NULL);
	DWORD leagueExeSize = GetFileSize(hFile, NULL);
	if (hFile != INVALID_HANDLE_VALUE)
	{
		DWORD read;
		ReadFile(hFile, leagueBuf, leagueExeSize, &read, NULL);
		CloseHandle(hFile);

		hFile = CreateFileA("League of Legends_decrypted.exe", GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);
		if (hFile != INVALID_HANDLE_VALUE)
		{
			memcpy(leagueBuf + (baseTextAddress - (DWORD_PTR)imageDosHeader), codeBuf, textPageCount * 0x1000);
			WriteFile(hFile, leagueBuf, leagueExeSize, &fileWritten, NULL);

			PrintMessage("===============================================================================");
			PrintMessage("Base address: ~%c0x%08x~%c", 11, imageDosHeader, 15);
			PrintMessage("~%cAll sections dumped~%c: decrypted .exe in:", 10, 15);

			char fileNameBuf[512];
			memset(fileNameBuf, 0, sizeof(fileNameBuf));
			GetFinalPathNameByHandleA(hFile, fileNameBuf, 512, 0);
			PrintMessage("~%c%s~%c", 11, fileNameBuf, 15);

			CloseHandle(hFile);
		}
	}
	

	return 0;
}

BOOL WINAPI DllMain(HINSTANCE hInstDLL, DWORD fdwReason, LPVOID lpReserved)
{
	if (fdwReason == DLL_PROCESS_ATTACH)
	{
		raiseExceptionFunc = (ZwRaiseException_t)GetProcAddress(GetModuleHandleA("ntdll.dll"), "NtRaiseException");
		CloseHandle(CreateThread(NULL, 0, DoStuff, NULL, 0, NULL));
	}
	return TRUE;
}

```

`Unpackman/Unpackman.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="Main.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`Unpackman/Unpackman.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>15.0</VCProjectVersion>
    <ProjectGuid>{1CA969CE-EDC9-41A3-A617-E68274A72754}</ProjectGuid>
    <RootNamespace>Unpackman</RootNamespace>
    <WindowsTargetPlatformVersion>10.0.17134.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>DynamicLibrary</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v141</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>DynamicLibrary</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v141</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>DynamicLibrary</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v141</PlatformToolset>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>DynamicLibrary</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v141</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>MultiByte</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
    </ClCompile>
    <Link>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <EntryPointSymbol>
      </EntryPointSymbol>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
    </ClCompile>
    <Link>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <EntryPointSymbol>
      </EntryPointSymbol>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="Main.cpp" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`Unpackman/Unpackman.vcxproj.user`:

```user
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup />
</Project>
```