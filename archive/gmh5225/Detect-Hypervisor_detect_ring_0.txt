Project Path: arc_gmh5225_Detect-Hypervisor_detect_ring_0_xc_43jp2

Source Tree:

```txt
arc_gmh5225_Detect-Hypervisor_detect_ring_0_xc_43jp2
├── HypervisorCheckR0
│   ├── DriverEntry.cpp
│   ├── HypervisorCheckR0.inf
│   ├── HypervisorCheckR0.vcxproj
│   ├── HypervisorCheckR0.vcxproj.filters
│   ├── HypervisorCheckR0.vcxproj.user
│   ├── HypervisorDetect.hpp
│   └── Struct.h
├── HypervisorCheckR0.sln
└── README.md

```

`HypervisorCheckR0.sln`:

```sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 16
VisualStudioVersion = 16.0.31624.102
MinimumVisualStudioVersion = 10.0.40219.1
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "HypervisorCheckR0", "HypervisorCheckR0\HypervisorCheckR0.vcxproj", "{164DF69B-E119-41A4-A578-49663695145F}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|ARM = Debug|ARM
		Debug|ARM64 = Debug|ARM64
		Debug|x64 = Debug|x64
		Debug|x86 = Debug|x86
		Release|ARM = Release|ARM
		Release|ARM64 = Release|ARM64
		Release|x64 = Release|x64
		Release|x86 = Release|x86
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{164DF69B-E119-41A4-A578-49663695145F}.Debug|ARM.ActiveCfg = Debug|ARM
		{164DF69B-E119-41A4-A578-49663695145F}.Debug|ARM.Build.0 = Debug|ARM
		{164DF69B-E119-41A4-A578-49663695145F}.Debug|ARM.Deploy.0 = Debug|ARM
		{164DF69B-E119-41A4-A578-49663695145F}.Debug|ARM64.ActiveCfg = Debug|ARM64
		{164DF69B-E119-41A4-A578-49663695145F}.Debug|ARM64.Build.0 = Debug|ARM64
		{164DF69B-E119-41A4-A578-49663695145F}.Debug|ARM64.Deploy.0 = Debug|ARM64
		{164DF69B-E119-41A4-A578-49663695145F}.Debug|x64.ActiveCfg = Debug|x64
		{164DF69B-E119-41A4-A578-49663695145F}.Debug|x64.Build.0 = Debug|x64
		{164DF69B-E119-41A4-A578-49663695145F}.Debug|x64.Deploy.0 = Debug|x64
		{164DF69B-E119-41A4-A578-49663695145F}.Debug|x86.ActiveCfg = Debug|Win32
		{164DF69B-E119-41A4-A578-49663695145F}.Debug|x86.Build.0 = Debug|Win32
		{164DF69B-E119-41A4-A578-49663695145F}.Debug|x86.Deploy.0 = Debug|Win32
		{164DF69B-E119-41A4-A578-49663695145F}.Release|ARM.ActiveCfg = Release|ARM
		{164DF69B-E119-41A4-A578-49663695145F}.Release|ARM.Build.0 = Release|ARM
		{164DF69B-E119-41A4-A578-49663695145F}.Release|ARM.Deploy.0 = Release|ARM
		{164DF69B-E119-41A4-A578-49663695145F}.Release|ARM64.ActiveCfg = Release|ARM64
		{164DF69B-E119-41A4-A578-49663695145F}.Release|ARM64.Build.0 = Release|ARM64
		{164DF69B-E119-41A4-A578-49663695145F}.Release|ARM64.Deploy.0 = Release|ARM64
		{164DF69B-E119-41A4-A578-49663695145F}.Release|x64.ActiveCfg = Release|x64
		{164DF69B-E119-41A4-A578-49663695145F}.Release|x64.Build.0 = Release|x64
		{164DF69B-E119-41A4-A578-49663695145F}.Release|x64.Deploy.0 = Release|x64
		{164DF69B-E119-41A4-A578-49663695145F}.Release|x86.ActiveCfg = Release|Win32
		{164DF69B-E119-41A4-A578-49663695145F}.Release|x86.Build.0 = Release|Win32
		{164DF69B-E119-41A4-A578-49663695145F}.Release|x86.Deploy.0 = Release|Win32
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {1E147BB8-3C81-4B3F-BD61-ABDDD68854F7}
	EndGlobalSection
EndGlobal

```

`HypervisorCheckR0/DriverEntry.cpp`:

```cpp
#include "HypervisorDetect.hpp"



NTSTATUS DriverEntry(IN PDRIVER_OBJECT pDriverObject, IN PUNICODE_STRING pRegistryPath)
{
	UNREFERENCED_PARAMETER(pRegistryPath);


	 
	DbgPrint("[Bad lev1oto] Cpuid is hypervisor ->\t 0x%p\n", DetectHyp::cpuid_is_hypervisor());
	DbgPrint("[Bad lev1oto] Compare cpuid list ->\t 0x%p\n", DetectHyp::compare_list_cpuid());
	DbgPrint("[Bad lev1oto] Time attack with rdtsc ->\t 0x%p\n", DetectHyp::time_attack_rdtsc()); 
	DbgPrint("[Bad lev1oto] Time attack with APERF ->\t 0x%p\n", DetectHyp::time_attack_APERF());
	DbgPrint("[Bad lev1oto] Time attack with MPERF->\t 0x%p\n", DetectHyp::time_attack_MPERF());
	DbgPrint("[Bad lev1oto] LBR is virtualizate ->\t 0x%p\n", DetectHyp::lbr_is_virtulazed());
	DbgPrint("[Bad lev1oto] LBR stack check ->\t 0x%p\n", DetectHyp::lbr_stask_is_virtulazed()); 
	
	return STATUS_SUCCESS;
}

```

`HypervisorCheckR0/HypervisorCheckR0.inf`:

```inf
;
; HypervisorCheckR0.inf
;

[Version]
Signature="$WINDOWS NT$"
Class=Sample ; TODO: edit Class
ClassGuid={78A1C341-4539-11d3-B88D-00C04FAD5171} ; TODO: edit ClassGuid
Provider=%ManufacturerName%
CatalogFile=HypervisorCheckR0.cat
DriverVer= ; TODO: set DriverVer in stampinf property pages
PnpLockDown=1

[DestinationDirs]
DefaultDestDir = 12
HypervisorCheckR0_Device_CoInstaller_CopyFiles = 11

; ================= Class section =====================

[ClassInstall32]
Addreg=SampleClassReg

[SampleClassReg]
HKR,,,0,%ClassName%
HKR,,Icon,,-5

[SourceDisksNames]
1 = %DiskName%,,,""

[SourceDisksFiles]
HypervisorCheckR0.sys  = 1,,
WdfCoInstaller$KMDFCOINSTALLERVERSION$.dll=1 ; make sure the number matches with SourceDisksNames

;*****************************************
; Install Section
;*****************************************

[Manufacturer]
%ManufacturerName%=Standard,NT$ARCH$

[Standard.NT$ARCH$]
%HypervisorCheckR0.DeviceDesc%=HypervisorCheckR0_Device, Root\HypervisorCheckR0 ; TODO: edit hw-id

[HypervisorCheckR0_Device.NT]
CopyFiles=Drivers_Dir

[Drivers_Dir]
HypervisorCheckR0.sys

;-------------- Service installation
[HypervisorCheckR0_Device.NT.Services]
AddService = HypervisorCheckR0,%SPSVCINST_ASSOCSERVICE%, HypervisorCheckR0_Service_Inst

; -------------- HypervisorCheckR0 driver install sections
[HypervisorCheckR0_Service_Inst]
DisplayName    = %HypervisorCheckR0.SVCDESC%
ServiceType    = 1               ; SERVICE_KERNEL_DRIVER
StartType      = 3               ; SERVICE_DEMAND_START
ErrorControl   = 1               ; SERVICE_ERROR_NORMAL
ServiceBinary  = %12%\HypervisorCheckR0.sys

;
;--- HypervisorCheckR0_Device Coinstaller installation ------
;

[HypervisorCheckR0_Device.NT.CoInstallers]
AddReg=HypervisorCheckR0_Device_CoInstaller_AddReg
CopyFiles=HypervisorCheckR0_Device_CoInstaller_CopyFiles

[HypervisorCheckR0_Device_CoInstaller_AddReg]
HKR,,CoInstallers32,0x00010000, "WdfCoInstaller$KMDFCOINSTALLERVERSION$.dll,WdfCoInstaller"

[HypervisorCheckR0_Device_CoInstaller_CopyFiles]
WdfCoInstaller$KMDFCOINSTALLERVERSION$.dll

[HypervisorCheckR0_Device.NT.Wdf]
KmdfService =  HypervisorCheckR0, HypervisorCheckR0_wdfsect
[HypervisorCheckR0_wdfsect]
KmdfLibraryVersion = $KMDFVERSION$

[Strings]
SPSVCINST_ASSOCSERVICE= 0x00000002
ManufacturerName="<Your manufacturer name>" ;TODO: Replace with your manufacturer name
ClassName="Samples" ; TODO: edit ClassName
DiskName = "HypervisorCheckR0 Installation Disk"
HypervisorCheckR0.DeviceDesc = "HypervisorCheckR0 Device"
HypervisorCheckR0.SVCDESC = "HypervisorCheckR0 Service"

```

`HypervisorCheckR0/HypervisorCheckR0.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|ARM">
      <Configuration>Debug</Configuration>
      <Platform>ARM</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|ARM">
      <Configuration>Release</Configuration>
      <Platform>ARM</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|ARM64">
      <Configuration>Debug</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|ARM64">
      <Configuration>Release</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <ProjectGuid>{164DF69B-E119-41A4-A578-49663695145F}</ProjectGuid>
    <TemplateGuid>{1bc93793-694f-48fe-9372-81e2b05556fd}</TemplateGuid>
    <TargetFrameworkVersion>v4.5</TargetFrameworkVersion>
    <MinimumVisualStudioVersion>12.0</MinimumVisualStudioVersion>
    <Configuration>Debug</Configuration>
    <Platform Condition="'$(Platform)' == ''">Win32</Platform>
    <RootNamespace>HypervisorCheckR0</RootNamespace>
    <WindowsTargetPlatformVersion>$(LatestTargetPlatformVersion)</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
    <Driver_SpectreMitigation>false</Driver_SpectreMitigation>
    <ALLOW_DATE_TIME>1</ALLOW_DATE_TIME>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
    <Import Project="$(VCTargetsPath)\BuildCustomizations\masm.props" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <TimeStampServer>
    </TimeStampServer>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <LanguageStandard>stdcpp17</LanguageStandard>
    </ClCompile>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <LanguageStandard_C>stdc17</LanguageStandard_C>
    </ClCompile>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <LanguageStandard>stdcpp17</LanguageStandard>
    </ClCompile>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <LanguageStandard_C>stdc17</LanguageStandard_C>
      <WarningLevel>Level2</WarningLevel>
      <TreatWarningAsError>false</TreatWarningAsError>
      <ExceptionHandling>SyncCThrow</ExceptionHandling>
      <BufferSecurityCheck>false</BufferSecurityCheck>
      <ControlFlowGuard>false</ControlFlowGuard>
    </ClCompile>
    <Link>
      <TreatLinkerWarningAsErrors>false</TreatLinkerWarningAsErrors>
      <EntryPointSymbol>DriverEntry</EntryPointSymbol>
      <AdditionalDependencies>%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <Inf Include="HypervisorCheckR0.inf" />
  </ItemGroup>
  <ItemGroup>
    <FilesToPackage Include="$(TargetPath)" />
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="DriverEntry.cpp" />
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="HypervisorDetect.hpp" />
    <ClInclude Include="NtApiDef.h" />
    <ClInclude Include="Struct.h" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
    <Import Project="$(VCTargetsPath)\BuildCustomizations\masm.targets" />
  </ImportGroup>
</Project>
```

`HypervisorCheckR0/HypervisorCheckR0.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hpp;hxx;hm;inl;inc;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
    <Filter Include="Driver Files">
      <UniqueIdentifier>{8E41214B-6785-4CFE-B992-037D68949A14}</UniqueIdentifier>
      <Extensions>inf;inv;inx;mof;mc;</Extensions>
    </Filter>
    <Filter Include="HypDetect">
      <UniqueIdentifier>{99a54c3d-b1a4-4d0e-bb2c-feb38413f6d1}</UniqueIdentifier>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <Inf Include="HypervisorCheckR0.inf">
      <Filter>Driver Files</Filter>
    </Inf>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="DriverEntry.cpp">
      <Filter>Driver Files</Filter>
    </ClCompile>
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="Struct.h">
      <Filter>Header Files</Filter>
    </ClInclude>
    <ClInclude Include="HypervisorDetect.hpp">
      <Filter>HypDetect</Filter>
    </ClInclude>
    <ClInclude Include="NtApiDef.h">
      <Filter>Header Files</Filter>
    </ClInclude>
  </ItemGroup>
</Project>
```

`HypervisorCheckR0/HypervisorCheckR0.vcxproj.user`:

```user
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="Current" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup />
</Project>
```

`HypervisorCheckR0/HypervisorDetect.hpp`:

```hpp
#pragma once
#include "Struct.h"
 

/*
We can't use SEH for manual map driver's

*/

namespace DetectHyp
{
	bool ProcIsIntel()
	{
		int cpuid[4]{ -1 };
		__cpuid(cpuid, 0);
		if (cpuid[2] == 'letn')
		{
			return TRUE;
		}
		return FALSE;
	}

	 bool compare_list_cpuid() 
	{
		//compare cpuid  list
		int  invalid_cpuid_list[4] = { -1 };
		int valid_cpuid_list[4] = { -1 };

		__cpuid(invalid_cpuid_list, 0x13371337);
		__cpuid(valid_cpuid_list, 0x40000000);

		if ((invalid_cpuid_list[0] != valid_cpuid_list[0]) ||
			(invalid_cpuid_list[1] != valid_cpuid_list[1]) ||
			(invalid_cpuid_list[2] != valid_cpuid_list[2]) ||
			(invalid_cpuid_list[3] != valid_cpuid_list[3]))
			return TRUE;

		return FALSE; 



	}

	 bool cpuid_is_hypervisor()
	{
		int cpuid[4] = { 0 };
		__cpuid(cpuid, 1);
		return ((cpuid[2] >> 31) & 1);
	}



	  bool   time_attack_rdtsc()
	{ 
		uint64_t avg = 0;
		int cpuInfo[4] = {};
		for (int i = 0; i < 2500; i++)
		{

			auto currentIrql = __readcr8(); 
			__writecr8(HIGH_LEVEL);

			_disable();
			auto tick1 = __readmsr(IA32_TIME_STAMP_COUNTER);
			__cpuid(cpuInfo, 0);// vm-exit
			auto tick2 = __readmsr(IA32_TIME_STAMP_COUNTER);
			_enable();

			__writecr8(currentIrql);

			avg += (tick2 - tick1);
		}
		avg /= 2500;  
		return (avg > 500) || (25 > avg) ; 
	}

	 
 


	 bool time_attack_MPERF()
	{
		 // Some hypervisor just return 0(like:VMware)

		int cpuid[4]{ -1 };
		uint64_t  avg{ 0 };
		for (int i = 0; i < 100; i++)
		{
			auto currentIrql = __readcr8();
			__writecr8(HIGH_LEVEL);

			_disable(); 
			auto tick1 = __readmsr(IA32_MPERF_MSR);
			__cpuid(cpuid, 0);//call vm-exit
			auto tick2 = __readmsr(IA32_MPERF_MSR);
			_enable();

			__writecr8(currentIrql);

			if ( (!tick1 && !tick2 ) || (tick1 == tick2))
			{
				return true;
			}

			avg += (tick2 - tick1);
		}
		avg /= 100;   
		return  (0x4ff < avg) || (0xc > avg);
	}
	


	 bool time_attack_APERF()
	{
		uint64_t avg{ 0 };
		int data[4]{ -1 };
		for (size_t i = 0; i < 100; i++)
		{
			auto currentIrql = __readcr8();
			__writecr8(HIGH_LEVEL);


			_disable();
			auto  tick1 = __readmsr(IA32_APERF_MSR);
			__cpuid(data, 0); //call vm-exit
			auto tick2 = __readmsr(IA32_APERF_MSR);
			_enable();

			__writecr8(currentIrql);

			if ( (!tick1 && !tick2) || (tick1 == tick2))
			{
				return true;
			}
			avg += (tick2 - tick1);
		}
		avg /= 100;   
		return  (0x4ff < avg) || (0x33 > avg);
	}
	
	 bool lbr_is_virtulazed()
	{
		if (ProcIsIntel())
		{
			auto current_value = __readmsr(MSR_DEBUGCTL);//safe current value
			__writemsr(MSR_DEBUGCTL, DEBUGCTL_LBR | DEBUGCTL_BTF);
			auto whatch_write = __readmsr(MSR_DEBUGCTL);
			__writemsr(MSR_DEBUGCTL, current_value);
			return (!(whatch_write & DEBUGCTL_LBR));
		}
		return FALSE;
	}
 
	 bool lbr_stask_is_virtulazed()
	{
		int cpuid[4]{ -1 };
		 auto currentLBR =	__readmsr(MSR_P6M_LBSTK_TOS); 
		 __cpuid(cpuid, 0);//call vm-exit
		 auto exitLBR =	__readmsr(MSR_P6M_LBSTK_TOS); 
		 return currentLBR != exitLBR;

	}

	
	
	 
	
}

```

`HypervisorCheckR0/Struct.h`:

```h
#pragma once
#include <ntdef.h>
#include <ntifs.h>
#include <ntddk.h>
#include <ntddk.h>
#include <minwindef.h>
#include <intrin.h>
#include <cstdint>

#define IA32_P5_MC_ADDR_MSR		0x00000000
#define DEBUGCTL_LBR            0x01
#define DEBUGCTL_BTF            0x02
#define	IA32_TIME_STAMP_COUNTER 0x00000010
#define SMI_COUNT_MSR 0x00000034
#define IA32_MPERF_MSR 0x000000E7
#define IA32_APERF_MSR 0x000000E8
#define	MSR_P6M_LBSTK_TOS	0x1c9
#define	MSR_DEBUGCTL		0x1d9


 

 

```

`README.md`:

```md
# Hypervisor_detect_ring_0
Check hypervisor in ring 0
Some check in hypervisor.Code based on Secret Club articles (How anti-cheat detect system emulation)  
Code was written for manual map driver  

```