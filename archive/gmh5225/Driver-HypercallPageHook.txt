Project Path: arc_gmh5225_Driver-HypercallPageHook_i52tsjm0

Source Tree:

```txt
arc_gmh5225_Driver-HypercallPageHook_i52tsjm0
├── HypercallPageHook.sln
├── README.md
└── projects
    └── HypercallPageHook
        ├── DriverEntry.cpp
        ├── HypercallHook
        │   ├── Dispatcher.asm
        │   ├── HypercallHook.cpp
        │   └── HypercallHook.hpp
        ├── HypercallPageHook.vcxproj
        ├── HypercallPageHook.vcxproj.filters
        └── HypercallPageHook.vcxproj.user

```

`HypercallPageHook.sln`:

```sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.5.33627.172
MinimumVisualStudioVersion = 10.0.40219.1
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "HypercallPageHook", "projects\HypercallPageHook\HypercallPageHook.vcxproj", "{86AE2793-77E5-4FA3-9BE6-E38F8B3C4622}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|x64 = Debug|x64
		Release|x64 = Release|x64
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{86AE2793-77E5-4FA3-9BE6-E38F8B3C4622}.Debug|x64.ActiveCfg = Debug|x64
		{86AE2793-77E5-4FA3-9BE6-E38F8B3C4622}.Debug|x64.Build.0 = Debug|x64
		{86AE2793-77E5-4FA3-9BE6-E38F8B3C4622}.Debug|x64.Deploy.0 = Debug|x64
		{86AE2793-77E5-4FA3-9BE6-E38F8B3C4622}.Release|x64.ActiveCfg = Release|x64
		{86AE2793-77E5-4FA3-9BE6-E38F8B3C4622}.Release|x64.Build.0 = Release|x64
		{86AE2793-77E5-4FA3-9BE6-E38F8B3C4622}.Release|x64.Deploy.0 = Release|x64
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {E5D7216D-3A03-4A28-89E0-4803862FA069}
	EndGlobalSection
EndGlobal

```

`README.md`:

```md
# HypercallPageHook
POC Hook of nt!HvcallCodeVa

```

`projects/HypercallPageHook/DriverEntry.cpp`:

```cpp
#include "HypercallHook/HypercallHook.hpp"

#define DEBUG_PRINT(Format, ...) DbgPrint("[HypercallHook]" Format, __VA_ARGS__)

UINT16
HookedSwitchVirtualAddressSpace(
    UINT64 newCR3
)
{
    DEBUG_PRINT("SwitchVirtualAddressSpace | NewCR3 = 0x%llX, Processor = 0x%X\n", newCR3, KeGetCurrentProcessorIndex());
    return hypercallHook::OriginalSwitchVirtualAddressSpace(newCR3);
}

[[maybe_unused]] VOID
DriverUnload(
)
{
    hypercallHook::Deinitialize();
}

NTSTATUS
DriverEntry(
)
{
    if (!hypercallHook::Initialize())
    {
        DEBUG_PRINT("Initialize failed. Maybe Hyper-V isn't enabled?");
        return STATUS_UNSUCCESSFUL;
    }

    hypercallHook::RegisterSwitchVirtualAddressSpaceHook(&HookedSwitchVirtualAddressSpace);
    DEBUG_PRINT("Hook registered");

    return STATUS_SUCCESS;
}

```

`projects/HypercallPageHook/HypercallHook/Dispatcher.asm`:

```asm
EXTERN Hypercall_HypercallPage : QWORD
EXTERN Hypercall_Handle_SwitchVirtualAddressSpace : PROC

.CODE

Hypercall_HypercallPageHook PROC

	; Example of hooking HvlSwitchVirtualAddressSpace
	cmp rcx, 10001h
	je Hypercall_Handle_SwitchVirtualAddressSpace

	; Add more here...

	jmp Hypercall_HypercallPage
Hypercall_HypercallPageHook ENDP

END
```

`projects/HypercallPageHook/HypercallHook/HypercallHook.cpp`:

```cpp
#include "HypercallHook.hpp"
// https://learn.microsoft.com/en-us/virtualization/hyper-v-on-windows/tlfs/hypercall-interface

extern "C" {
// nt!HvlInvokeHypercall
// Contains a reference to nt!HvcallCodeVa
_declspec(dllimport) UINT16 HvlInvokeHypercall(UINT64 HypercallInput, UINT64 Input, UINT64 Output);

// nt!HvlQueryConnection
// Test if Hyper-V is enabled
_declspec(dllimport) NTSTATUS HvlQueryConnection(PVOID *HypercallCodeVa);
}

namespace hypercallHook {
using FnInvokeHypercall = decltype(&HvlInvokeHypercall);

FnInvokeHypercall *HvcallCodeVa {};      // Address of nt!HvcallCodeVa
UINT32            *HvlEnlightenments {}, // Address of nt!HvlEnlightenments
                   originalHvlEnlightenments {};

FnSwitchVirtualAddressSpace callbackToSwitchVirtualAddressSpace {};
}  // namespace hypercallHook
using namespace hypercallHook;

extern "C" {
FnInvokeHypercall Hypercall_HypercallPage {}; // Original value of HvcallCodeVa, essentially points to
                                              // vmcall
                                              // ret
UINT16 Hypercall_HypercallPageHook(UINT64 HypercallInput, UINT64 Input, UINT64 Output);

// Hook handler for all calls to HvlSwitchVirtualAddressSpace
UINT16 Hypercall_Handle_SwitchVirtualAddressSpace(
    UINT64, UINT64 newCR3, UINT64 // 0x10001, newCR3, NULL
)
{
    if (callbackToSwitchVirtualAddressSpace)
    {
        // Delegate responsibility to switch VA space to the callback function
        return callbackToSwitchVirtualAddressSpace(newCR3);
    }
    else
    {
        return OriginalSwitchVirtualAddressSpace(newCR3);
    }
}
// Add more here...
}

BOOLEAN
hypercallHook::Initialize(
)
{
    if (!NT_SUCCESS(HvlQueryConnection(nullptr)))
        return false;

    //
    // Find the address of nt!HvcallCodeVa
    //
    for (UINT8 *it = reinterpret_cast<UINT8*>(&HvlInvokeHypercall);
                it < (reinterpret_cast<UINT8*>(&HvlInvokeHypercall) + 0x1000); ++it)
    {
        if (memcmp(it, "\x40\x32\xFF\x48\x8B\05", 6) == 0)
        {
            HvcallCodeVa = reinterpret_cast<decltype(HvcallCodeVa)>(it + 10 + *reinterpret_cast<int*>(it + 6));
            break;
        }
    }

    if (!HvcallCodeVa)
        return false;

    //
    // Find the address of HvlEnlightenments
    //
    HvlEnlightenments = reinterpret_cast<UINT32*>(&PsInitialSystemProcess) - 1;

    //
    // Overwrite the hypercall page (VA) pointer
    //
    Hypercall_HypercallPage = reinterpret_cast<decltype(Hypercall_HypercallPage)>(
        _InterlockedExchange64(reinterpret_cast<LONG64*>(HvcallCodeVa), reinterpret_cast<LONG64>(&Hypercall_HypercallPageHook)));

    //
    // Cause the kernel to transfer execution to hypervisor for context switches
    //
    originalHvlEnlightenments = _InterlockedOr(reinterpret_cast<LONG*>(HvlEnlightenments), 1); // HvSwitchVirtualAddressSpace

    return true;
}

VOID
hypercallHook::Deinitialize(
)
{
    _InterlockedExchange(reinterpret_cast<LONG*>(HvlEnlightenments), originalHvlEnlightenments);
    _InterlockedExchange64(reinterpret_cast<LONG64*>(HvcallCodeVa), reinterpret_cast<LONG64>(Hypercall_HypercallPage));
}

VOID
hypercallHook::RegisterSwitchVirtualAddressSpaceHook(
    FnSwitchVirtualAddressSpace callback
)
{
    callbackToSwitchVirtualAddressSpace = callback;
}

UINT16
hypercallHook::OriginalSwitchVirtualAddressSpace(
    UINT64 newCR3
)
{
    return Hypercall_HypercallPage(0x10001, newCR3, NULL);
}

```

`projects/HypercallPageHook/HypercallHook/HypercallHook.hpp`:

```hpp
#pragma once

#include <ntddk.h>
#include <intrin.h>

namespace hypercallHook {

BOOLEAN
Initialize(
);

VOID
Deinitialize(
);

using FnSwitchVirtualAddressSpace = UINT16(*)(UINT64 newCR3);

VOID
RegisterSwitchVirtualAddressSpaceHook(
	FnSwitchVirtualAddressSpace callback
);

UINT16
OriginalSwitchVirtualAddressSpace(
	UINT64 newCR3
);

}  // namespace hypercallHook

```

`projects/HypercallPageHook/HypercallPageHook.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <ProjectGuid>{86AE2793-77E5-4FA3-9BE6-E38F8B3C4622}</ProjectGuid>
    <TemplateGuid>{1bc93793-694f-48fe-9372-81e2b05556fd}</TemplateGuid>
    <TargetFrameworkVersion>v4.5</TargetFrameworkVersion>
    <MinimumVisualStudioVersion>12.0</MinimumVisualStudioVersion>
    <Configuration>Debug</Configuration>
    <Platform Condition="'$(Platform)' == ''">x64</Platform>
    <RootNamespace>HypercallPageHook</RootNamespace>
    <WindowsTargetPlatformVersion>$(LatestTargetPlatformVersion)</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
    <Driver_SpectreMitigation>false</Driver_SpectreMitigation>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
    <Driver_SpectreMitigation>false</Driver_SpectreMitigation>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
    <Import Project="$(VCTargetsPath)\BuildCustomizations\masm.props" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <OutDir>$(SolutionDir)compiled\$(Configuration)\</OutDir>
    <IntDir>$(SolutionDir)compiled-obj\$(Configuration)\$(ProjectName)\</IntDir>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
    <OutDir>$(SolutionDir)compiled\$(Configuration)\</OutDir>
    <IntDir>$(SolutionDir)compiled-obj\$(Configuration)\$(ProjectName)\</IntDir>
  </PropertyGroup>
  <PropertyGroup Label="Vcpkg">
    <VcpkgEnabled>false</VcpkgEnabled>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <DriverSign>
      <FileDigestAlgorithm>sha256</FileDigestAlgorithm>
    </DriverSign>
    <ClCompile>
      <LanguageStandard>stdcpplatest</LanguageStandard>
      <BufferSecurityCheck>false</BufferSecurityCheck>
      <ControlFlowGuard>false</ControlFlowGuard>
      <MultiProcessorCompilation>true</MultiProcessorCompilation>
    </ClCompile>
    <Link>
      <EntryPointSymbol>DriverEntry</EntryPointSymbol>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <DriverSign>
      <FileDigestAlgorithm>sha256</FileDigestAlgorithm>
    </DriverSign>
    <ClCompile>
      <LanguageStandard>stdcpplatest</LanguageStandard>
      <BufferSecurityCheck>false</BufferSecurityCheck>
      <ControlFlowGuard>false</ControlFlowGuard>
      <MultiProcessorCompilation>true</MultiProcessorCompilation>
    </ClCompile>
    <Link>
      <EntryPointSymbol>DriverEntry</EntryPointSymbol>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <FilesToPackage Include="$(TargetPath)" />
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="DriverEntry.cpp" />
    <ClCompile Include="HypercallHook\HypercallHook.cpp" />
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="HypercallHook\HypercallHook.hpp" />
  </ItemGroup>
  <ItemGroup>
    <MASM Include="HypercallHook\Dispatcher.asm" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
    <Import Project="$(VCTargetsPath)\BuildCustomizations\masm.targets" />
  </ImportGroup>
</Project>
```

`projects/HypercallPageHook/HypercallPageHook.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hpp;hxx;hm;inl;inc;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
    <Filter Include="Driver Files">
      <UniqueIdentifier>{8E41214B-6785-4CFE-B992-037D68949A14}</UniqueIdentifier>
      <Extensions>inf;inv;inx;mof;mc;</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="DriverEntry.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
    <ClCompile Include="HypercallHook\HypercallHook.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="HypercallHook\HypercallHook.hpp">
      <Filter>Header Files</Filter>
    </ClInclude>
  </ItemGroup>
  <ItemGroup>
    <MASM Include="HypercallHook\Dispatcher.asm">
      <Filter>Source Files</Filter>
    </MASM>
  </ItemGroup>
</Project>
```

`projects/HypercallPageHook/HypercallPageHook.vcxproj.user`:

```user
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="Current" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <ShowAllFiles>true</ShowAllFiles>
  </PropertyGroup>
</Project>
```