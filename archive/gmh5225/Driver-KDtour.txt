Project Path: arc_gmh5225_Driver-KDtour_rsn69wsk

Source Tree:

```txt
arc_gmh5225_Driver-KDtour_rsn69wsk
├── README.md
├── definitions.h
├── detour.h
├── entry.cpp
├── imports.h
├── kdtour.vcxproj
├── kdtour.vcxproj.filters
├── kdtour.vcxproj.user
└── utils.h

```

`README.md`:

```md
This is an old project i made, you can hook kernel functions for example: MmCopyMemory, MmCopyVirtualMemory and so on. (winver: 21H2)

get creative, you may be able to avoid your memory not be found by anti-cheats ;)

 - 1 Header file
 - No External Library
 - Simple to use
 - Custom Shellcode
 - Hooking without triggering PageGuard
 - Fully documented

# KDtour
A simple Kernel Detour Library

```

`definitions.h`:

```h
typedef struct _RTL_PROCESS_MODULE_INFORMATION
{
	void* section;
	void* mapped_base;
	void *image_base;
	unsigned long image_size;
	unsigned long flags;
	unsigned short load_order_index;
	unsigned short init_order_index;
	unsigned short load_count;
	unsigned short offset_to_file_name;
	unsigned char  full_path_name[256];
} RTL_PROCESS_MODULE_INFORMATION, *PRTL_PROCESS_MODULE_INFORMATION;

typedef struct _RTL_PROCESS_MODULES
{
	unsigned long number_of_modules;
	RTL_PROCESS_MODULE_INFORMATION modules[1];
} RTL_PROCESS_MODULES, *PRTL_PROCESS_MODULES;

typedef enum _SYSTEM_INFORMATION_CLASS
{
	system_basic_information,
	system_processor_information,
	system_performance_information,
	system_time_of_day_information,
	system_path_information,
	system_process_information,
	system_call_count_information,
	system_device_information,
	system_processor_performance_information,
	system_flags_information,
	system_call_time_information,
	system_module_information,
	system_locks_information,
	system_stack_trace_information,
	system_paged_pool_information,
	system_non_paged_pool_information,
	system_handle_information,
	system_object_information,
	system_page_file_information,
	system_vdm_instemul_information,
	system_vdm_bop_information,
	system_file_cache_information,
	system_pool_tag_information,
	system_interrupt_information,
	system_dpc_behavior_information,
	system_full_memory_information,
	system_load_gdi_driver_information,
	system_unload_gdi_driver_information,
	system_time_adjustment_information,
	system_summary_memory_information,
	system_next_event_id_information,
	system_event_ids_information,
	system_crash_dump_information,
	system_exception_information,
	system_crash_dump_state_information,
	system_kernel_debugger_information,
	system_context_switch_information,
	system_registry_quota_information,
	system_extend_service_table_information,
	system_priority_seperation,
	system_plug_play_bus_information,
	system_dock_information,
	system_processor_speed_information,
	system_current_time_zone_information,
	system_lookaside_information
} SYSTEM_INFORMATION_CLASS, *PSYSTEM_INFORMATION_CLASS;

extern "C" NTKERNELAPI NTSTATUS NTAPI ZwQuerySystemInformation( SYSTEM_INFORMATION_CLASS, void *, unsigned long, unsigned long * );
extern "C" NTKERNELAPI PVOID NTAPI RtlFindExportedRoutineByName( PVOID, PCCH );

```

`detour.h`:

```h
/*
							 __  __     _____     ______   ______     __  __     ______
							/\ \/ /    /\  __-.  /\__  _\ /\  __ \   /\ \/\ \   /\  == \
							\ \  _"-.  \ \ \/\ \ \/_/\ \/ \ \ \/\ \  \ \ \_\ \  \ \  __<
							 \ \_\ \_\  \ \____-    \ \_\  \ \_____\  \ \_____\  \ \_\ \_\
							  \/_/\/_/   \/____/     \/_/   \/_____/   \/_____/   \/_/ /_/
									 simple kernel detour library made by Tuple ©
*/

#ifndef DISABLE_INCLUDES
#include <ntifs.h>
#endif

class c_detour
{
private:
	// unknowncheats.me/forum/2310525-post10.html
	auto wrom( void *src, void *dst, const size_t size ) -> bool
	{
		const auto mdl = IoAllocateMdl( src, size, 0, 0, 0 );

		if ( !mdl )
		{
			return false;
		}

		MmProbeAndLockPages( mdl, KernelMode, IoReadAccess );

		auto map = MmMapLockedPagesSpecifyCache( 
			mdl, KernelMode, MmNonCached, 0, 0, NormalPagePriority );

		if ( !map )
		{
			MmUnmapLockedPages( map, mdl );
			MmUnlockPages( mdl );
			IoFreeMdl( mdl );
			return false;
		}

		MmProtectMdlSystemAddress( mdl, PAGE_READWRITE );

		memcpy( map, dst, size );

		MmUnmapLockedPages( map, mdl );
		MmUnlockPages( mdl );
		IoFreeMdl( mdl );

		return true;
	}

	void *src = nullptr;												// our hooked function address
	void *dst = nullptr;												// our handler address
	unsigned char org[38] = { 0x00 };									// original bytes for uninstall
	bool enabled = false;												// for toggling

public:

	c_detour( void *src, void *dst )									// class constructor
		: src( src ), dst( dst ) { }									// src = function address that gets hooked, dst = our handler

	c_detour( ) {}														// default class constructor

	auto install( ) -> bool												// install function that overwrites function code
	{
		memcpy( this->org, this->src, 38 );								// saves stolen bytes in our variable "org"

		unsigned char jmp_code[] =										// pretty sure this is flagged by anything better then battleye
		{
			0x48, 0xba, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // mov rdx, 00 00 00 00 00 00 00 00 ; clear rdx register
			0x48, 0xb9, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // mov rcx, 00 00 00 00 00 00 00 00 ; clear rcx register
			0x48, 0x01, 0xd1,											// add rcx, rdx						; set rcx with our handler addres
			0x48, 0x29, 0xca,											// sub rdx, rcx						; clear rdx register from old address
			0xff, 0xe1,													// jmp rcx							; jump to our handler address
			0x48, 0xb9, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00	// mov rcx, 00 00 00 00 00 00 00 00 ; clear rcx register
		};

		memcpy( ( void * )( jmp_code + 2 ), ( uintptr_t * )&dst, 8 );	// set the rdx address to our handler address  

		return this->wrom( this->src, jmp_code, 38 );					// write that shellcode in the rom section
	}

	auto uninstall( ) -> bool											// uninstall function, restore all stolen bytes
	{
		return this->wrom( this->src, this->org, 38 );					// write back the saved bytes
	}

	auto toggle( ) -> bool												// a small wrapper arround uninstall and install
	{
		if ( !this->src || !this->dst )									// check if the addresses are bad to avoid bluescreening
		{
			return false;												// return false if those are invalid
		}

		this->enabled = !this->enabled;									// if its true then its false, if its false then its true

		if ( this->enabled )											// check if its enabled after toggling
		{
			return this->install( );									// if enabled is true then we install
		}

		return this->uninstall( );										// this is like an else if its not enabled then it uninstalls
	}
};

```

`entry.cpp`:

```cpp
#include "imports.h"

auto ke_attach_process_hk( PRKPROCESS process ) -> void
{
	DbgPrintEx( 0, 0, "ke_attach_process_hk called" );
}

auto DriverEntry( ) -> NTSTATUS
{					
	const auto ntoskrnl = utils::get_kernel_module( "ntoskrnl.exe" );

	auto ke_attach_process = c_detour( utils::get_kernel_export < void * >( ntoskrnl, "KeAttachProcess" ), &ke_attach_process_hk );

	ke_attach_process.install( ); // hooks function

	ke_attach_process.uninstall( ); // unhooks function

	ke_attach_process.toggle( ); // just a basic switch to install/uninstall 

	return STATUS_SUCCESS;
}
```

`imports.h`:

```h
#include <ntifs.h>
#include <ntddk.h>
#include <ntimage.h>
#include <ntdef.h>
#include <windef.h>
#include <ntimage.h>
#include <intrin.h>
#include <ntstrsafe.h>

#include "definitions.h"

#include "detour.h"
#include "utils.h"
```

`kdtour.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <Keyword>Win32Proj</Keyword>
    <ProjectGuid>{7e81fcc8-bf6c-40e4-ac92-4b6604b370fa}</ProjectGuid>
    <RootNamespace>mmcopyhook</RootNamespace>
    <WindowsTargetPlatformVersion>10.0.22000.0</WindowsTargetPlatformVersion>
    <ProjectName>kdtour</ProjectName>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Driver</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>NotSet</CharacterSet>
    <TargetVersion>Windows10</TargetVersion>
    <DriverTargetPlatform>Universal</DriverTargetPlatform>
    <DriverType>KMDF</DriverType>
    <ALLOW_DATE_TIME>1</ALLOW_DATE_TIME>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <LinkIncremental>true</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <LinkIncremental>false</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <LinkIncremental>true</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <LinkIncremental>false</LinkIncremental>
    <OutDir>$(SolutionDir)bin\</OutDir>
    <IntDir>$(SolutionDir)bin\intermediates\</IntDir>
    <TargetName>$(ProjectName)_x64</TargetName>
    <EnableInf2cat>false</EnableInf2cat>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>TurnOffAllWarnings</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
      <LanguageStandard>stdcpp20</LanguageStandard>
      <LanguageStandard_C>stdc17</LanguageStandard_C>
    </ClCompile>
    <Link>
      <SubSystem>Native</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>false</GenerateDebugInformation>
      <AdditionalDependencies>%(AdditionalDependencies);$(KernelBufferOverflowLib);$(DDK_LIB_PATH)ntoskrnl.lib;$(DDK_LIB_PATH)hal.lib;$(DDK_LIB_PATH)wmilib.lib;$(KMDF_LIB_PATH)$(KMDF_VER_PATH)\WdfLdr.lib;$(KMDF_LIB_PATH)$(KMDF_VER_PATH)\WdfDriverEntry.lib</AdditionalDependencies>
      <IgnoreAllDefaultLibraries>true</IgnoreAllDefaultLibraries>
      <MinimumRequiredVersion>$(SUBSYSTEM_NATVER)</MinimumRequiredVersion>
      <Driver>Driver</Driver>
      <EntryPointSymbol>DriverEntry</EntryPointSymbol>
      <RandomizedBaseAddress />
      <DataExecutionPrevention />
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="entry.cpp" />
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="definitions.h" />
    <ClInclude Include="detour.h" />
    <ClInclude Include="imports.h" />
    <ClInclude Include="utils.h" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`kdtour.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <ClCompile Include="entry.cpp" />
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="utils.h" />
    <ClInclude Include="imports.h" />
    <ClInclude Include="definitions.h" />
    <ClInclude Include="detour.h" />
  </ItemGroup>
</Project>
```

`kdtour.vcxproj.user`:

```user
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="Current" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <SignMode>Off</SignMode>
  </PropertyGroup>
</Project>
```

`utils.h`:

```h
namespace utils
{
    auto get_system_information( SYSTEM_INFORMATION_CLASS information_class ) -> void *
    {
        unsigned long size = 32;
        char buffer[32];

        ZwQuerySystemInformation( information_class, buffer, size, &size );

        void *info = ExAllocatePoolZero( NonPagedPool, size, 'hjjd' );

        if ( !info )
            return nullptr;

        if ( !NT_SUCCESS( ZwQuerySystemInformation( information_class, info, size, &size ) ) )
        {
            ExFreePool( info );
            return nullptr;
        }

        return info;
    }

    auto get_kernel_module( const char *name ) -> uintptr_t
    {
        const auto to_lower = []( char *string ) -> const char *
        {
            for ( char *pointer = string; *pointer != '\0'; ++pointer )
            {
                *pointer = ( char )( short )tolower( *pointer );
            }

            return string;
        };

        const PRTL_PROCESS_MODULES info = ( PRTL_PROCESS_MODULES )get_system_information( system_module_information );

        if ( !info )
        {
            return 0;
        }

        for ( size_t i = 0; i < info->number_of_modules; ++i )
        {
            const auto &mod = info->modules[i];

            if ( strcmp( to_lower( ( char * )mod.full_path_name + mod.offset_to_file_name ), name ) == 0 )
            {
                const void *address = mod.image_base;
                ExFreePool( info );
               
                return reinterpret_cast< uintptr_t > ( address );
            }
        }

        ExFreePool( info );

        return 0;
    }

    template <typename t>
    auto get_kernel_export( const uintptr_t base, const char* name ) -> t
    {
        return reinterpret_cast< t >( RtlFindExportedRoutineByName( reinterpret_cast<void*> ( base ), name ) );
    }
}
```