Project Path: arc_gmh5225_QuickPGTrigger_7ufw3joa

Source Tree:

```txt
arc_gmh5225_QuickPGTrigger_7ufw3joa
├── QuickPGTrigger
│   ├── QuickPGTrigger.sln
│   ├── QuickPGTrigger.vcxproj
│   ├── QuickPGTrigger.vcxproj.filters
│   ├── main.cpp
│   ├── trigger.h
│   └── trigger.idt.cpp
└── README.md

```

`QuickPGTrigger/QuickPGTrigger.sln`:

```sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 16
VisualStudioVersion = 16.0.31613.86
MinimumVisualStudioVersion = 10.0.40219.1
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "QuickPGTrigger", "QuickPGTrigger.vcxproj", "{3969065A-D7B8-4167-A23A-E0972A1D1E74}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|x64 = Debug|x64
		Release|x64 = Release|x64
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{3969065A-D7B8-4167-A23A-E0972A1D1E74}.Debug|x64.ActiveCfg = Debug|x64
		{3969065A-D7B8-4167-A23A-E0972A1D1E74}.Debug|x64.Build.0 = Debug|x64
		{3969065A-D7B8-4167-A23A-E0972A1D1E74}.Debug|x64.Deploy.0 = Debug|x64
		{3969065A-D7B8-4167-A23A-E0972A1D1E74}.Release|x64.ActiveCfg = Release|x64
		{3969065A-D7B8-4167-A23A-E0972A1D1E74}.Release|x64.Build.0 = Release|x64
		{3969065A-D7B8-4167-A23A-E0972A1D1E74}.Release|x64.Deploy.0 = Release|x64
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {67137D3B-A314-4436-BA61-889DC0856556}
	EndGlobalSection
EndGlobal

```

`QuickPGTrigger/QuickPGTrigger.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <ProjectGuid>{3969065A-D7B8-4167-A23A-E0972A1D1E74}</ProjectGuid>
    <TemplateGuid>{1bc93793-694f-48fe-9372-81e2b05556fd}</TemplateGuid>
    <TargetFrameworkVersion>v4.5</TargetFrameworkVersion>
    <MinimumVisualStudioVersion>12.0</MinimumVisualStudioVersion>
    <Configuration>Debug</Configuration>
    <Platform Condition="'$(Platform)' == ''">Win32</Platform>
    <RootNamespace>QuickPGTrigger</RootNamespace>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>
    </DriverTargetPlatform>
    <Driver_SpectreMitigation>false</Driver_SpectreMitigation>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <TargetVersion>Windows10</TargetVersion>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>
    <ConfigurationType>Driver</ConfigurationType>
    <DriverType>KMDF</DriverType>
    <DriverTargetPlatform>
    </DriverTargetPlatform>
    <Driver_SpectreMitigation>false</Driver_SpectreMitigation>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="PropertySheets">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
    </ClCompile>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <TreatWarningAsError>false</TreatWarningAsError>
      <BufferSecurityCheck>false</BufferSecurityCheck>
      <ControlFlowGuard>false</ControlFlowGuard>
    </ClCompile>
    <Link>
      <TreatLinkerWarningAsErrors>false</TreatLinkerWarningAsErrors>
      <EntryPointSymbol>DriverEntry</EntryPointSymbol>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
    </ClCompile>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <TreatWarningAsError>false</TreatWarningAsError>
      <BufferSecurityCheck>false</BufferSecurityCheck>
      <ControlFlowGuard>false</ControlFlowGuard>
    </ClCompile>
    <Link>
      <TreatLinkerWarningAsErrors>false</TreatLinkerWarningAsErrors>
      <EntryPointSymbol>DriverEntry</EntryPointSymbol>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <FilesToPackage Include="$(TargetPath)" />
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="main.cpp" />
    <ClCompile Include="trigger.idt.cpp" />
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="trigger.h" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`QuickPGTrigger/QuickPGTrigger.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hpp;hxx;hm;inl;inc;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="main.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
    <ClCompile Include="trigger.idt.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="trigger.h">
      <Filter>Header Files</Filter>
    </ClInclude>
  </ItemGroup>
</Project>
```

`QuickPGTrigger/main.cpp`:

```cpp
#include "trigger.h"

VOID DrvUnload(PDRIVER_OBJECT DriverObject) {}

EXTERN_C
NTSTATUS
DriverEntry(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath) {
  DriverObject->DriverUnload = DrvUnload;

  TriggerByPatchIDT1();

  return STATUS_VIRUS_INFECTED;
}

```

`QuickPGTrigger/trigger.h`:

```h
#pragma once
#include <fltKernel.h>
/////////////////////////////////////////////////////
//// macro
#define dprintf(...)                                                           \
  DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, __VA_ARGS__)

/////////////////////////////////////////////////////
//// declare function
void TriggerByPatchIDT1();

```

`QuickPGTrigger/trigger.idt.cpp`:

```cpp
#include "trigger.h"
#include <intrin.h>

//////////////////////////////////////////////////////////////////////////////
//// struct
#include <pshpack1.h>
struct Idtr {
  unsigned short limit;
  ULONG_PTR base;
};
#include <poppack.h>

struct IDTENTRY64 {
  USHORT OffsetLow;
  USHORT Selector;
  union {
    USHORT Access;
    struct {
      USHORT IstIndex : 3;
      USHORT Reserved0 : 5;
      USHORT Type : 5;
      USHORT Dpl : 2;
      USHORT Present : 1;
    } AccessField;
  };
  USHORT OffsetMiddle;
  ULONG OffsetHigh;
  ULONG Reserved1;
};

//////////////////////////////////////////////////////////////////////////////
//// function
void TriggerByPatchIDT1() {
  Idtr idtr = {};
  __sidt(&idtr);
  auto entries = reinterpret_cast<IDTENTRY64 *>(idtr.base);
  auto high = static_cast<ULONG_PTR>(entries[1].OffsetHigh) << 32;
  auto middle = static_cast<ULONG_PTR>(entries[1].OffsetMiddle) << 16;
  auto low = static_cast<ULONG_PTR>(entries[1].OffsetLow);
  auto int1Handler = reinterpret_cast<PUCHAR>(high | middle | low);
  dprintf("int1Handler=%p\n", int1Handler);

  PUCHAR patchAddr = nullptr;
  for (int i = 1; i < 0x100; ++i) {
    if (int1Handler[i] == 0x01 && int1Handler[i + 1] == 0x75) {
      patchAddr = &int1Handler[i + 1];
      break;
    }
  }
  dprintf("patchAddr=%p\n", patchAddr);
  if (!patchAddr) {
    return;
  }

  // patch
  {
    auto irql = KeGetCurrentIrql();
    __writecr8(2);
    auto cr0 = __readcr0();
    __writecr0(cr0 & 0xFFFFFFFFFFFEFFFF);
    _disable();
    *patchAddr = 0x74; //->>>>>>>>>>0x75->0x74
    cr0 = __readcr0();
    _enable();
    __writecr0(cr0 | 0x10000);
    __writecr8(irql);
  }

  // trigger testing
  {
    auto processorsCount = KeQueryActiveProcessorCount(0);
    for (ULONG i = 0; i < processorsCount; ++i) {
      KeSetSystemAffinityThread(1 << i);

      Idtr idtr = {};
      __sidt(&idtr);

      auto irql = KeGetCurrentIrql();
      __writecr8(2);
      auto cr0 = __readcr0();
      __writecr0(cr0 & 0xFFFFFFFFFFFEFFFF);
      _disable();
      cr0 = __readcr0();
      _enable();
      __writecr0(cr0 | 0x10000);
      __writecr8(irql);

      KeRevertToUserAffinityThread();
    }
  }

  dprintf("TriggerByHookIDT1 finished!\n");
}

```

`README.md`:

```md
# QuickPGTrigger
The stress testing of your PG bypass [old school project]

```