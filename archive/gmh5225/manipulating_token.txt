Project Path: arc_gmh5225_manipulating_token_nztue67a

Source Tree:

```txt
arc_gmh5225_manipulating_token_nztue67a
└── TestofCreateProcessWithTokenW
    ├── TestofCreateProcessWithTokenW.cpp
    ├── TestofCreateProcessWithTokenW.sln
    ├── TestofCreateProcessWithTokenW.vcxproj
    ├── TestofCreateProcessWithTokenW.vcxproj.filters
    └── TestofCreateProcessWithTokenW.vcxproj.user

```

`TestofCreateProcessWithTokenW/TestofCreateProcessWithTokenW.cpp`:

```cpp
// TestofCreateProcessWithTokenW.cpp : 이 파일에는 'main' 함수가 포함됩니다. 거기서 프로그램 실행이 시작되고 종료됩니다.
//

#include <Windows.h>
#include <iostream>
#include <securitybaseapi.h>
#include <processthreadsapi.h>
#include <winbase.h>
#include <tchar.h>

#define usernamelength	256

int main()
{
	TOKEN_PRIVILEGES PrivToken;
	BOOL bResult = NULL;
	HANDLE hToken = NULL;

	ZeroMemory(&PrivToken, sizeof(PrivToken));
	PrivToken.PrivilegeCount = 1;
	OpenProcessToken(GetCurrentProcess(), TOKEN_ALL_ACCESS, &hToken);
	LookupPrivilegeValueW(NULL, SE_DEBUG_NAME, &PrivToken.Privileges[0].Luid);

	PrivToken.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
	bResult = AdjustTokenPrivileges(hToken, FALSE, &PrivToken, 0, NULL, NULL);
	if( NULL == bResult)
	{
		printf("Failed to call AdjustTokenPrivileges(SeDebugPrivilege) error (%d) \n", GetLastError());
	}

	OpenProcessToken(GetCurrentProcess(), TOKEN_ALL_ACCESS, &hToken);
	LookupPrivilegeValueW(NULL, SE_IMPERSONATE_NAME, &PrivToken.Privileges[0].Luid);
	
	PrivToken.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
	bResult = AdjustTokenPrivileges(hToken, FALSE, &PrivToken, 0, NULL, NULL);
	if( NULL == bResult)
	{
		printf("Failed to call AdjustTokenPrivileges(SeImpersonatePrivilege) error (%d) \n", GetLastError());
	}
	
	HANDLE hProcess, hPrimaryToken = NULL;
	int pid = 576;
	hProcess = OpenProcess(PROCESS_QUERY_LIMITED_INFORMATION, TRUE, pid);
	if( NULL == hProcess )
	{
		printf("Failed to call OpenProcess error (%d) \n", GetLastError());
		return 0;
	}
	else
	{
		bResult = OpenProcessToken(hProcess, TOKEN_QUERY | TOKEN_DUPLICATE, &hPrimaryToken);
		if( NULL == bResult)
		{
			printf("Failed to call OpenProcessToken error (%d) \n", GetLastError());
		}
	}

	TCHAR strUsername[usernamelength+1] = {0,};
	DWORD dwUsernameLength = usernamelength+1;
	GetUserName((TCHAR*)strUsername, &dwUsernameLength);
	printf("current user : %S\n", strUsername);

	if( TRUE == ImpersonateLoggedOnUser( hPrimaryToken ) )
	{
		TCHAR strImpUsername[usernamelength+1] = {0,};
		DWORD dwImpUsernameLength = usernamelength+1;
		GetUserName((TCHAR*)strImpUsername, &dwImpUsernameLength);
		printf("current user : %S\n", strImpUsername);
	}

	HANDLE hDupToken = NULL;
	HANDLE phSessionToken = NULL;
	BOOL bDupTokenResult, ProcWithToken = NULL;
	SECURITY_IMPERSONATION_LEVEL SecImpLevel = SecurityImpersonation;
	TOKEN_TYPE TokenType = TokenPrimary;
	bDupTokenResult = DuplicateTokenEx(hPrimaryToken, MAXIMUM_ALLOWED, NULL, SecImpLevel, TokenType, &hDupToken);
	
	STARTUPINFO StartupInfo = {};
	PROCESS_INFORMATION ProcInfo = {};
	ProcWithToken = CreateProcessWithTokenW(hDupToken, 0, L"C:\\Windows\\system32\\cmd.exe", NULL, CREATE_NEW_CONSOLE, NULL, NULL, &StartupInfo, &ProcInfo);
	if( NULL == ProcWithToken )
	{
		printf("Failed to call CreateProcessWithTokenW error (%d) \n", GetLastError());
	}
	system("pause");

	return 1;
}

```

`TestofCreateProcessWithTokenW/TestofCreateProcessWithTokenW.sln`:

```sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 16
VisualStudioVersion = 16.0.32228.343
MinimumVisualStudioVersion = 10.0.40219.1
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "TestofCreateProcessWithTokenW", "TestofCreateProcessWithTokenW.vcxproj", "{79350680-DBC6-49ED-B2E7-4A24E3329E3B}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|x64 = Debug|x64
		Debug|x86 = Debug|x86
		Release|x64 = Release|x64
		Release|x86 = Release|x86
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{79350680-DBC6-49ED-B2E7-4A24E3329E3B}.Debug|x64.ActiveCfg = Debug|x64
		{79350680-DBC6-49ED-B2E7-4A24E3329E3B}.Debug|x64.Build.0 = Debug|x64
		{79350680-DBC6-49ED-B2E7-4A24E3329E3B}.Debug|x86.ActiveCfg = Debug|Win32
		{79350680-DBC6-49ED-B2E7-4A24E3329E3B}.Debug|x86.Build.0 = Debug|Win32
		{79350680-DBC6-49ED-B2E7-4A24E3329E3B}.Release|x64.ActiveCfg = Release|x64
		{79350680-DBC6-49ED-B2E7-4A24E3329E3B}.Release|x64.Build.0 = Release|x64
		{79350680-DBC6-49ED-B2E7-4A24E3329E3B}.Release|x86.ActiveCfg = Release|Win32
		{79350680-DBC6-49ED-B2E7-4A24E3329E3B}.Release|x86.Build.0 = Release|Win32
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {CBF39765-E530-471F-B659-B413532C5BF4}
	EndGlobalSection
EndGlobal

```

`TestofCreateProcessWithTokenW/TestofCreateProcessWithTokenW.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <Keyword>Win32Proj</Keyword>
    <ProjectGuid>{79350680-dbc6-49ed-b2e7-4a24e3329e3b}</ProjectGuid>
    <RootNamespace>TestofCreateProcessWithTokenW</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <LinkIncremental>true</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <LinkIncremental>false</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <LinkIncremental>true</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <LinkIncremental>false</LinkIncremental>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="TestofCreateProcessWithTokenW.cpp" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`TestofCreateProcessWithTokenW/TestofCreateProcessWithTokenW.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="소스 파일">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;c++;cppm;ixx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="헤더 파일">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;h++;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="리소스 파일">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="TestofCreateProcessWithTokenW.cpp">
      <Filter>소스 파일</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`TestofCreateProcessWithTokenW/TestofCreateProcessWithTokenW.vcxproj.user`:

```user
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="Current" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup />
</Project>
```