Project Path: arc_5ec1cff_TrickyStore_z9imzgeq

Source Tree:

```txt
arc_5ec1cff_TrickyStore_z9imzgeq
├── README.md
├── README.zh-CN.md
├── SECURITY.md
├── _config.yml
├── changelog.md
├── module.json
└── update.json

```

`README.md`:

```md
# Tricky Store

A trick of keystore. **Android 10 or above is required**.

This module is used for modifying the certificate chain generated for android key attestation.

[中文 README](README.zh-CN.md)

## Stop opening source

Due to the rampant misuse and the contributions received after open-sourcing being less than expected, this module will be closed-source starting from version 1.1.0.

## Usage

1. Flash this module and reboot.  
2. For more than DEVICE integrity, put an unrevoked hardware keybox.xml at `/data/adb/tricky_store/keybox.xml` (Optional).  
3. Customize target packages at `/data/adb/tricky_store/target.txt` (Optional).  
4. Enjoy!  

**All configuration files will take effect immediately.**

## keybox.xml

format:

```xml
<?xml version="1.0"?>
<AndroidAttestation>
    <NumberOfKeyboxes>1</NumberOfKeyboxes>
    <Keybox DeviceID="...">
        <Key algorithm="ecdsa|rsa">
            <PrivateKey format="pem">
-----BEGIN EC PRIVATE KEY-----
...
-----END EC PRIVATE KEY-----
            </PrivateKey>
            <CertificateChain>
                <NumberOfCertificates>...</NumberOfCertificates>
                    <Certificate format="pem">
-----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----
                    </Certificate>
                ... more certificates
            </CertificateChain>
        </Key>...
    </Keybox>
</AndroidAttestation>
```

## Support TEE broken devices

Tricky Store will hack the leaf certificate by default.
On TEE broken devices, this will not work because we can't retrieve the leaf certificate from TEE.
In this case, we fallback to use generate key mode automatically.  

You can add a `!` after a package name to force use generate certificate support for this package.
Also, you can add a `?` after a package name to force use leaf hack mode for this package.

For example:

```
# target.txt
# use auto mode for KeyAttestation App
io.github.vvb2060.keyattestation
# always use leaf hack mode 
io.github.vvb2060.mahoshojo?
# always use certificate generating mode for gms
com.google.android.gms!
```

## Customize security patch level (1.2.1+)

Create the file `/data/adb/tricky_store/security_patch.txt`.

Simple:

```
# Hack os/vendor/boot security patch level
20241101
```

Advanced:

```
# os security patch level is 202411
system=202411
# do not hack boot patch level
boot=no
# vendor patch level is 20241101 (another format)
vendor=2024-11-01
# default value
# all=20241101
# keep consistent with system prop
# system=prop
```

Note: this feature will only hack the result of KeyAttestation, it will not do resetprop, you need do it yourself.

## Acknowledgement

- [FrameworkPatch](https://github.com/chiteroman/FrameworkPatch)
- [BootloaderSpoofer](https://github.com/chiteroman/BootloaderSpoofer)
- [KeystoreInjection](https://github.com/aviraxp/Zygisk-KeystoreInjection)
- [LSPosed](https://github.com/LSPosed/LSPosed)

```

`README.zh-CN.md`:

```md
# Tricky Store

**支持 Android 10 及以上版本**.

该模块用于修改 Android Keystore 生成的 Android KeyAttestation 证书链。

[中文 README](README.zh-CN.md)

## 停止开源

考虑到二改泛滥，且开源后获得的贡献少于预期，因此本模块自 1.1.0 版本起闭源发布。

## 用法

1. 刷入模块并重启。
2. For more than DEVICE integrity, put an unrevoked hardware keybox.xml at `/data/adb/tricky_store/keybox.xml` （可选）。
3. 在 `/data/adb/tricky_store/target.txt` 自定义修改生效的应用包名（可选） 。
4. 大功告成！  

**所有配置会立即生效**

## keybox.xml

format:

```xml
<?xml version="1.0"?>
<AndroidAttestation>
    <NumberOfKeyboxes>1</NumberOfKeyboxes>
    <Keybox DeviceID="...">
        <Key algorithm="ecdsa|rsa">
            <PrivateKey format="pem">
-----BEGIN EC PRIVATE KEY-----
...
-----END EC PRIVATE KEY-----
            </PrivateKey>
            <CertificateChain>
                <NumberOfCertificates>...</NumberOfCertificates>
                    <Certificate format="pem">
-----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----
                    </Certificate>
                ... more certificates
            </CertificateChain>
        </Key>...
    </Keybox>
</AndroidAttestation>
```

## 支持 TEE 损坏的设备

TrickyStore 默认采用修改来自 TEE 的叶证书的方式。
这在 TEE 损坏的设备上无法工作，因为 TEE 无法提供证书链。
因此，TrickyStore 会自动切换到生成证书链模式。  

在 target.txt 中，在包名后添加一个 `!` 可以强制使用生成证书链模式。
添加 `?` 到包名后可强制使用修改证书链模式。如无后缀则自动选择。

例子

```
# target.txt
# 对 KeyAttestation App 使用自动模式
io.github.vvb2060.keyattestation
# 对 momo 使用修改证书链模式
io.github.vvb2060.mahoshojo?
# 对 gms 使用生成证书链模式
com.google.android.gms!
```

## 自定义安全补丁级别(1.2.1+)

配置文件 `/data/adb/tricky_store/security_patch.txt`

简易：

```
# 修改 os/vendor/boot 的安全补丁级别
20241101
```

高级：

```
# os 安全补丁级别为 202411
system=202411
# 不要修改 boot 安全补丁级别
boot=no
# vendor 安全补丁级别 20241101 （使用了另一种格式）
vendor=2024-11-01
# 默认值
# all=20241101
# system 安全补丁级别与系统属性一致
# system=prop
```

注意：该功能仅修改 KeyAttestation 返回的结果，不会重置系统属性。

## Acknowledgement

- [FrameworkPatch](https://github.com/chiteroman/FrameworkPatch)
- [BootloaderSpoofer](https://github.com/chiteroman/BootloaderSpoofer)
- [KeystoreInjection](https://github.com/aviraxp/Zygisk-KeystoreInjection)
- [LSPosed](https://github.com/LSPosed/LSPosed)

```

`SECURITY.md`:

```md
# Security

### Will TrickyStore expose my private keys?

It depends. At most times, your private keys generated by the Android Keystore Provider remain securely in TEE/Strongbox and are never exposed to TrickyStore or other Android softwares. However, there are two exceptions:

* Usually, TrickyStore uses the keybox.xml to (re)sign the certificate of a public key from Android Keystore, if such certificate contains an attestation extension which includes verified boot status. However, applications can explicitly choose another attest key in the Keystore to sign a newly generated public key certificate. In this case, TrickyStore has to know the private key of the said attest key in order to be able to (re)sign the certificate, thus will generate a new attest key or intercept an imported one on the software level.

* On certain brand's devices (such as Oneplus), the OEM disabled the Android Keystore Provider's ability to generate asymmetric keys while the bootloader is unlocked (commonly known as teeBroken). In this case, TrickyStore has to act in the stead of Android Keystore to handle all asymmetric keys generation, which is known as 'generate mode' compared to the usual 'hack mode'.

When TrickyStore determines it is necessary to own a private key, it is stored in the '/data/adb/tricky_store/key_db' in a sqlite database. This directory is only accessible by the root user thus offering some protection from regular applications.

### Will TrickyStore compromise the chain of trust by re-signing certificates?

TrickyStore currently does not check if the certificate chain of to-be-hacked keys is valid. Even if it does check it according to Google's terms, given the readily available keyboxs on the Internet, any attacker can bypass this check if they sign their key with a valid keybox.

### If you have any suggestion to improve TrickyStore's security or point out any other security flaws, feel free to open an issue.
```

`_config.yml`:

```yml
theme: jekyll-theme-slate

```

`changelog.md`:

```md
# 1.4.1

- 修复一些问题

---

- Fix some issues

# 1.4.0

- 支持持久化存储已生成的密钥
- 支持自动解析 AVB key（联发科设备疑似使用了自定义算法，暂不支持）
- 支持自定义认证密钥的解析和导入
- 支持拦截并模拟更多 keystore 操作
- 修复一些证书链生成问题

---

- Support persistent storage of generated keys
- Support automatic parsing of AVB keys (MediaTek devices seem to use a custom algorithm, currently not supported)
- Support parsing and importing of custom attestation keys
- Support intercepting and simulating more keystore operations
- Fix some certificate chain generation issues

# 1.3.0

- 支持 KeyMint 4.0 新增的 moduleHash 字段
- 支持 Android 16
- 修复偶发注入失败的问题
- 将 Play 商店加入默认作用列表
- 修复大量证书链生成问题

---

- Support for the new moduleHash field introduced in KeyMint 4.0
- Compatibility with Android 16
- Fixed occasional injection failures 
- Added Play Store to the default scope list
- Resolved numerous certificate chain generation issues

# 1.2.1

支持自定义安全补丁级别（请参见 README.md）

---

Support customizing security patch level (please refer to README.md)

# 1.2.0

修复注入失败的问题
修复安装失败的问题
修复 cert hack 下报错的问题

---

Fixed the injection failure issue
Fixed the installation failure issue
Fixed the error issue under cert hack

# 1.2.0-RC2

修改叶证书模式同时会修改安全等级与信任根为非软件
修复缺失的 osVersion 字段

---

Leaf hack mode will also change the security level and root of trust to non-software based
Fix missing osVersion field

# 1.2.0-RC1

初步支持 Android 10-11 （感谢 @N-X-T ）
自动模式会检测是否支持硬件加密
修复模块损坏问题
修复证书签名算法选择的问题

---

Add initial support for Android 10-11 (Thanks @N-X-T )
Auto mode will detect if hardware encryption is supported
Fix issue that module may be corrupted
Fix issue with certificate signature algorithm selection

```

`module.json`:

```json
{
    "summary": "A trick of keystore",
    "sourceUrl": "https://github.com/5ec1cff/TrickyStore",
    "additionalAuthors": [
        {
            "type": "add",
            "name": "aviraxp",
            "link": "https://github.com/aviraxp"
        },
        {
            "type": "add",
            "name": "Cyberenchanter",
            "link": "https://github.com/Cyberenchanter"
        }
    ]
}

```

`update.json`:

```json
{
  "versionCode": 245,
  "version": "v1.4.1",
  "zipUrl": "https://github.com/5ec1cff/TrickyStore/releases/download/1.4.1/Tricky-Store-v1.4.1-245-72b2e84-release.zip",
  "changelog": "https://github.com/5ec1cff/TrickyStore/raw/release/changelog.md"
}

```